import{S as Mi,i as Si,s as Li,w as Hi,x as _i,y as Oi,E as Di,q as Pi,o as Fi,B as Ni,J as Ii,L as Bi}from"../../chunks/index-f5ab8554.js";import{S as zi,a as de}from"../../chunks/aframe-master-2426b128.js";import{g as ji}from"../../chunks/_commonjsHelpers-56d41998.js";import{g as Vi}from"../../chunks/contourLineStore-f7bdfd5e.js";import"../../chunks/NavigationButton-69f79570.js";import"../../chunks/Button-91b7d574.js";import"../../chunks/navigation-0e6511d1.js";import"../../chunks/singletons-d1fb5791.js";import"../../chunks/debugStore-68413b3c.js";import"../../chunks/index-bcbe7d6b.js";const St=.1;AFRAME.registerComponent("checkpoint-controls",{schema:{enabled:{default:!0},mode:{default:"teleport",oneOf:["teleport","animate"]},animateSpeed:{default:3}},init:function(){this.active=!0,this.checkpoint=null,this.isNavMeshConstrained=!1,this.offset=new THREE.Vector3,this.position=new THREE.Vector3,this.targetPosition=new THREE.Vector3},play:function(){this.active=!0},pause:function(){this.active=!1},setCheckpoint:function(e){const t=this.el;if(!!this.active&&this.checkpoint!==e){if(this.checkpoint&&t.emit("navigation-end",{checkpoint:this.checkpoint}),this.checkpoint=e,this.sync(),this.position.distanceTo(this.targetPosition)<St){this.checkpoint=null;return}t.emit("navigation-start",{checkpoint:e}),this.data.mode==="teleport"&&(this.el.setAttribute("position",this.targetPosition),this.checkpoint=null,t.emit("navigation-end",{checkpoint:e}),t.components["movement-controls"].updateNavLocation())}},isVelocityActive:function(){return!!(this.active&&this.checkpoint)},getVelocity:function(){if(!this.active)return;const e=this.data,t=this.offset,i=this.position,r=this.targetPosition,c=this.checkpoint;return this.sync(),i.distanceTo(r)<St?(this.checkpoint=null,this.el.emit("navigation-end",{checkpoint:c}),t.set(0,0,0)):(t.setLength(e.animateSpeed),t)},sync:function(){const e=this.offset,t=this.position,i=this.targetPosition;t.copy(this.el.getAttribute("position")),this.checkpoint.object3D.getWorldPosition(i),i.add(this.checkpoint.components.checkpoint.getOffset()),e.copy(i).sub(t)}});var Gi=Object.assign(function(){},{FACE_1:0,FACE_2:1,FACE_3:2,FACE_4:3,L_SHOULDER_1:4,R_SHOULDER_1:5,L_SHOULDER_2:6,R_SHOULDER_2:7,SELECT:8,START:9,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15,VENDOR:16});function Ki(e,t,i){this.type=e,this.index=t,this.pressed=i.pressed,this.value=i.value}var Ui=Ki;const Pe=Gi,rt=Ui,Ce=.2,xe={LEFT:"left",RIGHT:"right"},Ae={MOVEMENT:1,ROTATION:2};AFRAME.registerComponent("gamepad-controls",{GamepadButton:Pe,schema:{enabled:{default:!0},camera:{default:"[camera]",type:"selector"},rotationSensitivity:{default:2}},init:function(){const e=this.el.sceneEl;this.system=e.systems["tracked-controls-webxr"]||{controllers:[]},this.prevTime=window.performance.now(),this.buttons={};const t=this.el.object3D.rotation;this.pitch=new THREE.Object3D,this.pitch.rotation.x=THREE.Math.degToRad(t.x),this.yaw=new THREE.Object3D,this.yaw.position.y=10,this.yaw.rotation.y=THREE.Math.degToRad(t.y),this.yaw.add(this.pitch),this._lookVector=new THREE.Vector2,this._moveVector=new THREE.Vector2,this._dpadVector=new THREE.Vector2,e.addBehavior(this)},update:function(){this.tick()},tick:function(e,t){this.updateButtonState(),this.updateRotation(t)},remove:function(){},isVelocityActive:function(){if(!this.data.enabled||!this.isConnected())return!1;const e=this._dpadVector,t=this._moveVector;this.getDpad(e),this.getJoystick(Ae.MOVEMENT,t);const i=e.x||t.x,r=e.y||t.y;return Math.abs(i)>Ce||Math.abs(r)>Ce},getVelocityDelta:function(){const e=this._dpadVector,t=this._moveVector;this.getDpad(e),this.getJoystick(Ae.MOVEMENT,t);const i=e.x||t.x,r=e.y||t.y,c=new THREE.Vector3;return Math.abs(i)>Ce&&(c.x+=i),Math.abs(r)>Ce&&(c.z+=r),c},isRotationActive:function(){if(!this.data.enabled||!this.isConnected())return!1;const e=this._lookVector;return this.getJoystick(Ae.ROTATION,e),Math.abs(e.x)>Ce||Math.abs(e.y)>Ce},updateRotation:function(e){if(!this.isRotationActive())return;const t=this.data,i=this.yaw,r=this.pitch,c=t.camera.components["look-controls"],d=c&&c.pitchObject&&c.yawObject;d&&(r.rotation.copy(c.pitchObject.rotation),i.rotation.copy(c.yawObject.rotation));const m=this._lookVector;this.getJoystick(Ae.ROTATION,m),Math.abs(m.x)<=Ce&&(m.x=0),Math.abs(m.y)<=Ce&&(m.y=0),m.multiplyScalar(t.rotationSensitivity*e/1e3),i.rotation.y-=m.x,r.rotation.x-=m.y,r.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,r.rotation.x)),t.camera.object3D.rotation.set(r.rotation.x,i.rotation.y,0),d&&(c.pitchObject.rotation.copy(r.rotation),c.yawObject.rotation.copy(i.rotation))},updateButtonState:function(){const e=this.getGamepad(xe.RIGHT);if(this.data.enabled&&e)for(var t=0;t<e.buttons.length;t++)e.buttons[t].pressed&&!this.buttons[t]?this.emit(new rt("gamepadbuttondown",t,e.buttons[t])):!e.buttons[t].pressed&&this.buttons[t]&&this.emit(new rt("gamepadbuttonup",t,e.buttons[t])),this.buttons[t]=e.buttons[t].pressed;else Object.keys(this.buttons)&&(this.buttons={})},emit:function(e){this.el.emit(e.type,e),this.el.emit(e.type+":"+e.index,new rt(e.type,e.index,e))},getGamepad:function(){const e=[],t=[];return function(i){const r=this.el.sceneEl.components["proxy-controls"],c=r&&r.isConnected()&&r.getGamepad(0);if(c)return c;e.length=0;for(let m=0;m<this.system.controllers.length;m++){const T=this.system.controllers[m],b=T?T.gamepad:null;if(e.push(b),b&&b.handedness===i)return b}const d=navigator.getGamepads?navigator.getGamepads():t;for(let m=0;m<d.length;m++){const T=d[m];if(T&&T.hand===i)return T}return e[0]||d[0]}}(),getButton:function(e){return this.getGamepad(xe.RIGHT).buttons[e]},getAxis:function(e){return this.getGamepad(e>1?xe.RIGHT:xe.LEFT).axes[e]},getJoystick:function(e,t){const i=this.getGamepad(e===Ae.MOVEMENT?xe.LEFT:xe.RIGHT);if(i.mapping==="xr-standard")switch(e){case Ae.MOVEMENT:return t.set(i.axes[2],i.axes[3]);case Ae.ROTATION:return t.set(i.axes[0],i.axes[1])}else switch(e){case Ae.MOVEMENT:return t.set(i.axes[0],i.axes[1]);case Ae.ROTATION:return t.set(i.axes[2],i.axes[3])}throw new Error('Unexpected joystick index "%d".',e)},getDpad:function(e){const t=this.getGamepad(xe.LEFT);return t.buttons[Pe.DPAD_RIGHT]?e.set((t.buttons[Pe.DPAD_RIGHT].pressed?1:0)+(t.buttons[Pe.DPAD_LEFT].pressed?-1:0),(t.buttons[Pe.DPAD_UP].pressed?-1:0)+(t.buttons[Pe.DPAD_DOWN].pressed?1:0)):e.set(0,0)},isConnected:function(){const e=this.getGamepad(xe.LEFT);return!!(e&&e.connected)},getID:function(){return this.getGamepad(xe.LEFT).id}});(function(e){var t="KeyboardEvent"in e;t||(e.KeyboardEvent=function(){throw TypeError("Illegal constructor")}),"DOM_KEY_LOCATION_STANDARD"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_STANDARD=0),"DOM_KEY_LOCATION_LEFT"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_LEFT=1),"DOM_KEY_LOCATION_RIGHT"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_RIGHT=2),"DOM_KEY_LOCATION_NUMPAD"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_NUMPAD=3);var i=window.KeyboardEvent.DOM_KEY_LOCATION_STANDARD,r=window.KeyboardEvent.DOM_KEY_LOCATION_LEFT,c=window.KeyboardEvent.DOM_KEY_LOCATION_RIGHT,d=window.KeyboardEvent.DOM_KEY_LOCATION_NUMPAD;function m(V,X){return String(V).indexOf(X)!==-1}var T=function(){return m(navigator.platform,"Win")?"win":m(navigator.platform,"Mac")?"mac":m(navigator.platform,"CrOS")?"cros":m(navigator.platform,"Linux")?"linux":m(navigator.userAgent,"iPad")||m(navigator.platform,"iPod")||m(navigator.platform,"iPhone")?"ios":""}(),b=function(){return m(navigator.userAgent,"Chrome/")?"chrome":m(navigator.vendor,"Apple")?"safari":m(navigator.userAgent,"MSIE")?"ie":m(navigator.userAgent,"Gecko/")?"moz":m(navigator.userAgent,"Opera/")?"opera":""}(),M=b+"-"+T;function A(V,X,K){(M===X||b===X||T===X)&&Object.keys(K).forEach(function(se){V[se]=K[se]})}function N(V,X){var K={};return Object.keys(V).forEach(function(se){var oe=V[se];X in oe&&(K[oe[X]]=oe)}),K}var L={3:{code:"Cancel"},6:{code:"Help"},8:{code:"Backspace"},9:{code:"Tab"},12:{code:"Clear"},13:{code:"Enter"},16:{code:"Shift"},17:{code:"Control"},18:{code:"Alt"},19:{code:"Pause"},20:{code:"CapsLock"},21:{code:"KanaMode"},22:{code:"HangulMode"},23:{code:"JunjaMode"},24:{code:"FinalMode"},25:{code:"KanjiMode"},27:{code:"Escape"},28:{code:"Convert"},29:{code:"NonConvert"},30:{code:"Accept"},31:{code:"ModeChange"},32:{code:"Space"},33:{code:"PageUp"},34:{code:"PageDown"},35:{code:"End"},36:{code:"Home"},37:{code:"ArrowLeft"},38:{code:"ArrowUp"},39:{code:"ArrowRight"},40:{code:"ArrowDown"},41:{code:"Select"},42:{code:"Print"},43:{code:"Execute"},44:{code:"PrintScreen"},45:{code:"Insert"},46:{code:"Delete"},47:{code:"Help"},48:{code:"Digit0",keyCap:"0"},49:{code:"Digit1",keyCap:"1"},50:{code:"Digit2",keyCap:"2"},51:{code:"Digit3",keyCap:"3"},52:{code:"Digit4",keyCap:"4"},53:{code:"Digit5",keyCap:"5"},54:{code:"Digit6",keyCap:"6"},55:{code:"Digit7",keyCap:"7"},56:{code:"Digit8",keyCap:"8"},57:{code:"Digit9",keyCap:"9"},65:{code:"KeyA",keyCap:"a"},66:{code:"KeyB",keyCap:"b"},67:{code:"KeyC",keyCap:"c"},68:{code:"KeyD",keyCap:"d"},69:{code:"KeyE",keyCap:"e"},70:{code:"KeyF",keyCap:"f"},71:{code:"KeyG",keyCap:"g"},72:{code:"KeyH",keyCap:"h"},73:{code:"KeyI",keyCap:"i"},74:{code:"KeyJ",keyCap:"j"},75:{code:"KeyK",keyCap:"k"},76:{code:"KeyL",keyCap:"l"},77:{code:"KeyM",keyCap:"m"},78:{code:"KeyN",keyCap:"n"},79:{code:"KeyO",keyCap:"o"},80:{code:"KeyP",keyCap:"p"},81:{code:"KeyQ",keyCap:"q"},82:{code:"KeyR",keyCap:"r"},83:{code:"KeyS",keyCap:"s"},84:{code:"KeyT",keyCap:"t"},85:{code:"KeyU",keyCap:"u"},86:{code:"KeyV",keyCap:"v"},87:{code:"KeyW",keyCap:"w"},88:{code:"KeyX",keyCap:"x"},89:{code:"KeyY",keyCap:"y"},90:{code:"KeyZ",keyCap:"z"},91:{code:"OSLeft",location:r},92:{code:"OSRight",location:c},93:{code:"ContextMenu"},95:{code:"Standby"},96:{code:"Numpad0",keyCap:"0",location:d},97:{code:"Numpad1",keyCap:"1",location:d},98:{code:"Numpad2",keyCap:"2",location:d},99:{code:"Numpad3",keyCap:"3",location:d},100:{code:"Numpad4",keyCap:"4",location:d},101:{code:"Numpad5",keyCap:"5",location:d},102:{code:"Numpad6",keyCap:"6",location:d},103:{code:"Numpad7",keyCap:"7",location:d},104:{code:"Numpad8",keyCap:"8",location:d},105:{code:"Numpad9",keyCap:"9",location:d},106:{code:"NumpadMultiply",keyCap:"*",location:d},107:{code:"NumpadAdd",keyCap:"+",location:d},108:{code:"NumpadComma",keyCap:",",location:d},109:{code:"NumpadSubtract",keyCap:"-",location:d},110:{code:"NumpadDecimal",keyCap:".",location:d},111:{code:"NumpadDivide",keyCap:"/",location:d},112:{code:"F1"},113:{code:"F2"},114:{code:"F3"},115:{code:"F4"},116:{code:"F5"},117:{code:"F6"},118:{code:"F7"},119:{code:"F8"},120:{code:"F9"},121:{code:"F10"},122:{code:"F11"},123:{code:"F12"},124:{code:"F13"},125:{code:"F14"},126:{code:"F15"},127:{code:"F16"},128:{code:"F17"},129:{code:"F18"},130:{code:"F19"},131:{code:"F20"},132:{code:"F21"},133:{code:"F22"},134:{code:"F23"},135:{code:"F24"},144:{code:"NumLock",location:d},145:{code:"ScrollLock"},160:{code:"ShiftLeft",location:r},161:{code:"ShiftRight",location:c},162:{code:"ControlLeft",location:r},163:{code:"ControlRight",location:c},164:{code:"AltLeft",location:r},165:{code:"AltRight",location:c},166:{code:"BrowserBack"},167:{code:"BrowserForward"},168:{code:"BrowserRefresh"},169:{code:"BrowserStop"},170:{code:"BrowserSearch"},171:{code:"BrowserFavorites"},172:{code:"BrowserHome"},173:{code:"VolumeMute"},174:{code:"VolumeDown"},175:{code:"VolumeUp"},176:{code:"MediaTrackNext"},177:{code:"MediaTrackPrevious"},178:{code:"MediaStop"},179:{code:"MediaPlayPause"},180:{code:"LaunchMail"},181:{code:"MediaSelect"},182:{code:"LaunchApp1"},183:{code:"LaunchApp2"},186:{code:"Semicolon",keyCap:";"},187:{code:"Equal",keyCap:"="},188:{code:"Comma",keyCap:","},189:{code:"Minus",keyCap:"-"},190:{code:"Period",keyCap:"."},191:{code:"Slash",keyCap:"/"},192:{code:"Backquote",keyCap:"`"},219:{code:"BracketLeft",keyCap:"["},220:{code:"Backslash",keyCap:"\\"},221:{code:"BracketRight",keyCap:"]"},222:{code:"Quote",keyCap:"'"},226:{code:"IntlBackslash",keyCap:"\\"},229:{code:"Process"},246:{code:"Attn"},247:{code:"CrSel"},248:{code:"ExSel"},249:{code:"EraseEof"},250:{code:"Play"},251:{code:"ZoomToggle"},254:{code:"Clear"}};A(L,"moz",{59:{code:"Semicolon",keyCap:";"},61:{code:"Equal",keyCap:"="},107:{code:"Equal",keyCap:"="},109:{code:"Minus",keyCap:"-"},187:{code:"NumpadAdd",keyCap:"+",location:d},189:{code:"NumpadSubtract",keyCap:"-",location:d}}),A(L,"moz-mac",{12:{code:"NumLock",location:d},173:{code:"Minus",keyCap:"-"}}),A(L,"moz-win",{173:{code:"Minus",keyCap:"-"}}),A(L,"chrome-mac",{93:{code:"OSRight",location:c}}),A(L,"safari",{3:{code:"Enter"},25:{code:"Tab"}}),A(L,"ios",{10:{code:"Enter",location:i}}),A(L,"safari-mac",{91:{code:"OSLeft",location:r},93:{code:"OSRight",location:c},229:{code:"KeyQ",keyCap:"Q"}});var S={};T==="cros"&&(S["U+00A0"]={code:"ShiftLeft",location:r},S["U+00A1"]={code:"ShiftRight",location:c},S["U+00A2"]={code:"ControlLeft",location:r},S["U+00A3"]={code:"ControlRight",location:c},S["U+00A4"]={code:"AltLeft",location:r},S["U+00A5"]={code:"AltRight",location:c}),M==="chrome-mac"&&(S["U+0010"]={code:"ContextMenu"}),M==="safari-mac"&&(S["U+0010"]={code:"ContextMenu"}),T==="ios"&&(S["U+0010"]={code:"Function"},S["U+001C"]={code:"ArrowLeft"},S["U+001D"]={code:"ArrowRight"},S["U+001E"]={code:"ArrowUp"},S["U+001F"]={code:"ArrowDown"},S["U+0001"]={code:"Home"},S["U+0004"]={code:"End"},S["U+000B"]={code:"PageUp"},S["U+000C"]={code:"PageDown"});var D=[];D[r]={16:{code:"ShiftLeft",location:r},17:{code:"ControlLeft",location:r},18:{code:"AltLeft",location:r}},D[c]={16:{code:"ShiftRight",location:c},17:{code:"ControlRight",location:c},18:{code:"AltRight",location:c}},D[d]={13:{code:"NumpadEnter",location:d}},A(D[d],"moz",{109:{code:"NumpadSubtract",location:d},107:{code:"NumpadAdd",location:d}}),A(D[r],"moz-mac",{224:{code:"OSLeft",location:r}}),A(D[c],"moz-mac",{224:{code:"OSRight",location:c}}),A(D[c],"moz-win",{91:{code:"OSRight",location:c}}),A(D[c],"mac",{93:{code:"OSRight",location:c}}),A(D[d],"chrome-mac",{12:{code:"NumLock",location:d}}),A(D[d],"safari-mac",{12:{code:"NumLock",location:d},187:{code:"NumpadAdd",location:d},189:{code:"NumpadSubtract",location:d},190:{code:"NumpadDecimal",location:d},191:{code:"NumpadDivide",location:d}});var ee={ShiftLeft:{key:"Shift"},ShiftRight:{key:"Shift"},ControlLeft:{key:"Control"},ControlRight:{key:"Control"},AltLeft:{key:"Alt"},AltRight:{key:"Alt"},OSLeft:{key:"OS"},OSRight:{key:"OS"},NumpadEnter:{key:"Enter"},Space:{key:" "},Digit0:{key:"0",shiftKey:")"},Digit1:{key:"1",shiftKey:"!"},Digit2:{key:"2",shiftKey:"@"},Digit3:{key:"3",shiftKey:"#"},Digit4:{key:"4",shiftKey:"$"},Digit5:{key:"5",shiftKey:"%"},Digit6:{key:"6",shiftKey:"^"},Digit7:{key:"7",shiftKey:"&"},Digit8:{key:"8",shiftKey:"*"},Digit9:{key:"9",shiftKey:"("},KeyA:{key:"a",shiftKey:"A"},KeyB:{key:"b",shiftKey:"B"},KeyC:{key:"c",shiftKey:"C"},KeyD:{key:"d",shiftKey:"D"},KeyE:{key:"e",shiftKey:"E"},KeyF:{key:"f",shiftKey:"F"},KeyG:{key:"g",shiftKey:"G"},KeyH:{key:"h",shiftKey:"H"},KeyI:{key:"i",shiftKey:"I"},KeyJ:{key:"j",shiftKey:"J"},KeyK:{key:"k",shiftKey:"K"},KeyL:{key:"l",shiftKey:"L"},KeyM:{key:"m",shiftKey:"M"},KeyN:{key:"n",shiftKey:"N"},KeyO:{key:"o",shiftKey:"O"},KeyP:{key:"p",shiftKey:"P"},KeyQ:{key:"q",shiftKey:"Q"},KeyR:{key:"r",shiftKey:"R"},KeyS:{key:"s",shiftKey:"S"},KeyT:{key:"t",shiftKey:"T"},KeyU:{key:"u",shiftKey:"U"},KeyV:{key:"v",shiftKey:"V"},KeyW:{key:"w",shiftKey:"W"},KeyX:{key:"x",shiftKey:"X"},KeyY:{key:"y",shiftKey:"Y"},KeyZ:{key:"z",shiftKey:"Z"},Numpad0:{key:"0"},Numpad1:{key:"1"},Numpad2:{key:"2"},Numpad3:{key:"3"},Numpad4:{key:"4"},Numpad5:{key:"5"},Numpad6:{key:"6"},Numpad7:{key:"7"},Numpad8:{key:"8"},Numpad9:{key:"9"},NumpadMultiply:{key:"*"},NumpadAdd:{key:"+"},NumpadComma:{key:","},NumpadSubtract:{key:"-"},NumpadDecimal:{key:"."},NumpadDivide:{key:"/"},Semicolon:{key:";",shiftKey:":"},Equal:{key:"=",shiftKey:"+"},Comma:{key:",",shiftKey:"<"},Minus:{key:"-",shiftKey:"_"},Period:{key:".",shiftKey:">"},Slash:{key:"/",shiftKey:"?"},Backquote:{key:"`",shiftKey:"~"},BracketLeft:{key:"[",shiftKey:"{"},Backslash:{key:"\\",shiftKey:"|"},BracketRight:{key:"]",shiftKey:"}"},Quote:{key:"'",shiftKey:'"'},IntlBackslash:{key:"\\",shiftKey:"|"}};A(ee,"mac",{OSLeft:{key:"Meta"},OSRight:{key:"Meta"}});var ae={Esc:"Escape",Nonconvert:"NonConvert",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Menu:"ContextMenu",MediaNextTrack:"MediaTrackNext",MediaPreviousTrack:"MediaTrackPrevious",SelectMedia:"MediaSelect",HalfWidth:"Hankaku",FullWidth:"Zenkaku",RomanCharacters:"Romaji",Crsel:"CrSel",Exsel:"ExSel",Zoom:"ZoomToggle"},ie=N(L,"code");try{var fe=t&&"location"in new KeyboardEvent("")}catch{}function he(V){var X="keyCode"in V?V.keyCode:"which"in V?V.which:0,K=function(){if(fe||"keyLocation"in V){var oe=fe?V.location:V.keyLocation;if(oe&&X in D[oe])return D[oe][X]}return"keyIdentifier"in V&&V.keyIdentifier in S?S[V.keyIdentifier]:X in L?L[X]:null}();if(!K)return null;var se=function(){var oe=ee[K.code];return oe?V.shiftKey&&"shiftKey"in oe?oe.shiftKey:oe.key:K.code}();return{code:K.code,key:se,location:K.location,keyCap:K.keyCap}}function Ee(V,X){if(V=String(V),!ie.hasOwnProperty(V))return"Undefined";if(X&&String(X).toLowerCase()!=="en-us")throw Error("Unsupported locale");var K=ie[V];return K.keyCap||K.code||"Undefined"}"KeyboardEvent"in e&&"defineProperty"in Object&&function(){function V(K,se,oe){se in K||Object.defineProperty(K,se,oe)}if(V(KeyboardEvent.prototype,"code",{get:function(){var K=he(this);return K?K.code:""}}),"key"in KeyboardEvent.prototype){var X=Object.getOwnPropertyDescriptor(KeyboardEvent.prototype,"key");Object.defineProperty(KeyboardEvent.prototype,"key",{get:function(){var K=X.get.call(this);return ae.hasOwnProperty(K)?ae[K]:K}})}V(KeyboardEvent.prototype,"key",{get:function(){var K=he(this);return K&&"key"in K?K.key:"Unidentified"}}),V(KeyboardEvent.prototype,"location",{get:function(){var K=he(this);return K&&"location"in K?K.location:i}}),V(KeyboardEvent.prototype,"locale",{get:function(){return""}})}(),"queryKeyCap"in e.KeyboardEvent||(e.KeyboardEvent.queryKeyCap=Ee),e.identifyKey=function(V){if(!("code"in V)){var X=he(V);V.code=X?X.code:"",V.key=X&&"key"in X?X.key:"Unidentified",V.location="location"in V?V.location:"keyLocation"in V?V.keyLocation:X&&"location"in X?X.location:i,V.locale=""}}})(window);const qi="__keyboard-controls-proxy",Xi=window.KeyboardEvent;AFRAME.registerComponent("keyboard-controls",{schema:{enabled:{default:!0},debug:{default:!1}},init:function(){this.dVelocity=new THREE.Vector3,this.localKeys={},this.listeners={keydown:this.onKeyDown.bind(this),keyup:this.onKeyUp.bind(this),blur:this.onBlur.bind(this)},this.attachEventListeners()},isVelocityActive:function(){return this.data.enabled&&!!Object.keys(this.getKeys()).length},getVelocityDelta:function(){const e=this.data,t=this.getKeys();return this.dVelocity.set(0,0,0),e.enabled&&((t.KeyW||t.ArrowUp)&&(this.dVelocity.z-=1),(t.KeyA||t.ArrowLeft)&&(this.dVelocity.x-=1),(t.KeyS||t.ArrowDown)&&(this.dVelocity.z+=1),(t.KeyD||t.ArrowRight)&&(this.dVelocity.x+=1)),this.dVelocity.clone()},play:function(){this.attachEventListeners()},pause:function(){this.removeEventListeners()},remove:function(){this.pause()},attachEventListeners:function(){window.addEventListener("keydown",this.listeners.keydown,!1),window.addEventListener("keyup",this.listeners.keyup,!1),window.addEventListener("blur",this.listeners.blur,!1)},removeEventListeners:function(){window.removeEventListener("keydown",this.listeners.keydown),window.removeEventListener("keyup",this.listeners.keyup),window.removeEventListener("blur",this.listeners.blur)},onKeyDown:function(e){AFRAME.utils.shouldCaptureKeyEvent(e)&&(this.localKeys[e.code]=!0,this.emit(e))},onKeyUp:function(e){AFRAME.utils.shouldCaptureKeyEvent(e)&&(delete this.localKeys[e.code],this.emit(e))},onBlur:function(){for(let e in this.localKeys)this.localKeys.hasOwnProperty(e)&&delete this.localKeys[e]},emit:function(e){qi in e&&this.el.emit(e.type,e),this.el.emit(e.type+":"+e.code,new Xi(e.type,e)),this.data.debug&&console.log(e.type+":"+e.code)},isPressed:function(e){return e in this.getKeys()},getKeys:function(){return this.isProxied()?this.el.sceneEl.components["proxy-controls"].getKeyboard():this.localKeys},isProxied:function(){const e=this.el.sceneEl.components["proxy-controls"];return e&&e.isConnected()}});AFRAME.registerComponent("touch-controls",{schema:{enabled:{default:!0},reverseEnabled:{default:!0}},init:function(){this.dVelocity=new THREE.Vector3,this.bindMethods(),this.direction=0},play:function(){this.addEventListeners()},pause:function(){this.removeEventListeners(),this.dVelocity.set(0,0,0)},remove:function(){this.pause()},addEventListeners:function(){const e=this.el.sceneEl,t=e.canvas;if(!t){e.addEventListener("render-target-loaded",this.addEventListeners.bind(this));return}t.addEventListener("touchstart",this.onTouchStart),t.addEventListener("touchend",this.onTouchEnd)},removeEventListeners:function(){const e=this.el.sceneEl&&this.el.sceneEl.canvas;!e||(e.removeEventListener("touchstart",this.onTouchStart),e.removeEventListener("touchend",this.onTouchEnd))},isVelocityActive:function(){return this.data.enabled&&!!this.direction},getVelocityDelta:function(){return this.dVelocity.z=this.direction,this.dVelocity.clone()},bindMethods:function(){this.onTouchStart=this.onTouchStart.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this)},onTouchStart:function(e){this.direction=-1,this.data.reverseEnabled&&e.touches.length===2&&(this.direction=1),e.preventDefault()},onTouchEnd:function(e){this.direction=0,e.preventDefault()}});const Lt="-controls",Wi=.2,Zi=1e-5;AFRAME.registerComponent("movement-controls",{dependencies:["rotation"],schema:{enabled:{default:!0},controls:{default:["gamepad","trackpad","keyboard","touch"]},speed:{default:.3,min:0},fly:{default:!1},constrainToNavMesh:{default:!1},camera:{default:"[movement-controls] [camera]",type:"selector"}},init:function(){const e=this.el;this.velocityCtrl=null,this.velocity=new THREE.Vector3,this.heading=new THREE.Quaternion,this.navGroup=null,this.navNode=null,e.sceneEl.hasLoaded?this.injectControls():e.sceneEl.addEventListener("loaded",this.injectControls.bind(this))},update:function(e){const t=this.el,i=this.data,r=t.sceneEl.systems.nav;t.sceneEl.hasLoaded&&this.injectControls(),r&&i.constrainToNavMesh!==e.constrainToNavMesh&&(i.constrainToNavMesh?r.addAgent(this):r.removeAgent(this))},injectControls:function(){const e=this.data;var t;for(let i=0;i<e.controls.length;i++)t=e.controls[i]+Lt,this.el.components[t]||this.el.setAttribute(t,"")},updateNavLocation:function(){this.navGroup=null,this.navNode=null},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3;return function(r,c){if(!c)return;const d=this.el,m=this.data;if(!m.enabled)return;this.updateVelocityCtrl();const T=this.velocityCtrl,b=this.velocity;if(!!T)if(c/1e3>Wi?b.set(0,0,0):this.updateVelocity(c),m.constrainToNavMesh&&T.isNavMeshConstrained!==!1){if(b.lengthSq()<Zi)return;e.copy(d.object3D.position),t.copy(b).multiplyScalar(c/1e3).add(e);const M=d.sceneEl.systems.nav;this.navGroup=this.navGroup===null?M.getGroup(e):this.navGroup,this.navNode=this.navNode||M.getNode(e,this.navGroup),this.navNode=M.clampStep(e,t,this.navGroup,this.navNode,i),d.object3D.position.copy(i)}else d.hasAttribute("velocity")?d.setAttribute("velocity",b):(d.object3D.position.x+=b.x*c/1e3,d.object3D.position.y+=b.y*c/1e3,d.object3D.position.z+=b.z*c/1e3)}}(),updateVelocityCtrl:function(){const e=this.data;if(e.enabled){for(let t=0,i=e.controls.length;t<i;t++){const r=this.el.components[e.controls[t]+Lt];if(r&&r.isVelocityActive()){this.velocityCtrl=r;return}}this.velocityCtrl=null}},updateVelocity:function(){const e=new THREE.Vector2,t=new THREE.Quaternion;return function(i){let r;const c=this.el,d=this.velocityCtrl,m=this.velocity,T=this.data;if(d)if(d.getVelocityDelta)r=d.getVelocityDelta(i);else if(d.getVelocity){m.copy(d.getVelocity());return}else if(d.getPositionDelta){m.copy(d.getPositionDelta(i).multiplyScalar(1e3/i));return}else throw new Error("Incompatible movement controls: ",d);if(c.hasAttribute("velocity")&&!T.constrainToNavMesh&&m.copy(this.el.getAttribute("velocity")),r&&T.enabled){const b=T.camera;t.copy(b.object3D.quaternion),t.premultiply(c.object3D.quaternion),r.applyQuaternion(t);const M=r.length();T.fly?(m.copy(r),m.multiplyScalar(this.data.speed*16.66667)):(e.set(r.x,r.z),e.setLength(M*this.data.speed*16.66667),m.x=e.x,m.z=e.y)}}}()});AFRAME.registerComponent("trackpad-controls",{schema:{enabled:{default:!0},enableNegX:{default:!0},enablePosX:{default:!0},enableNegZ:{default:!0},enablePosZ:{default:!0},mode:{default:"touch",oneOf:["swipe","touch","press"]}},init:function(){this.dVelocity=new THREE.Vector3,this.zVel=0,this.xVel=0,this.bindMethods()},play:function(){this.addEventListeners()},pause:function(){this.removeEventListeners(),this.dVelocity.set(0,0,0)},remove:function(){this.pause()},addEventListeners:function(){const e=this.data,t=this.el.sceneEl;switch(t.addEventListener("axismove",this.onAxisMove),e.mode){case"swipe":case"touch":t.addEventListener("trackpadtouchstart",this.onTouchStart),t.addEventListener("trackpadtouchend",this.onTouchEnd);break;case"press":t.addEventListener("trackpaddown",this.onTouchStart),t.addEventListener("trackpadup",this.onTouchEnd);break}},removeEventListeners:function(){const e=this.el.sceneEl;e.removeEventListener("axismove",this.onAxisMove),e.removeEventListener("trackpadtouchstart",this.onTouchStart),e.removeEventListener("trackpadtouchend",this.onTouchEnd),e.removeEventListener("trackpaddown",this.onTouchStart),e.removeEventListener("trackpadup",this.onTouchEnd)},isVelocityActive:function(){return this.data.enabled&&this.isMoving},getVelocityDelta:function(){return this.dVelocity.z=this.isMoving?-this.zVel:1,this.dVelocity.x=this.isMoving?this.xVel:1,this.dVelocity.clone()},bindMethods:function(){this.onTouchStart=this.onTouchStart.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.onAxisMove=this.onAxisMove.bind(this)},onTouchStart:function(e){switch(this.data.mode){case"swipe":this.canRecordAxis=!0,this.startingAxisData=[];break;case"touch":this.isMoving=!0;break;case"press":this.isMoving=!0;break}e.preventDefault()},onTouchEnd:function(e){this.data.mode=="swipe"&&(this.startingAxisData=[]),this.isMoving=!1,e.preventDefault()},onAxisMove:function(e){switch(this.data.mode){case"swipe":return this.handleSwipeAxis(e);case"touch":case"press":return this.handleTouchAxis(e)}},handleSwipeAxis:function(e){const t=this.data,i=e.detail.axis;if(this.startingAxisData.length===0&&this.canRecordAxis&&(this.canRecordAxis=!1,this.startingAxisData[0]=i[0],this.startingAxisData[1]=i[1]),this.startingAxisData.length>0){let r=0,c=0;t.enableNegX&&i[0]<this.startingAxisData[0]&&(r=-1),t.enablePosX&&i[0]>this.startingAxisData[0]&&(r=1),t.enablePosZ&&i[1]>this.startingAxisData[1]&&(c=-1),t.enableNegZ&&i[1]<this.startingAxisData[1]&&(c=1);const d=Math.abs(this.startingAxisData[1]-i[1]);Math.abs(this.startingAxisData[0]-i[0])>d?(this.zVel=0,this.xVel=r,this.isMoving=!0):(this.xVel=0,this.zVel=c,this.isMoving=!0)}},handleTouchAxis:function(e){const t=this.data,i=e.detail.axis;let r=0,c=0;t.enableNegX&&i[0]<0&&(r=-1),t.enablePosX&&i[0]>0&&(r=1),t.enablePosZ&&i[1]>0&&(c=-1),t.enableNegZ&&i[1]<0&&(c=1),Math.abs(i[0])>Math.abs(i[1])?(this.zVel=0,this.xVel=r):(this.xVel=0,this.zVel=c)}});const at={once:THREE.LoopOnce,repeat:THREE.LoopRepeat,pingpong:THREE.LoopPingPong};AFRAME.registerComponent("animation-mixer",{schema:{clip:{default:"*"},duration:{default:0},clampWhenFinished:{default:!1,type:"boolean"},crossFadeDuration:{default:0},loop:{default:"repeat",oneOf:Object.keys(at)},repetitions:{default:1/0,min:0},timeScale:{default:1}},init:function(){this.model=null,this.mixer=null,this.activeActions=[];const e=this.el.getObject3D("mesh");e?this.load(e):this.el.addEventListener("model-loaded",t=>{this.load(t.detail.model)})},load:function(e){const t=this.el;this.model=e,this.mixer=new THREE.AnimationMixer(e),this.mixer.addEventListener("loop",i=>{t.emit("animation-loop",{action:i.action,loopDelta:i.loopDelta})}),this.mixer.addEventListener("finished",i=>{t.emit("animation-finished",{action:i.action,direction:i.direction})}),this.data.clip&&this.update({})},remove:function(){this.mixer&&this.mixer.stopAllAction()},update:function(e){if(!e)return;const t=this.data,i=AFRAME.utils.diff(t,e);if("clip"in i){this.stopAction(),t.clip&&this.playAction();return}this.activeActions.forEach(r=>{"duration"in i&&t.duration&&r.setDuration(t.duration),"clampWhenFinished"in i&&(r.clampWhenFinished=t.clampWhenFinished),("loop"in i||"repetitions"in i)&&r.setLoop(at[t.loop],t.repetitions),"timeScale"in i&&r.setEffectiveTimeScale(t.timeScale)})},stopAction:function(){const e=this.data;for(let t=0;t<this.activeActions.length;t++)e.crossFadeDuration?this.activeActions[t].fadeOut(e.crossFadeDuration):this.activeActions[t].stop();this.activeActions.length=0},playAction:function(){if(!this.mixer)return;const e=this.model,t=this.data,i=e.animations||(e.geometry||{}).animations||[];if(!i.length)return;const r=Ji(t.clip);for(let c,d=0;c=i[d];d++)if(c.name.match(r)){const m=this.mixer.clipAction(c,e);m.enabled=!0,m.clampWhenFinished=t.clampWhenFinished,t.duration&&m.setDuration(t.duration),t.timeScale!==1&&m.setEffectiveTimeScale(t.timeScale),m.setLoop(at[t.loop],t.repetitions).fadeIn(t.crossFadeDuration).play(),this.activeActions.push(m)}},tick:function(e,t){this.mixer&&!isNaN(t)&&this.mixer.update(t/1e3)}});function Ji(e){return new RegExp("^"+e.split(/\*+/).map(Yi).join(".*")+"$")}function Yi(e){return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&")}var Qi=THREE.ColladaLoader=function(e){this.manager=e!==void 0?e:THREE.DefaultLoadingManager};THREE.ColladaLoader.prototype={constructor:THREE.ColladaLoader,crossOrigin:"anonymous",load:function(e,t,i,r){var c=this,d=c.path===void 0?THREE.LoaderUtils.extractUrlBase(e):c.path,m=new THREE.FileLoader(c.manager);m.setPath(c.path),m.load(e,function(T){t(c.parse(T,d))},i,r)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},options:{set convertUpAxis(e){console.warn("THREE.ColladaLoader: options.convertUpAxis() has been removed. Up axis is converted automatically.")}},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e,t){function i(a,s){for(var h=[],v=a.childNodes,u=0,E=v.length;u<E;u++){var R=v[u];R.nodeName===s&&h.push(R)}return h}function r(a){if(a.length===0)return[];for(var s=a.trim().split(/\s+/),h=new Array(s.length),v=0,u=s.length;v<u;v++)h[v]=s[v];return h}function c(a){if(a.length===0)return[];for(var s=a.trim().split(/\s+/),h=new Array(s.length),v=0,u=s.length;v<u;v++)h[v]=parseFloat(s[v]);return h}function d(a){if(a.length===0)return[];for(var s=a.trim().split(/\s+/),h=new Array(s.length),v=0,u=s.length;v<u;v++)h[v]=parseInt(s[v]);return h}function m(a){return a.substring(1)}function T(){return"three_default_"+Ri++}function b(a){return Object.keys(a).length===0}function M(a){return{unit:A(i(a,"unit")[0]),upAxis:N(i(a,"up_axis")[0])}}function A(a){return a!==void 0&&a.hasAttribute("meter")===!0?parseFloat(a.getAttribute("meter")):1}function N(a){return a!==void 0?a.textContent:"Y_UP"}function L(a,s,h,v){var u=i(a,s)[0];if(u!==void 0)for(var E=i(u,h),R=0;R<E.length;R++)v(E[R])}function S(a,s){for(var h in a){var v=a[h];v.build=s(a[h])}}function D(a,s){return a.build!==void 0||(a.build=s(a)),a.build}function ee(a){for(var s={sources:{},samplers:{},channels:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1){var E;switch(u.nodeName){case"source":E=u.getAttribute("id"),s.sources[E]=Qe(u);break;case"sampler":E=u.getAttribute("id"),s.samplers[E]=ae(u);break;case"channel":E=u.getAttribute("target"),s.channels[E]=ie(u);break;default:console.log(u)}}}G.animations[a.getAttribute("id")]=s}function ae(a){for(var s={inputs:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"input":var E=m(u.getAttribute("source")),R=u.getAttribute("semantic");s.inputs[R]=E;break}}return s}function ie(a){var s={},h=a.getAttribute("target"),v=h.split("/"),u=v.shift(),E=v.shift(),R=E.indexOf("(")!==-1,_=E.indexOf(".")!==-1;if(_)v=E.split("."),E=v.shift(),s.member=v.shift();else if(R){var P=E.split("(");E=P.shift();for(var j=0;j<P.length;j++)P[j]=parseInt(P[j].replace(/\)/,""));s.indices=P}return s.id=u,s.sid=E,s.arraySyntax=R,s.memberSyntax=_,s.sampler=m(a.getAttribute("source")),s}function fe(a){var s=[],h=a.channels,v=a.samplers,u=a.sources;for(var E in h)if(h.hasOwnProperty(E)){var R=h[E],_=v[R.sampler],P=_.inputs.INPUT,j=_.inputs.OUTPUT,O=u[P],z=u[j],$=Ee(R,O,z);oe($,s)}return s}function he(a){return D(G.animations[a],fe)}function Ee(a,s,h){var v=G.nodes[a.id],u=De(v.id),E=v.transforms[a.sid],R=v.matrix.clone().transpose(),_,P,j,O,z,$,q={};switch(E){case"matrix":for(j=0,O=s.array.length;j<O;j++)if(_=s.array[j],P=j*h.stride,q[_]===void 0&&(q[_]={}),a.arraySyntax===!0){var W=h.array[P],I=a.indices[0]+4*a.indices[1];q[_][I]=W}else for(z=0,$=h.stride;z<$;z++)q[_][z]=h.array[P+z];break;case"translate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',E);break;case"rotate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',E);break;case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',E);break}var Z=V(q,R),J={name:u.uuid,keyframes:Z};return J}function V(a,s){var h=[];for(var v in a)h.push({time:parseFloat(v),value:a[v]});h.sort(E);for(var u=0;u<16;u++)We(h,u,s.elements[u]);return h;function E(R,_){return R.time-_.time}}var X=new THREE.Vector3,K=new THREE.Vector3,se=new THREE.Quaternion;function oe(a,s){for(var h=a.keyframes,v=a.name,u=[],E=[],R=[],_=[],P=0,j=h.length;P<j;P++){var O=h[P],z=O.time,$=O.value;ge.fromArray($).transpose(),ge.decompose(X,se,K),u.push(z),E.push(X.x,X.y,X.z),R.push(se.x,se.y,se.z,se.w),_.push(K.x,K.y,K.z)}return E.length>0&&s.push(new THREE.VectorKeyframeTrack(v+".position",u,E)),R.length>0&&s.push(new THREE.QuaternionKeyframeTrack(v+".quaternion",u,R)),_.length>0&&s.push(new THREE.VectorKeyframeTrack(v+".scale",u,_)),s}function We(a,s,h){var v,u=!0,E,R;for(E=0,R=a.length;E<R;E++)v=a[E],v.value[s]===void 0?v.value[s]=null:u=!1;if(u===!0)for(E=0,R=a.length;E<R;E++)v=a[E],v.value[s]=h;else Ze(a,s)}function Ze(a,s){for(var h,v,u=0,E=a.length;u<E;u++){var R=a[u];if(R.value[s]===null){if(h=je(a,u,s),v=n(a,u,s),h===null){R.value[s]=v.value[s];continue}if(v===null){R.value[s]=h.value[s];continue}o(R,h,v,s)}}}function je(a,s,h){for(;s>=0;){var v=a[s];if(v.value[h]!==null)return v;s--}return null}function n(a,s,h){for(;s<a.length;){var v=a[s];if(v.value[h]!==null)return v;s++}return null}function o(a,s,h,v){if(h.time-s.time===0){a.value[v]=s.value[v];return}a.value[v]=(a.time-s.time)*(h.value[v]-s.value[v])/(h.time-s.time)+s.value[v]}function l(a){for(var s={name:a.getAttribute("id")||"default",start:parseFloat(a.getAttribute("start")||0),end:parseFloat(a.getAttribute("end")||0),animations:[]},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"instance_animation":s.animations.push(m(u.getAttribute("url")));break}}G.clips[a.getAttribute("id")]=s}function f(a){for(var s=[],h=a.name,v=a.end-a.start||-1,u=a.animations,E=0,R=u.length;E<R;E++)for(var _=he(u[E]),P=0,j=_.length;P<j;P++)s.push(_[P]);return new THREE.AnimationClip(h,v,s)}function p(a){return D(G.clips[a],f)}function g(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"skin":s.id=m(u.getAttribute("source")),s.skin=y(u);break;case"morph":s.id=m(u.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.");break}}G.controllers[a.getAttribute("id")]=s}function y(a){for(var s={sources:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"bind_shape_matrix":s.bindShapeMatrix=c(u.textContent);break;case"source":var E=u.getAttribute("id");s.sources[E]=Qe(u);break;case"joints":s.joints=w(u);break;case"vertex_weights":s.vertexWeights=C(u);break}}return s}function w(a){for(var s={inputs:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"input":var E=u.getAttribute("semantic"),R=m(u.getAttribute("source"));s.inputs[E]=R;break}}return s}function C(a){for(var s={inputs:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"input":var E=u.getAttribute("semantic"),R=m(u.getAttribute("source")),_=parseInt(u.getAttribute("offset"));s.inputs[E]={id:R,offset:_};break;case"vcount":s.vcount=d(u.textContent);break;case"v":s.v=d(u.textContent);break}}return s}function H(a){var s={id:a.id},h=G.geometries[s.id];return a.skin!==void 0&&(s.skin=k(a.skin),h.sources.skinIndices=s.skin.indices,h.sources.skinWeights=s.skin.weights),s}function k(a){var s=4,h={joints:[],indices:{array:[],stride:s},weights:{array:[],stride:s}},v=a.sources,u=a.vertexWeights,E=u.vcount,R=u.v,_=u.inputs.JOINT.offset,P=u.inputs.WEIGHT.offset,j=a.sources[a.joints.inputs.JOINT],O=a.sources[a.joints.inputs.INV_BIND_MATRIX],z=v[u.inputs.WEIGHT.id].array,$=0,q,W,I;for(q=0,I=E.length;q<I;q++){var Z=E[q],J=[];for(W=0;W<Z;W++){var te=R[$+_],re=R[$+P],le=z[re];J.push({index:te,weight:le}),$+=2}for(J.sort(nt),W=0;W<s;W++){var Y=J[W];Y!==void 0?(h.indices.array.push(Y.index),h.weights.array.push(Y.weight)):(h.indices.array.push(0),h.weights.array.push(0))}}for(a.bindShapeMatrix?h.bindMatrix=new THREE.Matrix4().fromArray(a.bindShapeMatrix).transpose():h.bindMatrix=new THREE.Matrix4().identity(),q=0,I=j.array.length;q<I;q++){var me=j.array[q],U=new THREE.Matrix4().fromArray(O.array,q*O.stride).transpose();h.joints.push({name:me,boneInverse:U})}return h;function nt(qe,Ci){return Ci.weight-qe.weight}}function B(a){return D(G.controllers[a],H)}function F(a){var s={init_from:i(a,"init_from")[0].textContent};G.images[a.getAttribute("id")]=s}function ne(a){return a.build!==void 0?a.build:a.init_from}function pe(a){var s=G.images[a];return s!==void 0?D(s,ne):(console.warn("THREE.ColladaLoader: Couldn't find image with ID:",a),null)}function ue(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"profile_COMMON":s.profile=ve(u);break}}G.effects[a.getAttribute("id")]=s}function ve(a){for(var s={surfaces:{},samplers:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"newparam":ye(u,s);break;case"technique":s.technique=Te(u);break;case"extra":s.extra=Ke(u);break}}return s}function ye(a,s){for(var h=a.getAttribute("sid"),v=0,u=a.childNodes.length;v<u;v++){var E=a.childNodes[v];if(E.nodeType===1)switch(E.nodeName){case"surface":s.surfaces[h]=Fe(E);break;case"sampler2D":s.samplers[h]=Ve(E);break}}}function Fe(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"init_from":s.init_from=u.textContent;break}}return s}function Ve(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"source":s.source=u.textContent;break}}return s}function Te(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"constant":case"lambert":case"blinn":case"phong":s.type=u.nodeName,s.parameters=Je(u);break}}return s}function Je(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":s[u.nodeName]=we(u);break;case"transparent":s[u.nodeName]={opaque:u.getAttribute("opaque"),data:we(u)};break}}return s}function we(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"color":s[u.nodeName]=c(u.textContent);break;case"float":s[u.nodeName]=parseFloat(u.textContent);break;case"texture":s[u.nodeName]={id:u.getAttribute("texture"),extra:ke(u)};break}}return s}function ke(a){for(var s={technique:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"extra":Re(u,s);break}}return s}function Re(a,s){for(var h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"technique":Ge(u,s);break}}}function Ge(a,s){for(var h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":s.technique[u.nodeName]=parseFloat(u.textContent);break;case"wrapU":case"wrapV":u.textContent.toUpperCase()==="TRUE"?s.technique[u.nodeName]=1:u.textContent.toUpperCase()==="FALSE"?s.technique[u.nodeName]=0:s.technique[u.nodeName]=parseInt(u.textContent);break}}}function Ke(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"technique":s.technique=Ne(u);break}}return s}function Ne(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"double_sided":s[u.nodeName]=parseInt(u.textContent);break}}return s}function Ue(a){return a}function Ye(a){return D(G.effects[a],Ue)}function Pt(a){for(var s={name:a.getAttribute("name")},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"instance_effect":s.url=m(u.getAttribute("url"));break}}G.materials[a.getAttribute("id")]=s}function Ft(a){var s,h=a.slice((a.lastIndexOf(".")-1>>>0)+2);switch(h=h.toLowerCase(),h){case"tga":s=et;break;default:s=Ct}return s}function ft(a){var s=Ye(a.url),h=s.profile.technique,v=s.profile.extra,u;switch(h.type){case"phong":case"blinn":u=new THREE.MeshPhongMaterial;break;case"lambert":u=new THREE.MeshLambertMaterial;break;default:u=new THREE.MeshBasicMaterial;break}u.name=a.name;function E($){var q=s.profile.samplers[$.id],W=null;if(q!==void 0){var I=s.profile.surfaces[q.source];W=pe(I.init_from)}else console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),W=pe($.id);if(W!==null){var Z=Ft(W);if(Z!==void 0){var J=Z.load(W),te=$.extra;if(te!==void 0&&te.technique!==void 0&&b(te.technique)===!1){var re=te.technique;J.wrapS=re.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,J.wrapT=re.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,J.offset.set(re.offsetU||0,re.offsetV||0),J.repeat.set(re.repeatU||1,re.repeatV||1)}else J.wrapS=THREE.RepeatWrapping,J.wrapT=THREE.RepeatWrapping;return J}else return console.warn("THREE.ColladaLoader: Loader for texture %s not found.",W),null}else return console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",$.id),null}var R=h.parameters;for(var _ in R){var P=R[_];switch(_){case"diffuse":P.color&&u.color.fromArray(P.color),P.texture&&(u.map=E(P.texture));break;case"specular":P.color&&u.specular&&u.specular.fromArray(P.color),P.texture&&(u.specularMap=E(P.texture));break;case"bump":P.texture&&(u.normalMap=E(P.texture));break;case"ambient":P.texture&&(u.lightMap=E(P.texture));break;case"shininess":P.float&&u.shininess&&(u.shininess=P.float);break;case"emission":P.color&&u.emissive&&u.emissive.fromArray(P.color),P.texture&&(u.emissiveMap=E(P.texture));break}}var j=R.transparent,O=R.transparency;if(O===void 0&&j&&(O={float:1}),j===void 0&&O&&(j={opaque:"A_ONE",data:{color:[1,1,1,1]}}),j&&O)if(j.data.texture)u.transparent=!0;else{var z=j.data.color;switch(j.opaque){case"A_ONE":u.opacity=z[3]*O.float;break;case"RGB_ZERO":u.opacity=1-z[0]*O.float;break;case"A_ZERO":u.opacity=1-z[3]*O.float;break;case"RGB_ONE":u.opacity=z[0]*O.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',j.opaque)}u.opacity<1&&(u.transparent=!0)}return v!==void 0&&v.technique!==void 0&&v.technique.double_sided===1&&(u.side=THREE.DoubleSide),u}function Nt(a){return D(G.materials[a],ft)}function It(a){for(var s={name:a.getAttribute("name")},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"optics":s.optics=Bt(u);break}}G.cameras[a.getAttribute("id")]=s}function Bt(a){for(var s=0;s<a.childNodes.length;s++){var h=a.childNodes[s];switch(h.nodeName){case"technique_common":return zt(h)}}return{}}function zt(a){for(var s={},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];switch(v.nodeName){case"perspective":case"orthographic":s.technique=v.nodeName,s.parameters=jt(v);break}}return s}function jt(a){for(var s={},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];switch(v.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":s[v.nodeName]=parseFloat(v.textContent);break}}return s}function pt(a){var s;switch(a.optics.technique){case"perspective":s=new THREE.PerspectiveCamera(a.optics.parameters.yfov,a.optics.parameters.aspect_ratio,a.optics.parameters.znear,a.optics.parameters.zfar);break;case"orthographic":var h=a.optics.parameters.ymag,v=a.optics.parameters.xmag,u=a.optics.parameters.aspect_ratio;v=v===void 0?h*u:v,h=h===void 0?v/u:h,v*=.5,h*=.5,s=new THREE.OrthographicCamera(-v,v,h,-h,a.optics.parameters.znear,a.optics.parameters.zfar);break;default:s=new THREE.PerspectiveCamera;break}return s.name=a.name,s}function Vt(a){var s=G.cameras[a];return s!==void 0?D(s,pt):(console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",a),null)}function Gt(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"technique_common":s=Kt(u);break}}G.lights[a.getAttribute("id")]=s}function Kt(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"directional":case"point":case"spot":case"ambient":s.technique=u.nodeName,s.parameters=Ut(u)}}return s}function Ut(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"color":var E=c(u.textContent);s.color=new THREE.Color().fromArray(E);break;case"falloff_angle":s.falloffAngle=parseFloat(u.textContent);break;case"quadratic_attenuation":var R=parseFloat(u.textContent);s.distance=R?Math.sqrt(1/R):0;break}}return s}function vt(a){var s;switch(a.technique){case"directional":s=new THREE.DirectionalLight;break;case"point":s=new THREE.PointLight;break;case"spot":s=new THREE.SpotLight;break;case"ambient":s=new THREE.AmbientLight;break}return a.parameters.color&&s.color.copy(a.parameters.color),a.parameters.distance&&(s.distance=a.parameters.distance),s}function qt(a){var s=G.lights[a];return s!==void 0?D(s,vt):(console.warn("THREE.ColladaLoader: Couldn't find light with ID:",a),null)}function Xt(a){var s={name:a.getAttribute("name"),sources:{},vertices:{},primitives:[]},h=i(a,"mesh")[0];if(h!==void 0){for(var v=0;v<h.childNodes.length;v++){var u=h.childNodes[v];if(u.nodeType===1){var E=u.getAttribute("id");switch(u.nodeName){case"source":s.sources[E]=Qe(u);break;case"vertices":s.vertices=Wt(u);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",u.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":s.primitives.push(Zt(u));break;default:console.log(u)}}}G.geometries[a.getAttribute("id")]=s}}function Qe(a){for(var s={array:[],stride:3},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"float_array":s.array=c(v.textContent);break;case"Name_array":s.array=r(v.textContent);break;case"technique_common":var u=i(v,"accessor")[0];u!==void 0&&(s.stride=parseInt(u.getAttribute("stride")));break}}return s}function Wt(a){for(var s={},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];v.nodeType===1&&(s[v.getAttribute("semantic")]=m(v.getAttribute("source")))}return s}function Zt(a){for(var s={type:a.nodeName,material:a.getAttribute("material"),count:parseInt(a.getAttribute("count")),inputs:{},stride:0,hasUV:!1},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"input":var E=m(u.getAttribute("source")),R=u.getAttribute("semantic"),_=parseInt(u.getAttribute("offset")),P=parseInt(u.getAttribute("set")),j=P>0?R+P:R;s.inputs[j]={id:E,offset:_},s.stride=Math.max(s.stride,_+1),R==="TEXCOORD"&&(s.hasUV=!0);break;case"vcount":s.vcount=d(u.textContent);break;case"p":s.p=d(u.textContent);break}}return s}function Jt(a){for(var s={},h=0;h<a.length;h++){var v=a[h];s[v.type]===void 0&&(s[v.type]=[]),s[v.type].push(v)}return s}function Yt(a){for(var s=0,h=0,v=a.length;h<v;h++){var u=a[h];u.hasUV===!0&&s++}s>0&&s<a.length&&(a.uvsNeedsFix=!0)}function mt(a){var s={},h=a.sources,v=a.vertices,u=a.primitives;if(u.length===0)return{};var E=Jt(u);for(var R in E){var _=E[R];Yt(_),s[R]=Qt(_,h,v)}return s}function Qt(a,s,h){for(var v={},u={array:[],stride:0},E={array:[],stride:0},R={array:[],stride:0},_={array:[],stride:0},P={array:[],stride:0},j={array:[],stride:4},O={array:[],stride:4},z=new THREE.BufferGeometry,$=[],q=0,W=0;W<a.length;W++){var I=a[W],Z=I.inputs,J=0;switch(I.type){case"lines":case"linestrips":J=I.count*2;break;case"triangles":J=I.count*3;break;case"polylist":for(var te=0;te<I.count;te++){var re=I.vcount[te];switch(re){case 3:J+=3;break;case 4:J+=6;break;default:J+=(re-2)*3;break}}break;default:console.warn("THREE.ColladaLoader: Unknow primitive type:",I.type)}z.addGroup(q,J,W),q+=J,I.material&&$.push(I.material);for(var le in Z){var Y=Z[le];switch(le){case"VERTEX":for(var me in h){var U=h[me];switch(me){case"POSITION":var nt=u.array.length;if(be(I,s[U],Y.offset,u.array),u.stride=s[U].stride,s.skinWeights&&s.skinIndices&&(be(I,s.skinIndices,Y.offset,j.array),be(I,s.skinWeights,Y.offset,O.array)),I.hasUV===!1&&a.uvsNeedsFix===!0)for(var J=(u.array.length-nt)/u.stride,qe=0;qe<J;qe++)R.array.push(0,0);break;case"NORMAL":be(I,s[U],Y.offset,E.array),E.stride=s[U].stride;break;case"COLOR":be(I,s[U],Y.offset,P.array),P.stride=s[U].stride;break;case"TEXCOORD":be(I,s[U],Y.offset,R.array),R.stride=s[U].stride;break;case"TEXCOORD1":be(I,s[U],Y.offset,_.array),R.stride=s[U].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',me)}}break;case"NORMAL":be(I,s[Y.id],Y.offset,E.array),E.stride=s[Y.id].stride;break;case"COLOR":be(I,s[Y.id],Y.offset,P.array),P.stride=s[Y.id].stride;break;case"TEXCOORD":be(I,s[Y.id],Y.offset,R.array),R.stride=s[Y.id].stride;break;case"TEXCOORD1":be(I,s[Y.id],Y.offset,_.array),_.stride=s[Y.id].stride;break}}}return u.array.length>0&&z.addAttribute("position",new THREE.Float32BufferAttribute(u.array,u.stride)),E.array.length>0&&z.addAttribute("normal",new THREE.Float32BufferAttribute(E.array,E.stride)),P.array.length>0&&z.addAttribute("color",new THREE.Float32BufferAttribute(P.array,P.stride)),R.array.length>0&&z.addAttribute("uv",new THREE.Float32BufferAttribute(R.array,R.stride)),_.array.length>0&&z.addAttribute("uv2",new THREE.Float32BufferAttribute(_.array,_.stride)),j.array.length>0&&z.addAttribute("skinIndex",new THREE.Float32BufferAttribute(j.array,j.stride)),O.array.length>0&&z.addAttribute("skinWeight",new THREE.Float32BufferAttribute(O.array,O.stride)),v.data=z,v.type=a[0].type,v.materialKeys=$,v}function be(a,s,h,v){var u=a.p,E=a.stride,R=a.vcount;function _(le){for(var Y=u[le+h]*j,me=Y+j;Y<me;Y++)v.push(P[Y])}var P=s.array,j=s.stride;if(a.vcount!==void 0)for(var O=0,z=0,$=R.length;z<$;z++){var q=R[z];if(q===4){var W=O+E*0,I=O+E*1,Z=O+E*2,J=O+E*3;_(W),_(I),_(J),_(I),_(Z),_(J)}else if(q===3){var W=O+E*0,I=O+E*1,Z=O+E*2;_(W),_(I),_(Z)}else if(q>4)for(var te=1,re=q-2;te<=re;te++){var W=O+E*0,I=O+E*te,Z=O+E*(te+1);_(W),_(I),_(Z)}O+=E*q}else for(var z=0,$=u.length;z<$;z+=E)_(z)}function gt(a){return D(G.geometries[a],mt)}function $t(a){for(var s={name:a.getAttribute("name")||"",joints:{},links:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"technique_common":ii(v,s);break}}G.kinematicsModels[a.getAttribute("id")]=s}function ei(a){return a.build!==void 0?a.build:a}function ti(a){return D(G.kinematicsModels[a],ei)}function ii(a,s){for(var h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"joint":s.joints[v.getAttribute("sid")]=ni(v);break;case"link":s.links.push(yt(v));break}}}function ni(a){for(var s,h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"prismatic":case"revolute":s=ri(v);break}}return s}function ri(a,h){for(var h={sid:a.getAttribute("sid"),name:a.getAttribute("name")||"",axis:new THREE.Vector3,limits:{min:0,max:0},type:a.nodeName,static:!1,zeroPosition:0,middlePosition:0},v=0;v<a.childNodes.length;v++){var u=a.childNodes[v];if(u.nodeType===1)switch(u.nodeName){case"axis":var E=c(u.textContent);h.axis.fromArray(E);break;case"limits":var R=u.getElementsByTagName("max")[0],_=u.getElementsByTagName("min")[0];h.limits.max=parseFloat(R.textContent),h.limits.min=parseFloat(_.textContent);break}}return h.limits.min>=h.limits.max&&(h.static=!0),h.middlePosition=(h.limits.min+h.limits.max)/2,h}function yt(a){for(var s={sid:a.getAttribute("sid"),name:a.getAttribute("name")||"",attachments:[],transforms:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"attachment_full":s.attachments.push(ai(v));break;case"matrix":case"translate":case"rotate":s.transforms.push(Et(v));break}}return s}function ai(a){for(var s={joint:a.getAttribute("joint").split("/").pop(),transforms:[],links:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"link":s.links.push(yt(v));break;case"matrix":case"translate":case"rotate":s.transforms.push(Et(v));break}}return s}function Et(a){var s={type:a.nodeName},h=c(a.textContent);switch(s.type){case"matrix":s.obj=new THREE.Matrix4,s.obj.fromArray(h).transpose();break;case"translate":s.obj=new THREE.Vector3,s.obj.fromArray(h);break;case"rotate":s.obj=new THREE.Vector3,s.obj.fromArray(h),s.angle=THREE.Math.degToRad(h[3]);break}return s}function si(a){for(var s={name:a.getAttribute("name")||"",rigidBodies:{}},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"rigid_body":s.rigidBodies[v.getAttribute("name")]={},oi(v,s.rigidBodies[v.getAttribute("name")]);break}}G.physicsModels[a.getAttribute("id")]=s}function oi(a,s){for(var h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"technique_common":ci(v,s);break}}}function ci(a,s){for(var h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"inertia":s.inertia=c(v.textContent);break;case"mass":s.mass=c(v.textContent)[0];break}}}function li(a){for(var s={bindJointAxis:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"bind_joint_axis":s.bindJointAxis.push(hi(v));break}}G.kinematicsScenes[m(a.getAttribute("url"))]=s}function hi(a){for(var s={target:a.getAttribute("target").split("/").pop()},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"axis":var u=v.getElementsByTagName("param")[0];s.axis=u.textContent;var E=s.axis.split("inst_").pop().split("axis")[0];s.jointIndex=E.substr(0,E.length-1);break}}return s}function ui(a){return a.build!==void 0?a.build:a}function di(a){return D(G.kinematicsScenes[a],ui)}function fi(){var a=Object.keys(G.kinematicsModels)[0],s=Object.keys(G.kinematicsScenes)[0],h=Object.keys(G.visualScenes)[0];if(a===void 0||s===void 0)return;for(var v=ti(a),u=di(s),E=kt(h),R=u.bindJointAxis,_={},P=0,j=R.length;P<j;P++){var O=R[P],z=ce.querySelector('[sid="'+O.target+'"]');if(z){var $=z.parentElement;q(O.jointIndex,$)}}function q(I,Z){var J=Z.getAttribute("name"),te=v.joints[I];E.traverse(function(re){re.name===J&&(_[I]={object:re,transforms:pi(Z),joint:te,position:te.zeroPosition})})}var W=new THREE.Matrix4;Mt={joints:v&&v.joints,getJointValue:function(I){var Z=_[I];if(Z)return Z.position;console.warn("THREE.ColladaLoader: Joint "+I+" doesn't exist.")},setJointValue:function(I,Z){var J=_[I];if(J){var te=J.joint;if(Z>te.limits.max||Z<te.limits.min)console.warn("THREE.ColladaLoader: Joint "+I+" value "+Z+" outside of limits (min: "+te.limits.min+", max: "+te.limits.max+").");else if(te.static)console.warn("THREE.ColladaLoader: Joint "+I+" is static.");else{var re=J.object,le=te.axis,Y=J.transforms;ge.identity();for(var me=0;me<Y.length;me++){var U=Y[me];if(U.sid&&U.sid.indexOf(I)!==-1)switch(te.type){case"revolute":ge.multiply(W.makeRotationAxis(le,THREE.Math.degToRad(Z)));break;case"prismatic":ge.multiply(W.makeTranslation(le.x*Z,le.y*Z,le.z*Z));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+te.type);break}else switch(U.type){case"matrix":ge.multiply(U.obj);break;case"translate":ge.multiply(W.makeTranslation(U.obj.x,U.obj.y,U.obj.z));break;case"scale":ge.scale(U.obj);break;case"rotate":ge.multiply(W.makeRotationAxis(U.obj,U.angle));break}}re.matrix.copy(ge),re.matrix.decompose(re.position,re.quaternion,re.scale),_[I].position=Z}}else console.log("THREE.ColladaLoader: "+I+" does not exist.")}}}function pi(a){for(var s=[],h=ce.querySelector('[id="'+a.id+'"]'),v=0;v<h.childNodes.length;v++){var u=h.childNodes[v];if(u.nodeType===1)switch(u.nodeName){case"matrix":var R=c(u.textContent),E=new THREE.Matrix4().fromArray(R).transpose();s.push({sid:u.getAttribute("sid"),type:u.nodeName,obj:E});break;case"translate":case"scale":var R=c(u.textContent),_=new THREE.Vector3().fromArray(R);s.push({sid:u.getAttribute("sid"),type:u.nodeName,obj:_});break;case"rotate":var R=c(u.textContent),_=new THREE.Vector3().fromArray(R),P=THREE.Math.degToRad(R[3]);s.push({sid:u.getAttribute("sid"),type:u.nodeName,obj:_,angle:P});break}}return s}function vi(a){for(var s=a.getElementsByTagName("node"),h=0;h<s.length;h++){var v=s[h];v.hasAttribute("id")===!1&&v.setAttribute("id",T())}}var ge=new THREE.Matrix4,Oe=new THREE.Vector3;function $e(a){for(var s={name:a.getAttribute("name")||"",type:a.getAttribute("type"),id:a.getAttribute("id"),sid:a.getAttribute("sid"),matrix:new THREE.Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"node":s.nodes.push(v.getAttribute("id")),$e(v);break;case"instance_camera":s.instanceCameras.push(m(v.getAttribute("url")));break;case"instance_controller":s.instanceControllers.push(bt(v));break;case"instance_light":s.instanceLights.push(m(v.getAttribute("url")));break;case"instance_geometry":s.instanceGeometries.push(bt(v));break;case"instance_node":s.instanceNodes.push(m(v.getAttribute("url")));break;case"matrix":var E=c(v.textContent);s.matrix.multiply(ge.fromArray(E).transpose()),s.transforms[v.getAttribute("sid")]=v.nodeName;break;case"translate":var E=c(v.textContent);Oe.fromArray(E),s.matrix.multiply(ge.makeTranslation(Oe.x,Oe.y,Oe.z)),s.transforms[v.getAttribute("sid")]=v.nodeName;break;case"rotate":var E=c(v.textContent),u=THREE.Math.degToRad(E[3]);s.matrix.multiply(ge.makeRotationAxis(Oe.fromArray(E),u)),s.transforms[v.getAttribute("sid")]=v.nodeName;break;case"scale":var E=c(v.textContent);s.matrix.scale(Oe.fromArray(E)),s.transforms[v.getAttribute("sid")]=v.nodeName;break;case"extra":break;default:console.log(v)}}return xt(s.id)?console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",s.id):G.nodes[s.id]=s,s}function bt(a){for(var s={id:m(a.getAttribute("url")),materials:{},skeletons:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];switch(v.nodeName){case"bind_material":for(var u=v.getElementsByTagName("instance_material"),E=0;E<u.length;E++){var R=u[E],_=R.getAttribute("symbol"),P=R.getAttribute("target");s.materials[_]=m(P)}break;case"skeleton":s.skeletons.push(m(v.textContent));break}}return s}function mi(a,s){var h=[],v=[],u,E,R;for(u=0;u<a.length;u++){var _=a[u],P;if(xt(_))P=De(_),Tt(P,s,h);else if(Ti(_))for(var j=G.visualScenes[_],O=j.children,E=0;E<O.length;E++){var z=O[E];if(z.type==="JOINT"){var P=De(z.id);Tt(P,s,h)}}else console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",_)}for(u=0;u<s.length;u++)for(E=0;E<h.length;E++)if(R=h[E],R.bone.name===s[u].name){v[u]=R,R.processed=!0;break}for(u=0;u<h.length;u++)R=h[u],R.processed===!1&&(v.push(R),R.processed=!0);var $=[],q=[];for(u=0;u<v.length;u++)R=v[u],$.push(R.bone),q.push(R.boneInverse);return new THREE.Skeleton($,q)}function Tt(a,s,h){a.traverse(function(v){if(v.isBone===!0){for(var u,E=0;E<s.length;E++){var R=s[E];if(R.name===v.name){u=R.boneInverse;break}}u===void 0&&(u=new THREE.Matrix4),h.push({bone:v,boneInverse:u,processed:!1})}})}function gi(a){for(var s=[],h=a.matrix,v=a.nodes,u=a.type,E=a.instanceCameras,R=a.instanceControllers,_=a.instanceLights,P=a.instanceGeometries,j=a.instanceNodes,O=0,z=v.length;O<z;O++)s.push(De(v[O]));for(var O=0,z=E.length;O<z;O++){var $=Vt(E[O]);$!==null&&s.push($.clone())}for(var O=0,z=R.length;O<z;O++)for(var q=R[O],W=B(q.id),I=gt(W.id),Z=wt(I,q.materials),J=q.skeletons,te=W.skin.joints,re=mi(J,te),le=0,Y=Z.length;le<Y;le++){var U=Z[le];U.isSkinnedMesh&&(U.bind(re,W.skin.bindMatrix),U.normalizeSkinWeights()),s.push(U)}for(var O=0,z=_.length;O<z;O++){var me=qt(_[O]);me!==null&&s.push(me.clone())}for(var O=0,z=P.length;O<z;O++)for(var q=P[O],I=gt(q.id),Z=wt(I,q.materials),le=0,Y=Z.length;le<Y;le++)s.push(Z[le]);for(var O=0,z=j.length;O<z;O++)s.push(De(j[O]).clone());var U;if(v.length===0&&s.length===1)U=s[0];else{U=u==="JOINT"?new THREE.Bone:new THREE.Group;for(var O=0;O<s.length;O++)U.add(s[O])}return U.name===""&&(U.name=u==="JOINT"?a.sid:a.name),U.matrix.copy(h),U.matrix.decompose(U.position,U.quaternion,U.scale),U}var yi=new THREE.MeshBasicMaterial({color:16711935});function Ei(a,s){for(var h=[],v=0,u=a.length;v<u;v++){var E=s[a[v]];E===void 0?(console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",a[v]),h.push(yi)):h.push(Nt(E))}return h}function wt(a,s){var h=[];for(var v in a){var u=a[v],E=Ei(u.materialKeys,s);E.length===0&&(v==="lines"||v==="linestrips"?E.push(new THREE.LineBasicMaterial):E.push(new THREE.MeshPhongMaterial));var R=u.data.attributes.skinIndex!==void 0;if(R)for(var _=0,P=E.length;_<P;_++)E[_].skinning=!0;var j=E.length===1?E[0]:E,O;switch(v){case"lines":O=new THREE.LineSegments(u.data,j);break;case"linestrips":O=new THREE.Line(u.data,j);break;case"triangles":case"polylist":R?O=new THREE.SkinnedMesh(u.data,j):O=new THREE.Mesh(u.data,j);break}h.push(O)}return h}function xt(a){return G.nodes[a]!==void 0}function De(a){return D(G.nodes[a],gi)}function bi(a){var s={name:a.getAttribute("name"),children:[]};vi(a);for(var h=i(a,"node"),v=0;v<h.length;v++)s.children.push($e(h[v]));G.visualScenes[a.getAttribute("id")]=s}function At(a){var s=new THREE.Group;s.name=a.name;for(var h=a.children,v=0;v<h.length;v++){var u=h[v];s.add(De(u.id))}return s}function Ti(a){return G.visualScenes[a]!==void 0}function kt(a){return D(G.visualScenes[a],At)}function wi(a){var s=i(a,"instance_visual_scene")[0];return kt(m(s.getAttribute("url")))}function xi(){var a=G.clips;if(b(a)===!0){if(b(G.animations)===!1){var s=[];for(var h in G.animations)for(var v=he(h),u=0,E=v.length;u<E;u++)s.push(v[u]);tt.push(new THREE.AnimationClip("default",-1,s))}}else for(var h in a)tt.push(p(h))}if(e.length===0)return{scene:new THREE.Scene};var Ai=new DOMParser().parseFromString(e,"application/xml"),ce=i(Ai,"COLLADA")[0],ki=ce.getAttribute("version");console.log("THREE.ColladaLoader: File version",ki);var Rt=M(i(ce,"asset")[0]),Ct=new THREE.TextureLoader(this.manager);Ct.setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);var et;THREE.TGALoader&&(et=new THREE.TGALoader(this.manager),et.setPath(this.resourcePath||t));var tt=[],Mt={},Ri=0,G={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};L(ce,"library_animations","animation",ee),L(ce,"library_animation_clips","animation_clip",l),L(ce,"library_controllers","controller",g),L(ce,"library_images","image",F),L(ce,"library_effects","effect",ue),L(ce,"library_materials","material",Pt),L(ce,"library_cameras","camera",It),L(ce,"library_lights","light",Gt),L(ce,"library_geometries","geometry",Xt),L(ce,"library_nodes","node",$e),L(ce,"library_visual_scenes","visual_scene",bi),L(ce,"library_kinematics_models","kinematics_model",$t),L(ce,"library_physics_models","physics_model",si),L(ce,"scene","instance_kinematics_scene",li),S(G.animations,fe),S(G.clips,f),S(G.controllers,H),S(G.images,ne),S(G.effects,Ue),S(G.materials,ft),S(G.cameras,pt),S(G.lights,vt),S(G.geometries,mt),S(G.visualScenes,At),xi(),fi();var it=wi(i(ce,"scene")[0]);return Rt.upAxis==="Z_UP"&&it.quaternion.setFromEuler(new THREE.Euler(-Math.PI/2,0,0)),it.scale.multiplyScalar(Rt.unit),{animations:tt,kinematics:Mt,library:G,scene:it}}};THREE.ColladaLoader=Qi;AFRAME.registerComponent("collada-model-legacy",{schema:{type:"asset"},init:function(){this.model=null,this.loader=new THREE.ColladaLoader},update:function(){var e=this,t=this.el,i=this.data,r=this.el.sceneEl.systems.renderer;!i||(this.remove(),this.loader.load(i,function(c){e.model=c.scene,e.model.traverse(function(d){if(d.isMesh){var m=d.material;m.color&&r.applyColorCorrection(m.color),m.map&&r.applyColorCorrection(m.map),m.emissive&&r.applyColorCorrection(m.emissive),m.emissiveMap&&r.applyColorCorrection(m.emissiveMap)}}),t.setObject3D("mesh",e.model),t.emit("model-loaded",{format:"collada",model:e.model})}))},remove:function(){!this.model||this.el.removeObject3D("mesh")}});var $i=THREE.FBXLoader=function(){var e,t,i;function r(n){this.manager=n!==void 0?n:THREE.DefaultLoadingManager}r.prototype={constructor:r,crossOrigin:"anonymous",load:function(n,o,l,f){var p=this,g=THREE.LoaderUtils.extractUrlBase(n),y=new THREE.FileLoader(this.manager);y.setResponseType("arraybuffer"),y.load(n,function(w){try{var C=p.parse(w,g);o(C)}catch(H){setTimeout(function(){f&&f(H),p.manager.itemError(n)},0)}},l,f)},setCrossOrigin:function(n){return this.crossOrigin=n,this},parse:function(n,o){if(N(n))e=new b().parse(n);else{var l=oe(n);if(!L(l))throw new Error("THREE.FBXLoader: Unknown format.");if(S(l)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+S(l));e=new T().parse(l)}var f=new THREE.TextureLoader(this.manager).setPath(o).setCrossOrigin(this.crossOrigin);return new c(f).parse(e)}};function c(n){this.textureLoader=n}c.prototype={constructor:c,parse:function(){t=this.parseConnections();var n=this.parseImages(),o=this.parseTextures(n),l=this.parseMaterials(o),f=this.parseDeformers(),p=new d().parse(f);return this.parseScene(f,p,l),i},parseConnections:function(){var n=new Map;if("Connections"in e){var o=e.Connections.connections;o.forEach(function(l){var f=l[0],p=l[1],g=l[2];n.has(f)||n.set(f,{parents:[],children:[]});var y={ID:p,relationship:g};n.get(f).parents.push(y),n.has(p)||n.set(p,{parents:[],children:[]});var w={ID:f,relationship:g};n.get(p).children.push(w)})}return n},parseImages:function(){var n={},o={};if("Video"in e.Objects){var l=e.Objects.Video;for(var f in l){var p=l[f],g=parseInt(f);if(n[g]=p.RelativeFilename||p.Filename,"Content"in p){var y=p.Content instanceof ArrayBuffer&&p.Content.byteLength>0,w=typeof p.Content=="string"&&p.Content!=="";if(y||w){var C=this.parseImage(l[f]);o[p.RelativeFilename||p.Filename]=C}}}}for(var g in n){var H=n[g];o[H]!==void 0?n[g]=o[H]:n[g]=n[g].split("\\").pop()}return n},parseImage:function(n){var o=n.Content,l=n.RelativeFilename||n.Filename,f=l.slice(l.lastIndexOf(".")+1).toLowerCase(),p;switch(f){case"bmp":p="image/bmp";break;case"jpg":case"jpeg":p="image/jpeg";break;case"png":p="image/png";break;case"tif":p="image/tiff";break;case"tga":if(typeof THREE.TGALoader!="function"){console.warn("FBXLoader: THREE.TGALoader is required to load TGA textures");return}else{THREE.Loader.Handlers.get(".tga")===null&&THREE.Loader.Handlers.add(/\.tga$/i,new THREE.TGALoader),p="image/tga";break}default:console.warn('FBXLoader: Image type "'+f+'" is not supported.');return}if(typeof o=="string")return"data:"+p+";base64,"+o;var g=new Uint8Array(o);return window.URL.createObjectURL(new Blob([g],{type:p}))},parseTextures:function(n){var o=new Map;if("Texture"in e.Objects){var l=e.Objects.Texture;for(var f in l){var p=this.parseTexture(l[f],n);o.set(parseInt(f),p)}}return o},parseTexture:function(n,o){var l=this.loadTexture(n,o);l.ID=n.id,l.name=n.attrName;var f=n.WrapModeU,p=n.WrapModeV,g=f!==void 0?f.value:0,y=p!==void 0?p.value:0;if(l.wrapS=g===0?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,l.wrapT=y===0?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,"Scaling"in n){var w=n.Scaling.value;l.repeat.x=w[0],l.repeat.y=w[1]}return l},loadTexture:function(n,o){var l,f=this.textureLoader.path,p=t.get(n.id).children;p!==void 0&&p.length>0&&o[p[0].ID]!==void 0&&(l=o[p[0].ID],(l.indexOf("blob:")===0||l.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));var g,y=n.FileName.slice(-3).toLowerCase();if(y==="tga"){var w=THREE.Loader.Handlers.get(".tga");w===null?(console.warn("FBXLoader: TGALoader not found, creating empty placeholder texture for",l),g=new THREE.Texture):g=w.load(l)}else y==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating empty placeholder texture for",l),g=new THREE.Texture):g=this.textureLoader.load(l);return this.textureLoader.setPath(f),g},parseMaterials:function(n){var o=new Map;if("Material"in e.Objects){var l=e.Objects.Material;for(var f in l){var p=this.parseMaterial(l[f],n);p!==null&&o.set(parseInt(f),p)}}return o},parseMaterial:function(n,o){var l=n.id,f=n.attrName,p=n.ShadingModel;if(typeof p=="object"&&(p=p.value),!t.has(l))return null;var g=this.parseParameters(n,o,l),y;switch(p.toLowerCase()){case"phong":y=new THREE.MeshPhongMaterial;break;case"lambert":y=new THREE.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',p),y=new THREE.MeshPhongMaterial({color:3342591});break}return y.setValues(g),y.name=f,y},parseParameters:function(n,o,l){var f={};n.BumpFactor&&(f.bumpScale=n.BumpFactor.value),n.Diffuse?f.color=new THREE.Color().fromArray(n.Diffuse.value):n.DiffuseColor&&n.DiffuseColor.type==="Color"&&(f.color=new THREE.Color().fromArray(n.DiffuseColor.value)),n.DisplacementFactor&&(f.displacementScale=n.DisplacementFactor.value),n.Emissive?f.emissive=new THREE.Color().fromArray(n.Emissive.value):n.EmissiveColor&&n.EmissiveColor.type==="Color"&&(f.emissive=new THREE.Color().fromArray(n.EmissiveColor.value)),n.EmissiveFactor&&(f.emissiveIntensity=parseFloat(n.EmissiveFactor.value)),n.Opacity&&(f.opacity=parseFloat(n.Opacity.value)),f.opacity<1&&(f.transparent=!0),n.ReflectionFactor&&(f.reflectivity=n.ReflectionFactor.value),n.Shininess&&(f.shininess=n.Shininess.value),n.Specular?f.specular=new THREE.Color().fromArray(n.Specular.value):n.SpecularColor&&n.SpecularColor.type==="Color"&&(f.specular=new THREE.Color().fromArray(n.SpecularColor.value));var p=this;return t.get(l).children.forEach(function(g){var y=g.relationship;switch(y){case"Bump":f.bumpMap=p.getTexture(o,g.ID);break;case"DiffuseColor":f.map=p.getTexture(o,g.ID);break;case"DisplacementColor":f.displacementMap=p.getTexture(o,g.ID);break;case"EmissiveColor":f.emissiveMap=p.getTexture(o,g.ID);break;case"NormalMap":f.normalMap=p.getTexture(o,g.ID);break;case"ReflectionColor":f.envMap=p.getTexture(o,g.ID),f.envMap.mapping=THREE.EquirectangularReflectionMapping;break;case"SpecularColor":f.specularMap=p.getTexture(o,g.ID);break;case"TransparentColor":f.alphaMap=p.getTexture(o,g.ID),f.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",y);break}}),f},getTexture:function(n,o){return"LayeredTexture"in e.Objects&&o in e.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),o=t.get(o).children[0].ID),n.get(o)},parseDeformers:function(){var n={},o={};if("Deformer"in e.Objects){var l=e.Objects.Deformer;for(var f in l){var p=l[f],g=t.get(parseInt(f));if(p.attrType==="Skin"){var y=this.parseSkeleton(g,l);y.ID=f,g.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),y.geometryID=g.parents[0].ID,n[f]=y}else if(p.attrType==="BlendShape"){var w={id:f};w.rawTargets=this.parseMorphTargets(g,l),w.id=f,g.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),o[f]=w}}}return{skeletons:n,morphTargets:o}},parseSkeleton:function(n,o){var l=[];return n.children.forEach(function(f){var p=o[f.ID];if(p.attrType==="Cluster"){var g={ID:f.ID,indices:[],weights:[],transform:new THREE.Matrix4().fromArray(p.Transform.a),transformLink:new THREE.Matrix4().fromArray(p.TransformLink.a),linkMode:p.Mode};"Indexes"in p&&(g.indices=p.Indexes.a,g.weights=p.Weights.a),l.push(g)}}),{rawBones:l,bones:[]}},parseMorphTargets:function(n,o){for(var l=[],f=0;f<n.children.length;f++){if(f===8){console.warn("FBXLoader: maximum of 8 morph targets supported. Ignoring additional targets.");break}var p=n.children[f],g=o[p.ID],y={name:g.attrName,initialWeight:g.DeformPercent,id:g.id,fullWeights:g.FullWeights.a};if(g.attrType!=="BlendShapeChannel")return;var w=t.get(parseInt(p.ID));w.children.forEach(function(C){C.relationship===void 0&&(y.geoID=C.ID)}),l.push(y)}return l},parseScene:function(n,o,l){i=new THREE.Group;var f=this.parseModels(n.skeletons,o,l),p=e.Objects.Model,g=this;f.forEach(function(w){var C=p[w.ID];g.setLookAtProperties(w,C);var H=t.get(w.ID).parents;H.forEach(function(k){var B=f.get(k.ID);B!==void 0&&B.add(w)}),w.parent===null&&i.add(w)}),this.bindSkeleton(n.skeletons,o,f),this.createAmbientLight(),this.setupMorphMaterials();var y=new m().parse();i.children.length===1&&i.children[0].isGroup&&(i.children[0].animations=y,i=i.children[0]),i.animations=y},parseModels:function(n,o,l){var f=new Map,p=e.Objects.Model;for(var g in p){var y=parseInt(g),w=p[g],C=t.get(y),H=this.buildSkeleton(C,n,y,w.attrName);if(!H){switch(w.attrType){case"Camera":H=this.createCamera(C);break;case"Light":H=this.createLight(C);break;case"Mesh":H=this.createMesh(C,o,l);break;case"NurbsCurve":H=this.createCurve(C,o);break;case"LimbNode":case"Null":default:H=new THREE.Group;break}H.name=THREE.PropertyBinding.sanitizeNodeName(w.attrName),H.ID=y}this.setModelTransforms(H,w),f.set(y,H)}return f},buildSkeleton:function(n,o,l,f){var p=null;return n.parents.forEach(function(g){for(var y in o){var w=o[y];w.rawBones.forEach(function(C,H){if(C.ID===g.ID){var k=p;p=new THREE.Bone,p.matrixWorld.copy(C.transformLink),p.name=THREE.PropertyBinding.sanitizeNodeName(f),p.ID=l,w.bones[H]=p,k!==null&&p.add(k)}})}}),p},createCamera:function(n){var o,l;if(n.children.forEach(function(B){var F=e.Objects.NodeAttribute[B.ID];F!==void 0&&(l=F)}),l===void 0)o=new THREE.Object3D;else{var f=0;l.CameraProjectionType!==void 0&&l.CameraProjectionType.value===1&&(f=1);var p=1;l.NearPlane!==void 0&&(p=l.NearPlane.value/1e3);var g=1e3;l.FarPlane!==void 0&&(g=l.FarPlane.value/1e3);var y=window.innerWidth,w=window.innerHeight;l.AspectWidth!==void 0&&l.AspectHeight!==void 0&&(y=l.AspectWidth.value,w=l.AspectHeight.value);var C=y/w,H=45;l.FieldOfView!==void 0&&(H=l.FieldOfView.value);var k=l.FocalLength?l.FocalLength.value:null;switch(f){case 0:o=new THREE.PerspectiveCamera(H,C,p,g),k!==null&&o.setFocalLength(k);break;case 1:o=new THREE.OrthographicCamera(-y/2,y/2,w/2,-w/2,p,g);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+f+"."),o=new THREE.Object3D;break}}return o},createLight:function(n){var o,l;if(n.children.forEach(function(k){var B=e.Objects.NodeAttribute[k.ID];B!==void 0&&(l=B)}),l===void 0)o=new THREE.Object3D;else{var f;l.LightType===void 0?f=0:f=l.LightType.value;var p=16777215;l.Color!==void 0&&(p=new THREE.Color().fromArray(l.Color.value));var g=l.Intensity===void 0?1:l.Intensity.value/100;l.CastLightOnObject!==void 0&&l.CastLightOnObject.value===0&&(g=0);var y=0;l.FarAttenuationEnd!==void 0&&(l.EnableFarAttenuation!==void 0&&l.EnableFarAttenuation.value===0?y=0:y=l.FarAttenuationEnd.value);var w=1;switch(f){case 0:o=new THREE.PointLight(p,g,y,w);break;case 1:o=new THREE.DirectionalLight(p,g);break;case 2:var C=Math.PI/3;l.InnerAngle!==void 0&&(C=THREE.Math.degToRad(l.InnerAngle.value));var H=0;l.OuterAngle!==void 0&&(H=THREE.Math.degToRad(l.OuterAngle.value),H=Math.max(H,1)),o=new THREE.SpotLight(p,g,y,C,H,w);break;default:console.warn("THREE.FBXLoader: Unknown light type "+l.LightType.value+", defaulting to a THREE.PointLight."),o=new THREE.PointLight(p,g);break}l.CastShadows!==void 0&&l.CastShadows.value===1&&(o.castShadow=!0)}return o},createMesh:function(n,o,l){var f,p=null,g=null,y=[];return n.children.forEach(function(w){o.has(w.ID)&&(p=o.get(w.ID)),l.has(w.ID)&&y.push(l.get(w.ID))}),y.length>1?g=y:y.length>0?g=y[0]:(g=new THREE.MeshPhongMaterial({color:13421772}),y.push(g)),"color"in p.attributes&&y.forEach(function(w){w.vertexColors=THREE.VertexColors}),p.FBX_Deformer?(y.forEach(function(w){w.skinning=!0}),f=new THREE.SkinnedMesh(p,g)):f=new THREE.Mesh(p,g),f},createCurve:function(n,o){var l=n.children.reduce(function(p,g){return o.has(g.ID)&&(p=o.get(g.ID)),p},null),f=new THREE.LineBasicMaterial({color:3342591,linewidth:1});return new THREE.Line(l,f)},setModelTransforms:function(n,o){var l={};"RotationOrder"in o&&(l.eulerOrder=parseInt(o.RotationOrder.value)),"Lcl_Translation"in o&&(l.translation=o.Lcl_Translation.value),"RotationOffset"in o&&(l.rotationOffset=o.RotationOffset.value),"Lcl_Rotation"in o&&(l.rotation=o.Lcl_Rotation.value),"PreRotation"in o&&(l.preRotation=o.PreRotation.value),"PostRotation"in o&&(l.postRotation=o.PostRotation.value),"Lcl_Scaling"in o&&(l.scale=o.Lcl_Scaling.value);var f=X(l);n.applyMatrix(f)},setLookAtProperties:function(n,o){if("LookAtProperty"in o){var l=t.get(n.ID).children;l.forEach(function(f){if(f.relationship==="LookAtProperty"){var p=e.Objects.Model[f.ID];if("Lcl_Translation"in p){var g=p.Lcl_Translation.value;n.target!==void 0?(n.target.position.fromArray(g),i.add(n.target)):n.lookAt(new THREE.Vector3().fromArray(g))}}})}},bindSkeleton:function(n,o,l){var f=this.parsePoseNodes();for(var p in n){var g=n[p],y=t.get(parseInt(g.ID)).parents;y.forEach(function(w){if(o.has(w.ID)){var C=w.ID,H=t.get(C);H.parents.forEach(function(k){if(l.has(k.ID)){var B=l.get(k.ID);B.bind(new THREE.Skeleton(g.bones),f[k.ID])}})}})}},parsePoseNodes:function(){var n={};if("Pose"in e.Objects){var o=e.Objects.Pose;for(var l in o)if(o[l].attrType==="BindPose"){var f=o[l].PoseNode;Array.isArray(f)?f.forEach(function(p){n[p.Node]=new THREE.Matrix4().fromArray(p.Matrix.a)}):n[f.Node]=new THREE.Matrix4().fromArray(f.Matrix.a)}}return n},createAmbientLight:function(){if("GlobalSettings"in e&&"AmbientColor"in e.GlobalSettings){var n=e.GlobalSettings.AmbientColor.value,o=n[0],l=n[1],f=n[2];if(o!==0||l!==0||f!==0){var p=new THREE.Color(o,l,f);i.add(new THREE.AmbientLight(p,1))}}},setupMorphMaterials:function(){i.traverse(function(n){if(n.isMesh&&(n.geometry.morphAttributes.position||n.geometry.morphAttributes.normal)){var o=n.uuid,l=n.material.uuid,f=!1;i.traverse(function(p){p.isMesh&&p.material.uuid===l&&p.uuid!==o&&(f=!0)}),f===!0&&(n.material=n.material.clone()),n.material.morphTargets=!0}})}};function d(){}d.prototype={constructor:d,parse:function(n){var o=new Map;if("Geometry"in e.Objects){var l=e.Objects.Geometry;for(var f in l){var p=t.get(parseInt(f)),g=this.parseGeometry(p,l[f],n);o.set(parseInt(f),g)}}return o},parseGeometry:function(n,o,l){switch(o.attrType){case"Mesh":return this.parseMeshGeometry(n,o,l);case"NurbsCurve":return this.parseNurbsGeometry(o)}},parseMeshGeometry:function(n,o,l){var f=l.skeletons,p=l.morphTargets,g=n.parents.map(function(B){return e.Objects.Model[B.ID]});if(g.length!==0){var y=n.children.reduce(function(B,F){return f[F.ID]!==void 0&&(B=f[F.ID]),B},null),w=n.children.reduce(function(B,F){return p[F.ID]!==void 0&&(B=p[F.ID]),B},null),C=g[0],H={};"RotationOrder"in C&&(H.eulerOrder=C.RotationOrder.value),"GeometricTranslation"in C&&(H.translation=C.GeometricTranslation.value),"GeometricRotation"in C&&(H.rotation=C.GeometricRotation.value),"GeometricScaling"in C&&(H.scale=C.GeometricScaling.value);var k=X(H);return this.genGeometry(o,y,w,k)}},genGeometry:function(n,o,l,f){var p=new THREE.BufferGeometry;n.attrName&&(p.name=n.attrName);var g=this.parseGeoNode(n,o),y=this.genBuffers(g),w=new THREE.Float32BufferAttribute(y.vertex,3);if(f.applyToBufferAttribute(w),p.addAttribute("position",w),y.colors.length>0&&p.addAttribute("color",new THREE.Float32BufferAttribute(y.colors,3)),o&&(p.addAttribute("skinIndex",new THREE.Uint16BufferAttribute(y.weightsIndices,4)),p.addAttribute("skinWeight",new THREE.Float32BufferAttribute(y.vertexWeights,4)),p.FBX_Deformer=o),y.normal.length>0){var C=new THREE.Float32BufferAttribute(y.normal,3),H=new THREE.Matrix3().getNormalMatrix(f);H.applyToBufferAttribute(C),p.addAttribute("normal",C)}if(y.uvs.forEach(function(pe,ue){var ve="uv"+(ue+1).toString();ue===0&&(ve="uv"),p.addAttribute(ve,new THREE.Float32BufferAttribute(y.uvs[ue],2))}),g.material&&g.material.mappingType!=="AllSame"){var k=y.materialIndex[0],B=0;if(y.materialIndex.forEach(function(pe,ue){pe!==k&&(p.addGroup(B,ue-B,k),k=pe,B=ue)}),p.groups.length>0){var F=p.groups[p.groups.length-1],ne=F.start+F.count;ne!==y.materialIndex.length&&p.addGroup(ne,y.materialIndex.length-ne,k)}p.groups.length===0&&p.addGroup(0,y.materialIndex.length,y.materialIndex[0])}return this.addMorphTargets(p,n,l,f),p},parseGeoNode:function(n,o){var l={};if(l.vertexPositions=n.Vertices!==void 0?n.Vertices.a:[],l.vertexIndices=n.PolygonVertexIndex!==void 0?n.PolygonVertexIndex.a:[],n.LayerElementColor&&(l.color=this.parseVertexColors(n.LayerElementColor[0])),n.LayerElementMaterial&&(l.material=this.parseMaterialIndices(n.LayerElementMaterial[0])),n.LayerElementNormal&&(l.normal=this.parseNormals(n.LayerElementNormal[0])),n.LayerElementUV){l.uv=[];for(var f=0;n.LayerElementUV[f];)l.uv.push(this.parseUVs(n.LayerElementUV[f])),f++}return l.weightTable={},o!==null&&(l.skeleton=o,o.rawBones.forEach(function(p,g){p.indices.forEach(function(y,w){l.weightTable[y]===void 0&&(l.weightTable[y]=[]),l.weightTable[y].push({id:g,weight:p.weights[w]})})})),l},genBuffers:function(n){var o={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]},l=0,f=0,p=!1,g=[],y=[],w=[],C=[],H=[],k=[],B=this;return n.vertexIndices.forEach(function(F,ne){var pe=!1;F<0&&(F=F^-1,pe=!0);var ue=[],ve=[];if(g.push(F*3,F*3+1,F*3+2),n.color){var ye=ae(ne,l,F,n.color);w.push(ye[0],ye[1],ye[2])}if(n.skeleton){if(n.weightTable[F]!==void 0&&n.weightTable[F].forEach(function(we){ve.push(we.weight),ue.push(we.id)}),ve.length>4){p||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),p=!0);var Fe=[0,0,0,0],Ve=[0,0,0,0];ve.forEach(function(we,ke){var Re=we,Ge=ue[ke];Ve.forEach(function(Ke,Ne,Ue){if(Re>Ke){Ue[Ne]=Re,Re=Ke;var Ye=Fe[Ne];Fe[Ne]=Ge,Ge=Ye}})}),ue=Fe,ve=Ve}for(;ve.length<4;)ve.push(0),ue.push(0);for(var Te=0;Te<4;++Te)H.push(ve[Te]),k.push(ue[Te])}if(n.normal){var ye=ae(ne,l,F,n.normal);y.push(ye[0],ye[1],ye[2])}if(n.material&&n.material.mappingType!=="AllSame")var Je=ae(ne,l,F,n.material)[0];n.uv&&n.uv.forEach(function(we,ke){var Re=ae(ne,l,F,we);C[ke]===void 0&&(C[ke]=[]),C[ke].push(Re[0]),C[ke].push(Re[1])}),f++,pe&&(B.genFace(o,n,g,Je,y,w,C,H,k,f),l++,f=0,g=[],y=[],w=[],C=[],H=[],k=[])}),o},genFace:function(n,o,l,f,p,g,y,w,C,H){for(var k=2;k<H;k++)n.vertex.push(o.vertexPositions[l[0]]),n.vertex.push(o.vertexPositions[l[1]]),n.vertex.push(o.vertexPositions[l[2]]),n.vertex.push(o.vertexPositions[l[(k-1)*3]]),n.vertex.push(o.vertexPositions[l[(k-1)*3+1]]),n.vertex.push(o.vertexPositions[l[(k-1)*3+2]]),n.vertex.push(o.vertexPositions[l[k*3]]),n.vertex.push(o.vertexPositions[l[k*3+1]]),n.vertex.push(o.vertexPositions[l[k*3+2]]),o.skeleton&&(n.vertexWeights.push(w[0]),n.vertexWeights.push(w[1]),n.vertexWeights.push(w[2]),n.vertexWeights.push(w[3]),n.vertexWeights.push(w[(k-1)*4]),n.vertexWeights.push(w[(k-1)*4+1]),n.vertexWeights.push(w[(k-1)*4+2]),n.vertexWeights.push(w[(k-1)*4+3]),n.vertexWeights.push(w[k*4]),n.vertexWeights.push(w[k*4+1]),n.vertexWeights.push(w[k*4+2]),n.vertexWeights.push(w[k*4+3]),n.weightsIndices.push(C[0]),n.weightsIndices.push(C[1]),n.weightsIndices.push(C[2]),n.weightsIndices.push(C[3]),n.weightsIndices.push(C[(k-1)*4]),n.weightsIndices.push(C[(k-1)*4+1]),n.weightsIndices.push(C[(k-1)*4+2]),n.weightsIndices.push(C[(k-1)*4+3]),n.weightsIndices.push(C[k*4]),n.weightsIndices.push(C[k*4+1]),n.weightsIndices.push(C[k*4+2]),n.weightsIndices.push(C[k*4+3])),o.color&&(n.colors.push(g[0]),n.colors.push(g[1]),n.colors.push(g[2]),n.colors.push(g[(k-1)*3]),n.colors.push(g[(k-1)*3+1]),n.colors.push(g[(k-1)*3+2]),n.colors.push(g[k*3]),n.colors.push(g[k*3+1]),n.colors.push(g[k*3+2])),o.material&&o.material.mappingType!=="AllSame"&&(n.materialIndex.push(f),n.materialIndex.push(f),n.materialIndex.push(f)),o.normal&&(n.normal.push(p[0]),n.normal.push(p[1]),n.normal.push(p[2]),n.normal.push(p[(k-1)*3]),n.normal.push(p[(k-1)*3+1]),n.normal.push(p[(k-1)*3+2]),n.normal.push(p[k*3]),n.normal.push(p[k*3+1]),n.normal.push(p[k*3+2])),o.uv&&o.uv.forEach(function(B,F){n.uvs[F]===void 0&&(n.uvs[F]=[]),n.uvs[F].push(y[F][0]),n.uvs[F].push(y[F][1]),n.uvs[F].push(y[F][(k-1)*2]),n.uvs[F].push(y[F][(k-1)*2+1]),n.uvs[F].push(y[F][k*2]),n.uvs[F].push(y[F][k*2+1])})},addMorphTargets:function(n,o,l,f){if(l!==null){n.morphAttributes.position=[],n.morphAttributes.normal=[];var p=this;l.rawTargets.forEach(function(g){var y=e.Objects.Geometry[g.geoID];y!==void 0&&p.genMorphGeometry(n,o,y,f)})}},genMorphGeometry:function(n,o,l,f){var p=new THREE.BufferGeometry;l.attrName&&(p.name=l.attrName);for(var g=o.PolygonVertexIndex!==void 0?o.PolygonVertexIndex.a:[],y=o.Vertices!==void 0?o.Vertices.a.slice():[],w=l.Vertices!==void 0?l.Vertices.a:[],C=l.Indexes!==void 0?l.Indexes.a:[],H=0;H<C.length;H++){var k=C[H]*3;y[k]+=w[H*3],y[k+1]+=w[H*3+1],y[k+2]+=w[H*3+2]}var B={vertexIndices:g,vertexPositions:y},F=this.genBuffers(B),ne=new THREE.Float32BufferAttribute(F.vertex,3);ne.name=l.attrName,f.applyToBufferAttribute(ne),n.morphAttributes.position.push(ne)},parseNormals:function(n){var o=n.MappingInformationType,l=n.ReferenceInformationType,f=n.Normals.a,p=[];return l==="IndexToDirect"&&("NormalIndex"in n?p=n.NormalIndex.a:"NormalsIndex"in n&&(p=n.NormalsIndex.a)),{dataSize:3,buffer:f,indices:p,mappingType:o,referenceType:l}},parseUVs:function(n){var o=n.MappingInformationType,l=n.ReferenceInformationType,f=n.UV.a,p=[];return l==="IndexToDirect"&&(p=n.UVIndex.a),{dataSize:2,buffer:f,indices:p,mappingType:o,referenceType:l}},parseVertexColors:function(n){var o=n.MappingInformationType,l=n.ReferenceInformationType,f=n.Colors.a,p=[];return l==="IndexToDirect"&&(p=n.ColorIndex.a),{dataSize:4,buffer:f,indices:p,mappingType:o,referenceType:l}},parseMaterialIndices:function(n){var o=n.MappingInformationType,l=n.ReferenceInformationType;if(o==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:l};for(var f=n.Materials.a,p=[],g=0;g<f.length;++g)p.push(g);return{dataSize:1,buffer:f,indices:p,mappingType:o,referenceType:l}},parseNurbsGeometry:function(n){if(THREE.NURBSCurve===void 0)return console.error("THREE.FBXLoader: The loader relies on THREE.NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new THREE.BufferGeometry;var o=parseInt(n.Order);if(isNaN(o))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",n.Order,n.id),new THREE.BufferGeometry;for(var l=o-1,f=n.KnotVector.a,p=[],g=n.Points.a,y=0,w=g.length;y<w;y+=4)p.push(new THREE.Vector4().fromArray(g,y));var C,H;if(n.Form==="Closed")p.push(p[0]);else if(n.Form==="Periodic"){C=l,H=f.length-1-C;for(var y=0;y<l;++y)p.push(p[y])}var k=new THREE.NURBSCurve(l,f,p,C,H),B=k.getPoints(p.length*7),F=new Float32Array(B.length*3);B.forEach(function(pe,ue){pe.toArray(F,ue*3)});var ne=new THREE.BufferGeometry;return ne.addAttribute("position",new THREE.BufferAttribute(F,3)),ne}};function m(){}m.prototype={constructor:m,parse:function(){var n=[],o=this.parseClips();if(o===void 0)return n;for(var l in o){var f=o[l],p=this.addClip(f);n.push(p)}return n},parseClips:function(){if(e.Objects.AnimationCurve!==void 0){var n=this.parseAnimationCurveNodes();this.parseAnimationCurves(n);var o=this.parseAnimationLayers(n),l=this.parseAnimStacks(o);return l}},parseAnimationCurveNodes:function(){var n=e.Objects.AnimationCurveNode,o=new Map;for(var l in n){var f=n[l];if(f.attrName.match(/S|R|T|DeformPercent/)!==null){var p={id:f.id,attr:f.attrName,curves:{}};o.set(p.id,p)}}return o},parseAnimationCurves:function(n){var o=e.Objects.AnimationCurve;for(var l in o){var f={id:o[l].id,times:o[l].KeyTime.a.map(D),values:o[l].KeyValueFloat.a},p=t.get(f.id);if(p!==void 0){var g=p.parents[0].ID,y=p.parents[0].relationship;y.match(/X/)?n.get(g).curves.x=f:y.match(/Y/)?n.get(g).curves.y=f:y.match(/Z/)?n.get(g).curves.z=f:y.match(/d|DeformPercent/)&&n.has(g)&&(n.get(g).curves.morph=f)}}},parseAnimationLayers:function(n){var o=e.Objects.AnimationLayer,l=new Map;for(var f in o){var p=[],g=t.get(parseInt(f));if(g!==void 0){var y=g.children,w=this;y.forEach(function(C,H){if(n.has(C.ID)){var k=n.get(C.ID);if(k.curves.x!==void 0||k.curves.y!==void 0||k.curves.z!==void 0){if(p[H]===void 0){var B;t.get(C.ID).parents.forEach(function(ye){ye.relationship!==void 0&&(B=ye.ID)});var F=e.Objects.Model[B.toString()],ne={modelName:THREE.PropertyBinding.sanitizeNodeName(F.attrName),initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1],transform:w.getModelAnimTransform(F)};"PreRotation"in F&&(ne.preRotations=F.PreRotation.value),"PostRotation"in F&&(ne.postRotations=F.PostRotation.value),p[H]=ne}p[H][k.attr]=k}else if(k.curves.morph!==void 0){if(p[H]===void 0){var pe;t.get(C.ID).parents.forEach(function(Te){Te.relationship!==void 0&&(pe=Te.ID)});var ue=t.get(pe).parents[0].ID,ve=t.get(ue).parents[0].ID,B=t.get(ve).parents[0].ID,F=e.Objects.Model[B],ne={modelName:THREE.PropertyBinding.sanitizeNodeName(F.attrName),morphName:e.Objects.Deformer[pe].attrName};p[H]=ne}p[H][k.attr]=k}}}),l.set(parseInt(f),p)}}return l},getModelAnimTransform:function(n){var o={};return"RotationOrder"in n&&(o.eulerOrder=parseInt(n.RotationOrder.value)),"Lcl_Translation"in n&&(o.translation=n.Lcl_Translation.value),"RotationOffset"in n&&(o.rotationOffset=n.RotationOffset.value),"Lcl_Rotation"in n&&(o.rotation=n.Lcl_Rotation.value),"PreRotation"in n&&(o.preRotation=n.PreRotation.value),"PostRotation"in n&&(o.postRotation=n.PostRotation.value),"Lcl_Scaling"in n&&(o.scale=n.Lcl_Scaling.value),X(o)},parseAnimStacks:function(n){var o=e.Objects.AnimationStack,l={};for(var f in o){var p=t.get(parseInt(f)).children;p.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var g=n.get(p[0].ID);l[f]={name:o[f].attrName,layer:g}}return l},addClip:function(n){var o=[],l=this;return n.layer.forEach(function(f){o=o.concat(l.generateTracks(f))}),new THREE.AnimationClip(n.name,-1,o)},generateTracks:function(n){var o=[],l=new THREE.Vector3,f=new THREE.Quaternion,p=new THREE.Vector3;if(n.transform&&n.transform.decompose(l,f,p),l=l.toArray(),f=new THREE.Euler().setFromQuaternion(f).toArray(),p=p.toArray(),n.T!==void 0&&Object.keys(n.T.curves).length>0){var g=this.generateVectorTrack(n.modelName,n.T.curves,l,"position");g!==void 0&&o.push(g)}if(n.R!==void 0&&Object.keys(n.R.curves).length>0){var y=this.generateRotationTrack(n.modelName,n.R.curves,f,n.preRotations,n.postRotations);y!==void 0&&o.push(y)}if(n.S!==void 0&&Object.keys(n.S.curves).length>0){var w=this.generateVectorTrack(n.modelName,n.S.curves,p,"scale");w!==void 0&&o.push(w)}if(n.DeformPercent!==void 0){var C=this.generateMorphTrack(n);C!==void 0&&o.push(C)}return o},generateVectorTrack:function(n,o,l,f){var p=this.getTimesForAllAxes(o),g=this.getKeyframeTrackValues(p,o,l);return new THREE.VectorKeyframeTrack(n+"."+f,p,g)},generateRotationTrack:function(n,o,l,f,p){o.x!==void 0&&(this.interpolateRotations(o.x),o.x.values=o.x.values.map(THREE.Math.degToRad)),o.y!==void 0&&(this.interpolateRotations(o.y),o.y.values=o.y.values.map(THREE.Math.degToRad)),o.z!==void 0&&(this.interpolateRotations(o.z),o.z.values=o.z.values.map(THREE.Math.degToRad));var g=this.getTimesForAllAxes(o),y=this.getKeyframeTrackValues(g,o,l);f!==void 0&&(f=f.map(THREE.Math.degToRad),f.push("ZYX"),f=new THREE.Euler().fromArray(f),f=new THREE.Quaternion().setFromEuler(f)),p!==void 0&&(p=p.map(THREE.Math.degToRad),p.push("ZYX"),p=new THREE.Euler().fromArray(p),p=new THREE.Quaternion().setFromEuler(p).inverse());for(var w=new THREE.Quaternion,C=new THREE.Euler,H=[],k=0;k<y.length;k+=3)C.set(y[k],y[k+1],y[k+2],"ZYX"),w.setFromEuler(C),f!==void 0&&w.premultiply(f),p!==void 0&&w.multiply(p),w.toArray(H,k/3*4);return new THREE.QuaternionKeyframeTrack(n+".quaternion",g,H)},generateMorphTrack:function(n){var o=n.DeformPercent.curves.morph,l=o.values.map(function(p){return p/100}),f=i.getObjectByName(n.modelName).morphTargetDictionary[n.morphName];return new THREE.NumberKeyframeTrack(n.modelName+".morphTargetInfluences["+f+"]",o.times,l)},getTimesForAllAxes:function(n){var o=[];return n.x!==void 0&&(o=o.concat(n.x.times)),n.y!==void 0&&(o=o.concat(n.y.times)),n.z!==void 0&&(o=o.concat(n.z.times)),o=o.sort(function(l,f){return l-f}).filter(function(l,f,p){return p.indexOf(l)==f}),o},getKeyframeTrackValues:function(n,o,l){var f=l,p=[],g=-1,y=-1,w=-1;return n.forEach(function(C){if(o.x&&(g=o.x.times.indexOf(C)),o.y&&(y=o.y.times.indexOf(C)),o.z&&(w=o.z.times.indexOf(C)),g!==-1){var H=o.x.values[g];p.push(H),f[0]=H}else p.push(f[0]);if(y!==-1){var k=o.y.values[y];p.push(k),f[1]=k}else p.push(f[1]);if(w!==-1){var B=o.z.values[w];p.push(B),f[2]=B}else p.push(f[2])}),p},interpolateRotations:function(n){for(var o=1;o<n.values.length;o++){var l=n.values[o-1],f=n.values[o]-l,p=Math.abs(f);if(p>=180){for(var g=p/180,y=f/g,w=l+y,C=n.times[o-1],H=n.times[o]-C,k=H/g,B=C+k,F=[],ne=[];B<n.times[o];)F.push(B),B+=k,ne.push(w),w+=y;n.times=je(n.times,o,F),n.values=je(n.values,o,ne)}}}};function T(){}T.prototype={constructor:T,getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(n){this.nodeStack.push(n),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(n,o){this.currentProp=n,this.currentPropName=o},parse:function(n){this.currentIndent=0,console.log("FBXTree: ",A),this.allNodes=new A,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var o=this,l=n.split(/[\r\n]+/);return l.forEach(function(f,p){var g=f.match(/^[\s\t]*;/),y=f.match(/^[\s\t]*$/);if(!(g||y)){var w=f.match("^\\t{"+o.currentIndent+"}(\\w+):(.*){",""),C=f.match("^\\t{"+o.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),H=f.match("^\\t{"+(o.currentIndent-1)+"}}");w?o.parseNodeBegin(f,w):C?o.parseNodeProperty(f,C,l[++p]):H?o.popStack():f.match(/^[^\s\t}]/)&&o.parseNodePropertyContinued(f)}}),this.allNodes},parseNodeBegin:function(n,o){var l=o[1].trim().replace(/^"/,"").replace(/"$/,""),f=o[2].split(",").map(function(w){return w.trim().replace(/^"/,"").replace(/"$/,"")}),p={name:l},g=this.parseNodeAttr(f),y=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(l,p):l in y?(l==="PoseNode"?y.PoseNode.push(p):y[l].id!==void 0&&(y[l]={},y[l][y[l].id]=y[l]),g.id!==""&&(y[l][g.id]=p)):typeof g.id=="number"?(y[l]={},y[l][g.id]=p):l!=="Properties70"&&(l==="PoseNode"?y[l]=[p]:y[l]=p),typeof g.id=="number"&&(p.id=g.id),g.name!==""&&(p.attrName=g.name),g.type!==""&&(p.attrType=g.type),this.pushStack(p)},parseNodeAttr:function(n){var o=n[0];n[0]!==""&&(o=parseInt(n[0]),isNaN(o)&&(o=n[0]));var l="",f="";return n.length>1&&(l=n[1].replace(/^(\w+)::/,""),f=n[2]),{id:o,name:l,type:f}},parseNodeProperty:function(n,o,l){var f=o[1].replace(/^"/,"").replace(/"$/,"").trim(),p=o[2].replace(/^"/,"").replace(/"$/,"").trim();f==="Content"&&p===","&&(p=l.replace(/"/g,"").replace(/,$/,"").trim());var g=this.getCurrentNode(),y=g.name;if(y==="Properties70"){this.parseNodeSpecialProperty(n,f,p);return}if(f==="C"){var w=p.split(",").slice(1),C=parseInt(w[0]),H=parseInt(w[1]),k=p.split(",").slice(3);k=k.map(function(B){return B.trim().replace(/^"/,"")}),f="connections",p=[C,H],We(p,k),g[f]===void 0&&(g[f]=[])}f==="Node"&&(g.id=p),f in g&&Array.isArray(g[f])?g[f].push(p):f!=="a"?g[f]=p:g.a=p,this.setCurrentProp(g,f),f==="a"&&p.slice(-1)!==","&&(g.a=se(p))},parseNodePropertyContinued:function(n){var o=this.getCurrentNode();o.a+=n,n.slice(-1)!==","&&(o.a=se(o.a))},parseNodeSpecialProperty:function(n,o,l){var f=l.split('",').map(function(H){return H.trim().replace(/^\"/,"").replace(/\s/,"_")}),p=f[0],g=f[1],y=f[2],w=f[3],C=f[4];switch(g){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":C=parseFloat(C);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":C=se(C);break}this.getPrevNode()[p]={type:g,type2:y,flag:w,value:C},this.setCurrentProp(this.getPrevNode(),p)}};function b(){}b.prototype={constructor:b,parse:function(n){var o=new M(n);o.skip(23);var l=o.getUint32();console.log("THREE.FBXLoader: FBX binary version: "+l);for(var f=new A;!this.endOfContent(o);){var p=this.parseNode(o,l);p!==null&&f.add(p.name,p)}return f},endOfContent:function(n){return n.size()%16===0?(n.getOffset()+160+16&-16)>=n.size():n.getOffset()+160+16>=n.size()},parseNode:function(n,o){var l={},f=o>=7500?n.getUint64():n.getUint32(),p=o>=7500?n.getUint64():n.getUint32();o>=7500?n.getUint64():n.getUint32();var g=n.getUint8(),y=n.getString(g);if(f===0)return null;for(var w=[],C=0;C<p;C++)w.push(this.parseProperty(n));var H=w.length>0?w[0]:"",k=w.length>1?w[1]:"",B=w.length>2?w[2]:"";for(l.singleProperty=p===1&&n.getOffset()===f;f>n.getOffset();){var F=this.parseNode(n,o);F!==null&&this.parseSubNode(y,l,F)}return l.propertyList=w,typeof H=="number"&&(l.id=H),k!==""&&(l.attrName=k),B!==""&&(l.attrType=B),y!==""&&(l.name=y),l},parseSubNode:function(n,o,l){if(l.singleProperty===!0){var f=l.propertyList[0];Array.isArray(f)?(o[l.name]=l,l.a=f):o[l.name]=f}else if(n==="Connections"&&l.name==="C"){var p=[];l.propertyList.forEach(function(B,F){F!==0&&p.push(B)}),o.connections===void 0&&(o.connections=[]),o.connections.push(p)}else if(l.name==="Properties70"){var g=Object.keys(l);g.forEach(function(B){o[B]=l[B]})}else if(n==="Properties70"&&l.name==="P"){var y=l.propertyList[0],w=l.propertyList[1],C=l.propertyList[2],H=l.propertyList[3],k;y.indexOf("Lcl ")===0&&(y=y.replace("Lcl ","Lcl_")),w.indexOf("Lcl ")===0&&(w=w.replace("Lcl ","Lcl_")),w==="Color"||w==="ColorRGB"||w==="Vector"||w==="Vector3D"||w.indexOf("Lcl_")===0?k=[l.propertyList[4],l.propertyList[5],l.propertyList[6]]:k=l.propertyList[4],o[y]={type:w,type2:C,flag:H,value:k}}else o[l.name]===void 0?typeof l.id=="number"?(o[l.name]={},o[l.name][l.id]=l):o[l.name]=l:l.name==="PoseNode"?(Array.isArray(o[l.name])||(o[l.name]=[o[l.name]]),o[l.name].push(l)):o[l.name][l.id]===void 0&&(o[l.name][l.id]=l)},parseProperty:function(n){var o=n.getString(1);switch(o){case"C":return n.getBoolean();case"D":return n.getFloat64();case"F":return n.getFloat32();case"I":return n.getInt32();case"L":return n.getInt64();case"R":var l=n.getUint32();return n.getArrayBuffer(l);case"S":var l=n.getUint32();return n.getString(l);case"Y":return n.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var f=n.getUint32(),p=n.getUint32(),g=n.getUint32();if(p===0)switch(o){case"b":case"c":return n.getBooleanArray(f);case"d":return n.getFloat64Array(f);case"f":return n.getFloat32Array(f);case"i":return n.getInt32Array(f);case"l":return n.getInt64Array(f)}typeof Zlib=="undefined"&&console.error("THREE.FBXLoader: External library Inflate.min.js required, obtain or import from https://github.com/imaya/zlib.js");var y=new Zlib.Inflate(new Uint8Array(n.getArrayBuffer(g))),w=new M(y.decompress().buffer);switch(o){case"b":case"c":return w.getBooleanArray(f);case"d":return w.getFloat64Array(f);case"f":return w.getFloat32Array(f);case"i":return w.getInt32Array(f);case"l":return w.getInt64Array(f)}default:throw new Error("THREE.FBXLoader: Unknown property type "+o)}}};function M(n,o){this.dv=new DataView(n),this.offset=0,this.littleEndian=o!==void 0?o:!0}M.prototype={constructor:M,getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(n){this.offset+=n},getBoolean:function(){return(this.getUint8()&1)===1},getBooleanArray:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getBoolean());return o},getUint8:function(){var n=this.dv.getUint8(this.offset);return this.offset+=1,n},getInt16:function(){var n=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,n},getInt32:function(){var n=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,n},getInt32Array:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getInt32());return o},getUint32:function(){var n=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,n},getInt64:function(){var n,o;return this.littleEndian?(n=this.getUint32(),o=this.getUint32()):(o=this.getUint32(),n=this.getUint32()),o&2147483648?(o=~o&4294967295,n=~n&4294967295,n===4294967295&&(o=o+1&4294967295),n=n+1&4294967295,-(o*4294967296+n)):o*4294967296+n},getInt64Array:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getInt64());return o},getUint64:function(){var n,o;return this.littleEndian?(n=this.getUint32(),o=this.getUint32()):(o=this.getUint32(),n=this.getUint32()),o*4294967296+n},getFloat32:function(){var n=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,n},getFloat32Array:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getFloat32());return o},getFloat64:function(){var n=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,n},getFloat64Array:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getFloat64());return o},getArrayBuffer:function(n){var o=this.dv.buffer.slice(this.offset,this.offset+n);return this.offset+=n,o},getString:function(n){for(var o=[],l=0;l<n;l++)o[l]=this.getUint8();var f=o.indexOf(0);return f>=0&&(o=o.slice(0,f)),THREE.LoaderUtils.decodeText(new Uint8Array(o))}};function A(){}A.prototype={constructor:A,add:function(n,o){this[n]=o}};function N(n){var o="Kaydara FBX Binary  \0";return n.byteLength>=o.length&&o===oe(n,0,o.length)}function L(n){var o=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],l=0;function f(y){var w=n[y-1];return n=n.slice(l+y),l++,w}for(var p=0;p<o.length;++p){var g=f(1);if(g===o[p])return!1}return!0}function S(n){var o=/FBXVersion: (\d+)/,l=n.match(o);if(l){var f=parseInt(l[1]);return f}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function D(n){return n/46186158e3}var ee=[];function ae(n,o,l,f){var p;switch(f.mappingType){case"ByPolygonVertex":p=n;break;case"ByPolygon":p=o;break;case"ByVertice":p=l;break;case"AllSame":p=f.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+f.mappingType)}f.referenceType==="IndexToDirect"&&(p=f.indices[p]);var g=p*f.dataSize,y=g+f.dataSize;return Ze(ee,f.buffer,g,y)}var ie=new THREE.Matrix4,fe=new THREE.Euler,he=new THREE.Vector3,Ee=new THREE.Vector3,V=new THREE.Matrix4;function X(n){var o=new THREE.Matrix4;Ee.set(0,0,0),V.identity();var l=n.eulerOrder?K(n.eulerOrder):K(0);if(n.translation&&Ee.fromArray(n.translation),n.rotationOffset&&Ee.add(he.fromArray(n.rotationOffset)),n.rotation){var f=n.rotation.map(THREE.Math.degToRad);f.push(l),V.makeRotationFromEuler(fe.fromArray(f))}if(n.preRotation){var f=n.preRotation.map(THREE.Math.degToRad);f.push(l),ie.makeRotationFromEuler(fe.fromArray(f)),V.premultiply(ie)}if(n.postRotation){var f=n.postRotation.map(THREE.Math.degToRad);f.push(l),ie.makeRotationFromEuler(fe.fromArray(f)),ie.getInverse(ie),V.multiply(ie)}return n.scale&&o.scale(he.fromArray(n.scale)),o.setPosition(Ee),o.multiply(V),o}function K(n){var o=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return n===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),o[0]):o[n]}function se(n){var o=n.split(",").map(function(l){return parseFloat(l)});return o}function oe(n,o,l){return o===void 0&&(o=0),l===void 0&&(l=n.byteLength),THREE.LoaderUtils.decodeText(new Uint8Array(n,o,l))}function We(n,o){for(var l=0,f=n.length,p=o.length;l<p;l++,f++)n[f]=o[l]}function Ze(n,o,l,f){for(var p=l,g=0;p<f;p++,g++)n[g]=o[p];return n}function je(n,o,l){return n.slice(0,o).concat(l).concat(n.slice(o))}return r}();THREE.FBXLoader=$i;AFRAME.registerComponent("fbx-model",{schema:{src:{type:"asset"},crossorigin:{default:""}},init:function(){this.model=null},update:function(){const e=this.data;if(!e.src)return;this.remove();const t=new THREE.FBXLoader;e.crossorigin&&t.setCrossOrigin(e.crossorigin),t.load(e.src,this.load.bind(this))},load:function(e){this.model=e,this.el.setObject3D("mesh",e),this.el.emit("model-loaded",{format:"fbx",model:e})},remove:function(){this.model&&this.el.removeObject3D("mesh")}});function en(){return"script_"+Date.now()+"_"+Math.ceil(Math.random()*1e5)}function tn(e,t){var i=document.createElement("script");return i.type="text/javascript",i.async=!0,i.id=t,i.src=e,i}function st(e){const t=document.getElementById(e),i=t.parentNode;try{i&&i.removeChild(t)}catch{}}function nn(e){const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}function rn(e,t,i){return new i(function(r,c){const d=t.timeout||5e3,m=en(),T=tn(e,m),b=setTimeout(function(){c(new Error("Script request to "+e+" timed out")),st(m)},d),M=function(A){clearTimeout(A)};T.addEventListener("load",function(A){r({ok:!0}),M(b),st(m)}),T.addEventListener("error",function(A){c(new Error("Script request to "+e+" failed "+A)),M(b),st(m)}),nn(T)})}function an(e){return e=e||{},function(t,i){return i=i||{},rn(t,i,e.Promise||Promise)}}var sn=an;const on=sn(),cn="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r86/examples/js/loaders/GLTFLoader.js",ln=function(){let e;return function(){return e=e||on(cn),e}}();AFRAME.registerComponent("gltf-model-legacy",{schema:{type:"model"},init:function(){this.model=null,this.loader=null,this.loaderPromise=ln().then(()=>{this.loader=new THREE.GLTFLoader,this.loader.setCrossOrigin("Anonymous")})},update:function(){const e=this,t=this.el,i=this.data;!i||(this.remove(),this.loaderPromise.then(()=>{this.loader.load(i,function(c){e.model=c.scene,e.model.animations=c.animations,t.setObject3D("mesh",e.model),t.emit("model-loaded",{format:"gltf",model:e.model})})}))},remove:function(){!this.model||this.el.removeObject3D("mesh")}});AFRAME.registerComponent("object-model",{schema:{src:{type:"asset"},crossorigin:{default:""}},init:function(){this.model=null},update:function(){let e;const t=this.data;!t.src||(this.remove(),e=new THREE.ObjectLoader,t.crossorigin&&e.setCrossOrigin(t.crossorigin),e.load(t.src,i=>{i.traverse(r=>{r instanceof THREE.SkinnedMesh&&r.material&&(r.material.skinning=!!(r.geometry&&r.geometry.bones||[]).length)}),this.load(i)}))},load:function(e){this.model=e,this.el.setObject3D("mesh",e),this.el.emit("model-loaded",{format:"json",model:e})},remove:function(){this.model&&this.el.removeObject3D("mesh")}});AFRAME.registerComponent("checkpoint",{schema:{offset:{default:{x:0,y:0,z:0},type:"vec3"}},init:function(){this.active=!1,this.targetEl=null,this.fire=this.fire.bind(this),this.offset=new THREE.Vector3},update:function(){this.offset.copy(this.data.offset)},play:function(){this.el.addEventListener("click",this.fire)},pause:function(){this.el.removeEventListener("click",this.fire)},remove:function(){this.pause()},fire:function(){const e=this.el.sceneEl.querySelector("[checkpoint-controls]");if(!e)throw new Error("No `checkpoint-controls` component found.");e.components["checkpoint-controls"].setCheckpoint(this.el)},getOffset:function(){return this.offset.copy(this.data.offset)}});function hn(e){return e?Array.isArray(e)?e:e.materials?e.materials:[e]:[]}function Ie(e,t,i,r){!e||(t=t||[],e.traverse(c=>{if(!c.isMesh)return;hn(c.material).forEach(m=>{m&&!("envMap"in m)||t.length&&t.indexOf(m.name)===-1||(m.envMap=i,m.reflectivity=r,m.needsUpdate=!0)})}))}AFRAME.registerComponent("cube-env-map",{multiple:!0,schema:{path:{default:""},extension:{default:"jpg",oneOf:["jpg","png"]},format:{default:"RGBFormat",oneOf:["RGBFormat","RGBAFormat"]},enableBackground:{default:!1},reflectivity:{default:1,min:0,max:1},materials:{default:[]}},init:function(){const e=this.data;this.texture=new THREE.CubeTextureLoader().load([e.path+"posx."+e.extension,e.path+"negx."+e.extension,e.path+"posy."+e.extension,e.path+"negy."+e.extension,e.path+"posz."+e.extension,e.path+"negz."+e.extension]),this.texture.format=THREE[e.format],this.object3dsetHandler=()=>{const t=this.el.getObject3D("mesh"),i=this.data;Ie(t,i.materials,this.texture,i.reflectivity)},this.el.addEventListener("object3dset",this.object3dsetHandler)},update:function(e){const t=this.data,i=this.el.getObject3D("mesh");let r=[],c=[];if(t.materials.length&&(e.materials?(r=t.materials.filter(d=>!e.materials.includes(d)),c=e.materials.filter(d=>!t.materials.includes(d))):r=t.materials),r.length&&Ie(i,r,this.texture,t.reflectivity),c.length&&Ie(i,c,null,1),e.materials&&t.reflectivity!==e.reflectivity){const d=t.materials.filter(m=>e.materials.includes(m));d.length&&Ie(i,d,this.texture,t.reflectivity)}this.data.enableBackground&&!e.enableBackground?this.setBackground(this.texture):!this.data.enableBackground&&e.enableBackground&&this.setBackground(null)},remove:function(){this.el.removeEventListener("object3dset",this.object3dsetHandler);const e=this.el.getObject3D("mesh"),t=this.data;Ie(e,t.materials,null,1),t.enableBackground&&this.setBackground(null)},setBackground:function(e){this.el.sceneEl.object3D.background=e}});AFRAME.registerComponent("grab",{init:function(){this.system=this.el.sceneEl.systems.physics,this.GRABBED_STATE="grabbed",this.grabbing=!1,this.hitEl=null,this.physics=this.el.sceneEl.systems.physics,this.constraint=null,this.onHit=this.onHit.bind(this),this.onGripOpen=this.onGripOpen.bind(this),this.onGripClose=this.onGripClose.bind(this)},play:function(){const e=this.el;e.addEventListener("hit",this.onHit),e.addEventListener("gripdown",this.onGripClose),e.addEventListener("gripup",this.onGripOpen),e.addEventListener("trackpaddown",this.onGripClose),e.addEventListener("trackpadup",this.onGripOpen),e.addEventListener("triggerdown",this.onGripClose),e.addEventListener("triggerup",this.onGripOpen)},pause:function(){const e=this.el;e.removeEventListener("hit",this.onHit),e.removeEventListener("gripdown",this.onGripClose),e.removeEventListener("gripup",this.onGripOpen),e.removeEventListener("trackpaddown",this.onGripClose),e.removeEventListener("trackpadup",this.onGripOpen),e.removeEventListener("triggerdown",this.onGripClose),e.removeEventListener("triggerup",this.onGripOpen)},onGripClose:function(){this.grabbing=!0},onGripOpen:function(){const e=this.hitEl;this.grabbing=!1,e&&(e.removeState(this.GRABBED_STATE),this.hitEl=void 0,this.system.removeConstraint(this.constraint),this.constraint=null)},onHit:function(e){const t=e.detail.el;!t||t.is(this.GRABBED_STATE)||!this.grabbing||this.hitEl||(t.addState(this.GRABBED_STATE),this.hitEl=t,this.constraint=new CANNON.LockConstraint(this.el.body,t.body),this.system.addConstraint(this.constraint))}});const un=-9.8,dn=-15;AFRAME.registerComponent("jump-ability",{dependencies:["velocity"],schema:{on:{default:"keydown:Space gamepadbuttondown:0"},playerHeight:{default:1.764},maxJumps:{default:1},distance:{default:5},debug:{default:!1}},init:function(){this.velocity=0,this.numJumps=0;const e=this.beginJump.bind(this),t=this.data.on.split(" ");this.bindings={};for(let i=0;i<t.length;i++)this.bindings[t[i]]=e,this.el.addEventListener(t[i],e);this.bindings.collide=this.onCollide.bind(this),this.el.addEventListener("collide",this.bindings.collide)},remove:function(){for(var e in this.bindings)this.bindings.hasOwnProperty(e)&&(this.el.removeEventListener(e,this.bindings[e]),delete this.bindings[e]);this.el.removeEventListener("collide",this.bindings.collide),delete this.bindings.collide},beginJump:function(){if(this.numJumps<this.data.maxJumps){const e=this.data,t=Math.sqrt(-2*e.distance*(un+dn)),i=this.el.getAttribute("velocity");this.el.setAttribute("velocity",{x:i.x,y:t,z:i.z}),this.numJumps++,this.el.emit("jumpstart")}},onCollide:function(){this.numJumps>0&&this.el.emit("jumpend"),this.numJumps=0}});const Ht=1e-6;AFRAME.registerComponent("kinematic-body",{dependencies:["velocity"],schema:{mass:{default:5},radius:{default:1.3},linearDamping:{default:.05},enableSlopes:{default:!0},enableJumps:{default:!1}},init:function(){this.system=this.el.sceneEl.systems.physics,this.system.addComponent(this);const e=this.el,t=this.data,i=new CANNON.Vec3().copy(e.object3D.getWorldPosition(new THREE.Vector3));this.body=new CANNON.Body({material:this.system.getMaterial("staticMaterial"),position:i,mass:t.mass,linearDamping:t.linearDamping,fixedRotation:!0}),this.body.addShape(new CANNON.Sphere(t.radius),new CANNON.Vec3(0,t.radius,0)),this.body.el=this.el,this.el.body=this.body,this.system.addBody(this.body),e.hasAttribute("wasd-controls")&&console.warn("[kinematic-body] Not compatible with wasd-controls, use movement-controls.")},remove:function(){this.system.removeBody(this.body),this.system.removeComponent(this),delete this.el.body},beforeStep:function(e,t){if(!t)return;const i=this.el,r=this.data,c=this.body;r.enableJumps||c.velocity.set(0,0,0),c.position.copy(i.getAttribute("position"))},step:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3,r=new THREE.Vector3;return function(c,d){if(!d)return;let m=this.body,T=this.data,b=!1,M,A=-1/0,N,L=this.system.getContacts();d=Math.min(d,this.system.data.maxInterval*1e3),r.set(0,0,0),e.copy(this.el.getAttribute("velocity")),m.velocity.copy(e);for(var S=0,D;D=L[S];S++)if(!!D.enabled){if(m.id===D.bi.id)D.ni.negate(i);else if(m.id===D.bj.id)i.copy(D.ni);else continue;b=m.velocity.dot(i)<-Ht,b&&i.y<=.5?e.projectOnPlane(i):i.y>.5&&(M=m.id===D.bi.id?Math.abs(D.rj.y+D.bj.position.y):Math.abs(D.ri.y+D.bi.position.y),M>A&&(A=M,r.copy(i),N=m.id===D.bi.id?D.bj:D.bi))}t.copy(e).normalize(),N&&(!T.enableJumps||t.y<.5)?(T.enableSlopes?r.y<1-Ht&&r.copy(this.raycastToGround(N,r)):r.set(0,1,0),e.projectOnPlane(r)):this.system.driver.world&&e.add(this.system.driver.world.gravity.scale(d*4/1e3)),m.velocity.copy(e),this.el.setAttribute("velocity",m.velocity),this.el.setAttribute("position",m.position)}}(),raycastToGround:function(e,t){let i,r,c=this.body.position,d=this.body.position.clone();return i=new CANNON.Ray(c,d),i._updateDirection(),i.intersectBody(e),i.hasHit?(r=i.result.hitNormalWorld,Math.abs(r.y)>Math.abs(t.y)?r:t):t}});AFRAME.registerComponent("mesh-smooth",{init:function(){this.el.addEventListener("model-loaded",e=>{e.detail.model.traverse(t=>{t.isMesh&&t.geometry.computeVertexNormals()})})}});AFRAME.registerComponent("normal-material",{init:function(){this.material=new THREE.MeshNormalMaterial({flatShading:!0}),this.applyMaterial=this.applyMaterial.bind(this),this.el.addEventListener("object3dset",this.applyMaterial)},remove:function(){this.el.removeEventListener("object3dset",this.applyMaterial)},applyMaterial:function(){this.el.object3D.traverse(e=>{e.isMesh&&(e.material=this.material)})}});AFRAME.registerComponent("sphere-collider",{schema:{objects:{default:""},state:{default:"collided"},radius:{default:.05},watch:{default:!0}},init:function(){this.observer=null,this.els=[],this.collisions=[],this.handleHit=this.handleHit.bind(this),this.handleHitEnd=this.handleHitEnd.bind(this)},remove:function(){this.pause()},play:function(){const e=this.el.sceneEl;this.data.watch&&(this.observer=new MutationObserver(this.update.bind(this,null)),this.observer.observe(e,{childList:!0,subtree:!0}))},pause:function(){this.observer&&(this.observer.disconnect(),this.observer=null)},update:function(){const e=this.data;let t;e.objects?t=this.el.sceneEl.querySelectorAll(e.objects):t=this.el.sceneEl.children,this.els=Array.prototype.slice.call(t)},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3,r=new THREE.Vector3,c=new THREE.Box3,d=new Map;return function(){const m=this.el,T=this.data,b=m.getObject3D("mesh"),M=[];let A;if(!b)return;d.clear(),m.object3D.getWorldPosition(e),m.object3D.getWorldScale(i),A=T.radius*L(i),this.els.forEach(N),M.sort((S,D)=>d.get(S)>d.get(D)?1:-1).forEach(this.handleHit),M.length===0&&m.emit("hit",{el:null}),this.collisions.filter(S=>!d.has(S)).forEach(this.handleHitEnd),this.collisions=M;function N(S){let D,ee,ae,ie;!S.isEntity||(ee=S.getObject3D("mesh"),ee&&(c.setFromObject(ee).getSize(r),ie=Math.max(r.x,r.y,r.z)/2,D=Math.sqrt(2*ie*ie),c.getCenter(t),D&&(ae=e.distanceTo(t),ae<D+A&&(M.push(S),d.set(S,ae)))))}function L(S){return Math.max.apply(null,S.toArray())}}}(),handleHit:function(e){e.emit("hit"),e.addState(this.data.state),this.el.emit("hit",{el:e})},handleHitEnd:function(e){e.emit("hitend"),e.removeState(this.data.state),this.el.emit("hitend",{el:e})}});AFRAME.registerComponent("nav-mesh",{init:function(){this.system=this.el.sceneEl.systems.nav,this.hasLoadedNavMesh=!1,this.el.addEventListener("object3dset",this.loadNavMesh.bind(this))},play:function(){this.hasLoadedNavMesh||this.loadNavMesh()},loadNavMesh:function(){const e=this.el.getObject3D("mesh"),t=this.el.sceneEl.object3D;if(!e)return;let i;if(e.traverse(c=>{c.isMesh&&(i=c)}),!i)return;const r=i.geometry.isBufferGeometry?new THREE.Geometry().fromBufferGeometry(i.geometry):i.geometry.clone();t.updateMatrixWorld(),r.applyMatrix(i.matrixWorld),this.system.setNavMeshGeometry(r),this.hasLoadedNavMesh=!0}});AFRAME.registerComponent("nav-agent",{schema:{destination:{type:"vec3"},active:{default:!1},speed:{default:2}},init:function(){this.system=this.el.sceneEl.systems.nav,this.system.addAgent(this),this.group=null,this.path=[],this.raycaster=new THREE.Raycaster},remove:function(){this.system.removeAgent(this)},update:function(){this.path.length=0},updateNavLocation:function(){this.group=null,this.path=[]},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3;return function(r,c){const d=this.el,m=this.data,T=this.raycaster,b=m.speed*c/1e3;if(!m.active)return;if(!this.path.length){const D=this.el.object3D.position;this.group=this.group||this.system.getGroup(D),this.path=this.system.getPath(D,e.copy(m.destination),this.group)||[],d.emit("navigation-start")}if(!this.path.length){console.warn("[nav] Unable to find path to %o.",m.destination),this.el.setAttribute("nav-agent",{active:!1}),d.emit("navigation-end");return}const M=d.object3D.position,A=this.path[0];t.subVectors(A,M);const N=t.length();let L;if(N<b){if(this.path.shift(),!this.path.length){this.el.setAttribute("nav-agent",{active:!1}),d.emit("navigation-end");return}i.copy(M),L=this.path[0]}else i.copy(t.setLength(b)).add(M),L=A;L.y=M.y,d.object3D.lookAt(L),T.ray.origin.copy(i),T.ray.origin.y+=1.5,T.ray.direction.y=-1;const S=T.intersectObject(this.system.getNavMesh());S.length?(t.subVectors(S[0].point,M),M.add(t.setLength(b))):M.copy(i)}}()});var Q=function(){};Q.computeCentroids=function(e){var t,i,r;for(t=0,i=e.faces.length;t<i;t++)(r=e.faces[t]).centroid=new THREE.Vector3(0,0,0),r.centroid.add(e.vertices[r.a]),r.centroid.add(e.vertices[r.b]),r.centroid.add(e.vertices[r.c]),r.centroid.divideScalar(3)},Q.roundNumber=function(e,t){return Number(e.toFixed(t))},Q.sample=function(e){return e[Math.floor(Math.random()*e.length)]},Q.mergeVertexIds=function(e,t){var i=[];if(e.forEach(function(b){t.indexOf(b)>=0&&i.push(b)}),i.length<2)return[];i.includes(e[0])&&i.includes(e[e.length-1])&&e.push(e.shift()),i.includes(t[0])&&i.includes(t[t.length-1])&&t.push(t.shift()),i=[],e.forEach(function(b){t.includes(b)&&i.push(b)});for(var r=i[1],c=i[0],d=e.slice();d[0]!==r;)d.push(d.shift());for(var m=0,T=t.slice();T[0]!==c;)if(T.push(T.shift()),m++>10)throw new Error("Unexpected state");return T.shift(),T.pop(),d=d.concat(T)},Q.setPolygonCentroid=function(e,t){var i=new THREE.Vector3,r=t.vertices;e.vertexIds.forEach(function(c){i.add(r[c])}),i.divideScalar(e.vertexIds.length),e.centroid.copy(i)},Q.cleanPolygon=function(e,t){for(var i=[],r=t.vertices,c=0;c<e.vertexIds.length;c++){var d,m,T,b=r[e.vertexIds[c]];c===0?(d=e.vertexIds[1],m=e.vertexIds[e.vertexIds.length-1]):c===e.vertexIds.length-1?(d=e.vertexIds[0],m=e.vertexIds[e.vertexIds.length-2]):(d=e.vertexIds[c+1],m=e.vertexIds[c-1]),T=r[m];var M=r[d].clone().sub(b),A=T.clone().sub(b),N=M.angleTo(A);if(N>Math.PI-.01&&N<Math.PI+.01){var L=[];e.neighbours.forEach(function(S){S.vertexIds.includes(e.vertexIds[c])||L.push(S)}),e.neighbours=L}else i.push(e.vertexIds[c])}e.vertexIds=i,this.setPolygonCentroid(e,t)},Q.isConvex=function(e,t){var i=t.vertices;if(e.vertexIds.length<3)return!1;for(var r=!0,c=[],d=0;d<e.vertexIds.length;d++){var m,T,b=i[e.vertexIds[d]];d===0?(m=i[e.vertexIds[1]],T=i[e.vertexIds[e.vertexIds.length-1]]):d===e.vertexIds.length-1?(m=i[e.vertexIds[0]],T=i[e.vertexIds[e.vertexIds.length-2]]):(m=i[e.vertexIds[d+1]],T=i[e.vertexIds[d-1]]);var M=m.clone().sub(b),A=T.clone().sub(b),N=M.angleTo(A);if(N===Math.PI||N===0)return!1;var L=M.cross(A).y;c.push(L)}return c.forEach(function(S){S===0&&(r=!1)}),c.forEach(c[0]>0?function(S){S<0&&(r=!1)}:function(S){S>0&&(r=!1)}),r},Q.distanceToSquared=function(e,t){var i=e.x-t.x,r=e.y-t.y,c=e.z-t.z;return i*i+r*r+c*c},Q.isPointInPoly=function(e,t){for(var i=!1,r=-1,c=e.length,d=c-1;++r<c;d=r)(e[r].z<=t.z&&t.z<e[d].z||e[d].z<=t.z&&t.z<e[r].z)&&t.x<(e[d].x-e[r].x)*(t.z-e[r].z)/(e[d].z-e[r].z)+e[r].x&&(i=!i);return i},Q.isVectorInPolygon=function(e,t,i){var r=1e5,c=-1e5,d=[];return t.vertexIds.forEach(function(m){r=Math.min(i[m].y,r),c=Math.max(i[m].y,c),d.push(i[m])}),!!(e.y<c+.5&&e.y>r-.5&&this.isPointInPoly(d,e))},Q.triarea2=function(e,t,i){return(i.x-e.x)*(t.z-e.z)-(t.x-e.x)*(i.z-e.z)},Q.vequal=function(e,t){return this.distanceToSquared(e,t)<1e-5};var Me=function(e){this.content=[],this.scoreFunction=e};Me.prototype.push=function(e){this.content.push(e),this.sinkDown(this.content.length-1)},Me.prototype.pop=function(){var e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e},Me.prototype.remove=function(e){var t=this.content.indexOf(e),i=this.content.pop();t!==this.content.length-1&&(this.content[t]=i,this.scoreFunction(i)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))},Me.prototype.size=function(){return this.content.length},Me.prototype.rescoreElement=function(e){this.sinkDown(this.content.indexOf(e))},Me.prototype.sinkDown=function(e){for(var t=this.content[e];e>0;){var i=(e+1>>1)-1,r=this.content[i];if(!(this.scoreFunction(t)<this.scoreFunction(r)))break;this.content[i]=t,this.content[e]=r,e=i}},Me.prototype.bubbleUp=function(e){for(var t=this.content.length,i=this.content[e],r=this.scoreFunction(i);;){var c=e+1<<1,d=c-1,m=null,T=void 0;if(d<t&&(T=this.scoreFunction(this.content[d]))<r&&(m=d),c<t&&this.scoreFunction(this.content[c])<(m===null?r:T)&&(m=c),m===null)break;this.content[e]=this.content[m],this.content[m]=i,e=m}};var He=function(){};He.init=function(e){for(var t=0;t<e.length;t++){var i=e[t];i.f=0,i.g=0,i.h=0,i.cost=1,i.visited=!1,i.closed=!1,i.parent=null}},He.cleanUp=function(e){for(var t=0;t<e.length;t++){var i=e[t];delete i.f,delete i.g,delete i.h,delete i.cost,delete i.visited,delete i.closed,delete i.parent}},He.heap=function(){return new Me(function(e){return e.f})},He.search=function(e,t,i){this.init(e);var r=this.heap();for(r.push(t);r.size()>0;){var c=r.pop();if(c===i){for(var d=c,m=[];d.parent;)m.push(d),d=d.parent;return this.cleanUp(m),m.reverse()}c.closed=!0;for(var T=this.neighbours(e,c),b=0,M=T.length;b<M;b++){var A=T[b];if(!A.closed){var N=c.g+A.cost,L=A.visited;if(!L||N<A.g){if(A.visited=!0,A.parent=c,!A.centroid||!i.centroid)throw new Error("Unexpected state");A.h=A.h||this.heuristic(A.centroid,i.centroid),A.g=N,A.f=A.g+A.h,L?r.rescoreElement(A):r.push(A)}}}}return[]},He.heuristic=function(e,t){return Q.distanceToSquared(e,t)},He.neighbours=function(e,t){for(var i=[],r=0;r<t.neighbours.length;r++)i.push(e[t.neighbours[r]]);return i};var fn=1,_e=function(){};_e.buildZone=function(e){var t=this,i=this._buildNavigationMesh(e),r={};i.vertices.forEach(function(m){m.x=Q.roundNumber(m.x,2),m.y=Q.roundNumber(m.y,2),m.z=Q.roundNumber(m.z,2)}),r.vertices=i.vertices;var c=this._buildPolygonGroups(i);r.groups=[];var d=function(m,T){for(var b=0;b<m.length;b++)if(T===m[b])return b};return c.forEach(function(m){var T=[];m.forEach(function(b){var M=b.neighbours.map(function(N){return d(m,N)}),A=b.neighbours.map(function(N){return t._getSharedVerticesInOrder(b,N)});b.centroid.x=Q.roundNumber(b.centroid.x,2),b.centroid.y=Q.roundNumber(b.centroid.y,2),b.centroid.z=Q.roundNumber(b.centroid.z,2),T.push({id:d(m,b),neighbours:M,vertexIds:b.vertexIds,centroid:b.centroid,portals:A})}),r.groups.push(T)}),r},_e._buildNavigationMesh=function(e){return Q.computeCentroids(e),e.mergeVertices(),this._buildPolygonsFromGeometry(e)},_e._buildPolygonGroups=function(e){var t=[],i=0,r=function(c){c.neighbours.forEach(function(d){d.group===void 0&&(d.group=c.group,r(d))})};return e.polygons.forEach(function(c){c.group===void 0&&(c.group=i++,r(c)),t[c.group]||(t[c.group]=[]),t[c.group].push(c)}),t},_e._buildPolygonNeighbours=function(e,t,i){var r=new Set,c=i.get(e.vertexIds[0]),d=i.get(e.vertexIds[1]),m=i.get(e.vertexIds[2]);c.forEach(function(T){(d.has(T)||m.has(T))&&r.add(t.polygons[T])}),d.forEach(function(T){m.has(T)&&r.add(t.polygons[T])}),e.neighbours=Array.from(r)},_e._buildPolygonsFromGeometry=function(e){for(var t=this,i=[],r=e.vertices,c=e.faceVertexUvs,d=new Map,m=0;m<r.length;m++)d.set(m,new Set);e.faces.forEach(function(b){i.push({id:fn++,vertexIds:[b.a,b.b,b.c],centroid:b.centroid,normal:b.normal,neighbours:[]}),d.get(b.a).add(i.length-1),d.get(b.b).add(i.length-1),d.get(b.c).add(i.length-1)});var T={polygons:i,vertices:r,faceVertexUvs:c};return i.forEach(function(b){t._buildPolygonNeighbours(b,T,d)}),T},_e._getSharedVerticesInOrder=function(e,t){var i=e.vertexIds,r=t.vertexIds,c=new Set;if(i.forEach(function(m){r.includes(m)&&c.add(m)}),c.size<2)return[];c.has(i[0])&&c.has(i[i.length-1])&&i.push(i.shift()),c.has(r[0])&&c.has(r[r.length-1])&&r.push(r.shift());var d=[];return i.forEach(function(m){r.includes(m)&&d.push(m)}),d};var dt=function(){this.portals=[]};dt.prototype.push=function(e,t){t===void 0&&(t=e),this.portals.push({left:e,right:t})},dt.prototype.stringPull=function(){var e,t,i,r=this.portals,c=[],d=0,m=0,T=0;t=r[0].left,i=r[0].right,c.push(e=r[0].left);for(var b=1;b<r.length;b++){var M=r[b].left,A=r[b].right;if(Q.triarea2(e,i,A)<=0){if(!(Q.vequal(e,i)||Q.triarea2(e,t,A)>0)){c.push(t),t=e=t,i=e,m=d=m,T=d,b=d;continue}i=A,T=b}if(Q.triarea2(e,t,M)>=0){if(!(Q.vequal(e,t)||Q.triarea2(e,i,M)<0)){c.push(i),t=e=i,i=e,m=d=T,T=d,b=d;continue}t=M,m=b}}return c.length!==0&&Q.vequal(c[c.length-1],r[r.length-1].left)||c.push(r[r.length-1].left),this.path=c,c};var ot,ct,Le,lt,ht,Xe,Se=function(){this.zones={}};Se.createZone=function(e){return _e.buildZone(e)},Se.prototype.setZoneData=function(e,t){this.zones[e]=t},Se.prototype.getGroup=function(e,t){if(!this.zones[e])return null;var i=null,r=Math.pow(50,2);return this.zones[e].groups.forEach(function(c,d){c.forEach(function(m){var T=Q.distanceToSquared(m.centroid,t);T<r&&(i=d,r=T)})}),i},Se.prototype.getRandomNode=function(e,t,i,r){if(!this.zones[e])return new THREE.Vector3;i=i||null,r=r||0;var c=[];return this.zones[e].groups[t].forEach(function(d){i&&r?Q.distanceToSquared(i,d.centroid)<r*r&&c.push(d.centroid):c.push(d.centroid)}),Q.sample(c)||new THREE.Vector3},Se.prototype.getClosestNode=function(e,t,i,r){r===void 0&&(r=!1);var c=this.zones[t].vertices,d=null,m=1/0;return this.zones[t].groups[i].forEach(function(T){var b=Q.distanceToSquared(T.centroid,e);b<m&&(!r||Q.isVectorInPolygon(e,T,c))&&(d=T,m=b)}),d},Se.prototype.findPath=function(e,t,i,r){var c=this.zones[i].groups[r],d=this.zones[i].vertices,m=this.getClosestNode(e,i,r),T=this.getClosestNode(t,i,r,!0);if(!m||!T)return null;var b=He.search(c,m,T),M=function(ee,ae){for(var ie=0;ie<ee.neighbours.length;ie++)if(ee.neighbours[ie]===ae.id)return ee.portals[ie]},A=new dt;A.push(e);for(var N=0;N<b.length;N++){var L=b[N+1];if(L){var S=M(b[N],L);A.push(d[S[0]],d[S[1]])}}A.push(t),A.stringPull();var D=A.path.map(function(ee){return new THREE.Vector3(ee.x,ee.y,ee.z)});return D.shift(),D},Se.prototype.clampStep=(Le=new THREE.Vector3,lt=new THREE.Plane,ht=new THREE.Triangle,Xe=new THREE.Vector3,function(e,t,i,r,c,d){var m=this.zones[r].vertices,T=this.zones[r].groups[c],b=[i],M={};M[i.id]=0,ot=void 0,Xe.set(0,0,0),ct=1/0,lt.setFromCoplanarPoints(m[i.vertexIds[0]],m[i.vertexIds[1]],m[i.vertexIds[2]]),lt.projectPoint(t,Le),t.copy(Le);for(var A=b.pop();A;A=b.pop()){ht.set(m[A.vertexIds[0]],m[A.vertexIds[1]],m[A.vertexIds[2]]),ht.closestPointToPoint(t,Le),Le.distanceToSquared(t)<ct&&(ot=A,Xe.copy(Le),ct=Le.distanceToSquared(t));var N=M[A];if(!(N>2))for(var L=0;L<A.neighbours.length;L++){var S=T[A.neighbours[L]];S.id in M||(b.push(S),M[S.id]=N+1)}}return d.copy(Xe),ot});var pn=Object.freeze(Object.defineProperty({__proto__:null,Pathfinding:Se},Symbol.toStringTag,{value:"Module"})),vn=ji(pn);const{Pathfinding:Ot}=vn,Be=new Ot,ze="level";AFRAME.registerSystem("nav",{init:function(){this.navMesh=null,this.agents=new Set},setNavMeshGeometry:function(e){this.navMesh=new THREE.Mesh(e),Be.setZoneData(ze,Ot.createZone(e)),Array.from(this.agents).forEach(t=>t.updateNavLocation())},getNavMesh:function(){return this.navMesh},addAgent:function(e){this.agents.add(e)},removeAgent:function(e){this.agents.delete(e)},getPath:function(e,t,i){return this.navMesh?Be.findPath(e,t,ze,i):null},getGroup:function(e){return this.navMesh?Be.getGroup(ze,e):null},getNode:function(e,t){return this.navMesh?Be.getClosestNode(e,ze,t,!0):null},clampStep:function(e,t,i,r,c){if(this.navMesh){if(!r)return c.copy(t),this.getNode(t,i)}else return c.copy(t),null;return Be.clampStep(e,t,r,ze,i,c)}});AFRAME.registerPrimitive("a-grid",{defaultComponents:{geometry:{primitive:"plane",width:75,height:75},rotation:{x:-90,y:0,z:0},material:{src:"url(https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v1.16.3/assets/grid.png)",repeat:"75 75"}},mappings:{width:"geometry.width",height:"geometry.height",src:"material.src"}});var Dt={exports:{}},x=Dt.exports={VERSION:"0.1.1",PI:Math.PI,TAU:2*Math.PI,DEG_TO_RAD:.0174532925,RAD_TO_DEG:57.2957795,SQRT3:Math.sqrt(3),TILE:"tile",ENT:"entity",STR:"structure",HEX:"hex",SQR:"square",ABS:"abstract"};x.Board=function(e,t){if(!e)throw new Error("You must pass in a grid system for the board to use.");this.tiles=[],this.tileGroup=null,this.group=new THREE.Object3D,this.grid=null,this.overlay=null,this.finder=new x.AStarFinder(t),x.Loader.init(),this.setGrid(e)},x.Board.prototype={setEntityOnTile:function(e,t){var i=this.grid.cellToPixel(t.cell);e.position.copy(i),e.position.y+=e.heightOffset||0,e.tile&&(e.tile.entity=null),e.tile=t,t.entity=e},addTile:function(e){var t=this.tiles.indexOf(e);t===-1&&(this.tiles.push(e),this.snapTileToGrid(e),e.position.y=0,this.tileGroup.add(e.mesh),this.grid.add(e.cell),e.cell.tile=e)},removeTile:function(e){if(e){var t=this.tiles.indexOf(e);this.grid.remove(e.cell),t!==-1&&this.tiles.splice(t,1),e.dispose()}},removeAllTiles:function(){if(this.tileGroup)for(var e=this.tileGroup.children,t=0;t<e.length;t++)this.tileGroup.remove(e[t])},getTileAtCell:function(e){var t=this.grid.cellToHash(e);return e.tile||(typeof this.grid.cells[t]!="undefined"?this.grid.cells[t].tile:null)},snapToGrid:function(e){var t=this.grid.pixelToCell(e);e.copy(this.grid.cellToPixel(t))},snapTileToGrid:function(e){if(e.cell)e.position.copy(this.grid.cellToPixel(e.cell));else{var t=this.grid.pixelToCell(e.position);e.position.copy(this.grid.cellToPixel(t))}return e},getRandomTile:function(){var e=x.Tools.randomInt(0,this.tiles.length-1);return this.tiles[e]},findPath:function(e,t,i){return this.finder.findPath(e.cell,t.cell,i,this.grid)},setGrid:function(e){this.group.remove(this.tileGroup),this.grid&&e!==this.grid&&(this.removeAllTiles(),this.tiles.forEach(function(t){this.grid.remove(t.cell),t.dispose()}),this.grid.dispose()),this.grid=e,this.tiles=[],this.tileGroup=new THREE.Object3D,this.group.add(this.tileGroup)},generateOverlay:function(e){var t=new THREE.LineBasicMaterial({color:0,opacity:.3});this.overlay&&this.group.remove(this.overlay),this.overlay=new THREE.Object3D,this.grid.generateOverlay(e,this.overlay,t),this.group.add(this.overlay)},generateTilemap:function(e){this.reset();var t=this.grid.generateTiles(e);this.tiles=t,this.tileGroup=new THREE.Object3D;for(var i=0;i<t.length;i++)this.tileGroup.add(t[i].mesh);this.group.add(this.tileGroup)},reset:function(){this.removeAllTiles(),this.tileGroup&&this.group.remove(this.tileGroup)}},x.Board.prototype.constructor=x.Board,x.Cell=function(e,t,i,r){this.q=e||0,this.r=t||0,this.s=i||0,this.h=r||1,this.tile=null,this.userData={},this.walkable=!0,this._calcCost=0,this._priority=0,this._visited=!1,this._parent=null,this.uniqueID=x.LinkedList.generateID()},x.Cell.prototype={set:function(e,t,i){return this.q=e,this.r=t,this.s=i,this},copy:function(e){return this.q=e.q,this.r=e.r,this.s=e.s,this.h=e.h,this.tile=e.tile||null,this.userData=e.userData||{},this.walkable=e.walkable,this},add:function(e){return this.q+=e.q,this.r+=e.r,this.s+=e.s,this},equals:function(e){return this.q===e.q&&this.r===e.r&&this.s===e.s}},x.Cell.prototype.constructor=x.Cell,x.HexGrid=function(e){e=e||{},this.type=x.HEX,this.size=5,this.cellSize=typeof e.cellSize=="undefined"?10:e.cellSize,this.cells={},this.numCells=0,this.extrudeSettings=null,this.autogenerated=!1;var t,i=[];for(t=0;6>t;t++)i.push(this._createVertex(t));for(this.cellShape=new THREE.Shape,this.cellShape.moveTo(i[0].x,i[0].y),t=1;6>t;t++)this.cellShape.lineTo(i[t].x,i[t].y);this.cellShape.lineTo(i[0].x,i[0].y),this.cellShape.autoClose=!0,this.cellGeo=new THREE.Geometry,this.cellGeo.vertices=i,this.cellGeo.verticesNeedUpdate=!0,this.cellShapeGeo=new THREE.ShapeGeometry(this.cellShape),this._cellWidth=2*this.cellSize,this._cellLength=.5*x.SQRT3*this._cellWidth,this._hashDelimeter=".",this._directions=[new x.Cell(1,-1,0),new x.Cell(1,0,-1),new x.Cell(0,1,-1),new x.Cell(-1,1,0),new x.Cell(-1,0,1),new x.Cell(0,-1,1)],this._diagonals=[new x.Cell(2,-1,-1),new x.Cell(1,1,-2),new x.Cell(-1,2,-1),new x.Cell(-2,1,1),new x.Cell(-1,-1,2),new x.Cell(1,-2,1)],this._list=[],this._vec3=new THREE.Vector3,this._cel=new x.Cell,this._conversionVec=new THREE.Vector3,this._geoCache=[],this._matCache=[]},x.HexGrid.TWO_THIRDS=2/3,x.HexGrid.prototype={cellToPixel:function(e){return this._vec3.x=e.q*this._cellWidth*.75,this._vec3.y=e.h,this._vec3.z=-((e.s-e.r)*this._cellLength*.5),this._vec3},pixelToCell:function(e){var t=e.x*(x.HexGrid.TWO_THIRDS/this.cellSize),i=(-e.x/3+x.SQRT3/3*e.z)/this.cellSize;return this._cel.set(t,i,-t-i),this._cubeRound(this._cel)},getCellAt:function(e){var t=e.x*(x.HexGrid.TWO_THIRDS/this.cellSize),i=(-e.x/3+x.SQRT3/3*e.z)/this.cellSize;return this._cel.set(t,i,-t-i),this._cubeRound(this._cel),this.cells[this.cellToHash(this._cel)]},getNeighbors:function(e,t,i){var r,c,d=this._directions.length;for(this._list.length=0,r=0;d>r;r++)this._cel.copy(e),this._cel.add(this._directions[r]),c=this.cells[this.cellToHash(this._cel)],!c||i&&!i(e,c)||this._list.push(c);if(t)for(r=0;d>r;r++)this._cel.copy(e),this._cel.add(this._diagonals[r]),c=this.cells[this.cellToHash(this._cel)],!c||i&&!i(e,c)||this._list.push(c);return this._list},getRandomCell:function(){var e,t=0,i=x.Tools.randomInt(0,this.numCells);for(e in this.cells){if(t===i)return this.cells[e];t++}return this.cells[e]},cellToHash:function(e){return e.q+this._hashDelimeter+e.r+this._hashDelimeter+e.s},distance:function(e,t){var i=Math.max(Math.abs(e.q-t.q),Math.abs(e.r-t.r),Math.abs(e.s-t.s));return i+=t.h-e.h},clearPath:function(){var e,t;for(e in this.cells)t=this.cells[e],t._calcCost=0,t._priority=0,t._parent=null,t._visited=!1},traverse:function(e){var t;for(t in this.cells)e(this.cells[t])},generateTile:function(e,t,i){var r=Math.abs(e.h);1>r&&(r=1);var c=this._geoCache[r];c||(this.extrudeSettings.amount=r,c=new THREE.ExtrudeGeometry(this.cellShape,this.extrudeSettings),this._geoCache[r]=c);var d=new x.Tile({size:this.cellSize,scale:t,cell:e,geometry:c,material:i});return e.tile=d,d},generateTiles:function(e){e=e||{};var t=[],i={tileScale:.95,cellSize:this.cellSize,material:null,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5}};i=x.Tools.merge(i,e),this.cellSize=i.cellSize,this._cellWidth=2*this.cellSize,this._cellLength=.5*x.SQRT3*this._cellWidth,this.autogenerated=!0,this.extrudeSettings=i.extrudeSettings;var r,c,d;for(r in this.cells)d=this.cells[r],c=this.generateTile(d,i.tileScale,i.material),c.position.copy(this.cellToPixel(d)),c.position.y=0,t.push(c);return t},generateTilePoly:function(e){e||(e=new THREE.MeshBasicMaterial({color:2405631}));var t=new THREE.Mesh(this.cellShapeGeo,e);return this._vec3.set(1,0,0),t.rotateOnAxis(this._vec3,x.PI/2),t},generate:function(e){e=e||{},this.size=typeof e.size=="undefined"?this.size:e.size;var t,i,r,c;for(t=-this.size;t<this.size+1;t++)for(i=-this.size;i<this.size+1;i++)r=-t-i,Math.abs(t)<=this.size&&Math.abs(i)<=this.size&&Math.abs(r)<=this.size&&(c=new x.Cell(t,i,r),this.add(c))},generateOverlay:function(e,t,i){var r,c,d,m=this.cellShape.createPointsGeometry();for(r=-e;e+1>r;r++)for(c=-e;e+1>c;c++)if(d=-r-c,Math.abs(r)<=e&&Math.abs(c)<=e&&Math.abs(d)<=e){this._cel.set(r,c,d);var T=new THREE.Line(m,i);T.position.copy(this.cellToPixel(this._cel)),T.rotation.x=90*x.DEG_TO_RAD,t.add(T)}},add:function(e){var t=this.cellToHash(e);if(!this.cells[t])return this.cells[t]=e,this.numCells++,e},remove:function(e){var t=this.cellToHash(e);this.cells[t]&&(delete this.cells[t],this.numCells--)},dispose:function(){this.cells=null,this.numCells=0,this.cellShape=null,this.cellGeo.dispose(),this.cellGeo=null,this.cellShapeGeo.dispose(),this.cellShapeGeo=null,this._list=null,this._vec3=null,this._conversionVec=null,this._geoCache=null,this._matCache=null},load:function(e,t,i){var r=this;x.Tools.getJSON({url:e,callback:function(c){r.fromJSON(c),t.call(i||null,c)},cache:!1,scope:r})},fromJSON:function(e){var t,i,r=e.cells;for(this.cells={},this.numCells=0,this.size=e.size,this.cellSize=e.cellSize,this._cellWidth=2*this.cellSize,this._cellLength=.5*x.SQRT3*this._cellWidth,this.extrudeSettings=e.extrudeSettings,this.autogenerated=e.autogenerated,t=0;t<r.length;t++)i=new x.Cell,i.copy(r[t]),this.add(i)},toJSON:function(){var e,t,i={size:this.size,cellSize:this.cellSize,extrudeSettings:this.extrudeSettings,autogenerated:this.autogenerated},r=[];for(t in this.cells)e=this.cells[t],r.push({q:e.q,r:e.r,s:e.s,h:e.h,walkable:e.walkable,userData:e.userData});return i.cells=r,i},_createVertex:function(e){var t=x.TAU/6*e;return new THREE.Vector3(this.cellSize*Math.cos(t),this.cellSize*Math.sin(t),0)},_cubeRound:function(e){var t=Math.round(e.q),i=Math.round(e.r),r=Math.round(e.s),c=Math.abs(t-e.q),d=Math.abs(i-e.r),m=Math.abs(r-e.s);return c>d&&c>m?t=-i-r:d>m?i=-t-r:r=-t-i,this._cel.set(t,i,r)}},x.HexGrid.prototype.constructor=x.HexGrid,x.SqrGrid=function(e){e=e||{},this.type=x.SQR,this.size=5,this.cellSize=typeof e.cellSize=="undefined"?10:e.cellSize,this.cells={},this.numCells=0,this.extrudeSettings=null,this.autogenerated=!1;var t=[];t.push(new THREE.Vector3),t.push(new THREE.Vector3(-this.cellSize,this.cellSize)),t.push(new THREE.Vector3(this.cellSize,this.cellSize)),t.push(new THREE.Vector3(this.cellSize,-this.cellSize)),this.cellShape=new THREE.Shape,this.cellShape.moveTo(-this.cellSize,-this.cellSize),this.cellShape.lineTo(-this.cellSize,this.cellSize),this.cellShape.lineTo(this.cellSize,this.cellSize),this.cellShape.lineTo(this.cellSize,-this.cellSize),this.cellShape.lineTo(-this.cellSize,-this.cellSize),this.cellGeo=new THREE.Geometry,this.cellGeo.vertices=t,this.cellGeo.verticesNeedUpdate=!0,this.cellShapeGeo=new THREE.ShapeGeometry(this.cellShape),this._fullCellSize=2*this.cellSize,this._hashDelimeter=".",this._directions=[new x.Cell(1,0,0),new x.Cell(0,-1,0),new x.Cell(-1,0,0),new x.Cell(0,1,0)],this._diagonals=[new x.Cell(-1,-1,0),new x.Cell(-1,1,0),new x.Cell(1,1,0),new x.Cell(1,-1,0)],this._list=[],this._vec3=new THREE.Vector3,this._cel=new x.Cell,this._conversionVec=new THREE.Vector3,this._geoCache=[],this._matCache=[]},x.SqrGrid.prototype={cellToPixel:function(e){return this._vec3.x=e.q*this._fullCellSize,this._vec3.y=e.h,this._vec3.z=e.r*this._fullCellSize,this._vec3},pixelToCell:function(e){var t=Math.round(e.x/this._fullCellSize),i=Math.round(e.z/this._fullCellSize);return this._cel.set(t,i,0)},getCellAt:function(e){var t=Math.round(e.x/this._fullCellSize),i=Math.round(e.z/this._fullCellSize);return this._cel.set(t,i),this.cells[this.cellToHash(this._cel)]},getNeighbors:function(e,t,i){var r,c,d=this._directions.length;for(this._list.length=0,r=0;d>r;r++)this._cel.copy(e),this._cel.add(this._directions[r]),c=this.cells[this.cellToHash(this._cel)],!c||i&&!i(e,c)||this._list.push(c);if(t)for(r=0;d>r;r++)this._cel.copy(e),this._cel.add(this._diagonals[r]),c=this.cells[this.cellToHash(this._cel)],!c||i&&!i(e,c)||this._list.push(c);return this._list},getRandomCell:function(){var e,t=0,i=x.Tools.randomInt(0,this.numCells);for(e in this.cells){if(t===i)return this.cells[e];t++}return this.cells[e]},cellToHash:function(e){return e.q+this._hashDelimeter+e.r},distance:function(e,t){var i=Math.max(Math.abs(e.q-t.q),Math.abs(e.r-t.r));return i+=t.h-e.h},clearPath:function(){var e,t;for(e in this.cells)t=this.cells[e],t._calcCost=0,t._priority=0,t._parent=null,t._visited=!1},traverse:function(e){var t;for(t in this.cells)e(this.cells[t])},generateTile:function(e,t,i){var r=Math.abs(e.h);1>r&&(r=1);var c=this._geoCache[r];c||(this.extrudeSettings.amount=r,c=new THREE.ExtrudeGeometry(this.cellShape,this.extrudeSettings),this._geoCache[r]=c);var d=new x.Tile({size:this.cellSize,scale:t,cell:e,geometry:c,material:i});return e.tile=d,d},generateTiles:function(e){e=e||{};var t=[],i={tileScale:.95,cellSize:this.cellSize,material:null,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5}};i=x.Tools.merge(i,e),this.cellSize=i.cellSize,this._fullCellSize=2*this.cellSize,this.autogenerated=!0,this.extrudeSettings=i.extrudeSettings;var r,c,d;for(r in this.cells)d=this.cells[r],c=this.generateTile(d,i.tileScale,i.material),c.position.copy(this.cellToPixel(d)),c.position.y=0,t.push(c);return t},generateTilePoly:function(e){e||(e=new THREE.MeshBasicMaterial({color:2405631}));var t=new THREE.Mesh(this.cellShapeGeo,e);return this._vec3.set(1,0,0),t.rotateOnAxis(this._vec3,x.PI/2),t},generate:function(e){e=e||{},this.size=typeof e.size=="undefined"?this.size:e.size;var t,i,r,c=Math.ceil(this.size/2);for(t=-c;c>t;t++)for(i=-c;c>i;i++)r=new x.Cell(t,i+1),this.add(r)},generateOverlay:function(e,t,i){var r,c,d=Math.ceil(e/2);for(r=-d;d>r;r++)for(c=-d;d>c;c++){this._cel.set(r,c);var m=new THREE.Line(this.cellGeo,i);m.position.copy(this.cellToPixel(this._cel)),m.rotation.x=90*x.DEG_TO_RAD,t.add(m)}},add:function(e){var t=this.cellToHash(e);if(!this.cells[t])return this.cells[t]=e,this.numCells++,e},remove:function(e){var t=this.cellToHash(e);this.cells[t]&&(delete this.cells[t],this.numCells--)},dispose:function(){this.cells=null,this.numCells=0,this.cellShape=null,this.cellGeo.dispose(),this.cellGeo=null,this.cellShapeGeo.dispose(),this.cellShapeGeo=null,this._list=null,this._vec3=null,this._conversionVec=null,this._geoCache=null,this._matCache=null},load:function(e,t,i){x.Tools.getJSON({url:e,callback:function(r){this.fromJSON(r),t.call(i||null,r)},cache:!1,scope:this})},fromJSON:function(e){var t,i,r=e.cells;for(this.cells={},this.numCells=0,this.size=e.size,this.cellSize=e.cellSize,this._fullCellSize=2*this.cellSize,this.extrudeSettings=e.extrudeSettings,this.autogenerated=e.autogenerated,t=0;t<r.length;t++)i=new x.Cell,i.copy(r[t]),this.add(i)},toJSON:function(){var e,t,i={size:this.size,cellSize:this.cellSize,extrudeSettings:this.extrudeSettings,autogenerated:this.autogenerated},r=[];for(t in this.cells)e=this.cells[t],r.push({q:e.q,r:e.r,s:e.s,h:e.h,walkable:e.walkable,userData:e.userData});return i.cells=r,i}},x.SqrGrid.prototype.constructor=x.SqrGrid,x.Tile=function(e){e=e||{};var t={cell:null,geometry:null,material:null};if(t=x.Tools.merge(t,e),!t.cell||!t.geometry)throw new Error("Missing vg.Tile configuration");this.cell=t.cell,this.cell.tile&&this.cell.tile!==this&&this.cell.tile.dispose(),this.cell.tile=this,this.uniqueID=x.Tools.generateID(),this.geometry=t.geometry,this.material=t.material,this.material||(this.material=new THREE.MeshPhongMaterial({color:x.Tools.randomizeRGB("30, 30, 30",13)})),this.objectType=x.TILE,this.entity=null,this.userData={},this.selected=!1,this.highlight="0x0084cc",this.mesh=new THREE.Mesh(this.geometry,this.material),this.mesh.userData.structure=this,this.position=this.mesh.position,this.rotation=this.mesh.rotation,this.rotation.x=-90*x.DEG_TO_RAD,this.mesh.scale.set(t.scale,t.scale,1),this.material.emissive?this._emissive=this.material.emissive.getHex():this._emissive=null},x.Tile.prototype={select:function(){return this.material.emissive&&this.material.emissive.setHex(this.highlight),this.selected=!0,this},deselect:function(){return this._emissive!==null&&this.material.emissive&&this.material.emissive.setHex(this._emissive),this.selected=!1,this},toggle:function(){return this.selected?this.deselect():this.select(),this},dispose:function(){this.cell&&this.cell.tile&&(this.cell.tile=null),this.cell=null,this.position=null,this.rotation=null,this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.mesh.userData.structure=null,this.mesh=null,this.material=null,this.userData=null,this.entity=null,this.geometry=null,this._emissive=null}},x.Tile.prototype.constructor=x.Tile,function(){var e=function(){this.obj=null,this.next=null,this.prev=null,this.free=!0},t=function(){this.first=null,this.last=null,this.length=0,this.objToNodeMap={},this.uniqueID=Date.now()+""+Math.floor(1e3*Math.random()),this.sortArray=[]};t.generateID=function(){return Math.random().toString(36).slice(2)+Date.now()},t.prototype={getNode:function(i){return this.objToNodeMap[i.uniqueID]},addNode:function(i){var r=new e;if(!i.uniqueID)try{i.uniqueID=t.generateID()}catch{return console.error("[LinkedList.addNode] obj passed is immutable: cannot attach necessary identifier"),null}return r.obj=i,r.free=!1,this.objToNodeMap[i.uniqueID]=r,r},swapObjects:function(i,r){this.objToNodeMap[i.obj.uniqueID]=null,this.objToNodeMap[r.uniqueID]=i,i.obj=r},add:function(i){var r=this.objToNodeMap[i.uniqueID];if(r){if(r.free===!1)return;r.obj=i,r.free=!1,r.next=null,r.prev=null}else r=this.addNode(i);if(this.first){if(!this.last)throw new Error("[LinkedList.add] No last in the list -- that shouldn't happen here");this.last.next=r,r.prev=this.last,this.last=r,r.next=null}else this.first=r,this.last=r,r.next=null,r.prev=null;this.length++,this.showDebug&&this.dump("after add")},has:function(i){return!!this.objToNodeMap[i.uniqueID]},moveUp:function(i){this.dump("before move up");var r=this.getNode(i);if(!r)throw"Oops, trying to move an object that isn't in the list";if(r.prev){var c=r.prev,d=c.prev;r==this.last&&(this.last=c);var m=r.next;d&&(d.next=r),r.next=c,r.prev=c.prev,c.next=m,c.prev=r,this.first==c&&(this.first=r)}},moveDown:function(i){var r=this.getNode(i);if(!r)throw"Oops, trying to move an object that isn't in the list";if(r.next){var c=r.next;this.moveUp(c.obj),this.last==c&&(this.last=r)}},sort:function(i){var r,c,d=this.sortArray,m=this.first;for(d.length=0;m;)d.push(m.obj),m=m.next;for(this.clear(),d.sort(i),c=d.length,r=0;c>r;r++)this.add(d[r])},remove:function(i){var r=this.getNode(i);return!r||r.free?!1:(r.prev&&(r.prev.next=r.next),r.next&&(r.next.prev=r.prev),r.prev||(this.first=r.next),r.next||(this.last=r.prev),r.free=!0,r.prev=null,r.next=null,this.length--,!0)},shift:function(){var i=this.first;return this.length===0?null:(i.prev&&(i.prev.next=i.next),i.next&&(i.next.prev=i.prev),this.first=i.next,i.next||(this.last=null),i.free=!0,i.prev=null,i.next=null,this.length--,i.obj)},pop:function(){var i=this.last;return this.length===0?null:(i.prev&&(i.prev.next=i.next),i.next&&(i.next.prev=i.prev),this.last=i.prev,i.prev||(this.first=null),i.free=!0,i.prev=null,i.next=null,this.length--,i.obj)},concat:function(i){for(var r=i.first;r;)this.add(r.obj),r=r.next},clear:function(){for(var i=this.first;i;)i.free=!0,i=i.next;this.first=null,this.length=0},dispose:function(){for(var i=this.first;i;)i.obj=null,i=i.next;this.first=null,this.objToNodeMap=null},dump:function(i){console.log("===================="+i+"=====================");for(var r=this.first;r;)console.log("{"+r.obj.toString()+"} previous="+(r.prev?r.prev.obj:"NULL")),r=r.next();console.log("==================================="),console.log("Last: {"+(this.last?this.last.obj:"NULL")+"} First: {"+(this.first?this.first.obj:"NULL")+"}")}},t.prototype.constructor=t,x.LinkedList=t}(),function(){var e=function(i,r,c,d,m){this._listener=r,this.isOnce=c,this.context=d,this.signal=i,this._priority=m||0};e.prototype={active:!0,params:null,execute:function(i){var r,c;return this.active&&this._listener&&(c=this.params?this.params.concat(i):i,r=this._listener.apply(this.context,c),this.isOnce&&this.detach()),r},detach:function(){return this.isBound()?this.signal.remove(this._listener,this.context):null},isBound:function(){return!!this.signal&&!!this._listener},_destroy:function(){delete this.signal,delete this._listener,delete this.context},toString:function(){return"[SignalBinding isOnce:"+this.isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}},e.prototype.constructor=e;var t=function(){this._bindings=[],this._prevParams=null;var i=this;this.dispatch=function(){t.prototype.dispatch.apply(i,arguments)}};t.prototype={memorize:!1,_shouldPropagate:!0,active:!0,validateListener:function(i,r){if(typeof i!="function")throw new Error("Signal: listener is a required param of {fn}() and should be a Function.".replace("{fn}",r))},_registerListener:function(i,r,c,d){var m,T=this._indexOfListener(i,c);if(T!==-1){if(m=this._bindings[T],m.isOnce!==r)throw new Error("You cannot add"+(r?"":"Once")+"() then add"+(r?"Once":"")+"() the same listener without removing the relationship first.")}else m=new e(this,i,r,c,d),this._addBinding(m);return this.memorize&&this._prevParams&&m.execute(this._prevParams),m},_addBinding:function(i){var r=this._bindings.length;do r--;while(this._bindings[r]&&i._priority<=this._bindings[r]._priority);this._bindings.splice(r+1,0,i)},_indexOfListener:function(i,r){for(var c,d=this._bindings.length;d--;)if(c=this._bindings[d],c._listener===i&&c.context===r)return d;return-1},has:function(i,r){return this._indexOfListener(i,r)!==-1},add:function(i,r,c){return this.validateListener(i,"add"),this._registerListener(i,!1,r,c)},addOnce:function(i,r,c){return this.validateListener(i,"addOnce"),this._registerListener(i,!0,r,c)},remove:function(i,r){this.validateListener(i,"remove");var c=this._indexOfListener(i,r);return c!==-1&&(this._bindings[c]._destroy(),this._bindings.splice(c,1)),i},removeAll:function(i){typeof i=="undefined"&&(i=null);for(var r=this._bindings.length;r--;)i?this._bindings[r].context===i&&(this._bindings[r]._destroy(),this._bindings.splice(r,1)):this._bindings[r]._destroy();i||(this._bindings.length=0)},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(){if(this.active){var i,r=Array.prototype.slice.call(arguments),c=this._bindings.length;if(this.memorize&&(this._prevParams=r),c){i=this._bindings.slice(),this._shouldPropagate=!0;do c--;while(i[c]&&this._shouldPropagate&&i[c].execute(r)!==!1)}}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}},t.prototype.constructor=t,x.Signal=t}(),x.AStarFinder=function(e){e=e||{};var t={allowDiagonal:!1,heuristicFilter:null};t=x.Tools.merge(t,e),this.allowDiagonal=t.allowDiagonal,this.heuristicFilter=t.heuristicFilter,this.list=new x.LinkedList},x.AStarFinder.prototype={findPath:function(e,t,i,r){var c,d,m,T,b,M;for(i=i||this.heuristicFilter,r.clearPath(),this.list.clear(),this.list.add(e);this.list.length>0;){if(this.list.sort(this.compare),c=this.list.shift(),c._visited=!0,c===t)return x.PathUtil.backtrace(t);for(m=r.getNeighbors(c,this.allowDiagonal,i),b=0,M=m.length;M>b;b++)if(T=m[b],T.walkable&&(d=c._calcCost+r.distance(c,T),!T._visited||d<T._calcCost)){if(T._visited=!0,T._parent=c,T._calcCost=d,T._priority=d+r.distance(t,T),T===t)return x.PathUtil.backtrace(t);this.list.add(T)}}return null},compare:function(e,t){return e._priority-t._priority}},x.AStarFinder.prototype.constructor=x.AStarFinder,x.PathUtil={backtrace:function(e){for(var t=[e];e._parent;)e=e._parent,t.push(e);return t.reverse()},biBacktrace:function(e,t){var i=this.backtrace(e),r=this.backtrace(t);return i.concat(r.reverse())},pathLength:function(e){var t,i,r,c,d,m=0;for(t=1;t<e.length;++t)i=e[t-1],r=e[t],c=i[0]-r[0],d=i[1]-r[1],m+=Math.sqrt(c*c+d*d);return m},interpolate:function(e,t,i,r){var c,d,m,T,b,M,A=Math.abs,N=[];for(m=A(i-e),T=A(r-t),c=i>e?1:-1,d=r>t?1:-1,b=m-T;e!==i||t!==r;)N.push([e,t]),M=2*b,M>-T&&(b-=T,e+=c),m>M&&(b+=m,t+=d);return N},expandPath:function(e){var t,i,r,c,d,m,T=[],b=e.length;if(2>b)return T;for(d=0;b-1>d;++d)for(t=e[d],i=e[d+1],r=this.interpolate(t[0],t[1],i[0],i[1]),c=r.length,m=0;c-1>m;++m)T.push(r[m]);return T.push(e[b-1]),T},smoothenPath:function(e,t){var i,r,c,d,m,T,b,M,A,N,L,S,D=t.length,ee=t[0][0],ae=t[0][1],ie=t[D-1][0],fe=t[D-1][1];for(i=ee,r=ae,m=[[i,r]],b=2;D>b;++b){for(A=t[b],c=A[0],d=A[1],N=this.interpolate(i,r,c,d),S=!1,M=1;M<N.length;++M)if(L=N[M],!e.isWalkableAt(L[0],L[1])){S=!0;break}S&&(T=t[b-1],m.push(T),i=T[0],r=T[1])}return m.push([ie,fe]),m},compressPath:function(e){if(e.length<3)return e;var t,i,r,c,d,m,T=[],b=e[0][0],M=e[0][1],A=e[1][0],N=e[1][1],L=A-b,S=N-M;for(d=Math.sqrt(L*L+S*S),L/=d,S/=d,T.push([b,M]),m=2;m<e.length;m++)t=A,i=N,r=L,c=S,A=e[m][0],N=e[m][1],L=A-t,S=N-i,d=Math.sqrt(L*L+S*S),L/=d,S/=d,(L!==r||S!==c)&&T.push([t,i]);return T.push([A,N]),T}},x.Loader={manager:null,imageLoader:null,crossOrigin:!1,init:function(e){this.crossOrigin=e||!1,this.manager=new THREE.LoadingManager(function(){},function(){},function(){console.warn("Error loading images")}),this.imageLoader=new THREE.ImageLoader(this.manager),this.imageLoader.crossOrigin=e},loadTexture:function(e,t,i,r){var c=new THREE.Texture(null,t);return this.imageLoader.load(e,function(d){c.image=d,c.needsUpdate=!0,i&&i(c)},null,function(d){r&&r(d)}),c.sourceFile=e,c}},x.MouseCaster=function(e,t,i){this.down=!1,this.rightDown=!1,this.pickedObject=null,this.selectedObject=null,this.allHits=null,this.active=!0,this.shift=!1,this.ctrl=!1,this.wheel=0,this.position=new THREE.Vector3,this.screenPosition=new THREE.Vector2,this.signal=new x.Signal,this.group=e,this._camera=t,this._raycaster=new THREE.Raycaster,this._preventDefault=!1,i=i||document,i.addEventListener("mousemove",this._onDocumentMouseMove.bind(this),!1),i.addEventListener("mousedown",this._onDocumentMouseDown.bind(this),!1),i.addEventListener("mouseup",this._onDocumentMouseUp.bind(this),!1),i.addEventListener("mousewheel",this._onMouseWheel.bind(this),!1),i.addEventListener("DOMMouseScroll",this._onMouseWheel.bind(this),!1)},x.MouseCaster.OVER="over",x.MouseCaster.OUT="out",x.MouseCaster.DOWN="down",x.MouseCaster.UP="up",x.MouseCaster.CLICK="click",x.MouseCaster.WHEEL="wheel",x.MouseCaster.prototype={update:function(){if(this.active){this._raycaster.setFromCamera(this.screenPosition,this._camera);var e,t,i=this._raycaster.intersectObject(this.group,!0);i.length>0?(e=i[0],t=e.object.userData.structure,this.pickedObject!=t&&(this.pickedObject&&this.signal.dispatch(x.MouseCaster.OUT,this.pickedObject),this.pickedObject=t,this.selectedObject=null,this.signal.dispatch(x.MouseCaster.OVER,this.pickedObject)),this.position.copy(e.point),this.screenPosition.z=e.distance):(this.pickedObject&&this.signal.dispatch(x.MouseCaster.OUT,this.pickedObject),this.pickedObject=null,this.selectedObject=null),this.allHits=i}},preventDefault:function(){this._preventDefault=!0},_onDocumentMouseDown:function(e){return e=e||window.event,e.preventDefault(),this._preventDefault?(this._preventDefault=!1,!1):(this.pickedObject&&(this.selectedObject=this.pickedObject),this.shift=e.shiftKey,this.ctrl=e.ctrlKey,this.down=e.which===1,this.rightDown=e.which===3,void this.signal.dispatch(x.MouseCaster.DOWN,this.pickedObject))},_onDocumentMouseUp:function(e){return e.preventDefault(),this._preventDefault?(this._preventDefault=!1,!1):(this.shift=e.shiftKey,this.ctrl=e.ctrlKey,this.signal.dispatch(x.MouseCaster.UP,this.pickedObject),this.selectedObject&&this.pickedObject&&this.selectedObject.uniqueID===this.pickedObject.uniqueID&&this.signal.dispatch(x.MouseCaster.CLICK,this.pickedObject),this.down=e.which===1?!1:this.down,void(this.rightDown=e.which===3?!1:this.rightDown))},_onDocumentMouseMove:function(e){e.preventDefault(),this.screenPosition.x=e.clientX/window.innerWidth*2-1,this.screenPosition.y=2*-(e.clientY/window.innerHeight)+1},_onMouseWheel:function(e){if(this.active){e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta!==void 0?t=e.wheelDelta:e.detail!==void 0&&(t=-e.detail),t>0?this.wheel++:this.wheel--,this.signal.dispatch(x.MouseCaster.WHEEL,this.wheel)}}},x.MouseCaster.prototype.constructor=x.MouseCaster,x.Scene=function(e,t){var i={element:document.body,alpha:!0,antialias:!0,clearColor:"#fff",sortObjects:!1,fog:null,light:new THREE.DirectionalLight(16777215),lightPosition:null,cameraType:"PerspectiveCamera",cameraPosition:null,orthoZoom:4},r={minDistance:100,maxDistance:1e3,zoomSpeed:2,noZoom:!1};if(i=x.Tools.merge(i,e),typeof t!="boolean"&&(r=x.Tools.merge(r,t)),this.renderer=new THREE.WebGLRenderer({alpha:i.alpha,antialias:i.antialias}),this.renderer.setClearColor(i.clearColor,0),this.renderer.sortObjects=i.sortObjects,this.width=window.innerWidth,this.height=window.innerHeight,this.orthoZoom=i.orthoZoom,this.container=new THREE.Scene,this.container.fog=i.fog,this.container.add(new THREE.AmbientLight(14540253)),i.lightPosition||i.light.position.set(-1,1,-1).normalize(),this.container.add(i.light),i.cameraType==="OrthographicCamera"){var c=window.innerWidth/this.orthoZoom,d=window.innerHeight/this.orthoZoom;this.camera=new THREE.OrthographicCamera(c/-2,c/2,d/2,d/-2,1,5e3)}else this.camera=new THREE.PerspectiveCamera(50,this.width/this.height,1,5e3);this.contolled=!!t,this.contolled&&(this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.minDistance=r.minDistance,this.controls.maxDistance=r.maxDistance,this.controls.zoomSpeed=r.zoomSpeed,this.controls.noZoom=r.noZoom),i.cameraPosition&&this.camera.position.copy(i.cameraPosition),window.addEventListener("resize",function(){if(this.width=window.innerWidth,this.height=window.innerHeight,this.camera.type==="OrthographicCamera"){var m=this.width/this.orthoZoom,T=this.height/this.orthoZoom;this.camera.left=m/-2,this.camera.right=m/2,this.camera.top=T/2,this.camera.bottom=T/-2}else this.camera.aspect=this.width/this.height;this.camera.updateProjectionMatrix(),this.renderer.setSize(this.width,this.height)}.bind(this),!1),this.attachTo(i.element)},x.Scene.prototype={attachTo:function(e){e.style.width=this.width+"px",e.style.height=this.height+"px",this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(this.width,this.height),e.appendChild(this.renderer.domElement)},add:function(e){this.container.add(e)},remove:function(e){this.container.remove(e)},render:function(){this.contolled&&this.controls.update(),this.renderer.render(this.container,this.camera)},updateOrthoZoom:function(){if(this.orthoZoom<=0)return void(this.orthoZoom=0);var e=this.width/this.orthoZoom,t=this.height/this.orthoZoom;this.camera.left=e/-2,this.camera.right=e/2,this.camera.top=t/2,this.camera.bottom=t/-2,this.camera.updateProjectionMatrix()},focusOn:function(e){this.camera.lookAt(e.position)}},x.Scene.prototype.constructor=x.Scene,x.SelectionManager=function(e){this.mouse=e,this.onSelect=new x.Signal,this.onDeselect=new x.Signal,this.selected=null,this.toggleSelection=!1,this.mouse.signal.add(this.onMouse,this)},x.SelectionManager.prototype={select:function(e,t){e&&(t=t||!0,this.selected!==e&&this.clearSelection(t),e.selected?this.toggleSelection&&(t&&this.onDeselect.dispatch(e),e.deselect()):e.select(),this.selected=e,t&&this.onSelect.dispatch(e))},clearSelection:function(e){e=e||!0,this.selected&&(e&&this.onDeselect.dispatch(this.selected),this.selected.deselect()),this.selected=null},onMouse:function(e,t){switch(e){case x.MouseCaster.DOWN:t||this.clearSelection();break;case x.MouseCaster.CLICK:this.select(t)}}},x.SelectionManager.prototype.constructor=x.SelectionManager,x.Tools={clamp:function(e,t,i){return Math.max(t,Math.min(i,e))},sign:function(e){return e&&e/Math.abs(e)},random:function(e,t){return arguments.length===1?Math.random()*e-.5*e:Math.random()*(t-e)+e},randomInt:function(e,t){return arguments.length===1?Math.random()*e-.5*e|0:Math.random()*(t-e+1)+e|0},normalize:function(e,t,i){return(e-t)/(i-t)},getShortRotation:function(e){return e%=this.TAU,e>this.PI?e-=this.TAU:e<-this.PI&&(e+=this.TAU),e},generateID:function(){return Math.random().toString(36).slice(2)+Date.now()},isPlainObject:function(e){if(typeof e!="object"||e.nodeType||e===e.window)return!1;try{if(e.constructor&&!Object.prototype.hasOwnProperty.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch{return!1}return!0},merge:function(e,t){var i=this,r=Array.isArray(t),c=r&&[]||{};return r?(e=e||[],c=c.concat(e),t.forEach(function(d,m){typeof c[m]=="undefined"?c[m]=d:i.isPlainObject(d)?c[m]=i.merge(e[m],d):e.indexOf(d)===-1&&c.push(d)}),c):(e&&i.isPlainObject(e)&&Object.keys(e).forEach(function(d){c[d]=e[d]}),Object.keys(t).forEach(function(d){t[d]&&i.isPlainObject(t[d])&&e[d]?c[d]=i.merge(e[d],t[d]):c[d]=t[d]}),c)},now:function(){return window.nwf?window.nwf.system.Performance.elapsedTime:window.performance.now()},empty:function(e){for(;e.lastChild;)e.removeChild(e.lastChild)},radixSort:function(e,t,i,r){if(t=t||0,i=i||e.length,r=r||31,!(t>=i-1||0>r)){for(var c=t,d=i,m=1<<r;d>c;)if(e[c]&m){--d;var T=e[c];e[c]=e[d],e[d]=T}else++c;this.radixSort(e,t,d,r-1),this.radixSort(e,d,i,r-1)}},randomizeRGB:function(e,t){var i,r,c=e.split(","),d="rgb(";for(t=this.randomInt(t),i=0;3>i;i++)r=parseInt(c[i])+t,0>r?r=0:r>255&&(r=255),d+=r+",";return d=d.substring(0,d.length-1),d+=")"},getJSON:function(e){var t=new XMLHttpRequest,i=typeof e.cache=="undefined"?!1:e.cache,r=i?e.url:e.url+"?t="+Math.floor(1e4*Math.random())+Date.now();t.onreadystatechange=function(){if(this.status===200){var c=null;try{c=JSON.parse(this.responseText)}catch{return}return void e.callback.call(e.scope||null,c)}this.status!==0&&console.warn("[Tools.getJSON] Error: "+this.status+" ("+this.statusText+") :: "+e.url)},t.open("GET",r,!0),t.setRequestHeader("Accept","application/json"),t.setRequestHeader("Content-Type","application/json"),t.send("")}};var mn={size:5,cellSize:10,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5},autogenerated:!0,cells:[{q:-1,r:0,s:1,h:1,walkable:!0,userData:{}},{q:0,r:-1,s:1,h:1,walkable:!0,userData:{}},{q:0,r:0,s:0,h:1,walkable:!0,userData:{}},{q:1,r:-1,s:0,h:1,walkable:!0,userData:{}},{q:-1,r:1,s:0,h:0,walkable:!0,userData:{}},{q:0,r:1,s:-1,h:0,walkable:!0,userData:{}},{q:1,r:0,s:-1,h:0,walkable:!0,userData:{}}]};const _t=Dt.exports,gn=mn;AFRAME.registerPrimitive("a-hexgrid",{defaultComponents:{hexgrid:{}},mappings:{src:"hexgrid.src"}});AFRAME.registerComponent("hexgrid",{dependencies:["material"],schema:{src:{type:"asset"}},init:function(){const e=this.data;e.src?fetch(e.src).then(t=>t.json()).then(t=>this.addMesh(t)):this.addMesh(gn)},addMesh:function(e){const t=new _t.HexGrid;t.fromJSON(e);const i=new _t.Board(t);i.generateTilemap(),this.el.setObject3D("mesh",i.group),this.addMaterial()},addMaterial:function(){const t=(this.el.components.material||{}).material;!t||this.el.object3D.traverse(i=>{i.isMesh&&(i.material=t)})},remove:function(){this.el.removeObject3D("mesh")}});AFRAME.registerPrimitive("a-ocean",{defaultComponents:{ocean:{},rotation:{x:-90,y:0,z:0}},mappings:{width:"ocean.width",depth:"ocean.depth",density:"ocean.density",amplitude:"ocean.amplitude",amplitudeVariance:"ocean.amplitudeVariance",speed:"ocean.speed",speedVariance:"ocean.speedVariance",color:"ocean.color",opacity:"ocean.opacity"}});AFRAME.registerComponent("ocean",{schema:{width:{default:10,min:0},depth:{default:10,min:0},density:{default:10},amplitude:{default:.1},amplitudeVariance:{default:.3},speed:{default:1},speedVariance:{default:2},color:{default:"#7AD2F7",type:"color"},opacity:{default:.8}},play:function(){const e=this.el,t=this.data;let i=e.components.material;const r=new THREE.PlaneGeometry(t.width,t.depth,t.density,t.density);r.mergeVertices(),this.waves=[];for(let c,d=0,m=r.vertices.length;d<m;d++)c=r.vertices[d],this.waves.push({z:c.z,ang:Math.random()*Math.PI*2,amp:t.amplitude+Math.random()*t.amplitudeVariance,speed:(t.speed+Math.random()*t.speedVariance)/1e3});i||(i={},i.material=new THREE.MeshPhongMaterial({color:t.color,transparent:t.opacity<1,opacity:t.opacity,shading:THREE.FlatShading})),this.mesh=new THREE.Mesh(r,i.material),e.setObject3D("mesh",this.mesh)},remove:function(){this.el.removeObject3D("mesh")},tick:function(e,t){if(!t)return;const i=this.mesh.geometry.vertices;for(let r,c,d=0;r=i[d];d++)c=this.waves[d],r.z=c.z+Math.sin(c.ang)*c.amp,c.ang+=c.speed*t;this.mesh.geometry.verticesNeedUpdate=!0}});AFRAME.registerPrimitive("a-tube",{defaultComponents:{tube:{}},mappings:{path:"tube.path",segments:"tube.segments",radius:"tube.radius","radial-segments":"tube.radialSegments",closed:"tube.closed"}});AFRAME.registerComponent("tube",{schema:{path:{default:[]},segments:{default:64},radius:{default:1},radialSegments:{default:8},closed:{default:!1}},init:function(){const e=this.el,t=this.data;let i=e.components.material;if(!t.path.length){console.error("[a-tube] `path` property expected but not found.");return}const r=new THREE.CatmullRomCurve3(t.path.map(function(d){return d=d.split(" "),new THREE.Vector3(Number(d[0]),Number(d[1]),Number(d[2]))})),c=new THREE.TubeGeometry(r,t.segments,t.radius,t.radialSegments,t.closed);i||(i={},i.material=new THREE.MeshPhongMaterial),this.mesh=new THREE.Mesh(c,i.material),this.el.setObject3D("mesh",this.mesh)},update:function(e){!Object.keys(e).length||(this.remove(),this.init())},remove:function(){this.mesh&&this.el.removeObject3D("mesh")}});function yn(e){let t,i;return t=new zi({}),{c(){Hi(t.$$.fragment)},l(r){_i(t.$$.fragment,r)},m(r,c){Oi(t,r,c),i=!0},p:Di,i(r){i||(Pi(t.$$.fragment,r),i=!0)},o(r){Fi(t.$$.fragment,r),i=!1},d(r){Ni(t,r)}}}function ut(e){return e*Math.PI/180}function En(e,t,i){let r;Ii(e,Vi,b=>i(0,r=b));let c=[.05,.025,.05];const d=new de.exports.THREE.Vector3(0,0,1);AFRAME.registerComponent("curve-point",{schema:{},init(){this.el.addEventListener("componentchanged",this.changeHandler.bind(this)),this.el.emit("curve-point-change")},changeHandler(b){b.detail.name=="position"&&this.el.emit("curve-point-change")}}),AFRAME.registerComponent("curve",{schema:{type:{type:"string",default:"CatmullRom",oneOf:["CatmullRom","CubicBezier","QuadraticBezier","Line"]},closed:{type:"boolean",default:!1}},init(){this.pathPoints=null,this.curve=null,this.el.addEventListener("curve-point-change",this.update.bind(this))},update(b){if(this.points=Array.from(this.el.querySelectorAll("a-curve-point, [curve-point]")),this.points.length<=1)console.warn("At least 2 curve-points needed to draw a curve"),this.curve=null;else{let M=this.points.map(function(A){return A.x!==void 0&&A.y!==void 0&&A.z!==void 0?A:A.object3D.getWorldPosition(new de.exports.THREE.Vector3)});if(!AFRAME.utils.deepEqual(M,this.pathPoints)||b!=="CustomEvent"&&!AFRAME.utils.deepEqual(this.data,b)){switch(this.curve=null,this.pathPoints=M,this.data.type){case"CubicBezier":if(this.pathPoints.length!=4)throw new Error("The Three constructor of type CubicBezierCurve3 requires 4 points");this.curve=new de.exports.THREE.CubicBezierCurve3(this.pathPoints[0],this.pathPoints[1],this.pathPoints[2],this.pathPoints[3]);break;case"QuadraticBezier":if(this.pathPoints.length!=3)throw new Error("The Three constructor of type QuadraticBezierCurve3 requires 3 points");this.curve=new de.exports.THREE.QuadraticBezierCurve3(this.pathPoints[0],this.pathPoints[1],this.pathPoints[2]);break;case"Line":if(this.pathPoints.length!=2)throw new Error("The Three constructor of type LineCurve3 requires 2 points");this.curve=new de.exports.THREE.LineCurve3(this.pathPoints[0],this.pathPoints[1]);break;case"CatmullRom":this.curve=new de.exports.THREE.CatmullRomCurve3(this.pathPoints);break;case"Spline":this.curve=new de.exports.THREE.SplineCurve3(this.pathPoints);break;default:throw new Error("No Three constructor of type (case sensitive): "+this.data.type+"Curve3")}this.curve.closed=this.data.closed,this.el.emit("curve-updated")}}},remove(){this.el.removeEventListener("curve-point-change",this.update.bind(this))},closestPointInLocalSpace:function(M,A,N,L){if(!this.curve)throw Error("Curve not instantiated yet.");A=A||.1/this.curve.getLength(),L=L||.5,N=N||.5,L/=2;let S=N+L,D=N-L,ee=this.curve.getPointAt(S),ae=this.curve.getPointAt(D),ie=ee.distanceTo(M),fe=ae.distanceTo(M),he=ie<fe;if(L<A){let Ee=this.curve.getTangentAt(he?S:D);if(L<A)return{result:he?S:D,location:he?ee:ae,distance:he?ie:fe,normal:T(Ee),tangent:Ee}}return ie<fe?this.closestPointInLocalSpace(M,A,S,L):this.closestPointInLocalSpace(M,A,D,L)}});const m=new de.exports.THREE.Quaternion;function T(b){let M=new de.exports.THREE.Vector3(0,1,0);return m.setFromUnitVectors(d,b),M.applyQuaternion(m),M}return AFRAME.registerShader("line",{schema:{color:{default:"#ff0000"}},init(b){this.material=new de.exports.THREE.LineBasicMaterial(b)},update(b){this.material=new de.exports.THREE.LineBasicMaterial(b)}}),AFRAME.registerComponent("draw-curve",{schema:{curve:{type:"selector"}},init(){this.data.curve.addEventListener("curve-updated",this.update.bind(this))},update(){if(this.data.curve&&(this.curve=this.data.curve.components.curve),this.curve&&this.curve.curve){let b=new de.exports.THREE.BufferGeometry().setFromPoints(this.curve.curve.getPoints(this.curve.curve.getPoints().length*10)),M=this.el.getOrCreateObject3D("mesh",de.exports.THREE.Line);lineMaterial=M.material?M.material:new de.exports.THREE.LineBasicMaterial({color:"#ff0000"}),this.el.setObject3D("mesh",new de.exports.THREE.Line(b,lineMaterial))}},remove(){this.data.curve.removeEventListener("curve-updated",this.update.bind(this)),this.el.getObject3D("mesh").geometry=new de.exports.THREE.Geometry}}),AFRAME.registerComponent("clone-along-curve",{schema:{curve:{type:"selector"},spacing:{default:1},rotation:{type:"vec3",default:AFRAME.utils.coordinates.parse("0 0 0")},scale:{type:"vec3",default:AFRAME.utils.coordinates.parse("1 1 1")}},init(){this.el.addEventListener("model-loaded",this.update.bind(this)),this.data.curve.addEventListener("curve-updated",this.update.bind(this))},update(){if(this.remove(),this.data.curve&&(this.curve=this.data.curve.components.curve),!this.el.getObject3D("clones")&&this.curve&&this.curve.curve){let b=this.el.getObject3D("mesh"),M=this.curve.curve.getLength(),N=0,L=this.el.getOrCreateObject3D("clones",de.exports.THREE.Group),S=new de.exports.THREE.Object3D;for(b.scale.set(this.data.scale.x,this.data.scale.y,this.data.scale.z),b.rotation.set(ut(this.data.rotation.x),ut(this.data.rotation.y),ut(this.data.rotation.z)),b.rotation.order="YXZ",S.add(b);N<=M;){let D=S.clone(!0);D.position.copy(this.curve.curve.getPointAt(N/M));const ee=this.curve.curve.getTangentAt(N/M).normalize();D.quaternion.setFromUnitVectors(d,ee),L.add(D),N+=this.data.spacing}}},remove(){this.curve=null,this.el.getObject3D("clones")&&this.el.removeObject3D("clones")}}),AFRAME.primitives.primitives["a-draw-curve"]||AFRAME.registerPrimitive("a-draw-curve",{defaultComponents:{"draw-curve":{}},mappings:{curveref:"draw-curve.curve"}}),AFRAME.primitives.primitives["a-curve-point"]||AFRAME.registerPrimitive("a-curve-point",{defaultComponents:{"curve-point":{}},mappings:{}}),AFRAME.primitives.primitives["a-curve"]||AFRAME.registerPrimitive("a-curve",{defaultComponents:{curve:{}},mappings:{type:"curve.type"}}),AFRAME.registerComponent("lava-path",{init(){var b;if(console.log("lava path:"),console.log(r.lava_paths),!!((b=r.lava_paths)!=null&&b.length))for(let M=0;M<r.lava_paths.length;M++){const A=r.lava_paths[M],N=document.createElement("a-curve");N.setAttribute("id","track"+M);for(let D=0;D<A.length;D++){const ee=A[D],ae=ee[0],ie=ee[2],fe=ee[1],he=document.createElement("a-curve-point");he.setAttribute("position",{x:ae/c[0],y:ie/c[1],z:fe/c[2]}),N.appendChild(he)}this.el.appendChild(N);const L=document.createElement("a-entity");L.setAttribute("clone-along-curve","curve: #track"+M+"; spacing: 0.035; rotation: 90 0 0;"),L.setAttribute("geometry","primitive:cylinder; height:0.04; radius:0.4 ;"),L.setAttribute("material","color: orangered; transparency: true; opacity: 0.001");const S=r.lava_paths.length*2e3;L.setAttribute("animation","property: material.opacity; to: 1; dur: 2000; loop: false; delay: "+(S-M*2e3)+";"),this.el.appendChild(L)}}}),Bi(()=>{delete AFRAME.components["curve-point"],delete AFRAME.components.curve,delete AFRAME.components["draw-curve"],delete AFRAME.components["lava-path"],delete AFRAME.components["clone-along-curve"],delete AFRAME.shaders.line}),[]}class Ln extends Mi{constructor(t){super(),Si(this,t,En,yn,Li,{})}}export{Ln as default};
