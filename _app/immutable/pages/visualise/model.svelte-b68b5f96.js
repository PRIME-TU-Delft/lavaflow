import{S as Ri,i as Ci,s as Mi,w as Si,x as Li,y as _i,E as Hi,q as Oi,o as Di,B as Ni}from"../../chunks/index-b2cf3344.js";import{S as Fi}from"../../chunks/aframe-master-a7eaaf7b.js";import{g as Pi}from"../../chunks/_commonjsHelpers-56d41998.js";import"../../chunks/contourLineStore-66468231.js";import"../../chunks/index-082afcc0.js";import"../../chunks/NavigationButton-f564c9bc.js";import"../../chunks/Button-2751e271.js";import"../../chunks/navigation-0e6511d1.js";import"../../chunks/singletons-d1fb5791.js";import"../../chunks/debugStore-aae9bc5b.js";const Ct=.1;AFRAME.registerComponent("checkpoint-controls",{schema:{enabled:{default:!0},mode:{default:"teleport",oneOf:["teleport","animate"]},animateSpeed:{default:3}},init:function(){this.active=!0,this.checkpoint=null,this.isNavMeshConstrained=!1,this.offset=new THREE.Vector3,this.position=new THREE.Vector3,this.targetPosition=new THREE.Vector3},play:function(){this.active=!0},pause:function(){this.active=!1},setCheckpoint:function(e){const t=this.el;if(!!this.active&&this.checkpoint!==e){if(this.checkpoint&&t.emit("navigation-end",{checkpoint:this.checkpoint}),this.checkpoint=e,this.sync(),this.position.distanceTo(this.targetPosition)<Ct){this.checkpoint=null;return}t.emit("navigation-start",{checkpoint:e}),this.data.mode==="teleport"&&(this.el.setAttribute("position",this.targetPosition),this.checkpoint=null,t.emit("navigation-end",{checkpoint:e}),t.components["movement-controls"].updateNavLocation())}},isVelocityActive:function(){return!!(this.active&&this.checkpoint)},getVelocity:function(){if(!this.active)return;const e=this.data,t=this.offset,i=this.position,r=this.targetPosition,c=this.checkpoint;return this.sync(),i.distanceTo(r)<Ct?(this.checkpoint=null,this.el.emit("navigation-end",{checkpoint:c}),t.set(0,0,0)):(t.setLength(e.animateSpeed),t)},sync:function(){const e=this.offset,t=this.position,i=this.targetPosition;t.copy(this.el.getAttribute("position")),this.checkpoint.object3D.getWorldPosition(i),i.add(this.checkpoint.components.checkpoint.getOffset()),e.copy(i).sub(t)}});var Ii=Object.assign(function(){},{FACE_1:0,FACE_2:1,FACE_3:2,FACE_4:3,L_SHOULDER_1:4,R_SHOULDER_1:5,L_SHOULDER_2:6,R_SHOULDER_2:7,SELECT:8,START:9,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15,VENDOR:16});function Bi(e,t,i){this.type=e,this.index=t,this.pressed=i.pressed,this.value=i.value}var zi=Bi;const De=Ii,nt=zi,Re=.2,Te={LEFT:"left",RIGHT:"right"},we={MOVEMENT:1,ROTATION:2};AFRAME.registerComponent("gamepad-controls",{GamepadButton:De,schema:{enabled:{default:!0},camera:{default:"[camera]",type:"selector"},rotationSensitivity:{default:2}},init:function(){const e=this.el.sceneEl;this.system=e.systems["tracked-controls-webxr"]||{controllers:[]},this.prevTime=window.performance.now(),this.buttons={};const t=this.el.object3D.rotation;this.pitch=new THREE.Object3D,this.pitch.rotation.x=THREE.Math.degToRad(t.x),this.yaw=new THREE.Object3D,this.yaw.position.y=10,this.yaw.rotation.y=THREE.Math.degToRad(t.y),this.yaw.add(this.pitch),this._lookVector=new THREE.Vector2,this._moveVector=new THREE.Vector2,this._dpadVector=new THREE.Vector2,e.addBehavior(this)},update:function(){this.tick()},tick:function(e,t){this.updateButtonState(),this.updateRotation(t)},remove:function(){},isVelocityActive:function(){if(!this.data.enabled||!this.isConnected())return!1;const e=this._dpadVector,t=this._moveVector;this.getDpad(e),this.getJoystick(we.MOVEMENT,t);const i=e.x||t.x,r=e.y||t.y;return Math.abs(i)>Re||Math.abs(r)>Re},getVelocityDelta:function(){const e=this._dpadVector,t=this._moveVector;this.getDpad(e),this.getJoystick(we.MOVEMENT,t);const i=e.x||t.x,r=e.y||t.y,c=new THREE.Vector3;return Math.abs(i)>Re&&(c.x+=i),Math.abs(r)>Re&&(c.z+=r),c},isRotationActive:function(){if(!this.data.enabled||!this.isConnected())return!1;const e=this._lookVector;return this.getJoystick(we.ROTATION,e),Math.abs(e.x)>Re||Math.abs(e.y)>Re},updateRotation:function(e){if(!this.isRotationActive())return;const t=this.data,i=this.yaw,r=this.pitch,c=t.camera.components["look-controls"],d=c&&c.pitchObject&&c.yawObject;d&&(r.rotation.copy(c.pitchObject.rotation),i.rotation.copy(c.yawObject.rotation));const m=this._lookVector;this.getJoystick(we.ROTATION,m),Math.abs(m.x)<=Re&&(m.x=0),Math.abs(m.y)<=Re&&(m.y=0),m.multiplyScalar(t.rotationSensitivity*e/1e3),i.rotation.y-=m.x,r.rotation.x-=m.y,r.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,r.rotation.x)),t.camera.object3D.rotation.set(r.rotation.x,i.rotation.y,0),d&&(c.pitchObject.rotation.copy(r.rotation),c.yawObject.rotation.copy(i.rotation))},updateButtonState:function(){const e=this.getGamepad(Te.RIGHT);if(this.data.enabled&&e)for(var t=0;t<e.buttons.length;t++)e.buttons[t].pressed&&!this.buttons[t]?this.emit(new nt("gamepadbuttondown",t,e.buttons[t])):!e.buttons[t].pressed&&this.buttons[t]&&this.emit(new nt("gamepadbuttonup",t,e.buttons[t])),this.buttons[t]=e.buttons[t].pressed;else Object.keys(this.buttons)&&(this.buttons={})},emit:function(e){this.el.emit(e.type,e),this.el.emit(e.type+":"+e.index,new nt(e.type,e.index,e))},getGamepad:function(){const e=[],t=[];return function(i){const r=this.el.sceneEl.components["proxy-controls"],c=r&&r.isConnected()&&r.getGamepad(0);if(c)return c;e.length=0;for(let m=0;m<this.system.controllers.length;m++){const b=this.system.controllers[m],w=b?b.gamepad:null;if(e.push(w),w&&w.handedness===i)return w}const d=navigator.getGamepads?navigator.getGamepads():t;for(let m=0;m<d.length;m++){const b=d[m];if(b&&b.hand===i)return b}return e[0]||d[0]}}(),getButton:function(e){return this.getGamepad(Te.RIGHT).buttons[e]},getAxis:function(e){return this.getGamepad(e>1?Te.RIGHT:Te.LEFT).axes[e]},getJoystick:function(e,t){const i=this.getGamepad(e===we.MOVEMENT?Te.LEFT:Te.RIGHT);if(i.mapping==="xr-standard")switch(e){case we.MOVEMENT:return t.set(i.axes[2],i.axes[3]);case we.ROTATION:return t.set(i.axes[0],i.axes[1])}else switch(e){case we.MOVEMENT:return t.set(i.axes[0],i.axes[1]);case we.ROTATION:return t.set(i.axes[2],i.axes[3])}throw new Error('Unexpected joystick index "%d".',e)},getDpad:function(e){const t=this.getGamepad(Te.LEFT);return t.buttons[De.DPAD_RIGHT]?e.set((t.buttons[De.DPAD_RIGHT].pressed?1:0)+(t.buttons[De.DPAD_LEFT].pressed?-1:0),(t.buttons[De.DPAD_UP].pressed?-1:0)+(t.buttons[De.DPAD_DOWN].pressed?1:0)):e.set(0,0)},isConnected:function(){const e=this.getGamepad(Te.LEFT);return!!(e&&e.connected)},getID:function(){return this.getGamepad(Te.LEFT).id}});(function(e){var t="KeyboardEvent"in e;t||(e.KeyboardEvent=function(){throw TypeError("Illegal constructor")}),"DOM_KEY_LOCATION_STANDARD"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_STANDARD=0),"DOM_KEY_LOCATION_LEFT"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_LEFT=1),"DOM_KEY_LOCATION_RIGHT"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_RIGHT=2),"DOM_KEY_LOCATION_NUMPAD"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_NUMPAD=3);var i=window.KeyboardEvent.DOM_KEY_LOCATION_STANDARD,r=window.KeyboardEvent.DOM_KEY_LOCATION_LEFT,c=window.KeyboardEvent.DOM_KEY_LOCATION_RIGHT,d=window.KeyboardEvent.DOM_KEY_LOCATION_NUMPAD;function m(j,X){return String(j).indexOf(X)!==-1}var b=function(){return m(navigator.platform,"Win")?"win":m(navigator.platform,"Mac")?"mac":m(navigator.platform,"CrOS")?"cros":m(navigator.platform,"Linux")?"linux":m(navigator.userAgent,"iPad")||m(navigator.platform,"iPod")||m(navigator.platform,"iPhone")?"ios":""}(),w=function(){return m(navigator.userAgent,"Chrome/")?"chrome":m(navigator.vendor,"Apple")?"safari":m(navigator.userAgent,"MSIE")?"ie":m(navigator.userAgent,"Gecko/")?"moz":m(navigator.userAgent,"Opera/")?"opera":""}(),H=w+"-"+b;function C(j,X,G){(H===X||w===X||b===X)&&Object.keys(G).forEach(function(ae){j[ae]=G[ae]})}function K(j,X){var G={};return Object.keys(j).forEach(function(ae){var se=j[ae];X in se&&(G[se[X]]=se)}),G}var D={3:{code:"Cancel"},6:{code:"Help"},8:{code:"Backspace"},9:{code:"Tab"},12:{code:"Clear"},13:{code:"Enter"},16:{code:"Shift"},17:{code:"Control"},18:{code:"Alt"},19:{code:"Pause"},20:{code:"CapsLock"},21:{code:"KanaMode"},22:{code:"HangulMode"},23:{code:"JunjaMode"},24:{code:"FinalMode"},25:{code:"KanjiMode"},27:{code:"Escape"},28:{code:"Convert"},29:{code:"NonConvert"},30:{code:"Accept"},31:{code:"ModeChange"},32:{code:"Space"},33:{code:"PageUp"},34:{code:"PageDown"},35:{code:"End"},36:{code:"Home"},37:{code:"ArrowLeft"},38:{code:"ArrowUp"},39:{code:"ArrowRight"},40:{code:"ArrowDown"},41:{code:"Select"},42:{code:"Print"},43:{code:"Execute"},44:{code:"PrintScreen"},45:{code:"Insert"},46:{code:"Delete"},47:{code:"Help"},48:{code:"Digit0",keyCap:"0"},49:{code:"Digit1",keyCap:"1"},50:{code:"Digit2",keyCap:"2"},51:{code:"Digit3",keyCap:"3"},52:{code:"Digit4",keyCap:"4"},53:{code:"Digit5",keyCap:"5"},54:{code:"Digit6",keyCap:"6"},55:{code:"Digit7",keyCap:"7"},56:{code:"Digit8",keyCap:"8"},57:{code:"Digit9",keyCap:"9"},65:{code:"KeyA",keyCap:"a"},66:{code:"KeyB",keyCap:"b"},67:{code:"KeyC",keyCap:"c"},68:{code:"KeyD",keyCap:"d"},69:{code:"KeyE",keyCap:"e"},70:{code:"KeyF",keyCap:"f"},71:{code:"KeyG",keyCap:"g"},72:{code:"KeyH",keyCap:"h"},73:{code:"KeyI",keyCap:"i"},74:{code:"KeyJ",keyCap:"j"},75:{code:"KeyK",keyCap:"k"},76:{code:"KeyL",keyCap:"l"},77:{code:"KeyM",keyCap:"m"},78:{code:"KeyN",keyCap:"n"},79:{code:"KeyO",keyCap:"o"},80:{code:"KeyP",keyCap:"p"},81:{code:"KeyQ",keyCap:"q"},82:{code:"KeyR",keyCap:"r"},83:{code:"KeyS",keyCap:"s"},84:{code:"KeyT",keyCap:"t"},85:{code:"KeyU",keyCap:"u"},86:{code:"KeyV",keyCap:"v"},87:{code:"KeyW",keyCap:"w"},88:{code:"KeyX",keyCap:"x"},89:{code:"KeyY",keyCap:"y"},90:{code:"KeyZ",keyCap:"z"},91:{code:"OSLeft",location:r},92:{code:"OSRight",location:c},93:{code:"ContextMenu"},95:{code:"Standby"},96:{code:"Numpad0",keyCap:"0",location:d},97:{code:"Numpad1",keyCap:"1",location:d},98:{code:"Numpad2",keyCap:"2",location:d},99:{code:"Numpad3",keyCap:"3",location:d},100:{code:"Numpad4",keyCap:"4",location:d},101:{code:"Numpad5",keyCap:"5",location:d},102:{code:"Numpad6",keyCap:"6",location:d},103:{code:"Numpad7",keyCap:"7",location:d},104:{code:"Numpad8",keyCap:"8",location:d},105:{code:"Numpad9",keyCap:"9",location:d},106:{code:"NumpadMultiply",keyCap:"*",location:d},107:{code:"NumpadAdd",keyCap:"+",location:d},108:{code:"NumpadComma",keyCap:",",location:d},109:{code:"NumpadSubtract",keyCap:"-",location:d},110:{code:"NumpadDecimal",keyCap:".",location:d},111:{code:"NumpadDivide",keyCap:"/",location:d},112:{code:"F1"},113:{code:"F2"},114:{code:"F3"},115:{code:"F4"},116:{code:"F5"},117:{code:"F6"},118:{code:"F7"},119:{code:"F8"},120:{code:"F9"},121:{code:"F10"},122:{code:"F11"},123:{code:"F12"},124:{code:"F13"},125:{code:"F14"},126:{code:"F15"},127:{code:"F16"},128:{code:"F17"},129:{code:"F18"},130:{code:"F19"},131:{code:"F20"},132:{code:"F21"},133:{code:"F22"},134:{code:"F23"},135:{code:"F24"},144:{code:"NumLock",location:d},145:{code:"ScrollLock"},160:{code:"ShiftLeft",location:r},161:{code:"ShiftRight",location:c},162:{code:"ControlLeft",location:r},163:{code:"ControlRight",location:c},164:{code:"AltLeft",location:r},165:{code:"AltRight",location:c},166:{code:"BrowserBack"},167:{code:"BrowserForward"},168:{code:"BrowserRefresh"},169:{code:"BrowserStop"},170:{code:"BrowserSearch"},171:{code:"BrowserFavorites"},172:{code:"BrowserHome"},173:{code:"VolumeMute"},174:{code:"VolumeDown"},175:{code:"VolumeUp"},176:{code:"MediaTrackNext"},177:{code:"MediaTrackPrevious"},178:{code:"MediaStop"},179:{code:"MediaPlayPause"},180:{code:"LaunchMail"},181:{code:"MediaSelect"},182:{code:"LaunchApp1"},183:{code:"LaunchApp2"},186:{code:"Semicolon",keyCap:";"},187:{code:"Equal",keyCap:"="},188:{code:"Comma",keyCap:","},189:{code:"Minus",keyCap:"-"},190:{code:"Period",keyCap:"."},191:{code:"Slash",keyCap:"/"},192:{code:"Backquote",keyCap:"`"},219:{code:"BracketLeft",keyCap:"["},220:{code:"Backslash",keyCap:"\\"},221:{code:"BracketRight",keyCap:"]"},222:{code:"Quote",keyCap:"'"},226:{code:"IntlBackslash",keyCap:"\\"},229:{code:"Process"},246:{code:"Attn"},247:{code:"CrSel"},248:{code:"ExSel"},249:{code:"EraseEof"},250:{code:"Play"},251:{code:"ZoomToggle"},254:{code:"Clear"}};C(D,"moz",{59:{code:"Semicolon",keyCap:";"},61:{code:"Equal",keyCap:"="},107:{code:"Equal",keyCap:"="},109:{code:"Minus",keyCap:"-"},187:{code:"NumpadAdd",keyCap:"+",location:d},189:{code:"NumpadSubtract",keyCap:"-",location:d}}),C(D,"moz-mac",{12:{code:"NumLock",location:d},173:{code:"Minus",keyCap:"-"}}),C(D,"moz-win",{173:{code:"Minus",keyCap:"-"}}),C(D,"chrome-mac",{93:{code:"OSRight",location:c}}),C(D,"safari",{3:{code:"Enter"},25:{code:"Tab"}}),C(D,"ios",{10:{code:"Enter",location:i}}),C(D,"safari-mac",{91:{code:"OSLeft",location:r},93:{code:"OSRight",location:c},229:{code:"KeyQ",keyCap:"Q"}});var S={};b==="cros"&&(S["U+00A0"]={code:"ShiftLeft",location:r},S["U+00A1"]={code:"ShiftRight",location:c},S["U+00A2"]={code:"ControlLeft",location:r},S["U+00A3"]={code:"ControlRight",location:c},S["U+00A4"]={code:"AltLeft",location:r},S["U+00A5"]={code:"AltRight",location:c}),H==="chrome-mac"&&(S["U+0010"]={code:"ContextMenu"}),H==="safari-mac"&&(S["U+0010"]={code:"ContextMenu"}),b==="ios"&&(S["U+0010"]={code:"Function"},S["U+001C"]={code:"ArrowLeft"},S["U+001D"]={code:"ArrowRight"},S["U+001E"]={code:"ArrowUp"},S["U+001F"]={code:"ArrowDown"},S["U+0001"]={code:"Home"},S["U+0004"]={code:"End"},S["U+000B"]={code:"PageUp"},S["U+000C"]={code:"PageDown"});var F=[];F[r]={16:{code:"ShiftLeft",location:r},17:{code:"ControlLeft",location:r},18:{code:"AltLeft",location:r}},F[c]={16:{code:"ShiftRight",location:c},17:{code:"ControlRight",location:c},18:{code:"AltRight",location:c}},F[d]={13:{code:"NumpadEnter",location:d}},C(F[d],"moz",{109:{code:"NumpadSubtract",location:d},107:{code:"NumpadAdd",location:d}}),C(F[r],"moz-mac",{224:{code:"OSLeft",location:r}}),C(F[c],"moz-mac",{224:{code:"OSRight",location:c}}),C(F[c],"moz-win",{91:{code:"OSRight",location:c}}),C(F[c],"mac",{93:{code:"OSRight",location:c}}),C(F[d],"chrome-mac",{12:{code:"NumLock",location:d}}),C(F[d],"safari-mac",{12:{code:"NumLock",location:d},187:{code:"NumpadAdd",location:d},189:{code:"NumpadSubtract",location:d},190:{code:"NumpadDecimal",location:d},191:{code:"NumpadDivide",location:d}});var re={ShiftLeft:{key:"Shift"},ShiftRight:{key:"Shift"},ControlLeft:{key:"Control"},ControlRight:{key:"Control"},AltLeft:{key:"Alt"},AltRight:{key:"Alt"},OSLeft:{key:"OS"},OSRight:{key:"OS"},NumpadEnter:{key:"Enter"},Space:{key:" "},Digit0:{key:"0",shiftKey:")"},Digit1:{key:"1",shiftKey:"!"},Digit2:{key:"2",shiftKey:"@"},Digit3:{key:"3",shiftKey:"#"},Digit4:{key:"4",shiftKey:"$"},Digit5:{key:"5",shiftKey:"%"},Digit6:{key:"6",shiftKey:"^"},Digit7:{key:"7",shiftKey:"&"},Digit8:{key:"8",shiftKey:"*"},Digit9:{key:"9",shiftKey:"("},KeyA:{key:"a",shiftKey:"A"},KeyB:{key:"b",shiftKey:"B"},KeyC:{key:"c",shiftKey:"C"},KeyD:{key:"d",shiftKey:"D"},KeyE:{key:"e",shiftKey:"E"},KeyF:{key:"f",shiftKey:"F"},KeyG:{key:"g",shiftKey:"G"},KeyH:{key:"h",shiftKey:"H"},KeyI:{key:"i",shiftKey:"I"},KeyJ:{key:"j",shiftKey:"J"},KeyK:{key:"k",shiftKey:"K"},KeyL:{key:"l",shiftKey:"L"},KeyM:{key:"m",shiftKey:"M"},KeyN:{key:"n",shiftKey:"N"},KeyO:{key:"o",shiftKey:"O"},KeyP:{key:"p",shiftKey:"P"},KeyQ:{key:"q",shiftKey:"Q"},KeyR:{key:"r",shiftKey:"R"},KeyS:{key:"s",shiftKey:"S"},KeyT:{key:"t",shiftKey:"T"},KeyU:{key:"u",shiftKey:"U"},KeyV:{key:"v",shiftKey:"V"},KeyW:{key:"w",shiftKey:"W"},KeyX:{key:"x",shiftKey:"X"},KeyY:{key:"y",shiftKey:"Y"},KeyZ:{key:"z",shiftKey:"Z"},Numpad0:{key:"0"},Numpad1:{key:"1"},Numpad2:{key:"2"},Numpad3:{key:"3"},Numpad4:{key:"4"},Numpad5:{key:"5"},Numpad6:{key:"6"},Numpad7:{key:"7"},Numpad8:{key:"8"},Numpad9:{key:"9"},NumpadMultiply:{key:"*"},NumpadAdd:{key:"+"},NumpadComma:{key:","},NumpadSubtract:{key:"-"},NumpadDecimal:{key:"."},NumpadDivide:{key:"/"},Semicolon:{key:";",shiftKey:":"},Equal:{key:"=",shiftKey:"+"},Comma:{key:",",shiftKey:"<"},Minus:{key:"-",shiftKey:"_"},Period:{key:".",shiftKey:">"},Slash:{key:"/",shiftKey:"?"},Backquote:{key:"`",shiftKey:"~"},BracketLeft:{key:"[",shiftKey:"{"},Backslash:{key:"\\",shiftKey:"|"},BracketRight:{key:"]",shiftKey:"}"},Quote:{key:"'",shiftKey:'"'},IntlBackslash:{key:"\\",shiftKey:"|"}};C(re,"mac",{OSLeft:{key:"Meta"},OSRight:{key:"Meta"}});var he={Esc:"Escape",Nonconvert:"NonConvert",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Menu:"ContextMenu",MediaNextTrack:"MediaTrackNext",MediaPreviousTrack:"MediaTrackPrevious",SelectMedia:"MediaSelect",HalfWidth:"Hankaku",FullWidth:"Zenkaku",RomanCharacters:"Romaji",Crsel:"CrSel",Exsel:"ExSel",Zoom:"ZoomToggle"},ne=K(D,"code");try{var me=t&&"location"in new KeyboardEvent("")}catch{}function ye(j){var X="keyCode"in j?j.keyCode:"which"in j?j.which:0,G=function(){if(me||"keyLocation"in j){var se=me?j.location:j.keyLocation;if(se&&X in F[se])return F[se][X]}return"keyIdentifier"in j&&j.keyIdentifier in S?S[j.keyIdentifier]:X in D?D[X]:null}();if(!G)return null;var ae=function(){var se=re[G.code];return se?j.shiftKey&&"shiftKey"in se?se.shiftKey:se.key:G.code}();return{code:G.code,key:ae,location:G.location,keyCap:G.keyCap}}function xe(j,X){if(j=String(j),!ne.hasOwnProperty(j))return"Undefined";if(X&&String(X).toLowerCase()!=="en-us")throw Error("Unsupported locale");var G=ne[j];return G.keyCap||G.code||"Undefined"}"KeyboardEvent"in e&&"defineProperty"in Object&&function(){function j(G,ae,se){ae in G||Object.defineProperty(G,ae,se)}if(j(KeyboardEvent.prototype,"code",{get:function(){var G=ye(this);return G?G.code:""}}),"key"in KeyboardEvent.prototype){var X=Object.getOwnPropertyDescriptor(KeyboardEvent.prototype,"key");Object.defineProperty(KeyboardEvent.prototype,"key",{get:function(){var G=X.get.call(this);return he.hasOwnProperty(G)?he[G]:G}})}j(KeyboardEvent.prototype,"key",{get:function(){var G=ye(this);return G&&"key"in G?G.key:"Unidentified"}}),j(KeyboardEvent.prototype,"location",{get:function(){var G=ye(this);return G&&"location"in G?G.location:i}}),j(KeyboardEvent.prototype,"locale",{get:function(){return""}})}(),"queryKeyCap"in e.KeyboardEvent||(e.KeyboardEvent.queryKeyCap=xe),e.identifyKey=function(j){if(!("code"in j)){var X=ye(j);j.code=X?X.code:"",j.key=X&&"key"in X?X.key:"Unidentified",j.location="location"in j?j.location:"keyLocation"in j?j.keyLocation:X&&"location"in X?X.location:i,j.locale=""}}})(window);const ji="__keyboard-controls-proxy",Vi=window.KeyboardEvent;AFRAME.registerComponent("keyboard-controls",{schema:{enabled:{default:!0},debug:{default:!1}},init:function(){this.dVelocity=new THREE.Vector3,this.localKeys={},this.listeners={keydown:this.onKeyDown.bind(this),keyup:this.onKeyUp.bind(this),blur:this.onBlur.bind(this)},this.attachEventListeners()},isVelocityActive:function(){return this.data.enabled&&!!Object.keys(this.getKeys()).length},getVelocityDelta:function(){const e=this.data,t=this.getKeys();return this.dVelocity.set(0,0,0),e.enabled&&((t.KeyW||t.ArrowUp)&&(this.dVelocity.z-=1),(t.KeyA||t.ArrowLeft)&&(this.dVelocity.x-=1),(t.KeyS||t.ArrowDown)&&(this.dVelocity.z+=1),(t.KeyD||t.ArrowRight)&&(this.dVelocity.x+=1)),this.dVelocity.clone()},play:function(){this.attachEventListeners()},pause:function(){this.removeEventListeners()},remove:function(){this.pause()},attachEventListeners:function(){window.addEventListener("keydown",this.listeners.keydown,!1),window.addEventListener("keyup",this.listeners.keyup,!1),window.addEventListener("blur",this.listeners.blur,!1)},removeEventListeners:function(){window.removeEventListener("keydown",this.listeners.keydown),window.removeEventListener("keyup",this.listeners.keyup),window.removeEventListener("blur",this.listeners.blur)},onKeyDown:function(e){AFRAME.utils.shouldCaptureKeyEvent(e)&&(this.localKeys[e.code]=!0,this.emit(e))},onKeyUp:function(e){AFRAME.utils.shouldCaptureKeyEvent(e)&&(delete this.localKeys[e.code],this.emit(e))},onBlur:function(){for(let e in this.localKeys)this.localKeys.hasOwnProperty(e)&&delete this.localKeys[e]},emit:function(e){ji in e&&this.el.emit(e.type,e),this.el.emit(e.type+":"+e.code,new Vi(e.type,e)),this.data.debug&&console.log(e.type+":"+e.code)},isPressed:function(e){return e in this.getKeys()},getKeys:function(){return this.isProxied()?this.el.sceneEl.components["proxy-controls"].getKeyboard():this.localKeys},isProxied:function(){const e=this.el.sceneEl.components["proxy-controls"];return e&&e.isConnected()}});AFRAME.registerComponent("touch-controls",{schema:{enabled:{default:!0},reverseEnabled:{default:!0}},init:function(){this.dVelocity=new THREE.Vector3,this.bindMethods(),this.direction=0},play:function(){this.addEventListeners()},pause:function(){this.removeEventListeners(),this.dVelocity.set(0,0,0)},remove:function(){this.pause()},addEventListeners:function(){const e=this.el.sceneEl,t=e.canvas;if(!t){e.addEventListener("render-target-loaded",this.addEventListeners.bind(this));return}t.addEventListener("touchstart",this.onTouchStart),t.addEventListener("touchend",this.onTouchEnd)},removeEventListeners:function(){const e=this.el.sceneEl&&this.el.sceneEl.canvas;!e||(e.removeEventListener("touchstart",this.onTouchStart),e.removeEventListener("touchend",this.onTouchEnd))},isVelocityActive:function(){return this.data.enabled&&!!this.direction},getVelocityDelta:function(){return this.dVelocity.z=this.direction,this.dVelocity.clone()},bindMethods:function(){this.onTouchStart=this.onTouchStart.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this)},onTouchStart:function(e){this.direction=-1,this.data.reverseEnabled&&e.touches.length===2&&(this.direction=1),e.preventDefault()},onTouchEnd:function(e){this.direction=0,e.preventDefault()}});const Mt="-controls",Ki=.2,Gi=1e-5;AFRAME.registerComponent("movement-controls",{dependencies:["rotation"],schema:{enabled:{default:!0},controls:{default:["gamepad","trackpad","keyboard","touch"]},speed:{default:.3,min:0},fly:{default:!1},constrainToNavMesh:{default:!1},camera:{default:"[movement-controls] [camera]",type:"selector"}},init:function(){const e=this.el;this.velocityCtrl=null,this.velocity=new THREE.Vector3,this.heading=new THREE.Quaternion,this.navGroup=null,this.navNode=null,e.sceneEl.hasLoaded?this.injectControls():e.sceneEl.addEventListener("loaded",this.injectControls.bind(this))},update:function(e){const t=this.el,i=this.data,r=t.sceneEl.systems.nav;t.sceneEl.hasLoaded&&this.injectControls(),r&&i.constrainToNavMesh!==e.constrainToNavMesh&&(i.constrainToNavMesh?r.addAgent(this):r.removeAgent(this))},injectControls:function(){const e=this.data;var t;for(let i=0;i<e.controls.length;i++)t=e.controls[i]+Mt,this.el.components[t]||this.el.setAttribute(t,"")},updateNavLocation:function(){this.navGroup=null,this.navNode=null},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3;return function(r,c){if(!c)return;const d=this.el,m=this.data;if(!m.enabled)return;this.updateVelocityCtrl();const b=this.velocityCtrl,w=this.velocity;if(!!b)if(c/1e3>Ki?w.set(0,0,0):this.updateVelocity(c),m.constrainToNavMesh&&b.isNavMeshConstrained!==!1){if(w.lengthSq()<Gi)return;e.copy(d.object3D.position),t.copy(w).multiplyScalar(c/1e3).add(e);const H=d.sceneEl.systems.nav;this.navGroup=this.navGroup===null?H.getGroup(e):this.navGroup,this.navNode=this.navNode||H.getNode(e,this.navGroup),this.navNode=H.clampStep(e,t,this.navGroup,this.navNode,i),d.object3D.position.copy(i)}else d.hasAttribute("velocity")?d.setAttribute("velocity",w):(d.object3D.position.x+=w.x*c/1e3,d.object3D.position.y+=w.y*c/1e3,d.object3D.position.z+=w.z*c/1e3)}}(),updateVelocityCtrl:function(){const e=this.data;if(e.enabled){for(let t=0,i=e.controls.length;t<i;t++){const r=this.el.components[e.controls[t]+Mt];if(r&&r.isVelocityActive()){this.velocityCtrl=r;return}}this.velocityCtrl=null}},updateVelocity:function(){const e=new THREE.Vector2,t=new THREE.Quaternion;return function(i){let r;const c=this.el,d=this.velocityCtrl,m=this.velocity,b=this.data;if(d)if(d.getVelocityDelta)r=d.getVelocityDelta(i);else if(d.getVelocity){m.copy(d.getVelocity());return}else if(d.getPositionDelta){m.copy(d.getPositionDelta(i).multiplyScalar(1e3/i));return}else throw new Error("Incompatible movement controls: ",d);if(c.hasAttribute("velocity")&&!b.constrainToNavMesh&&m.copy(this.el.getAttribute("velocity")),r&&b.enabled){const w=b.camera;t.copy(w.object3D.quaternion),t.premultiply(c.object3D.quaternion),r.applyQuaternion(t);const H=r.length();b.fly?(m.copy(r),m.multiplyScalar(this.data.speed*16.66667)):(e.set(r.x,r.z),e.setLength(H*this.data.speed*16.66667),m.x=e.x,m.z=e.y)}}}()});AFRAME.registerComponent("trackpad-controls",{schema:{enabled:{default:!0},enableNegX:{default:!0},enablePosX:{default:!0},enableNegZ:{default:!0},enablePosZ:{default:!0},mode:{default:"touch",oneOf:["swipe","touch","press"]}},init:function(){this.dVelocity=new THREE.Vector3,this.zVel=0,this.xVel=0,this.bindMethods()},play:function(){this.addEventListeners()},pause:function(){this.removeEventListeners(),this.dVelocity.set(0,0,0)},remove:function(){this.pause()},addEventListeners:function(){const e=this.data,t=this.el.sceneEl;switch(t.addEventListener("axismove",this.onAxisMove),e.mode){case"swipe":case"touch":t.addEventListener("trackpadtouchstart",this.onTouchStart),t.addEventListener("trackpadtouchend",this.onTouchEnd);break;case"press":t.addEventListener("trackpaddown",this.onTouchStart),t.addEventListener("trackpadup",this.onTouchEnd);break}},removeEventListeners:function(){const e=this.el.sceneEl;e.removeEventListener("axismove",this.onAxisMove),e.removeEventListener("trackpadtouchstart",this.onTouchStart),e.removeEventListener("trackpadtouchend",this.onTouchEnd),e.removeEventListener("trackpaddown",this.onTouchStart),e.removeEventListener("trackpadup",this.onTouchEnd)},isVelocityActive:function(){return this.data.enabled&&this.isMoving},getVelocityDelta:function(){return this.dVelocity.z=this.isMoving?-this.zVel:1,this.dVelocity.x=this.isMoving?this.xVel:1,this.dVelocity.clone()},bindMethods:function(){this.onTouchStart=this.onTouchStart.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.onAxisMove=this.onAxisMove.bind(this)},onTouchStart:function(e){switch(this.data.mode){case"swipe":this.canRecordAxis=!0,this.startingAxisData=[];break;case"touch":this.isMoving=!0;break;case"press":this.isMoving=!0;break}e.preventDefault()},onTouchEnd:function(e){this.data.mode=="swipe"&&(this.startingAxisData=[]),this.isMoving=!1,e.preventDefault()},onAxisMove:function(e){switch(this.data.mode){case"swipe":return this.handleSwipeAxis(e);case"touch":case"press":return this.handleTouchAxis(e)}},handleSwipeAxis:function(e){const t=this.data,i=e.detail.axis;if(this.startingAxisData.length===0&&this.canRecordAxis&&(this.canRecordAxis=!1,this.startingAxisData[0]=i[0],this.startingAxisData[1]=i[1]),this.startingAxisData.length>0){let r=0,c=0;t.enableNegX&&i[0]<this.startingAxisData[0]&&(r=-1),t.enablePosX&&i[0]>this.startingAxisData[0]&&(r=1),t.enablePosZ&&i[1]>this.startingAxisData[1]&&(c=-1),t.enableNegZ&&i[1]<this.startingAxisData[1]&&(c=1);const d=Math.abs(this.startingAxisData[1]-i[1]);Math.abs(this.startingAxisData[0]-i[0])>d?(this.zVel=0,this.xVel=r,this.isMoving=!0):(this.xVel=0,this.zVel=c,this.isMoving=!0)}},handleTouchAxis:function(e){const t=this.data,i=e.detail.axis;let r=0,c=0;t.enableNegX&&i[0]<0&&(r=-1),t.enablePosX&&i[0]>0&&(r=1),t.enablePosZ&&i[1]>0&&(c=-1),t.enableNegZ&&i[1]<0&&(c=1),Math.abs(i[0])>Math.abs(i[1])?(this.zVel=0,this.xVel=r):(this.xVel=0,this.zVel=c)}});const rt={once:THREE.LoopOnce,repeat:THREE.LoopRepeat,pingpong:THREE.LoopPingPong};AFRAME.registerComponent("animation-mixer",{schema:{clip:{default:"*"},duration:{default:0},clampWhenFinished:{default:!1,type:"boolean"},crossFadeDuration:{default:0},loop:{default:"repeat",oneOf:Object.keys(rt)},repetitions:{default:1/0,min:0},timeScale:{default:1}},init:function(){this.model=null,this.mixer=null,this.activeActions=[];const e=this.el.getObject3D("mesh");e?this.load(e):this.el.addEventListener("model-loaded",t=>{this.load(t.detail.model)})},load:function(e){const t=this.el;this.model=e,this.mixer=new THREE.AnimationMixer(e),this.mixer.addEventListener("loop",i=>{t.emit("animation-loop",{action:i.action,loopDelta:i.loopDelta})}),this.mixer.addEventListener("finished",i=>{t.emit("animation-finished",{action:i.action,direction:i.direction})}),this.data.clip&&this.update({})},remove:function(){this.mixer&&this.mixer.stopAllAction()},update:function(e){if(!e)return;const t=this.data,i=AFRAME.utils.diff(t,e);if("clip"in i){this.stopAction(),t.clip&&this.playAction();return}this.activeActions.forEach(r=>{"duration"in i&&t.duration&&r.setDuration(t.duration),"clampWhenFinished"in i&&(r.clampWhenFinished=t.clampWhenFinished),("loop"in i||"repetitions"in i)&&r.setLoop(rt[t.loop],t.repetitions),"timeScale"in i&&r.setEffectiveTimeScale(t.timeScale)})},stopAction:function(){const e=this.data;for(let t=0;t<this.activeActions.length;t++)e.crossFadeDuration?this.activeActions[t].fadeOut(e.crossFadeDuration):this.activeActions[t].stop();this.activeActions.length=0},playAction:function(){if(!this.mixer)return;const e=this.model,t=this.data,i=e.animations||(e.geometry||{}).animations||[];if(!i.length)return;const r=Ui(t.clip);for(let c,d=0;c=i[d];d++)if(c.name.match(r)){const m=this.mixer.clipAction(c,e);m.enabled=!0,m.clampWhenFinished=t.clampWhenFinished,t.duration&&m.setDuration(t.duration),t.timeScale!==1&&m.setEffectiveTimeScale(t.timeScale),m.setLoop(rt[t.loop],t.repetitions).fadeIn(t.crossFadeDuration).play(),this.activeActions.push(m)}},tick:function(e,t){this.mixer&&!isNaN(t)&&this.mixer.update(t/1e3)}});function Ui(e){return new RegExp("^"+e.split(/\*+/).map(qi).join(".*")+"$")}function qi(e){return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&")}var Xi=THREE.ColladaLoader=function(e){this.manager=e!==void 0?e:THREE.DefaultLoadingManager};THREE.ColladaLoader.prototype={constructor:THREE.ColladaLoader,crossOrigin:"anonymous",load:function(e,t,i,r){var c=this,d=c.path===void 0?THREE.LoaderUtils.extractUrlBase(e):c.path,m=new THREE.FileLoader(c.manager);m.setPath(c.path),m.load(e,function(b){t(c.parse(b,d))},i,r)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},options:{set convertUpAxis(e){console.warn("THREE.ColladaLoader: options.convertUpAxis() has been removed. Up axis is converted automatically.")}},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e,t){function i(a,s){for(var h=[],v=a.childNodes,u=0,E=v.length;u<E;u++){var A=v[u];A.nodeName===s&&h.push(A)}return h}function r(a){if(a.length===0)return[];for(var s=a.trim().split(/\s+/),h=new Array(s.length),v=0,u=s.length;v<u;v++)h[v]=s[v];return h}function c(a){if(a.length===0)return[];for(var s=a.trim().split(/\s+/),h=new Array(s.length),v=0,u=s.length;v<u;v++)h[v]=parseFloat(s[v]);return h}function d(a){if(a.length===0)return[];for(var s=a.trim().split(/\s+/),h=new Array(s.length),v=0,u=s.length;v<u;v++)h[v]=parseInt(s[v]);return h}function m(a){return a.substring(1)}function b(){return"three_default_"+ki++}function w(a){return Object.keys(a).length===0}function H(a){return{unit:C(i(a,"unit")[0]),upAxis:K(i(a,"up_axis")[0])}}function C(a){return a!==void 0&&a.hasAttribute("meter")===!0?parseFloat(a.getAttribute("meter")):1}function K(a){return a!==void 0?a.textContent:"Y_UP"}function D(a,s,h,v){var u=i(a,s)[0];if(u!==void 0)for(var E=i(u,h),A=0;A<E.length;A++)v(E[A])}function S(a,s){for(var h in a){var v=a[h];v.build=s(a[h])}}function F(a,s){return a.build!==void 0||(a.build=s(a)),a.build}function re(a){for(var s={sources:{},samplers:{},channels:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1){var E;switch(u.nodeName){case"source":E=u.getAttribute("id"),s.sources[E]=Ye(u);break;case"sampler":E=u.getAttribute("id"),s.samplers[E]=he(u);break;case"channel":E=u.getAttribute("target"),s.channels[E]=ne(u);break;default:console.log(u)}}}V.animations[a.getAttribute("id")]=s}function he(a){for(var s={inputs:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"input":var E=m(u.getAttribute("source")),A=u.getAttribute("semantic");s.inputs[A]=E;break}}return s}function ne(a){var s={},h=a.getAttribute("target"),v=h.split("/"),u=v.shift(),E=v.shift(),A=E.indexOf("(")!==-1,L=E.indexOf(".")!==-1;if(L)v=E.split("."),E=v.shift(),s.member=v.shift();else if(A){var O=E.split("(");E=O.shift();for(var z=0;z<O.length;z++)O[z]=parseInt(O[z].replace(/\)/,""));s.indices=O}return s.id=u,s.sid=E,s.arraySyntax=A,s.memberSyntax=L,s.sampler=m(a.getAttribute("source")),s}function me(a){var s=[],h=a.channels,v=a.samplers,u=a.sources;for(var E in h)if(h.hasOwnProperty(E)){var A=h[E],L=v[A.sampler],O=L.inputs.INPUT,z=L.inputs.OUTPUT,_=u[O],B=u[z],Q=xe(A,_,B);se(Q,s)}return s}function ye(a){return F(V.animations[a],me)}function xe(a,s,h){var v=V.nodes[a.id],u=Oe(v.id),E=v.transforms[a.sid],A=v.matrix.clone().transpose(),L,O,z,_,B,Q,q={};switch(E){case"matrix":for(z=0,_=s.array.length;z<_;z++)if(L=s.array[z],O=z*h.stride,q[L]===void 0&&(q[L]={}),a.arraySyntax===!0){var W=h.array[O],P=a.indices[0]+4*a.indices[1];q[L][P]=W}else for(B=0,Q=h.stride;B<Q;B++)q[L][B]=h.array[O+B];break;case"translate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',E);break;case"rotate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',E);break;case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',E);break}var Z=j(q,A),J={name:u.uuid,keyframes:Z};return J}function j(a,s){var h=[];for(var v in a)h.push({time:parseFloat(v),value:a[v]});h.sort(E);for(var u=0;u<16;u++)Xe(h,u,s.elements[u]);return h;function E(A,L){return A.time-L.time}}var X=new THREE.Vector3,G=new THREE.Vector3,ae=new THREE.Quaternion;function se(a,s){for(var h=a.keyframes,v=a.name,u=[],E=[],A=[],L=[],O=0,z=h.length;O<z;O++){var _=h[O],B=_.time,Q=_.value;pe.fromArray(Q).transpose(),pe.decompose(X,ae,G),u.push(B),E.push(X.x,X.y,X.z),A.push(ae.x,ae.y,ae.z,ae.w),L.push(G.x,G.y,G.z)}return E.length>0&&s.push(new THREE.VectorKeyframeTrack(v+".position",u,E)),A.length>0&&s.push(new THREE.QuaternionKeyframeTrack(v+".quaternion",u,A)),L.length>0&&s.push(new THREE.VectorKeyframeTrack(v+".scale",u,L)),s}function Xe(a,s,h){var v,u=!0,E,A;for(E=0,A=a.length;E<A;E++)v=a[E],v.value[s]===void 0?v.value[s]=null:u=!1;if(u===!0)for(E=0,A=a.length;E<A;E++)v=a[E],v.value[s]=h;else We(a,s)}function We(a,s){for(var h,v,u=0,E=a.length;u<E;u++){var A=a[u];if(A.value[s]===null){if(h=ze(a,u,s),v=n(a,u,s),h===null){A.value[s]=v.value[s];continue}if(v===null){A.value[s]=h.value[s];continue}o(A,h,v,s)}}}function ze(a,s,h){for(;s>=0;){var v=a[s];if(v.value[h]!==null)return v;s--}return null}function n(a,s,h){for(;s<a.length;){var v=a[s];if(v.value[h]!==null)return v;s++}return null}function o(a,s,h,v){if(h.time-s.time===0){a.value[v]=s.value[v];return}a.value[v]=(a.time-s.time)*(h.value[v]-s.value[v])/(h.time-s.time)+s.value[v]}function l(a){for(var s={name:a.getAttribute("id")||"default",start:parseFloat(a.getAttribute("start")||0),end:parseFloat(a.getAttribute("end")||0),animations:[]},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"instance_animation":s.animations.push(m(u.getAttribute("url")));break}}V.clips[a.getAttribute("id")]=s}function f(a){for(var s=[],h=a.name,v=a.end-a.start||-1,u=a.animations,E=0,A=u.length;E<A;E++)for(var L=ye(u[E]),O=0,z=L.length;O<z;O++)s.push(L[O]);return new THREE.AnimationClip(h,v,s)}function p(a){return F(V.clips[a],f)}function g(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"skin":s.id=m(u.getAttribute("source")),s.skin=y(u);break;case"morph":s.id=m(u.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.");break}}V.controllers[a.getAttribute("id")]=s}function y(a){for(var s={sources:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"bind_shape_matrix":s.bindShapeMatrix=c(u.textContent);break;case"source":var E=u.getAttribute("id");s.sources[E]=Ye(u);break;case"joints":s.joints=T(u);break;case"vertex_weights":s.vertexWeights=R(u);break}}return s}function T(a){for(var s={inputs:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"input":var E=u.getAttribute("semantic"),A=m(u.getAttribute("source"));s.inputs[E]=A;break}}return s}function R(a){for(var s={inputs:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"input":var E=u.getAttribute("semantic"),A=m(u.getAttribute("source")),L=parseInt(u.getAttribute("offset"));s.inputs[E]={id:A,offset:L};break;case"vcount":s.vcount=d(u.textContent);break;case"v":s.v=d(u.textContent);break}}return s}function M(a){var s={id:a.id},h=V.geometries[s.id];return a.skin!==void 0&&(s.skin=k(a.skin),h.sources.skinIndices=s.skin.indices,h.sources.skinWeights=s.skin.weights),s}function k(a){var s=4,h={joints:[],indices:{array:[],stride:s},weights:{array:[],stride:s}},v=a.sources,u=a.vertexWeights,E=u.vcount,A=u.v,L=u.inputs.JOINT.offset,O=u.inputs.WEIGHT.offset,z=a.sources[a.joints.inputs.JOINT],_=a.sources[a.joints.inputs.INV_BIND_MATRIX],B=v[u.inputs.WEIGHT.id].array,Q=0,q,W,P;for(q=0,P=E.length;q<P;q++){var Z=E[q],J=[];for(W=0;W<Z;W++){var ee=A[Q+L],ie=A[Q+O],ce=B[ie];J.push({index:ee,weight:ce}),Q+=2}for(J.sort(it),W=0;W<s;W++){var Y=J[W];Y!==void 0?(h.indices.array.push(Y.index),h.weights.array.push(Y.weight)):(h.indices.array.push(0),h.weights.array.push(0))}}for(a.bindShapeMatrix?h.bindMatrix=new THREE.Matrix4().fromArray(a.bindShapeMatrix).transpose():h.bindMatrix=new THREE.Matrix4().identity(),q=0,P=z.array.length;q<P;q++){var fe=z.array[q],U=new THREE.Matrix4().fromArray(_.array,q*_.stride).transpose();h.joints.push({name:fe,boneInverse:U})}return h;function it(Ue,Ai){return Ai.weight-Ue.weight}}function I(a){return F(V.controllers[a],M)}function N(a){var s={init_from:i(a,"init_from")[0].textContent};V.images[a.getAttribute("id")]=s}function te(a){return a.build!==void 0?a.build:a.init_from}function ue(a){var s=V.images[a];return s!==void 0?F(s,te):(console.warn("THREE.ColladaLoader: Couldn't find image with ID:",a),null)}function le(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"profile_COMMON":s.profile=de(u);break}}V.effects[a.getAttribute("id")]=s}function de(a){for(var s={surfaces:{},samplers:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"newparam":ve(u,s);break;case"technique":s.technique=Ee(u);break;case"extra":s.extra=Ke(u);break}}return s}function ve(a,s){for(var h=a.getAttribute("sid"),v=0,u=a.childNodes.length;v<u;v++){var E=a.childNodes[v];if(E.nodeType===1)switch(E.nodeName){case"surface":s.surfaces[h]=Ne(E);break;case"sampler2D":s.samplers[h]=je(E);break}}}function Ne(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"init_from":s.init_from=u.textContent;break}}return s}function je(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"source":s.source=u.textContent;break}}return s}function Ee(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"constant":case"lambert":case"blinn":case"phong":s.type=u.nodeName,s.parameters=Ze(u);break}}return s}function Ze(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":s[u.nodeName]=be(u);break;case"transparent":s[u.nodeName]={opaque:u.getAttribute("opaque"),data:be(u)};break}}return s}function be(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"color":s[u.nodeName]=c(u.textContent);break;case"float":s[u.nodeName]=parseFloat(u.textContent);break;case"texture":s[u.nodeName]={id:u.getAttribute("texture"),extra:ke(u)};break}}return s}function ke(a){for(var s={technique:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"extra":Ae(u,s);break}}return s}function Ae(a,s){for(var h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"technique":Ve(u,s);break}}}function Ve(a,s){for(var h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":s.technique[u.nodeName]=parseFloat(u.textContent);break;case"wrapU":case"wrapV":u.textContent.toUpperCase()==="TRUE"?s.technique[u.nodeName]=1:u.textContent.toUpperCase()==="FALSE"?s.technique[u.nodeName]=0:s.technique[u.nodeName]=parseInt(u.textContent);break}}}function Ke(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"technique":s.technique=Fe(u);break}}return s}function Fe(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"double_sided":s[u.nodeName]=parseInt(u.textContent);break}}return s}function Ge(a){return a}function Je(a){return F(V.effects[a],Ge)}function Ot(a){for(var s={name:a.getAttribute("name")},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"instance_effect":s.url=m(u.getAttribute("url"));break}}V.materials[a.getAttribute("id")]=s}function Dt(a){var s,h=a.slice((a.lastIndexOf(".")-1>>>0)+2);switch(h=h.toLowerCase(),h){case"tga":s=Qe;break;default:s=At}return s}function ut(a){var s=Je(a.url),h=s.profile.technique,v=s.profile.extra,u;switch(h.type){case"phong":case"blinn":u=new THREE.MeshPhongMaterial;break;case"lambert":u=new THREE.MeshLambertMaterial;break;default:u=new THREE.MeshBasicMaterial;break}u.name=a.name;function E(Q){var q=s.profile.samplers[Q.id],W=null;if(q!==void 0){var P=s.profile.surfaces[q.source];W=ue(P.init_from)}else console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),W=ue(Q.id);if(W!==null){var Z=Dt(W);if(Z!==void 0){var J=Z.load(W),ee=Q.extra;if(ee!==void 0&&ee.technique!==void 0&&w(ee.technique)===!1){var ie=ee.technique;J.wrapS=ie.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,J.wrapT=ie.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,J.offset.set(ie.offsetU||0,ie.offsetV||0),J.repeat.set(ie.repeatU||1,ie.repeatV||1)}else J.wrapS=THREE.RepeatWrapping,J.wrapT=THREE.RepeatWrapping;return J}else return console.warn("THREE.ColladaLoader: Loader for texture %s not found.",W),null}else return console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",Q.id),null}var A=h.parameters;for(var L in A){var O=A[L];switch(L){case"diffuse":O.color&&u.color.fromArray(O.color),O.texture&&(u.map=E(O.texture));break;case"specular":O.color&&u.specular&&u.specular.fromArray(O.color),O.texture&&(u.specularMap=E(O.texture));break;case"bump":O.texture&&(u.normalMap=E(O.texture));break;case"ambient":O.texture&&(u.lightMap=E(O.texture));break;case"shininess":O.float&&u.shininess&&(u.shininess=O.float);break;case"emission":O.color&&u.emissive&&u.emissive.fromArray(O.color),O.texture&&(u.emissiveMap=E(O.texture));break}}var z=A.transparent,_=A.transparency;if(_===void 0&&z&&(_={float:1}),z===void 0&&_&&(z={opaque:"A_ONE",data:{color:[1,1,1,1]}}),z&&_)if(z.data.texture)u.transparent=!0;else{var B=z.data.color;switch(z.opaque){case"A_ONE":u.opacity=B[3]*_.float;break;case"RGB_ZERO":u.opacity=1-B[0]*_.float;break;case"A_ZERO":u.opacity=1-B[3]*_.float;break;case"RGB_ONE":u.opacity=B[0]*_.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',z.opaque)}u.opacity<1&&(u.transparent=!0)}return v!==void 0&&v.technique!==void 0&&v.technique.double_sided===1&&(u.side=THREE.DoubleSide),u}function Nt(a){return F(V.materials[a],ut)}function Ft(a){for(var s={name:a.getAttribute("name")},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"optics":s.optics=Pt(u);break}}V.cameras[a.getAttribute("id")]=s}function Pt(a){for(var s=0;s<a.childNodes.length;s++){var h=a.childNodes[s];switch(h.nodeName){case"technique_common":return It(h)}}return{}}function It(a){for(var s={},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];switch(v.nodeName){case"perspective":case"orthographic":s.technique=v.nodeName,s.parameters=Bt(v);break}}return s}function Bt(a){for(var s={},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];switch(v.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":s[v.nodeName]=parseFloat(v.textContent);break}}return s}function dt(a){var s;switch(a.optics.technique){case"perspective":s=new THREE.PerspectiveCamera(a.optics.parameters.yfov,a.optics.parameters.aspect_ratio,a.optics.parameters.znear,a.optics.parameters.zfar);break;case"orthographic":var h=a.optics.parameters.ymag,v=a.optics.parameters.xmag,u=a.optics.parameters.aspect_ratio;v=v===void 0?h*u:v,h=h===void 0?v/u:h,v*=.5,h*=.5,s=new THREE.OrthographicCamera(-v,v,h,-h,a.optics.parameters.znear,a.optics.parameters.zfar);break;default:s=new THREE.PerspectiveCamera;break}return s.name=a.name,s}function zt(a){var s=V.cameras[a];return s!==void 0?F(s,dt):(console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",a),null)}function jt(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"technique_common":s=Vt(u);break}}V.lights[a.getAttribute("id")]=s}function Vt(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"directional":case"point":case"spot":case"ambient":s.technique=u.nodeName,s.parameters=Kt(u)}}return s}function Kt(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"color":var E=c(u.textContent);s.color=new THREE.Color().fromArray(E);break;case"falloff_angle":s.falloffAngle=parseFloat(u.textContent);break;case"quadratic_attenuation":var A=parseFloat(u.textContent);s.distance=A?Math.sqrt(1/A):0;break}}return s}function ft(a){var s;switch(a.technique){case"directional":s=new THREE.DirectionalLight;break;case"point":s=new THREE.PointLight;break;case"spot":s=new THREE.SpotLight;break;case"ambient":s=new THREE.AmbientLight;break}return a.parameters.color&&s.color.copy(a.parameters.color),a.parameters.distance&&(s.distance=a.parameters.distance),s}function Gt(a){var s=V.lights[a];return s!==void 0?F(s,ft):(console.warn("THREE.ColladaLoader: Couldn't find light with ID:",a),null)}function Ut(a){var s={name:a.getAttribute("name"),sources:{},vertices:{},primitives:[]},h=i(a,"mesh")[0];if(h!==void 0){for(var v=0;v<h.childNodes.length;v++){var u=h.childNodes[v];if(u.nodeType===1){var E=u.getAttribute("id");switch(u.nodeName){case"source":s.sources[E]=Ye(u);break;case"vertices":s.vertices=qt(u);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",u.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":s.primitives.push(Xt(u));break;default:console.log(u)}}}V.geometries[a.getAttribute("id")]=s}}function Ye(a){for(var s={array:[],stride:3},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"float_array":s.array=c(v.textContent);break;case"Name_array":s.array=r(v.textContent);break;case"technique_common":var u=i(v,"accessor")[0];u!==void 0&&(s.stride=parseInt(u.getAttribute("stride")));break}}return s}function qt(a){for(var s={},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];v.nodeType===1&&(s[v.getAttribute("semantic")]=m(v.getAttribute("source")))}return s}function Xt(a){for(var s={type:a.nodeName,material:a.getAttribute("material"),count:parseInt(a.getAttribute("count")),inputs:{},stride:0,hasUV:!1},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"input":var E=m(u.getAttribute("source")),A=u.getAttribute("semantic"),L=parseInt(u.getAttribute("offset")),O=parseInt(u.getAttribute("set")),z=O>0?A+O:A;s.inputs[z]={id:E,offset:L},s.stride=Math.max(s.stride,L+1),A==="TEXCOORD"&&(s.hasUV=!0);break;case"vcount":s.vcount=d(u.textContent);break;case"p":s.p=d(u.textContent);break}}return s}function Wt(a){for(var s={},h=0;h<a.length;h++){var v=a[h];s[v.type]===void 0&&(s[v.type]=[]),s[v.type].push(v)}return s}function Zt(a){for(var s=0,h=0,v=a.length;h<v;h++){var u=a[h];u.hasUV===!0&&s++}s>0&&s<a.length&&(a.uvsNeedsFix=!0)}function pt(a){var s={},h=a.sources,v=a.vertices,u=a.primitives;if(u.length===0)return{};var E=Wt(u);for(var A in E){var L=E[A];Zt(L),s[A]=Jt(L,h,v)}return s}function Jt(a,s,h){for(var v={},u={array:[],stride:0},E={array:[],stride:0},A={array:[],stride:0},L={array:[],stride:0},O={array:[],stride:0},z={array:[],stride:4},_={array:[],stride:4},B=new THREE.BufferGeometry,Q=[],q=0,W=0;W<a.length;W++){var P=a[W],Z=P.inputs,J=0;switch(P.type){case"lines":case"linestrips":J=P.count*2;break;case"triangles":J=P.count*3;break;case"polylist":for(var ee=0;ee<P.count;ee++){var ie=P.vcount[ee];switch(ie){case 3:J+=3;break;case 4:J+=6;break;default:J+=(ie-2)*3;break}}break;default:console.warn("THREE.ColladaLoader: Unknow primitive type:",P.type)}B.addGroup(q,J,W),q+=J,P.material&&Q.push(P.material);for(var ce in Z){var Y=Z[ce];switch(ce){case"VERTEX":for(var fe in h){var U=h[fe];switch(fe){case"POSITION":var it=u.array.length;if(ge(P,s[U],Y.offset,u.array),u.stride=s[U].stride,s.skinWeights&&s.skinIndices&&(ge(P,s.skinIndices,Y.offset,z.array),ge(P,s.skinWeights,Y.offset,_.array)),P.hasUV===!1&&a.uvsNeedsFix===!0)for(var J=(u.array.length-it)/u.stride,Ue=0;Ue<J;Ue++)A.array.push(0,0);break;case"NORMAL":ge(P,s[U],Y.offset,E.array),E.stride=s[U].stride;break;case"COLOR":ge(P,s[U],Y.offset,O.array),O.stride=s[U].stride;break;case"TEXCOORD":ge(P,s[U],Y.offset,A.array),A.stride=s[U].stride;break;case"TEXCOORD1":ge(P,s[U],Y.offset,L.array),A.stride=s[U].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',fe)}}break;case"NORMAL":ge(P,s[Y.id],Y.offset,E.array),E.stride=s[Y.id].stride;break;case"COLOR":ge(P,s[Y.id],Y.offset,O.array),O.stride=s[Y.id].stride;break;case"TEXCOORD":ge(P,s[Y.id],Y.offset,A.array),A.stride=s[Y.id].stride;break;case"TEXCOORD1":ge(P,s[Y.id],Y.offset,L.array),L.stride=s[Y.id].stride;break}}}return u.array.length>0&&B.addAttribute("position",new THREE.Float32BufferAttribute(u.array,u.stride)),E.array.length>0&&B.addAttribute("normal",new THREE.Float32BufferAttribute(E.array,E.stride)),O.array.length>0&&B.addAttribute("color",new THREE.Float32BufferAttribute(O.array,O.stride)),A.array.length>0&&B.addAttribute("uv",new THREE.Float32BufferAttribute(A.array,A.stride)),L.array.length>0&&B.addAttribute("uv2",new THREE.Float32BufferAttribute(L.array,L.stride)),z.array.length>0&&B.addAttribute("skinIndex",new THREE.Float32BufferAttribute(z.array,z.stride)),_.array.length>0&&B.addAttribute("skinWeight",new THREE.Float32BufferAttribute(_.array,_.stride)),v.data=B,v.type=a[0].type,v.materialKeys=Q,v}function ge(a,s,h,v){var u=a.p,E=a.stride,A=a.vcount;function L(ce){for(var Y=u[ce+h]*z,fe=Y+z;Y<fe;Y++)v.push(O[Y])}var O=s.array,z=s.stride;if(a.vcount!==void 0)for(var _=0,B=0,Q=A.length;B<Q;B++){var q=A[B];if(q===4){var W=_+E*0,P=_+E*1,Z=_+E*2,J=_+E*3;L(W),L(P),L(J),L(P),L(Z),L(J)}else if(q===3){var W=_+E*0,P=_+E*1,Z=_+E*2;L(W),L(P),L(Z)}else if(q>4)for(var ee=1,ie=q-2;ee<=ie;ee++){var W=_+E*0,P=_+E*ee,Z=_+E*(ee+1);L(W),L(P),L(Z)}_+=E*q}else for(var B=0,Q=u.length;B<Q;B+=E)L(B)}function vt(a){return F(V.geometries[a],pt)}function Yt(a){for(var s={name:a.getAttribute("name")||"",joints:{},links:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"technique_common":ei(v,s);break}}V.kinematicsModels[a.getAttribute("id")]=s}function $t(a){return a.build!==void 0?a.build:a}function Qt(a){return F(V.kinematicsModels[a],$t)}function ei(a,s){for(var h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"joint":s.joints[v.getAttribute("sid")]=ti(v);break;case"link":s.links.push(mt(v));break}}}function ti(a){for(var s,h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"prismatic":case"revolute":s=ii(v);break}}return s}function ii(a,h){for(var h={sid:a.getAttribute("sid"),name:a.getAttribute("name")||"",axis:new THREE.Vector3,limits:{min:0,max:0},type:a.nodeName,static:!1,zeroPosition:0,middlePosition:0},v=0;v<a.childNodes.length;v++){var u=a.childNodes[v];if(u.nodeType===1)switch(u.nodeName){case"axis":var E=c(u.textContent);h.axis.fromArray(E);break;case"limits":var A=u.getElementsByTagName("max")[0],L=u.getElementsByTagName("min")[0];h.limits.max=parseFloat(A.textContent),h.limits.min=parseFloat(L.textContent);break}}return h.limits.min>=h.limits.max&&(h.static=!0),h.middlePosition=(h.limits.min+h.limits.max)/2,h}function mt(a){for(var s={sid:a.getAttribute("sid"),name:a.getAttribute("name")||"",attachments:[],transforms:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"attachment_full":s.attachments.push(ni(v));break;case"matrix":case"translate":case"rotate":s.transforms.push(gt(v));break}}return s}function ni(a){for(var s={joint:a.getAttribute("joint").split("/").pop(),transforms:[],links:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"link":s.links.push(mt(v));break;case"matrix":case"translate":case"rotate":s.transforms.push(gt(v));break}}return s}function gt(a){var s={type:a.nodeName},h=c(a.textContent);switch(s.type){case"matrix":s.obj=new THREE.Matrix4,s.obj.fromArray(h).transpose();break;case"translate":s.obj=new THREE.Vector3,s.obj.fromArray(h);break;case"rotate":s.obj=new THREE.Vector3,s.obj.fromArray(h),s.angle=THREE.Math.degToRad(h[3]);break}return s}function ri(a){for(var s={name:a.getAttribute("name")||"",rigidBodies:{}},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"rigid_body":s.rigidBodies[v.getAttribute("name")]={},ai(v,s.rigidBodies[v.getAttribute("name")]);break}}V.physicsModels[a.getAttribute("id")]=s}function ai(a,s){for(var h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"technique_common":si(v,s);break}}}function si(a,s){for(var h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"inertia":s.inertia=c(v.textContent);break;case"mass":s.mass=c(v.textContent)[0];break}}}function oi(a){for(var s={bindJointAxis:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"bind_joint_axis":s.bindJointAxis.push(ci(v));break}}V.kinematicsScenes[m(a.getAttribute("url"))]=s}function ci(a){for(var s={target:a.getAttribute("target").split("/").pop()},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"axis":var u=v.getElementsByTagName("param")[0];s.axis=u.textContent;var E=s.axis.split("inst_").pop().split("axis")[0];s.jointIndex=E.substr(0,E.length-1);break}}return s}function li(a){return a.build!==void 0?a.build:a}function hi(a){return F(V.kinematicsScenes[a],li)}function ui(){var a=Object.keys(V.kinematicsModels)[0],s=Object.keys(V.kinematicsScenes)[0],h=Object.keys(V.visualScenes)[0];if(a===void 0||s===void 0)return;for(var v=Qt(a),u=hi(s),E=xt(h),A=u.bindJointAxis,L={},O=0,z=A.length;O<z;O++){var _=A[O],B=oe.querySelector('[sid="'+_.target+'"]');if(B){var Q=B.parentElement;q(_.jointIndex,Q)}}function q(P,Z){var J=Z.getAttribute("name"),ee=v.joints[P];E.traverse(function(ie){ie.name===J&&(L[P]={object:ie,transforms:di(Z),joint:ee,position:ee.zeroPosition})})}var W=new THREE.Matrix4;Rt={joints:v&&v.joints,getJointValue:function(P){var Z=L[P];if(Z)return Z.position;console.warn("THREE.ColladaLoader: Joint "+P+" doesn't exist.")},setJointValue:function(P,Z){var J=L[P];if(J){var ee=J.joint;if(Z>ee.limits.max||Z<ee.limits.min)console.warn("THREE.ColladaLoader: Joint "+P+" value "+Z+" outside of limits (min: "+ee.limits.min+", max: "+ee.limits.max+").");else if(ee.static)console.warn("THREE.ColladaLoader: Joint "+P+" is static.");else{var ie=J.object,ce=ee.axis,Y=J.transforms;pe.identity();for(var fe=0;fe<Y.length;fe++){var U=Y[fe];if(U.sid&&U.sid.indexOf(P)!==-1)switch(ee.type){case"revolute":pe.multiply(W.makeRotationAxis(ce,THREE.Math.degToRad(Z)));break;case"prismatic":pe.multiply(W.makeTranslation(ce.x*Z,ce.y*Z,ce.z*Z));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+ee.type);break}else switch(U.type){case"matrix":pe.multiply(U.obj);break;case"translate":pe.multiply(W.makeTranslation(U.obj.x,U.obj.y,U.obj.z));break;case"scale":pe.scale(U.obj);break;case"rotate":pe.multiply(W.makeRotationAxis(U.obj,U.angle));break}}ie.matrix.copy(pe),ie.matrix.decompose(ie.position,ie.quaternion,ie.scale),L[P].position=Z}}else console.log("THREE.ColladaLoader: "+P+" does not exist.")}}}function di(a){for(var s=[],h=oe.querySelector('[id="'+a.id+'"]'),v=0;v<h.childNodes.length;v++){var u=h.childNodes[v];if(u.nodeType===1)switch(u.nodeName){case"matrix":var A=c(u.textContent),E=new THREE.Matrix4().fromArray(A).transpose();s.push({sid:u.getAttribute("sid"),type:u.nodeName,obj:E});break;case"translate":case"scale":var A=c(u.textContent),L=new THREE.Vector3().fromArray(A);s.push({sid:u.getAttribute("sid"),type:u.nodeName,obj:L});break;case"rotate":var A=c(u.textContent),L=new THREE.Vector3().fromArray(A),O=THREE.Math.degToRad(A[3]);s.push({sid:u.getAttribute("sid"),type:u.nodeName,obj:L,angle:O});break}}return s}function fi(a){for(var s=a.getElementsByTagName("node"),h=0;h<s.length;h++){var v=s[h];v.hasAttribute("id")===!1&&v.setAttribute("id",b())}}var pe=new THREE.Matrix4,He=new THREE.Vector3;function $e(a){for(var s={name:a.getAttribute("name")||"",type:a.getAttribute("type"),id:a.getAttribute("id"),sid:a.getAttribute("sid"),matrix:new THREE.Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"node":s.nodes.push(v.getAttribute("id")),$e(v);break;case"instance_camera":s.instanceCameras.push(m(v.getAttribute("url")));break;case"instance_controller":s.instanceControllers.push(yt(v));break;case"instance_light":s.instanceLights.push(m(v.getAttribute("url")));break;case"instance_geometry":s.instanceGeometries.push(yt(v));break;case"instance_node":s.instanceNodes.push(m(v.getAttribute("url")));break;case"matrix":var E=c(v.textContent);s.matrix.multiply(pe.fromArray(E).transpose()),s.transforms[v.getAttribute("sid")]=v.nodeName;break;case"translate":var E=c(v.textContent);He.fromArray(E),s.matrix.multiply(pe.makeTranslation(He.x,He.y,He.z)),s.transforms[v.getAttribute("sid")]=v.nodeName;break;case"rotate":var E=c(v.textContent),u=THREE.Math.degToRad(E[3]);s.matrix.multiply(pe.makeRotationAxis(He.fromArray(E),u)),s.transforms[v.getAttribute("sid")]=v.nodeName;break;case"scale":var E=c(v.textContent);s.matrix.scale(He.fromArray(E)),s.transforms[v.getAttribute("sid")]=v.nodeName;break;case"extra":break;default:console.log(v)}}return Tt(s.id)?console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",s.id):V.nodes[s.id]=s,s}function yt(a){for(var s={id:m(a.getAttribute("url")),materials:{},skeletons:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];switch(v.nodeName){case"bind_material":for(var u=v.getElementsByTagName("instance_material"),E=0;E<u.length;E++){var A=u[E],L=A.getAttribute("symbol"),O=A.getAttribute("target");s.materials[L]=m(O)}break;case"skeleton":s.skeletons.push(m(v.textContent));break}}return s}function pi(a,s){var h=[],v=[],u,E,A;for(u=0;u<a.length;u++){var L=a[u],O;if(Tt(L))O=Oe(L),Et(O,s,h);else if(Ei(L))for(var z=V.visualScenes[L],_=z.children,E=0;E<_.length;E++){var B=_[E];if(B.type==="JOINT"){var O=Oe(B.id);Et(O,s,h)}}else console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",L)}for(u=0;u<s.length;u++)for(E=0;E<h.length;E++)if(A=h[E],A.bone.name===s[u].name){v[u]=A,A.processed=!0;break}for(u=0;u<h.length;u++)A=h[u],A.processed===!1&&(v.push(A),A.processed=!0);var Q=[],q=[];for(u=0;u<v.length;u++)A=v[u],Q.push(A.bone),q.push(A.boneInverse);return new THREE.Skeleton(Q,q)}function Et(a,s,h){a.traverse(function(v){if(v.isBone===!0){for(var u,E=0;E<s.length;E++){var A=s[E];if(A.name===v.name){u=A.boneInverse;break}}u===void 0&&(u=new THREE.Matrix4),h.push({bone:v,boneInverse:u,processed:!1})}})}function vi(a){for(var s=[],h=a.matrix,v=a.nodes,u=a.type,E=a.instanceCameras,A=a.instanceControllers,L=a.instanceLights,O=a.instanceGeometries,z=a.instanceNodes,_=0,B=v.length;_<B;_++)s.push(Oe(v[_]));for(var _=0,B=E.length;_<B;_++){var Q=zt(E[_]);Q!==null&&s.push(Q.clone())}for(var _=0,B=A.length;_<B;_++)for(var q=A[_],W=I(q.id),P=vt(W.id),Z=bt(P,q.materials),J=q.skeletons,ee=W.skin.joints,ie=pi(J,ee),ce=0,Y=Z.length;ce<Y;ce++){var U=Z[ce];U.isSkinnedMesh&&(U.bind(ie,W.skin.bindMatrix),U.normalizeSkinWeights()),s.push(U)}for(var _=0,B=L.length;_<B;_++){var fe=Gt(L[_]);fe!==null&&s.push(fe.clone())}for(var _=0,B=O.length;_<B;_++)for(var q=O[_],P=vt(q.id),Z=bt(P,q.materials),ce=0,Y=Z.length;ce<Y;ce++)s.push(Z[ce]);for(var _=0,B=z.length;_<B;_++)s.push(Oe(z[_]).clone());var U;if(v.length===0&&s.length===1)U=s[0];else{U=u==="JOINT"?new THREE.Bone:new THREE.Group;for(var _=0;_<s.length;_++)U.add(s[_])}return U.name===""&&(U.name=u==="JOINT"?a.sid:a.name),U.matrix.copy(h),U.matrix.decompose(U.position,U.quaternion,U.scale),U}var mi=new THREE.MeshBasicMaterial({color:16711935});function gi(a,s){for(var h=[],v=0,u=a.length;v<u;v++){var E=s[a[v]];E===void 0?(console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",a[v]),h.push(mi)):h.push(Nt(E))}return h}function bt(a,s){var h=[];for(var v in a){var u=a[v],E=gi(u.materialKeys,s);E.length===0&&(v==="lines"||v==="linestrips"?E.push(new THREE.LineBasicMaterial):E.push(new THREE.MeshPhongMaterial));var A=u.data.attributes.skinIndex!==void 0;if(A)for(var L=0,O=E.length;L<O;L++)E[L].skinning=!0;var z=E.length===1?E[0]:E,_;switch(v){case"lines":_=new THREE.LineSegments(u.data,z);break;case"linestrips":_=new THREE.Line(u.data,z);break;case"triangles":case"polylist":A?_=new THREE.SkinnedMesh(u.data,z):_=new THREE.Mesh(u.data,z);break}h.push(_)}return h}function Tt(a){return V.nodes[a]!==void 0}function Oe(a){return F(V.nodes[a],vi)}function yi(a){var s={name:a.getAttribute("name"),children:[]};fi(a);for(var h=i(a,"node"),v=0;v<h.length;v++)s.children.push($e(h[v]));V.visualScenes[a.getAttribute("id")]=s}function wt(a){var s=new THREE.Group;s.name=a.name;for(var h=a.children,v=0;v<h.length;v++){var u=h[v];s.add(Oe(u.id))}return s}function Ei(a){return V.visualScenes[a]!==void 0}function xt(a){return F(V.visualScenes[a],wt)}function bi(a){var s=i(a,"instance_visual_scene")[0];return xt(m(s.getAttribute("url")))}function Ti(){var a=V.clips;if(w(a)===!0){if(w(V.animations)===!1){var s=[];for(var h in V.animations)for(var v=ye(h),u=0,E=v.length;u<E;u++)s.push(v[u]);et.push(new THREE.AnimationClip("default",-1,s))}}else for(var h in a)et.push(p(h))}if(e.length===0)return{scene:new THREE.Scene};var wi=new DOMParser().parseFromString(e,"application/xml"),oe=i(wi,"COLLADA")[0],xi=oe.getAttribute("version");console.log("THREE.ColladaLoader: File version",xi);var kt=H(i(oe,"asset")[0]),At=new THREE.TextureLoader(this.manager);At.setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);var Qe;THREE.TGALoader&&(Qe=new THREE.TGALoader(this.manager),Qe.setPath(this.resourcePath||t));var et=[],Rt={},ki=0,V={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};D(oe,"library_animations","animation",re),D(oe,"library_animation_clips","animation_clip",l),D(oe,"library_controllers","controller",g),D(oe,"library_images","image",N),D(oe,"library_effects","effect",le),D(oe,"library_materials","material",Ot),D(oe,"library_cameras","camera",Ft),D(oe,"library_lights","light",jt),D(oe,"library_geometries","geometry",Ut),D(oe,"library_nodes","node",$e),D(oe,"library_visual_scenes","visual_scene",yi),D(oe,"library_kinematics_models","kinematics_model",Yt),D(oe,"library_physics_models","physics_model",ri),D(oe,"scene","instance_kinematics_scene",oi),S(V.animations,me),S(V.clips,f),S(V.controllers,M),S(V.images,te),S(V.effects,Ge),S(V.materials,ut),S(V.cameras,dt),S(V.lights,ft),S(V.geometries,pt),S(V.visualScenes,wt),Ti(),ui();var tt=bi(i(oe,"scene")[0]);return kt.upAxis==="Z_UP"&&tt.quaternion.setFromEuler(new THREE.Euler(-Math.PI/2,0,0)),tt.scale.multiplyScalar(kt.unit),{animations:et,kinematics:Rt,library:V,scene:tt}}};THREE.ColladaLoader=Xi;AFRAME.registerComponent("collada-model-legacy",{schema:{type:"asset"},init:function(){this.model=null,this.loader=new THREE.ColladaLoader},update:function(){var e=this,t=this.el,i=this.data,r=this.el.sceneEl.systems.renderer;!i||(this.remove(),this.loader.load(i,function(c){e.model=c.scene,e.model.traverse(function(d){if(d.isMesh){var m=d.material;m.color&&r.applyColorCorrection(m.color),m.map&&r.applyColorCorrection(m.map),m.emissive&&r.applyColorCorrection(m.emissive),m.emissiveMap&&r.applyColorCorrection(m.emissiveMap)}}),t.setObject3D("mesh",e.model),t.emit("model-loaded",{format:"collada",model:e.model})}))},remove:function(){!this.model||this.el.removeObject3D("mesh")}});var Wi=THREE.FBXLoader=function(){var e,t,i;function r(n){this.manager=n!==void 0?n:THREE.DefaultLoadingManager}r.prototype={constructor:r,crossOrigin:"anonymous",load:function(n,o,l,f){var p=this,g=THREE.LoaderUtils.extractUrlBase(n),y=new THREE.FileLoader(this.manager);y.setResponseType("arraybuffer"),y.load(n,function(T){try{var R=p.parse(T,g);o(R)}catch(M){setTimeout(function(){f&&f(M),p.manager.itemError(n)},0)}},l,f)},setCrossOrigin:function(n){return this.crossOrigin=n,this},parse:function(n,o){if(K(n))e=new w().parse(n);else{var l=se(n);if(!D(l))throw new Error("THREE.FBXLoader: Unknown format.");if(S(l)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+S(l));e=new b().parse(l)}var f=new THREE.TextureLoader(this.manager).setPath(o).setCrossOrigin(this.crossOrigin);return new c(f).parse(e)}};function c(n){this.textureLoader=n}c.prototype={constructor:c,parse:function(){t=this.parseConnections();var n=this.parseImages(),o=this.parseTextures(n),l=this.parseMaterials(o),f=this.parseDeformers(),p=new d().parse(f);return this.parseScene(f,p,l),i},parseConnections:function(){var n=new Map;if("Connections"in e){var o=e.Connections.connections;o.forEach(function(l){var f=l[0],p=l[1],g=l[2];n.has(f)||n.set(f,{parents:[],children:[]});var y={ID:p,relationship:g};n.get(f).parents.push(y),n.has(p)||n.set(p,{parents:[],children:[]});var T={ID:f,relationship:g};n.get(p).children.push(T)})}return n},parseImages:function(){var n={},o={};if("Video"in e.Objects){var l=e.Objects.Video;for(var f in l){var p=l[f],g=parseInt(f);if(n[g]=p.RelativeFilename||p.Filename,"Content"in p){var y=p.Content instanceof ArrayBuffer&&p.Content.byteLength>0,T=typeof p.Content=="string"&&p.Content!=="";if(y||T){var R=this.parseImage(l[f]);o[p.RelativeFilename||p.Filename]=R}}}}for(var g in n){var M=n[g];o[M]!==void 0?n[g]=o[M]:n[g]=n[g].split("\\").pop()}return n},parseImage:function(n){var o=n.Content,l=n.RelativeFilename||n.Filename,f=l.slice(l.lastIndexOf(".")+1).toLowerCase(),p;switch(f){case"bmp":p="image/bmp";break;case"jpg":case"jpeg":p="image/jpeg";break;case"png":p="image/png";break;case"tif":p="image/tiff";break;case"tga":if(typeof THREE.TGALoader!="function"){console.warn("FBXLoader: THREE.TGALoader is required to load TGA textures");return}else{THREE.Loader.Handlers.get(".tga")===null&&THREE.Loader.Handlers.add(/\.tga$/i,new THREE.TGALoader),p="image/tga";break}default:console.warn('FBXLoader: Image type "'+f+'" is not supported.');return}if(typeof o=="string")return"data:"+p+";base64,"+o;var g=new Uint8Array(o);return window.URL.createObjectURL(new Blob([g],{type:p}))},parseTextures:function(n){var o=new Map;if("Texture"in e.Objects){var l=e.Objects.Texture;for(var f in l){var p=this.parseTexture(l[f],n);o.set(parseInt(f),p)}}return o},parseTexture:function(n,o){var l=this.loadTexture(n,o);l.ID=n.id,l.name=n.attrName;var f=n.WrapModeU,p=n.WrapModeV,g=f!==void 0?f.value:0,y=p!==void 0?p.value:0;if(l.wrapS=g===0?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,l.wrapT=y===0?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,"Scaling"in n){var T=n.Scaling.value;l.repeat.x=T[0],l.repeat.y=T[1]}return l},loadTexture:function(n,o){var l,f=this.textureLoader.path,p=t.get(n.id).children;p!==void 0&&p.length>0&&o[p[0].ID]!==void 0&&(l=o[p[0].ID],(l.indexOf("blob:")===0||l.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));var g,y=n.FileName.slice(-3).toLowerCase();if(y==="tga"){var T=THREE.Loader.Handlers.get(".tga");T===null?(console.warn("FBXLoader: TGALoader not found, creating empty placeholder texture for",l),g=new THREE.Texture):g=T.load(l)}else y==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating empty placeholder texture for",l),g=new THREE.Texture):g=this.textureLoader.load(l);return this.textureLoader.setPath(f),g},parseMaterials:function(n){var o=new Map;if("Material"in e.Objects){var l=e.Objects.Material;for(var f in l){var p=this.parseMaterial(l[f],n);p!==null&&o.set(parseInt(f),p)}}return o},parseMaterial:function(n,o){var l=n.id,f=n.attrName,p=n.ShadingModel;if(typeof p=="object"&&(p=p.value),!t.has(l))return null;var g=this.parseParameters(n,o,l),y;switch(p.toLowerCase()){case"phong":y=new THREE.MeshPhongMaterial;break;case"lambert":y=new THREE.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',p),y=new THREE.MeshPhongMaterial({color:3342591});break}return y.setValues(g),y.name=f,y},parseParameters:function(n,o,l){var f={};n.BumpFactor&&(f.bumpScale=n.BumpFactor.value),n.Diffuse?f.color=new THREE.Color().fromArray(n.Diffuse.value):n.DiffuseColor&&n.DiffuseColor.type==="Color"&&(f.color=new THREE.Color().fromArray(n.DiffuseColor.value)),n.DisplacementFactor&&(f.displacementScale=n.DisplacementFactor.value),n.Emissive?f.emissive=new THREE.Color().fromArray(n.Emissive.value):n.EmissiveColor&&n.EmissiveColor.type==="Color"&&(f.emissive=new THREE.Color().fromArray(n.EmissiveColor.value)),n.EmissiveFactor&&(f.emissiveIntensity=parseFloat(n.EmissiveFactor.value)),n.Opacity&&(f.opacity=parseFloat(n.Opacity.value)),f.opacity<1&&(f.transparent=!0),n.ReflectionFactor&&(f.reflectivity=n.ReflectionFactor.value),n.Shininess&&(f.shininess=n.Shininess.value),n.Specular?f.specular=new THREE.Color().fromArray(n.Specular.value):n.SpecularColor&&n.SpecularColor.type==="Color"&&(f.specular=new THREE.Color().fromArray(n.SpecularColor.value));var p=this;return t.get(l).children.forEach(function(g){var y=g.relationship;switch(y){case"Bump":f.bumpMap=p.getTexture(o,g.ID);break;case"DiffuseColor":f.map=p.getTexture(o,g.ID);break;case"DisplacementColor":f.displacementMap=p.getTexture(o,g.ID);break;case"EmissiveColor":f.emissiveMap=p.getTexture(o,g.ID);break;case"NormalMap":f.normalMap=p.getTexture(o,g.ID);break;case"ReflectionColor":f.envMap=p.getTexture(o,g.ID),f.envMap.mapping=THREE.EquirectangularReflectionMapping;break;case"SpecularColor":f.specularMap=p.getTexture(o,g.ID);break;case"TransparentColor":f.alphaMap=p.getTexture(o,g.ID),f.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",y);break}}),f},getTexture:function(n,o){return"LayeredTexture"in e.Objects&&o in e.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),o=t.get(o).children[0].ID),n.get(o)},parseDeformers:function(){var n={},o={};if("Deformer"in e.Objects){var l=e.Objects.Deformer;for(var f in l){var p=l[f],g=t.get(parseInt(f));if(p.attrType==="Skin"){var y=this.parseSkeleton(g,l);y.ID=f,g.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),y.geometryID=g.parents[0].ID,n[f]=y}else if(p.attrType==="BlendShape"){var T={id:f};T.rawTargets=this.parseMorphTargets(g,l),T.id=f,g.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),o[f]=T}}}return{skeletons:n,morphTargets:o}},parseSkeleton:function(n,o){var l=[];return n.children.forEach(function(f){var p=o[f.ID];if(p.attrType==="Cluster"){var g={ID:f.ID,indices:[],weights:[],transform:new THREE.Matrix4().fromArray(p.Transform.a),transformLink:new THREE.Matrix4().fromArray(p.TransformLink.a),linkMode:p.Mode};"Indexes"in p&&(g.indices=p.Indexes.a,g.weights=p.Weights.a),l.push(g)}}),{rawBones:l,bones:[]}},parseMorphTargets:function(n,o){for(var l=[],f=0;f<n.children.length;f++){if(f===8){console.warn("FBXLoader: maximum of 8 morph targets supported. Ignoring additional targets.");break}var p=n.children[f],g=o[p.ID],y={name:g.attrName,initialWeight:g.DeformPercent,id:g.id,fullWeights:g.FullWeights.a};if(g.attrType!=="BlendShapeChannel")return;var T=t.get(parseInt(p.ID));T.children.forEach(function(R){R.relationship===void 0&&(y.geoID=R.ID)}),l.push(y)}return l},parseScene:function(n,o,l){i=new THREE.Group;var f=this.parseModels(n.skeletons,o,l),p=e.Objects.Model,g=this;f.forEach(function(T){var R=p[T.ID];g.setLookAtProperties(T,R);var M=t.get(T.ID).parents;M.forEach(function(k){var I=f.get(k.ID);I!==void 0&&I.add(T)}),T.parent===null&&i.add(T)}),this.bindSkeleton(n.skeletons,o,f),this.createAmbientLight(),this.setupMorphMaterials();var y=new m().parse();i.children.length===1&&i.children[0].isGroup&&(i.children[0].animations=y,i=i.children[0]),i.animations=y},parseModels:function(n,o,l){var f=new Map,p=e.Objects.Model;for(var g in p){var y=parseInt(g),T=p[g],R=t.get(y),M=this.buildSkeleton(R,n,y,T.attrName);if(!M){switch(T.attrType){case"Camera":M=this.createCamera(R);break;case"Light":M=this.createLight(R);break;case"Mesh":M=this.createMesh(R,o,l);break;case"NurbsCurve":M=this.createCurve(R,o);break;case"LimbNode":case"Null":default:M=new THREE.Group;break}M.name=THREE.PropertyBinding.sanitizeNodeName(T.attrName),M.ID=y}this.setModelTransforms(M,T),f.set(y,M)}return f},buildSkeleton:function(n,o,l,f){var p=null;return n.parents.forEach(function(g){for(var y in o){var T=o[y];T.rawBones.forEach(function(R,M){if(R.ID===g.ID){var k=p;p=new THREE.Bone,p.matrixWorld.copy(R.transformLink),p.name=THREE.PropertyBinding.sanitizeNodeName(f),p.ID=l,T.bones[M]=p,k!==null&&p.add(k)}})}}),p},createCamera:function(n){var o,l;if(n.children.forEach(function(I){var N=e.Objects.NodeAttribute[I.ID];N!==void 0&&(l=N)}),l===void 0)o=new THREE.Object3D;else{var f=0;l.CameraProjectionType!==void 0&&l.CameraProjectionType.value===1&&(f=1);var p=1;l.NearPlane!==void 0&&(p=l.NearPlane.value/1e3);var g=1e3;l.FarPlane!==void 0&&(g=l.FarPlane.value/1e3);var y=window.innerWidth,T=window.innerHeight;l.AspectWidth!==void 0&&l.AspectHeight!==void 0&&(y=l.AspectWidth.value,T=l.AspectHeight.value);var R=y/T,M=45;l.FieldOfView!==void 0&&(M=l.FieldOfView.value);var k=l.FocalLength?l.FocalLength.value:null;switch(f){case 0:o=new THREE.PerspectiveCamera(M,R,p,g),k!==null&&o.setFocalLength(k);break;case 1:o=new THREE.OrthographicCamera(-y/2,y/2,T/2,-T/2,p,g);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+f+"."),o=new THREE.Object3D;break}}return o},createLight:function(n){var o,l;if(n.children.forEach(function(k){var I=e.Objects.NodeAttribute[k.ID];I!==void 0&&(l=I)}),l===void 0)o=new THREE.Object3D;else{var f;l.LightType===void 0?f=0:f=l.LightType.value;var p=16777215;l.Color!==void 0&&(p=new THREE.Color().fromArray(l.Color.value));var g=l.Intensity===void 0?1:l.Intensity.value/100;l.CastLightOnObject!==void 0&&l.CastLightOnObject.value===0&&(g=0);var y=0;l.FarAttenuationEnd!==void 0&&(l.EnableFarAttenuation!==void 0&&l.EnableFarAttenuation.value===0?y=0:y=l.FarAttenuationEnd.value);var T=1;switch(f){case 0:o=new THREE.PointLight(p,g,y,T);break;case 1:o=new THREE.DirectionalLight(p,g);break;case 2:var R=Math.PI/3;l.InnerAngle!==void 0&&(R=THREE.Math.degToRad(l.InnerAngle.value));var M=0;l.OuterAngle!==void 0&&(M=THREE.Math.degToRad(l.OuterAngle.value),M=Math.max(M,1)),o=new THREE.SpotLight(p,g,y,R,M,T);break;default:console.warn("THREE.FBXLoader: Unknown light type "+l.LightType.value+", defaulting to a THREE.PointLight."),o=new THREE.PointLight(p,g);break}l.CastShadows!==void 0&&l.CastShadows.value===1&&(o.castShadow=!0)}return o},createMesh:function(n,o,l){var f,p=null,g=null,y=[];return n.children.forEach(function(T){o.has(T.ID)&&(p=o.get(T.ID)),l.has(T.ID)&&y.push(l.get(T.ID))}),y.length>1?g=y:y.length>0?g=y[0]:(g=new THREE.MeshPhongMaterial({color:13421772}),y.push(g)),"color"in p.attributes&&y.forEach(function(T){T.vertexColors=THREE.VertexColors}),p.FBX_Deformer?(y.forEach(function(T){T.skinning=!0}),f=new THREE.SkinnedMesh(p,g)):f=new THREE.Mesh(p,g),f},createCurve:function(n,o){var l=n.children.reduce(function(p,g){return o.has(g.ID)&&(p=o.get(g.ID)),p},null),f=new THREE.LineBasicMaterial({color:3342591,linewidth:1});return new THREE.Line(l,f)},setModelTransforms:function(n,o){var l={};"RotationOrder"in o&&(l.eulerOrder=parseInt(o.RotationOrder.value)),"Lcl_Translation"in o&&(l.translation=o.Lcl_Translation.value),"RotationOffset"in o&&(l.rotationOffset=o.RotationOffset.value),"Lcl_Rotation"in o&&(l.rotation=o.Lcl_Rotation.value),"PreRotation"in o&&(l.preRotation=o.PreRotation.value),"PostRotation"in o&&(l.postRotation=o.PostRotation.value),"Lcl_Scaling"in o&&(l.scale=o.Lcl_Scaling.value);var f=X(l);n.applyMatrix(f)},setLookAtProperties:function(n,o){if("LookAtProperty"in o){var l=t.get(n.ID).children;l.forEach(function(f){if(f.relationship==="LookAtProperty"){var p=e.Objects.Model[f.ID];if("Lcl_Translation"in p){var g=p.Lcl_Translation.value;n.target!==void 0?(n.target.position.fromArray(g),i.add(n.target)):n.lookAt(new THREE.Vector3().fromArray(g))}}})}},bindSkeleton:function(n,o,l){var f=this.parsePoseNodes();for(var p in n){var g=n[p],y=t.get(parseInt(g.ID)).parents;y.forEach(function(T){if(o.has(T.ID)){var R=T.ID,M=t.get(R);M.parents.forEach(function(k){if(l.has(k.ID)){var I=l.get(k.ID);I.bind(new THREE.Skeleton(g.bones),f[k.ID])}})}})}},parsePoseNodes:function(){var n={};if("Pose"in e.Objects){var o=e.Objects.Pose;for(var l in o)if(o[l].attrType==="BindPose"){var f=o[l].PoseNode;Array.isArray(f)?f.forEach(function(p){n[p.Node]=new THREE.Matrix4().fromArray(p.Matrix.a)}):n[f.Node]=new THREE.Matrix4().fromArray(f.Matrix.a)}}return n},createAmbientLight:function(){if("GlobalSettings"in e&&"AmbientColor"in e.GlobalSettings){var n=e.GlobalSettings.AmbientColor.value,o=n[0],l=n[1],f=n[2];if(o!==0||l!==0||f!==0){var p=new THREE.Color(o,l,f);i.add(new THREE.AmbientLight(p,1))}}},setupMorphMaterials:function(){i.traverse(function(n){if(n.isMesh&&(n.geometry.morphAttributes.position||n.geometry.morphAttributes.normal)){var o=n.uuid,l=n.material.uuid,f=!1;i.traverse(function(p){p.isMesh&&p.material.uuid===l&&p.uuid!==o&&(f=!0)}),f===!0&&(n.material=n.material.clone()),n.material.morphTargets=!0}})}};function d(){}d.prototype={constructor:d,parse:function(n){var o=new Map;if("Geometry"in e.Objects){var l=e.Objects.Geometry;for(var f in l){var p=t.get(parseInt(f)),g=this.parseGeometry(p,l[f],n);o.set(parseInt(f),g)}}return o},parseGeometry:function(n,o,l){switch(o.attrType){case"Mesh":return this.parseMeshGeometry(n,o,l);case"NurbsCurve":return this.parseNurbsGeometry(o)}},parseMeshGeometry:function(n,o,l){var f=l.skeletons,p=l.morphTargets,g=n.parents.map(function(I){return e.Objects.Model[I.ID]});if(g.length!==0){var y=n.children.reduce(function(I,N){return f[N.ID]!==void 0&&(I=f[N.ID]),I},null),T=n.children.reduce(function(I,N){return p[N.ID]!==void 0&&(I=p[N.ID]),I},null),R=g[0],M={};"RotationOrder"in R&&(M.eulerOrder=R.RotationOrder.value),"GeometricTranslation"in R&&(M.translation=R.GeometricTranslation.value),"GeometricRotation"in R&&(M.rotation=R.GeometricRotation.value),"GeometricScaling"in R&&(M.scale=R.GeometricScaling.value);var k=X(M);return this.genGeometry(o,y,T,k)}},genGeometry:function(n,o,l,f){var p=new THREE.BufferGeometry;n.attrName&&(p.name=n.attrName);var g=this.parseGeoNode(n,o),y=this.genBuffers(g),T=new THREE.Float32BufferAttribute(y.vertex,3);if(f.applyToBufferAttribute(T),p.addAttribute("position",T),y.colors.length>0&&p.addAttribute("color",new THREE.Float32BufferAttribute(y.colors,3)),o&&(p.addAttribute("skinIndex",new THREE.Uint16BufferAttribute(y.weightsIndices,4)),p.addAttribute("skinWeight",new THREE.Float32BufferAttribute(y.vertexWeights,4)),p.FBX_Deformer=o),y.normal.length>0){var R=new THREE.Float32BufferAttribute(y.normal,3),M=new THREE.Matrix3().getNormalMatrix(f);M.applyToBufferAttribute(R),p.addAttribute("normal",R)}if(y.uvs.forEach(function(ue,le){var de="uv"+(le+1).toString();le===0&&(de="uv"),p.addAttribute(de,new THREE.Float32BufferAttribute(y.uvs[le],2))}),g.material&&g.material.mappingType!=="AllSame"){var k=y.materialIndex[0],I=0;if(y.materialIndex.forEach(function(ue,le){ue!==k&&(p.addGroup(I,le-I,k),k=ue,I=le)}),p.groups.length>0){var N=p.groups[p.groups.length-1],te=N.start+N.count;te!==y.materialIndex.length&&p.addGroup(te,y.materialIndex.length-te,k)}p.groups.length===0&&p.addGroup(0,y.materialIndex.length,y.materialIndex[0])}return this.addMorphTargets(p,n,l,f),p},parseGeoNode:function(n,o){var l={};if(l.vertexPositions=n.Vertices!==void 0?n.Vertices.a:[],l.vertexIndices=n.PolygonVertexIndex!==void 0?n.PolygonVertexIndex.a:[],n.LayerElementColor&&(l.color=this.parseVertexColors(n.LayerElementColor[0])),n.LayerElementMaterial&&(l.material=this.parseMaterialIndices(n.LayerElementMaterial[0])),n.LayerElementNormal&&(l.normal=this.parseNormals(n.LayerElementNormal[0])),n.LayerElementUV){l.uv=[];for(var f=0;n.LayerElementUV[f];)l.uv.push(this.parseUVs(n.LayerElementUV[f])),f++}return l.weightTable={},o!==null&&(l.skeleton=o,o.rawBones.forEach(function(p,g){p.indices.forEach(function(y,T){l.weightTable[y]===void 0&&(l.weightTable[y]=[]),l.weightTable[y].push({id:g,weight:p.weights[T]})})})),l},genBuffers:function(n){var o={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]},l=0,f=0,p=!1,g=[],y=[],T=[],R=[],M=[],k=[],I=this;return n.vertexIndices.forEach(function(N,te){var ue=!1;N<0&&(N=N^-1,ue=!0);var le=[],de=[];if(g.push(N*3,N*3+1,N*3+2),n.color){var ve=he(te,l,N,n.color);T.push(ve[0],ve[1],ve[2])}if(n.skeleton){if(n.weightTable[N]!==void 0&&n.weightTable[N].forEach(function(be){de.push(be.weight),le.push(be.id)}),de.length>4){p||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),p=!0);var Ne=[0,0,0,0],je=[0,0,0,0];de.forEach(function(be,ke){var Ae=be,Ve=le[ke];je.forEach(function(Ke,Fe,Ge){if(Ae>Ke){Ge[Fe]=Ae,Ae=Ke;var Je=Ne[Fe];Ne[Fe]=Ve,Ve=Je}})}),le=Ne,de=je}for(;de.length<4;)de.push(0),le.push(0);for(var Ee=0;Ee<4;++Ee)M.push(de[Ee]),k.push(le[Ee])}if(n.normal){var ve=he(te,l,N,n.normal);y.push(ve[0],ve[1],ve[2])}if(n.material&&n.material.mappingType!=="AllSame")var Ze=he(te,l,N,n.material)[0];n.uv&&n.uv.forEach(function(be,ke){var Ae=he(te,l,N,be);R[ke]===void 0&&(R[ke]=[]),R[ke].push(Ae[0]),R[ke].push(Ae[1])}),f++,ue&&(I.genFace(o,n,g,Ze,y,T,R,M,k,f),l++,f=0,g=[],y=[],T=[],R=[],M=[],k=[])}),o},genFace:function(n,o,l,f,p,g,y,T,R,M){for(var k=2;k<M;k++)n.vertex.push(o.vertexPositions[l[0]]),n.vertex.push(o.vertexPositions[l[1]]),n.vertex.push(o.vertexPositions[l[2]]),n.vertex.push(o.vertexPositions[l[(k-1)*3]]),n.vertex.push(o.vertexPositions[l[(k-1)*3+1]]),n.vertex.push(o.vertexPositions[l[(k-1)*3+2]]),n.vertex.push(o.vertexPositions[l[k*3]]),n.vertex.push(o.vertexPositions[l[k*3+1]]),n.vertex.push(o.vertexPositions[l[k*3+2]]),o.skeleton&&(n.vertexWeights.push(T[0]),n.vertexWeights.push(T[1]),n.vertexWeights.push(T[2]),n.vertexWeights.push(T[3]),n.vertexWeights.push(T[(k-1)*4]),n.vertexWeights.push(T[(k-1)*4+1]),n.vertexWeights.push(T[(k-1)*4+2]),n.vertexWeights.push(T[(k-1)*4+3]),n.vertexWeights.push(T[k*4]),n.vertexWeights.push(T[k*4+1]),n.vertexWeights.push(T[k*4+2]),n.vertexWeights.push(T[k*4+3]),n.weightsIndices.push(R[0]),n.weightsIndices.push(R[1]),n.weightsIndices.push(R[2]),n.weightsIndices.push(R[3]),n.weightsIndices.push(R[(k-1)*4]),n.weightsIndices.push(R[(k-1)*4+1]),n.weightsIndices.push(R[(k-1)*4+2]),n.weightsIndices.push(R[(k-1)*4+3]),n.weightsIndices.push(R[k*4]),n.weightsIndices.push(R[k*4+1]),n.weightsIndices.push(R[k*4+2]),n.weightsIndices.push(R[k*4+3])),o.color&&(n.colors.push(g[0]),n.colors.push(g[1]),n.colors.push(g[2]),n.colors.push(g[(k-1)*3]),n.colors.push(g[(k-1)*3+1]),n.colors.push(g[(k-1)*3+2]),n.colors.push(g[k*3]),n.colors.push(g[k*3+1]),n.colors.push(g[k*3+2])),o.material&&o.material.mappingType!=="AllSame"&&(n.materialIndex.push(f),n.materialIndex.push(f),n.materialIndex.push(f)),o.normal&&(n.normal.push(p[0]),n.normal.push(p[1]),n.normal.push(p[2]),n.normal.push(p[(k-1)*3]),n.normal.push(p[(k-1)*3+1]),n.normal.push(p[(k-1)*3+2]),n.normal.push(p[k*3]),n.normal.push(p[k*3+1]),n.normal.push(p[k*3+2])),o.uv&&o.uv.forEach(function(I,N){n.uvs[N]===void 0&&(n.uvs[N]=[]),n.uvs[N].push(y[N][0]),n.uvs[N].push(y[N][1]),n.uvs[N].push(y[N][(k-1)*2]),n.uvs[N].push(y[N][(k-1)*2+1]),n.uvs[N].push(y[N][k*2]),n.uvs[N].push(y[N][k*2+1])})},addMorphTargets:function(n,o,l,f){if(l!==null){n.morphAttributes.position=[],n.morphAttributes.normal=[];var p=this;l.rawTargets.forEach(function(g){var y=e.Objects.Geometry[g.geoID];y!==void 0&&p.genMorphGeometry(n,o,y,f)})}},genMorphGeometry:function(n,o,l,f){var p=new THREE.BufferGeometry;l.attrName&&(p.name=l.attrName);for(var g=o.PolygonVertexIndex!==void 0?o.PolygonVertexIndex.a:[],y=o.Vertices!==void 0?o.Vertices.a.slice():[],T=l.Vertices!==void 0?l.Vertices.a:[],R=l.Indexes!==void 0?l.Indexes.a:[],M=0;M<R.length;M++){var k=R[M]*3;y[k]+=T[M*3],y[k+1]+=T[M*3+1],y[k+2]+=T[M*3+2]}var I={vertexIndices:g,vertexPositions:y},N=this.genBuffers(I),te=new THREE.Float32BufferAttribute(N.vertex,3);te.name=l.attrName,f.applyToBufferAttribute(te),n.morphAttributes.position.push(te)},parseNormals:function(n){var o=n.MappingInformationType,l=n.ReferenceInformationType,f=n.Normals.a,p=[];return l==="IndexToDirect"&&("NormalIndex"in n?p=n.NormalIndex.a:"NormalsIndex"in n&&(p=n.NormalsIndex.a)),{dataSize:3,buffer:f,indices:p,mappingType:o,referenceType:l}},parseUVs:function(n){var o=n.MappingInformationType,l=n.ReferenceInformationType,f=n.UV.a,p=[];return l==="IndexToDirect"&&(p=n.UVIndex.a),{dataSize:2,buffer:f,indices:p,mappingType:o,referenceType:l}},parseVertexColors:function(n){var o=n.MappingInformationType,l=n.ReferenceInformationType,f=n.Colors.a,p=[];return l==="IndexToDirect"&&(p=n.ColorIndex.a),{dataSize:4,buffer:f,indices:p,mappingType:o,referenceType:l}},parseMaterialIndices:function(n){var o=n.MappingInformationType,l=n.ReferenceInformationType;if(o==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:l};for(var f=n.Materials.a,p=[],g=0;g<f.length;++g)p.push(g);return{dataSize:1,buffer:f,indices:p,mappingType:o,referenceType:l}},parseNurbsGeometry:function(n){if(THREE.NURBSCurve===void 0)return console.error("THREE.FBXLoader: The loader relies on THREE.NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new THREE.BufferGeometry;var o=parseInt(n.Order);if(isNaN(o))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",n.Order,n.id),new THREE.BufferGeometry;for(var l=o-1,f=n.KnotVector.a,p=[],g=n.Points.a,y=0,T=g.length;y<T;y+=4)p.push(new THREE.Vector4().fromArray(g,y));var R,M;if(n.Form==="Closed")p.push(p[0]);else if(n.Form==="Periodic"){R=l,M=f.length-1-R;for(var y=0;y<l;++y)p.push(p[y])}var k=new THREE.NURBSCurve(l,f,p,R,M),I=k.getPoints(p.length*7),N=new Float32Array(I.length*3);I.forEach(function(ue,le){ue.toArray(N,le*3)});var te=new THREE.BufferGeometry;return te.addAttribute("position",new THREE.BufferAttribute(N,3)),te}};function m(){}m.prototype={constructor:m,parse:function(){var n=[],o=this.parseClips();if(o===void 0)return n;for(var l in o){var f=o[l],p=this.addClip(f);n.push(p)}return n},parseClips:function(){if(e.Objects.AnimationCurve!==void 0){var n=this.parseAnimationCurveNodes();this.parseAnimationCurves(n);var o=this.parseAnimationLayers(n),l=this.parseAnimStacks(o);return l}},parseAnimationCurveNodes:function(){var n=e.Objects.AnimationCurveNode,o=new Map;for(var l in n){var f=n[l];if(f.attrName.match(/S|R|T|DeformPercent/)!==null){var p={id:f.id,attr:f.attrName,curves:{}};o.set(p.id,p)}}return o},parseAnimationCurves:function(n){var o=e.Objects.AnimationCurve;for(var l in o){var f={id:o[l].id,times:o[l].KeyTime.a.map(F),values:o[l].KeyValueFloat.a},p=t.get(f.id);if(p!==void 0){var g=p.parents[0].ID,y=p.parents[0].relationship;y.match(/X/)?n.get(g).curves.x=f:y.match(/Y/)?n.get(g).curves.y=f:y.match(/Z/)?n.get(g).curves.z=f:y.match(/d|DeformPercent/)&&n.has(g)&&(n.get(g).curves.morph=f)}}},parseAnimationLayers:function(n){var o=e.Objects.AnimationLayer,l=new Map;for(var f in o){var p=[],g=t.get(parseInt(f));if(g!==void 0){var y=g.children,T=this;y.forEach(function(R,M){if(n.has(R.ID)){var k=n.get(R.ID);if(k.curves.x!==void 0||k.curves.y!==void 0||k.curves.z!==void 0){if(p[M]===void 0){var I;t.get(R.ID).parents.forEach(function(ve){ve.relationship!==void 0&&(I=ve.ID)});var N=e.Objects.Model[I.toString()],te={modelName:THREE.PropertyBinding.sanitizeNodeName(N.attrName),initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1],transform:T.getModelAnimTransform(N)};"PreRotation"in N&&(te.preRotations=N.PreRotation.value),"PostRotation"in N&&(te.postRotations=N.PostRotation.value),p[M]=te}p[M][k.attr]=k}else if(k.curves.morph!==void 0){if(p[M]===void 0){var ue;t.get(R.ID).parents.forEach(function(Ee){Ee.relationship!==void 0&&(ue=Ee.ID)});var le=t.get(ue).parents[0].ID,de=t.get(le).parents[0].ID,I=t.get(de).parents[0].ID,N=e.Objects.Model[I],te={modelName:THREE.PropertyBinding.sanitizeNodeName(N.attrName),morphName:e.Objects.Deformer[ue].attrName};p[M]=te}p[M][k.attr]=k}}}),l.set(parseInt(f),p)}}return l},getModelAnimTransform:function(n){var o={};return"RotationOrder"in n&&(o.eulerOrder=parseInt(n.RotationOrder.value)),"Lcl_Translation"in n&&(o.translation=n.Lcl_Translation.value),"RotationOffset"in n&&(o.rotationOffset=n.RotationOffset.value),"Lcl_Rotation"in n&&(o.rotation=n.Lcl_Rotation.value),"PreRotation"in n&&(o.preRotation=n.PreRotation.value),"PostRotation"in n&&(o.postRotation=n.PostRotation.value),"Lcl_Scaling"in n&&(o.scale=n.Lcl_Scaling.value),X(o)},parseAnimStacks:function(n){var o=e.Objects.AnimationStack,l={};for(var f in o){var p=t.get(parseInt(f)).children;p.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var g=n.get(p[0].ID);l[f]={name:o[f].attrName,layer:g}}return l},addClip:function(n){var o=[],l=this;return n.layer.forEach(function(f){o=o.concat(l.generateTracks(f))}),new THREE.AnimationClip(n.name,-1,o)},generateTracks:function(n){var o=[],l=new THREE.Vector3,f=new THREE.Quaternion,p=new THREE.Vector3;if(n.transform&&n.transform.decompose(l,f,p),l=l.toArray(),f=new THREE.Euler().setFromQuaternion(f).toArray(),p=p.toArray(),n.T!==void 0&&Object.keys(n.T.curves).length>0){var g=this.generateVectorTrack(n.modelName,n.T.curves,l,"position");g!==void 0&&o.push(g)}if(n.R!==void 0&&Object.keys(n.R.curves).length>0){var y=this.generateRotationTrack(n.modelName,n.R.curves,f,n.preRotations,n.postRotations);y!==void 0&&o.push(y)}if(n.S!==void 0&&Object.keys(n.S.curves).length>0){var T=this.generateVectorTrack(n.modelName,n.S.curves,p,"scale");T!==void 0&&o.push(T)}if(n.DeformPercent!==void 0){var R=this.generateMorphTrack(n);R!==void 0&&o.push(R)}return o},generateVectorTrack:function(n,o,l,f){var p=this.getTimesForAllAxes(o),g=this.getKeyframeTrackValues(p,o,l);return new THREE.VectorKeyframeTrack(n+"."+f,p,g)},generateRotationTrack:function(n,o,l,f,p){o.x!==void 0&&(this.interpolateRotations(o.x),o.x.values=o.x.values.map(THREE.Math.degToRad)),o.y!==void 0&&(this.interpolateRotations(o.y),o.y.values=o.y.values.map(THREE.Math.degToRad)),o.z!==void 0&&(this.interpolateRotations(o.z),o.z.values=o.z.values.map(THREE.Math.degToRad));var g=this.getTimesForAllAxes(o),y=this.getKeyframeTrackValues(g,o,l);f!==void 0&&(f=f.map(THREE.Math.degToRad),f.push("ZYX"),f=new THREE.Euler().fromArray(f),f=new THREE.Quaternion().setFromEuler(f)),p!==void 0&&(p=p.map(THREE.Math.degToRad),p.push("ZYX"),p=new THREE.Euler().fromArray(p),p=new THREE.Quaternion().setFromEuler(p).inverse());for(var T=new THREE.Quaternion,R=new THREE.Euler,M=[],k=0;k<y.length;k+=3)R.set(y[k],y[k+1],y[k+2],"ZYX"),T.setFromEuler(R),f!==void 0&&T.premultiply(f),p!==void 0&&T.multiply(p),T.toArray(M,k/3*4);return new THREE.QuaternionKeyframeTrack(n+".quaternion",g,M)},generateMorphTrack:function(n){var o=n.DeformPercent.curves.morph,l=o.values.map(function(p){return p/100}),f=i.getObjectByName(n.modelName).morphTargetDictionary[n.morphName];return new THREE.NumberKeyframeTrack(n.modelName+".morphTargetInfluences["+f+"]",o.times,l)},getTimesForAllAxes:function(n){var o=[];return n.x!==void 0&&(o=o.concat(n.x.times)),n.y!==void 0&&(o=o.concat(n.y.times)),n.z!==void 0&&(o=o.concat(n.z.times)),o=o.sort(function(l,f){return l-f}).filter(function(l,f,p){return p.indexOf(l)==f}),o},getKeyframeTrackValues:function(n,o,l){var f=l,p=[],g=-1,y=-1,T=-1;return n.forEach(function(R){if(o.x&&(g=o.x.times.indexOf(R)),o.y&&(y=o.y.times.indexOf(R)),o.z&&(T=o.z.times.indexOf(R)),g!==-1){var M=o.x.values[g];p.push(M),f[0]=M}else p.push(f[0]);if(y!==-1){var k=o.y.values[y];p.push(k),f[1]=k}else p.push(f[1]);if(T!==-1){var I=o.z.values[T];p.push(I),f[2]=I}else p.push(f[2])}),p},interpolateRotations:function(n){for(var o=1;o<n.values.length;o++){var l=n.values[o-1],f=n.values[o]-l,p=Math.abs(f);if(p>=180){for(var g=p/180,y=f/g,T=l+y,R=n.times[o-1],M=n.times[o]-R,k=M/g,I=R+k,N=[],te=[];I<n.times[o];)N.push(I),I+=k,te.push(T),T+=y;n.times=ze(n.times,o,N),n.values=ze(n.values,o,te)}}}};function b(){}b.prototype={constructor:b,getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(n){this.nodeStack.push(n),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(n,o){this.currentProp=n,this.currentPropName=o},parse:function(n){this.currentIndent=0,console.log("FBXTree: ",C),this.allNodes=new C,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var o=this,l=n.split(/[\r\n]+/);return l.forEach(function(f,p){var g=f.match(/^[\s\t]*;/),y=f.match(/^[\s\t]*$/);if(!(g||y)){var T=f.match("^\\t{"+o.currentIndent+"}(\\w+):(.*){",""),R=f.match("^\\t{"+o.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),M=f.match("^\\t{"+(o.currentIndent-1)+"}}");T?o.parseNodeBegin(f,T):R?o.parseNodeProperty(f,R,l[++p]):M?o.popStack():f.match(/^[^\s\t}]/)&&o.parseNodePropertyContinued(f)}}),this.allNodes},parseNodeBegin:function(n,o){var l=o[1].trim().replace(/^"/,"").replace(/"$/,""),f=o[2].split(",").map(function(T){return T.trim().replace(/^"/,"").replace(/"$/,"")}),p={name:l},g=this.parseNodeAttr(f),y=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(l,p):l in y?(l==="PoseNode"?y.PoseNode.push(p):y[l].id!==void 0&&(y[l]={},y[l][y[l].id]=y[l]),g.id!==""&&(y[l][g.id]=p)):typeof g.id=="number"?(y[l]={},y[l][g.id]=p):l!=="Properties70"&&(l==="PoseNode"?y[l]=[p]:y[l]=p),typeof g.id=="number"&&(p.id=g.id),g.name!==""&&(p.attrName=g.name),g.type!==""&&(p.attrType=g.type),this.pushStack(p)},parseNodeAttr:function(n){var o=n[0];n[0]!==""&&(o=parseInt(n[0]),isNaN(o)&&(o=n[0]));var l="",f="";return n.length>1&&(l=n[1].replace(/^(\w+)::/,""),f=n[2]),{id:o,name:l,type:f}},parseNodeProperty:function(n,o,l){var f=o[1].replace(/^"/,"").replace(/"$/,"").trim(),p=o[2].replace(/^"/,"").replace(/"$/,"").trim();f==="Content"&&p===","&&(p=l.replace(/"/g,"").replace(/,$/,"").trim());var g=this.getCurrentNode(),y=g.name;if(y==="Properties70"){this.parseNodeSpecialProperty(n,f,p);return}if(f==="C"){var T=p.split(",").slice(1),R=parseInt(T[0]),M=parseInt(T[1]),k=p.split(",").slice(3);k=k.map(function(I){return I.trim().replace(/^"/,"")}),f="connections",p=[R,M],Xe(p,k),g[f]===void 0&&(g[f]=[])}f==="Node"&&(g.id=p),f in g&&Array.isArray(g[f])?g[f].push(p):f!=="a"?g[f]=p:g.a=p,this.setCurrentProp(g,f),f==="a"&&p.slice(-1)!==","&&(g.a=ae(p))},parseNodePropertyContinued:function(n){var o=this.getCurrentNode();o.a+=n,n.slice(-1)!==","&&(o.a=ae(o.a))},parseNodeSpecialProperty:function(n,o,l){var f=l.split('",').map(function(M){return M.trim().replace(/^\"/,"").replace(/\s/,"_")}),p=f[0],g=f[1],y=f[2],T=f[3],R=f[4];switch(g){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":R=parseFloat(R);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":R=ae(R);break}this.getPrevNode()[p]={type:g,type2:y,flag:T,value:R},this.setCurrentProp(this.getPrevNode(),p)}};function w(){}w.prototype={constructor:w,parse:function(n){var o=new H(n);o.skip(23);var l=o.getUint32();console.log("THREE.FBXLoader: FBX binary version: "+l);for(var f=new C;!this.endOfContent(o);){var p=this.parseNode(o,l);p!==null&&f.add(p.name,p)}return f},endOfContent:function(n){return n.size()%16===0?(n.getOffset()+160+16&-16)>=n.size():n.getOffset()+160+16>=n.size()},parseNode:function(n,o){var l={},f=o>=7500?n.getUint64():n.getUint32(),p=o>=7500?n.getUint64():n.getUint32();o>=7500?n.getUint64():n.getUint32();var g=n.getUint8(),y=n.getString(g);if(f===0)return null;for(var T=[],R=0;R<p;R++)T.push(this.parseProperty(n));var M=T.length>0?T[0]:"",k=T.length>1?T[1]:"",I=T.length>2?T[2]:"";for(l.singleProperty=p===1&&n.getOffset()===f;f>n.getOffset();){var N=this.parseNode(n,o);N!==null&&this.parseSubNode(y,l,N)}return l.propertyList=T,typeof M=="number"&&(l.id=M),k!==""&&(l.attrName=k),I!==""&&(l.attrType=I),y!==""&&(l.name=y),l},parseSubNode:function(n,o,l){if(l.singleProperty===!0){var f=l.propertyList[0];Array.isArray(f)?(o[l.name]=l,l.a=f):o[l.name]=f}else if(n==="Connections"&&l.name==="C"){var p=[];l.propertyList.forEach(function(I,N){N!==0&&p.push(I)}),o.connections===void 0&&(o.connections=[]),o.connections.push(p)}else if(l.name==="Properties70"){var g=Object.keys(l);g.forEach(function(I){o[I]=l[I]})}else if(n==="Properties70"&&l.name==="P"){var y=l.propertyList[0],T=l.propertyList[1],R=l.propertyList[2],M=l.propertyList[3],k;y.indexOf("Lcl ")===0&&(y=y.replace("Lcl ","Lcl_")),T.indexOf("Lcl ")===0&&(T=T.replace("Lcl ","Lcl_")),T==="Color"||T==="ColorRGB"||T==="Vector"||T==="Vector3D"||T.indexOf("Lcl_")===0?k=[l.propertyList[4],l.propertyList[5],l.propertyList[6]]:k=l.propertyList[4],o[y]={type:T,type2:R,flag:M,value:k}}else o[l.name]===void 0?typeof l.id=="number"?(o[l.name]={},o[l.name][l.id]=l):o[l.name]=l:l.name==="PoseNode"?(Array.isArray(o[l.name])||(o[l.name]=[o[l.name]]),o[l.name].push(l)):o[l.name][l.id]===void 0&&(o[l.name][l.id]=l)},parseProperty:function(n){var o=n.getString(1);switch(o){case"C":return n.getBoolean();case"D":return n.getFloat64();case"F":return n.getFloat32();case"I":return n.getInt32();case"L":return n.getInt64();case"R":var l=n.getUint32();return n.getArrayBuffer(l);case"S":var l=n.getUint32();return n.getString(l);case"Y":return n.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var f=n.getUint32(),p=n.getUint32(),g=n.getUint32();if(p===0)switch(o){case"b":case"c":return n.getBooleanArray(f);case"d":return n.getFloat64Array(f);case"f":return n.getFloat32Array(f);case"i":return n.getInt32Array(f);case"l":return n.getInt64Array(f)}typeof Zlib=="undefined"&&console.error("THREE.FBXLoader: External library Inflate.min.js required, obtain or import from https://github.com/imaya/zlib.js");var y=new Zlib.Inflate(new Uint8Array(n.getArrayBuffer(g))),T=new H(y.decompress().buffer);switch(o){case"b":case"c":return T.getBooleanArray(f);case"d":return T.getFloat64Array(f);case"f":return T.getFloat32Array(f);case"i":return T.getInt32Array(f);case"l":return T.getInt64Array(f)}default:throw new Error("THREE.FBXLoader: Unknown property type "+o)}}};function H(n,o){this.dv=new DataView(n),this.offset=0,this.littleEndian=o!==void 0?o:!0}H.prototype={constructor:H,getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(n){this.offset+=n},getBoolean:function(){return(this.getUint8()&1)===1},getBooleanArray:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getBoolean());return o},getUint8:function(){var n=this.dv.getUint8(this.offset);return this.offset+=1,n},getInt16:function(){var n=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,n},getInt32:function(){var n=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,n},getInt32Array:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getInt32());return o},getUint32:function(){var n=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,n},getInt64:function(){var n,o;return this.littleEndian?(n=this.getUint32(),o=this.getUint32()):(o=this.getUint32(),n=this.getUint32()),o&2147483648?(o=~o&4294967295,n=~n&4294967295,n===4294967295&&(o=o+1&4294967295),n=n+1&4294967295,-(o*4294967296+n)):o*4294967296+n},getInt64Array:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getInt64());return o},getUint64:function(){var n,o;return this.littleEndian?(n=this.getUint32(),o=this.getUint32()):(o=this.getUint32(),n=this.getUint32()),o*4294967296+n},getFloat32:function(){var n=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,n},getFloat32Array:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getFloat32());return o},getFloat64:function(){var n=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,n},getFloat64Array:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getFloat64());return o},getArrayBuffer:function(n){var o=this.dv.buffer.slice(this.offset,this.offset+n);return this.offset+=n,o},getString:function(n){for(var o=[],l=0;l<n;l++)o[l]=this.getUint8();var f=o.indexOf(0);return f>=0&&(o=o.slice(0,f)),THREE.LoaderUtils.decodeText(new Uint8Array(o))}};function C(){}C.prototype={constructor:C,add:function(n,o){this[n]=o}};function K(n){var o="Kaydara FBX Binary  \0";return n.byteLength>=o.length&&o===se(n,0,o.length)}function D(n){var o=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],l=0;function f(y){var T=n[y-1];return n=n.slice(l+y),l++,T}for(var p=0;p<o.length;++p){var g=f(1);if(g===o[p])return!1}return!0}function S(n){var o=/FBXVersion: (\d+)/,l=n.match(o);if(l){var f=parseInt(l[1]);return f}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function F(n){return n/46186158e3}var re=[];function he(n,o,l,f){var p;switch(f.mappingType){case"ByPolygonVertex":p=n;break;case"ByPolygon":p=o;break;case"ByVertice":p=l;break;case"AllSame":p=f.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+f.mappingType)}f.referenceType==="IndexToDirect"&&(p=f.indices[p]);var g=p*f.dataSize,y=g+f.dataSize;return We(re,f.buffer,g,y)}var ne=new THREE.Matrix4,me=new THREE.Euler,ye=new THREE.Vector3,xe=new THREE.Vector3,j=new THREE.Matrix4;function X(n){var o=new THREE.Matrix4;xe.set(0,0,0),j.identity();var l=n.eulerOrder?G(n.eulerOrder):G(0);if(n.translation&&xe.fromArray(n.translation),n.rotationOffset&&xe.add(ye.fromArray(n.rotationOffset)),n.rotation){var f=n.rotation.map(THREE.Math.degToRad);f.push(l),j.makeRotationFromEuler(me.fromArray(f))}if(n.preRotation){var f=n.preRotation.map(THREE.Math.degToRad);f.push(l),ne.makeRotationFromEuler(me.fromArray(f)),j.premultiply(ne)}if(n.postRotation){var f=n.postRotation.map(THREE.Math.degToRad);f.push(l),ne.makeRotationFromEuler(me.fromArray(f)),ne.getInverse(ne),j.multiply(ne)}return n.scale&&o.scale(ye.fromArray(n.scale)),o.setPosition(xe),o.multiply(j),o}function G(n){var o=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return n===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),o[0]):o[n]}function ae(n){var o=n.split(",").map(function(l){return parseFloat(l)});return o}function se(n,o,l){return o===void 0&&(o=0),l===void 0&&(l=n.byteLength),THREE.LoaderUtils.decodeText(new Uint8Array(n,o,l))}function Xe(n,o){for(var l=0,f=n.length,p=o.length;l<p;l++,f++)n[f]=o[l]}function We(n,o,l,f){for(var p=l,g=0;p<f;p++,g++)n[g]=o[p];return n}function ze(n,o,l){return n.slice(0,o).concat(l).concat(n.slice(o))}return r}();THREE.FBXLoader=Wi;AFRAME.registerComponent("fbx-model",{schema:{src:{type:"asset"},crossorigin:{default:""}},init:function(){this.model=null},update:function(){const e=this.data;if(!e.src)return;this.remove();const t=new THREE.FBXLoader;e.crossorigin&&t.setCrossOrigin(e.crossorigin),t.load(e.src,this.load.bind(this))},load:function(e){this.model=e,this.el.setObject3D("mesh",e),this.el.emit("model-loaded",{format:"fbx",model:e})},remove:function(){this.model&&this.el.removeObject3D("mesh")}});function Zi(){return"script_"+Date.now()+"_"+Math.ceil(Math.random()*1e5)}function Ji(e,t){var i=document.createElement("script");return i.type="text/javascript",i.async=!0,i.id=t,i.src=e,i}function at(e){const t=document.getElementById(e),i=t.parentNode;try{i&&i.removeChild(t)}catch{}}function Yi(e){const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}function $i(e,t,i){return new i(function(r,c){const d=t.timeout||5e3,m=Zi(),b=Ji(e,m),w=setTimeout(function(){c(new Error("Script request to "+e+" timed out")),at(m)},d),H=function(C){clearTimeout(C)};b.addEventListener("load",function(C){r({ok:!0}),H(w),at(m)}),b.addEventListener("error",function(C){c(new Error("Script request to "+e+" failed "+C)),H(w),at(m)}),Yi(b)})}function Qi(e){return e=e||{},function(t,i){return i=i||{},$i(t,i,e.Promise||Promise)}}var en=Qi;const tn=en(),nn="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r86/examples/js/loaders/GLTFLoader.js",rn=function(){let e;return function(){return e=e||tn(nn),e}}();AFRAME.registerComponent("gltf-model-legacy",{schema:{type:"model"},init:function(){this.model=null,this.loader=null,this.loaderPromise=rn().then(()=>{this.loader=new THREE.GLTFLoader,this.loader.setCrossOrigin("Anonymous")})},update:function(){const e=this,t=this.el,i=this.data;!i||(this.remove(),this.loaderPromise.then(()=>{this.loader.load(i,function(c){e.model=c.scene,e.model.animations=c.animations,t.setObject3D("mesh",e.model),t.emit("model-loaded",{format:"gltf",model:e.model})})}))},remove:function(){!this.model||this.el.removeObject3D("mesh")}});AFRAME.registerComponent("object-model",{schema:{src:{type:"asset"},crossorigin:{default:""}},init:function(){this.model=null},update:function(){let e;const t=this.data;!t.src||(this.remove(),e=new THREE.ObjectLoader,t.crossorigin&&e.setCrossOrigin(t.crossorigin),e.load(t.src,i=>{i.traverse(r=>{r instanceof THREE.SkinnedMesh&&r.material&&(r.material.skinning=!!(r.geometry&&r.geometry.bones||[]).length)}),this.load(i)}))},load:function(e){this.model=e,this.el.setObject3D("mesh",e),this.el.emit("model-loaded",{format:"json",model:e})},remove:function(){this.model&&this.el.removeObject3D("mesh")}});AFRAME.registerComponent("checkpoint",{schema:{offset:{default:{x:0,y:0,z:0},type:"vec3"}},init:function(){this.active=!1,this.targetEl=null,this.fire=this.fire.bind(this),this.offset=new THREE.Vector3},update:function(){this.offset.copy(this.data.offset)},play:function(){this.el.addEventListener("click",this.fire)},pause:function(){this.el.removeEventListener("click",this.fire)},remove:function(){this.pause()},fire:function(){const e=this.el.sceneEl.querySelector("[checkpoint-controls]");if(!e)throw new Error("No `checkpoint-controls` component found.");e.components["checkpoint-controls"].setCheckpoint(this.el)},getOffset:function(){return this.offset.copy(this.data.offset)}});function an(e){return e?Array.isArray(e)?e:e.materials?e.materials:[e]:[]}function Pe(e,t,i,r){!e||(t=t||[],e.traverse(c=>{if(!c.isMesh)return;an(c.material).forEach(m=>{m&&!("envMap"in m)||t.length&&t.indexOf(m.name)===-1||(m.envMap=i,m.reflectivity=r,m.needsUpdate=!0)})}))}AFRAME.registerComponent("cube-env-map",{multiple:!0,schema:{path:{default:""},extension:{default:"jpg",oneOf:["jpg","png"]},format:{default:"RGBFormat",oneOf:["RGBFormat","RGBAFormat"]},enableBackground:{default:!1},reflectivity:{default:1,min:0,max:1},materials:{default:[]}},init:function(){const e=this.data;this.texture=new THREE.CubeTextureLoader().load([e.path+"posx."+e.extension,e.path+"negx."+e.extension,e.path+"posy."+e.extension,e.path+"negy."+e.extension,e.path+"posz."+e.extension,e.path+"negz."+e.extension]),this.texture.format=THREE[e.format],this.object3dsetHandler=()=>{const t=this.el.getObject3D("mesh"),i=this.data;Pe(t,i.materials,this.texture,i.reflectivity)},this.el.addEventListener("object3dset",this.object3dsetHandler)},update:function(e){const t=this.data,i=this.el.getObject3D("mesh");let r=[],c=[];if(t.materials.length&&(e.materials?(r=t.materials.filter(d=>!e.materials.includes(d)),c=e.materials.filter(d=>!t.materials.includes(d))):r=t.materials),r.length&&Pe(i,r,this.texture,t.reflectivity),c.length&&Pe(i,c,null,1),e.materials&&t.reflectivity!==e.reflectivity){const d=t.materials.filter(m=>e.materials.includes(m));d.length&&Pe(i,d,this.texture,t.reflectivity)}this.data.enableBackground&&!e.enableBackground?this.setBackground(this.texture):!this.data.enableBackground&&e.enableBackground&&this.setBackground(null)},remove:function(){this.el.removeEventListener("object3dset",this.object3dsetHandler);const e=this.el.getObject3D("mesh"),t=this.data;Pe(e,t.materials,null,1),t.enableBackground&&this.setBackground(null)},setBackground:function(e){this.el.sceneEl.object3D.background=e}});AFRAME.registerComponent("grab",{init:function(){this.system=this.el.sceneEl.systems.physics,this.GRABBED_STATE="grabbed",this.grabbing=!1,this.hitEl=null,this.physics=this.el.sceneEl.systems.physics,this.constraint=null,this.onHit=this.onHit.bind(this),this.onGripOpen=this.onGripOpen.bind(this),this.onGripClose=this.onGripClose.bind(this)},play:function(){const e=this.el;e.addEventListener("hit",this.onHit),e.addEventListener("gripdown",this.onGripClose),e.addEventListener("gripup",this.onGripOpen),e.addEventListener("trackpaddown",this.onGripClose),e.addEventListener("trackpadup",this.onGripOpen),e.addEventListener("triggerdown",this.onGripClose),e.addEventListener("triggerup",this.onGripOpen)},pause:function(){const e=this.el;e.removeEventListener("hit",this.onHit),e.removeEventListener("gripdown",this.onGripClose),e.removeEventListener("gripup",this.onGripOpen),e.removeEventListener("trackpaddown",this.onGripClose),e.removeEventListener("trackpadup",this.onGripOpen),e.removeEventListener("triggerdown",this.onGripClose),e.removeEventListener("triggerup",this.onGripOpen)},onGripClose:function(){this.grabbing=!0},onGripOpen:function(){const e=this.hitEl;this.grabbing=!1,e&&(e.removeState(this.GRABBED_STATE),this.hitEl=void 0,this.system.removeConstraint(this.constraint),this.constraint=null)},onHit:function(e){const t=e.detail.el;!t||t.is(this.GRABBED_STATE)||!this.grabbing||this.hitEl||(t.addState(this.GRABBED_STATE),this.hitEl=t,this.constraint=new CANNON.LockConstraint(this.el.body,t.body),this.system.addConstraint(this.constraint))}});const sn=-9.8,on=-15;AFRAME.registerComponent("jump-ability",{dependencies:["velocity"],schema:{on:{default:"keydown:Space gamepadbuttondown:0"},playerHeight:{default:1.764},maxJumps:{default:1},distance:{default:5},debug:{default:!1}},init:function(){this.velocity=0,this.numJumps=0;const e=this.beginJump.bind(this),t=this.data.on.split(" ");this.bindings={};for(let i=0;i<t.length;i++)this.bindings[t[i]]=e,this.el.addEventListener(t[i],e);this.bindings.collide=this.onCollide.bind(this),this.el.addEventListener("collide",this.bindings.collide)},remove:function(){for(var e in this.bindings)this.bindings.hasOwnProperty(e)&&(this.el.removeEventListener(e,this.bindings[e]),delete this.bindings[e]);this.el.removeEventListener("collide",this.bindings.collide),delete this.bindings.collide},beginJump:function(){if(this.numJumps<this.data.maxJumps){const e=this.data,t=Math.sqrt(-2*e.distance*(sn+on)),i=this.el.getAttribute("velocity");this.el.setAttribute("velocity",{x:i.x,y:t,z:i.z}),this.numJumps++,this.el.emit("jumpstart")}},onCollide:function(){this.numJumps>0&&this.el.emit("jumpend"),this.numJumps=0}});const St=1e-6;AFRAME.registerComponent("kinematic-body",{dependencies:["velocity"],schema:{mass:{default:5},radius:{default:1.3},linearDamping:{default:.05},enableSlopes:{default:!0},enableJumps:{default:!1}},init:function(){this.system=this.el.sceneEl.systems.physics,this.system.addComponent(this);const e=this.el,t=this.data,i=new CANNON.Vec3().copy(e.object3D.getWorldPosition(new THREE.Vector3));this.body=new CANNON.Body({material:this.system.getMaterial("staticMaterial"),position:i,mass:t.mass,linearDamping:t.linearDamping,fixedRotation:!0}),this.body.addShape(new CANNON.Sphere(t.radius),new CANNON.Vec3(0,t.radius,0)),this.body.el=this.el,this.el.body=this.body,this.system.addBody(this.body),e.hasAttribute("wasd-controls")&&console.warn("[kinematic-body] Not compatible with wasd-controls, use movement-controls.")},remove:function(){this.system.removeBody(this.body),this.system.removeComponent(this),delete this.el.body},beforeStep:function(e,t){if(!t)return;const i=this.el,r=this.data,c=this.body;r.enableJumps||c.velocity.set(0,0,0),c.position.copy(i.getAttribute("position"))},step:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3,r=new THREE.Vector3;return function(c,d){if(!d)return;let m=this.body,b=this.data,w=!1,H,C=-1/0,K,D=this.system.getContacts();d=Math.min(d,this.system.data.maxInterval*1e3),r.set(0,0,0),e.copy(this.el.getAttribute("velocity")),m.velocity.copy(e);for(var S=0,F;F=D[S];S++)if(!!F.enabled){if(m.id===F.bi.id)F.ni.negate(i);else if(m.id===F.bj.id)i.copy(F.ni);else continue;w=m.velocity.dot(i)<-St,w&&i.y<=.5?e.projectOnPlane(i):i.y>.5&&(H=m.id===F.bi.id?Math.abs(F.rj.y+F.bj.position.y):Math.abs(F.ri.y+F.bi.position.y),H>C&&(C=H,r.copy(i),K=m.id===F.bi.id?F.bj:F.bi))}t.copy(e).normalize(),K&&(!b.enableJumps||t.y<.5)?(b.enableSlopes?r.y<1-St&&r.copy(this.raycastToGround(K,r)):r.set(0,1,0),e.projectOnPlane(r)):this.system.driver.world&&e.add(this.system.driver.world.gravity.scale(d*4/1e3)),m.velocity.copy(e),this.el.setAttribute("velocity",m.velocity),this.el.setAttribute("position",m.position)}}(),raycastToGround:function(e,t){let i,r,c=this.body.position,d=this.body.position.clone();return i=new CANNON.Ray(c,d),i._updateDirection(),i.intersectBody(e),i.hasHit?(r=i.result.hitNormalWorld,Math.abs(r.y)>Math.abs(t.y)?r:t):t}});AFRAME.registerComponent("mesh-smooth",{init:function(){this.el.addEventListener("model-loaded",e=>{e.detail.model.traverse(t=>{t.isMesh&&t.geometry.computeVertexNormals()})})}});AFRAME.registerComponent("normal-material",{init:function(){this.material=new THREE.MeshNormalMaterial({flatShading:!0}),this.applyMaterial=this.applyMaterial.bind(this),this.el.addEventListener("object3dset",this.applyMaterial)},remove:function(){this.el.removeEventListener("object3dset",this.applyMaterial)},applyMaterial:function(){this.el.object3D.traverse(e=>{e.isMesh&&(e.material=this.material)})}});AFRAME.registerComponent("sphere-collider",{schema:{objects:{default:""},state:{default:"collided"},radius:{default:.05},watch:{default:!0}},init:function(){this.observer=null,this.els=[],this.collisions=[],this.handleHit=this.handleHit.bind(this),this.handleHitEnd=this.handleHitEnd.bind(this)},remove:function(){this.pause()},play:function(){const e=this.el.sceneEl;this.data.watch&&(this.observer=new MutationObserver(this.update.bind(this,null)),this.observer.observe(e,{childList:!0,subtree:!0}))},pause:function(){this.observer&&(this.observer.disconnect(),this.observer=null)},update:function(){const e=this.data;let t;e.objects?t=this.el.sceneEl.querySelectorAll(e.objects):t=this.el.sceneEl.children,this.els=Array.prototype.slice.call(t)},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3,r=new THREE.Vector3,c=new THREE.Box3,d=new Map;return function(){const m=this.el,b=this.data,w=m.getObject3D("mesh"),H=[];let C;if(!w)return;d.clear(),m.object3D.getWorldPosition(e),m.object3D.getWorldScale(i),C=b.radius*D(i),this.els.forEach(K),H.sort((S,F)=>d.get(S)>d.get(F)?1:-1).forEach(this.handleHit),H.length===0&&m.emit("hit",{el:null}),this.collisions.filter(S=>!d.has(S)).forEach(this.handleHitEnd),this.collisions=H;function K(S){let F,re,he,ne;!S.isEntity||(re=S.getObject3D("mesh"),re&&(c.setFromObject(re).getSize(r),ne=Math.max(r.x,r.y,r.z)/2,F=Math.sqrt(2*ne*ne),c.getCenter(t),F&&(he=e.distanceTo(t),he<F+C&&(H.push(S),d.set(S,he)))))}function D(S){return Math.max.apply(null,S.toArray())}}}(),handleHit:function(e){e.emit("hit"),e.addState(this.data.state),this.el.emit("hit",{el:e})},handleHitEnd:function(e){e.emit("hitend"),e.removeState(this.data.state),this.el.emit("hitend",{el:e})}});AFRAME.registerComponent("nav-mesh",{init:function(){this.system=this.el.sceneEl.systems.nav,this.hasLoadedNavMesh=!1,this.el.addEventListener("object3dset",this.loadNavMesh.bind(this))},play:function(){this.hasLoadedNavMesh||this.loadNavMesh()},loadNavMesh:function(){const e=this.el.getObject3D("mesh"),t=this.el.sceneEl.object3D;if(!e)return;let i;if(e.traverse(c=>{c.isMesh&&(i=c)}),!i)return;const r=i.geometry.isBufferGeometry?new THREE.Geometry().fromBufferGeometry(i.geometry):i.geometry.clone();t.updateMatrixWorld(),r.applyMatrix(i.matrixWorld),this.system.setNavMeshGeometry(r),this.hasLoadedNavMesh=!0}});AFRAME.registerComponent("nav-agent",{schema:{destination:{type:"vec3"},active:{default:!1},speed:{default:2}},init:function(){this.system=this.el.sceneEl.systems.nav,this.system.addAgent(this),this.group=null,this.path=[],this.raycaster=new THREE.Raycaster},remove:function(){this.system.removeAgent(this)},update:function(){this.path.length=0},updateNavLocation:function(){this.group=null,this.path=[]},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3;return function(r,c){const d=this.el,m=this.data,b=this.raycaster,w=m.speed*c/1e3;if(!m.active)return;if(!this.path.length){const F=this.el.object3D.position;this.group=this.group||this.system.getGroup(F),this.path=this.system.getPath(F,e.copy(m.destination),this.group)||[],d.emit("navigation-start")}if(!this.path.length){console.warn("[nav] Unable to find path to %o.",m.destination),this.el.setAttribute("nav-agent",{active:!1}),d.emit("navigation-end");return}const H=d.object3D.position,C=this.path[0];t.subVectors(C,H);const K=t.length();let D;if(K<w){if(this.path.shift(),!this.path.length){this.el.setAttribute("nav-agent",{active:!1}),d.emit("navigation-end");return}i.copy(H),D=this.path[0]}else i.copy(t.setLength(w)).add(H),D=C;D.y=H.y,d.object3D.lookAt(D),b.ray.origin.copy(i),b.ray.origin.y+=1.5,b.ray.direction.y=-1;const S=b.intersectObject(this.system.getNavMesh());S.length?(t.subVectors(S[0].point,H),H.add(t.setLength(w))):H.copy(i)}}()});var $=function(){};$.computeCentroids=function(e){var t,i,r;for(t=0,i=e.faces.length;t<i;t++)(r=e.faces[t]).centroid=new THREE.Vector3(0,0,0),r.centroid.add(e.vertices[r.a]),r.centroid.add(e.vertices[r.b]),r.centroid.add(e.vertices[r.c]),r.centroid.divideScalar(3)},$.roundNumber=function(e,t){return Number(e.toFixed(t))},$.sample=function(e){return e[Math.floor(Math.random()*e.length)]},$.mergeVertexIds=function(e,t){var i=[];if(e.forEach(function(w){t.indexOf(w)>=0&&i.push(w)}),i.length<2)return[];i.includes(e[0])&&i.includes(e[e.length-1])&&e.push(e.shift()),i.includes(t[0])&&i.includes(t[t.length-1])&&t.push(t.shift()),i=[],e.forEach(function(w){t.includes(w)&&i.push(w)});for(var r=i[1],c=i[0],d=e.slice();d[0]!==r;)d.push(d.shift());for(var m=0,b=t.slice();b[0]!==c;)if(b.push(b.shift()),m++>10)throw new Error("Unexpected state");return b.shift(),b.pop(),d=d.concat(b)},$.setPolygonCentroid=function(e,t){var i=new THREE.Vector3,r=t.vertices;e.vertexIds.forEach(function(c){i.add(r[c])}),i.divideScalar(e.vertexIds.length),e.centroid.copy(i)},$.cleanPolygon=function(e,t){for(var i=[],r=t.vertices,c=0;c<e.vertexIds.length;c++){var d,m,b,w=r[e.vertexIds[c]];c===0?(d=e.vertexIds[1],m=e.vertexIds[e.vertexIds.length-1]):c===e.vertexIds.length-1?(d=e.vertexIds[0],m=e.vertexIds[e.vertexIds.length-2]):(d=e.vertexIds[c+1],m=e.vertexIds[c-1]),b=r[m];var H=r[d].clone().sub(w),C=b.clone().sub(w),K=H.angleTo(C);if(K>Math.PI-.01&&K<Math.PI+.01){var D=[];e.neighbours.forEach(function(S){S.vertexIds.includes(e.vertexIds[c])||D.push(S)}),e.neighbours=D}else i.push(e.vertexIds[c])}e.vertexIds=i,this.setPolygonCentroid(e,t)},$.isConvex=function(e,t){var i=t.vertices;if(e.vertexIds.length<3)return!1;for(var r=!0,c=[],d=0;d<e.vertexIds.length;d++){var m,b,w=i[e.vertexIds[d]];d===0?(m=i[e.vertexIds[1]],b=i[e.vertexIds[e.vertexIds.length-1]]):d===e.vertexIds.length-1?(m=i[e.vertexIds[0]],b=i[e.vertexIds[e.vertexIds.length-2]]):(m=i[e.vertexIds[d+1]],b=i[e.vertexIds[d-1]]);var H=m.clone().sub(w),C=b.clone().sub(w),K=H.angleTo(C);if(K===Math.PI||K===0)return!1;var D=H.cross(C).y;c.push(D)}return c.forEach(function(S){S===0&&(r=!1)}),c.forEach(c[0]>0?function(S){S<0&&(r=!1)}:function(S){S>0&&(r=!1)}),r},$.distanceToSquared=function(e,t){var i=e.x-t.x,r=e.y-t.y,c=e.z-t.z;return i*i+r*r+c*c},$.isPointInPoly=function(e,t){for(var i=!1,r=-1,c=e.length,d=c-1;++r<c;d=r)(e[r].z<=t.z&&t.z<e[d].z||e[d].z<=t.z&&t.z<e[r].z)&&t.x<(e[d].x-e[r].x)*(t.z-e[r].z)/(e[d].z-e[r].z)+e[r].x&&(i=!i);return i},$.isVectorInPolygon=function(e,t,i){var r=1e5,c=-1e5,d=[];return t.vertexIds.forEach(function(m){r=Math.min(i[m].y,r),c=Math.max(i[m].y,c),d.push(i[m])}),!!(e.y<c+.5&&e.y>r-.5&&this.isPointInPoly(d,e))},$.triarea2=function(e,t,i){return(i.x-e.x)*(t.z-e.z)-(t.x-e.x)*(i.z-e.z)},$.vequal=function(e,t){return this.distanceToSquared(e,t)<1e-5};var Ce=function(e){this.content=[],this.scoreFunction=e};Ce.prototype.push=function(e){this.content.push(e),this.sinkDown(this.content.length-1)},Ce.prototype.pop=function(){var e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e},Ce.prototype.remove=function(e){var t=this.content.indexOf(e),i=this.content.pop();t!==this.content.length-1&&(this.content[t]=i,this.scoreFunction(i)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))},Ce.prototype.size=function(){return this.content.length},Ce.prototype.rescoreElement=function(e){this.sinkDown(this.content.indexOf(e))},Ce.prototype.sinkDown=function(e){for(var t=this.content[e];e>0;){var i=(e+1>>1)-1,r=this.content[i];if(!(this.scoreFunction(t)<this.scoreFunction(r)))break;this.content[i]=t,this.content[e]=r,e=i}},Ce.prototype.bubbleUp=function(e){for(var t=this.content.length,i=this.content[e],r=this.scoreFunction(i);;){var c=e+1<<1,d=c-1,m=null,b=void 0;if(d<t&&(b=this.scoreFunction(this.content[d]))<r&&(m=d),c<t&&this.scoreFunction(this.content[c])<(m===null?r:b)&&(m=c),m===null)break;this.content[e]=this.content[m],this.content[m]=i,e=m}};var Le=function(){};Le.init=function(e){for(var t=0;t<e.length;t++){var i=e[t];i.f=0,i.g=0,i.h=0,i.cost=1,i.visited=!1,i.closed=!1,i.parent=null}},Le.cleanUp=function(e){for(var t=0;t<e.length;t++){var i=e[t];delete i.f,delete i.g,delete i.h,delete i.cost,delete i.visited,delete i.closed,delete i.parent}},Le.heap=function(){return new Ce(function(e){return e.f})},Le.search=function(e,t,i){this.init(e);var r=this.heap();for(r.push(t);r.size()>0;){var c=r.pop();if(c===i){for(var d=c,m=[];d.parent;)m.push(d),d=d.parent;return this.cleanUp(m),m.reverse()}c.closed=!0;for(var b=this.neighbours(e,c),w=0,H=b.length;w<H;w++){var C=b[w];if(!C.closed){var K=c.g+C.cost,D=C.visited;if(!D||K<C.g){if(C.visited=!0,C.parent=c,!C.centroid||!i.centroid)throw new Error("Unexpected state");C.h=C.h||this.heuristic(C.centroid,i.centroid),C.g=K,C.f=C.g+C.h,D?r.rescoreElement(C):r.push(C)}}}}return[]},Le.heuristic=function(e,t){return $.distanceToSquared(e,t)},Le.neighbours=function(e,t){for(var i=[],r=0;r<t.neighbours.length;r++)i.push(e[t.neighbours[r]]);return i};var cn=1,_e=function(){};_e.buildZone=function(e){var t=this,i=this._buildNavigationMesh(e),r={};i.vertices.forEach(function(m){m.x=$.roundNumber(m.x,2),m.y=$.roundNumber(m.y,2),m.z=$.roundNumber(m.z,2)}),r.vertices=i.vertices;var c=this._buildPolygonGroups(i);r.groups=[];var d=function(m,b){for(var w=0;w<m.length;w++)if(b===m[w])return w};return c.forEach(function(m){var b=[];m.forEach(function(w){var H=w.neighbours.map(function(K){return d(m,K)}),C=w.neighbours.map(function(K){return t._getSharedVerticesInOrder(w,K)});w.centroid.x=$.roundNumber(w.centroid.x,2),w.centroid.y=$.roundNumber(w.centroid.y,2),w.centroid.z=$.roundNumber(w.centroid.z,2),b.push({id:d(m,w),neighbours:H,vertexIds:w.vertexIds,centroid:w.centroid,portals:C})}),r.groups.push(b)}),r},_e._buildNavigationMesh=function(e){return $.computeCentroids(e),e.mergeVertices(),this._buildPolygonsFromGeometry(e)},_e._buildPolygonGroups=function(e){var t=[],i=0,r=function(c){c.neighbours.forEach(function(d){d.group===void 0&&(d.group=c.group,r(d))})};return e.polygons.forEach(function(c){c.group===void 0&&(c.group=i++,r(c)),t[c.group]||(t[c.group]=[]),t[c.group].push(c)}),t},_e._buildPolygonNeighbours=function(e,t,i){var r=new Set,c=i.get(e.vertexIds[0]),d=i.get(e.vertexIds[1]),m=i.get(e.vertexIds[2]);c.forEach(function(b){(d.has(b)||m.has(b))&&r.add(t.polygons[b])}),d.forEach(function(b){m.has(b)&&r.add(t.polygons[b])}),e.neighbours=Array.from(r)},_e._buildPolygonsFromGeometry=function(e){for(var t=this,i=[],r=e.vertices,c=e.faceVertexUvs,d=new Map,m=0;m<r.length;m++)d.set(m,new Set);e.faces.forEach(function(w){i.push({id:cn++,vertexIds:[w.a,w.b,w.c],centroid:w.centroid,normal:w.normal,neighbours:[]}),d.get(w.a).add(i.length-1),d.get(w.b).add(i.length-1),d.get(w.c).add(i.length-1)});var b={polygons:i,vertices:r,faceVertexUvs:c};return i.forEach(function(w){t._buildPolygonNeighbours(w,b,d)}),b},_e._getSharedVerticesInOrder=function(e,t){var i=e.vertexIds,r=t.vertexIds,c=new Set;if(i.forEach(function(m){r.includes(m)&&c.add(m)}),c.size<2)return[];c.has(i[0])&&c.has(i[i.length-1])&&i.push(i.shift()),c.has(r[0])&&c.has(r[r.length-1])&&r.push(r.shift());var d=[];return i.forEach(function(m){r.includes(m)&&d.push(m)}),d};var ht=function(){this.portals=[]};ht.prototype.push=function(e,t){t===void 0&&(t=e),this.portals.push({left:e,right:t})},ht.prototype.stringPull=function(){var e,t,i,r=this.portals,c=[],d=0,m=0,b=0;t=r[0].left,i=r[0].right,c.push(e=r[0].left);for(var w=1;w<r.length;w++){var H=r[w].left,C=r[w].right;if($.triarea2(e,i,C)<=0){if(!($.vequal(e,i)||$.triarea2(e,t,C)>0)){c.push(t),t=e=t,i=e,m=d=m,b=d,w=d;continue}i=C,b=w}if($.triarea2(e,t,H)>=0){if(!($.vequal(e,t)||$.triarea2(e,i,H)<0)){c.push(i),t=e=i,i=e,m=d=b,b=d,w=d;continue}t=H,m=w}}return c.length!==0&&$.vequal(c[c.length-1],r[r.length-1].left)||c.push(r[r.length-1].left),this.path=c,c};var st,ot,Se,ct,lt,qe,Me=function(){this.zones={}};Me.createZone=function(e){return _e.buildZone(e)},Me.prototype.setZoneData=function(e,t){this.zones[e]=t},Me.prototype.getGroup=function(e,t){if(!this.zones[e])return null;var i=null,r=Math.pow(50,2);return this.zones[e].groups.forEach(function(c,d){c.forEach(function(m){var b=$.distanceToSquared(m.centroid,t);b<r&&(i=d,r=b)})}),i},Me.prototype.getRandomNode=function(e,t,i,r){if(!this.zones[e])return new THREE.Vector3;i=i||null,r=r||0;var c=[];return this.zones[e].groups[t].forEach(function(d){i&&r?$.distanceToSquared(i,d.centroid)<r*r&&c.push(d.centroid):c.push(d.centroid)}),$.sample(c)||new THREE.Vector3},Me.prototype.getClosestNode=function(e,t,i,r){r===void 0&&(r=!1);var c=this.zones[t].vertices,d=null,m=1/0;return this.zones[t].groups[i].forEach(function(b){var w=$.distanceToSquared(b.centroid,e);w<m&&(!r||$.isVectorInPolygon(e,b,c))&&(d=b,m=w)}),d},Me.prototype.findPath=function(e,t,i,r){var c=this.zones[i].groups[r],d=this.zones[i].vertices,m=this.getClosestNode(e,i,r),b=this.getClosestNode(t,i,r,!0);if(!m||!b)return null;var w=Le.search(c,m,b),H=function(re,he){for(var ne=0;ne<re.neighbours.length;ne++)if(re.neighbours[ne]===he.id)return re.portals[ne]},C=new ht;C.push(e);for(var K=0;K<w.length;K++){var D=w[K+1];if(D){var S=H(w[K],D);C.push(d[S[0]],d[S[1]])}}C.push(t),C.stringPull();var F=C.path.map(function(re){return new THREE.Vector3(re.x,re.y,re.z)});return F.shift(),F},Me.prototype.clampStep=(Se=new THREE.Vector3,ct=new THREE.Plane,lt=new THREE.Triangle,qe=new THREE.Vector3,function(e,t,i,r,c,d){var m=this.zones[r].vertices,b=this.zones[r].groups[c],w=[i],H={};H[i.id]=0,st=void 0,qe.set(0,0,0),ot=1/0,ct.setFromCoplanarPoints(m[i.vertexIds[0]],m[i.vertexIds[1]],m[i.vertexIds[2]]),ct.projectPoint(t,Se),t.copy(Se);for(var C=w.pop();C;C=w.pop()){lt.set(m[C.vertexIds[0]],m[C.vertexIds[1]],m[C.vertexIds[2]]),lt.closestPointToPoint(t,Se),Se.distanceToSquared(t)<ot&&(st=C,qe.copy(Se),ot=Se.distanceToSquared(t));var K=H[C];if(!(K>2))for(var D=0;D<C.neighbours.length;D++){var S=b[C.neighbours[D]];S.id in H||(w.push(S),H[S.id]=K+1)}}return d.copy(qe),st});var ln=Object.freeze(Object.defineProperty({__proto__:null,Pathfinding:Me},Symbol.toStringTag,{value:"Module"})),hn=Pi(ln);const{Pathfinding:_t}=hn,Ie=new _t,Be="level";AFRAME.registerSystem("nav",{init:function(){this.navMesh=null,this.agents=new Set},setNavMeshGeometry:function(e){this.navMesh=new THREE.Mesh(e),Ie.setZoneData(Be,_t.createZone(e)),Array.from(this.agents).forEach(t=>t.updateNavLocation())},getNavMesh:function(){return this.navMesh},addAgent:function(e){this.agents.add(e)},removeAgent:function(e){this.agents.delete(e)},getPath:function(e,t,i){return this.navMesh?Ie.findPath(e,t,Be,i):null},getGroup:function(e){return this.navMesh?Ie.getGroup(Be,e):null},getNode:function(e,t){return this.navMesh?Ie.getClosestNode(e,Be,t,!0):null},clampStep:function(e,t,i,r,c){if(this.navMesh){if(!r)return c.copy(t),this.getNode(t,i)}else return c.copy(t),null;return Ie.clampStep(e,t,r,Be,i,c)}});AFRAME.registerPrimitive("a-grid",{defaultComponents:{geometry:{primitive:"plane",width:75,height:75},rotation:{x:-90,y:0,z:0},material:{src:"url(https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v1.16.3/assets/grid.png)",repeat:"75 75"}},mappings:{width:"geometry.width",height:"geometry.height",src:"material.src"}});var Ht={exports:{}},x=Ht.exports={VERSION:"0.1.1",PI:Math.PI,TAU:2*Math.PI,DEG_TO_RAD:.0174532925,RAD_TO_DEG:57.2957795,SQRT3:Math.sqrt(3),TILE:"tile",ENT:"entity",STR:"structure",HEX:"hex",SQR:"square",ABS:"abstract"};x.Board=function(e,t){if(!e)throw new Error("You must pass in a grid system for the board to use.");this.tiles=[],this.tileGroup=null,this.group=new THREE.Object3D,this.grid=null,this.overlay=null,this.finder=new x.AStarFinder(t),x.Loader.init(),this.setGrid(e)},x.Board.prototype={setEntityOnTile:function(e,t){var i=this.grid.cellToPixel(t.cell);e.position.copy(i),e.position.y+=e.heightOffset||0,e.tile&&(e.tile.entity=null),e.tile=t,t.entity=e},addTile:function(e){var t=this.tiles.indexOf(e);t===-1&&(this.tiles.push(e),this.snapTileToGrid(e),e.position.y=0,this.tileGroup.add(e.mesh),this.grid.add(e.cell),e.cell.tile=e)},removeTile:function(e){if(e){var t=this.tiles.indexOf(e);this.grid.remove(e.cell),t!==-1&&this.tiles.splice(t,1),e.dispose()}},removeAllTiles:function(){if(this.tileGroup)for(var e=this.tileGroup.children,t=0;t<e.length;t++)this.tileGroup.remove(e[t])},getTileAtCell:function(e){var t=this.grid.cellToHash(e);return e.tile||(typeof this.grid.cells[t]!="undefined"?this.grid.cells[t].tile:null)},snapToGrid:function(e){var t=this.grid.pixelToCell(e);e.copy(this.grid.cellToPixel(t))},snapTileToGrid:function(e){if(e.cell)e.position.copy(this.grid.cellToPixel(e.cell));else{var t=this.grid.pixelToCell(e.position);e.position.copy(this.grid.cellToPixel(t))}return e},getRandomTile:function(){var e=x.Tools.randomInt(0,this.tiles.length-1);return this.tiles[e]},findPath:function(e,t,i){return this.finder.findPath(e.cell,t.cell,i,this.grid)},setGrid:function(e){this.group.remove(this.tileGroup),this.grid&&e!==this.grid&&(this.removeAllTiles(),this.tiles.forEach(function(t){this.grid.remove(t.cell),t.dispose()}),this.grid.dispose()),this.grid=e,this.tiles=[],this.tileGroup=new THREE.Object3D,this.group.add(this.tileGroup)},generateOverlay:function(e){var t=new THREE.LineBasicMaterial({color:0,opacity:.3});this.overlay&&this.group.remove(this.overlay),this.overlay=new THREE.Object3D,this.grid.generateOverlay(e,this.overlay,t),this.group.add(this.overlay)},generateTilemap:function(e){this.reset();var t=this.grid.generateTiles(e);this.tiles=t,this.tileGroup=new THREE.Object3D;for(var i=0;i<t.length;i++)this.tileGroup.add(t[i].mesh);this.group.add(this.tileGroup)},reset:function(){this.removeAllTiles(),this.tileGroup&&this.group.remove(this.tileGroup)}},x.Board.prototype.constructor=x.Board,x.Cell=function(e,t,i,r){this.q=e||0,this.r=t||0,this.s=i||0,this.h=r||1,this.tile=null,this.userData={},this.walkable=!0,this._calcCost=0,this._priority=0,this._visited=!1,this._parent=null,this.uniqueID=x.LinkedList.generateID()},x.Cell.prototype={set:function(e,t,i){return this.q=e,this.r=t,this.s=i,this},copy:function(e){return this.q=e.q,this.r=e.r,this.s=e.s,this.h=e.h,this.tile=e.tile||null,this.userData=e.userData||{},this.walkable=e.walkable,this},add:function(e){return this.q+=e.q,this.r+=e.r,this.s+=e.s,this},equals:function(e){return this.q===e.q&&this.r===e.r&&this.s===e.s}},x.Cell.prototype.constructor=x.Cell,x.HexGrid=function(e){e=e||{},this.type=x.HEX,this.size=5,this.cellSize=typeof e.cellSize=="undefined"?10:e.cellSize,this.cells={},this.numCells=0,this.extrudeSettings=null,this.autogenerated=!1;var t,i=[];for(t=0;6>t;t++)i.push(this._createVertex(t));for(this.cellShape=new THREE.Shape,this.cellShape.moveTo(i[0].x,i[0].y),t=1;6>t;t++)this.cellShape.lineTo(i[t].x,i[t].y);this.cellShape.lineTo(i[0].x,i[0].y),this.cellShape.autoClose=!0,this.cellGeo=new THREE.Geometry,this.cellGeo.vertices=i,this.cellGeo.verticesNeedUpdate=!0,this.cellShapeGeo=new THREE.ShapeGeometry(this.cellShape),this._cellWidth=2*this.cellSize,this._cellLength=.5*x.SQRT3*this._cellWidth,this._hashDelimeter=".",this._directions=[new x.Cell(1,-1,0),new x.Cell(1,0,-1),new x.Cell(0,1,-1),new x.Cell(-1,1,0),new x.Cell(-1,0,1),new x.Cell(0,-1,1)],this._diagonals=[new x.Cell(2,-1,-1),new x.Cell(1,1,-2),new x.Cell(-1,2,-1),new x.Cell(-2,1,1),new x.Cell(-1,-1,2),new x.Cell(1,-2,1)],this._list=[],this._vec3=new THREE.Vector3,this._cel=new x.Cell,this._conversionVec=new THREE.Vector3,this._geoCache=[],this._matCache=[]},x.HexGrid.TWO_THIRDS=2/3,x.HexGrid.prototype={cellToPixel:function(e){return this._vec3.x=e.q*this._cellWidth*.75,this._vec3.y=e.h,this._vec3.z=-((e.s-e.r)*this._cellLength*.5),this._vec3},pixelToCell:function(e){var t=e.x*(x.HexGrid.TWO_THIRDS/this.cellSize),i=(-e.x/3+x.SQRT3/3*e.z)/this.cellSize;return this._cel.set(t,i,-t-i),this._cubeRound(this._cel)},getCellAt:function(e){var t=e.x*(x.HexGrid.TWO_THIRDS/this.cellSize),i=(-e.x/3+x.SQRT3/3*e.z)/this.cellSize;return this._cel.set(t,i,-t-i),this._cubeRound(this._cel),this.cells[this.cellToHash(this._cel)]},getNeighbors:function(e,t,i){var r,c,d=this._directions.length;for(this._list.length=0,r=0;d>r;r++)this._cel.copy(e),this._cel.add(this._directions[r]),c=this.cells[this.cellToHash(this._cel)],!c||i&&!i(e,c)||this._list.push(c);if(t)for(r=0;d>r;r++)this._cel.copy(e),this._cel.add(this._diagonals[r]),c=this.cells[this.cellToHash(this._cel)],!c||i&&!i(e,c)||this._list.push(c);return this._list},getRandomCell:function(){var e,t=0,i=x.Tools.randomInt(0,this.numCells);for(e in this.cells){if(t===i)return this.cells[e];t++}return this.cells[e]},cellToHash:function(e){return e.q+this._hashDelimeter+e.r+this._hashDelimeter+e.s},distance:function(e,t){var i=Math.max(Math.abs(e.q-t.q),Math.abs(e.r-t.r),Math.abs(e.s-t.s));return i+=t.h-e.h},clearPath:function(){var e,t;for(e in this.cells)t=this.cells[e],t._calcCost=0,t._priority=0,t._parent=null,t._visited=!1},traverse:function(e){var t;for(t in this.cells)e(this.cells[t])},generateTile:function(e,t,i){var r=Math.abs(e.h);1>r&&(r=1);var c=this._geoCache[r];c||(this.extrudeSettings.amount=r,c=new THREE.ExtrudeGeometry(this.cellShape,this.extrudeSettings),this._geoCache[r]=c);var d=new x.Tile({size:this.cellSize,scale:t,cell:e,geometry:c,material:i});return e.tile=d,d},generateTiles:function(e){e=e||{};var t=[],i={tileScale:.95,cellSize:this.cellSize,material:null,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5}};i=x.Tools.merge(i,e),this.cellSize=i.cellSize,this._cellWidth=2*this.cellSize,this._cellLength=.5*x.SQRT3*this._cellWidth,this.autogenerated=!0,this.extrudeSettings=i.extrudeSettings;var r,c,d;for(r in this.cells)d=this.cells[r],c=this.generateTile(d,i.tileScale,i.material),c.position.copy(this.cellToPixel(d)),c.position.y=0,t.push(c);return t},generateTilePoly:function(e){e||(e=new THREE.MeshBasicMaterial({color:2405631}));var t=new THREE.Mesh(this.cellShapeGeo,e);return this._vec3.set(1,0,0),t.rotateOnAxis(this._vec3,x.PI/2),t},generate:function(e){e=e||{},this.size=typeof e.size=="undefined"?this.size:e.size;var t,i,r,c;for(t=-this.size;t<this.size+1;t++)for(i=-this.size;i<this.size+1;i++)r=-t-i,Math.abs(t)<=this.size&&Math.abs(i)<=this.size&&Math.abs(r)<=this.size&&(c=new x.Cell(t,i,r),this.add(c))},generateOverlay:function(e,t,i){var r,c,d,m=this.cellShape.createPointsGeometry();for(r=-e;e+1>r;r++)for(c=-e;e+1>c;c++)if(d=-r-c,Math.abs(r)<=e&&Math.abs(c)<=e&&Math.abs(d)<=e){this._cel.set(r,c,d);var b=new THREE.Line(m,i);b.position.copy(this.cellToPixel(this._cel)),b.rotation.x=90*x.DEG_TO_RAD,t.add(b)}},add:function(e){var t=this.cellToHash(e);if(!this.cells[t])return this.cells[t]=e,this.numCells++,e},remove:function(e){var t=this.cellToHash(e);this.cells[t]&&(delete this.cells[t],this.numCells--)},dispose:function(){this.cells=null,this.numCells=0,this.cellShape=null,this.cellGeo.dispose(),this.cellGeo=null,this.cellShapeGeo.dispose(),this.cellShapeGeo=null,this._list=null,this._vec3=null,this._conversionVec=null,this._geoCache=null,this._matCache=null},load:function(e,t,i){var r=this;x.Tools.getJSON({url:e,callback:function(c){r.fromJSON(c),t.call(i||null,c)},cache:!1,scope:r})},fromJSON:function(e){var t,i,r=e.cells;for(this.cells={},this.numCells=0,this.size=e.size,this.cellSize=e.cellSize,this._cellWidth=2*this.cellSize,this._cellLength=.5*x.SQRT3*this._cellWidth,this.extrudeSettings=e.extrudeSettings,this.autogenerated=e.autogenerated,t=0;t<r.length;t++)i=new x.Cell,i.copy(r[t]),this.add(i)},toJSON:function(){var e,t,i={size:this.size,cellSize:this.cellSize,extrudeSettings:this.extrudeSettings,autogenerated:this.autogenerated},r=[];for(t in this.cells)e=this.cells[t],r.push({q:e.q,r:e.r,s:e.s,h:e.h,walkable:e.walkable,userData:e.userData});return i.cells=r,i},_createVertex:function(e){var t=x.TAU/6*e;return new THREE.Vector3(this.cellSize*Math.cos(t),this.cellSize*Math.sin(t),0)},_cubeRound:function(e){var t=Math.round(e.q),i=Math.round(e.r),r=Math.round(e.s),c=Math.abs(t-e.q),d=Math.abs(i-e.r),m=Math.abs(r-e.s);return c>d&&c>m?t=-i-r:d>m?i=-t-r:r=-t-i,this._cel.set(t,i,r)}},x.HexGrid.prototype.constructor=x.HexGrid,x.SqrGrid=function(e){e=e||{},this.type=x.SQR,this.size=5,this.cellSize=typeof e.cellSize=="undefined"?10:e.cellSize,this.cells={},this.numCells=0,this.extrudeSettings=null,this.autogenerated=!1;var t=[];t.push(new THREE.Vector3),t.push(new THREE.Vector3(-this.cellSize,this.cellSize)),t.push(new THREE.Vector3(this.cellSize,this.cellSize)),t.push(new THREE.Vector3(this.cellSize,-this.cellSize)),this.cellShape=new THREE.Shape,this.cellShape.moveTo(-this.cellSize,-this.cellSize),this.cellShape.lineTo(-this.cellSize,this.cellSize),this.cellShape.lineTo(this.cellSize,this.cellSize),this.cellShape.lineTo(this.cellSize,-this.cellSize),this.cellShape.lineTo(-this.cellSize,-this.cellSize),this.cellGeo=new THREE.Geometry,this.cellGeo.vertices=t,this.cellGeo.verticesNeedUpdate=!0,this.cellShapeGeo=new THREE.ShapeGeometry(this.cellShape),this._fullCellSize=2*this.cellSize,this._hashDelimeter=".",this._directions=[new x.Cell(1,0,0),new x.Cell(0,-1,0),new x.Cell(-1,0,0),new x.Cell(0,1,0)],this._diagonals=[new x.Cell(-1,-1,0),new x.Cell(-1,1,0),new x.Cell(1,1,0),new x.Cell(1,-1,0)],this._list=[],this._vec3=new THREE.Vector3,this._cel=new x.Cell,this._conversionVec=new THREE.Vector3,this._geoCache=[],this._matCache=[]},x.SqrGrid.prototype={cellToPixel:function(e){return this._vec3.x=e.q*this._fullCellSize,this._vec3.y=e.h,this._vec3.z=e.r*this._fullCellSize,this._vec3},pixelToCell:function(e){var t=Math.round(e.x/this._fullCellSize),i=Math.round(e.z/this._fullCellSize);return this._cel.set(t,i,0)},getCellAt:function(e){var t=Math.round(e.x/this._fullCellSize),i=Math.round(e.z/this._fullCellSize);return this._cel.set(t,i),this.cells[this.cellToHash(this._cel)]},getNeighbors:function(e,t,i){var r,c,d=this._directions.length;for(this._list.length=0,r=0;d>r;r++)this._cel.copy(e),this._cel.add(this._directions[r]),c=this.cells[this.cellToHash(this._cel)],!c||i&&!i(e,c)||this._list.push(c);if(t)for(r=0;d>r;r++)this._cel.copy(e),this._cel.add(this._diagonals[r]),c=this.cells[this.cellToHash(this._cel)],!c||i&&!i(e,c)||this._list.push(c);return this._list},getRandomCell:function(){var e,t=0,i=x.Tools.randomInt(0,this.numCells);for(e in this.cells){if(t===i)return this.cells[e];t++}return this.cells[e]},cellToHash:function(e){return e.q+this._hashDelimeter+e.r},distance:function(e,t){var i=Math.max(Math.abs(e.q-t.q),Math.abs(e.r-t.r));return i+=t.h-e.h},clearPath:function(){var e,t;for(e in this.cells)t=this.cells[e],t._calcCost=0,t._priority=0,t._parent=null,t._visited=!1},traverse:function(e){var t;for(t in this.cells)e(this.cells[t])},generateTile:function(e,t,i){var r=Math.abs(e.h);1>r&&(r=1);var c=this._geoCache[r];c||(this.extrudeSettings.amount=r,c=new THREE.ExtrudeGeometry(this.cellShape,this.extrudeSettings),this._geoCache[r]=c);var d=new x.Tile({size:this.cellSize,scale:t,cell:e,geometry:c,material:i});return e.tile=d,d},generateTiles:function(e){e=e||{};var t=[],i={tileScale:.95,cellSize:this.cellSize,material:null,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5}};i=x.Tools.merge(i,e),this.cellSize=i.cellSize,this._fullCellSize=2*this.cellSize,this.autogenerated=!0,this.extrudeSettings=i.extrudeSettings;var r,c,d;for(r in this.cells)d=this.cells[r],c=this.generateTile(d,i.tileScale,i.material),c.position.copy(this.cellToPixel(d)),c.position.y=0,t.push(c);return t},generateTilePoly:function(e){e||(e=new THREE.MeshBasicMaterial({color:2405631}));var t=new THREE.Mesh(this.cellShapeGeo,e);return this._vec3.set(1,0,0),t.rotateOnAxis(this._vec3,x.PI/2),t},generate:function(e){e=e||{},this.size=typeof e.size=="undefined"?this.size:e.size;var t,i,r,c=Math.ceil(this.size/2);for(t=-c;c>t;t++)for(i=-c;c>i;i++)r=new x.Cell(t,i+1),this.add(r)},generateOverlay:function(e,t,i){var r,c,d=Math.ceil(e/2);for(r=-d;d>r;r++)for(c=-d;d>c;c++){this._cel.set(r,c);var m=new THREE.Line(this.cellGeo,i);m.position.copy(this.cellToPixel(this._cel)),m.rotation.x=90*x.DEG_TO_RAD,t.add(m)}},add:function(e){var t=this.cellToHash(e);if(!this.cells[t])return this.cells[t]=e,this.numCells++,e},remove:function(e){var t=this.cellToHash(e);this.cells[t]&&(delete this.cells[t],this.numCells--)},dispose:function(){this.cells=null,this.numCells=0,this.cellShape=null,this.cellGeo.dispose(),this.cellGeo=null,this.cellShapeGeo.dispose(),this.cellShapeGeo=null,this._list=null,this._vec3=null,this._conversionVec=null,this._geoCache=null,this._matCache=null},load:function(e,t,i){x.Tools.getJSON({url:e,callback:function(r){this.fromJSON(r),t.call(i||null,r)},cache:!1,scope:this})},fromJSON:function(e){var t,i,r=e.cells;for(this.cells={},this.numCells=0,this.size=e.size,this.cellSize=e.cellSize,this._fullCellSize=2*this.cellSize,this.extrudeSettings=e.extrudeSettings,this.autogenerated=e.autogenerated,t=0;t<r.length;t++)i=new x.Cell,i.copy(r[t]),this.add(i)},toJSON:function(){var e,t,i={size:this.size,cellSize:this.cellSize,extrudeSettings:this.extrudeSettings,autogenerated:this.autogenerated},r=[];for(t in this.cells)e=this.cells[t],r.push({q:e.q,r:e.r,s:e.s,h:e.h,walkable:e.walkable,userData:e.userData});return i.cells=r,i}},x.SqrGrid.prototype.constructor=x.SqrGrid,x.Tile=function(e){e=e||{};var t={cell:null,geometry:null,material:null};if(t=x.Tools.merge(t,e),!t.cell||!t.geometry)throw new Error("Missing vg.Tile configuration");this.cell=t.cell,this.cell.tile&&this.cell.tile!==this&&this.cell.tile.dispose(),this.cell.tile=this,this.uniqueID=x.Tools.generateID(),this.geometry=t.geometry,this.material=t.material,this.material||(this.material=new THREE.MeshPhongMaterial({color:x.Tools.randomizeRGB("30, 30, 30",13)})),this.objectType=x.TILE,this.entity=null,this.userData={},this.selected=!1,this.highlight="0x0084cc",this.mesh=new THREE.Mesh(this.geometry,this.material),this.mesh.userData.structure=this,this.position=this.mesh.position,this.rotation=this.mesh.rotation,this.rotation.x=-90*x.DEG_TO_RAD,this.mesh.scale.set(t.scale,t.scale,1),this.material.emissive?this._emissive=this.material.emissive.getHex():this._emissive=null},x.Tile.prototype={select:function(){return this.material.emissive&&this.material.emissive.setHex(this.highlight),this.selected=!0,this},deselect:function(){return this._emissive!==null&&this.material.emissive&&this.material.emissive.setHex(this._emissive),this.selected=!1,this},toggle:function(){return this.selected?this.deselect():this.select(),this},dispose:function(){this.cell&&this.cell.tile&&(this.cell.tile=null),this.cell=null,this.position=null,this.rotation=null,this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.mesh.userData.structure=null,this.mesh=null,this.material=null,this.userData=null,this.entity=null,this.geometry=null,this._emissive=null}},x.Tile.prototype.constructor=x.Tile,function(){var e=function(){this.obj=null,this.next=null,this.prev=null,this.free=!0},t=function(){this.first=null,this.last=null,this.length=0,this.objToNodeMap={},this.uniqueID=Date.now()+""+Math.floor(1e3*Math.random()),this.sortArray=[]};t.generateID=function(){return Math.random().toString(36).slice(2)+Date.now()},t.prototype={getNode:function(i){return this.objToNodeMap[i.uniqueID]},addNode:function(i){var r=new e;if(!i.uniqueID)try{i.uniqueID=t.generateID()}catch{return console.error("[LinkedList.addNode] obj passed is immutable: cannot attach necessary identifier"),null}return r.obj=i,r.free=!1,this.objToNodeMap[i.uniqueID]=r,r},swapObjects:function(i,r){this.objToNodeMap[i.obj.uniqueID]=null,this.objToNodeMap[r.uniqueID]=i,i.obj=r},add:function(i){var r=this.objToNodeMap[i.uniqueID];if(r){if(r.free===!1)return;r.obj=i,r.free=!1,r.next=null,r.prev=null}else r=this.addNode(i);if(this.first){if(!this.last)throw new Error("[LinkedList.add] No last in the list -- that shouldn't happen here");this.last.next=r,r.prev=this.last,this.last=r,r.next=null}else this.first=r,this.last=r,r.next=null,r.prev=null;this.length++,this.showDebug&&this.dump("after add")},has:function(i){return!!this.objToNodeMap[i.uniqueID]},moveUp:function(i){this.dump("before move up");var r=this.getNode(i);if(!r)throw"Oops, trying to move an object that isn't in the list";if(r.prev){var c=r.prev,d=c.prev;r==this.last&&(this.last=c);var m=r.next;d&&(d.next=r),r.next=c,r.prev=c.prev,c.next=m,c.prev=r,this.first==c&&(this.first=r)}},moveDown:function(i){var r=this.getNode(i);if(!r)throw"Oops, trying to move an object that isn't in the list";if(r.next){var c=r.next;this.moveUp(c.obj),this.last==c&&(this.last=r)}},sort:function(i){var r,c,d=this.sortArray,m=this.first;for(d.length=0;m;)d.push(m.obj),m=m.next;for(this.clear(),d.sort(i),c=d.length,r=0;c>r;r++)this.add(d[r])},remove:function(i){var r=this.getNode(i);return!r||r.free?!1:(r.prev&&(r.prev.next=r.next),r.next&&(r.next.prev=r.prev),r.prev||(this.first=r.next),r.next||(this.last=r.prev),r.free=!0,r.prev=null,r.next=null,this.length--,!0)},shift:function(){var i=this.first;return this.length===0?null:(i.prev&&(i.prev.next=i.next),i.next&&(i.next.prev=i.prev),this.first=i.next,i.next||(this.last=null),i.free=!0,i.prev=null,i.next=null,this.length--,i.obj)},pop:function(){var i=this.last;return this.length===0?null:(i.prev&&(i.prev.next=i.next),i.next&&(i.next.prev=i.prev),this.last=i.prev,i.prev||(this.first=null),i.free=!0,i.prev=null,i.next=null,this.length--,i.obj)},concat:function(i){for(var r=i.first;r;)this.add(r.obj),r=r.next},clear:function(){for(var i=this.first;i;)i.free=!0,i=i.next;this.first=null,this.length=0},dispose:function(){for(var i=this.first;i;)i.obj=null,i=i.next;this.first=null,this.objToNodeMap=null},dump:function(i){console.log("===================="+i+"=====================");for(var r=this.first;r;)console.log("{"+r.obj.toString()+"} previous="+(r.prev?r.prev.obj:"NULL")),r=r.next();console.log("==================================="),console.log("Last: {"+(this.last?this.last.obj:"NULL")+"} First: {"+(this.first?this.first.obj:"NULL")+"}")}},t.prototype.constructor=t,x.LinkedList=t}(),function(){var e=function(i,r,c,d,m){this._listener=r,this.isOnce=c,this.context=d,this.signal=i,this._priority=m||0};e.prototype={active:!0,params:null,execute:function(i){var r,c;return this.active&&this._listener&&(c=this.params?this.params.concat(i):i,r=this._listener.apply(this.context,c),this.isOnce&&this.detach()),r},detach:function(){return this.isBound()?this.signal.remove(this._listener,this.context):null},isBound:function(){return!!this.signal&&!!this._listener},_destroy:function(){delete this.signal,delete this._listener,delete this.context},toString:function(){return"[SignalBinding isOnce:"+this.isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}},e.prototype.constructor=e;var t=function(){this._bindings=[],this._prevParams=null;var i=this;this.dispatch=function(){t.prototype.dispatch.apply(i,arguments)}};t.prototype={memorize:!1,_shouldPropagate:!0,active:!0,validateListener:function(i,r){if(typeof i!="function")throw new Error("Signal: listener is a required param of {fn}() and should be a Function.".replace("{fn}",r))},_registerListener:function(i,r,c,d){var m,b=this._indexOfListener(i,c);if(b!==-1){if(m=this._bindings[b],m.isOnce!==r)throw new Error("You cannot add"+(r?"":"Once")+"() then add"+(r?"Once":"")+"() the same listener without removing the relationship first.")}else m=new e(this,i,r,c,d),this._addBinding(m);return this.memorize&&this._prevParams&&m.execute(this._prevParams),m},_addBinding:function(i){var r=this._bindings.length;do r--;while(this._bindings[r]&&i._priority<=this._bindings[r]._priority);this._bindings.splice(r+1,0,i)},_indexOfListener:function(i,r){for(var c,d=this._bindings.length;d--;)if(c=this._bindings[d],c._listener===i&&c.context===r)return d;return-1},has:function(i,r){return this._indexOfListener(i,r)!==-1},add:function(i,r,c){return this.validateListener(i,"add"),this._registerListener(i,!1,r,c)},addOnce:function(i,r,c){return this.validateListener(i,"addOnce"),this._registerListener(i,!0,r,c)},remove:function(i,r){this.validateListener(i,"remove");var c=this._indexOfListener(i,r);return c!==-1&&(this._bindings[c]._destroy(),this._bindings.splice(c,1)),i},removeAll:function(i){typeof i=="undefined"&&(i=null);for(var r=this._bindings.length;r--;)i?this._bindings[r].context===i&&(this._bindings[r]._destroy(),this._bindings.splice(r,1)):this._bindings[r]._destroy();i||(this._bindings.length=0)},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(){if(this.active){var i,r=Array.prototype.slice.call(arguments),c=this._bindings.length;if(this.memorize&&(this._prevParams=r),c){i=this._bindings.slice(),this._shouldPropagate=!0;do c--;while(i[c]&&this._shouldPropagate&&i[c].execute(r)!==!1)}}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}},t.prototype.constructor=t,x.Signal=t}(),x.AStarFinder=function(e){e=e||{};var t={allowDiagonal:!1,heuristicFilter:null};t=x.Tools.merge(t,e),this.allowDiagonal=t.allowDiagonal,this.heuristicFilter=t.heuristicFilter,this.list=new x.LinkedList},x.AStarFinder.prototype={findPath:function(e,t,i,r){var c,d,m,b,w,H;for(i=i||this.heuristicFilter,r.clearPath(),this.list.clear(),this.list.add(e);this.list.length>0;){if(this.list.sort(this.compare),c=this.list.shift(),c._visited=!0,c===t)return x.PathUtil.backtrace(t);for(m=r.getNeighbors(c,this.allowDiagonal,i),w=0,H=m.length;H>w;w++)if(b=m[w],b.walkable&&(d=c._calcCost+r.distance(c,b),!b._visited||d<b._calcCost)){if(b._visited=!0,b._parent=c,b._calcCost=d,b._priority=d+r.distance(t,b),b===t)return x.PathUtil.backtrace(t);this.list.add(b)}}return null},compare:function(e,t){return e._priority-t._priority}},x.AStarFinder.prototype.constructor=x.AStarFinder,x.PathUtil={backtrace:function(e){for(var t=[e];e._parent;)e=e._parent,t.push(e);return t.reverse()},biBacktrace:function(e,t){var i=this.backtrace(e),r=this.backtrace(t);return i.concat(r.reverse())},pathLength:function(e){var t,i,r,c,d,m=0;for(t=1;t<e.length;++t)i=e[t-1],r=e[t],c=i[0]-r[0],d=i[1]-r[1],m+=Math.sqrt(c*c+d*d);return m},interpolate:function(e,t,i,r){var c,d,m,b,w,H,C=Math.abs,K=[];for(m=C(i-e),b=C(r-t),c=i>e?1:-1,d=r>t?1:-1,w=m-b;e!==i||t!==r;)K.push([e,t]),H=2*w,H>-b&&(w-=b,e+=c),m>H&&(w+=m,t+=d);return K},expandPath:function(e){var t,i,r,c,d,m,b=[],w=e.length;if(2>w)return b;for(d=0;w-1>d;++d)for(t=e[d],i=e[d+1],r=this.interpolate(t[0],t[1],i[0],i[1]),c=r.length,m=0;c-1>m;++m)b.push(r[m]);return b.push(e[w-1]),b},smoothenPath:function(e,t){var i,r,c,d,m,b,w,H,C,K,D,S,F=t.length,re=t[0][0],he=t[0][1],ne=t[F-1][0],me=t[F-1][1];for(i=re,r=he,m=[[i,r]],w=2;F>w;++w){for(C=t[w],c=C[0],d=C[1],K=this.interpolate(i,r,c,d),S=!1,H=1;H<K.length;++H)if(D=K[H],!e.isWalkableAt(D[0],D[1])){S=!0;break}S&&(b=t[w-1],m.push(b),i=b[0],r=b[1])}return m.push([ne,me]),m},compressPath:function(e){if(e.length<3)return e;var t,i,r,c,d,m,b=[],w=e[0][0],H=e[0][1],C=e[1][0],K=e[1][1],D=C-w,S=K-H;for(d=Math.sqrt(D*D+S*S),D/=d,S/=d,b.push([w,H]),m=2;m<e.length;m++)t=C,i=K,r=D,c=S,C=e[m][0],K=e[m][1],D=C-t,S=K-i,d=Math.sqrt(D*D+S*S),D/=d,S/=d,(D!==r||S!==c)&&b.push([t,i]);return b.push([C,K]),b}},x.Loader={manager:null,imageLoader:null,crossOrigin:!1,init:function(e){this.crossOrigin=e||!1,this.manager=new THREE.LoadingManager(function(){},function(){},function(){console.warn("Error loading images")}),this.imageLoader=new THREE.ImageLoader(this.manager),this.imageLoader.crossOrigin=e},loadTexture:function(e,t,i,r){var c=new THREE.Texture(null,t);return this.imageLoader.load(e,function(d){c.image=d,c.needsUpdate=!0,i&&i(c)},null,function(d){r&&r(d)}),c.sourceFile=e,c}},x.MouseCaster=function(e,t,i){this.down=!1,this.rightDown=!1,this.pickedObject=null,this.selectedObject=null,this.allHits=null,this.active=!0,this.shift=!1,this.ctrl=!1,this.wheel=0,this.position=new THREE.Vector3,this.screenPosition=new THREE.Vector2,this.signal=new x.Signal,this.group=e,this._camera=t,this._raycaster=new THREE.Raycaster,this._preventDefault=!1,i=i||document,i.addEventListener("mousemove",this._onDocumentMouseMove.bind(this),!1),i.addEventListener("mousedown",this._onDocumentMouseDown.bind(this),!1),i.addEventListener("mouseup",this._onDocumentMouseUp.bind(this),!1),i.addEventListener("mousewheel",this._onMouseWheel.bind(this),!1),i.addEventListener("DOMMouseScroll",this._onMouseWheel.bind(this),!1)},x.MouseCaster.OVER="over",x.MouseCaster.OUT="out",x.MouseCaster.DOWN="down",x.MouseCaster.UP="up",x.MouseCaster.CLICK="click",x.MouseCaster.WHEEL="wheel",x.MouseCaster.prototype={update:function(){if(this.active){this._raycaster.setFromCamera(this.screenPosition,this._camera);var e,t,i=this._raycaster.intersectObject(this.group,!0);i.length>0?(e=i[0],t=e.object.userData.structure,this.pickedObject!=t&&(this.pickedObject&&this.signal.dispatch(x.MouseCaster.OUT,this.pickedObject),this.pickedObject=t,this.selectedObject=null,this.signal.dispatch(x.MouseCaster.OVER,this.pickedObject)),this.position.copy(e.point),this.screenPosition.z=e.distance):(this.pickedObject&&this.signal.dispatch(x.MouseCaster.OUT,this.pickedObject),this.pickedObject=null,this.selectedObject=null),this.allHits=i}},preventDefault:function(){this._preventDefault=!0},_onDocumentMouseDown:function(e){return e=e||window.event,e.preventDefault(),this._preventDefault?(this._preventDefault=!1,!1):(this.pickedObject&&(this.selectedObject=this.pickedObject),this.shift=e.shiftKey,this.ctrl=e.ctrlKey,this.down=e.which===1,this.rightDown=e.which===3,void this.signal.dispatch(x.MouseCaster.DOWN,this.pickedObject))},_onDocumentMouseUp:function(e){return e.preventDefault(),this._preventDefault?(this._preventDefault=!1,!1):(this.shift=e.shiftKey,this.ctrl=e.ctrlKey,this.signal.dispatch(x.MouseCaster.UP,this.pickedObject),this.selectedObject&&this.pickedObject&&this.selectedObject.uniqueID===this.pickedObject.uniqueID&&this.signal.dispatch(x.MouseCaster.CLICK,this.pickedObject),this.down=e.which===1?!1:this.down,void(this.rightDown=e.which===3?!1:this.rightDown))},_onDocumentMouseMove:function(e){e.preventDefault(),this.screenPosition.x=e.clientX/window.innerWidth*2-1,this.screenPosition.y=2*-(e.clientY/window.innerHeight)+1},_onMouseWheel:function(e){if(this.active){e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta!==void 0?t=e.wheelDelta:e.detail!==void 0&&(t=-e.detail),t>0?this.wheel++:this.wheel--,this.signal.dispatch(x.MouseCaster.WHEEL,this.wheel)}}},x.MouseCaster.prototype.constructor=x.MouseCaster,x.Scene=function(e,t){var i={element:document.body,alpha:!0,antialias:!0,clearColor:"#fff",sortObjects:!1,fog:null,light:new THREE.DirectionalLight(16777215),lightPosition:null,cameraType:"PerspectiveCamera",cameraPosition:null,orthoZoom:4},r={minDistance:100,maxDistance:1e3,zoomSpeed:2,noZoom:!1};if(i=x.Tools.merge(i,e),typeof t!="boolean"&&(r=x.Tools.merge(r,t)),this.renderer=new THREE.WebGLRenderer({alpha:i.alpha,antialias:i.antialias}),this.renderer.setClearColor(i.clearColor,0),this.renderer.sortObjects=i.sortObjects,this.width=window.innerWidth,this.height=window.innerHeight,this.orthoZoom=i.orthoZoom,this.container=new THREE.Scene,this.container.fog=i.fog,this.container.add(new THREE.AmbientLight(14540253)),i.lightPosition||i.light.position.set(-1,1,-1).normalize(),this.container.add(i.light),i.cameraType==="OrthographicCamera"){var c=window.innerWidth/this.orthoZoom,d=window.innerHeight/this.orthoZoom;this.camera=new THREE.OrthographicCamera(c/-2,c/2,d/2,d/-2,1,5e3)}else this.camera=new THREE.PerspectiveCamera(50,this.width/this.height,1,5e3);this.contolled=!!t,this.contolled&&(this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.minDistance=r.minDistance,this.controls.maxDistance=r.maxDistance,this.controls.zoomSpeed=r.zoomSpeed,this.controls.noZoom=r.noZoom),i.cameraPosition&&this.camera.position.copy(i.cameraPosition),window.addEventListener("resize",function(){if(this.width=window.innerWidth,this.height=window.innerHeight,this.camera.type==="OrthographicCamera"){var m=this.width/this.orthoZoom,b=this.height/this.orthoZoom;this.camera.left=m/-2,this.camera.right=m/2,this.camera.top=b/2,this.camera.bottom=b/-2}else this.camera.aspect=this.width/this.height;this.camera.updateProjectionMatrix(),this.renderer.setSize(this.width,this.height)}.bind(this),!1),this.attachTo(i.element)},x.Scene.prototype={attachTo:function(e){e.style.width=this.width+"px",e.style.height=this.height+"px",this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(this.width,this.height),e.appendChild(this.renderer.domElement)},add:function(e){this.container.add(e)},remove:function(e){this.container.remove(e)},render:function(){this.contolled&&this.controls.update(),this.renderer.render(this.container,this.camera)},updateOrthoZoom:function(){if(this.orthoZoom<=0)return void(this.orthoZoom=0);var e=this.width/this.orthoZoom,t=this.height/this.orthoZoom;this.camera.left=e/-2,this.camera.right=e/2,this.camera.top=t/2,this.camera.bottom=t/-2,this.camera.updateProjectionMatrix()},focusOn:function(e){this.camera.lookAt(e.position)}},x.Scene.prototype.constructor=x.Scene,x.SelectionManager=function(e){this.mouse=e,this.onSelect=new x.Signal,this.onDeselect=new x.Signal,this.selected=null,this.toggleSelection=!1,this.mouse.signal.add(this.onMouse,this)},x.SelectionManager.prototype={select:function(e,t){e&&(t=t||!0,this.selected!==e&&this.clearSelection(t),e.selected?this.toggleSelection&&(t&&this.onDeselect.dispatch(e),e.deselect()):e.select(),this.selected=e,t&&this.onSelect.dispatch(e))},clearSelection:function(e){e=e||!0,this.selected&&(e&&this.onDeselect.dispatch(this.selected),this.selected.deselect()),this.selected=null},onMouse:function(e,t){switch(e){case x.MouseCaster.DOWN:t||this.clearSelection();break;case x.MouseCaster.CLICK:this.select(t)}}},x.SelectionManager.prototype.constructor=x.SelectionManager,x.Tools={clamp:function(e,t,i){return Math.max(t,Math.min(i,e))},sign:function(e){return e&&e/Math.abs(e)},random:function(e,t){return arguments.length===1?Math.random()*e-.5*e:Math.random()*(t-e)+e},randomInt:function(e,t){return arguments.length===1?Math.random()*e-.5*e|0:Math.random()*(t-e+1)+e|0},normalize:function(e,t,i){return(e-t)/(i-t)},getShortRotation:function(e){return e%=this.TAU,e>this.PI?e-=this.TAU:e<-this.PI&&(e+=this.TAU),e},generateID:function(){return Math.random().toString(36).slice(2)+Date.now()},isPlainObject:function(e){if(typeof e!="object"||e.nodeType||e===e.window)return!1;try{if(e.constructor&&!Object.prototype.hasOwnProperty.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch{return!1}return!0},merge:function(e,t){var i=this,r=Array.isArray(t),c=r&&[]||{};return r?(e=e||[],c=c.concat(e),t.forEach(function(d,m){typeof c[m]=="undefined"?c[m]=d:i.isPlainObject(d)?c[m]=i.merge(e[m],d):e.indexOf(d)===-1&&c.push(d)}),c):(e&&i.isPlainObject(e)&&Object.keys(e).forEach(function(d){c[d]=e[d]}),Object.keys(t).forEach(function(d){t[d]&&i.isPlainObject(t[d])&&e[d]?c[d]=i.merge(e[d],t[d]):c[d]=t[d]}),c)},now:function(){return window.nwf?window.nwf.system.Performance.elapsedTime:window.performance.now()},empty:function(e){for(;e.lastChild;)e.removeChild(e.lastChild)},radixSort:function(e,t,i,r){if(t=t||0,i=i||e.length,r=r||31,!(t>=i-1||0>r)){for(var c=t,d=i,m=1<<r;d>c;)if(e[c]&m){--d;var b=e[c];e[c]=e[d],e[d]=b}else++c;this.radixSort(e,t,d,r-1),this.radixSort(e,d,i,r-1)}},randomizeRGB:function(e,t){var i,r,c=e.split(","),d="rgb(";for(t=this.randomInt(t),i=0;3>i;i++)r=parseInt(c[i])+t,0>r?r=0:r>255&&(r=255),d+=r+",";return d=d.substring(0,d.length-1),d+=")"},getJSON:function(e){var t=new XMLHttpRequest,i=typeof e.cache=="undefined"?!1:e.cache,r=i?e.url:e.url+"?t="+Math.floor(1e4*Math.random())+Date.now();t.onreadystatechange=function(){if(this.status===200){var c=null;try{c=JSON.parse(this.responseText)}catch{return}return void e.callback.call(e.scope||null,c)}this.status!==0&&console.warn("[Tools.getJSON] Error: "+this.status+" ("+this.statusText+") :: "+e.url)},t.open("GET",r,!0),t.setRequestHeader("Accept","application/json"),t.setRequestHeader("Content-Type","application/json"),t.send("")}};var un={size:5,cellSize:10,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5},autogenerated:!0,cells:[{q:-1,r:0,s:1,h:1,walkable:!0,userData:{}},{q:0,r:-1,s:1,h:1,walkable:!0,userData:{}},{q:0,r:0,s:0,h:1,walkable:!0,userData:{}},{q:1,r:-1,s:0,h:1,walkable:!0,userData:{}},{q:-1,r:1,s:0,h:0,walkable:!0,userData:{}},{q:0,r:1,s:-1,h:0,walkable:!0,userData:{}},{q:1,r:0,s:-1,h:0,walkable:!0,userData:{}}]};const Lt=Ht.exports,dn=un;AFRAME.registerPrimitive("a-hexgrid",{defaultComponents:{hexgrid:{}},mappings:{src:"hexgrid.src"}});AFRAME.registerComponent("hexgrid",{dependencies:["material"],schema:{src:{type:"asset"}},init:function(){const e=this.data;e.src?fetch(e.src).then(t=>t.json()).then(t=>this.addMesh(t)):this.addMesh(dn)},addMesh:function(e){const t=new Lt.HexGrid;t.fromJSON(e);const i=new Lt.Board(t);i.generateTilemap(),this.el.setObject3D("mesh",i.group),this.addMaterial()},addMaterial:function(){const t=(this.el.components.material||{}).material;!t||this.el.object3D.traverse(i=>{i.isMesh&&(i.material=t)})},remove:function(){this.el.removeObject3D("mesh")}});AFRAME.registerPrimitive("a-ocean",{defaultComponents:{ocean:{},rotation:{x:-90,y:0,z:0}},mappings:{width:"ocean.width",depth:"ocean.depth",density:"ocean.density",amplitude:"ocean.amplitude",amplitudeVariance:"ocean.amplitudeVariance",speed:"ocean.speed",speedVariance:"ocean.speedVariance",color:"ocean.color",opacity:"ocean.opacity"}});AFRAME.registerComponent("ocean",{schema:{width:{default:10,min:0},depth:{default:10,min:0},density:{default:10},amplitude:{default:.1},amplitudeVariance:{default:.3},speed:{default:1},speedVariance:{default:2},color:{default:"#7AD2F7",type:"color"},opacity:{default:.8}},play:function(){const e=this.el,t=this.data;let i=e.components.material;const r=new THREE.PlaneGeometry(t.width,t.depth,t.density,t.density);r.mergeVertices(),this.waves=[];for(let c,d=0,m=r.vertices.length;d<m;d++)c=r.vertices[d],this.waves.push({z:c.z,ang:Math.random()*Math.PI*2,amp:t.amplitude+Math.random()*t.amplitudeVariance,speed:(t.speed+Math.random()*t.speedVariance)/1e3});i||(i={},i.material=new THREE.MeshPhongMaterial({color:t.color,transparent:t.opacity<1,opacity:t.opacity,shading:THREE.FlatShading})),this.mesh=new THREE.Mesh(r,i.material),e.setObject3D("mesh",this.mesh)},remove:function(){this.el.removeObject3D("mesh")},tick:function(e,t){if(!t)return;const i=this.mesh.geometry.vertices;for(let r,c,d=0;r=i[d];d++)c=this.waves[d],r.z=c.z+Math.sin(c.ang)*c.amp,c.ang+=c.speed*t;this.mesh.geometry.verticesNeedUpdate=!0}});AFRAME.registerPrimitive("a-tube",{defaultComponents:{tube:{}},mappings:{path:"tube.path",segments:"tube.segments",radius:"tube.radius","radial-segments":"tube.radialSegments",closed:"tube.closed"}});AFRAME.registerComponent("tube",{schema:{path:{default:[]},segments:{default:64},radius:{default:1},radialSegments:{default:8},closed:{default:!1}},init:function(){const e=this.el,t=this.data;let i=e.components.material;if(!t.path.length){console.error("[a-tube] `path` property expected but not found.");return}const r=new THREE.CatmullRomCurve3(t.path.map(function(d){return d=d.split(" "),new THREE.Vector3(Number(d[0]),Number(d[1]),Number(d[2]))})),c=new THREE.TubeGeometry(r,t.segments,t.radius,t.radialSegments,t.closed);i||(i={},i.material=new THREE.MeshPhongMaterial),this.mesh=new THREE.Mesh(c,i.material),this.el.setObject3D("mesh",this.mesh)},update:function(e){!Object.keys(e).length||(this.remove(),this.init())},remove:function(){this.mesh&&this.el.removeObject3D("mesh")}});function fn(e){let t,i;return t=new Fi({}),{c(){Si(t.$$.fragment)},l(r){Li(t.$$.fragment,r)},m(r,c){_i(t,r,c),i=!0},p:Hi,i(r){i||(Oi(t.$$.fragment,r),i=!0)},o(r){Di(t.$$.fragment,r),i=!1},d(r){Ni(t,r)}}}class kn extends Ri{constructor(t){super(),Ci(this,t,null,fn,Mi,{})}}export{kn as default};
