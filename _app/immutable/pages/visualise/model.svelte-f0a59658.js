import{S as Mi,i as Si,s as Li,w as Hi,x as _i,y as Oi,E as Di,q as Fi,o as Ni,B as Pi,J as Ii,L as Bi}from"../../chunks/index-ca5d62ed.js";import{S as zi,a as ue}from"../../chunks/aframe-master-52339316.js";import{g as ji}from"../../chunks/_commonjsHelpers-56d41998.js";import{g as Vi}from"../../chunks/gltfStore-4d0c5d70.js";import"../../chunks/contourLineStore-080ee4cb.js";import"../../chunks/index-bcf3c295.js";import"../../chunks/NavigationButton-4b0ccaf5.js";import"../../chunks/navigation-0e6511d1.js";import"../../chunks/singletons-d1fb5791.js";import"../../chunks/difficultyStore-d15690e4.js";import"../../chunks/debugStore-218dd941.js";import"../../chunks/@vite-plugin-wasm-pack@wasm-9c455baf.js";const St=.1;AFRAME.registerComponent("checkpoint-controls",{schema:{enabled:{default:!0},mode:{default:"teleport",oneOf:["teleport","animate"]},animateSpeed:{default:3}},init:function(){this.active=!0,this.checkpoint=null,this.isNavMeshConstrained=!1,this.offset=new THREE.Vector3,this.position=new THREE.Vector3,this.targetPosition=new THREE.Vector3},play:function(){this.active=!0},pause:function(){this.active=!1},setCheckpoint:function(e){const t=this.el;if(!!this.active&&this.checkpoint!==e){if(this.checkpoint&&t.emit("navigation-end",{checkpoint:this.checkpoint}),this.checkpoint=e,this.sync(),this.position.distanceTo(this.targetPosition)<St){this.checkpoint=null;return}t.emit("navigation-start",{checkpoint:e}),this.data.mode==="teleport"&&(this.el.setAttribute("position",this.targetPosition),this.checkpoint=null,t.emit("navigation-end",{checkpoint:e}),t.components["movement-controls"].updateNavLocation())}},isVelocityActive:function(){return!!(this.active&&this.checkpoint)},getVelocity:function(){if(!this.active)return;const e=this.data,t=this.offset,i=this.position,r=this.targetPosition,c=this.checkpoint;return this.sync(),i.distanceTo(r)<St?(this.checkpoint=null,this.el.emit("navigation-end",{checkpoint:c}),t.set(0,0,0)):(t.setLength(e.animateSpeed),t)},sync:function(){const e=this.offset,t=this.position,i=this.targetPosition;t.copy(this.el.getAttribute("position")),this.checkpoint.object3D.getWorldPosition(i),i.add(this.checkpoint.components.checkpoint.getOffset()),e.copy(i).sub(t)}});var Gi=Object.assign(function(){},{FACE_1:0,FACE_2:1,FACE_3:2,FACE_4:3,L_SHOULDER_1:4,R_SHOULDER_1:5,L_SHOULDER_2:6,R_SHOULDER_2:7,SELECT:8,START:9,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15,VENDOR:16});function Ki(e,t,i){this.type=e,this.index=t,this.pressed=i.pressed,this.value=i.value}var Ui=Ki;const Fe=Gi,rt=Ui,Ce=.2,we={LEFT:"left",RIGHT:"right"},xe={MOVEMENT:1,ROTATION:2};AFRAME.registerComponent("gamepad-controls",{GamepadButton:Fe,schema:{enabled:{default:!0},camera:{default:"[camera]",type:"selector"},rotationSensitivity:{default:2}},init:function(){const e=this.el.sceneEl;this.system=e.systems["tracked-controls-webxr"]||{controllers:[]},this.prevTime=window.performance.now(),this.buttons={};const t=this.el.object3D.rotation;this.pitch=new THREE.Object3D,this.pitch.rotation.x=THREE.Math.degToRad(t.x),this.yaw=new THREE.Object3D,this.yaw.position.y=10,this.yaw.rotation.y=THREE.Math.degToRad(t.y),this.yaw.add(this.pitch),this._lookVector=new THREE.Vector2,this._moveVector=new THREE.Vector2,this._dpadVector=new THREE.Vector2,e.addBehavior(this)},update:function(){this.tick()},tick:function(e,t){this.updateButtonState(),this.updateRotation(t)},remove:function(){},isVelocityActive:function(){if(!this.data.enabled||!this.isConnected())return!1;const e=this._dpadVector,t=this._moveVector;this.getDpad(e),this.getJoystick(xe.MOVEMENT,t);const i=e.x||t.x,r=e.y||t.y;return Math.abs(i)>Ce||Math.abs(r)>Ce},getVelocityDelta:function(){const e=this._dpadVector,t=this._moveVector;this.getDpad(e),this.getJoystick(xe.MOVEMENT,t);const i=e.x||t.x,r=e.y||t.y,c=new THREE.Vector3;return Math.abs(i)>Ce&&(c.x+=i),Math.abs(r)>Ce&&(c.z+=r),c},isRotationActive:function(){if(!this.data.enabled||!this.isConnected())return!1;const e=this._lookVector;return this.getJoystick(xe.ROTATION,e),Math.abs(e.x)>Ce||Math.abs(e.y)>Ce},updateRotation:function(e){if(!this.isRotationActive())return;const t=this.data,i=this.yaw,r=this.pitch,c=t.camera.components["look-controls"],d=c&&c.pitchObject&&c.yawObject;d&&(r.rotation.copy(c.pitchObject.rotation),i.rotation.copy(c.yawObject.rotation));const m=this._lookVector;this.getJoystick(xe.ROTATION,m),Math.abs(m.x)<=Ce&&(m.x=0),Math.abs(m.y)<=Ce&&(m.y=0),m.multiplyScalar(t.rotationSensitivity*e/1e3),i.rotation.y-=m.x,r.rotation.x-=m.y,r.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,r.rotation.x)),t.camera.object3D.rotation.set(r.rotation.x,i.rotation.y,0),d&&(c.pitchObject.rotation.copy(r.rotation),c.yawObject.rotation.copy(i.rotation))},updateButtonState:function(){const e=this.getGamepad(we.RIGHT);if(this.data.enabled&&e)for(var t=0;t<e.buttons.length;t++)e.buttons[t].pressed&&!this.buttons[t]?this.emit(new rt("gamepadbuttondown",t,e.buttons[t])):!e.buttons[t].pressed&&this.buttons[t]&&this.emit(new rt("gamepadbuttonup",t,e.buttons[t])),this.buttons[t]=e.buttons[t].pressed;else Object.keys(this.buttons)&&(this.buttons={})},emit:function(e){this.el.emit(e.type,e),this.el.emit(e.type+":"+e.index,new rt(e.type,e.index,e))},getGamepad:function(){const e=[],t=[];return function(i){const r=this.el.sceneEl.components["proxy-controls"],c=r&&r.isConnected()&&r.getGamepad(0);if(c)return c;e.length=0;for(let m=0;m<this.system.controllers.length;m++){const E=this.system.controllers[m],w=E?E.gamepad:null;if(e.push(w),w&&w.handedness===i)return w}const d=navigator.getGamepads?navigator.getGamepads():t;for(let m=0;m<d.length;m++){const E=d[m];if(E&&E.hand===i)return E}return e[0]||d[0]}}(),getButton:function(e){return this.getGamepad(we.RIGHT).buttons[e]},getAxis:function(e){return this.getGamepad(e>1?we.RIGHT:we.LEFT).axes[e]},getJoystick:function(e,t){const i=this.getGamepad(e===xe.MOVEMENT?we.LEFT:we.RIGHT);if(i.mapping==="xr-standard")switch(e){case xe.MOVEMENT:return t.set(i.axes[2],i.axes[3]);case xe.ROTATION:return t.set(i.axes[0],i.axes[1])}else switch(e){case xe.MOVEMENT:return t.set(i.axes[0],i.axes[1]);case xe.ROTATION:return t.set(i.axes[2],i.axes[3])}throw new Error('Unexpected joystick index "%d".',e)},getDpad:function(e){const t=this.getGamepad(we.LEFT);return t.buttons[Fe.DPAD_RIGHT]?e.set((t.buttons[Fe.DPAD_RIGHT].pressed?1:0)+(t.buttons[Fe.DPAD_LEFT].pressed?-1:0),(t.buttons[Fe.DPAD_UP].pressed?-1:0)+(t.buttons[Fe.DPAD_DOWN].pressed?1:0)):e.set(0,0)},isConnected:function(){const e=this.getGamepad(we.LEFT);return!!(e&&e.connected)},getID:function(){return this.getGamepad(we.LEFT).id}});(function(e){var t="KeyboardEvent"in e;t||(e.KeyboardEvent=function(){throw TypeError("Illegal constructor")}),"DOM_KEY_LOCATION_STANDARD"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_STANDARD=0),"DOM_KEY_LOCATION_LEFT"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_LEFT=1),"DOM_KEY_LOCATION_RIGHT"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_RIGHT=2),"DOM_KEY_LOCATION_NUMPAD"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_NUMPAD=3);var i=window.KeyboardEvent.DOM_KEY_LOCATION_STANDARD,r=window.KeyboardEvent.DOM_KEY_LOCATION_LEFT,c=window.KeyboardEvent.DOM_KEY_LOCATION_RIGHT,d=window.KeyboardEvent.DOM_KEY_LOCATION_NUMPAD;function m(V,X){return String(V).indexOf(X)!==-1}var E=function(){return m(navigator.platform,"Win")?"win":m(navigator.platform,"Mac")?"mac":m(navigator.platform,"CrOS")?"cros":m(navigator.platform,"Linux")?"linux":m(navigator.userAgent,"iPad")||m(navigator.platform,"iPod")||m(navigator.platform,"iPhone")?"ios":""}(),w=function(){return m(navigator.userAgent,"Chrome/")?"chrome":m(navigator.vendor,"Apple")?"safari":m(navigator.userAgent,"MSIE")?"ie":m(navigator.userAgent,"Gecko/")?"moz":m(navigator.userAgent,"Opera/")?"opera":""}(),L=w+"-"+E;function R(V,X,K){(L===X||w===X||E===X)&&Object.keys(K).forEach(function(se){V[se]=K[se]})}function B(V,X){var K={};return Object.keys(V).forEach(function(se){var oe=V[se];X in oe&&(K[oe[X]]=oe)}),K}var O={3:{code:"Cancel"},6:{code:"Help"},8:{code:"Backspace"},9:{code:"Tab"},12:{code:"Clear"},13:{code:"Enter"},16:{code:"Shift"},17:{code:"Control"},18:{code:"Alt"},19:{code:"Pause"},20:{code:"CapsLock"},21:{code:"KanaMode"},22:{code:"HangulMode"},23:{code:"JunjaMode"},24:{code:"FinalMode"},25:{code:"KanjiMode"},27:{code:"Escape"},28:{code:"Convert"},29:{code:"NonConvert"},30:{code:"Accept"},31:{code:"ModeChange"},32:{code:"Space"},33:{code:"PageUp"},34:{code:"PageDown"},35:{code:"End"},36:{code:"Home"},37:{code:"ArrowLeft"},38:{code:"ArrowUp"},39:{code:"ArrowRight"},40:{code:"ArrowDown"},41:{code:"Select"},42:{code:"Print"},43:{code:"Execute"},44:{code:"PrintScreen"},45:{code:"Insert"},46:{code:"Delete"},47:{code:"Help"},48:{code:"Digit0",keyCap:"0"},49:{code:"Digit1",keyCap:"1"},50:{code:"Digit2",keyCap:"2"},51:{code:"Digit3",keyCap:"3"},52:{code:"Digit4",keyCap:"4"},53:{code:"Digit5",keyCap:"5"},54:{code:"Digit6",keyCap:"6"},55:{code:"Digit7",keyCap:"7"},56:{code:"Digit8",keyCap:"8"},57:{code:"Digit9",keyCap:"9"},65:{code:"KeyA",keyCap:"a"},66:{code:"KeyB",keyCap:"b"},67:{code:"KeyC",keyCap:"c"},68:{code:"KeyD",keyCap:"d"},69:{code:"KeyE",keyCap:"e"},70:{code:"KeyF",keyCap:"f"},71:{code:"KeyG",keyCap:"g"},72:{code:"KeyH",keyCap:"h"},73:{code:"KeyI",keyCap:"i"},74:{code:"KeyJ",keyCap:"j"},75:{code:"KeyK",keyCap:"k"},76:{code:"KeyL",keyCap:"l"},77:{code:"KeyM",keyCap:"m"},78:{code:"KeyN",keyCap:"n"},79:{code:"KeyO",keyCap:"o"},80:{code:"KeyP",keyCap:"p"},81:{code:"KeyQ",keyCap:"q"},82:{code:"KeyR",keyCap:"r"},83:{code:"KeyS",keyCap:"s"},84:{code:"KeyT",keyCap:"t"},85:{code:"KeyU",keyCap:"u"},86:{code:"KeyV",keyCap:"v"},87:{code:"KeyW",keyCap:"w"},88:{code:"KeyX",keyCap:"x"},89:{code:"KeyY",keyCap:"y"},90:{code:"KeyZ",keyCap:"z"},91:{code:"OSLeft",location:r},92:{code:"OSRight",location:c},93:{code:"ContextMenu"},95:{code:"Standby"},96:{code:"Numpad0",keyCap:"0",location:d},97:{code:"Numpad1",keyCap:"1",location:d},98:{code:"Numpad2",keyCap:"2",location:d},99:{code:"Numpad3",keyCap:"3",location:d},100:{code:"Numpad4",keyCap:"4",location:d},101:{code:"Numpad5",keyCap:"5",location:d},102:{code:"Numpad6",keyCap:"6",location:d},103:{code:"Numpad7",keyCap:"7",location:d},104:{code:"Numpad8",keyCap:"8",location:d},105:{code:"Numpad9",keyCap:"9",location:d},106:{code:"NumpadMultiply",keyCap:"*",location:d},107:{code:"NumpadAdd",keyCap:"+",location:d},108:{code:"NumpadComma",keyCap:",",location:d},109:{code:"NumpadSubtract",keyCap:"-",location:d},110:{code:"NumpadDecimal",keyCap:".",location:d},111:{code:"NumpadDivide",keyCap:"/",location:d},112:{code:"F1"},113:{code:"F2"},114:{code:"F3"},115:{code:"F4"},116:{code:"F5"},117:{code:"F6"},118:{code:"F7"},119:{code:"F8"},120:{code:"F9"},121:{code:"F10"},122:{code:"F11"},123:{code:"F12"},124:{code:"F13"},125:{code:"F14"},126:{code:"F15"},127:{code:"F16"},128:{code:"F17"},129:{code:"F18"},130:{code:"F19"},131:{code:"F20"},132:{code:"F21"},133:{code:"F22"},134:{code:"F23"},135:{code:"F24"},144:{code:"NumLock",location:d},145:{code:"ScrollLock"},160:{code:"ShiftLeft",location:r},161:{code:"ShiftRight",location:c},162:{code:"ControlLeft",location:r},163:{code:"ControlRight",location:c},164:{code:"AltLeft",location:r},165:{code:"AltRight",location:c},166:{code:"BrowserBack"},167:{code:"BrowserForward"},168:{code:"BrowserRefresh"},169:{code:"BrowserStop"},170:{code:"BrowserSearch"},171:{code:"BrowserFavorites"},172:{code:"BrowserHome"},173:{code:"VolumeMute"},174:{code:"VolumeDown"},175:{code:"VolumeUp"},176:{code:"MediaTrackNext"},177:{code:"MediaTrackPrevious"},178:{code:"MediaStop"},179:{code:"MediaPlayPause"},180:{code:"LaunchMail"},181:{code:"MediaSelect"},182:{code:"LaunchApp1"},183:{code:"LaunchApp2"},186:{code:"Semicolon",keyCap:";"},187:{code:"Equal",keyCap:"="},188:{code:"Comma",keyCap:","},189:{code:"Minus",keyCap:"-"},190:{code:"Period",keyCap:"."},191:{code:"Slash",keyCap:"/"},192:{code:"Backquote",keyCap:"`"},219:{code:"BracketLeft",keyCap:"["},220:{code:"Backslash",keyCap:"\\"},221:{code:"BracketRight",keyCap:"]"},222:{code:"Quote",keyCap:"'"},226:{code:"IntlBackslash",keyCap:"\\"},229:{code:"Process"},246:{code:"Attn"},247:{code:"CrSel"},248:{code:"ExSel"},249:{code:"EraseEof"},250:{code:"Play"},251:{code:"ZoomToggle"},254:{code:"Clear"}};R(O,"moz",{59:{code:"Semicolon",keyCap:";"},61:{code:"Equal",keyCap:"="},107:{code:"Equal",keyCap:"="},109:{code:"Minus",keyCap:"-"},187:{code:"NumpadAdd",keyCap:"+",location:d},189:{code:"NumpadSubtract",keyCap:"-",location:d}}),R(O,"moz-mac",{12:{code:"NumLock",location:d},173:{code:"Minus",keyCap:"-"}}),R(O,"moz-win",{173:{code:"Minus",keyCap:"-"}}),R(O,"chrome-mac",{93:{code:"OSRight",location:c}}),R(O,"safari",{3:{code:"Enter"},25:{code:"Tab"}}),R(O,"ios",{10:{code:"Enter",location:i}}),R(O,"safari-mac",{91:{code:"OSLeft",location:r},93:{code:"OSRight",location:c},229:{code:"KeyQ",keyCap:"Q"}});var M={};E==="cros"&&(M["U+00A0"]={code:"ShiftLeft",location:r},M["U+00A1"]={code:"ShiftRight",location:c},M["U+00A2"]={code:"ControlLeft",location:r},M["U+00A3"]={code:"ControlRight",location:c},M["U+00A4"]={code:"AltLeft",location:r},M["U+00A5"]={code:"AltRight",location:c}),L==="chrome-mac"&&(M["U+0010"]={code:"ContextMenu"}),L==="safari-mac"&&(M["U+0010"]={code:"ContextMenu"}),E==="ios"&&(M["U+0010"]={code:"Function"},M["U+001C"]={code:"ArrowLeft"},M["U+001D"]={code:"ArrowRight"},M["U+001E"]={code:"ArrowUp"},M["U+001F"]={code:"ArrowDown"},M["U+0001"]={code:"Home"},M["U+0004"]={code:"End"},M["U+000B"]={code:"PageUp"},M["U+000C"]={code:"PageDown"});var N=[];N[r]={16:{code:"ShiftLeft",location:r},17:{code:"ControlLeft",location:r},18:{code:"AltLeft",location:r}},N[c]={16:{code:"ShiftRight",location:c},17:{code:"ControlRight",location:c},18:{code:"AltRight",location:c}},N[d]={13:{code:"NumpadEnter",location:d}},R(N[d],"moz",{109:{code:"NumpadSubtract",location:d},107:{code:"NumpadAdd",location:d}}),R(N[r],"moz-mac",{224:{code:"OSLeft",location:r}}),R(N[c],"moz-mac",{224:{code:"OSRight",location:c}}),R(N[c],"moz-win",{91:{code:"OSRight",location:c}}),R(N[c],"mac",{93:{code:"OSRight",location:c}}),R(N[d],"chrome-mac",{12:{code:"NumLock",location:d}}),R(N[d],"safari-mac",{12:{code:"NumLock",location:d},187:{code:"NumpadAdd",location:d},189:{code:"NumpadSubtract",location:d},190:{code:"NumpadDecimal",location:d},191:{code:"NumpadDivide",location:d}});var re={ShiftLeft:{key:"Shift"},ShiftRight:{key:"Shift"},ControlLeft:{key:"Control"},ControlRight:{key:"Control"},AltLeft:{key:"Alt"},AltRight:{key:"Alt"},OSLeft:{key:"OS"},OSRight:{key:"OS"},NumpadEnter:{key:"Enter"},Space:{key:" "},Digit0:{key:"0",shiftKey:")"},Digit1:{key:"1",shiftKey:"!"},Digit2:{key:"2",shiftKey:"@"},Digit3:{key:"3",shiftKey:"#"},Digit4:{key:"4",shiftKey:"$"},Digit5:{key:"5",shiftKey:"%"},Digit6:{key:"6",shiftKey:"^"},Digit7:{key:"7",shiftKey:"&"},Digit8:{key:"8",shiftKey:"*"},Digit9:{key:"9",shiftKey:"("},KeyA:{key:"a",shiftKey:"A"},KeyB:{key:"b",shiftKey:"B"},KeyC:{key:"c",shiftKey:"C"},KeyD:{key:"d",shiftKey:"D"},KeyE:{key:"e",shiftKey:"E"},KeyF:{key:"f",shiftKey:"F"},KeyG:{key:"g",shiftKey:"G"},KeyH:{key:"h",shiftKey:"H"},KeyI:{key:"i",shiftKey:"I"},KeyJ:{key:"j",shiftKey:"J"},KeyK:{key:"k",shiftKey:"K"},KeyL:{key:"l",shiftKey:"L"},KeyM:{key:"m",shiftKey:"M"},KeyN:{key:"n",shiftKey:"N"},KeyO:{key:"o",shiftKey:"O"},KeyP:{key:"p",shiftKey:"P"},KeyQ:{key:"q",shiftKey:"Q"},KeyR:{key:"r",shiftKey:"R"},KeyS:{key:"s",shiftKey:"S"},KeyT:{key:"t",shiftKey:"T"},KeyU:{key:"u",shiftKey:"U"},KeyV:{key:"v",shiftKey:"V"},KeyW:{key:"w",shiftKey:"W"},KeyX:{key:"x",shiftKey:"X"},KeyY:{key:"y",shiftKey:"Y"},KeyZ:{key:"z",shiftKey:"Z"},Numpad0:{key:"0"},Numpad1:{key:"1"},Numpad2:{key:"2"},Numpad3:{key:"3"},Numpad4:{key:"4"},Numpad5:{key:"5"},Numpad6:{key:"6"},Numpad7:{key:"7"},Numpad8:{key:"8"},Numpad9:{key:"9"},NumpadMultiply:{key:"*"},NumpadAdd:{key:"+"},NumpadComma:{key:","},NumpadSubtract:{key:"-"},NumpadDecimal:{key:"."},NumpadDivide:{key:"/"},Semicolon:{key:";",shiftKey:":"},Equal:{key:"=",shiftKey:"+"},Comma:{key:",",shiftKey:"<"},Minus:{key:"-",shiftKey:"_"},Period:{key:".",shiftKey:">"},Slash:{key:"/",shiftKey:"?"},Backquote:{key:"`",shiftKey:"~"},BracketLeft:{key:"[",shiftKey:"{"},Backslash:{key:"\\",shiftKey:"|"},BracketRight:{key:"]",shiftKey:"}"},Quote:{key:"'",shiftKey:'"'},IntlBackslash:{key:"\\",shiftKey:"|"}};R(re,"mac",{OSLeft:{key:"Meta"},OSRight:{key:"Meta"}});var ae={Esc:"Escape",Nonconvert:"NonConvert",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Menu:"ContextMenu",MediaNextTrack:"MediaTrackNext",MediaPreviousTrack:"MediaTrackPrevious",SelectMedia:"MediaSelect",HalfWidth:"Hankaku",FullWidth:"Zenkaku",RomanCharacters:"Romaji",Crsel:"CrSel",Exsel:"ExSel",Zoom:"ZoomToggle"},ie=B(O,"code");try{var ge=t&&"location"in new KeyboardEvent("")}catch{}function Ee(V){var X="keyCode"in V?V.keyCode:"which"in V?V.which:0,K=function(){if(ge||"keyLocation"in V){var oe=ge?V.location:V.keyLocation;if(oe&&X in N[oe])return N[oe][X]}return"keyIdentifier"in V&&V.keyIdentifier in M?M[V.keyIdentifier]:X in O?O[X]:null}();if(!K)return null;var se=function(){var oe=re[K.code];return oe?V.shiftKey&&"shiftKey"in oe?oe.shiftKey:oe.key:K.code}();return{code:K.code,key:se,location:K.location,keyCap:K.keyCap}}function Ae(V,X){if(V=String(V),!ie.hasOwnProperty(V))return"Undefined";if(X&&String(X).toLowerCase()!=="en-us")throw Error("Unsupported locale");var K=ie[V];return K.keyCap||K.code||"Undefined"}"KeyboardEvent"in e&&"defineProperty"in Object&&function(){function V(K,se,oe){se in K||Object.defineProperty(K,se,oe)}if(V(KeyboardEvent.prototype,"code",{get:function(){var K=Ee(this);return K?K.code:""}}),"key"in KeyboardEvent.prototype){var X=Object.getOwnPropertyDescriptor(KeyboardEvent.prototype,"key");Object.defineProperty(KeyboardEvent.prototype,"key",{get:function(){var K=X.get.call(this);return ae.hasOwnProperty(K)?ae[K]:K}})}V(KeyboardEvent.prototype,"key",{get:function(){var K=Ee(this);return K&&"key"in K?K.key:"Unidentified"}}),V(KeyboardEvent.prototype,"location",{get:function(){var K=Ee(this);return K&&"location"in K?K.location:i}}),V(KeyboardEvent.prototype,"locale",{get:function(){return""}})}(),"queryKeyCap"in e.KeyboardEvent||(e.KeyboardEvent.queryKeyCap=Ae),e.identifyKey=function(V){if(!("code"in V)){var X=Ee(V);V.code=X?X.code:"",V.key=X&&"key"in X?X.key:"Unidentified",V.location="location"in V?V.location:"keyLocation"in V?V.keyLocation:X&&"location"in X?X.location:i,V.locale=""}}})(window);const qi="__keyboard-controls-proxy",Xi=window.KeyboardEvent;AFRAME.registerComponent("keyboard-controls",{schema:{enabled:{default:!0},debug:{default:!1}},init:function(){this.dVelocity=new THREE.Vector3,this.localKeys={},this.listeners={keydown:this.onKeyDown.bind(this),keyup:this.onKeyUp.bind(this),blur:this.onBlur.bind(this)},this.attachEventListeners()},isVelocityActive:function(){return this.data.enabled&&!!Object.keys(this.getKeys()).length},getVelocityDelta:function(){const e=this.data,t=this.getKeys();return this.dVelocity.set(0,0,0),e.enabled&&((t.KeyW||t.ArrowUp)&&(this.dVelocity.z-=1),(t.KeyA||t.ArrowLeft)&&(this.dVelocity.x-=1),(t.KeyS||t.ArrowDown)&&(this.dVelocity.z+=1),(t.KeyD||t.ArrowRight)&&(this.dVelocity.x+=1)),this.dVelocity.clone()},play:function(){this.attachEventListeners()},pause:function(){this.removeEventListeners()},remove:function(){this.pause()},attachEventListeners:function(){window.addEventListener("keydown",this.listeners.keydown,!1),window.addEventListener("keyup",this.listeners.keyup,!1),window.addEventListener("blur",this.listeners.blur,!1)},removeEventListeners:function(){window.removeEventListener("keydown",this.listeners.keydown),window.removeEventListener("keyup",this.listeners.keyup),window.removeEventListener("blur",this.listeners.blur)},onKeyDown:function(e){AFRAME.utils.shouldCaptureKeyEvent(e)&&(this.localKeys[e.code]=!0,this.emit(e))},onKeyUp:function(e){AFRAME.utils.shouldCaptureKeyEvent(e)&&(delete this.localKeys[e.code],this.emit(e))},onBlur:function(){for(let e in this.localKeys)this.localKeys.hasOwnProperty(e)&&delete this.localKeys[e]},emit:function(e){qi in e&&this.el.emit(e.type,e),this.el.emit(e.type+":"+e.code,new Xi(e.type,e)),this.data.debug&&console.log(e.type+":"+e.code)},isPressed:function(e){return e in this.getKeys()},getKeys:function(){return this.isProxied()?this.el.sceneEl.components["proxy-controls"].getKeyboard():this.localKeys},isProxied:function(){const e=this.el.sceneEl.components["proxy-controls"];return e&&e.isConnected()}});AFRAME.registerComponent("touch-controls",{schema:{enabled:{default:!0},reverseEnabled:{default:!0}},init:function(){this.dVelocity=new THREE.Vector3,this.bindMethods(),this.direction=0},play:function(){this.addEventListeners()},pause:function(){this.removeEventListeners(),this.dVelocity.set(0,0,0)},remove:function(){this.pause()},addEventListeners:function(){const e=this.el.sceneEl,t=e.canvas;if(!t){e.addEventListener("render-target-loaded",this.addEventListeners.bind(this));return}t.addEventListener("touchstart",this.onTouchStart),t.addEventListener("touchend",this.onTouchEnd)},removeEventListeners:function(){const e=this.el.sceneEl&&this.el.sceneEl.canvas;!e||(e.removeEventListener("touchstart",this.onTouchStart),e.removeEventListener("touchend",this.onTouchEnd))},isVelocityActive:function(){return this.data.enabled&&!!this.direction},getVelocityDelta:function(){return this.dVelocity.z=this.direction,this.dVelocity.clone()},bindMethods:function(){this.onTouchStart=this.onTouchStart.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this)},onTouchStart:function(e){this.direction=-1,this.data.reverseEnabled&&e.touches.length===2&&(this.direction=1),e.preventDefault()},onTouchEnd:function(e){this.direction=0,e.preventDefault()}});const Lt="-controls",Wi=.2,Zi=1e-5;AFRAME.registerComponent("movement-controls",{dependencies:["rotation"],schema:{enabled:{default:!0},controls:{default:["gamepad","trackpad","keyboard","touch"]},speed:{default:.3,min:0},fly:{default:!1},constrainToNavMesh:{default:!1},camera:{default:"[movement-controls] [camera]",type:"selector"}},init:function(){const e=this.el;this.velocityCtrl=null,this.velocity=new THREE.Vector3,this.heading=new THREE.Quaternion,this.navGroup=null,this.navNode=null,e.sceneEl.hasLoaded?this.injectControls():e.sceneEl.addEventListener("loaded",this.injectControls.bind(this))},update:function(e){const t=this.el,i=this.data,r=t.sceneEl.systems.nav;t.sceneEl.hasLoaded&&this.injectControls(),r&&i.constrainToNavMesh!==e.constrainToNavMesh&&(i.constrainToNavMesh?r.addAgent(this):r.removeAgent(this))},injectControls:function(){const e=this.data;var t;for(let i=0;i<e.controls.length;i++)t=e.controls[i]+Lt,this.el.components[t]||this.el.setAttribute(t,"")},updateNavLocation:function(){this.navGroup=null,this.navNode=null},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3;return function(r,c){if(!c)return;const d=this.el,m=this.data;if(!m.enabled)return;this.updateVelocityCtrl();const E=this.velocityCtrl,w=this.velocity;if(!!E)if(c/1e3>Wi?w.set(0,0,0):this.updateVelocity(c),m.constrainToNavMesh&&E.isNavMeshConstrained!==!1){if(w.lengthSq()<Zi)return;e.copy(d.object3D.position),t.copy(w).multiplyScalar(c/1e3).add(e);const L=d.sceneEl.systems.nav;this.navGroup=this.navGroup===null?L.getGroup(e):this.navGroup,this.navNode=this.navNode||L.getNode(e,this.navGroup),this.navNode=L.clampStep(e,t,this.navGroup,this.navNode,i),d.object3D.position.copy(i)}else d.hasAttribute("velocity")?d.setAttribute("velocity",w):(d.object3D.position.x+=w.x*c/1e3,d.object3D.position.y+=w.y*c/1e3,d.object3D.position.z+=w.z*c/1e3)}}(),updateVelocityCtrl:function(){const e=this.data;if(e.enabled){for(let t=0,i=e.controls.length;t<i;t++){const r=this.el.components[e.controls[t]+Lt];if(r&&r.isVelocityActive()){this.velocityCtrl=r;return}}this.velocityCtrl=null}},updateVelocity:function(){const e=new THREE.Vector2,t=new THREE.Quaternion;return function(i){let r;const c=this.el,d=this.velocityCtrl,m=this.velocity,E=this.data;if(d)if(d.getVelocityDelta)r=d.getVelocityDelta(i);else if(d.getVelocity){m.copy(d.getVelocity());return}else if(d.getPositionDelta){m.copy(d.getPositionDelta(i).multiplyScalar(1e3/i));return}else throw new Error("Incompatible movement controls: ",d);if(c.hasAttribute("velocity")&&!E.constrainToNavMesh&&m.copy(this.el.getAttribute("velocity")),r&&E.enabled){const w=E.camera;t.copy(w.object3D.quaternion),t.premultiply(c.object3D.quaternion),r.applyQuaternion(t);const L=r.length();E.fly?(m.copy(r),m.multiplyScalar(this.data.speed*16.66667)):(e.set(r.x,r.z),e.setLength(L*this.data.speed*16.66667),m.x=e.x,m.z=e.y)}}}()});AFRAME.registerComponent("trackpad-controls",{schema:{enabled:{default:!0},enableNegX:{default:!0},enablePosX:{default:!0},enableNegZ:{default:!0},enablePosZ:{default:!0},mode:{default:"touch",oneOf:["swipe","touch","press"]}},init:function(){this.dVelocity=new THREE.Vector3,this.zVel=0,this.xVel=0,this.bindMethods()},play:function(){this.addEventListeners()},pause:function(){this.removeEventListeners(),this.dVelocity.set(0,0,0)},remove:function(){this.pause()},addEventListeners:function(){const e=this.data,t=this.el.sceneEl;switch(t.addEventListener("axismove",this.onAxisMove),e.mode){case"swipe":case"touch":t.addEventListener("trackpadtouchstart",this.onTouchStart),t.addEventListener("trackpadtouchend",this.onTouchEnd);break;case"press":t.addEventListener("trackpaddown",this.onTouchStart),t.addEventListener("trackpadup",this.onTouchEnd);break}},removeEventListeners:function(){const e=this.el.sceneEl;e.removeEventListener("axismove",this.onAxisMove),e.removeEventListener("trackpadtouchstart",this.onTouchStart),e.removeEventListener("trackpadtouchend",this.onTouchEnd),e.removeEventListener("trackpaddown",this.onTouchStart),e.removeEventListener("trackpadup",this.onTouchEnd)},isVelocityActive:function(){return this.data.enabled&&this.isMoving},getVelocityDelta:function(){return this.dVelocity.z=this.isMoving?-this.zVel:1,this.dVelocity.x=this.isMoving?this.xVel:1,this.dVelocity.clone()},bindMethods:function(){this.onTouchStart=this.onTouchStart.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.onAxisMove=this.onAxisMove.bind(this)},onTouchStart:function(e){switch(this.data.mode){case"swipe":this.canRecordAxis=!0,this.startingAxisData=[];break;case"touch":this.isMoving=!0;break;case"press":this.isMoving=!0;break}e.preventDefault()},onTouchEnd:function(e){this.data.mode=="swipe"&&(this.startingAxisData=[]),this.isMoving=!1,e.preventDefault()},onAxisMove:function(e){switch(this.data.mode){case"swipe":return this.handleSwipeAxis(e);case"touch":case"press":return this.handleTouchAxis(e)}},handleSwipeAxis:function(e){const t=this.data,i=e.detail.axis;if(this.startingAxisData.length===0&&this.canRecordAxis&&(this.canRecordAxis=!1,this.startingAxisData[0]=i[0],this.startingAxisData[1]=i[1]),this.startingAxisData.length>0){let r=0,c=0;t.enableNegX&&i[0]<this.startingAxisData[0]&&(r=-1),t.enablePosX&&i[0]>this.startingAxisData[0]&&(r=1),t.enablePosZ&&i[1]>this.startingAxisData[1]&&(c=-1),t.enableNegZ&&i[1]<this.startingAxisData[1]&&(c=1);const d=Math.abs(this.startingAxisData[1]-i[1]);Math.abs(this.startingAxisData[0]-i[0])>d?(this.zVel=0,this.xVel=r,this.isMoving=!0):(this.xVel=0,this.zVel=c,this.isMoving=!0)}},handleTouchAxis:function(e){const t=this.data,i=e.detail.axis;let r=0,c=0;t.enableNegX&&i[0]<0&&(r=-1),t.enablePosX&&i[0]>0&&(r=1),t.enablePosZ&&i[1]>0&&(c=-1),t.enableNegZ&&i[1]<0&&(c=1),Math.abs(i[0])>Math.abs(i[1])?(this.zVel=0,this.xVel=r):(this.xVel=0,this.zVel=c)}});const at={once:THREE.LoopOnce,repeat:THREE.LoopRepeat,pingpong:THREE.LoopPingPong};AFRAME.registerComponent("animation-mixer",{schema:{clip:{default:"*"},duration:{default:0},clampWhenFinished:{default:!1,type:"boolean"},crossFadeDuration:{default:0},loop:{default:"repeat",oneOf:Object.keys(at)},repetitions:{default:1/0,min:0},timeScale:{default:1}},init:function(){this.model=null,this.mixer=null,this.activeActions=[];const e=this.el.getObject3D("mesh");e?this.load(e):this.el.addEventListener("model-loaded",t=>{this.load(t.detail.model)})},load:function(e){const t=this.el;this.model=e,this.mixer=new THREE.AnimationMixer(e),this.mixer.addEventListener("loop",i=>{t.emit("animation-loop",{action:i.action,loopDelta:i.loopDelta})}),this.mixer.addEventListener("finished",i=>{t.emit("animation-finished",{action:i.action,direction:i.direction})}),this.data.clip&&this.update({})},remove:function(){this.mixer&&this.mixer.stopAllAction()},update:function(e){if(!e)return;const t=this.data,i=AFRAME.utils.diff(t,e);if("clip"in i){this.stopAction(),t.clip&&this.playAction();return}this.activeActions.forEach(r=>{"duration"in i&&t.duration&&r.setDuration(t.duration),"clampWhenFinished"in i&&(r.clampWhenFinished=t.clampWhenFinished),("loop"in i||"repetitions"in i)&&r.setLoop(at[t.loop],t.repetitions),"timeScale"in i&&r.setEffectiveTimeScale(t.timeScale)})},stopAction:function(){const e=this.data;for(let t=0;t<this.activeActions.length;t++)e.crossFadeDuration?this.activeActions[t].fadeOut(e.crossFadeDuration):this.activeActions[t].stop();this.activeActions.length=0},playAction:function(){if(!this.mixer)return;const e=this.model,t=this.data,i=e.animations||(e.geometry||{}).animations||[];if(!i.length)return;const r=Ji(t.clip);for(let c,d=0;c=i[d];d++)if(c.name.match(r)){const m=this.mixer.clipAction(c,e);m.enabled=!0,m.clampWhenFinished=t.clampWhenFinished,t.duration&&m.setDuration(t.duration),t.timeScale!==1&&m.setEffectiveTimeScale(t.timeScale),m.setLoop(at[t.loop],t.repetitions).fadeIn(t.crossFadeDuration).play(),this.activeActions.push(m)}},tick:function(e,t){this.mixer&&!isNaN(t)&&this.mixer.update(t/1e3)}});function Ji(e){return new RegExp("^"+e.split(/\*+/).map(Yi).join(".*")+"$")}function Yi(e){return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&")}var $i=THREE.ColladaLoader=function(e){this.manager=e!==void 0?e:THREE.DefaultLoadingManager};THREE.ColladaLoader.prototype={constructor:THREE.ColladaLoader,crossOrigin:"anonymous",load:function(e,t,i,r){var c=this,d=c.path===void 0?THREE.LoaderUtils.extractUrlBase(e):c.path,m=new THREE.FileLoader(c.manager);m.setPath(c.path),m.load(e,function(E){t(c.parse(E,d))},i,r)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},options:{set convertUpAxis(e){console.warn("THREE.ColladaLoader: options.convertUpAxis() has been removed. Up axis is converted automatically.")}},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e,t){function i(a,s){for(var h=[],v=a.childNodes,u=0,b=v.length;u<b;u++){var k=v[u];k.nodeName===s&&h.push(k)}return h}function r(a){if(a.length===0)return[];for(var s=a.trim().split(/\s+/),h=new Array(s.length),v=0,u=s.length;v<u;v++)h[v]=s[v];return h}function c(a){if(a.length===0)return[];for(var s=a.trim().split(/\s+/),h=new Array(s.length),v=0,u=s.length;v<u;v++)h[v]=parseFloat(s[v]);return h}function d(a){if(a.length===0)return[];for(var s=a.trim().split(/\s+/),h=new Array(s.length),v=0,u=s.length;v<u;v++)h[v]=parseInt(s[v]);return h}function m(a){return a.substring(1)}function E(){return"three_default_"+Ri++}function w(a){return Object.keys(a).length===0}function L(a){return{unit:R(i(a,"unit")[0]),upAxis:B(i(a,"up_axis")[0])}}function R(a){return a!==void 0&&a.hasAttribute("meter")===!0?parseFloat(a.getAttribute("meter")):1}function B(a){return a!==void 0?a.textContent:"Y_UP"}function O(a,s,h,v){var u=i(a,s)[0];if(u!==void 0)for(var b=i(u,h),k=0;k<b.length;k++)v(b[k])}function M(a,s){for(var h in a){var v=a[h];v.build=s(a[h])}}function N(a,s){return a.build!==void 0||(a.build=s(a)),a.build}function re(a){for(var s={sources:{},samplers:{},channels:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1){var b;switch(u.nodeName){case"source":b=u.getAttribute("id"),s.sources[b]=$e(u);break;case"sampler":b=u.getAttribute("id"),s.samplers[b]=ae(u);break;case"channel":b=u.getAttribute("target"),s.channels[b]=ie(u);break;default:console.log(u)}}}G.animations[a.getAttribute("id")]=s}function ae(a){for(var s={inputs:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"input":var b=m(u.getAttribute("source")),k=u.getAttribute("semantic");s.inputs[k]=b;break}}return s}function ie(a){var s={},h=a.getAttribute("target"),v=h.split("/"),u=v.shift(),b=v.shift(),k=b.indexOf("(")!==-1,H=b.indexOf(".")!==-1;if(H)v=b.split("."),b=v.shift(),s.member=v.shift();else if(k){var D=b.split("(");b=D.shift();for(var j=0;j<D.length;j++)D[j]=parseInt(D[j].replace(/\)/,""));s.indices=D}return s.id=u,s.sid=b,s.arraySyntax=k,s.memberSyntax=H,s.sampler=m(a.getAttribute("source")),s}function ge(a){var s=[],h=a.channels,v=a.samplers,u=a.sources;for(var b in h)if(h.hasOwnProperty(b)){var k=h[b],H=v[k.sampler],D=H.inputs.INPUT,j=H.inputs.OUTPUT,_=u[D],z=u[j],Q=Ae(k,_,z);oe(Q,s)}return s}function Ee(a){return N(G.animations[a],ge)}function Ae(a,s,h){var v=G.nodes[a.id],u=De(v.id),b=v.transforms[a.sid],k=v.matrix.clone().transpose(),H,D,j,_,z,Q,q={};switch(b){case"matrix":for(j=0,_=s.array.length;j<_;j++)if(H=s.array[j],D=j*h.stride,q[H]===void 0&&(q[H]={}),a.arraySyntax===!0){var W=h.array[D],P=a.indices[0]+4*a.indices[1];q[H][P]=W}else for(z=0,Q=h.stride;z<Q;z++)q[H][z]=h.array[D+z];break;case"translate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',b);break;case"rotate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',b);break;case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',b);break}var Z=V(q,k),J={name:u.uuid,keyframes:Z};return J}function V(a,s){var h=[];for(var v in a)h.push({time:parseFloat(v),value:a[v]});h.sort(b);for(var u=0;u<16;u++)We(h,u,s.elements[u]);return h;function b(k,H){return k.time-H.time}}var X=new THREE.Vector3,K=new THREE.Vector3,se=new THREE.Quaternion;function oe(a,s){for(var h=a.keyframes,v=a.name,u=[],b=[],k=[],H=[],D=0,j=h.length;D<j;D++){var _=h[D],z=_.time,Q=_.value;ve.fromArray(Q).transpose(),ve.decompose(X,se,K),u.push(z),b.push(X.x,X.y,X.z),k.push(se.x,se.y,se.z,se.w),H.push(K.x,K.y,K.z)}return b.length>0&&s.push(new THREE.VectorKeyframeTrack(v+".position",u,b)),k.length>0&&s.push(new THREE.QuaternionKeyframeTrack(v+".quaternion",u,k)),H.length>0&&s.push(new THREE.VectorKeyframeTrack(v+".scale",u,H)),s}function We(a,s,h){var v,u=!0,b,k;for(b=0,k=a.length;b<k;b++)v=a[b],v.value[s]===void 0?v.value[s]=null:u=!1;if(u===!0)for(b=0,k=a.length;b<k;b++)v=a[b],v.value[s]=h;else Ze(a,s)}function Ze(a,s){for(var h,v,u=0,b=a.length;u<b;u++){var k=a[u];if(k.value[s]===null){if(h=je(a,u,s),v=n(a,u,s),h===null){k.value[s]=v.value[s];continue}if(v===null){k.value[s]=h.value[s];continue}o(k,h,v,s)}}}function je(a,s,h){for(;s>=0;){var v=a[s];if(v.value[h]!==null)return v;s--}return null}function n(a,s,h){for(;s<a.length;){var v=a[s];if(v.value[h]!==null)return v;s++}return null}function o(a,s,h,v){if(h.time-s.time===0){a.value[v]=s.value[v];return}a.value[v]=(a.time-s.time)*(h.value[v]-s.value[v])/(h.time-s.time)+s.value[v]}function l(a){for(var s={name:a.getAttribute("id")||"default",start:parseFloat(a.getAttribute("start")||0),end:parseFloat(a.getAttribute("end")||0),animations:[]},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"instance_animation":s.animations.push(m(u.getAttribute("url")));break}}G.clips[a.getAttribute("id")]=s}function f(a){for(var s=[],h=a.name,v=a.end-a.start||-1,u=a.animations,b=0,k=u.length;b<k;b++)for(var H=Ee(u[b]),D=0,j=H.length;D<j;D++)s.push(H[D]);return new THREE.AnimationClip(h,v,s)}function p(a){return N(G.clips[a],f)}function g(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"skin":s.id=m(u.getAttribute("source")),s.skin=y(u);break;case"morph":s.id=m(u.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.");break}}G.controllers[a.getAttribute("id")]=s}function y(a){for(var s={sources:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"bind_shape_matrix":s.bindShapeMatrix=c(u.textContent);break;case"source":var b=u.getAttribute("id");s.sources[b]=$e(u);break;case"joints":s.joints=T(u);break;case"vertex_weights":s.vertexWeights=C(u);break}}return s}function T(a){for(var s={inputs:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"input":var b=u.getAttribute("semantic"),k=m(u.getAttribute("source"));s.inputs[b]=k;break}}return s}function C(a){for(var s={inputs:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"input":var b=u.getAttribute("semantic"),k=m(u.getAttribute("source")),H=parseInt(u.getAttribute("offset"));s.inputs[b]={id:k,offset:H};break;case"vcount":s.vcount=d(u.textContent);break;case"v":s.v=d(u.textContent);break}}return s}function S(a){var s={id:a.id},h=G.geometries[s.id];return a.skin!==void 0&&(s.skin=A(a.skin),h.sources.skinIndices=s.skin.indices,h.sources.skinWeights=s.skin.weights),s}function A(a){var s=4,h={joints:[],indices:{array:[],stride:s},weights:{array:[],stride:s}},v=a.sources,u=a.vertexWeights,b=u.vcount,k=u.v,H=u.inputs.JOINT.offset,D=u.inputs.WEIGHT.offset,j=a.sources[a.joints.inputs.JOINT],_=a.sources[a.joints.inputs.INV_BIND_MATRIX],z=v[u.inputs.WEIGHT.id].array,Q=0,q,W,P;for(q=0,P=b.length;q<P;q++){var Z=b[q],J=[];for(W=0;W<Z;W++){var ee=k[Q+H],ne=k[Q+D],le=z[ne];J.push({index:ee,weight:le}),Q+=2}for(J.sort(nt),W=0;W<s;W++){var Y=J[W];Y!==void 0?(h.indices.array.push(Y.index),h.weights.array.push(Y.weight)):(h.indices.array.push(0),h.weights.array.push(0))}}for(a.bindShapeMatrix?h.bindMatrix=new THREE.Matrix4().fromArray(a.bindShapeMatrix).transpose():h.bindMatrix=new THREE.Matrix4().identity(),q=0,P=j.array.length;q<P;q++){var pe=j.array[q],U=new THREE.Matrix4().fromArray(_.array,q*_.stride).transpose();h.joints.push({name:pe,boneInverse:U})}return h;function nt(qe,Ci){return Ci.weight-qe.weight}}function I(a){return N(G.controllers[a],S)}function F(a){var s={init_from:i(a,"init_from")[0].textContent};G.images[a.getAttribute("id")]=s}function te(a){return a.build!==void 0?a.build:a.init_from}function de(a){var s=G.images[a];return s!==void 0?N(s,te):(console.warn("THREE.ColladaLoader: Couldn't find image with ID:",a),null)}function he(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"profile_COMMON":s.profile=fe(u);break}}G.effects[a.getAttribute("id")]=s}function fe(a){for(var s={surfaces:{},samplers:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"newparam":me(u,s);break;case"technique":s.technique=be(u);break;case"extra":s.extra=Ke(u);break}}return s}function me(a,s){for(var h=a.getAttribute("sid"),v=0,u=a.childNodes.length;v<u;v++){var b=a.childNodes[v];if(b.nodeType===1)switch(b.nodeName){case"surface":s.surfaces[h]=Ne(b);break;case"sampler2D":s.samplers[h]=Ve(b);break}}}function Ne(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"init_from":s.init_from=u.textContent;break}}return s}function Ve(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"source":s.source=u.textContent;break}}return s}function be(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"constant":case"lambert":case"blinn":case"phong":s.type=u.nodeName,s.parameters=Je(u);break}}return s}function Je(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":s[u.nodeName]=Te(u);break;case"transparent":s[u.nodeName]={opaque:u.getAttribute("opaque"),data:Te(u)};break}}return s}function Te(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"color":s[u.nodeName]=c(u.textContent);break;case"float":s[u.nodeName]=parseFloat(u.textContent);break;case"texture":s[u.nodeName]={id:u.getAttribute("texture"),extra:ke(u)};break}}return s}function ke(a){for(var s={technique:{}},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"extra":Re(u,s);break}}return s}function Re(a,s){for(var h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"technique":Ge(u,s);break}}}function Ge(a,s){for(var h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":s.technique[u.nodeName]=parseFloat(u.textContent);break;case"wrapU":case"wrapV":u.textContent.toUpperCase()==="TRUE"?s.technique[u.nodeName]=1:u.textContent.toUpperCase()==="FALSE"?s.technique[u.nodeName]=0:s.technique[u.nodeName]=parseInt(u.textContent);break}}}function Ke(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"technique":s.technique=Pe(u);break}}return s}function Pe(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"double_sided":s[u.nodeName]=parseInt(u.textContent);break}}return s}function Ue(a){return a}function Ye(a){return N(G.effects[a],Ue)}function Ft(a){for(var s={name:a.getAttribute("name")},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"instance_effect":s.url=m(u.getAttribute("url"));break}}G.materials[a.getAttribute("id")]=s}function Nt(a){var s,h=a.slice((a.lastIndexOf(".")-1>>>0)+2);switch(h=h.toLowerCase(),h){case"tga":s=et;break;default:s=Ct}return s}function ft(a){var s=Ye(a.url),h=s.profile.technique,v=s.profile.extra,u;switch(h.type){case"phong":case"blinn":u=new THREE.MeshPhongMaterial;break;case"lambert":u=new THREE.MeshLambertMaterial;break;default:u=new THREE.MeshBasicMaterial;break}u.name=a.name;function b(Q){var q=s.profile.samplers[Q.id],W=null;if(q!==void 0){var P=s.profile.surfaces[q.source];W=de(P.init_from)}else console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),W=de(Q.id);if(W!==null){var Z=Nt(W);if(Z!==void 0){var J=Z.load(W),ee=Q.extra;if(ee!==void 0&&ee.technique!==void 0&&w(ee.technique)===!1){var ne=ee.technique;J.wrapS=ne.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,J.wrapT=ne.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,J.offset.set(ne.offsetU||0,ne.offsetV||0),J.repeat.set(ne.repeatU||1,ne.repeatV||1)}else J.wrapS=THREE.RepeatWrapping,J.wrapT=THREE.RepeatWrapping;return J}else return console.warn("THREE.ColladaLoader: Loader for texture %s not found.",W),null}else return console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",Q.id),null}var k=h.parameters;for(var H in k){var D=k[H];switch(H){case"diffuse":D.color&&u.color.fromArray(D.color),D.texture&&(u.map=b(D.texture));break;case"specular":D.color&&u.specular&&u.specular.fromArray(D.color),D.texture&&(u.specularMap=b(D.texture));break;case"bump":D.texture&&(u.normalMap=b(D.texture));break;case"ambient":D.texture&&(u.lightMap=b(D.texture));break;case"shininess":D.float&&u.shininess&&(u.shininess=D.float);break;case"emission":D.color&&u.emissive&&u.emissive.fromArray(D.color),D.texture&&(u.emissiveMap=b(D.texture));break}}var j=k.transparent,_=k.transparency;if(_===void 0&&j&&(_={float:1}),j===void 0&&_&&(j={opaque:"A_ONE",data:{color:[1,1,1,1]}}),j&&_)if(j.data.texture)u.transparent=!0;else{var z=j.data.color;switch(j.opaque){case"A_ONE":u.opacity=z[3]*_.float;break;case"RGB_ZERO":u.opacity=1-z[0]*_.float;break;case"A_ZERO":u.opacity=1-z[3]*_.float;break;case"RGB_ONE":u.opacity=z[0]*_.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',j.opaque)}u.opacity<1&&(u.transparent=!0)}return v!==void 0&&v.technique!==void 0&&v.technique.double_sided===1&&(u.side=THREE.DoubleSide),u}function Pt(a){return N(G.materials[a],ft)}function It(a){for(var s={name:a.getAttribute("name")},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"optics":s.optics=Bt(u);break}}G.cameras[a.getAttribute("id")]=s}function Bt(a){for(var s=0;s<a.childNodes.length;s++){var h=a.childNodes[s];switch(h.nodeName){case"technique_common":return zt(h)}}return{}}function zt(a){for(var s={},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];switch(v.nodeName){case"perspective":case"orthographic":s.technique=v.nodeName,s.parameters=jt(v);break}}return s}function jt(a){for(var s={},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];switch(v.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":s[v.nodeName]=parseFloat(v.textContent);break}}return s}function pt(a){var s;switch(a.optics.technique){case"perspective":s=new THREE.PerspectiveCamera(a.optics.parameters.yfov,a.optics.parameters.aspect_ratio,a.optics.parameters.znear,a.optics.parameters.zfar);break;case"orthographic":var h=a.optics.parameters.ymag,v=a.optics.parameters.xmag,u=a.optics.parameters.aspect_ratio;v=v===void 0?h*u:v,h=h===void 0?v/u:h,v*=.5,h*=.5,s=new THREE.OrthographicCamera(-v,v,h,-h,a.optics.parameters.znear,a.optics.parameters.zfar);break;default:s=new THREE.PerspectiveCamera;break}return s.name=a.name,s}function Vt(a){var s=G.cameras[a];return s!==void 0?N(s,pt):(console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",a),null)}function Gt(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"technique_common":s=Kt(u);break}}G.lights[a.getAttribute("id")]=s}function Kt(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"directional":case"point":case"spot":case"ambient":s.technique=u.nodeName,s.parameters=Ut(u)}}return s}function Ut(a){for(var s={},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"color":var b=c(u.textContent);s.color=new THREE.Color().fromArray(b);break;case"falloff_angle":s.falloffAngle=parseFloat(u.textContent);break;case"quadratic_attenuation":var k=parseFloat(u.textContent);s.distance=k?Math.sqrt(1/k):0;break}}return s}function vt(a){var s;switch(a.technique){case"directional":s=new THREE.DirectionalLight;break;case"point":s=new THREE.PointLight;break;case"spot":s=new THREE.SpotLight;break;case"ambient":s=new THREE.AmbientLight;break}return a.parameters.color&&s.color.copy(a.parameters.color),a.parameters.distance&&(s.distance=a.parameters.distance),s}function qt(a){var s=G.lights[a];return s!==void 0?N(s,vt):(console.warn("THREE.ColladaLoader: Couldn't find light with ID:",a),null)}function Xt(a){var s={name:a.getAttribute("name"),sources:{},vertices:{},primitives:[]},h=i(a,"mesh")[0];if(h!==void 0){for(var v=0;v<h.childNodes.length;v++){var u=h.childNodes[v];if(u.nodeType===1){var b=u.getAttribute("id");switch(u.nodeName){case"source":s.sources[b]=$e(u);break;case"vertices":s.vertices=Wt(u);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",u.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":s.primitives.push(Zt(u));break;default:console.log(u)}}}G.geometries[a.getAttribute("id")]=s}}function $e(a){for(var s={array:[],stride:3},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"float_array":s.array=c(v.textContent);break;case"Name_array":s.array=r(v.textContent);break;case"technique_common":var u=i(v,"accessor")[0];u!==void 0&&(s.stride=parseInt(u.getAttribute("stride")));break}}return s}function Wt(a){for(var s={},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];v.nodeType===1&&(s[v.getAttribute("semantic")]=m(v.getAttribute("source")))}return s}function Zt(a){for(var s={type:a.nodeName,material:a.getAttribute("material"),count:parseInt(a.getAttribute("count")),inputs:{},stride:0,hasUV:!1},h=0,v=a.childNodes.length;h<v;h++){var u=a.childNodes[h];if(u.nodeType===1)switch(u.nodeName){case"input":var b=m(u.getAttribute("source")),k=u.getAttribute("semantic"),H=parseInt(u.getAttribute("offset")),D=parseInt(u.getAttribute("set")),j=D>0?k+D:k;s.inputs[j]={id:b,offset:H},s.stride=Math.max(s.stride,H+1),k==="TEXCOORD"&&(s.hasUV=!0);break;case"vcount":s.vcount=d(u.textContent);break;case"p":s.p=d(u.textContent);break}}return s}function Jt(a){for(var s={},h=0;h<a.length;h++){var v=a[h];s[v.type]===void 0&&(s[v.type]=[]),s[v.type].push(v)}return s}function Yt(a){for(var s=0,h=0,v=a.length;h<v;h++){var u=a[h];u.hasUV===!0&&s++}s>0&&s<a.length&&(a.uvsNeedsFix=!0)}function mt(a){var s={},h=a.sources,v=a.vertices,u=a.primitives;if(u.length===0)return{};var b=Jt(u);for(var k in b){var H=b[k];Yt(H),s[k]=$t(H,h,v)}return s}function $t(a,s,h){for(var v={},u={array:[],stride:0},b={array:[],stride:0},k={array:[],stride:0},H={array:[],stride:0},D={array:[],stride:0},j={array:[],stride:4},_={array:[],stride:4},z=new THREE.BufferGeometry,Q=[],q=0,W=0;W<a.length;W++){var P=a[W],Z=P.inputs,J=0;switch(P.type){case"lines":case"linestrips":J=P.count*2;break;case"triangles":J=P.count*3;break;case"polylist":for(var ee=0;ee<P.count;ee++){var ne=P.vcount[ee];switch(ne){case 3:J+=3;break;case 4:J+=6;break;default:J+=(ne-2)*3;break}}break;default:console.warn("THREE.ColladaLoader: Unknow primitive type:",P.type)}z.addGroup(q,J,W),q+=J,P.material&&Q.push(P.material);for(var le in Z){var Y=Z[le];switch(le){case"VERTEX":for(var pe in h){var U=h[pe];switch(pe){case"POSITION":var nt=u.array.length;if(ye(P,s[U],Y.offset,u.array),u.stride=s[U].stride,s.skinWeights&&s.skinIndices&&(ye(P,s.skinIndices,Y.offset,j.array),ye(P,s.skinWeights,Y.offset,_.array)),P.hasUV===!1&&a.uvsNeedsFix===!0)for(var J=(u.array.length-nt)/u.stride,qe=0;qe<J;qe++)k.array.push(0,0);break;case"NORMAL":ye(P,s[U],Y.offset,b.array),b.stride=s[U].stride;break;case"COLOR":ye(P,s[U],Y.offset,D.array),D.stride=s[U].stride;break;case"TEXCOORD":ye(P,s[U],Y.offset,k.array),k.stride=s[U].stride;break;case"TEXCOORD1":ye(P,s[U],Y.offset,H.array),k.stride=s[U].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',pe)}}break;case"NORMAL":ye(P,s[Y.id],Y.offset,b.array),b.stride=s[Y.id].stride;break;case"COLOR":ye(P,s[Y.id],Y.offset,D.array),D.stride=s[Y.id].stride;break;case"TEXCOORD":ye(P,s[Y.id],Y.offset,k.array),k.stride=s[Y.id].stride;break;case"TEXCOORD1":ye(P,s[Y.id],Y.offset,H.array),H.stride=s[Y.id].stride;break}}}return u.array.length>0&&z.addAttribute("position",new THREE.Float32BufferAttribute(u.array,u.stride)),b.array.length>0&&z.addAttribute("normal",new THREE.Float32BufferAttribute(b.array,b.stride)),D.array.length>0&&z.addAttribute("color",new THREE.Float32BufferAttribute(D.array,D.stride)),k.array.length>0&&z.addAttribute("uv",new THREE.Float32BufferAttribute(k.array,k.stride)),H.array.length>0&&z.addAttribute("uv2",new THREE.Float32BufferAttribute(H.array,H.stride)),j.array.length>0&&z.addAttribute("skinIndex",new THREE.Float32BufferAttribute(j.array,j.stride)),_.array.length>0&&z.addAttribute("skinWeight",new THREE.Float32BufferAttribute(_.array,_.stride)),v.data=z,v.type=a[0].type,v.materialKeys=Q,v}function ye(a,s,h,v){var u=a.p,b=a.stride,k=a.vcount;function H(le){for(var Y=u[le+h]*j,pe=Y+j;Y<pe;Y++)v.push(D[Y])}var D=s.array,j=s.stride;if(a.vcount!==void 0)for(var _=0,z=0,Q=k.length;z<Q;z++){var q=k[z];if(q===4){var W=_+b*0,P=_+b*1,Z=_+b*2,J=_+b*3;H(W),H(P),H(J),H(P),H(Z),H(J)}else if(q===3){var W=_+b*0,P=_+b*1,Z=_+b*2;H(W),H(P),H(Z)}else if(q>4)for(var ee=1,ne=q-2;ee<=ne;ee++){var W=_+b*0,P=_+b*ee,Z=_+b*(ee+1);H(W),H(P),H(Z)}_+=b*q}else for(var z=0,Q=u.length;z<Q;z+=b)H(z)}function gt(a){return N(G.geometries[a],mt)}function Qt(a){for(var s={name:a.getAttribute("name")||"",joints:{},links:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"technique_common":ii(v,s);break}}G.kinematicsModels[a.getAttribute("id")]=s}function ei(a){return a.build!==void 0?a.build:a}function ti(a){return N(G.kinematicsModels[a],ei)}function ii(a,s){for(var h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"joint":s.joints[v.getAttribute("sid")]=ni(v);break;case"link":s.links.push(yt(v));break}}}function ni(a){for(var s,h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"prismatic":case"revolute":s=ri(v);break}}return s}function ri(a,h){for(var h={sid:a.getAttribute("sid"),name:a.getAttribute("name")||"",axis:new THREE.Vector3,limits:{min:0,max:0},type:a.nodeName,static:!1,zeroPosition:0,middlePosition:0},v=0;v<a.childNodes.length;v++){var u=a.childNodes[v];if(u.nodeType===1)switch(u.nodeName){case"axis":var b=c(u.textContent);h.axis.fromArray(b);break;case"limits":var k=u.getElementsByTagName("max")[0],H=u.getElementsByTagName("min")[0];h.limits.max=parseFloat(k.textContent),h.limits.min=parseFloat(H.textContent);break}}return h.limits.min>=h.limits.max&&(h.static=!0),h.middlePosition=(h.limits.min+h.limits.max)/2,h}function yt(a){for(var s={sid:a.getAttribute("sid"),name:a.getAttribute("name")||"",attachments:[],transforms:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"attachment_full":s.attachments.push(ai(v));break;case"matrix":case"translate":case"rotate":s.transforms.push(Et(v));break}}return s}function ai(a){for(var s={joint:a.getAttribute("joint").split("/").pop(),transforms:[],links:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"link":s.links.push(yt(v));break;case"matrix":case"translate":case"rotate":s.transforms.push(Et(v));break}}return s}function Et(a){var s={type:a.nodeName},h=c(a.textContent);switch(s.type){case"matrix":s.obj=new THREE.Matrix4,s.obj.fromArray(h).transpose();break;case"translate":s.obj=new THREE.Vector3,s.obj.fromArray(h);break;case"rotate":s.obj=new THREE.Vector3,s.obj.fromArray(h),s.angle=THREE.Math.degToRad(h[3]);break}return s}function si(a){for(var s={name:a.getAttribute("name")||"",rigidBodies:{}},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"rigid_body":s.rigidBodies[v.getAttribute("name")]={},oi(v,s.rigidBodies[v.getAttribute("name")]);break}}G.physicsModels[a.getAttribute("id")]=s}function oi(a,s){for(var h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"technique_common":ci(v,s);break}}}function ci(a,s){for(var h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"inertia":s.inertia=c(v.textContent);break;case"mass":s.mass=c(v.textContent)[0];break}}}function li(a){for(var s={bindJointAxis:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"bind_joint_axis":s.bindJointAxis.push(hi(v));break}}G.kinematicsScenes[m(a.getAttribute("url"))]=s}function hi(a){for(var s={target:a.getAttribute("target").split("/").pop()},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"axis":var u=v.getElementsByTagName("param")[0];s.axis=u.textContent;var b=s.axis.split("inst_").pop().split("axis")[0];s.jointIndex=b.substr(0,b.length-1);break}}return s}function ui(a){return a.build!==void 0?a.build:a}function di(a){return N(G.kinematicsScenes[a],ui)}function fi(){var a=Object.keys(G.kinematicsModels)[0],s=Object.keys(G.kinematicsScenes)[0],h=Object.keys(G.visualScenes)[0];if(a===void 0||s===void 0)return;for(var v=ti(a),u=di(s),b=kt(h),k=u.bindJointAxis,H={},D=0,j=k.length;D<j;D++){var _=k[D],z=ce.querySelector('[sid="'+_.target+'"]');if(z){var Q=z.parentElement;q(_.jointIndex,Q)}}function q(P,Z){var J=Z.getAttribute("name"),ee=v.joints[P];b.traverse(function(ne){ne.name===J&&(H[P]={object:ne,transforms:pi(Z),joint:ee,position:ee.zeroPosition})})}var W=new THREE.Matrix4;Mt={joints:v&&v.joints,getJointValue:function(P){var Z=H[P];if(Z)return Z.position;console.warn("THREE.ColladaLoader: Joint "+P+" doesn't exist.")},setJointValue:function(P,Z){var J=H[P];if(J){var ee=J.joint;if(Z>ee.limits.max||Z<ee.limits.min)console.warn("THREE.ColladaLoader: Joint "+P+" value "+Z+" outside of limits (min: "+ee.limits.min+", max: "+ee.limits.max+").");else if(ee.static)console.warn("THREE.ColladaLoader: Joint "+P+" is static.");else{var ne=J.object,le=ee.axis,Y=J.transforms;ve.identity();for(var pe=0;pe<Y.length;pe++){var U=Y[pe];if(U.sid&&U.sid.indexOf(P)!==-1)switch(ee.type){case"revolute":ve.multiply(W.makeRotationAxis(le,THREE.Math.degToRad(Z)));break;case"prismatic":ve.multiply(W.makeTranslation(le.x*Z,le.y*Z,le.z*Z));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+ee.type);break}else switch(U.type){case"matrix":ve.multiply(U.obj);break;case"translate":ve.multiply(W.makeTranslation(U.obj.x,U.obj.y,U.obj.z));break;case"scale":ve.scale(U.obj);break;case"rotate":ve.multiply(W.makeRotationAxis(U.obj,U.angle));break}}ne.matrix.copy(ve),ne.matrix.decompose(ne.position,ne.quaternion,ne.scale),H[P].position=Z}}else console.log("THREE.ColladaLoader: "+P+" does not exist.")}}}function pi(a){for(var s=[],h=ce.querySelector('[id="'+a.id+'"]'),v=0;v<h.childNodes.length;v++){var u=h.childNodes[v];if(u.nodeType===1)switch(u.nodeName){case"matrix":var k=c(u.textContent),b=new THREE.Matrix4().fromArray(k).transpose();s.push({sid:u.getAttribute("sid"),type:u.nodeName,obj:b});break;case"translate":case"scale":var k=c(u.textContent),H=new THREE.Vector3().fromArray(k);s.push({sid:u.getAttribute("sid"),type:u.nodeName,obj:H});break;case"rotate":var k=c(u.textContent),H=new THREE.Vector3().fromArray(k),D=THREE.Math.degToRad(k[3]);s.push({sid:u.getAttribute("sid"),type:u.nodeName,obj:H,angle:D});break}}return s}function vi(a){for(var s=a.getElementsByTagName("node"),h=0;h<s.length;h++){var v=s[h];v.hasAttribute("id")===!1&&v.setAttribute("id",E())}}var ve=new THREE.Matrix4,Oe=new THREE.Vector3;function Qe(a){for(var s={name:a.getAttribute("name")||"",type:a.getAttribute("type"),id:a.getAttribute("id"),sid:a.getAttribute("sid"),matrix:new THREE.Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];if(v.nodeType===1)switch(v.nodeName){case"node":s.nodes.push(v.getAttribute("id")),Qe(v);break;case"instance_camera":s.instanceCameras.push(m(v.getAttribute("url")));break;case"instance_controller":s.instanceControllers.push(bt(v));break;case"instance_light":s.instanceLights.push(m(v.getAttribute("url")));break;case"instance_geometry":s.instanceGeometries.push(bt(v));break;case"instance_node":s.instanceNodes.push(m(v.getAttribute("url")));break;case"matrix":var b=c(v.textContent);s.matrix.multiply(ve.fromArray(b).transpose()),s.transforms[v.getAttribute("sid")]=v.nodeName;break;case"translate":var b=c(v.textContent);Oe.fromArray(b),s.matrix.multiply(ve.makeTranslation(Oe.x,Oe.y,Oe.z)),s.transforms[v.getAttribute("sid")]=v.nodeName;break;case"rotate":var b=c(v.textContent),u=THREE.Math.degToRad(b[3]);s.matrix.multiply(ve.makeRotationAxis(Oe.fromArray(b),u)),s.transforms[v.getAttribute("sid")]=v.nodeName;break;case"scale":var b=c(v.textContent);s.matrix.scale(Oe.fromArray(b)),s.transforms[v.getAttribute("sid")]=v.nodeName;break;case"extra":break;default:console.log(v)}}return xt(s.id)?console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",s.id):G.nodes[s.id]=s,s}function bt(a){for(var s={id:m(a.getAttribute("url")),materials:{},skeletons:[]},h=0;h<a.childNodes.length;h++){var v=a.childNodes[h];switch(v.nodeName){case"bind_material":for(var u=v.getElementsByTagName("instance_material"),b=0;b<u.length;b++){var k=u[b],H=k.getAttribute("symbol"),D=k.getAttribute("target");s.materials[H]=m(D)}break;case"skeleton":s.skeletons.push(m(v.textContent));break}}return s}function mi(a,s){var h=[],v=[],u,b,k;for(u=0;u<a.length;u++){var H=a[u],D;if(xt(H))D=De(H),Tt(D,s,h);else if(Ti(H))for(var j=G.visualScenes[H],_=j.children,b=0;b<_.length;b++){var z=_[b];if(z.type==="JOINT"){var D=De(z.id);Tt(D,s,h)}}else console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",H)}for(u=0;u<s.length;u++)for(b=0;b<h.length;b++)if(k=h[b],k.bone.name===s[u].name){v[u]=k,k.processed=!0;break}for(u=0;u<h.length;u++)k=h[u],k.processed===!1&&(v.push(k),k.processed=!0);var Q=[],q=[];for(u=0;u<v.length;u++)k=v[u],Q.push(k.bone),q.push(k.boneInverse);return new THREE.Skeleton(Q,q)}function Tt(a,s,h){a.traverse(function(v){if(v.isBone===!0){for(var u,b=0;b<s.length;b++){var k=s[b];if(k.name===v.name){u=k.boneInverse;break}}u===void 0&&(u=new THREE.Matrix4),h.push({bone:v,boneInverse:u,processed:!1})}})}function gi(a){for(var s=[],h=a.matrix,v=a.nodes,u=a.type,b=a.instanceCameras,k=a.instanceControllers,H=a.instanceLights,D=a.instanceGeometries,j=a.instanceNodes,_=0,z=v.length;_<z;_++)s.push(De(v[_]));for(var _=0,z=b.length;_<z;_++){var Q=Vt(b[_]);Q!==null&&s.push(Q.clone())}for(var _=0,z=k.length;_<z;_++)for(var q=k[_],W=I(q.id),P=gt(W.id),Z=wt(P,q.materials),J=q.skeletons,ee=W.skin.joints,ne=mi(J,ee),le=0,Y=Z.length;le<Y;le++){var U=Z[le];U.isSkinnedMesh&&(U.bind(ne,W.skin.bindMatrix),U.normalizeSkinWeights()),s.push(U)}for(var _=0,z=H.length;_<z;_++){var pe=qt(H[_]);pe!==null&&s.push(pe.clone())}for(var _=0,z=D.length;_<z;_++)for(var q=D[_],P=gt(q.id),Z=wt(P,q.materials),le=0,Y=Z.length;le<Y;le++)s.push(Z[le]);for(var _=0,z=j.length;_<z;_++)s.push(De(j[_]).clone());var U;if(v.length===0&&s.length===1)U=s[0];else{U=u==="JOINT"?new THREE.Bone:new THREE.Group;for(var _=0;_<s.length;_++)U.add(s[_])}return U.name===""&&(U.name=u==="JOINT"?a.sid:a.name),U.matrix.copy(h),U.matrix.decompose(U.position,U.quaternion,U.scale),U}var yi=new THREE.MeshBasicMaterial({color:16711935});function Ei(a,s){for(var h=[],v=0,u=a.length;v<u;v++){var b=s[a[v]];b===void 0?(console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",a[v]),h.push(yi)):h.push(Pt(b))}return h}function wt(a,s){var h=[];for(var v in a){var u=a[v],b=Ei(u.materialKeys,s);b.length===0&&(v==="lines"||v==="linestrips"?b.push(new THREE.LineBasicMaterial):b.push(new THREE.MeshPhongMaterial));var k=u.data.attributes.skinIndex!==void 0;if(k)for(var H=0,D=b.length;H<D;H++)b[H].skinning=!0;var j=b.length===1?b[0]:b,_;switch(v){case"lines":_=new THREE.LineSegments(u.data,j);break;case"linestrips":_=new THREE.Line(u.data,j);break;case"triangles":case"polylist":k?_=new THREE.SkinnedMesh(u.data,j):_=new THREE.Mesh(u.data,j);break}h.push(_)}return h}function xt(a){return G.nodes[a]!==void 0}function De(a){return N(G.nodes[a],gi)}function bi(a){var s={name:a.getAttribute("name"),children:[]};vi(a);for(var h=i(a,"node"),v=0;v<h.length;v++)s.children.push(Qe(h[v]));G.visualScenes[a.getAttribute("id")]=s}function At(a){var s=new THREE.Group;s.name=a.name;for(var h=a.children,v=0;v<h.length;v++){var u=h[v];s.add(De(u.id))}return s}function Ti(a){return G.visualScenes[a]!==void 0}function kt(a){return N(G.visualScenes[a],At)}function wi(a){var s=i(a,"instance_visual_scene")[0];return kt(m(s.getAttribute("url")))}function xi(){var a=G.clips;if(w(a)===!0){if(w(G.animations)===!1){var s=[];for(var h in G.animations)for(var v=Ee(h),u=0,b=v.length;u<b;u++)s.push(v[u]);tt.push(new THREE.AnimationClip("default",-1,s))}}else for(var h in a)tt.push(p(h))}if(e.length===0)return{scene:new THREE.Scene};var Ai=new DOMParser().parseFromString(e,"application/xml"),ce=i(Ai,"COLLADA")[0],ki=ce.getAttribute("version");console.log("THREE.ColladaLoader: File version",ki);var Rt=L(i(ce,"asset")[0]),Ct=new THREE.TextureLoader(this.manager);Ct.setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);var et;THREE.TGALoader&&(et=new THREE.TGALoader(this.manager),et.setPath(this.resourcePath||t));var tt=[],Mt={},Ri=0,G={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};O(ce,"library_animations","animation",re),O(ce,"library_animation_clips","animation_clip",l),O(ce,"library_controllers","controller",g),O(ce,"library_images","image",F),O(ce,"library_effects","effect",he),O(ce,"library_materials","material",Ft),O(ce,"library_cameras","camera",It),O(ce,"library_lights","light",Gt),O(ce,"library_geometries","geometry",Xt),O(ce,"library_nodes","node",Qe),O(ce,"library_visual_scenes","visual_scene",bi),O(ce,"library_kinematics_models","kinematics_model",Qt),O(ce,"library_physics_models","physics_model",si),O(ce,"scene","instance_kinematics_scene",li),M(G.animations,ge),M(G.clips,f),M(G.controllers,S),M(G.images,te),M(G.effects,Ue),M(G.materials,ft),M(G.cameras,pt),M(G.lights,vt),M(G.geometries,mt),M(G.visualScenes,At),xi(),fi();var it=wi(i(ce,"scene")[0]);return Rt.upAxis==="Z_UP"&&it.quaternion.setFromEuler(new THREE.Euler(-Math.PI/2,0,0)),it.scale.multiplyScalar(Rt.unit),{animations:tt,kinematics:Mt,library:G,scene:it}}};THREE.ColladaLoader=$i;AFRAME.registerComponent("collada-model-legacy",{schema:{type:"asset"},init:function(){this.model=null,this.loader=new THREE.ColladaLoader},update:function(){var e=this,t=this.el,i=this.data,r=this.el.sceneEl.systems.renderer;!i||(this.remove(),this.loader.load(i,function(c){e.model=c.scene,e.model.traverse(function(d){if(d.isMesh){var m=d.material;m.color&&r.applyColorCorrection(m.color),m.map&&r.applyColorCorrection(m.map),m.emissive&&r.applyColorCorrection(m.emissive),m.emissiveMap&&r.applyColorCorrection(m.emissiveMap)}}),t.setObject3D("mesh",e.model),t.emit("model-loaded",{format:"collada",model:e.model})}))},remove:function(){!this.model||this.el.removeObject3D("mesh")}});var Qi=THREE.FBXLoader=function(){var e,t,i;function r(n){this.manager=n!==void 0?n:THREE.DefaultLoadingManager}r.prototype={constructor:r,crossOrigin:"anonymous",load:function(n,o,l,f){var p=this,g=THREE.LoaderUtils.extractUrlBase(n),y=new THREE.FileLoader(this.manager);y.setResponseType("arraybuffer"),y.load(n,function(T){try{var C=p.parse(T,g);o(C)}catch(S){setTimeout(function(){f&&f(S),p.manager.itemError(n)},0)}},l,f)},setCrossOrigin:function(n){return this.crossOrigin=n,this},parse:function(n,o){if(B(n))e=new w().parse(n);else{var l=oe(n);if(!O(l))throw new Error("THREE.FBXLoader: Unknown format.");if(M(l)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+M(l));e=new E().parse(l)}var f=new THREE.TextureLoader(this.manager).setPath(o).setCrossOrigin(this.crossOrigin);return new c(f).parse(e)}};function c(n){this.textureLoader=n}c.prototype={constructor:c,parse:function(){t=this.parseConnections();var n=this.parseImages(),o=this.parseTextures(n),l=this.parseMaterials(o),f=this.parseDeformers(),p=new d().parse(f);return this.parseScene(f,p,l),i},parseConnections:function(){var n=new Map;if("Connections"in e){var o=e.Connections.connections;o.forEach(function(l){var f=l[0],p=l[1],g=l[2];n.has(f)||n.set(f,{parents:[],children:[]});var y={ID:p,relationship:g};n.get(f).parents.push(y),n.has(p)||n.set(p,{parents:[],children:[]});var T={ID:f,relationship:g};n.get(p).children.push(T)})}return n},parseImages:function(){var n={},o={};if("Video"in e.Objects){var l=e.Objects.Video;for(var f in l){var p=l[f],g=parseInt(f);if(n[g]=p.RelativeFilename||p.Filename,"Content"in p){var y=p.Content instanceof ArrayBuffer&&p.Content.byteLength>0,T=typeof p.Content=="string"&&p.Content!=="";if(y||T){var C=this.parseImage(l[f]);o[p.RelativeFilename||p.Filename]=C}}}}for(var g in n){var S=n[g];o[S]!==void 0?n[g]=o[S]:n[g]=n[g].split("\\").pop()}return n},parseImage:function(n){var o=n.Content,l=n.RelativeFilename||n.Filename,f=l.slice(l.lastIndexOf(".")+1).toLowerCase(),p;switch(f){case"bmp":p="image/bmp";break;case"jpg":case"jpeg":p="image/jpeg";break;case"png":p="image/png";break;case"tif":p="image/tiff";break;case"tga":if(typeof THREE.TGALoader!="function"){console.warn("FBXLoader: THREE.TGALoader is required to load TGA textures");return}else{THREE.Loader.Handlers.get(".tga")===null&&THREE.Loader.Handlers.add(/\.tga$/i,new THREE.TGALoader),p="image/tga";break}default:console.warn('FBXLoader: Image type "'+f+'" is not supported.');return}if(typeof o=="string")return"data:"+p+";base64,"+o;var g=new Uint8Array(o);return window.URL.createObjectURL(new Blob([g],{type:p}))},parseTextures:function(n){var o=new Map;if("Texture"in e.Objects){var l=e.Objects.Texture;for(var f in l){var p=this.parseTexture(l[f],n);o.set(parseInt(f),p)}}return o},parseTexture:function(n,o){var l=this.loadTexture(n,o);l.ID=n.id,l.name=n.attrName;var f=n.WrapModeU,p=n.WrapModeV,g=f!==void 0?f.value:0,y=p!==void 0?p.value:0;if(l.wrapS=g===0?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,l.wrapT=y===0?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,"Scaling"in n){var T=n.Scaling.value;l.repeat.x=T[0],l.repeat.y=T[1]}return l},loadTexture:function(n,o){var l,f=this.textureLoader.path,p=t.get(n.id).children;p!==void 0&&p.length>0&&o[p[0].ID]!==void 0&&(l=o[p[0].ID],(l.indexOf("blob:")===0||l.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));var g,y=n.FileName.slice(-3).toLowerCase();if(y==="tga"){var T=THREE.Loader.Handlers.get(".tga");T===null?(console.warn("FBXLoader: TGALoader not found, creating empty placeholder texture for",l),g=new THREE.Texture):g=T.load(l)}else y==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating empty placeholder texture for",l),g=new THREE.Texture):g=this.textureLoader.load(l);return this.textureLoader.setPath(f),g},parseMaterials:function(n){var o=new Map;if("Material"in e.Objects){var l=e.Objects.Material;for(var f in l){var p=this.parseMaterial(l[f],n);p!==null&&o.set(parseInt(f),p)}}return o},parseMaterial:function(n,o){var l=n.id,f=n.attrName,p=n.ShadingModel;if(typeof p=="object"&&(p=p.value),!t.has(l))return null;var g=this.parseParameters(n,o,l),y;switch(p.toLowerCase()){case"phong":y=new THREE.MeshPhongMaterial;break;case"lambert":y=new THREE.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',p),y=new THREE.MeshPhongMaterial({color:3342591});break}return y.setValues(g),y.name=f,y},parseParameters:function(n,o,l){var f={};n.BumpFactor&&(f.bumpScale=n.BumpFactor.value),n.Diffuse?f.color=new THREE.Color().fromArray(n.Diffuse.value):n.DiffuseColor&&n.DiffuseColor.type==="Color"&&(f.color=new THREE.Color().fromArray(n.DiffuseColor.value)),n.DisplacementFactor&&(f.displacementScale=n.DisplacementFactor.value),n.Emissive?f.emissive=new THREE.Color().fromArray(n.Emissive.value):n.EmissiveColor&&n.EmissiveColor.type==="Color"&&(f.emissive=new THREE.Color().fromArray(n.EmissiveColor.value)),n.EmissiveFactor&&(f.emissiveIntensity=parseFloat(n.EmissiveFactor.value)),n.Opacity&&(f.opacity=parseFloat(n.Opacity.value)),f.opacity<1&&(f.transparent=!0),n.ReflectionFactor&&(f.reflectivity=n.ReflectionFactor.value),n.Shininess&&(f.shininess=n.Shininess.value),n.Specular?f.specular=new THREE.Color().fromArray(n.Specular.value):n.SpecularColor&&n.SpecularColor.type==="Color"&&(f.specular=new THREE.Color().fromArray(n.SpecularColor.value));var p=this;return t.get(l).children.forEach(function(g){var y=g.relationship;switch(y){case"Bump":f.bumpMap=p.getTexture(o,g.ID);break;case"DiffuseColor":f.map=p.getTexture(o,g.ID);break;case"DisplacementColor":f.displacementMap=p.getTexture(o,g.ID);break;case"EmissiveColor":f.emissiveMap=p.getTexture(o,g.ID);break;case"NormalMap":f.normalMap=p.getTexture(o,g.ID);break;case"ReflectionColor":f.envMap=p.getTexture(o,g.ID),f.envMap.mapping=THREE.EquirectangularReflectionMapping;break;case"SpecularColor":f.specularMap=p.getTexture(o,g.ID);break;case"TransparentColor":f.alphaMap=p.getTexture(o,g.ID),f.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",y);break}}),f},getTexture:function(n,o){return"LayeredTexture"in e.Objects&&o in e.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),o=t.get(o).children[0].ID),n.get(o)},parseDeformers:function(){var n={},o={};if("Deformer"in e.Objects){var l=e.Objects.Deformer;for(var f in l){var p=l[f],g=t.get(parseInt(f));if(p.attrType==="Skin"){var y=this.parseSkeleton(g,l);y.ID=f,g.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),y.geometryID=g.parents[0].ID,n[f]=y}else if(p.attrType==="BlendShape"){var T={id:f};T.rawTargets=this.parseMorphTargets(g,l),T.id=f,g.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),o[f]=T}}}return{skeletons:n,morphTargets:o}},parseSkeleton:function(n,o){var l=[];return n.children.forEach(function(f){var p=o[f.ID];if(p.attrType==="Cluster"){var g={ID:f.ID,indices:[],weights:[],transform:new THREE.Matrix4().fromArray(p.Transform.a),transformLink:new THREE.Matrix4().fromArray(p.TransformLink.a),linkMode:p.Mode};"Indexes"in p&&(g.indices=p.Indexes.a,g.weights=p.Weights.a),l.push(g)}}),{rawBones:l,bones:[]}},parseMorphTargets:function(n,o){for(var l=[],f=0;f<n.children.length;f++){if(f===8){console.warn("FBXLoader: maximum of 8 morph targets supported. Ignoring additional targets.");break}var p=n.children[f],g=o[p.ID],y={name:g.attrName,initialWeight:g.DeformPercent,id:g.id,fullWeights:g.FullWeights.a};if(g.attrType!=="BlendShapeChannel")return;var T=t.get(parseInt(p.ID));T.children.forEach(function(C){C.relationship===void 0&&(y.geoID=C.ID)}),l.push(y)}return l},parseScene:function(n,o,l){i=new THREE.Group;var f=this.parseModels(n.skeletons,o,l),p=e.Objects.Model,g=this;f.forEach(function(T){var C=p[T.ID];g.setLookAtProperties(T,C);var S=t.get(T.ID).parents;S.forEach(function(A){var I=f.get(A.ID);I!==void 0&&I.add(T)}),T.parent===null&&i.add(T)}),this.bindSkeleton(n.skeletons,o,f),this.createAmbientLight(),this.setupMorphMaterials();var y=new m().parse();i.children.length===1&&i.children[0].isGroup&&(i.children[0].animations=y,i=i.children[0]),i.animations=y},parseModels:function(n,o,l){var f=new Map,p=e.Objects.Model;for(var g in p){var y=parseInt(g),T=p[g],C=t.get(y),S=this.buildSkeleton(C,n,y,T.attrName);if(!S){switch(T.attrType){case"Camera":S=this.createCamera(C);break;case"Light":S=this.createLight(C);break;case"Mesh":S=this.createMesh(C,o,l);break;case"NurbsCurve":S=this.createCurve(C,o);break;case"LimbNode":case"Null":default:S=new THREE.Group;break}S.name=THREE.PropertyBinding.sanitizeNodeName(T.attrName),S.ID=y}this.setModelTransforms(S,T),f.set(y,S)}return f},buildSkeleton:function(n,o,l,f){var p=null;return n.parents.forEach(function(g){for(var y in o){var T=o[y];T.rawBones.forEach(function(C,S){if(C.ID===g.ID){var A=p;p=new THREE.Bone,p.matrixWorld.copy(C.transformLink),p.name=THREE.PropertyBinding.sanitizeNodeName(f),p.ID=l,T.bones[S]=p,A!==null&&p.add(A)}})}}),p},createCamera:function(n){var o,l;if(n.children.forEach(function(I){var F=e.Objects.NodeAttribute[I.ID];F!==void 0&&(l=F)}),l===void 0)o=new THREE.Object3D;else{var f=0;l.CameraProjectionType!==void 0&&l.CameraProjectionType.value===1&&(f=1);var p=1;l.NearPlane!==void 0&&(p=l.NearPlane.value/1e3);var g=1e3;l.FarPlane!==void 0&&(g=l.FarPlane.value/1e3);var y=window.innerWidth,T=window.innerHeight;l.AspectWidth!==void 0&&l.AspectHeight!==void 0&&(y=l.AspectWidth.value,T=l.AspectHeight.value);var C=y/T,S=45;l.FieldOfView!==void 0&&(S=l.FieldOfView.value);var A=l.FocalLength?l.FocalLength.value:null;switch(f){case 0:o=new THREE.PerspectiveCamera(S,C,p,g),A!==null&&o.setFocalLength(A);break;case 1:o=new THREE.OrthographicCamera(-y/2,y/2,T/2,-T/2,p,g);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+f+"."),o=new THREE.Object3D;break}}return o},createLight:function(n){var o,l;if(n.children.forEach(function(A){var I=e.Objects.NodeAttribute[A.ID];I!==void 0&&(l=I)}),l===void 0)o=new THREE.Object3D;else{var f;l.LightType===void 0?f=0:f=l.LightType.value;var p=16777215;l.Color!==void 0&&(p=new THREE.Color().fromArray(l.Color.value));var g=l.Intensity===void 0?1:l.Intensity.value/100;l.CastLightOnObject!==void 0&&l.CastLightOnObject.value===0&&(g=0);var y=0;l.FarAttenuationEnd!==void 0&&(l.EnableFarAttenuation!==void 0&&l.EnableFarAttenuation.value===0?y=0:y=l.FarAttenuationEnd.value);var T=1;switch(f){case 0:o=new THREE.PointLight(p,g,y,T);break;case 1:o=new THREE.DirectionalLight(p,g);break;case 2:var C=Math.PI/3;l.InnerAngle!==void 0&&(C=THREE.Math.degToRad(l.InnerAngle.value));var S=0;l.OuterAngle!==void 0&&(S=THREE.Math.degToRad(l.OuterAngle.value),S=Math.max(S,1)),o=new THREE.SpotLight(p,g,y,C,S,T);break;default:console.warn("THREE.FBXLoader: Unknown light type "+l.LightType.value+", defaulting to a THREE.PointLight."),o=new THREE.PointLight(p,g);break}l.CastShadows!==void 0&&l.CastShadows.value===1&&(o.castShadow=!0)}return o},createMesh:function(n,o,l){var f,p=null,g=null,y=[];return n.children.forEach(function(T){o.has(T.ID)&&(p=o.get(T.ID)),l.has(T.ID)&&y.push(l.get(T.ID))}),y.length>1?g=y:y.length>0?g=y[0]:(g=new THREE.MeshPhongMaterial({color:13421772}),y.push(g)),"color"in p.attributes&&y.forEach(function(T){T.vertexColors=THREE.VertexColors}),p.FBX_Deformer?(y.forEach(function(T){T.skinning=!0}),f=new THREE.SkinnedMesh(p,g)):f=new THREE.Mesh(p,g),f},createCurve:function(n,o){var l=n.children.reduce(function(p,g){return o.has(g.ID)&&(p=o.get(g.ID)),p},null),f=new THREE.LineBasicMaterial({color:3342591,linewidth:1});return new THREE.Line(l,f)},setModelTransforms:function(n,o){var l={};"RotationOrder"in o&&(l.eulerOrder=parseInt(o.RotationOrder.value)),"Lcl_Translation"in o&&(l.translation=o.Lcl_Translation.value),"RotationOffset"in o&&(l.rotationOffset=o.RotationOffset.value),"Lcl_Rotation"in o&&(l.rotation=o.Lcl_Rotation.value),"PreRotation"in o&&(l.preRotation=o.PreRotation.value),"PostRotation"in o&&(l.postRotation=o.PostRotation.value),"Lcl_Scaling"in o&&(l.scale=o.Lcl_Scaling.value);var f=X(l);n.applyMatrix(f)},setLookAtProperties:function(n,o){if("LookAtProperty"in o){var l=t.get(n.ID).children;l.forEach(function(f){if(f.relationship==="LookAtProperty"){var p=e.Objects.Model[f.ID];if("Lcl_Translation"in p){var g=p.Lcl_Translation.value;n.target!==void 0?(n.target.position.fromArray(g),i.add(n.target)):n.lookAt(new THREE.Vector3().fromArray(g))}}})}},bindSkeleton:function(n,o,l){var f=this.parsePoseNodes();for(var p in n){var g=n[p],y=t.get(parseInt(g.ID)).parents;y.forEach(function(T){if(o.has(T.ID)){var C=T.ID,S=t.get(C);S.parents.forEach(function(A){if(l.has(A.ID)){var I=l.get(A.ID);I.bind(new THREE.Skeleton(g.bones),f[A.ID])}})}})}},parsePoseNodes:function(){var n={};if("Pose"in e.Objects){var o=e.Objects.Pose;for(var l in o)if(o[l].attrType==="BindPose"){var f=o[l].PoseNode;Array.isArray(f)?f.forEach(function(p){n[p.Node]=new THREE.Matrix4().fromArray(p.Matrix.a)}):n[f.Node]=new THREE.Matrix4().fromArray(f.Matrix.a)}}return n},createAmbientLight:function(){if("GlobalSettings"in e&&"AmbientColor"in e.GlobalSettings){var n=e.GlobalSettings.AmbientColor.value,o=n[0],l=n[1],f=n[2];if(o!==0||l!==0||f!==0){var p=new THREE.Color(o,l,f);i.add(new THREE.AmbientLight(p,1))}}},setupMorphMaterials:function(){i.traverse(function(n){if(n.isMesh&&(n.geometry.morphAttributes.position||n.geometry.morphAttributes.normal)){var o=n.uuid,l=n.material.uuid,f=!1;i.traverse(function(p){p.isMesh&&p.material.uuid===l&&p.uuid!==o&&(f=!0)}),f===!0&&(n.material=n.material.clone()),n.material.morphTargets=!0}})}};function d(){}d.prototype={constructor:d,parse:function(n){var o=new Map;if("Geometry"in e.Objects){var l=e.Objects.Geometry;for(var f in l){var p=t.get(parseInt(f)),g=this.parseGeometry(p,l[f],n);o.set(parseInt(f),g)}}return o},parseGeometry:function(n,o,l){switch(o.attrType){case"Mesh":return this.parseMeshGeometry(n,o,l);case"NurbsCurve":return this.parseNurbsGeometry(o)}},parseMeshGeometry:function(n,o,l){var f=l.skeletons,p=l.morphTargets,g=n.parents.map(function(I){return e.Objects.Model[I.ID]});if(g.length!==0){var y=n.children.reduce(function(I,F){return f[F.ID]!==void 0&&(I=f[F.ID]),I},null),T=n.children.reduce(function(I,F){return p[F.ID]!==void 0&&(I=p[F.ID]),I},null),C=g[0],S={};"RotationOrder"in C&&(S.eulerOrder=C.RotationOrder.value),"GeometricTranslation"in C&&(S.translation=C.GeometricTranslation.value),"GeometricRotation"in C&&(S.rotation=C.GeometricRotation.value),"GeometricScaling"in C&&(S.scale=C.GeometricScaling.value);var A=X(S);return this.genGeometry(o,y,T,A)}},genGeometry:function(n,o,l,f){var p=new THREE.BufferGeometry;n.attrName&&(p.name=n.attrName);var g=this.parseGeoNode(n,o),y=this.genBuffers(g),T=new THREE.Float32BufferAttribute(y.vertex,3);if(f.applyToBufferAttribute(T),p.addAttribute("position",T),y.colors.length>0&&p.addAttribute("color",new THREE.Float32BufferAttribute(y.colors,3)),o&&(p.addAttribute("skinIndex",new THREE.Uint16BufferAttribute(y.weightsIndices,4)),p.addAttribute("skinWeight",new THREE.Float32BufferAttribute(y.vertexWeights,4)),p.FBX_Deformer=o),y.normal.length>0){var C=new THREE.Float32BufferAttribute(y.normal,3),S=new THREE.Matrix3().getNormalMatrix(f);S.applyToBufferAttribute(C),p.addAttribute("normal",C)}if(y.uvs.forEach(function(de,he){var fe="uv"+(he+1).toString();he===0&&(fe="uv"),p.addAttribute(fe,new THREE.Float32BufferAttribute(y.uvs[he],2))}),g.material&&g.material.mappingType!=="AllSame"){var A=y.materialIndex[0],I=0;if(y.materialIndex.forEach(function(de,he){de!==A&&(p.addGroup(I,he-I,A),A=de,I=he)}),p.groups.length>0){var F=p.groups[p.groups.length-1],te=F.start+F.count;te!==y.materialIndex.length&&p.addGroup(te,y.materialIndex.length-te,A)}p.groups.length===0&&p.addGroup(0,y.materialIndex.length,y.materialIndex[0])}return this.addMorphTargets(p,n,l,f),p},parseGeoNode:function(n,o){var l={};if(l.vertexPositions=n.Vertices!==void 0?n.Vertices.a:[],l.vertexIndices=n.PolygonVertexIndex!==void 0?n.PolygonVertexIndex.a:[],n.LayerElementColor&&(l.color=this.parseVertexColors(n.LayerElementColor[0])),n.LayerElementMaterial&&(l.material=this.parseMaterialIndices(n.LayerElementMaterial[0])),n.LayerElementNormal&&(l.normal=this.parseNormals(n.LayerElementNormal[0])),n.LayerElementUV){l.uv=[];for(var f=0;n.LayerElementUV[f];)l.uv.push(this.parseUVs(n.LayerElementUV[f])),f++}return l.weightTable={},o!==null&&(l.skeleton=o,o.rawBones.forEach(function(p,g){p.indices.forEach(function(y,T){l.weightTable[y]===void 0&&(l.weightTable[y]=[]),l.weightTable[y].push({id:g,weight:p.weights[T]})})})),l},genBuffers:function(n){var o={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]},l=0,f=0,p=!1,g=[],y=[],T=[],C=[],S=[],A=[],I=this;return n.vertexIndices.forEach(function(F,te){var de=!1;F<0&&(F=F^-1,de=!0);var he=[],fe=[];if(g.push(F*3,F*3+1,F*3+2),n.color){var me=ae(te,l,F,n.color);T.push(me[0],me[1],me[2])}if(n.skeleton){if(n.weightTable[F]!==void 0&&n.weightTable[F].forEach(function(Te){fe.push(Te.weight),he.push(Te.id)}),fe.length>4){p||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),p=!0);var Ne=[0,0,0,0],Ve=[0,0,0,0];fe.forEach(function(Te,ke){var Re=Te,Ge=he[ke];Ve.forEach(function(Ke,Pe,Ue){if(Re>Ke){Ue[Pe]=Re,Re=Ke;var Ye=Ne[Pe];Ne[Pe]=Ge,Ge=Ye}})}),he=Ne,fe=Ve}for(;fe.length<4;)fe.push(0),he.push(0);for(var be=0;be<4;++be)S.push(fe[be]),A.push(he[be])}if(n.normal){var me=ae(te,l,F,n.normal);y.push(me[0],me[1],me[2])}if(n.material&&n.material.mappingType!=="AllSame")var Je=ae(te,l,F,n.material)[0];n.uv&&n.uv.forEach(function(Te,ke){var Re=ae(te,l,F,Te);C[ke]===void 0&&(C[ke]=[]),C[ke].push(Re[0]),C[ke].push(Re[1])}),f++,de&&(I.genFace(o,n,g,Je,y,T,C,S,A,f),l++,f=0,g=[],y=[],T=[],C=[],S=[],A=[])}),o},genFace:function(n,o,l,f,p,g,y,T,C,S){for(var A=2;A<S;A++)n.vertex.push(o.vertexPositions[l[0]]),n.vertex.push(o.vertexPositions[l[1]]),n.vertex.push(o.vertexPositions[l[2]]),n.vertex.push(o.vertexPositions[l[(A-1)*3]]),n.vertex.push(o.vertexPositions[l[(A-1)*3+1]]),n.vertex.push(o.vertexPositions[l[(A-1)*3+2]]),n.vertex.push(o.vertexPositions[l[A*3]]),n.vertex.push(o.vertexPositions[l[A*3+1]]),n.vertex.push(o.vertexPositions[l[A*3+2]]),o.skeleton&&(n.vertexWeights.push(T[0]),n.vertexWeights.push(T[1]),n.vertexWeights.push(T[2]),n.vertexWeights.push(T[3]),n.vertexWeights.push(T[(A-1)*4]),n.vertexWeights.push(T[(A-1)*4+1]),n.vertexWeights.push(T[(A-1)*4+2]),n.vertexWeights.push(T[(A-1)*4+3]),n.vertexWeights.push(T[A*4]),n.vertexWeights.push(T[A*4+1]),n.vertexWeights.push(T[A*4+2]),n.vertexWeights.push(T[A*4+3]),n.weightsIndices.push(C[0]),n.weightsIndices.push(C[1]),n.weightsIndices.push(C[2]),n.weightsIndices.push(C[3]),n.weightsIndices.push(C[(A-1)*4]),n.weightsIndices.push(C[(A-1)*4+1]),n.weightsIndices.push(C[(A-1)*4+2]),n.weightsIndices.push(C[(A-1)*4+3]),n.weightsIndices.push(C[A*4]),n.weightsIndices.push(C[A*4+1]),n.weightsIndices.push(C[A*4+2]),n.weightsIndices.push(C[A*4+3])),o.color&&(n.colors.push(g[0]),n.colors.push(g[1]),n.colors.push(g[2]),n.colors.push(g[(A-1)*3]),n.colors.push(g[(A-1)*3+1]),n.colors.push(g[(A-1)*3+2]),n.colors.push(g[A*3]),n.colors.push(g[A*3+1]),n.colors.push(g[A*3+2])),o.material&&o.material.mappingType!=="AllSame"&&(n.materialIndex.push(f),n.materialIndex.push(f),n.materialIndex.push(f)),o.normal&&(n.normal.push(p[0]),n.normal.push(p[1]),n.normal.push(p[2]),n.normal.push(p[(A-1)*3]),n.normal.push(p[(A-1)*3+1]),n.normal.push(p[(A-1)*3+2]),n.normal.push(p[A*3]),n.normal.push(p[A*3+1]),n.normal.push(p[A*3+2])),o.uv&&o.uv.forEach(function(I,F){n.uvs[F]===void 0&&(n.uvs[F]=[]),n.uvs[F].push(y[F][0]),n.uvs[F].push(y[F][1]),n.uvs[F].push(y[F][(A-1)*2]),n.uvs[F].push(y[F][(A-1)*2+1]),n.uvs[F].push(y[F][A*2]),n.uvs[F].push(y[F][A*2+1])})},addMorphTargets:function(n,o,l,f){if(l!==null){n.morphAttributes.position=[],n.morphAttributes.normal=[];var p=this;l.rawTargets.forEach(function(g){var y=e.Objects.Geometry[g.geoID];y!==void 0&&p.genMorphGeometry(n,o,y,f)})}},genMorphGeometry:function(n,o,l,f){var p=new THREE.BufferGeometry;l.attrName&&(p.name=l.attrName);for(var g=o.PolygonVertexIndex!==void 0?o.PolygonVertexIndex.a:[],y=o.Vertices!==void 0?o.Vertices.a.slice():[],T=l.Vertices!==void 0?l.Vertices.a:[],C=l.Indexes!==void 0?l.Indexes.a:[],S=0;S<C.length;S++){var A=C[S]*3;y[A]+=T[S*3],y[A+1]+=T[S*3+1],y[A+2]+=T[S*3+2]}var I={vertexIndices:g,vertexPositions:y},F=this.genBuffers(I),te=new THREE.Float32BufferAttribute(F.vertex,3);te.name=l.attrName,f.applyToBufferAttribute(te),n.morphAttributes.position.push(te)},parseNormals:function(n){var o=n.MappingInformationType,l=n.ReferenceInformationType,f=n.Normals.a,p=[];return l==="IndexToDirect"&&("NormalIndex"in n?p=n.NormalIndex.a:"NormalsIndex"in n&&(p=n.NormalsIndex.a)),{dataSize:3,buffer:f,indices:p,mappingType:o,referenceType:l}},parseUVs:function(n){var o=n.MappingInformationType,l=n.ReferenceInformationType,f=n.UV.a,p=[];return l==="IndexToDirect"&&(p=n.UVIndex.a),{dataSize:2,buffer:f,indices:p,mappingType:o,referenceType:l}},parseVertexColors:function(n){var o=n.MappingInformationType,l=n.ReferenceInformationType,f=n.Colors.a,p=[];return l==="IndexToDirect"&&(p=n.ColorIndex.a),{dataSize:4,buffer:f,indices:p,mappingType:o,referenceType:l}},parseMaterialIndices:function(n){var o=n.MappingInformationType,l=n.ReferenceInformationType;if(o==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:l};for(var f=n.Materials.a,p=[],g=0;g<f.length;++g)p.push(g);return{dataSize:1,buffer:f,indices:p,mappingType:o,referenceType:l}},parseNurbsGeometry:function(n){if(THREE.NURBSCurve===void 0)return console.error("THREE.FBXLoader: The loader relies on THREE.NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new THREE.BufferGeometry;var o=parseInt(n.Order);if(isNaN(o))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",n.Order,n.id),new THREE.BufferGeometry;for(var l=o-1,f=n.KnotVector.a,p=[],g=n.Points.a,y=0,T=g.length;y<T;y+=4)p.push(new THREE.Vector4().fromArray(g,y));var C,S;if(n.Form==="Closed")p.push(p[0]);else if(n.Form==="Periodic"){C=l,S=f.length-1-C;for(var y=0;y<l;++y)p.push(p[y])}var A=new THREE.NURBSCurve(l,f,p,C,S),I=A.getPoints(p.length*7),F=new Float32Array(I.length*3);I.forEach(function(de,he){de.toArray(F,he*3)});var te=new THREE.BufferGeometry;return te.addAttribute("position",new THREE.BufferAttribute(F,3)),te}};function m(){}m.prototype={constructor:m,parse:function(){var n=[],o=this.parseClips();if(o===void 0)return n;for(var l in o){var f=o[l],p=this.addClip(f);n.push(p)}return n},parseClips:function(){if(e.Objects.AnimationCurve!==void 0){var n=this.parseAnimationCurveNodes();this.parseAnimationCurves(n);var o=this.parseAnimationLayers(n),l=this.parseAnimStacks(o);return l}},parseAnimationCurveNodes:function(){var n=e.Objects.AnimationCurveNode,o=new Map;for(var l in n){var f=n[l];if(f.attrName.match(/S|R|T|DeformPercent/)!==null){var p={id:f.id,attr:f.attrName,curves:{}};o.set(p.id,p)}}return o},parseAnimationCurves:function(n){var o=e.Objects.AnimationCurve;for(var l in o){var f={id:o[l].id,times:o[l].KeyTime.a.map(N),values:o[l].KeyValueFloat.a},p=t.get(f.id);if(p!==void 0){var g=p.parents[0].ID,y=p.parents[0].relationship;y.match(/X/)?n.get(g).curves.x=f:y.match(/Y/)?n.get(g).curves.y=f:y.match(/Z/)?n.get(g).curves.z=f:y.match(/d|DeformPercent/)&&n.has(g)&&(n.get(g).curves.morph=f)}}},parseAnimationLayers:function(n){var o=e.Objects.AnimationLayer,l=new Map;for(var f in o){var p=[],g=t.get(parseInt(f));if(g!==void 0){var y=g.children,T=this;y.forEach(function(C,S){if(n.has(C.ID)){var A=n.get(C.ID);if(A.curves.x!==void 0||A.curves.y!==void 0||A.curves.z!==void 0){if(p[S]===void 0){var I;t.get(C.ID).parents.forEach(function(me){me.relationship!==void 0&&(I=me.ID)});var F=e.Objects.Model[I.toString()],te={modelName:THREE.PropertyBinding.sanitizeNodeName(F.attrName),initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1],transform:T.getModelAnimTransform(F)};"PreRotation"in F&&(te.preRotations=F.PreRotation.value),"PostRotation"in F&&(te.postRotations=F.PostRotation.value),p[S]=te}p[S][A.attr]=A}else if(A.curves.morph!==void 0){if(p[S]===void 0){var de;t.get(C.ID).parents.forEach(function(be){be.relationship!==void 0&&(de=be.ID)});var he=t.get(de).parents[0].ID,fe=t.get(he).parents[0].ID,I=t.get(fe).parents[0].ID,F=e.Objects.Model[I],te={modelName:THREE.PropertyBinding.sanitizeNodeName(F.attrName),morphName:e.Objects.Deformer[de].attrName};p[S]=te}p[S][A.attr]=A}}}),l.set(parseInt(f),p)}}return l},getModelAnimTransform:function(n){var o={};return"RotationOrder"in n&&(o.eulerOrder=parseInt(n.RotationOrder.value)),"Lcl_Translation"in n&&(o.translation=n.Lcl_Translation.value),"RotationOffset"in n&&(o.rotationOffset=n.RotationOffset.value),"Lcl_Rotation"in n&&(o.rotation=n.Lcl_Rotation.value),"PreRotation"in n&&(o.preRotation=n.PreRotation.value),"PostRotation"in n&&(o.postRotation=n.PostRotation.value),"Lcl_Scaling"in n&&(o.scale=n.Lcl_Scaling.value),X(o)},parseAnimStacks:function(n){var o=e.Objects.AnimationStack,l={};for(var f in o){var p=t.get(parseInt(f)).children;p.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var g=n.get(p[0].ID);l[f]={name:o[f].attrName,layer:g}}return l},addClip:function(n){var o=[],l=this;return n.layer.forEach(function(f){o=o.concat(l.generateTracks(f))}),new THREE.AnimationClip(n.name,-1,o)},generateTracks:function(n){var o=[],l=new THREE.Vector3,f=new THREE.Quaternion,p=new THREE.Vector3;if(n.transform&&n.transform.decompose(l,f,p),l=l.toArray(),f=new THREE.Euler().setFromQuaternion(f).toArray(),p=p.toArray(),n.T!==void 0&&Object.keys(n.T.curves).length>0){var g=this.generateVectorTrack(n.modelName,n.T.curves,l,"position");g!==void 0&&o.push(g)}if(n.R!==void 0&&Object.keys(n.R.curves).length>0){var y=this.generateRotationTrack(n.modelName,n.R.curves,f,n.preRotations,n.postRotations);y!==void 0&&o.push(y)}if(n.S!==void 0&&Object.keys(n.S.curves).length>0){var T=this.generateVectorTrack(n.modelName,n.S.curves,p,"scale");T!==void 0&&o.push(T)}if(n.DeformPercent!==void 0){var C=this.generateMorphTrack(n);C!==void 0&&o.push(C)}return o},generateVectorTrack:function(n,o,l,f){var p=this.getTimesForAllAxes(o),g=this.getKeyframeTrackValues(p,o,l);return new THREE.VectorKeyframeTrack(n+"."+f,p,g)},generateRotationTrack:function(n,o,l,f,p){o.x!==void 0&&(this.interpolateRotations(o.x),o.x.values=o.x.values.map(THREE.Math.degToRad)),o.y!==void 0&&(this.interpolateRotations(o.y),o.y.values=o.y.values.map(THREE.Math.degToRad)),o.z!==void 0&&(this.interpolateRotations(o.z),o.z.values=o.z.values.map(THREE.Math.degToRad));var g=this.getTimesForAllAxes(o),y=this.getKeyframeTrackValues(g,o,l);f!==void 0&&(f=f.map(THREE.Math.degToRad),f.push("ZYX"),f=new THREE.Euler().fromArray(f),f=new THREE.Quaternion().setFromEuler(f)),p!==void 0&&(p=p.map(THREE.Math.degToRad),p.push("ZYX"),p=new THREE.Euler().fromArray(p),p=new THREE.Quaternion().setFromEuler(p).inverse());for(var T=new THREE.Quaternion,C=new THREE.Euler,S=[],A=0;A<y.length;A+=3)C.set(y[A],y[A+1],y[A+2],"ZYX"),T.setFromEuler(C),f!==void 0&&T.premultiply(f),p!==void 0&&T.multiply(p),T.toArray(S,A/3*4);return new THREE.QuaternionKeyframeTrack(n+".quaternion",g,S)},generateMorphTrack:function(n){var o=n.DeformPercent.curves.morph,l=o.values.map(function(p){return p/100}),f=i.getObjectByName(n.modelName).morphTargetDictionary[n.morphName];return new THREE.NumberKeyframeTrack(n.modelName+".morphTargetInfluences["+f+"]",o.times,l)},getTimesForAllAxes:function(n){var o=[];return n.x!==void 0&&(o=o.concat(n.x.times)),n.y!==void 0&&(o=o.concat(n.y.times)),n.z!==void 0&&(o=o.concat(n.z.times)),o=o.sort(function(l,f){return l-f}).filter(function(l,f,p){return p.indexOf(l)==f}),o},getKeyframeTrackValues:function(n,o,l){var f=l,p=[],g=-1,y=-1,T=-1;return n.forEach(function(C){if(o.x&&(g=o.x.times.indexOf(C)),o.y&&(y=o.y.times.indexOf(C)),o.z&&(T=o.z.times.indexOf(C)),g!==-1){var S=o.x.values[g];p.push(S),f[0]=S}else p.push(f[0]);if(y!==-1){var A=o.y.values[y];p.push(A),f[1]=A}else p.push(f[1]);if(T!==-1){var I=o.z.values[T];p.push(I),f[2]=I}else p.push(f[2])}),p},interpolateRotations:function(n){for(var o=1;o<n.values.length;o++){var l=n.values[o-1],f=n.values[o]-l,p=Math.abs(f);if(p>=180){for(var g=p/180,y=f/g,T=l+y,C=n.times[o-1],S=n.times[o]-C,A=S/g,I=C+A,F=[],te=[];I<n.times[o];)F.push(I),I+=A,te.push(T),T+=y;n.times=je(n.times,o,F),n.values=je(n.values,o,te)}}}};function E(){}E.prototype={constructor:E,getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(n){this.nodeStack.push(n),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(n,o){this.currentProp=n,this.currentPropName=o},parse:function(n){this.currentIndent=0,console.log("FBXTree: ",R),this.allNodes=new R,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var o=this,l=n.split(/[\r\n]+/);return l.forEach(function(f,p){var g=f.match(/^[\s\t]*;/),y=f.match(/^[\s\t]*$/);if(!(g||y)){var T=f.match("^\\t{"+o.currentIndent+"}(\\w+):(.*){",""),C=f.match("^\\t{"+o.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),S=f.match("^\\t{"+(o.currentIndent-1)+"}}");T?o.parseNodeBegin(f,T):C?o.parseNodeProperty(f,C,l[++p]):S?o.popStack():f.match(/^[^\s\t}]/)&&o.parseNodePropertyContinued(f)}}),this.allNodes},parseNodeBegin:function(n,o){var l=o[1].trim().replace(/^"/,"").replace(/"$/,""),f=o[2].split(",").map(function(T){return T.trim().replace(/^"/,"").replace(/"$/,"")}),p={name:l},g=this.parseNodeAttr(f),y=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(l,p):l in y?(l==="PoseNode"?y.PoseNode.push(p):y[l].id!==void 0&&(y[l]={},y[l][y[l].id]=y[l]),g.id!==""&&(y[l][g.id]=p)):typeof g.id=="number"?(y[l]={},y[l][g.id]=p):l!=="Properties70"&&(l==="PoseNode"?y[l]=[p]:y[l]=p),typeof g.id=="number"&&(p.id=g.id),g.name!==""&&(p.attrName=g.name),g.type!==""&&(p.attrType=g.type),this.pushStack(p)},parseNodeAttr:function(n){var o=n[0];n[0]!==""&&(o=parseInt(n[0]),isNaN(o)&&(o=n[0]));var l="",f="";return n.length>1&&(l=n[1].replace(/^(\w+)::/,""),f=n[2]),{id:o,name:l,type:f}},parseNodeProperty:function(n,o,l){var f=o[1].replace(/^"/,"").replace(/"$/,"").trim(),p=o[2].replace(/^"/,"").replace(/"$/,"").trim();f==="Content"&&p===","&&(p=l.replace(/"/g,"").replace(/,$/,"").trim());var g=this.getCurrentNode(),y=g.name;if(y==="Properties70"){this.parseNodeSpecialProperty(n,f,p);return}if(f==="C"){var T=p.split(",").slice(1),C=parseInt(T[0]),S=parseInt(T[1]),A=p.split(",").slice(3);A=A.map(function(I){return I.trim().replace(/^"/,"")}),f="connections",p=[C,S],We(p,A),g[f]===void 0&&(g[f]=[])}f==="Node"&&(g.id=p),f in g&&Array.isArray(g[f])?g[f].push(p):f!=="a"?g[f]=p:g.a=p,this.setCurrentProp(g,f),f==="a"&&p.slice(-1)!==","&&(g.a=se(p))},parseNodePropertyContinued:function(n){var o=this.getCurrentNode();o.a+=n,n.slice(-1)!==","&&(o.a=se(o.a))},parseNodeSpecialProperty:function(n,o,l){var f=l.split('",').map(function(S){return S.trim().replace(/^\"/,"").replace(/\s/,"_")}),p=f[0],g=f[1],y=f[2],T=f[3],C=f[4];switch(g){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":C=parseFloat(C);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":C=se(C);break}this.getPrevNode()[p]={type:g,type2:y,flag:T,value:C},this.setCurrentProp(this.getPrevNode(),p)}};function w(){}w.prototype={constructor:w,parse:function(n){var o=new L(n);o.skip(23);var l=o.getUint32();console.log("THREE.FBXLoader: FBX binary version: "+l);for(var f=new R;!this.endOfContent(o);){var p=this.parseNode(o,l);p!==null&&f.add(p.name,p)}return f},endOfContent:function(n){return n.size()%16===0?(n.getOffset()+160+16&-16)>=n.size():n.getOffset()+160+16>=n.size()},parseNode:function(n,o){var l={},f=o>=7500?n.getUint64():n.getUint32(),p=o>=7500?n.getUint64():n.getUint32();o>=7500?n.getUint64():n.getUint32();var g=n.getUint8(),y=n.getString(g);if(f===0)return null;for(var T=[],C=0;C<p;C++)T.push(this.parseProperty(n));var S=T.length>0?T[0]:"",A=T.length>1?T[1]:"",I=T.length>2?T[2]:"";for(l.singleProperty=p===1&&n.getOffset()===f;f>n.getOffset();){var F=this.parseNode(n,o);F!==null&&this.parseSubNode(y,l,F)}return l.propertyList=T,typeof S=="number"&&(l.id=S),A!==""&&(l.attrName=A),I!==""&&(l.attrType=I),y!==""&&(l.name=y),l},parseSubNode:function(n,o,l){if(l.singleProperty===!0){var f=l.propertyList[0];Array.isArray(f)?(o[l.name]=l,l.a=f):o[l.name]=f}else if(n==="Connections"&&l.name==="C"){var p=[];l.propertyList.forEach(function(I,F){F!==0&&p.push(I)}),o.connections===void 0&&(o.connections=[]),o.connections.push(p)}else if(l.name==="Properties70"){var g=Object.keys(l);g.forEach(function(I){o[I]=l[I]})}else if(n==="Properties70"&&l.name==="P"){var y=l.propertyList[0],T=l.propertyList[1],C=l.propertyList[2],S=l.propertyList[3],A;y.indexOf("Lcl ")===0&&(y=y.replace("Lcl ","Lcl_")),T.indexOf("Lcl ")===0&&(T=T.replace("Lcl ","Lcl_")),T==="Color"||T==="ColorRGB"||T==="Vector"||T==="Vector3D"||T.indexOf("Lcl_")===0?A=[l.propertyList[4],l.propertyList[5],l.propertyList[6]]:A=l.propertyList[4],o[y]={type:T,type2:C,flag:S,value:A}}else o[l.name]===void 0?typeof l.id=="number"?(o[l.name]={},o[l.name][l.id]=l):o[l.name]=l:l.name==="PoseNode"?(Array.isArray(o[l.name])||(o[l.name]=[o[l.name]]),o[l.name].push(l)):o[l.name][l.id]===void 0&&(o[l.name][l.id]=l)},parseProperty:function(n){var o=n.getString(1);switch(o){case"C":return n.getBoolean();case"D":return n.getFloat64();case"F":return n.getFloat32();case"I":return n.getInt32();case"L":return n.getInt64();case"R":var l=n.getUint32();return n.getArrayBuffer(l);case"S":var l=n.getUint32();return n.getString(l);case"Y":return n.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var f=n.getUint32(),p=n.getUint32(),g=n.getUint32();if(p===0)switch(o){case"b":case"c":return n.getBooleanArray(f);case"d":return n.getFloat64Array(f);case"f":return n.getFloat32Array(f);case"i":return n.getInt32Array(f);case"l":return n.getInt64Array(f)}typeof Zlib=="undefined"&&console.error("THREE.FBXLoader: External library Inflate.min.js required, obtain or import from https://github.com/imaya/zlib.js");var y=new Zlib.Inflate(new Uint8Array(n.getArrayBuffer(g))),T=new L(y.decompress().buffer);switch(o){case"b":case"c":return T.getBooleanArray(f);case"d":return T.getFloat64Array(f);case"f":return T.getFloat32Array(f);case"i":return T.getInt32Array(f);case"l":return T.getInt64Array(f)}default:throw new Error("THREE.FBXLoader: Unknown property type "+o)}}};function L(n,o){this.dv=new DataView(n),this.offset=0,this.littleEndian=o!==void 0?o:!0}L.prototype={constructor:L,getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(n){this.offset+=n},getBoolean:function(){return(this.getUint8()&1)===1},getBooleanArray:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getBoolean());return o},getUint8:function(){var n=this.dv.getUint8(this.offset);return this.offset+=1,n},getInt16:function(){var n=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,n},getInt32:function(){var n=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,n},getInt32Array:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getInt32());return o},getUint32:function(){var n=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,n},getInt64:function(){var n,o;return this.littleEndian?(n=this.getUint32(),o=this.getUint32()):(o=this.getUint32(),n=this.getUint32()),o&2147483648?(o=~o&4294967295,n=~n&4294967295,n===4294967295&&(o=o+1&4294967295),n=n+1&4294967295,-(o*4294967296+n)):o*4294967296+n},getInt64Array:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getInt64());return o},getUint64:function(){var n,o;return this.littleEndian?(n=this.getUint32(),o=this.getUint32()):(o=this.getUint32(),n=this.getUint32()),o*4294967296+n},getFloat32:function(){var n=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,n},getFloat32Array:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getFloat32());return o},getFloat64:function(){var n=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,n},getFloat64Array:function(n){for(var o=[],l=0;l<n;l++)o.push(this.getFloat64());return o},getArrayBuffer:function(n){var o=this.dv.buffer.slice(this.offset,this.offset+n);return this.offset+=n,o},getString:function(n){for(var o=[],l=0;l<n;l++)o[l]=this.getUint8();var f=o.indexOf(0);return f>=0&&(o=o.slice(0,f)),THREE.LoaderUtils.decodeText(new Uint8Array(o))}};function R(){}R.prototype={constructor:R,add:function(n,o){this[n]=o}};function B(n){var o="Kaydara FBX Binary  \0";return n.byteLength>=o.length&&o===oe(n,0,o.length)}function O(n){var o=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],l=0;function f(y){var T=n[y-1];return n=n.slice(l+y),l++,T}for(var p=0;p<o.length;++p){var g=f(1);if(g===o[p])return!1}return!0}function M(n){var o=/FBXVersion: (\d+)/,l=n.match(o);if(l){var f=parseInt(l[1]);return f}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function N(n){return n/46186158e3}var re=[];function ae(n,o,l,f){var p;switch(f.mappingType){case"ByPolygonVertex":p=n;break;case"ByPolygon":p=o;break;case"ByVertice":p=l;break;case"AllSame":p=f.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+f.mappingType)}f.referenceType==="IndexToDirect"&&(p=f.indices[p]);var g=p*f.dataSize,y=g+f.dataSize;return Ze(re,f.buffer,g,y)}var ie=new THREE.Matrix4,ge=new THREE.Euler,Ee=new THREE.Vector3,Ae=new THREE.Vector3,V=new THREE.Matrix4;function X(n){var o=new THREE.Matrix4;Ae.set(0,0,0),V.identity();var l=n.eulerOrder?K(n.eulerOrder):K(0);if(n.translation&&Ae.fromArray(n.translation),n.rotationOffset&&Ae.add(Ee.fromArray(n.rotationOffset)),n.rotation){var f=n.rotation.map(THREE.Math.degToRad);f.push(l),V.makeRotationFromEuler(ge.fromArray(f))}if(n.preRotation){var f=n.preRotation.map(THREE.Math.degToRad);f.push(l),ie.makeRotationFromEuler(ge.fromArray(f)),V.premultiply(ie)}if(n.postRotation){var f=n.postRotation.map(THREE.Math.degToRad);f.push(l),ie.makeRotationFromEuler(ge.fromArray(f)),ie.getInverse(ie),V.multiply(ie)}return n.scale&&o.scale(Ee.fromArray(n.scale)),o.setPosition(Ae),o.multiply(V),o}function K(n){var o=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return n===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),o[0]):o[n]}function se(n){var o=n.split(",").map(function(l){return parseFloat(l)});return o}function oe(n,o,l){return o===void 0&&(o=0),l===void 0&&(l=n.byteLength),THREE.LoaderUtils.decodeText(new Uint8Array(n,o,l))}function We(n,o){for(var l=0,f=n.length,p=o.length;l<p;l++,f++)n[f]=o[l]}function Ze(n,o,l,f){for(var p=l,g=0;p<f;p++,g++)n[g]=o[p];return n}function je(n,o,l){return n.slice(0,o).concat(l).concat(n.slice(o))}return r}();THREE.FBXLoader=Qi;AFRAME.registerComponent("fbx-model",{schema:{src:{type:"asset"},crossorigin:{default:""}},init:function(){this.model=null},update:function(){const e=this.data;if(!e.src)return;this.remove();const t=new THREE.FBXLoader;e.crossorigin&&t.setCrossOrigin(e.crossorigin),t.load(e.src,this.load.bind(this))},load:function(e){this.model=e,this.el.setObject3D("mesh",e),this.el.emit("model-loaded",{format:"fbx",model:e})},remove:function(){this.model&&this.el.removeObject3D("mesh")}});function en(){return"script_"+Date.now()+"_"+Math.ceil(Math.random()*1e5)}function tn(e,t){var i=document.createElement("script");return i.type="text/javascript",i.async=!0,i.id=t,i.src=e,i}function st(e){const t=document.getElementById(e),i=t.parentNode;try{i&&i.removeChild(t)}catch{}}function nn(e){const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}function rn(e,t,i){return new i(function(r,c){const d=t.timeout||5e3,m=en(),E=tn(e,m),w=setTimeout(function(){c(new Error("Script request to "+e+" timed out")),st(m)},d),L=function(R){clearTimeout(R)};E.addEventListener("load",function(R){r({ok:!0}),L(w),st(m)}),E.addEventListener("error",function(R){c(new Error("Script request to "+e+" failed "+R)),L(w),st(m)}),nn(E)})}function an(e){return e=e||{},function(t,i){return i=i||{},rn(t,i,e.Promise||Promise)}}var sn=an;const on=sn(),cn="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r86/examples/js/loaders/GLTFLoader.js",ln=function(){let e;return function(){return e=e||on(cn),e}}();AFRAME.registerComponent("gltf-model-legacy",{schema:{type:"model"},init:function(){this.model=null,this.loader=null,this.loaderPromise=ln().then(()=>{this.loader=new THREE.GLTFLoader,this.loader.setCrossOrigin("Anonymous")})},update:function(){const e=this,t=this.el,i=this.data;!i||(this.remove(),this.loaderPromise.then(()=>{this.loader.load(i,function(c){e.model=c.scene,e.model.animations=c.animations,t.setObject3D("mesh",e.model),t.emit("model-loaded",{format:"gltf",model:e.model})})}))},remove:function(){!this.model||this.el.removeObject3D("mesh")}});AFRAME.registerComponent("object-model",{schema:{src:{type:"asset"},crossorigin:{default:""}},init:function(){this.model=null},update:function(){let e;const t=this.data;!t.src||(this.remove(),e=new THREE.ObjectLoader,t.crossorigin&&e.setCrossOrigin(t.crossorigin),e.load(t.src,i=>{i.traverse(r=>{r instanceof THREE.SkinnedMesh&&r.material&&(r.material.skinning=!!(r.geometry&&r.geometry.bones||[]).length)}),this.load(i)}))},load:function(e){this.model=e,this.el.setObject3D("mesh",e),this.el.emit("model-loaded",{format:"json",model:e})},remove:function(){this.model&&this.el.removeObject3D("mesh")}});AFRAME.registerComponent("checkpoint",{schema:{offset:{default:{x:0,y:0,z:0},type:"vec3"}},init:function(){this.active=!1,this.targetEl=null,this.fire=this.fire.bind(this),this.offset=new THREE.Vector3},update:function(){this.offset.copy(this.data.offset)},play:function(){this.el.addEventListener("click",this.fire)},pause:function(){this.el.removeEventListener("click",this.fire)},remove:function(){this.pause()},fire:function(){const e=this.el.sceneEl.querySelector("[checkpoint-controls]");if(!e)throw new Error("No `checkpoint-controls` component found.");e.components["checkpoint-controls"].setCheckpoint(this.el)},getOffset:function(){return this.offset.copy(this.data.offset)}});function hn(e){return e?Array.isArray(e)?e:e.materials?e.materials:[e]:[]}function Ie(e,t,i,r){!e||(t=t||[],e.traverse(c=>{if(!c.isMesh)return;hn(c.material).forEach(m=>{m&&!("envMap"in m)||t.length&&t.indexOf(m.name)===-1||(m.envMap=i,m.reflectivity=r,m.needsUpdate=!0)})}))}AFRAME.registerComponent("cube-env-map",{multiple:!0,schema:{path:{default:""},extension:{default:"jpg",oneOf:["jpg","png"]},format:{default:"RGBFormat",oneOf:["RGBFormat","RGBAFormat"]},enableBackground:{default:!1},reflectivity:{default:1,min:0,max:1},materials:{default:[]}},init:function(){const e=this.data;this.texture=new THREE.CubeTextureLoader().load([e.path+"posx."+e.extension,e.path+"negx."+e.extension,e.path+"posy."+e.extension,e.path+"negy."+e.extension,e.path+"posz."+e.extension,e.path+"negz."+e.extension]),this.texture.format=THREE[e.format],this.object3dsetHandler=()=>{const t=this.el.getObject3D("mesh"),i=this.data;Ie(t,i.materials,this.texture,i.reflectivity)},this.el.addEventListener("object3dset",this.object3dsetHandler)},update:function(e){const t=this.data,i=this.el.getObject3D("mesh");let r=[],c=[];if(t.materials.length&&(e.materials?(r=t.materials.filter(d=>!e.materials.includes(d)),c=e.materials.filter(d=>!t.materials.includes(d))):r=t.materials),r.length&&Ie(i,r,this.texture,t.reflectivity),c.length&&Ie(i,c,null,1),e.materials&&t.reflectivity!==e.reflectivity){const d=t.materials.filter(m=>e.materials.includes(m));d.length&&Ie(i,d,this.texture,t.reflectivity)}this.data.enableBackground&&!e.enableBackground?this.setBackground(this.texture):!this.data.enableBackground&&e.enableBackground&&this.setBackground(null)},remove:function(){this.el.removeEventListener("object3dset",this.object3dsetHandler);const e=this.el.getObject3D("mesh"),t=this.data;Ie(e,t.materials,null,1),t.enableBackground&&this.setBackground(null)},setBackground:function(e){this.el.sceneEl.object3D.background=e}});AFRAME.registerComponent("grab",{init:function(){this.system=this.el.sceneEl.systems.physics,this.GRABBED_STATE="grabbed",this.grabbing=!1,this.hitEl=null,this.physics=this.el.sceneEl.systems.physics,this.constraint=null,this.onHit=this.onHit.bind(this),this.onGripOpen=this.onGripOpen.bind(this),this.onGripClose=this.onGripClose.bind(this)},play:function(){const e=this.el;e.addEventListener("hit",this.onHit),e.addEventListener("gripdown",this.onGripClose),e.addEventListener("gripup",this.onGripOpen),e.addEventListener("trackpaddown",this.onGripClose),e.addEventListener("trackpadup",this.onGripOpen),e.addEventListener("triggerdown",this.onGripClose),e.addEventListener("triggerup",this.onGripOpen)},pause:function(){const e=this.el;e.removeEventListener("hit",this.onHit),e.removeEventListener("gripdown",this.onGripClose),e.removeEventListener("gripup",this.onGripOpen),e.removeEventListener("trackpaddown",this.onGripClose),e.removeEventListener("trackpadup",this.onGripOpen),e.removeEventListener("triggerdown",this.onGripClose),e.removeEventListener("triggerup",this.onGripOpen)},onGripClose:function(){this.grabbing=!0},onGripOpen:function(){const e=this.hitEl;this.grabbing=!1,e&&(e.removeState(this.GRABBED_STATE),this.hitEl=void 0,this.system.removeConstraint(this.constraint),this.constraint=null)},onHit:function(e){const t=e.detail.el;!t||t.is(this.GRABBED_STATE)||!this.grabbing||this.hitEl||(t.addState(this.GRABBED_STATE),this.hitEl=t,this.constraint=new CANNON.LockConstraint(this.el.body,t.body),this.system.addConstraint(this.constraint))}});const un=-9.8,dn=-15;AFRAME.registerComponent("jump-ability",{dependencies:["velocity"],schema:{on:{default:"keydown:Space gamepadbuttondown:0"},playerHeight:{default:1.764},maxJumps:{default:1},distance:{default:5},debug:{default:!1}},init:function(){this.velocity=0,this.numJumps=0;const e=this.beginJump.bind(this),t=this.data.on.split(" ");this.bindings={};for(let i=0;i<t.length;i++)this.bindings[t[i]]=e,this.el.addEventListener(t[i],e);this.bindings.collide=this.onCollide.bind(this),this.el.addEventListener("collide",this.bindings.collide)},remove:function(){for(var e in this.bindings)this.bindings.hasOwnProperty(e)&&(this.el.removeEventListener(e,this.bindings[e]),delete this.bindings[e]);this.el.removeEventListener("collide",this.bindings.collide),delete this.bindings.collide},beginJump:function(){if(this.numJumps<this.data.maxJumps){const e=this.data,t=Math.sqrt(-2*e.distance*(un+dn)),i=this.el.getAttribute("velocity");this.el.setAttribute("velocity",{x:i.x,y:t,z:i.z}),this.numJumps++,this.el.emit("jumpstart")}},onCollide:function(){this.numJumps>0&&this.el.emit("jumpend"),this.numJumps=0}});const Ht=1e-6;AFRAME.registerComponent("kinematic-body",{dependencies:["velocity"],schema:{mass:{default:5},radius:{default:1.3},linearDamping:{default:.05},enableSlopes:{default:!0},enableJumps:{default:!1}},init:function(){this.system=this.el.sceneEl.systems.physics,this.system.addComponent(this);const e=this.el,t=this.data,i=new CANNON.Vec3().copy(e.object3D.getWorldPosition(new THREE.Vector3));this.body=new CANNON.Body({material:this.system.getMaterial("staticMaterial"),position:i,mass:t.mass,linearDamping:t.linearDamping,fixedRotation:!0}),this.body.addShape(new CANNON.Sphere(t.radius),new CANNON.Vec3(0,t.radius,0)),this.body.el=this.el,this.el.body=this.body,this.system.addBody(this.body),e.hasAttribute("wasd-controls")&&console.warn("[kinematic-body] Not compatible with wasd-controls, use movement-controls.")},remove:function(){this.system.removeBody(this.body),this.system.removeComponent(this),delete this.el.body},beforeStep:function(e,t){if(!t)return;const i=this.el,r=this.data,c=this.body;r.enableJumps||c.velocity.set(0,0,0),c.position.copy(i.getAttribute("position"))},step:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3,r=new THREE.Vector3;return function(c,d){if(!d)return;let m=this.body,E=this.data,w=!1,L,R=-1/0,B,O=this.system.getContacts();d=Math.min(d,this.system.data.maxInterval*1e3),r.set(0,0,0),e.copy(this.el.getAttribute("velocity")),m.velocity.copy(e);for(var M=0,N;N=O[M];M++)if(!!N.enabled){if(m.id===N.bi.id)N.ni.negate(i);else if(m.id===N.bj.id)i.copy(N.ni);else continue;w=m.velocity.dot(i)<-Ht,w&&i.y<=.5?e.projectOnPlane(i):i.y>.5&&(L=m.id===N.bi.id?Math.abs(N.rj.y+N.bj.position.y):Math.abs(N.ri.y+N.bi.position.y),L>R&&(R=L,r.copy(i),B=m.id===N.bi.id?N.bj:N.bi))}t.copy(e).normalize(),B&&(!E.enableJumps||t.y<.5)?(E.enableSlopes?r.y<1-Ht&&r.copy(this.raycastToGround(B,r)):r.set(0,1,0),e.projectOnPlane(r)):this.system.driver.world&&e.add(this.system.driver.world.gravity.scale(d*4/1e3)),m.velocity.copy(e),this.el.setAttribute("velocity",m.velocity),this.el.setAttribute("position",m.position)}}(),raycastToGround:function(e,t){let i,r,c=this.body.position,d=this.body.position.clone();return i=new CANNON.Ray(c,d),i._updateDirection(),i.intersectBody(e),i.hasHit?(r=i.result.hitNormalWorld,Math.abs(r.y)>Math.abs(t.y)?r:t):t}});AFRAME.registerComponent("mesh-smooth",{init:function(){this.el.addEventListener("model-loaded",e=>{e.detail.model.traverse(t=>{t.isMesh&&t.geometry.computeVertexNormals()})})}});AFRAME.registerComponent("normal-material",{init:function(){this.material=new THREE.MeshNormalMaterial({flatShading:!0}),this.applyMaterial=this.applyMaterial.bind(this),this.el.addEventListener("object3dset",this.applyMaterial)},remove:function(){this.el.removeEventListener("object3dset",this.applyMaterial)},applyMaterial:function(){this.el.object3D.traverse(e=>{e.isMesh&&(e.material=this.material)})}});AFRAME.registerComponent("sphere-collider",{schema:{objects:{default:""},state:{default:"collided"},radius:{default:.05},watch:{default:!0}},init:function(){this.observer=null,this.els=[],this.collisions=[],this.handleHit=this.handleHit.bind(this),this.handleHitEnd=this.handleHitEnd.bind(this)},remove:function(){this.pause()},play:function(){const e=this.el.sceneEl;this.data.watch&&(this.observer=new MutationObserver(this.update.bind(this,null)),this.observer.observe(e,{childList:!0,subtree:!0}))},pause:function(){this.observer&&(this.observer.disconnect(),this.observer=null)},update:function(){const e=this.data;let t;e.objects?t=this.el.sceneEl.querySelectorAll(e.objects):t=this.el.sceneEl.children,this.els=Array.prototype.slice.call(t)},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3,r=new THREE.Vector3,c=new THREE.Box3,d=new Map;return function(){const m=this.el,E=this.data,w=m.getObject3D("mesh"),L=[];let R;if(!w)return;d.clear(),m.object3D.getWorldPosition(e),m.object3D.getWorldScale(i),R=E.radius*O(i),this.els.forEach(B),L.sort((M,N)=>d.get(M)>d.get(N)?1:-1).forEach(this.handleHit),L.length===0&&m.emit("hit",{el:null}),this.collisions.filter(M=>!d.has(M)).forEach(this.handleHitEnd),this.collisions=L;function B(M){let N,re,ae,ie;!M.isEntity||(re=M.getObject3D("mesh"),re&&(c.setFromObject(re).getSize(r),ie=Math.max(r.x,r.y,r.z)/2,N=Math.sqrt(2*ie*ie),c.getCenter(t),N&&(ae=e.distanceTo(t),ae<N+R&&(L.push(M),d.set(M,ae)))))}function O(M){return Math.max.apply(null,M.toArray())}}}(),handleHit:function(e){e.emit("hit"),e.addState(this.data.state),this.el.emit("hit",{el:e})},handleHitEnd:function(e){e.emit("hitend"),e.removeState(this.data.state),this.el.emit("hitend",{el:e})}});AFRAME.registerComponent("nav-mesh",{init:function(){this.system=this.el.sceneEl.systems.nav,this.hasLoadedNavMesh=!1,this.el.addEventListener("object3dset",this.loadNavMesh.bind(this))},play:function(){this.hasLoadedNavMesh||this.loadNavMesh()},loadNavMesh:function(){const e=this.el.getObject3D("mesh"),t=this.el.sceneEl.object3D;if(!e)return;let i;if(e.traverse(c=>{c.isMesh&&(i=c)}),!i)return;const r=i.geometry.isBufferGeometry?new THREE.Geometry().fromBufferGeometry(i.geometry):i.geometry.clone();t.updateMatrixWorld(),r.applyMatrix(i.matrixWorld),this.system.setNavMeshGeometry(r),this.hasLoadedNavMesh=!0}});AFRAME.registerComponent("nav-agent",{schema:{destination:{type:"vec3"},active:{default:!1},speed:{default:2}},init:function(){this.system=this.el.sceneEl.systems.nav,this.system.addAgent(this),this.group=null,this.path=[],this.raycaster=new THREE.Raycaster},remove:function(){this.system.removeAgent(this)},update:function(){this.path.length=0},updateNavLocation:function(){this.group=null,this.path=[]},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3;return function(r,c){const d=this.el,m=this.data,E=this.raycaster,w=m.speed*c/1e3;if(!m.active)return;if(!this.path.length){const N=this.el.object3D.position;this.group=this.group||this.system.getGroup(N),this.path=this.system.getPath(N,e.copy(m.destination),this.group)||[],d.emit("navigation-start")}if(!this.path.length){console.warn("[nav] Unable to find path to %o.",m.destination),this.el.setAttribute("nav-agent",{active:!1}),d.emit("navigation-end");return}const L=d.object3D.position,R=this.path[0];t.subVectors(R,L);const B=t.length();let O;if(B<w){if(this.path.shift(),!this.path.length){this.el.setAttribute("nav-agent",{active:!1}),d.emit("navigation-end");return}i.copy(L),O=this.path[0]}else i.copy(t.setLength(w)).add(L),O=R;O.y=L.y,d.object3D.lookAt(O),E.ray.origin.copy(i),E.ray.origin.y+=1.5,E.ray.direction.y=-1;const M=E.intersectObject(this.system.getNavMesh());M.length?(t.subVectors(M[0].point,L),L.add(t.setLength(w))):L.copy(i)}}()});var $=function(){};$.computeCentroids=function(e){var t,i,r;for(t=0,i=e.faces.length;t<i;t++)(r=e.faces[t]).centroid=new THREE.Vector3(0,0,0),r.centroid.add(e.vertices[r.a]),r.centroid.add(e.vertices[r.b]),r.centroid.add(e.vertices[r.c]),r.centroid.divideScalar(3)},$.roundNumber=function(e,t){return Number(e.toFixed(t))},$.sample=function(e){return e[Math.floor(Math.random()*e.length)]},$.mergeVertexIds=function(e,t){var i=[];if(e.forEach(function(w){t.indexOf(w)>=0&&i.push(w)}),i.length<2)return[];i.includes(e[0])&&i.includes(e[e.length-1])&&e.push(e.shift()),i.includes(t[0])&&i.includes(t[t.length-1])&&t.push(t.shift()),i=[],e.forEach(function(w){t.includes(w)&&i.push(w)});for(var r=i[1],c=i[0],d=e.slice();d[0]!==r;)d.push(d.shift());for(var m=0,E=t.slice();E[0]!==c;)if(E.push(E.shift()),m++>10)throw new Error("Unexpected state");return E.shift(),E.pop(),d=d.concat(E)},$.setPolygonCentroid=function(e,t){var i=new THREE.Vector3,r=t.vertices;e.vertexIds.forEach(function(c){i.add(r[c])}),i.divideScalar(e.vertexIds.length),e.centroid.copy(i)},$.cleanPolygon=function(e,t){for(var i=[],r=t.vertices,c=0;c<e.vertexIds.length;c++){var d,m,E,w=r[e.vertexIds[c]];c===0?(d=e.vertexIds[1],m=e.vertexIds[e.vertexIds.length-1]):c===e.vertexIds.length-1?(d=e.vertexIds[0],m=e.vertexIds[e.vertexIds.length-2]):(d=e.vertexIds[c+1],m=e.vertexIds[c-1]),E=r[m];var L=r[d].clone().sub(w),R=E.clone().sub(w),B=L.angleTo(R);if(B>Math.PI-.01&&B<Math.PI+.01){var O=[];e.neighbours.forEach(function(M){M.vertexIds.includes(e.vertexIds[c])||O.push(M)}),e.neighbours=O}else i.push(e.vertexIds[c])}e.vertexIds=i,this.setPolygonCentroid(e,t)},$.isConvex=function(e,t){var i=t.vertices;if(e.vertexIds.length<3)return!1;for(var r=!0,c=[],d=0;d<e.vertexIds.length;d++){var m,E,w=i[e.vertexIds[d]];d===0?(m=i[e.vertexIds[1]],E=i[e.vertexIds[e.vertexIds.length-1]]):d===e.vertexIds.length-1?(m=i[e.vertexIds[0]],E=i[e.vertexIds[e.vertexIds.length-2]]):(m=i[e.vertexIds[d+1]],E=i[e.vertexIds[d-1]]);var L=m.clone().sub(w),R=E.clone().sub(w),B=L.angleTo(R);if(B===Math.PI||B===0)return!1;var O=L.cross(R).y;c.push(O)}return c.forEach(function(M){M===0&&(r=!1)}),c.forEach(c[0]>0?function(M){M<0&&(r=!1)}:function(M){M>0&&(r=!1)}),r},$.distanceToSquared=function(e,t){var i=e.x-t.x,r=e.y-t.y,c=e.z-t.z;return i*i+r*r+c*c},$.isPointInPoly=function(e,t){for(var i=!1,r=-1,c=e.length,d=c-1;++r<c;d=r)(e[r].z<=t.z&&t.z<e[d].z||e[d].z<=t.z&&t.z<e[r].z)&&t.x<(e[d].x-e[r].x)*(t.z-e[r].z)/(e[d].z-e[r].z)+e[r].x&&(i=!i);return i},$.isVectorInPolygon=function(e,t,i){var r=1e5,c=-1e5,d=[];return t.vertexIds.forEach(function(m){r=Math.min(i[m].y,r),c=Math.max(i[m].y,c),d.push(i[m])}),!!(e.y<c+.5&&e.y>r-.5&&this.isPointInPoly(d,e))},$.triarea2=function(e,t,i){return(i.x-e.x)*(t.z-e.z)-(t.x-e.x)*(i.z-e.z)},$.vequal=function(e,t){return this.distanceToSquared(e,t)<1e-5};var Me=function(e){this.content=[],this.scoreFunction=e};Me.prototype.push=function(e){this.content.push(e),this.sinkDown(this.content.length-1)},Me.prototype.pop=function(){var e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e},Me.prototype.remove=function(e){var t=this.content.indexOf(e),i=this.content.pop();t!==this.content.length-1&&(this.content[t]=i,this.scoreFunction(i)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))},Me.prototype.size=function(){return this.content.length},Me.prototype.rescoreElement=function(e){this.sinkDown(this.content.indexOf(e))},Me.prototype.sinkDown=function(e){for(var t=this.content[e];e>0;){var i=(e+1>>1)-1,r=this.content[i];if(!(this.scoreFunction(t)<this.scoreFunction(r)))break;this.content[i]=t,this.content[e]=r,e=i}},Me.prototype.bubbleUp=function(e){for(var t=this.content.length,i=this.content[e],r=this.scoreFunction(i);;){var c=e+1<<1,d=c-1,m=null,E=void 0;if(d<t&&(E=this.scoreFunction(this.content[d]))<r&&(m=d),c<t&&this.scoreFunction(this.content[c])<(m===null?r:E)&&(m=c),m===null)break;this.content[e]=this.content[m],this.content[m]=i,e=m}};var He=function(){};He.init=function(e){for(var t=0;t<e.length;t++){var i=e[t];i.f=0,i.g=0,i.h=0,i.cost=1,i.visited=!1,i.closed=!1,i.parent=null}},He.cleanUp=function(e){for(var t=0;t<e.length;t++){var i=e[t];delete i.f,delete i.g,delete i.h,delete i.cost,delete i.visited,delete i.closed,delete i.parent}},He.heap=function(){return new Me(function(e){return e.f})},He.search=function(e,t,i){this.init(e);var r=this.heap();for(r.push(t);r.size()>0;){var c=r.pop();if(c===i){for(var d=c,m=[];d.parent;)m.push(d),d=d.parent;return this.cleanUp(m),m.reverse()}c.closed=!0;for(var E=this.neighbours(e,c),w=0,L=E.length;w<L;w++){var R=E[w];if(!R.closed){var B=c.g+R.cost,O=R.visited;if(!O||B<R.g){if(R.visited=!0,R.parent=c,!R.centroid||!i.centroid)throw new Error("Unexpected state");R.h=R.h||this.heuristic(R.centroid,i.centroid),R.g=B,R.f=R.g+R.h,O?r.rescoreElement(R):r.push(R)}}}}return[]},He.heuristic=function(e,t){return $.distanceToSquared(e,t)},He.neighbours=function(e,t){for(var i=[],r=0;r<t.neighbours.length;r++)i.push(e[t.neighbours[r]]);return i};var fn=1,_e=function(){};_e.buildZone=function(e){var t=this,i=this._buildNavigationMesh(e),r={};i.vertices.forEach(function(m){m.x=$.roundNumber(m.x,2),m.y=$.roundNumber(m.y,2),m.z=$.roundNumber(m.z,2)}),r.vertices=i.vertices;var c=this._buildPolygonGroups(i);r.groups=[];var d=function(m,E){for(var w=0;w<m.length;w++)if(E===m[w])return w};return c.forEach(function(m){var E=[];m.forEach(function(w){var L=w.neighbours.map(function(B){return d(m,B)}),R=w.neighbours.map(function(B){return t._getSharedVerticesInOrder(w,B)});w.centroid.x=$.roundNumber(w.centroid.x,2),w.centroid.y=$.roundNumber(w.centroid.y,2),w.centroid.z=$.roundNumber(w.centroid.z,2),E.push({id:d(m,w),neighbours:L,vertexIds:w.vertexIds,centroid:w.centroid,portals:R})}),r.groups.push(E)}),r},_e._buildNavigationMesh=function(e){return $.computeCentroids(e),e.mergeVertices(),this._buildPolygonsFromGeometry(e)},_e._buildPolygonGroups=function(e){var t=[],i=0,r=function(c){c.neighbours.forEach(function(d){d.group===void 0&&(d.group=c.group,r(d))})};return e.polygons.forEach(function(c){c.group===void 0&&(c.group=i++,r(c)),t[c.group]||(t[c.group]=[]),t[c.group].push(c)}),t},_e._buildPolygonNeighbours=function(e,t,i){var r=new Set,c=i.get(e.vertexIds[0]),d=i.get(e.vertexIds[1]),m=i.get(e.vertexIds[2]);c.forEach(function(E){(d.has(E)||m.has(E))&&r.add(t.polygons[E])}),d.forEach(function(E){m.has(E)&&r.add(t.polygons[E])}),e.neighbours=Array.from(r)},_e._buildPolygonsFromGeometry=function(e){for(var t=this,i=[],r=e.vertices,c=e.faceVertexUvs,d=new Map,m=0;m<r.length;m++)d.set(m,new Set);e.faces.forEach(function(w){i.push({id:fn++,vertexIds:[w.a,w.b,w.c],centroid:w.centroid,normal:w.normal,neighbours:[]}),d.get(w.a).add(i.length-1),d.get(w.b).add(i.length-1),d.get(w.c).add(i.length-1)});var E={polygons:i,vertices:r,faceVertexUvs:c};return i.forEach(function(w){t._buildPolygonNeighbours(w,E,d)}),E},_e._getSharedVerticesInOrder=function(e,t){var i=e.vertexIds,r=t.vertexIds,c=new Set;if(i.forEach(function(m){r.includes(m)&&c.add(m)}),c.size<2)return[];c.has(i[0])&&c.has(i[i.length-1])&&i.push(i.shift()),c.has(r[0])&&c.has(r[r.length-1])&&r.push(r.shift());var d=[];return i.forEach(function(m){r.includes(m)&&d.push(m)}),d};var dt=function(){this.portals=[]};dt.prototype.push=function(e,t){t===void 0&&(t=e),this.portals.push({left:e,right:t})},dt.prototype.stringPull=function(){var e,t,i,r=this.portals,c=[],d=0,m=0,E=0;t=r[0].left,i=r[0].right,c.push(e=r[0].left);for(var w=1;w<r.length;w++){var L=r[w].left,R=r[w].right;if($.triarea2(e,i,R)<=0){if(!($.vequal(e,i)||$.triarea2(e,t,R)>0)){c.push(t),t=e=t,i=e,m=d=m,E=d,w=d;continue}i=R,E=w}if($.triarea2(e,t,L)>=0){if(!($.vequal(e,t)||$.triarea2(e,i,L)<0)){c.push(i),t=e=i,i=e,m=d=E,E=d,w=d;continue}t=L,m=w}}return c.length!==0&&$.vequal(c[c.length-1],r[r.length-1].left)||c.push(r[r.length-1].left),this.path=c,c};var ot,ct,Le,lt,ht,Xe,Se=function(){this.zones={}};Se.createZone=function(e){return _e.buildZone(e)},Se.prototype.setZoneData=function(e,t){this.zones[e]=t},Se.prototype.getGroup=function(e,t){if(!this.zones[e])return null;var i=null,r=Math.pow(50,2);return this.zones[e].groups.forEach(function(c,d){c.forEach(function(m){var E=$.distanceToSquared(m.centroid,t);E<r&&(i=d,r=E)})}),i},Se.prototype.getRandomNode=function(e,t,i,r){if(!this.zones[e])return new THREE.Vector3;i=i||null,r=r||0;var c=[];return this.zones[e].groups[t].forEach(function(d){i&&r?$.distanceToSquared(i,d.centroid)<r*r&&c.push(d.centroid):c.push(d.centroid)}),$.sample(c)||new THREE.Vector3},Se.prototype.getClosestNode=function(e,t,i,r){r===void 0&&(r=!1);var c=this.zones[t].vertices,d=null,m=1/0;return this.zones[t].groups[i].forEach(function(E){var w=$.distanceToSquared(E.centroid,e);w<m&&(!r||$.isVectorInPolygon(e,E,c))&&(d=E,m=w)}),d},Se.prototype.findPath=function(e,t,i,r){var c=this.zones[i].groups[r],d=this.zones[i].vertices,m=this.getClosestNode(e,i,r),E=this.getClosestNode(t,i,r,!0);if(!m||!E)return null;var w=He.search(c,m,E),L=function(re,ae){for(var ie=0;ie<re.neighbours.length;ie++)if(re.neighbours[ie]===ae.id)return re.portals[ie]},R=new dt;R.push(e);for(var B=0;B<w.length;B++){var O=w[B+1];if(O){var M=L(w[B],O);R.push(d[M[0]],d[M[1]])}}R.push(t),R.stringPull();var N=R.path.map(function(re){return new THREE.Vector3(re.x,re.y,re.z)});return N.shift(),N},Se.prototype.clampStep=(Le=new THREE.Vector3,lt=new THREE.Plane,ht=new THREE.Triangle,Xe=new THREE.Vector3,function(e,t,i,r,c,d){var m=this.zones[r].vertices,E=this.zones[r].groups[c],w=[i],L={};L[i.id]=0,ot=void 0,Xe.set(0,0,0),ct=1/0,lt.setFromCoplanarPoints(m[i.vertexIds[0]],m[i.vertexIds[1]],m[i.vertexIds[2]]),lt.projectPoint(t,Le),t.copy(Le);for(var R=w.pop();R;R=w.pop()){ht.set(m[R.vertexIds[0]],m[R.vertexIds[1]],m[R.vertexIds[2]]),ht.closestPointToPoint(t,Le),Le.distanceToSquared(t)<ct&&(ot=R,Xe.copy(Le),ct=Le.distanceToSquared(t));var B=L[R];if(!(B>2))for(var O=0;O<R.neighbours.length;O++){var M=E[R.neighbours[O]];M.id in L||(w.push(M),L[M.id]=B+1)}}return d.copy(Xe),ot});var pn=Object.freeze(Object.defineProperty({__proto__:null,Pathfinding:Se},Symbol.toStringTag,{value:"Module"})),vn=ji(pn);const{Pathfinding:Ot}=vn,Be=new Ot,ze="level";AFRAME.registerSystem("nav",{init:function(){this.navMesh=null,this.agents=new Set},setNavMeshGeometry:function(e){this.navMesh=new THREE.Mesh(e),Be.setZoneData(ze,Ot.createZone(e)),Array.from(this.agents).forEach(t=>t.updateNavLocation())},getNavMesh:function(){return this.navMesh},addAgent:function(e){this.agents.add(e)},removeAgent:function(e){this.agents.delete(e)},getPath:function(e,t,i){return this.navMesh?Be.findPath(e,t,ze,i):null},getGroup:function(e){return this.navMesh?Be.getGroup(ze,e):null},getNode:function(e,t){return this.navMesh?Be.getClosestNode(e,ze,t,!0):null},clampStep:function(e,t,i,r,c){if(this.navMesh){if(!r)return c.copy(t),this.getNode(t,i)}else return c.copy(t),null;return Be.clampStep(e,t,r,ze,i,c)}});AFRAME.registerPrimitive("a-grid",{defaultComponents:{geometry:{primitive:"plane",width:75,height:75},rotation:{x:-90,y:0,z:0},material:{src:"url(https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v1.16.3/assets/grid.png)",repeat:"75 75"}},mappings:{width:"geometry.width",height:"geometry.height",src:"material.src"}});var Dt={exports:{}},x=Dt.exports={VERSION:"0.1.1",PI:Math.PI,TAU:2*Math.PI,DEG_TO_RAD:.0174532925,RAD_TO_DEG:57.2957795,SQRT3:Math.sqrt(3),TILE:"tile",ENT:"entity",STR:"structure",HEX:"hex",SQR:"square",ABS:"abstract"};x.Board=function(e,t){if(!e)throw new Error("You must pass in a grid system for the board to use.");this.tiles=[],this.tileGroup=null,this.group=new THREE.Object3D,this.grid=null,this.overlay=null,this.finder=new x.AStarFinder(t),x.Loader.init(),this.setGrid(e)},x.Board.prototype={setEntityOnTile:function(e,t){var i=this.grid.cellToPixel(t.cell);e.position.copy(i),e.position.y+=e.heightOffset||0,e.tile&&(e.tile.entity=null),e.tile=t,t.entity=e},addTile:function(e){var t=this.tiles.indexOf(e);t===-1&&(this.tiles.push(e),this.snapTileToGrid(e),e.position.y=0,this.tileGroup.add(e.mesh),this.grid.add(e.cell),e.cell.tile=e)},removeTile:function(e){if(e){var t=this.tiles.indexOf(e);this.grid.remove(e.cell),t!==-1&&this.tiles.splice(t,1),e.dispose()}},removeAllTiles:function(){if(this.tileGroup)for(var e=this.tileGroup.children,t=0;t<e.length;t++)this.tileGroup.remove(e[t])},getTileAtCell:function(e){var t=this.grid.cellToHash(e);return e.tile||(typeof this.grid.cells[t]!="undefined"?this.grid.cells[t].tile:null)},snapToGrid:function(e){var t=this.grid.pixelToCell(e);e.copy(this.grid.cellToPixel(t))},snapTileToGrid:function(e){if(e.cell)e.position.copy(this.grid.cellToPixel(e.cell));else{var t=this.grid.pixelToCell(e.position);e.position.copy(this.grid.cellToPixel(t))}return e},getRandomTile:function(){var e=x.Tools.randomInt(0,this.tiles.length-1);return this.tiles[e]},findPath:function(e,t,i){return this.finder.findPath(e.cell,t.cell,i,this.grid)},setGrid:function(e){this.group.remove(this.tileGroup),this.grid&&e!==this.grid&&(this.removeAllTiles(),this.tiles.forEach(function(t){this.grid.remove(t.cell),t.dispose()}),this.grid.dispose()),this.grid=e,this.tiles=[],this.tileGroup=new THREE.Object3D,this.group.add(this.tileGroup)},generateOverlay:function(e){var t=new THREE.LineBasicMaterial({color:0,opacity:.3});this.overlay&&this.group.remove(this.overlay),this.overlay=new THREE.Object3D,this.grid.generateOverlay(e,this.overlay,t),this.group.add(this.overlay)},generateTilemap:function(e){this.reset();var t=this.grid.generateTiles(e);this.tiles=t,this.tileGroup=new THREE.Object3D;for(var i=0;i<t.length;i++)this.tileGroup.add(t[i].mesh);this.group.add(this.tileGroup)},reset:function(){this.removeAllTiles(),this.tileGroup&&this.group.remove(this.tileGroup)}},x.Board.prototype.constructor=x.Board,x.Cell=function(e,t,i,r){this.q=e||0,this.r=t||0,this.s=i||0,this.h=r||1,this.tile=null,this.userData={},this.walkable=!0,this._calcCost=0,this._priority=0,this._visited=!1,this._parent=null,this.uniqueID=x.LinkedList.generateID()},x.Cell.prototype={set:function(e,t,i){return this.q=e,this.r=t,this.s=i,this},copy:function(e){return this.q=e.q,this.r=e.r,this.s=e.s,this.h=e.h,this.tile=e.tile||null,this.userData=e.userData||{},this.walkable=e.walkable,this},add:function(e){return this.q+=e.q,this.r+=e.r,this.s+=e.s,this},equals:function(e){return this.q===e.q&&this.r===e.r&&this.s===e.s}},x.Cell.prototype.constructor=x.Cell,x.HexGrid=function(e){e=e||{},this.type=x.HEX,this.size=5,this.cellSize=typeof e.cellSize=="undefined"?10:e.cellSize,this.cells={},this.numCells=0,this.extrudeSettings=null,this.autogenerated=!1;var t,i=[];for(t=0;6>t;t++)i.push(this._createVertex(t));for(this.cellShape=new THREE.Shape,this.cellShape.moveTo(i[0].x,i[0].y),t=1;6>t;t++)this.cellShape.lineTo(i[t].x,i[t].y);this.cellShape.lineTo(i[0].x,i[0].y),this.cellShape.autoClose=!0,this.cellGeo=new THREE.Geometry,this.cellGeo.vertices=i,this.cellGeo.verticesNeedUpdate=!0,this.cellShapeGeo=new THREE.ShapeGeometry(this.cellShape),this._cellWidth=2*this.cellSize,this._cellLength=.5*x.SQRT3*this._cellWidth,this._hashDelimeter=".",this._directions=[new x.Cell(1,-1,0),new x.Cell(1,0,-1),new x.Cell(0,1,-1),new x.Cell(-1,1,0),new x.Cell(-1,0,1),new x.Cell(0,-1,1)],this._diagonals=[new x.Cell(2,-1,-1),new x.Cell(1,1,-2),new x.Cell(-1,2,-1),new x.Cell(-2,1,1),new x.Cell(-1,-1,2),new x.Cell(1,-2,1)],this._list=[],this._vec3=new THREE.Vector3,this._cel=new x.Cell,this._conversionVec=new THREE.Vector3,this._geoCache=[],this._matCache=[]},x.HexGrid.TWO_THIRDS=2/3,x.HexGrid.prototype={cellToPixel:function(e){return this._vec3.x=e.q*this._cellWidth*.75,this._vec3.y=e.h,this._vec3.z=-((e.s-e.r)*this._cellLength*.5),this._vec3},pixelToCell:function(e){var t=e.x*(x.HexGrid.TWO_THIRDS/this.cellSize),i=(-e.x/3+x.SQRT3/3*e.z)/this.cellSize;return this._cel.set(t,i,-t-i),this._cubeRound(this._cel)},getCellAt:function(e){var t=e.x*(x.HexGrid.TWO_THIRDS/this.cellSize),i=(-e.x/3+x.SQRT3/3*e.z)/this.cellSize;return this._cel.set(t,i,-t-i),this._cubeRound(this._cel),this.cells[this.cellToHash(this._cel)]},getNeighbors:function(e,t,i){var r,c,d=this._directions.length;for(this._list.length=0,r=0;d>r;r++)this._cel.copy(e),this._cel.add(this._directions[r]),c=this.cells[this.cellToHash(this._cel)],!c||i&&!i(e,c)||this._list.push(c);if(t)for(r=0;d>r;r++)this._cel.copy(e),this._cel.add(this._diagonals[r]),c=this.cells[this.cellToHash(this._cel)],!c||i&&!i(e,c)||this._list.push(c);return this._list},getRandomCell:function(){var e,t=0,i=x.Tools.randomInt(0,this.numCells);for(e in this.cells){if(t===i)return this.cells[e];t++}return this.cells[e]},cellToHash:function(e){return e.q+this._hashDelimeter+e.r+this._hashDelimeter+e.s},distance:function(e,t){var i=Math.max(Math.abs(e.q-t.q),Math.abs(e.r-t.r),Math.abs(e.s-t.s));return i+=t.h-e.h},clearPath:function(){var e,t;for(e in this.cells)t=this.cells[e],t._calcCost=0,t._priority=0,t._parent=null,t._visited=!1},traverse:function(e){var t;for(t in this.cells)e(this.cells[t])},generateTile:function(e,t,i){var r=Math.abs(e.h);1>r&&(r=1);var c=this._geoCache[r];c||(this.extrudeSettings.amount=r,c=new THREE.ExtrudeGeometry(this.cellShape,this.extrudeSettings),this._geoCache[r]=c);var d=new x.Tile({size:this.cellSize,scale:t,cell:e,geometry:c,material:i});return e.tile=d,d},generateTiles:function(e){e=e||{};var t=[],i={tileScale:.95,cellSize:this.cellSize,material:null,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5}};i=x.Tools.merge(i,e),this.cellSize=i.cellSize,this._cellWidth=2*this.cellSize,this._cellLength=.5*x.SQRT3*this._cellWidth,this.autogenerated=!0,this.extrudeSettings=i.extrudeSettings;var r,c,d;for(r in this.cells)d=this.cells[r],c=this.generateTile(d,i.tileScale,i.material),c.position.copy(this.cellToPixel(d)),c.position.y=0,t.push(c);return t},generateTilePoly:function(e){e||(e=new THREE.MeshBasicMaterial({color:2405631}));var t=new THREE.Mesh(this.cellShapeGeo,e);return this._vec3.set(1,0,0),t.rotateOnAxis(this._vec3,x.PI/2),t},generate:function(e){e=e||{},this.size=typeof e.size=="undefined"?this.size:e.size;var t,i,r,c;for(t=-this.size;t<this.size+1;t++)for(i=-this.size;i<this.size+1;i++)r=-t-i,Math.abs(t)<=this.size&&Math.abs(i)<=this.size&&Math.abs(r)<=this.size&&(c=new x.Cell(t,i,r),this.add(c))},generateOverlay:function(e,t,i){var r,c,d,m=this.cellShape.createPointsGeometry();for(r=-e;e+1>r;r++)for(c=-e;e+1>c;c++)if(d=-r-c,Math.abs(r)<=e&&Math.abs(c)<=e&&Math.abs(d)<=e){this._cel.set(r,c,d);var E=new THREE.Line(m,i);E.position.copy(this.cellToPixel(this._cel)),E.rotation.x=90*x.DEG_TO_RAD,t.add(E)}},add:function(e){var t=this.cellToHash(e);if(!this.cells[t])return this.cells[t]=e,this.numCells++,e},remove:function(e){var t=this.cellToHash(e);this.cells[t]&&(delete this.cells[t],this.numCells--)},dispose:function(){this.cells=null,this.numCells=0,this.cellShape=null,this.cellGeo.dispose(),this.cellGeo=null,this.cellShapeGeo.dispose(),this.cellShapeGeo=null,this._list=null,this._vec3=null,this._conversionVec=null,this._geoCache=null,this._matCache=null},load:function(e,t,i){var r=this;x.Tools.getJSON({url:e,callback:function(c){r.fromJSON(c),t.call(i||null,c)},cache:!1,scope:r})},fromJSON:function(e){var t,i,r=e.cells;for(this.cells={},this.numCells=0,this.size=e.size,this.cellSize=e.cellSize,this._cellWidth=2*this.cellSize,this._cellLength=.5*x.SQRT3*this._cellWidth,this.extrudeSettings=e.extrudeSettings,this.autogenerated=e.autogenerated,t=0;t<r.length;t++)i=new x.Cell,i.copy(r[t]),this.add(i)},toJSON:function(){var e,t,i={size:this.size,cellSize:this.cellSize,extrudeSettings:this.extrudeSettings,autogenerated:this.autogenerated},r=[];for(t in this.cells)e=this.cells[t],r.push({q:e.q,r:e.r,s:e.s,h:e.h,walkable:e.walkable,userData:e.userData});return i.cells=r,i},_createVertex:function(e){var t=x.TAU/6*e;return new THREE.Vector3(this.cellSize*Math.cos(t),this.cellSize*Math.sin(t),0)},_cubeRound:function(e){var t=Math.round(e.q),i=Math.round(e.r),r=Math.round(e.s),c=Math.abs(t-e.q),d=Math.abs(i-e.r),m=Math.abs(r-e.s);return c>d&&c>m?t=-i-r:d>m?i=-t-r:r=-t-i,this._cel.set(t,i,r)}},x.HexGrid.prototype.constructor=x.HexGrid,x.SqrGrid=function(e){e=e||{},this.type=x.SQR,this.size=5,this.cellSize=typeof e.cellSize=="undefined"?10:e.cellSize,this.cells={},this.numCells=0,this.extrudeSettings=null,this.autogenerated=!1;var t=[];t.push(new THREE.Vector3),t.push(new THREE.Vector3(-this.cellSize,this.cellSize)),t.push(new THREE.Vector3(this.cellSize,this.cellSize)),t.push(new THREE.Vector3(this.cellSize,-this.cellSize)),this.cellShape=new THREE.Shape,this.cellShape.moveTo(-this.cellSize,-this.cellSize),this.cellShape.lineTo(-this.cellSize,this.cellSize),this.cellShape.lineTo(this.cellSize,this.cellSize),this.cellShape.lineTo(this.cellSize,-this.cellSize),this.cellShape.lineTo(-this.cellSize,-this.cellSize),this.cellGeo=new THREE.Geometry,this.cellGeo.vertices=t,this.cellGeo.verticesNeedUpdate=!0,this.cellShapeGeo=new THREE.ShapeGeometry(this.cellShape),this._fullCellSize=2*this.cellSize,this._hashDelimeter=".",this._directions=[new x.Cell(1,0,0),new x.Cell(0,-1,0),new x.Cell(-1,0,0),new x.Cell(0,1,0)],this._diagonals=[new x.Cell(-1,-1,0),new x.Cell(-1,1,0),new x.Cell(1,1,0),new x.Cell(1,-1,0)],this._list=[],this._vec3=new THREE.Vector3,this._cel=new x.Cell,this._conversionVec=new THREE.Vector3,this._geoCache=[],this._matCache=[]},x.SqrGrid.prototype={cellToPixel:function(e){return this._vec3.x=e.q*this._fullCellSize,this._vec3.y=e.h,this._vec3.z=e.r*this._fullCellSize,this._vec3},pixelToCell:function(e){var t=Math.round(e.x/this._fullCellSize),i=Math.round(e.z/this._fullCellSize);return this._cel.set(t,i,0)},getCellAt:function(e){var t=Math.round(e.x/this._fullCellSize),i=Math.round(e.z/this._fullCellSize);return this._cel.set(t,i),this.cells[this.cellToHash(this._cel)]},getNeighbors:function(e,t,i){var r,c,d=this._directions.length;for(this._list.length=0,r=0;d>r;r++)this._cel.copy(e),this._cel.add(this._directions[r]),c=this.cells[this.cellToHash(this._cel)],!c||i&&!i(e,c)||this._list.push(c);if(t)for(r=0;d>r;r++)this._cel.copy(e),this._cel.add(this._diagonals[r]),c=this.cells[this.cellToHash(this._cel)],!c||i&&!i(e,c)||this._list.push(c);return this._list},getRandomCell:function(){var e,t=0,i=x.Tools.randomInt(0,this.numCells);for(e in this.cells){if(t===i)return this.cells[e];t++}return this.cells[e]},cellToHash:function(e){return e.q+this._hashDelimeter+e.r},distance:function(e,t){var i=Math.max(Math.abs(e.q-t.q),Math.abs(e.r-t.r));return i+=t.h-e.h},clearPath:function(){var e,t;for(e in this.cells)t=this.cells[e],t._calcCost=0,t._priority=0,t._parent=null,t._visited=!1},traverse:function(e){var t;for(t in this.cells)e(this.cells[t])},generateTile:function(e,t,i){var r=Math.abs(e.h);1>r&&(r=1);var c=this._geoCache[r];c||(this.extrudeSettings.amount=r,c=new THREE.ExtrudeGeometry(this.cellShape,this.extrudeSettings),this._geoCache[r]=c);var d=new x.Tile({size:this.cellSize,scale:t,cell:e,geometry:c,material:i});return e.tile=d,d},generateTiles:function(e){e=e||{};var t=[],i={tileScale:.95,cellSize:this.cellSize,material:null,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5}};i=x.Tools.merge(i,e),this.cellSize=i.cellSize,this._fullCellSize=2*this.cellSize,this.autogenerated=!0,this.extrudeSettings=i.extrudeSettings;var r,c,d;for(r in this.cells)d=this.cells[r],c=this.generateTile(d,i.tileScale,i.material),c.position.copy(this.cellToPixel(d)),c.position.y=0,t.push(c);return t},generateTilePoly:function(e){e||(e=new THREE.MeshBasicMaterial({color:2405631}));var t=new THREE.Mesh(this.cellShapeGeo,e);return this._vec3.set(1,0,0),t.rotateOnAxis(this._vec3,x.PI/2),t},generate:function(e){e=e||{},this.size=typeof e.size=="undefined"?this.size:e.size;var t,i,r,c=Math.ceil(this.size/2);for(t=-c;c>t;t++)for(i=-c;c>i;i++)r=new x.Cell(t,i+1),this.add(r)},generateOverlay:function(e,t,i){var r,c,d=Math.ceil(e/2);for(r=-d;d>r;r++)for(c=-d;d>c;c++){this._cel.set(r,c);var m=new THREE.Line(this.cellGeo,i);m.position.copy(this.cellToPixel(this._cel)),m.rotation.x=90*x.DEG_TO_RAD,t.add(m)}},add:function(e){var t=this.cellToHash(e);if(!this.cells[t])return this.cells[t]=e,this.numCells++,e},remove:function(e){var t=this.cellToHash(e);this.cells[t]&&(delete this.cells[t],this.numCells--)},dispose:function(){this.cells=null,this.numCells=0,this.cellShape=null,this.cellGeo.dispose(),this.cellGeo=null,this.cellShapeGeo.dispose(),this.cellShapeGeo=null,this._list=null,this._vec3=null,this._conversionVec=null,this._geoCache=null,this._matCache=null},load:function(e,t,i){x.Tools.getJSON({url:e,callback:function(r){this.fromJSON(r),t.call(i||null,r)},cache:!1,scope:this})},fromJSON:function(e){var t,i,r=e.cells;for(this.cells={},this.numCells=0,this.size=e.size,this.cellSize=e.cellSize,this._fullCellSize=2*this.cellSize,this.extrudeSettings=e.extrudeSettings,this.autogenerated=e.autogenerated,t=0;t<r.length;t++)i=new x.Cell,i.copy(r[t]),this.add(i)},toJSON:function(){var e,t,i={size:this.size,cellSize:this.cellSize,extrudeSettings:this.extrudeSettings,autogenerated:this.autogenerated},r=[];for(t in this.cells)e=this.cells[t],r.push({q:e.q,r:e.r,s:e.s,h:e.h,walkable:e.walkable,userData:e.userData});return i.cells=r,i}},x.SqrGrid.prototype.constructor=x.SqrGrid,x.Tile=function(e){e=e||{};var t={cell:null,geometry:null,material:null};if(t=x.Tools.merge(t,e),!t.cell||!t.geometry)throw new Error("Missing vg.Tile configuration");this.cell=t.cell,this.cell.tile&&this.cell.tile!==this&&this.cell.tile.dispose(),this.cell.tile=this,this.uniqueID=x.Tools.generateID(),this.geometry=t.geometry,this.material=t.material,this.material||(this.material=new THREE.MeshPhongMaterial({color:x.Tools.randomizeRGB("30, 30, 30",13)})),this.objectType=x.TILE,this.entity=null,this.userData={},this.selected=!1,this.highlight="0x0084cc",this.mesh=new THREE.Mesh(this.geometry,this.material),this.mesh.userData.structure=this,this.position=this.mesh.position,this.rotation=this.mesh.rotation,this.rotation.x=-90*x.DEG_TO_RAD,this.mesh.scale.set(t.scale,t.scale,1),this.material.emissive?this._emissive=this.material.emissive.getHex():this._emissive=null},x.Tile.prototype={select:function(){return this.material.emissive&&this.material.emissive.setHex(this.highlight),this.selected=!0,this},deselect:function(){return this._emissive!==null&&this.material.emissive&&this.material.emissive.setHex(this._emissive),this.selected=!1,this},toggle:function(){return this.selected?this.deselect():this.select(),this},dispose:function(){this.cell&&this.cell.tile&&(this.cell.tile=null),this.cell=null,this.position=null,this.rotation=null,this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.mesh.userData.structure=null,this.mesh=null,this.material=null,this.userData=null,this.entity=null,this.geometry=null,this._emissive=null}},x.Tile.prototype.constructor=x.Tile,function(){var e=function(){this.obj=null,this.next=null,this.prev=null,this.free=!0},t=function(){this.first=null,this.last=null,this.length=0,this.objToNodeMap={},this.uniqueID=Date.now()+""+Math.floor(1e3*Math.random()),this.sortArray=[]};t.generateID=function(){return Math.random().toString(36).slice(2)+Date.now()},t.prototype={getNode:function(i){return this.objToNodeMap[i.uniqueID]},addNode:function(i){var r=new e;if(!i.uniqueID)try{i.uniqueID=t.generateID()}catch{return console.error("[LinkedList.addNode] obj passed is immutable: cannot attach necessary identifier"),null}return r.obj=i,r.free=!1,this.objToNodeMap[i.uniqueID]=r,r},swapObjects:function(i,r){this.objToNodeMap[i.obj.uniqueID]=null,this.objToNodeMap[r.uniqueID]=i,i.obj=r},add:function(i){var r=this.objToNodeMap[i.uniqueID];if(r){if(r.free===!1)return;r.obj=i,r.free=!1,r.next=null,r.prev=null}else r=this.addNode(i);if(this.first){if(!this.last)throw new Error("[LinkedList.add] No last in the list -- that shouldn't happen here");this.last.next=r,r.prev=this.last,this.last=r,r.next=null}else this.first=r,this.last=r,r.next=null,r.prev=null;this.length++,this.showDebug&&this.dump("after add")},has:function(i){return!!this.objToNodeMap[i.uniqueID]},moveUp:function(i){this.dump("before move up");var r=this.getNode(i);if(!r)throw"Oops, trying to move an object that isn't in the list";if(r.prev){var c=r.prev,d=c.prev;r==this.last&&(this.last=c);var m=r.next;d&&(d.next=r),r.next=c,r.prev=c.prev,c.next=m,c.prev=r,this.first==c&&(this.first=r)}},moveDown:function(i){var r=this.getNode(i);if(!r)throw"Oops, trying to move an object that isn't in the list";if(r.next){var c=r.next;this.moveUp(c.obj),this.last==c&&(this.last=r)}},sort:function(i){var r,c,d=this.sortArray,m=this.first;for(d.length=0;m;)d.push(m.obj),m=m.next;for(this.clear(),d.sort(i),c=d.length,r=0;c>r;r++)this.add(d[r])},remove:function(i){var r=this.getNode(i);return!r||r.free?!1:(r.prev&&(r.prev.next=r.next),r.next&&(r.next.prev=r.prev),r.prev||(this.first=r.next),r.next||(this.last=r.prev),r.free=!0,r.prev=null,r.next=null,this.length--,!0)},shift:function(){var i=this.first;return this.length===0?null:(i.prev&&(i.prev.next=i.next),i.next&&(i.next.prev=i.prev),this.first=i.next,i.next||(this.last=null),i.free=!0,i.prev=null,i.next=null,this.length--,i.obj)},pop:function(){var i=this.last;return this.length===0?null:(i.prev&&(i.prev.next=i.next),i.next&&(i.next.prev=i.prev),this.last=i.prev,i.prev||(this.first=null),i.free=!0,i.prev=null,i.next=null,this.length--,i.obj)},concat:function(i){for(var r=i.first;r;)this.add(r.obj),r=r.next},clear:function(){for(var i=this.first;i;)i.free=!0,i=i.next;this.first=null,this.length=0},dispose:function(){for(var i=this.first;i;)i.obj=null,i=i.next;this.first=null,this.objToNodeMap=null},dump:function(i){console.log("===================="+i+"=====================");for(var r=this.first;r;)console.log("{"+r.obj.toString()+"} previous="+(r.prev?r.prev.obj:"NULL")),r=r.next();console.log("==================================="),console.log("Last: {"+(this.last?this.last.obj:"NULL")+"} First: {"+(this.first?this.first.obj:"NULL")+"}")}},t.prototype.constructor=t,x.LinkedList=t}(),function(){var e=function(i,r,c,d,m){this._listener=r,this.isOnce=c,this.context=d,this.signal=i,this._priority=m||0};e.prototype={active:!0,params:null,execute:function(i){var r,c;return this.active&&this._listener&&(c=this.params?this.params.concat(i):i,r=this._listener.apply(this.context,c),this.isOnce&&this.detach()),r},detach:function(){return this.isBound()?this.signal.remove(this._listener,this.context):null},isBound:function(){return!!this.signal&&!!this._listener},_destroy:function(){delete this.signal,delete this._listener,delete this.context},toString:function(){return"[SignalBinding isOnce:"+this.isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}},e.prototype.constructor=e;var t=function(){this._bindings=[],this._prevParams=null;var i=this;this.dispatch=function(){t.prototype.dispatch.apply(i,arguments)}};t.prototype={memorize:!1,_shouldPropagate:!0,active:!0,validateListener:function(i,r){if(typeof i!="function")throw new Error("Signal: listener is a required param of {fn}() and should be a Function.".replace("{fn}",r))},_registerListener:function(i,r,c,d){var m,E=this._indexOfListener(i,c);if(E!==-1){if(m=this._bindings[E],m.isOnce!==r)throw new Error("You cannot add"+(r?"":"Once")+"() then add"+(r?"Once":"")+"() the same listener without removing the relationship first.")}else m=new e(this,i,r,c,d),this._addBinding(m);return this.memorize&&this._prevParams&&m.execute(this._prevParams),m},_addBinding:function(i){var r=this._bindings.length;do r--;while(this._bindings[r]&&i._priority<=this._bindings[r]._priority);this._bindings.splice(r+1,0,i)},_indexOfListener:function(i,r){for(var c,d=this._bindings.length;d--;)if(c=this._bindings[d],c._listener===i&&c.context===r)return d;return-1},has:function(i,r){return this._indexOfListener(i,r)!==-1},add:function(i,r,c){return this.validateListener(i,"add"),this._registerListener(i,!1,r,c)},addOnce:function(i,r,c){return this.validateListener(i,"addOnce"),this._registerListener(i,!0,r,c)},remove:function(i,r){this.validateListener(i,"remove");var c=this._indexOfListener(i,r);return c!==-1&&(this._bindings[c]._destroy(),this._bindings.splice(c,1)),i},removeAll:function(i){typeof i=="undefined"&&(i=null);for(var r=this._bindings.length;r--;)i?this._bindings[r].context===i&&(this._bindings[r]._destroy(),this._bindings.splice(r,1)):this._bindings[r]._destroy();i||(this._bindings.length=0)},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(){if(this.active){var i,r=Array.prototype.slice.call(arguments),c=this._bindings.length;if(this.memorize&&(this._prevParams=r),c){i=this._bindings.slice(),this._shouldPropagate=!0;do c--;while(i[c]&&this._shouldPropagate&&i[c].execute(r)!==!1)}}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}},t.prototype.constructor=t,x.Signal=t}(),x.AStarFinder=function(e){e=e||{};var t={allowDiagonal:!1,heuristicFilter:null};t=x.Tools.merge(t,e),this.allowDiagonal=t.allowDiagonal,this.heuristicFilter=t.heuristicFilter,this.list=new x.LinkedList},x.AStarFinder.prototype={findPath:function(e,t,i,r){var c,d,m,E,w,L;for(i=i||this.heuristicFilter,r.clearPath(),this.list.clear(),this.list.add(e);this.list.length>0;){if(this.list.sort(this.compare),c=this.list.shift(),c._visited=!0,c===t)return x.PathUtil.backtrace(t);for(m=r.getNeighbors(c,this.allowDiagonal,i),w=0,L=m.length;L>w;w++)if(E=m[w],E.walkable&&(d=c._calcCost+r.distance(c,E),!E._visited||d<E._calcCost)){if(E._visited=!0,E._parent=c,E._calcCost=d,E._priority=d+r.distance(t,E),E===t)return x.PathUtil.backtrace(t);this.list.add(E)}}return null},compare:function(e,t){return e._priority-t._priority}},x.AStarFinder.prototype.constructor=x.AStarFinder,x.PathUtil={backtrace:function(e){for(var t=[e];e._parent;)e=e._parent,t.push(e);return t.reverse()},biBacktrace:function(e,t){var i=this.backtrace(e),r=this.backtrace(t);return i.concat(r.reverse())},pathLength:function(e){var t,i,r,c,d,m=0;for(t=1;t<e.length;++t)i=e[t-1],r=e[t],c=i[0]-r[0],d=i[1]-r[1],m+=Math.sqrt(c*c+d*d);return m},interpolate:function(e,t,i,r){var c,d,m,E,w,L,R=Math.abs,B=[];for(m=R(i-e),E=R(r-t),c=i>e?1:-1,d=r>t?1:-1,w=m-E;e!==i||t!==r;)B.push([e,t]),L=2*w,L>-E&&(w-=E,e+=c),m>L&&(w+=m,t+=d);return B},expandPath:function(e){var t,i,r,c,d,m,E=[],w=e.length;if(2>w)return E;for(d=0;w-1>d;++d)for(t=e[d],i=e[d+1],r=this.interpolate(t[0],t[1],i[0],i[1]),c=r.length,m=0;c-1>m;++m)E.push(r[m]);return E.push(e[w-1]),E},smoothenPath:function(e,t){var i,r,c,d,m,E,w,L,R,B,O,M,N=t.length,re=t[0][0],ae=t[0][1],ie=t[N-1][0],ge=t[N-1][1];for(i=re,r=ae,m=[[i,r]],w=2;N>w;++w){for(R=t[w],c=R[0],d=R[1],B=this.interpolate(i,r,c,d),M=!1,L=1;L<B.length;++L)if(O=B[L],!e.isWalkableAt(O[0],O[1])){M=!0;break}M&&(E=t[w-1],m.push(E),i=E[0],r=E[1])}return m.push([ie,ge]),m},compressPath:function(e){if(e.length<3)return e;var t,i,r,c,d,m,E=[],w=e[0][0],L=e[0][1],R=e[1][0],B=e[1][1],O=R-w,M=B-L;for(d=Math.sqrt(O*O+M*M),O/=d,M/=d,E.push([w,L]),m=2;m<e.length;m++)t=R,i=B,r=O,c=M,R=e[m][0],B=e[m][1],O=R-t,M=B-i,d=Math.sqrt(O*O+M*M),O/=d,M/=d,(O!==r||M!==c)&&E.push([t,i]);return E.push([R,B]),E}},x.Loader={manager:null,imageLoader:null,crossOrigin:!1,init:function(e){this.crossOrigin=e||!1,this.manager=new THREE.LoadingManager(function(){},function(){},function(){console.warn("Error loading images")}),this.imageLoader=new THREE.ImageLoader(this.manager),this.imageLoader.crossOrigin=e},loadTexture:function(e,t,i,r){var c=new THREE.Texture(null,t);return this.imageLoader.load(e,function(d){c.image=d,c.needsUpdate=!0,i&&i(c)},null,function(d){r&&r(d)}),c.sourceFile=e,c}},x.MouseCaster=function(e,t,i){this.down=!1,this.rightDown=!1,this.pickedObject=null,this.selectedObject=null,this.allHits=null,this.active=!0,this.shift=!1,this.ctrl=!1,this.wheel=0,this.position=new THREE.Vector3,this.screenPosition=new THREE.Vector2,this.signal=new x.Signal,this.group=e,this._camera=t,this._raycaster=new THREE.Raycaster,this._preventDefault=!1,i=i||document,i.addEventListener("mousemove",this._onDocumentMouseMove.bind(this),!1),i.addEventListener("mousedown",this._onDocumentMouseDown.bind(this),!1),i.addEventListener("mouseup",this._onDocumentMouseUp.bind(this),!1),i.addEventListener("mousewheel",this._onMouseWheel.bind(this),!1),i.addEventListener("DOMMouseScroll",this._onMouseWheel.bind(this),!1)},x.MouseCaster.OVER="over",x.MouseCaster.OUT="out",x.MouseCaster.DOWN="down",x.MouseCaster.UP="up",x.MouseCaster.CLICK="click",x.MouseCaster.WHEEL="wheel",x.MouseCaster.prototype={update:function(){if(this.active){this._raycaster.setFromCamera(this.screenPosition,this._camera);var e,t,i=this._raycaster.intersectObject(this.group,!0);i.length>0?(e=i[0],t=e.object.userData.structure,this.pickedObject!=t&&(this.pickedObject&&this.signal.dispatch(x.MouseCaster.OUT,this.pickedObject),this.pickedObject=t,this.selectedObject=null,this.signal.dispatch(x.MouseCaster.OVER,this.pickedObject)),this.position.copy(e.point),this.screenPosition.z=e.distance):(this.pickedObject&&this.signal.dispatch(x.MouseCaster.OUT,this.pickedObject),this.pickedObject=null,this.selectedObject=null),this.allHits=i}},preventDefault:function(){this._preventDefault=!0},_onDocumentMouseDown:function(e){return e=e||window.event,e.preventDefault(),this._preventDefault?(this._preventDefault=!1,!1):(this.pickedObject&&(this.selectedObject=this.pickedObject),this.shift=e.shiftKey,this.ctrl=e.ctrlKey,this.down=e.which===1,this.rightDown=e.which===3,void this.signal.dispatch(x.MouseCaster.DOWN,this.pickedObject))},_onDocumentMouseUp:function(e){return e.preventDefault(),this._preventDefault?(this._preventDefault=!1,!1):(this.shift=e.shiftKey,this.ctrl=e.ctrlKey,this.signal.dispatch(x.MouseCaster.UP,this.pickedObject),this.selectedObject&&this.pickedObject&&this.selectedObject.uniqueID===this.pickedObject.uniqueID&&this.signal.dispatch(x.MouseCaster.CLICK,this.pickedObject),this.down=e.which===1?!1:this.down,void(this.rightDown=e.which===3?!1:this.rightDown))},_onDocumentMouseMove:function(e){e.preventDefault(),this.screenPosition.x=e.clientX/window.innerWidth*2-1,this.screenPosition.y=2*-(e.clientY/window.innerHeight)+1},_onMouseWheel:function(e){if(this.active){e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta!==void 0?t=e.wheelDelta:e.detail!==void 0&&(t=-e.detail),t>0?this.wheel++:this.wheel--,this.signal.dispatch(x.MouseCaster.WHEEL,this.wheel)}}},x.MouseCaster.prototype.constructor=x.MouseCaster,x.Scene=function(e,t){var i={element:document.body,alpha:!0,antialias:!0,clearColor:"#fff",sortObjects:!1,fog:null,light:new THREE.DirectionalLight(16777215),lightPosition:null,cameraType:"PerspectiveCamera",cameraPosition:null,orthoZoom:4},r={minDistance:100,maxDistance:1e3,zoomSpeed:2,noZoom:!1};if(i=x.Tools.merge(i,e),typeof t!="boolean"&&(r=x.Tools.merge(r,t)),this.renderer=new THREE.WebGLRenderer({alpha:i.alpha,antialias:i.antialias}),this.renderer.setClearColor(i.clearColor,0),this.renderer.sortObjects=i.sortObjects,this.width=window.innerWidth,this.height=window.innerHeight,this.orthoZoom=i.orthoZoom,this.container=new THREE.Scene,this.container.fog=i.fog,this.container.add(new THREE.AmbientLight(14540253)),i.lightPosition||i.light.position.set(-1,1,-1).normalize(),this.container.add(i.light),i.cameraType==="OrthographicCamera"){var c=window.innerWidth/this.orthoZoom,d=window.innerHeight/this.orthoZoom;this.camera=new THREE.OrthographicCamera(c/-2,c/2,d/2,d/-2,1,5e3)}else this.camera=new THREE.PerspectiveCamera(50,this.width/this.height,1,5e3);this.contolled=!!t,this.contolled&&(this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.minDistance=r.minDistance,this.controls.maxDistance=r.maxDistance,this.controls.zoomSpeed=r.zoomSpeed,this.controls.noZoom=r.noZoom),i.cameraPosition&&this.camera.position.copy(i.cameraPosition),window.addEventListener("resize",function(){if(this.width=window.innerWidth,this.height=window.innerHeight,this.camera.type==="OrthographicCamera"){var m=this.width/this.orthoZoom,E=this.height/this.orthoZoom;this.camera.left=m/-2,this.camera.right=m/2,this.camera.top=E/2,this.camera.bottom=E/-2}else this.camera.aspect=this.width/this.height;this.camera.updateProjectionMatrix(),this.renderer.setSize(this.width,this.height)}.bind(this),!1),this.attachTo(i.element)},x.Scene.prototype={attachTo:function(e){e.style.width=this.width+"px",e.style.height=this.height+"px",this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(this.width,this.height),e.appendChild(this.renderer.domElement)},add:function(e){this.container.add(e)},remove:function(e){this.container.remove(e)},render:function(){this.contolled&&this.controls.update(),this.renderer.render(this.container,this.camera)},updateOrthoZoom:function(){if(this.orthoZoom<=0)return void(this.orthoZoom=0);var e=this.width/this.orthoZoom,t=this.height/this.orthoZoom;this.camera.left=e/-2,this.camera.right=e/2,this.camera.top=t/2,this.camera.bottom=t/-2,this.camera.updateProjectionMatrix()},focusOn:function(e){this.camera.lookAt(e.position)}},x.Scene.prototype.constructor=x.Scene,x.SelectionManager=function(e){this.mouse=e,this.onSelect=new x.Signal,this.onDeselect=new x.Signal,this.selected=null,this.toggleSelection=!1,this.mouse.signal.add(this.onMouse,this)},x.SelectionManager.prototype={select:function(e,t){e&&(t=t||!0,this.selected!==e&&this.clearSelection(t),e.selected?this.toggleSelection&&(t&&this.onDeselect.dispatch(e),e.deselect()):e.select(),this.selected=e,t&&this.onSelect.dispatch(e))},clearSelection:function(e){e=e||!0,this.selected&&(e&&this.onDeselect.dispatch(this.selected),this.selected.deselect()),this.selected=null},onMouse:function(e,t){switch(e){case x.MouseCaster.DOWN:t||this.clearSelection();break;case x.MouseCaster.CLICK:this.select(t)}}},x.SelectionManager.prototype.constructor=x.SelectionManager,x.Tools={clamp:function(e,t,i){return Math.max(t,Math.min(i,e))},sign:function(e){return e&&e/Math.abs(e)},random:function(e,t){return arguments.length===1?Math.random()*e-.5*e:Math.random()*(t-e)+e},randomInt:function(e,t){return arguments.length===1?Math.random()*e-.5*e|0:Math.random()*(t-e+1)+e|0},normalize:function(e,t,i){return(e-t)/(i-t)},getShortRotation:function(e){return e%=this.TAU,e>this.PI?e-=this.TAU:e<-this.PI&&(e+=this.TAU),e},generateID:function(){return Math.random().toString(36).slice(2)+Date.now()},isPlainObject:function(e){if(typeof e!="object"||e.nodeType||e===e.window)return!1;try{if(e.constructor&&!Object.prototype.hasOwnProperty.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch{return!1}return!0},merge:function(e,t){var i=this,r=Array.isArray(t),c=r&&[]||{};return r?(e=e||[],c=c.concat(e),t.forEach(function(d,m){typeof c[m]=="undefined"?c[m]=d:i.isPlainObject(d)?c[m]=i.merge(e[m],d):e.indexOf(d)===-1&&c.push(d)}),c):(e&&i.isPlainObject(e)&&Object.keys(e).forEach(function(d){c[d]=e[d]}),Object.keys(t).forEach(function(d){t[d]&&i.isPlainObject(t[d])&&e[d]?c[d]=i.merge(e[d],t[d]):c[d]=t[d]}),c)},now:function(){return window.nwf?window.nwf.system.Performance.elapsedTime:window.performance.now()},empty:function(e){for(;e.lastChild;)e.removeChild(e.lastChild)},radixSort:function(e,t,i,r){if(t=t||0,i=i||e.length,r=r||31,!(t>=i-1||0>r)){for(var c=t,d=i,m=1<<r;d>c;)if(e[c]&m){--d;var E=e[c];e[c]=e[d],e[d]=E}else++c;this.radixSort(e,t,d,r-1),this.radixSort(e,d,i,r-1)}},randomizeRGB:function(e,t){var i,r,c=e.split(","),d="rgb(";for(t=this.randomInt(t),i=0;3>i;i++)r=parseInt(c[i])+t,0>r?r=0:r>255&&(r=255),d+=r+",";return d=d.substring(0,d.length-1),d+=")"},getJSON:function(e){var t=new XMLHttpRequest,i=typeof e.cache=="undefined"?!1:e.cache,r=i?e.url:e.url+"?t="+Math.floor(1e4*Math.random())+Date.now();t.onreadystatechange=function(){if(this.status===200){var c=null;try{c=JSON.parse(this.responseText)}catch{return}return void e.callback.call(e.scope||null,c)}this.status!==0&&console.warn("[Tools.getJSON] Error: "+this.status+" ("+this.statusText+") :: "+e.url)},t.open("GET",r,!0),t.setRequestHeader("Accept","application/json"),t.setRequestHeader("Content-Type","application/json"),t.send("")}};var mn={size:5,cellSize:10,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5},autogenerated:!0,cells:[{q:-1,r:0,s:1,h:1,walkable:!0,userData:{}},{q:0,r:-1,s:1,h:1,walkable:!0,userData:{}},{q:0,r:0,s:0,h:1,walkable:!0,userData:{}},{q:1,r:-1,s:0,h:1,walkable:!0,userData:{}},{q:-1,r:1,s:0,h:0,walkable:!0,userData:{}},{q:0,r:1,s:-1,h:0,walkable:!0,userData:{}},{q:1,r:0,s:-1,h:0,walkable:!0,userData:{}}]};const _t=Dt.exports,gn=mn;AFRAME.registerPrimitive("a-hexgrid",{defaultComponents:{hexgrid:{}},mappings:{src:"hexgrid.src"}});AFRAME.registerComponent("hexgrid",{dependencies:["material"],schema:{src:{type:"asset"}},init:function(){const e=this.data;e.src?fetch(e.src).then(t=>t.json()).then(t=>this.addMesh(t)):this.addMesh(gn)},addMesh:function(e){const t=new _t.HexGrid;t.fromJSON(e);const i=new _t.Board(t);i.generateTilemap(),this.el.setObject3D("mesh",i.group),this.addMaterial()},addMaterial:function(){const t=(this.el.components.material||{}).material;!t||this.el.object3D.traverse(i=>{i.isMesh&&(i.material=t)})},remove:function(){this.el.removeObject3D("mesh")}});AFRAME.registerPrimitive("a-ocean",{defaultComponents:{ocean:{},rotation:{x:-90,y:0,z:0}},mappings:{width:"ocean.width",depth:"ocean.depth",density:"ocean.density",amplitude:"ocean.amplitude",amplitudeVariance:"ocean.amplitudeVariance",speed:"ocean.speed",speedVariance:"ocean.speedVariance",color:"ocean.color",opacity:"ocean.opacity"}});AFRAME.registerComponent("ocean",{schema:{width:{default:10,min:0},depth:{default:10,min:0},density:{default:10},amplitude:{default:.1},amplitudeVariance:{default:.3},speed:{default:1},speedVariance:{default:2},color:{default:"#7AD2F7",type:"color"},opacity:{default:.8}},play:function(){const e=this.el,t=this.data;let i=e.components.material;const r=new THREE.PlaneGeometry(t.width,t.depth,t.density,t.density);r.mergeVertices(),this.waves=[];for(let c,d=0,m=r.vertices.length;d<m;d++)c=r.vertices[d],this.waves.push({z:c.z,ang:Math.random()*Math.PI*2,amp:t.amplitude+Math.random()*t.amplitudeVariance,speed:(t.speed+Math.random()*t.speedVariance)/1e3});i||(i={},i.material=new THREE.MeshPhongMaterial({color:t.color,transparent:t.opacity<1,opacity:t.opacity,shading:THREE.FlatShading})),this.mesh=new THREE.Mesh(r,i.material),e.setObject3D("mesh",this.mesh)},remove:function(){this.el.removeObject3D("mesh")},tick:function(e,t){if(!t)return;const i=this.mesh.geometry.vertices;for(let r,c,d=0;r=i[d];d++)c=this.waves[d],r.z=c.z+Math.sin(c.ang)*c.amp,c.ang+=c.speed*t;this.mesh.geometry.verticesNeedUpdate=!0}});AFRAME.registerPrimitive("a-tube",{defaultComponents:{tube:{}},mappings:{path:"tube.path",segments:"tube.segments",radius:"tube.radius","radial-segments":"tube.radialSegments",closed:"tube.closed"}});AFRAME.registerComponent("tube",{schema:{path:{default:[]},segments:{default:64},radius:{default:1},radialSegments:{default:8},closed:{default:!1}},init:function(){const e=this.el,t=this.data;let i=e.components.material;if(!t.path.length){console.error("[a-tube] `path` property expected but not found.");return}const r=new THREE.CatmullRomCurve3(t.path.map(function(d){return d=d.split(" "),new THREE.Vector3(Number(d[0]),Number(d[1]),Number(d[2]))})),c=new THREE.TubeGeometry(r,t.segments,t.radius,t.radialSegments,t.closed);i||(i={},i.material=new THREE.MeshPhongMaterial),this.mesh=new THREE.Mesh(c,i.material),this.el.setObject3D("mesh",this.mesh)},update:function(e){!Object.keys(e).length||(this.remove(),this.init())},remove:function(){this.mesh&&this.el.removeObject3D("mesh")}});function yn(e){let t,i;return t=new zi({}),{c(){Hi(t.$$.fragment)},l(r){_i(t.$$.fragment,r)},m(r,c){Oi(t,r,c),i=!0},p:Di,i(r){i||(Fi(t.$$.fragment,r),i=!0)},o(r){Ni(t.$$.fragment,r),i=!1},d(r){Pi(t,r)}}}function ut(e){return e*Math.PI/180}function En(e,t,i){let r;Ii(e,Vi,m=>i(0,r=m));let c=[.05,.025,.05];const d=new ue.exports.THREE.Vector3(0,0,1);return AFRAME.registerComponent("curve-point",{schema:{},init(){this.el.addEventListener("componentchanged",this.changeHandler.bind(this)),this.el.emit("curve-point-change")},changeHandler(m){m.detail.name=="position"&&this.el.emit("curve-point-change")}}),AFRAME.registerComponent("curve",{schema:{type:{type:"string",default:"CatmullRom",oneOf:["CatmullRom","CubicBezier","QuadraticBezier","Line"]},closed:{type:"boolean",default:!1}},init(){this.pathPoints=null,this.curve=null,this.el.addEventListener("curve-point-change",this.update.bind(this))},update(m){if(this.points=Array.from(this.el.querySelectorAll("a-curve-point, [curve-point]")),this.points.length<=1)console.warn("At least 2 curve-points needed to draw a curve"),this.curve=null;else{let E=this.points.map(function(w){return w.x!==void 0&&w.y!==void 0&&w.z!==void 0?w:w.object3D.getWorldPosition(new ue.exports.THREE.Vector3)});if(!AFRAME.utils.deepEqual(E,this.pathPoints)||m!=="CustomEvent"&&!AFRAME.utils.deepEqual(this.data,m)){switch(this.curve=null,this.pathPoints=E,this.data.type){case"CubicBezier":if(this.pathPoints.length!=4)throw new Error("The Three constructor of type CubicBezierCurve3 requires 4 points");this.curve=new ue.exports.THREE.CubicBezierCurve3(this.pathPoints[0],this.pathPoints[1],this.pathPoints[2],this.pathPoints[3]);break;case"QuadraticBezier":if(this.pathPoints.length!=3)throw new Error("The Three constructor of type QuadraticBezierCurve3 requires 3 points");this.curve=new ue.exports.THREE.QuadraticBezierCurve3(this.pathPoints[0],this.pathPoints[1],this.pathPoints[2]);break;case"Line":if(this.pathPoints.length!=2)throw new Error("The Three constructor of type LineCurve3 requires 2 points");this.curve=new ue.exports.THREE.LineCurve3(this.pathPoints[0],this.pathPoints[1]);break;case"CatmullRom":this.curve=new ue.exports.THREE.CatmullRomCurve3(this.pathPoints);break;default:throw new Error("No Three constructor of type (case sensitive): "+this.data.type+"Curve3")}this.curve.closed=this.data.closed,this.el.emit("curve-updated")}}},remove(){this.el.removeEventListener("curve-point-change",this.update.bind(this))}}),new ue.exports.THREE.Quaternion,AFRAME.registerShader("line",{schema:{color:{default:"#ff0000"}},init(m){this.material=new ue.exports.THREE.LineBasicMaterial(m)},update(m){this.material=new ue.exports.THREE.LineBasicMaterial(m)}}),AFRAME.registerComponent("draw-curve",{schema:{curve:{type:"selector"}},init(){this.data.curve.addEventListener("curve-updated",this.update.bind(this))},update(){if(this.data.curve&&(this.curve=this.data.curve.components.curve),this.curve&&this.curve.curve){let m=new ue.exports.THREE.BufferGeometry().setFromPoints(this.curve.curve.getPoints(this.curve.curve.getPoints().length*10)),E=this.el.getOrCreateObject3D("mesh",ue.exports.THREE.Line);const w=E.material?E.material:new ue.exports.THREE.LineBasicMaterial({color:"#ff0000"});this.el.setObject3D("mesh",new ue.exports.THREE.Line(m,w))}},remove(){this.data.curve.removeEventListener("curve-updated",this.update.bind(this)),this.el.getObject3D("mesh").geometry=new ue.exports.THREE.BufferGeometry}}),AFRAME.registerComponent("clone-along-curve",{schema:{curve:{type:"selector"},spacing:{default:1},rotation:{type:"vec3",default:AFRAME.utils.coordinates.parse("0 0 0")},scale:{type:"vec3",default:AFRAME.utils.coordinates.parse("1 1 1")}},init(){this.el.addEventListener("model-loaded",this.update.bind(this)),this.data.curve.addEventListener("curve-updated",this.update.bind(this))},update(){if(this.remove(),this.data.curve&&(this.curve=this.data.curve.components.curve),!this.el.getObject3D("clones")&&this.curve&&this.curve.curve){let m=this.el.getObject3D("mesh"),E=this.curve.curve.getLength(),L=0,R=this.el.getOrCreateObject3D("clones",ue.exports.THREE.Group),B=new ue.exports.THREE.Object3D;for(m.scale.set(this.data.scale.x,this.data.scale.y,this.data.scale.z),m.rotation.set(ut(this.data.rotation.x),ut(this.data.rotation.y),ut(this.data.rotation.z)),m.rotation.order="YXZ",B.add(m);L<=E;){let O=B.clone(!0);O.position.copy(this.curve.curve.getPointAt(L/E));const M=this.curve.curve.getTangentAt(L/E).normalize();O.quaternion.setFromUnitVectors(d,M),R.add(O),L+=this.data.spacing}}},remove(){this.curve=null,this.el.getObject3D("clones")&&this.el.removeObject3D("clones")}}),AFRAME.primitives.primitives["a-draw-curve"]||AFRAME.registerPrimitive("a-draw-curve",{defaultComponents:{"draw-curve":{}},mappings:{curveref:"draw-curve.curve"}}),AFRAME.primitives.primitives["a-curve-point"]||AFRAME.registerPrimitive("a-curve-point",{defaultComponents:{"curve-point":{}},mappings:{}}),AFRAME.primitives.primitives["a-curve"]||AFRAME.registerPrimitive("a-curve",{defaultComponents:{curve:{}},mappings:{type:"curve.type"}}),AFRAME.registerComponent("lava-path",{init(){var m;if(console.log("lava path:"),console.log(r.lava_paths),!!((m=r.lava_paths)!=null&&m.length))for(let E=0;E<r.lava_paths.length;E++){const w=r.lava_paths[E],L=document.createElement("a-curve");L.setAttribute("id","track"+E);for(let O=0;O<w.length;O++){const M=w[O],N=M[0],re=M[2],ae=M[1],ie=document.createElement("a-curve-point");ie.setAttribute("position",{x:N/c[0],y:re/c[1],z:ae/c[2]}),L.appendChild(ie)}this.el.appendChild(L);const R=document.createElement("a-entity");R.setAttribute("clone-along-curve","curve: #track"+E+"; spacing: 0.55; rotation: 90 0 0;"),R.setAttribute("geometry","primitive:cylinder; height:0.6; radius:0.4 ;"),R.setAttribute("material","color: orangered; transparency: true; opacity: 0.001");const B=r.lava_paths.length*2e3;R.setAttribute("animation","property: material.opacity; to: 1; dur: 2000; loop: false; delay: "+(B-E*2e3)+";"),this.el.appendChild(R)}}}),Bi(()=>{delete AFRAME.components["curve-point"],delete AFRAME.components.curve,delete AFRAME.components["draw-curve"],delete AFRAME.components["lava-path"],delete AFRAME.components["clone-along-curve"],delete AFRAME.shaders.line}),[]}class _n extends Mi{constructor(t){super(),Si(this,t,En,yn,Li,{})}}export{_n as default};
