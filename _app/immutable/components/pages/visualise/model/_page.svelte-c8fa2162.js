import{S as Ft,i as It,s as Bt,C as pt,k as ye,a as Le,l as Ee,m as we,c as He,h as q,a2 as ge,T as ri,b as oe,H as _e,D as vt,E as mt,F as gt,g as zt,t as ce,d as Vt,f as ue,G as it,o as vn,n as Te,w as Re,x as Ce,y as Me,z as Se,q as Ne,r as Pe,e as ai,I as mn,u as gn,a3 as si,L as oi,M as yn,a4 as En,N as bn,O as Tn,P as wn}from"../../../../chunks/index-5adb68ea.js";import{h as kn,a as xn,A as gi}from"../../../../chunks/aframe-master-018190e7.js";import{g as _n}from"../../../../chunks/_commonjsHelpers-ee9ee889.js";import{B as Qe,I as An,h as Rn,j as Cn,k as Mn}from"../../../../chunks/Button-52912701.js";import{N as yi}from"../../../../chunks/NavigationButton-5fbaa702.js";import{g as Sn}from"../../../../chunks/navigation-5b342094.js";import{g as ft}from"../../../../chunks/gltfStore-3cd6707b.js";import{a as li,t as Ln}from"../../../../chunks/contourLineStore-ac16300d.js";import{d as Hn}from"../../../../chunks/difficultyStore-7cc4eead.js";import{d as Dn}from"../../../../chunks/debugStore-f048b367.js";const ci=.1;AFRAME.registerComponent("checkpoint-controls",{schema:{enabled:{default:!0},mode:{default:"teleport",oneOf:["teleport","animate"]},animateSpeed:{default:3}},init:function(){this.active=!0,this.checkpoint=null,this.isNavMeshConstrained=!1,this.offset=new THREE.Vector3,this.position=new THREE.Vector3,this.targetPosition=new THREE.Vector3},play:function(){this.active=!0},pause:function(){this.active=!1},setCheckpoint:function(e){const t=this.el;if(!!this.active&&this.checkpoint!==e){if(this.checkpoint&&t.emit("navigation-end",{checkpoint:this.checkpoint}),this.checkpoint=e,this.sync(),this.position.distanceTo(this.targetPosition)<ci){this.checkpoint=null;return}t.emit("navigation-start",{checkpoint:e}),this.data.mode==="teleport"&&(this.el.setAttribute("position",this.targetPosition),this.checkpoint=null,t.emit("navigation-end",{checkpoint:e}),t.components["movement-controls"].updateNavLocation())}},isVelocityActive:function(){return!!(this.active&&this.checkpoint)},getVelocity:function(){if(!this.active)return;const e=this.data,t=this.offset,i=this.position,n=this.targetPosition,a=this.checkpoint;return this.sync(),i.distanceTo(n)<ci?(this.checkpoint=null,this.el.emit("navigation-end",{checkpoint:a}),t.set(0,0,0)):(t.setLength(e.animateSpeed),t)},sync:function(){const e=this.offset,t=this.position,i=this.targetPosition;t.copy(this.el.getAttribute("position")),this.checkpoint.object3D.getWorldPosition(i),i.add(this.checkpoint.components.checkpoint.getOffset()),e.copy(i).sub(t)}});var On=Object.assign(function(){},{FACE_1:0,FACE_2:1,FACE_3:2,FACE_4:3,L_SHOULDER_1:4,R_SHOULDER_1:5,L_SHOULDER_2:6,R_SHOULDER_2:7,SELECT:8,START:9,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15,VENDOR:16});function Nn(e,t,i){this.type=e,this.index=t,this.pressed=i.pressed,this.value=i.value}var Pn=Nn;const Ye=On,Ct=Pn,Ge=.2,Be={LEFT:"left",RIGHT:"right"},ze={MOVEMENT:1,ROTATION:2};AFRAME.registerComponent("gamepad-controls",{GamepadButton:Ye,schema:{enabled:{default:!0},camera:{default:"[camera]",type:"selector"},rotationSensitivity:{default:2}},init:function(){const e=this.el.sceneEl;this.system=e.systems["tracked-controls-webxr"]||{controllers:[]},this.prevTime=window.performance.now(),this.buttons={};const t=this.el.object3D.rotation;this.pitch=new THREE.Object3D,this.pitch.rotation.x=THREE.Math.degToRad(t.x),this.yaw=new THREE.Object3D,this.yaw.position.y=10,this.yaw.rotation.y=THREE.Math.degToRad(t.y),this.yaw.add(this.pitch),this._lookVector=new THREE.Vector2,this._moveVector=new THREE.Vector2,this._dpadVector=new THREE.Vector2,e.addBehavior(this)},update:function(){this.tick()},tick:function(e,t){this.updateButtonState(),this.updateRotation(t)},remove:function(){},isVelocityActive:function(){if(!this.data.enabled||!this.isConnected())return!1;const e=this._dpadVector,t=this._moveVector;this.getDpad(e),this.getJoystick(ze.MOVEMENT,t);const i=e.x||t.x,n=e.y||t.y;return Math.abs(i)>Ge||Math.abs(n)>Ge},getVelocityDelta:function(){const e=this._dpadVector,t=this._moveVector;this.getDpad(e),this.getJoystick(ze.MOVEMENT,t);const i=e.x||t.x,n=e.y||t.y,a=new THREE.Vector3;return Math.abs(i)>Ge&&(a.x+=i),Math.abs(n)>Ge&&(a.z+=n),a},isRotationActive:function(){if(!this.data.enabled||!this.isConnected())return!1;const e=this._lookVector;return this.getJoystick(ze.ROTATION,e),Math.abs(e.x)>Ge||Math.abs(e.y)>Ge},updateRotation:function(e){if(!this.isRotationActive())return;const t=this.data,i=this.yaw,n=this.pitch,a=t.camera.components["look-controls"],s=a&&a.pitchObject&&a.yawObject;s&&(n.rotation.copy(a.pitchObject.rotation),i.rotation.copy(a.yawObject.rotation));const u=this._lookVector;this.getJoystick(ze.ROTATION,u),Math.abs(u.x)<=Ge&&(u.x=0),Math.abs(u.y)<=Ge&&(u.y=0),u.multiplyScalar(t.rotationSensitivity*e/1e3),i.rotation.y-=u.x,n.rotation.x-=u.y,n.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,n.rotation.x)),t.camera.object3D.rotation.set(n.rotation.x,i.rotation.y,0),s&&(a.pitchObject.rotation.copy(n.rotation),a.yawObject.rotation.copy(i.rotation))},updateButtonState:function(){const e=this.getGamepad(Be.RIGHT);if(this.data.enabled&&e)for(var t=0;t<e.buttons.length;t++)e.buttons[t].pressed&&!this.buttons[t]?this.emit(new Ct("gamepadbuttondown",t,e.buttons[t])):!e.buttons[t].pressed&&this.buttons[t]&&this.emit(new Ct("gamepadbuttonup",t,e.buttons[t])),this.buttons[t]=e.buttons[t].pressed;else Object.keys(this.buttons)&&(this.buttons={})},emit:function(e){this.el.emit(e.type,e),this.el.emit(e.type+":"+e.index,new Ct(e.type,e.index,e))},getGamepad:function(){const e=[],t=[];return function(i){const n=this.el.sceneEl.components["proxy-controls"],a=n&&n.isConnected()&&n.getGamepad(0);if(a)return a;e.length=0;for(let u=0;u<this.system.controllers.length;u++){const g=this.system.controllers[u],y=g?g.gamepad:null;if(e.push(y),y&&y.handedness===i)return y}const s=navigator.getGamepads?navigator.getGamepads():t;for(let u=0;u<s.length;u++){const g=s[u];if(g&&g.hand===i)return g}return e[0]||s[0]}}(),getButton:function(e){return this.getGamepad(Be.RIGHT).buttons[e]},getAxis:function(e){return this.getGamepad(e>1?Be.RIGHT:Be.LEFT).axes[e]},getJoystick:function(e,t){const i=this.getGamepad(e===ze.MOVEMENT?Be.LEFT:Be.RIGHT);if(i.mapping==="xr-standard")switch(e){case ze.MOVEMENT:return t.set(i.axes[2],i.axes[3]);case ze.ROTATION:return t.set(i.axes[0],i.axes[1])}else switch(e){case ze.MOVEMENT:return t.set(i.axes[0],i.axes[1]);case ze.ROTATION:return t.set(i.axes[2],i.axes[3])}throw new Error('Unexpected joystick index "%d".',e)},getDpad:function(e){const t=this.getGamepad(Be.LEFT);return t.buttons[Ye.DPAD_RIGHT]?e.set((t.buttons[Ye.DPAD_RIGHT].pressed?1:0)+(t.buttons[Ye.DPAD_LEFT].pressed?-1:0),(t.buttons[Ye.DPAD_UP].pressed?-1:0)+(t.buttons[Ye.DPAD_DOWN].pressed?1:0)):e.set(0,0)},isConnected:function(){const e=this.getGamepad(Be.LEFT);return!!(e&&e.connected)},getID:function(){return this.getGamepad(Be.LEFT).id}});(function(e){var t="KeyboardEvent"in e;t||(e.KeyboardEvent=function(){throw TypeError("Illegal constructor")}),"DOM_KEY_LOCATION_STANDARD"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_STANDARD=0),"DOM_KEY_LOCATION_LEFT"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_LEFT=1),"DOM_KEY_LOCATION_RIGHT"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_RIGHT=2),"DOM_KEY_LOCATION_NUMPAD"in e.KeyboardEvent||(e.KeyboardEvent.DOM_KEY_LOCATION_NUMPAD=3);var i=window.KeyboardEvent.DOM_KEY_LOCATION_STANDARD,n=window.KeyboardEvent.DOM_KEY_LOCATION_LEFT,a=window.KeyboardEvent.DOM_KEY_LOCATION_RIGHT,s=window.KeyboardEvent.DOM_KEY_LOCATION_NUMPAD;function u(G,J){return String(G).indexOf(J)!==-1}var g=function(){return u(navigator.platform,"Win")?"win":u(navigator.platform,"Mac")?"mac":u(navigator.platform,"CrOS")?"cros":u(navigator.platform,"Linux")?"linux":u(navigator.userAgent,"iPad")||u(navigator.platform,"iPod")||u(navigator.platform,"iPhone")?"ios":""}(),y=function(){return u(navigator.userAgent,"Chrome/")?"chrome":u(navigator.vendor,"Apple")?"safari":u(navigator.userAgent,"MSIE")?"ie":u(navigator.userAgent,"Gecko/")?"moz":u(navigator.userAgent,"Opera/")?"opera":""}(),_=y+"-"+g;function b(G,J,X){(_===J||y===J||g===J)&&Object.keys(X).forEach(function(fe){G[fe]=X[fe]})}function L(G,J){var X={};return Object.keys(G).forEach(function(fe){var de=G[fe];J in de&&(X[de[J]]=de)}),X}var M={3:{code:"Cancel"},6:{code:"Help"},8:{code:"Backspace"},9:{code:"Tab"},12:{code:"Clear"},13:{code:"Enter"},16:{code:"Shift"},17:{code:"Control"},18:{code:"Alt"},19:{code:"Pause"},20:{code:"CapsLock"},21:{code:"KanaMode"},22:{code:"HangulMode"},23:{code:"JunjaMode"},24:{code:"FinalMode"},25:{code:"KanjiMode"},27:{code:"Escape"},28:{code:"Convert"},29:{code:"NonConvert"},30:{code:"Accept"},31:{code:"ModeChange"},32:{code:"Space"},33:{code:"PageUp"},34:{code:"PageDown"},35:{code:"End"},36:{code:"Home"},37:{code:"ArrowLeft"},38:{code:"ArrowUp"},39:{code:"ArrowRight"},40:{code:"ArrowDown"},41:{code:"Select"},42:{code:"Print"},43:{code:"Execute"},44:{code:"PrintScreen"},45:{code:"Insert"},46:{code:"Delete"},47:{code:"Help"},48:{code:"Digit0",keyCap:"0"},49:{code:"Digit1",keyCap:"1"},50:{code:"Digit2",keyCap:"2"},51:{code:"Digit3",keyCap:"3"},52:{code:"Digit4",keyCap:"4"},53:{code:"Digit5",keyCap:"5"},54:{code:"Digit6",keyCap:"6"},55:{code:"Digit7",keyCap:"7"},56:{code:"Digit8",keyCap:"8"},57:{code:"Digit9",keyCap:"9"},65:{code:"KeyA",keyCap:"a"},66:{code:"KeyB",keyCap:"b"},67:{code:"KeyC",keyCap:"c"},68:{code:"KeyD",keyCap:"d"},69:{code:"KeyE",keyCap:"e"},70:{code:"KeyF",keyCap:"f"},71:{code:"KeyG",keyCap:"g"},72:{code:"KeyH",keyCap:"h"},73:{code:"KeyI",keyCap:"i"},74:{code:"KeyJ",keyCap:"j"},75:{code:"KeyK",keyCap:"k"},76:{code:"KeyL",keyCap:"l"},77:{code:"KeyM",keyCap:"m"},78:{code:"KeyN",keyCap:"n"},79:{code:"KeyO",keyCap:"o"},80:{code:"KeyP",keyCap:"p"},81:{code:"KeyQ",keyCap:"q"},82:{code:"KeyR",keyCap:"r"},83:{code:"KeyS",keyCap:"s"},84:{code:"KeyT",keyCap:"t"},85:{code:"KeyU",keyCap:"u"},86:{code:"KeyV",keyCap:"v"},87:{code:"KeyW",keyCap:"w"},88:{code:"KeyX",keyCap:"x"},89:{code:"KeyY",keyCap:"y"},90:{code:"KeyZ",keyCap:"z"},91:{code:"OSLeft",location:n},92:{code:"OSRight",location:a},93:{code:"ContextMenu"},95:{code:"Standby"},96:{code:"Numpad0",keyCap:"0",location:s},97:{code:"Numpad1",keyCap:"1",location:s},98:{code:"Numpad2",keyCap:"2",location:s},99:{code:"Numpad3",keyCap:"3",location:s},100:{code:"Numpad4",keyCap:"4",location:s},101:{code:"Numpad5",keyCap:"5",location:s},102:{code:"Numpad6",keyCap:"6",location:s},103:{code:"Numpad7",keyCap:"7",location:s},104:{code:"Numpad8",keyCap:"8",location:s},105:{code:"Numpad9",keyCap:"9",location:s},106:{code:"NumpadMultiply",keyCap:"*",location:s},107:{code:"NumpadAdd",keyCap:"+",location:s},108:{code:"NumpadComma",keyCap:",",location:s},109:{code:"NumpadSubtract",keyCap:"-",location:s},110:{code:"NumpadDecimal",keyCap:".",location:s},111:{code:"NumpadDivide",keyCap:"/",location:s},112:{code:"F1"},113:{code:"F2"},114:{code:"F3"},115:{code:"F4"},116:{code:"F5"},117:{code:"F6"},118:{code:"F7"},119:{code:"F8"},120:{code:"F9"},121:{code:"F10"},122:{code:"F11"},123:{code:"F12"},124:{code:"F13"},125:{code:"F14"},126:{code:"F15"},127:{code:"F16"},128:{code:"F17"},129:{code:"F18"},130:{code:"F19"},131:{code:"F20"},132:{code:"F21"},133:{code:"F22"},134:{code:"F23"},135:{code:"F24"},144:{code:"NumLock",location:s},145:{code:"ScrollLock"},160:{code:"ShiftLeft",location:n},161:{code:"ShiftRight",location:a},162:{code:"ControlLeft",location:n},163:{code:"ControlRight",location:a},164:{code:"AltLeft",location:n},165:{code:"AltRight",location:a},166:{code:"BrowserBack"},167:{code:"BrowserForward"},168:{code:"BrowserRefresh"},169:{code:"BrowserStop"},170:{code:"BrowserSearch"},171:{code:"BrowserFavorites"},172:{code:"BrowserHome"},173:{code:"VolumeMute"},174:{code:"VolumeDown"},175:{code:"VolumeUp"},176:{code:"MediaTrackNext"},177:{code:"MediaTrackPrevious"},178:{code:"MediaStop"},179:{code:"MediaPlayPause"},180:{code:"LaunchMail"},181:{code:"MediaSelect"},182:{code:"LaunchApp1"},183:{code:"LaunchApp2"},186:{code:"Semicolon",keyCap:";"},187:{code:"Equal",keyCap:"="},188:{code:"Comma",keyCap:","},189:{code:"Minus",keyCap:"-"},190:{code:"Period",keyCap:"."},191:{code:"Slash",keyCap:"/"},192:{code:"Backquote",keyCap:"`"},219:{code:"BracketLeft",keyCap:"["},220:{code:"Backslash",keyCap:"\\"},221:{code:"BracketRight",keyCap:"]"},222:{code:"Quote",keyCap:"'"},226:{code:"IntlBackslash",keyCap:"\\"},229:{code:"Process"},246:{code:"Attn"},247:{code:"CrSel"},248:{code:"ExSel"},249:{code:"EraseEof"},250:{code:"Play"},251:{code:"ZoomToggle"},254:{code:"Clear"}};b(M,"moz",{59:{code:"Semicolon",keyCap:";"},61:{code:"Equal",keyCap:"="},107:{code:"Equal",keyCap:"="},109:{code:"Minus",keyCap:"-"},187:{code:"NumpadAdd",keyCap:"+",location:s},189:{code:"NumpadSubtract",keyCap:"-",location:s}}),b(M,"moz-mac",{12:{code:"NumLock",location:s},173:{code:"Minus",keyCap:"-"}}),b(M,"moz-win",{173:{code:"Minus",keyCap:"-"}}),b(M,"chrome-mac",{93:{code:"OSRight",location:a}}),b(M,"safari",{3:{code:"Enter"},25:{code:"Tab"}}),b(M,"ios",{10:{code:"Enter",location:i}}),b(M,"safari-mac",{91:{code:"OSLeft",location:n},93:{code:"OSRight",location:a},229:{code:"KeyQ",keyCap:"Q"}});var A={};g==="cros"&&(A["U+00A0"]={code:"ShiftLeft",location:n},A["U+00A1"]={code:"ShiftRight",location:a},A["U+00A2"]={code:"ControlLeft",location:n},A["U+00A3"]={code:"ControlRight",location:a},A["U+00A4"]={code:"AltLeft",location:n},A["U+00A5"]={code:"AltRight",location:a}),_==="chrome-mac"&&(A["U+0010"]={code:"ContextMenu"}),_==="safari-mac"&&(A["U+0010"]={code:"ContextMenu"}),g==="ios"&&(A["U+0010"]={code:"Function"},A["U+001C"]={code:"ArrowLeft"},A["U+001D"]={code:"ArrowRight"},A["U+001E"]={code:"ArrowUp"},A["U+001F"]={code:"ArrowDown"},A["U+0001"]={code:"Home"},A["U+0004"]={code:"End"},A["U+000B"]={code:"PageUp"},A["U+000C"]={code:"PageDown"});var H=[];H[n]={16:{code:"ShiftLeft",location:n},17:{code:"ControlLeft",location:n},18:{code:"AltLeft",location:n}},H[a]={16:{code:"ShiftRight",location:a},17:{code:"ControlRight",location:a},18:{code:"AltRight",location:a}},H[s]={13:{code:"NumpadEnter",location:s}},b(H[s],"moz",{109:{code:"NumpadSubtract",location:s},107:{code:"NumpadAdd",location:s}}),b(H[n],"moz-mac",{224:{code:"OSLeft",location:n}}),b(H[a],"moz-mac",{224:{code:"OSRight",location:a}}),b(H[a],"moz-win",{91:{code:"OSRight",location:a}}),b(H[a],"mac",{93:{code:"OSRight",location:a}}),b(H[s],"chrome-mac",{12:{code:"NumLock",location:s}}),b(H[s],"safari-mac",{12:{code:"NumLock",location:s},187:{code:"NumpadAdd",location:s},189:{code:"NumpadSubtract",location:s},190:{code:"NumpadDecimal",location:s},191:{code:"NumpadDivide",location:s}});var P={ShiftLeft:{key:"Shift"},ShiftRight:{key:"Shift"},ControlLeft:{key:"Control"},ControlRight:{key:"Control"},AltLeft:{key:"Alt"},AltRight:{key:"Alt"},OSLeft:{key:"OS"},OSRight:{key:"OS"},NumpadEnter:{key:"Enter"},Space:{key:" "},Digit0:{key:"0",shiftKey:")"},Digit1:{key:"1",shiftKey:"!"},Digit2:{key:"2",shiftKey:"@"},Digit3:{key:"3",shiftKey:"#"},Digit4:{key:"4",shiftKey:"$"},Digit5:{key:"5",shiftKey:"%"},Digit6:{key:"6",shiftKey:"^"},Digit7:{key:"7",shiftKey:"&"},Digit8:{key:"8",shiftKey:"*"},Digit9:{key:"9",shiftKey:"("},KeyA:{key:"a",shiftKey:"A"},KeyB:{key:"b",shiftKey:"B"},KeyC:{key:"c",shiftKey:"C"},KeyD:{key:"d",shiftKey:"D"},KeyE:{key:"e",shiftKey:"E"},KeyF:{key:"f",shiftKey:"F"},KeyG:{key:"g",shiftKey:"G"},KeyH:{key:"h",shiftKey:"H"},KeyI:{key:"i",shiftKey:"I"},KeyJ:{key:"j",shiftKey:"J"},KeyK:{key:"k",shiftKey:"K"},KeyL:{key:"l",shiftKey:"L"},KeyM:{key:"m",shiftKey:"M"},KeyN:{key:"n",shiftKey:"N"},KeyO:{key:"o",shiftKey:"O"},KeyP:{key:"p",shiftKey:"P"},KeyQ:{key:"q",shiftKey:"Q"},KeyR:{key:"r",shiftKey:"R"},KeyS:{key:"s",shiftKey:"S"},KeyT:{key:"t",shiftKey:"T"},KeyU:{key:"u",shiftKey:"U"},KeyV:{key:"v",shiftKey:"V"},KeyW:{key:"w",shiftKey:"W"},KeyX:{key:"x",shiftKey:"X"},KeyY:{key:"y",shiftKey:"Y"},KeyZ:{key:"z",shiftKey:"Z"},Numpad0:{key:"0"},Numpad1:{key:"1"},Numpad2:{key:"2"},Numpad3:{key:"3"},Numpad4:{key:"4"},Numpad5:{key:"5"},Numpad6:{key:"6"},Numpad7:{key:"7"},Numpad8:{key:"8"},Numpad9:{key:"9"},NumpadMultiply:{key:"*"},NumpadAdd:{key:"+"},NumpadComma:{key:","},NumpadSubtract:{key:"-"},NumpadDecimal:{key:"."},NumpadDivide:{key:"/"},Semicolon:{key:";",shiftKey:":"},Equal:{key:"=",shiftKey:"+"},Comma:{key:",",shiftKey:"<"},Minus:{key:"-",shiftKey:"_"},Period:{key:".",shiftKey:">"},Slash:{key:"/",shiftKey:"?"},Backquote:{key:"`",shiftKey:"~"},BracketLeft:{key:"[",shiftKey:"{"},Backslash:{key:"\\",shiftKey:"|"},BracketRight:{key:"]",shiftKey:"}"},Quote:{key:"'",shiftKey:'"'},IntlBackslash:{key:"\\",shiftKey:"|"}};b(P,"mac",{OSLeft:{key:"Meta"},OSRight:{key:"Meta"}});var $={Esc:"Escape",Nonconvert:"NonConvert",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Menu:"ContextMenu",MediaNextTrack:"MediaTrackNext",MediaPreviousTrack:"MediaTrackPrevious",SelectMedia:"MediaSelect",HalfWidth:"Hankaku",FullWidth:"Zenkaku",RomanCharacters:"Romaji",Crsel:"CrSel",Exsel:"ExSel",Zoom:"ZoomToggle"},D=L(M,"code");try{var ie=t&&"location"in new KeyboardEvent("")}catch{}function he(G){var J="keyCode"in G?G.keyCode:"which"in G?G.which:0,X=function(){if(ie||"keyLocation"in G){var de=ie?G.location:G.keyLocation;if(de&&J in H[de])return H[de][J]}return"keyIdentifier"in G&&G.keyIdentifier in A?A[G.keyIdentifier]:J in M?M[J]:null}();if(!X)return null;var fe=function(){var de=P[X.code];return de?G.shiftKey&&"shiftKey"in de?de.shiftKey:de.key:X.code}();return{code:X.code,key:fe,location:X.location,keyCap:X.keyCap}}function Ve(G,J){if(G=String(G),!D.hasOwnProperty(G))return"Undefined";if(J&&String(J).toLowerCase()!=="en-us")throw Error("Unsupported locale");var X=D[G];return X.keyCap||X.code||"Undefined"}"KeyboardEvent"in e&&"defineProperty"in Object&&function(){function G(X,fe,de){fe in X||Object.defineProperty(X,fe,de)}if(G(KeyboardEvent.prototype,"code",{get:function(){var X=he(this);return X?X.code:""}}),"key"in KeyboardEvent.prototype){var J=Object.getOwnPropertyDescriptor(KeyboardEvent.prototype,"key");Object.defineProperty(KeyboardEvent.prototype,"key",{get:function(){var X=J.get.call(this);return $.hasOwnProperty(X)?$[X]:X}})}G(KeyboardEvent.prototype,"key",{get:function(){var X=he(this);return X&&"key"in X?X.key:"Unidentified"}}),G(KeyboardEvent.prototype,"location",{get:function(){var X=he(this);return X&&"location"in X?X.location:i}}),G(KeyboardEvent.prototype,"locale",{get:function(){return""}})}(),"queryKeyCap"in e.KeyboardEvent||(e.KeyboardEvent.queryKeyCap=Ve),e.identifyKey=function(G){if(!("code"in G)){var J=he(G);G.code=J?J.code:"",G.key=J&&"key"in J?J.key:"Unidentified",G.location="location"in G?G.location:"keyLocation"in G?G.keyLocation:J&&"location"in J?J.location:i,G.locale=""}}})(window);const Fn="__keyboard-controls-proxy",In=window.KeyboardEvent;AFRAME.registerComponent("keyboard-controls",{schema:{enabled:{default:!0},debug:{default:!1}},init:function(){this.dVelocity=new THREE.Vector3,this.localKeys={},this.listeners={keydown:this.onKeyDown.bind(this),keyup:this.onKeyUp.bind(this),blur:this.onBlur.bind(this)},this.attachEventListeners()},isVelocityActive:function(){return this.data.enabled&&!!Object.keys(this.getKeys()).length},getVelocityDelta:function(){const e=this.data,t=this.getKeys();return this.dVelocity.set(0,0,0),e.enabled&&((t.KeyW||t.ArrowUp)&&(this.dVelocity.z-=1),(t.KeyA||t.ArrowLeft)&&(this.dVelocity.x-=1),(t.KeyS||t.ArrowDown)&&(this.dVelocity.z+=1),(t.KeyD||t.ArrowRight)&&(this.dVelocity.x+=1)),this.dVelocity.clone()},play:function(){this.attachEventListeners()},pause:function(){this.removeEventListeners()},remove:function(){this.pause()},attachEventListeners:function(){window.addEventListener("keydown",this.listeners.keydown,!1),window.addEventListener("keyup",this.listeners.keyup,!1),window.addEventListener("blur",this.listeners.blur,!1)},removeEventListeners:function(){window.removeEventListener("keydown",this.listeners.keydown),window.removeEventListener("keyup",this.listeners.keyup),window.removeEventListener("blur",this.listeners.blur)},onKeyDown:function(e){AFRAME.utils.shouldCaptureKeyEvent(e)&&(this.localKeys[e.code]=!0,this.emit(e))},onKeyUp:function(e){AFRAME.utils.shouldCaptureKeyEvent(e)&&(delete this.localKeys[e.code],this.emit(e))},onBlur:function(){for(let e in this.localKeys)this.localKeys.hasOwnProperty(e)&&delete this.localKeys[e]},emit:function(e){Fn in e&&this.el.emit(e.type,e),this.el.emit(e.type+":"+e.code,new In(e.type,e)),this.data.debug&&console.log(e.type+":"+e.code)},isPressed:function(e){return e in this.getKeys()},getKeys:function(){return this.isProxied()?this.el.sceneEl.components["proxy-controls"].getKeyboard():this.localKeys},isProxied:function(){const e=this.el.sceneEl.components["proxy-controls"];return e&&e.isConnected()}});AFRAME.registerComponent("touch-controls",{schema:{enabled:{default:!0},reverseEnabled:{default:!0}},init:function(){this.dVelocity=new THREE.Vector3,this.bindMethods(),this.direction=0},play:function(){this.addEventListeners()},pause:function(){this.removeEventListeners(),this.dVelocity.set(0,0,0)},remove:function(){this.pause()},addEventListeners:function(){const e=this.el.sceneEl,t=e.canvas;if(!t){e.addEventListener("render-target-loaded",this.addEventListeners.bind(this));return}t.addEventListener("touchstart",this.onTouchStart),t.addEventListener("touchend",this.onTouchEnd)},removeEventListeners:function(){const e=this.el.sceneEl&&this.el.sceneEl.canvas;!e||(e.removeEventListener("touchstart",this.onTouchStart),e.removeEventListener("touchend",this.onTouchEnd))},isVelocityActive:function(){return this.data.enabled&&!!this.direction},getVelocityDelta:function(){return this.dVelocity.z=this.direction,this.dVelocity.clone()},bindMethods:function(){this.onTouchStart=this.onTouchStart.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this)},onTouchStart:function(e){this.direction=-1,this.data.reverseEnabled&&e.touches.length===2&&(this.direction=1),e.preventDefault()},onTouchEnd:function(e){this.direction=0,e.preventDefault()}});const ui="-controls",Bn=.2,zn=1e-5;AFRAME.registerComponent("movement-controls",{dependencies:["rotation"],schema:{enabled:{default:!0},controls:{default:["gamepad","trackpad","keyboard","touch"]},speed:{default:.3,min:0},fly:{default:!1},constrainToNavMesh:{default:!1},camera:{default:"[movement-controls] [camera]",type:"selector"}},init:function(){const e=this.el;this.velocityCtrl=null,this.velocity=new THREE.Vector3,this.heading=new THREE.Quaternion,this.navGroup=null,this.navNode=null,e.sceneEl.hasLoaded?this.injectControls():e.sceneEl.addEventListener("loaded",this.injectControls.bind(this))},update:function(e){const t=this.el,i=this.data,n=t.sceneEl.systems.nav;t.sceneEl.hasLoaded&&this.injectControls(),n&&i.constrainToNavMesh!==e.constrainToNavMesh&&(i.constrainToNavMesh?n.addAgent(this):n.removeAgent(this))},injectControls:function(){const e=this.data;var t;for(let i=0;i<e.controls.length;i++)t=e.controls[i]+ui,this.el.components[t]||this.el.setAttribute(t,"")},updateNavLocation:function(){this.navGroup=null,this.navNode=null},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3;return function(n,a){if(!a)return;const s=this.el,u=this.data;if(!u.enabled)return;this.updateVelocityCtrl();const g=this.velocityCtrl,y=this.velocity;if(!!g)if(a/1e3>Bn?y.set(0,0,0):this.updateVelocity(a),u.constrainToNavMesh&&g.isNavMeshConstrained!==!1){if(y.lengthSq()<zn)return;e.copy(s.object3D.position),t.copy(y).multiplyScalar(a/1e3).add(e);const _=s.sceneEl.systems.nav;this.navGroup=this.navGroup===null?_.getGroup(e):this.navGroup,this.navNode=this.navNode||_.getNode(e,this.navGroup),this.navNode=_.clampStep(e,t,this.navGroup,this.navNode,i),s.object3D.position.copy(i)}else s.hasAttribute("velocity")?s.setAttribute("velocity",y):(s.object3D.position.x+=y.x*a/1e3,s.object3D.position.y+=y.y*a/1e3,s.object3D.position.z+=y.z*a/1e3)}}(),updateVelocityCtrl:function(){const e=this.data;if(e.enabled){for(let t=0,i=e.controls.length;t<i;t++){const n=this.el.components[e.controls[t]+ui];if(n&&n.isVelocityActive()){this.velocityCtrl=n;return}}this.velocityCtrl=null}},updateVelocity:function(){const e=new THREE.Vector2,t=new THREE.Quaternion;return function(i){let n;const a=this.el,s=this.velocityCtrl,u=this.velocity,g=this.data;if(s)if(s.getVelocityDelta)n=s.getVelocityDelta(i);else if(s.getVelocity){u.copy(s.getVelocity());return}else if(s.getPositionDelta){u.copy(s.getPositionDelta(i).multiplyScalar(1e3/i));return}else throw new Error("Incompatible movement controls: ",s);if(a.hasAttribute("velocity")&&!g.constrainToNavMesh&&u.copy(this.el.getAttribute("velocity")),n&&g.enabled){const y=g.camera;t.copy(y.object3D.quaternion),t.premultiply(a.object3D.quaternion),n.applyQuaternion(t);const _=n.length();g.fly?(u.copy(n),u.multiplyScalar(this.data.speed*16.66667)):(e.set(n.x,n.z),e.setLength(_*this.data.speed*16.66667),u.x=e.x,u.z=e.y)}}}()});AFRAME.registerComponent("trackpad-controls",{schema:{enabled:{default:!0},enableNegX:{default:!0},enablePosX:{default:!0},enableNegZ:{default:!0},enablePosZ:{default:!0},mode:{default:"touch",oneOf:["swipe","touch","press"]}},init:function(){this.dVelocity=new THREE.Vector3,this.zVel=0,this.xVel=0,this.bindMethods()},play:function(){this.addEventListeners()},pause:function(){this.removeEventListeners(),this.dVelocity.set(0,0,0)},remove:function(){this.pause()},addEventListeners:function(){const e=this.data,t=this.el.sceneEl;switch(t.addEventListener("axismove",this.onAxisMove),e.mode){case"swipe":case"touch":t.addEventListener("trackpadtouchstart",this.onTouchStart),t.addEventListener("trackpadtouchend",this.onTouchEnd);break;case"press":t.addEventListener("trackpaddown",this.onTouchStart),t.addEventListener("trackpadup",this.onTouchEnd);break}},removeEventListeners:function(){const e=this.el.sceneEl;e.removeEventListener("axismove",this.onAxisMove),e.removeEventListener("trackpadtouchstart",this.onTouchStart),e.removeEventListener("trackpadtouchend",this.onTouchEnd),e.removeEventListener("trackpaddown",this.onTouchStart),e.removeEventListener("trackpadup",this.onTouchEnd)},isVelocityActive:function(){return this.data.enabled&&this.isMoving},getVelocityDelta:function(){return this.dVelocity.z=this.isMoving?-this.zVel:1,this.dVelocity.x=this.isMoving?this.xVel:1,this.dVelocity.clone()},bindMethods:function(){this.onTouchStart=this.onTouchStart.bind(this),this.onTouchEnd=this.onTouchEnd.bind(this),this.onAxisMove=this.onAxisMove.bind(this)},onTouchStart:function(e){switch(this.data.mode){case"swipe":this.canRecordAxis=!0,this.startingAxisData=[];break;case"touch":this.isMoving=!0;break;case"press":this.isMoving=!0;break}e.preventDefault()},onTouchEnd:function(e){this.data.mode=="swipe"&&(this.startingAxisData=[]),this.isMoving=!1,e.preventDefault()},onAxisMove:function(e){switch(this.data.mode){case"swipe":return this.handleSwipeAxis(e);case"touch":case"press":return this.handleTouchAxis(e)}},handleSwipeAxis:function(e){const t=this.data,i=e.detail.axis;if(this.startingAxisData.length===0&&this.canRecordAxis&&(this.canRecordAxis=!1,this.startingAxisData[0]=i[0],this.startingAxisData[1]=i[1]),this.startingAxisData.length>0){let n=0,a=0;t.enableNegX&&i[0]<this.startingAxisData[0]&&(n=-1),t.enablePosX&&i[0]>this.startingAxisData[0]&&(n=1),t.enablePosZ&&i[1]>this.startingAxisData[1]&&(a=-1),t.enableNegZ&&i[1]<this.startingAxisData[1]&&(a=1);const s=Math.abs(this.startingAxisData[1]-i[1]);Math.abs(this.startingAxisData[0]-i[0])>s?(this.zVel=0,this.xVel=n,this.isMoving=!0):(this.xVel=0,this.zVel=a,this.isMoving=!0)}},handleTouchAxis:function(e){const t=this.data,i=e.detail.axis;let n=0,a=0;t.enableNegX&&i[0]<0&&(n=-1),t.enablePosX&&i[0]>0&&(n=1),t.enablePosZ&&i[1]>0&&(a=-1),t.enableNegZ&&i[1]<0&&(a=1),Math.abs(i[0])>Math.abs(i[1])?(this.zVel=0,this.xVel=n):(this.xVel=0,this.zVel=a)}});const Mt={once:THREE.LoopOnce,repeat:THREE.LoopRepeat,pingpong:THREE.LoopPingPong};AFRAME.registerComponent("animation-mixer",{schema:{clip:{default:"*"},duration:{default:0},clampWhenFinished:{default:!1,type:"boolean"},crossFadeDuration:{default:0},loop:{default:"repeat",oneOf:Object.keys(Mt)},repetitions:{default:1/0,min:0},timeScale:{default:1}},init:function(){this.model=null,this.mixer=null,this.activeActions=[];const e=this.el.getObject3D("mesh");e?this.load(e):this.el.addEventListener("model-loaded",t=>{this.load(t.detail.model)})},load:function(e){const t=this.el;this.model=e,this.mixer=new THREE.AnimationMixer(e),this.mixer.addEventListener("loop",i=>{t.emit("animation-loop",{action:i.action,loopDelta:i.loopDelta})}),this.mixer.addEventListener("finished",i=>{t.emit("animation-finished",{action:i.action,direction:i.direction})}),this.data.clip&&this.update({})},remove:function(){this.mixer&&this.mixer.stopAllAction()},update:function(e){if(!e)return;const t=this.data,i=AFRAME.utils.diff(t,e);if("clip"in i){this.stopAction(),t.clip&&this.playAction();return}this.activeActions.forEach(n=>{"duration"in i&&t.duration&&n.setDuration(t.duration),"clampWhenFinished"in i&&(n.clampWhenFinished=t.clampWhenFinished),("loop"in i||"repetitions"in i)&&n.setLoop(Mt[t.loop],t.repetitions),"timeScale"in i&&n.setEffectiveTimeScale(t.timeScale)})},stopAction:function(){const e=this.data;for(let t=0;t<this.activeActions.length;t++)e.crossFadeDuration?this.activeActions[t].fadeOut(e.crossFadeDuration):this.activeActions[t].stop();this.activeActions.length=0},playAction:function(){if(!this.mixer)return;const e=this.model,t=this.data,i=e.animations||(e.geometry||{}).animations||[];if(!i.length)return;const n=Vn(t.clip);for(let a,s=0;a=i[s];s++)if(a.name.match(n)){const u=this.mixer.clipAction(a,e);u.enabled=!0,u.clampWhenFinished=t.clampWhenFinished,t.duration&&u.setDuration(t.duration),t.timeScale!==1&&u.setEffectiveTimeScale(t.timeScale),u.setLoop(Mt[t.loop],t.repetitions).fadeIn(t.crossFadeDuration).play(),this.activeActions.push(u)}},tick:function(e,t){this.mixer&&!isNaN(t)&&this.mixer.update(t/1e3)}});function Vn(e){return new RegExp("^"+e.split(/\*+/).map(jn).join(".*")+"$")}function jn(e){return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&")}var Kn=THREE.ColladaLoader=function(e){this.manager=e!==void 0?e:THREE.DefaultLoadingManager};THREE.ColladaLoader.prototype={constructor:THREE.ColladaLoader,crossOrigin:"anonymous",load:function(e,t,i,n){var a=this,s=a.path===void 0?THREE.LoaderUtils.extractUrlBase(e):a.path,u=new THREE.FileLoader(a.manager);u.setPath(a.path),u.load(e,function(g){t(a.parse(g,s))},i,n)},setPath:function(e){return this.path=e,this},setResourcePath:function(e){return this.resourcePath=e,this},options:{set convertUpAxis(e){console.warn("THREE.ColladaLoader: options.convertUpAxis() has been removed. Up axis is converted automatically.")}},setCrossOrigin:function(e){return this.crossOrigin=e,this},parse:function(e,t){function i(o,l){for(var f=[],m=o.childNodes,d=0,w=m.length;d<w;d++){var C=m[d];C.nodeName===l&&f.push(C)}return f}function n(o){if(o.length===0)return[];for(var l=o.trim().split(/\s+/),f=new Array(l.length),m=0,d=l.length;m<d;m++)f[m]=l[m];return f}function a(o){if(o.length===0)return[];for(var l=o.trim().split(/\s+/),f=new Array(l.length),m=0,d=l.length;m<d;m++)f[m]=parseFloat(l[m]);return f}function s(o){if(o.length===0)return[];for(var l=o.trim().split(/\s+/),f=new Array(l.length),m=0,d=l.length;m<d;m++)f[m]=parseInt(l[m]);return f}function u(o){return o.substring(1)}function g(){return"three_default_"+dn++}function y(o){return Object.keys(o).length===0}function _(o){return{unit:b(i(o,"unit")[0]),upAxis:L(i(o,"up_axis")[0])}}function b(o){return o!==void 0&&o.hasAttribute("meter")===!0?parseFloat(o.getAttribute("meter")):1}function L(o){return o!==void 0?o.textContent:"Y_UP"}function M(o,l,f,m){var d=i(o,l)[0];if(d!==void 0)for(var w=i(d,f),C=0;C<w.length;C++)m(w[C])}function A(o,l){for(var f in o){var m=o[f];m.build=l(o[f])}}function H(o,l){return o.build!==void 0||(o.build=l(o)),o.build}function P(o){for(var l={sources:{},samplers:{},channels:{}},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1){var w;switch(d.nodeName){case"source":w=d.getAttribute("id"),l.sources[w]=wt(d);break;case"sampler":w=d.getAttribute("id"),l.samplers[w]=$(d);break;case"channel":w=d.getAttribute("target"),l.channels[w]=D(d);break;default:console.log(d)}}}U.animations[o.getAttribute("id")]=l}function $(o){for(var l={inputs:{}},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"input":var w=u(d.getAttribute("source")),C=d.getAttribute("semantic");l.inputs[C]=w;break}}return l}function D(o){var l={},f=o.getAttribute("target"),m=f.split("/"),d=m.shift(),w=m.shift(),C=w.indexOf("(")!==-1,N=w.indexOf(".")!==-1;if(N)m=w.split("."),w=m.shift(),l.member=m.shift();else if(C){var I=w.split("(");w=I.shift();for(var K=0;K<I.length;K++)I[K]=parseInt(I[K].replace(/\)/,""));l.indices=I}return l.id=d,l.sid=w,l.arraySyntax=C,l.memberSyntax=N,l.sampler=u(o.getAttribute("source")),l}function ie(o){var l=[],f=o.channels,m=o.samplers,d=o.sources;for(var w in f)if(f.hasOwnProperty(w)){var C=f[w],N=m[C.sampler],I=N.inputs.INPUT,K=N.inputs.OUTPUT,F=d[I],j=d[K],re=Ve(C,F,j);de(re,l)}return l}function he(o){return H(U.animations[o],ie)}function Ve(o,l,f){var m=U.nodes[o.id],d=Je(m.id),w=m.transforms[o.sid],C=m.matrix.clone().transpose(),N,I,K,F,j,re,Z={};switch(w){case"matrix":for(K=0,F=l.array.length;K<F;K++)if(N=l.array[K],I=K*f.stride,Z[N]===void 0&&(Z[N]={}),o.arraySyntax===!0){var Y=f.array[I],z=o.indices[0]+4*o.indices[1];Z[N][z]=Y}else for(j=0,re=f.stride;j<re;j++)Z[N][j]=f.array[I+j];break;case"translate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',w);break;case"rotate":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',w);break;case"scale":console.warn('THREE.ColladaLoader: Animation transform type "%s" not yet implemented.',w);break}var Q=G(Z,C),ee={name:d.uuid,keyframes:Q};return ee}function G(o,l){var f=[];for(var m in o)f.push({time:parseFloat(m),value:o[m]});f.sort(w);for(var d=0;d<16;d++)yt(f,d,l.elements[d]);return f;function w(C,N){return C.time-N.time}}var J=new THREE.Vector3,X=new THREE.Vector3,fe=new THREE.Quaternion;function de(o,l){for(var f=o.keyframes,m=o.name,d=[],w=[],C=[],N=[],I=0,K=f.length;I<K;I++){var F=f[I],j=F.time,re=F.value;Ae.fromArray(re).transpose(),Ae.decompose(J,fe,X),d.push(j),w.push(J.x,J.y,J.z),C.push(fe.x,fe.y,fe.z,fe.w),N.push(X.x,X.y,X.z)}return w.length>0&&l.push(new THREE.VectorKeyframeTrack(m+".position",d,w)),C.length>0&&l.push(new THREE.QuaternionKeyframeTrack(m+".quaternion",d,C)),N.length>0&&l.push(new THREE.VectorKeyframeTrack(m+".scale",d,N)),l}function yt(o,l,f){var m,d=!0,w,C;for(w=0,C=o.length;w<C;w++)m=o[w],m.value[l]===void 0?m.value[l]=null:d=!1;if(d===!0)for(w=0,C=o.length;w<C;w++)m=o[w],m.value[l]=f;else Et(o,l)}function Et(o,l){for(var f,m,d=0,w=o.length;d<w;d++){var C=o[d];if(C.value[l]===null){if(f=st(o,d,l),m=r(o,d,l),f===null){C.value[l]=m.value[l];continue}if(m===null){C.value[l]=f.value[l];continue}c(C,f,m,l)}}}function st(o,l,f){for(;l>=0;){var m=o[l];if(m.value[f]!==null)return m;l--}return null}function r(o,l,f){for(;l<o.length;){var m=o[l];if(m.value[f]!==null)return m;l++}return null}function c(o,l,f,m){if(f.time-l.time===0){o.value[m]=l.value[m];return}o.value[m]=(o.time-l.time)*(f.value[m]-l.value[m])/(f.time-l.time)+l.value[m]}function h(o){for(var l={name:o.getAttribute("id")||"default",start:parseFloat(o.getAttribute("start")||0),end:parseFloat(o.getAttribute("end")||0),animations:[]},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"instance_animation":l.animations.push(u(d.getAttribute("url")));break}}U.clips[o.getAttribute("id")]=l}function p(o){for(var l=[],f=o.name,m=o.end-o.start||-1,d=o.animations,w=0,C=d.length;w<C;w++)for(var N=he(d[w]),I=0,K=N.length;I<K;I++)l.push(N[I]);return new THREE.AnimationClip(f,m,l)}function v(o){return H(U.clips[o],p)}function E(o){for(var l={},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"skin":l.id=u(d.getAttribute("source")),l.skin=T(d);break;case"morph":l.id=u(d.getAttribute("source")),console.warn("THREE.ColladaLoader: Morph target animation not supported yet.");break}}U.controllers[o.getAttribute("id")]=l}function T(o){for(var l={sources:{}},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"bind_shape_matrix":l.bindShapeMatrix=a(d.textContent);break;case"source":var w=d.getAttribute("id");l.sources[w]=wt(d);break;case"joints":l.joints=k(d);break;case"vertex_weights":l.vertexWeights=S(d);break}}return l}function k(o){for(var l={inputs:{}},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"input":var w=d.getAttribute("semantic"),C=u(d.getAttribute("source"));l.inputs[w]=C;break}}return l}function S(o){for(var l={inputs:{}},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"input":var w=d.getAttribute("semantic"),C=u(d.getAttribute("source")),N=parseInt(d.getAttribute("offset"));l.inputs[w]={id:C,offset:N};break;case"vcount":l.vcount=s(d.textContent);break;case"v":l.v=s(d.textContent);break}}return l}function O(o){var l={id:o.id},f=U.geometries[l.id];return o.skin!==void 0&&(l.skin=R(o.skin),f.sources.skinIndices=l.skin.indices,f.sources.skinWeights=l.skin.weights),l}function R(o){var l=4,f={joints:[],indices:{array:[],stride:l},weights:{array:[],stride:l}},m=o.sources,d=o.vertexWeights,w=d.vcount,C=d.v,N=d.inputs.JOINT.offset,I=d.inputs.WEIGHT.offset,K=o.sources[o.joints.inputs.JOINT],F=o.sources[o.joints.inputs.INV_BIND_MATRIX],j=m[d.inputs.WEIGHT.id].array,re=0,Z,Y,z;for(Z=0,z=w.length;Z<z;Z++){var Q=w[Z],ee=[];for(Y=0;Y<Q;Y++){var ae=C[re+N],le=C[re+I],ve=j[le];ee.push({index:ae,weight:ve}),re+=2}for(ee.sort(Rt),Y=0;Y<l;Y++){var te=ee[Y];te!==void 0?(f.indices.array.push(te.index),f.weights.array.push(te.weight)):(f.indices.array.push(0),f.weights.array.push(0))}}for(o.bindShapeMatrix?f.bindMatrix=new THREE.Matrix4().fromArray(o.bindShapeMatrix).transpose():f.bindMatrix=new THREE.Matrix4().identity(),Z=0,z=K.array.length;Z<z;Z++){var xe=K.array[Z],W=new THREE.Matrix4().fromArray(F.array,Z*F.stride).transpose();f.joints.push({name:xe,boneInverse:W})}return f;function Rt(ht,pn){return pn.weight-ht.weight}}function V(o){return H(U.controllers[o],O)}function B(o){var l={init_from:i(o,"init_from")[0].textContent};U.images[o.getAttribute("id")]=l}function se(o){return o.build!==void 0?o.build:o.init_from}function be(o){var l=U.images[o];return l!==void 0?H(l,se):(console.warn("THREE.ColladaLoader: Couldn't find image with ID:",o),null)}function me(o){for(var l={},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"profile_COMMON":l.profile=ke(d);break}}U.effects[o.getAttribute("id")]=l}function ke(o){for(var l={surfaces:{},samplers:{}},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"newparam":De(d,l);break;case"technique":l.technique=Fe(d);break;case"extra":l.extra=ct(d);break}}return l}function De(o,l){for(var f=o.getAttribute("sid"),m=0,d=o.childNodes.length;m<d;m++){var w=o.childNodes[m];if(w.nodeType===1)switch(w.nodeName){case"surface":l.surfaces[f]=et(w);break;case"sampler2D":l.samplers[f]=ot(w);break}}}function et(o){for(var l={},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"init_from":l.init_from=d.textContent;break}}return l}function ot(o){for(var l={},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"source":l.source=d.textContent;break}}return l}function Fe(o){for(var l={},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"constant":case"lambert":case"blinn":case"phong":l.type=d.nodeName,l.parameters=bt(d);break}}return l}function bt(o){for(var l={},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":l[d.nodeName]=Ie(d);break;case"transparent":l[d.nodeName]={opaque:d.getAttribute("opaque"),data:Ie(d)};break}}return l}function Ie(o){for(var l={},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"color":l[d.nodeName]=a(d.textContent);break;case"float":l[d.nodeName]=parseFloat(d.textContent);break;case"texture":l[d.nodeName]={id:d.getAttribute("texture"),extra:je(d)};break}}return l}function je(o){for(var l={technique:{}},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"extra":Ke(d,l);break}}return l}function Ke(o,l){for(var f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"technique":lt(d,l);break}}}function lt(o,l){for(var f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":l.technique[d.nodeName]=parseFloat(d.textContent);break;case"wrapU":case"wrapV":d.textContent.toUpperCase()==="TRUE"?l.technique[d.nodeName]=1:d.textContent.toUpperCase()==="FALSE"?l.technique[d.nodeName]=0:l.technique[d.nodeName]=parseInt(d.textContent);break}}}function ct(o){for(var l={},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"technique":l.technique=tt(d);break}}return l}function tt(o){for(var l={},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"double_sided":l[d.nodeName]=parseInt(d.textContent);break}}return l}function ut(o){return o}function Tt(o){return H(U.effects[o],ut)}function Ti(o){for(var l={name:o.getAttribute("name")},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"instance_effect":l.url=u(d.getAttribute("url"));break}}U.materials[o.getAttribute("id")]=l}function wi(o){var l,f=o.slice((o.lastIndexOf(".")-1>>>0)+2);switch(f=f.toLowerCase(),f){case"tga":l=xt;break;default:l=ii}return l}function jt(o){var l=Tt(o.url),f=l.profile.technique,m=l.profile.extra,d;switch(f.type){case"phong":case"blinn":d=new THREE.MeshPhongMaterial;break;case"lambert":d=new THREE.MeshLambertMaterial;break;default:d=new THREE.MeshBasicMaterial;break}d.name=o.name;function w(re){var Z=l.profile.samplers[re.id],Y=null;if(Z!==void 0){var z=l.profile.surfaces[Z.source];Y=be(z.init_from)}else console.warn("THREE.ColladaLoader: Undefined sampler. Access image directly (see #12530)."),Y=be(re.id);if(Y!==null){var Q=wi(Y);if(Q!==void 0){var ee=Q.load(Y),ae=re.extra;if(ae!==void 0&&ae.technique!==void 0&&y(ae.technique)===!1){var le=ae.technique;ee.wrapS=le.wrapU?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,ee.wrapT=le.wrapV?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,ee.offset.set(le.offsetU||0,le.offsetV||0),ee.repeat.set(le.repeatU||1,le.repeatV||1)}else ee.wrapS=THREE.RepeatWrapping,ee.wrapT=THREE.RepeatWrapping;return ee}else return console.warn("THREE.ColladaLoader: Loader for texture %s not found.",Y),null}else return console.warn("THREE.ColladaLoader: Couldn't create texture with ID:",re.id),null}var C=f.parameters;for(var N in C){var I=C[N];switch(N){case"diffuse":I.color&&d.color.fromArray(I.color),I.texture&&(d.map=w(I.texture));break;case"specular":I.color&&d.specular&&d.specular.fromArray(I.color),I.texture&&(d.specularMap=w(I.texture));break;case"bump":I.texture&&(d.normalMap=w(I.texture));break;case"ambient":I.texture&&(d.lightMap=w(I.texture));break;case"shininess":I.float&&d.shininess&&(d.shininess=I.float);break;case"emission":I.color&&d.emissive&&d.emissive.fromArray(I.color),I.texture&&(d.emissiveMap=w(I.texture));break}}var K=C.transparent,F=C.transparency;if(F===void 0&&K&&(F={float:1}),K===void 0&&F&&(K={opaque:"A_ONE",data:{color:[1,1,1,1]}}),K&&F)if(K.data.texture)d.transparent=!0;else{var j=K.data.color;switch(K.opaque){case"A_ONE":d.opacity=j[3]*F.float;break;case"RGB_ZERO":d.opacity=1-j[0]*F.float;break;case"A_ZERO":d.opacity=1-j[3]*F.float;break;case"RGB_ONE":d.opacity=j[0]*F.float;break;default:console.warn('THREE.ColladaLoader: Invalid opaque type "%s" of transparent tag.',K.opaque)}d.opacity<1&&(d.transparent=!0)}return m!==void 0&&m.technique!==void 0&&m.technique.double_sided===1&&(d.side=THREE.DoubleSide),d}function ki(o){return H(U.materials[o],jt)}function xi(o){for(var l={name:o.getAttribute("name")},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"optics":l.optics=_i(d);break}}U.cameras[o.getAttribute("id")]=l}function _i(o){for(var l=0;l<o.childNodes.length;l++){var f=o.childNodes[l];switch(f.nodeName){case"technique_common":return Ai(f)}}return{}}function Ai(o){for(var l={},f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];switch(m.nodeName){case"perspective":case"orthographic":l.technique=m.nodeName,l.parameters=Ri(m);break}}return l}function Ri(o){for(var l={},f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];switch(m.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":l[m.nodeName]=parseFloat(m.textContent);break}}return l}function Kt(o){var l;switch(o.optics.technique){case"perspective":l=new THREE.PerspectiveCamera(o.optics.parameters.yfov,o.optics.parameters.aspect_ratio,o.optics.parameters.znear,o.optics.parameters.zfar);break;case"orthographic":var f=o.optics.parameters.ymag,m=o.optics.parameters.xmag,d=o.optics.parameters.aspect_ratio;m=m===void 0?f*d:m,f=f===void 0?m/d:f,m*=.5,f*=.5,l=new THREE.OrthographicCamera(-m,m,f,-f,o.optics.parameters.znear,o.optics.parameters.zfar);break;default:l=new THREE.PerspectiveCamera;break}return l.name=o.name,l}function Ci(o){var l=U.cameras[o];return l!==void 0?H(l,Kt):(console.warn("THREE.ColladaLoader: Couldn't find camera with ID:",o),null)}function Mi(o){for(var l={},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"technique_common":l=Si(d);break}}U.lights[o.getAttribute("id")]=l}function Si(o){for(var l={},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"directional":case"point":case"spot":case"ambient":l.technique=d.nodeName,l.parameters=Li(d)}}return l}function Li(o){for(var l={},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"color":var w=a(d.textContent);l.color=new THREE.Color().fromArray(w);break;case"falloff_angle":l.falloffAngle=parseFloat(d.textContent);break;case"quadratic_attenuation":var C=parseFloat(d.textContent);l.distance=C?Math.sqrt(1/C):0;break}}return l}function Gt(o){var l;switch(o.technique){case"directional":l=new THREE.DirectionalLight;break;case"point":l=new THREE.PointLight;break;case"spot":l=new THREE.SpotLight;break;case"ambient":l=new THREE.AmbientLight;break}return o.parameters.color&&l.color.copy(o.parameters.color),o.parameters.distance&&(l.distance=o.parameters.distance),l}function Hi(o){var l=U.lights[o];return l!==void 0?H(l,Gt):(console.warn("THREE.ColladaLoader: Couldn't find light with ID:",o),null)}function Di(o){var l={name:o.getAttribute("name"),sources:{},vertices:{},primitives:[]},f=i(o,"mesh")[0];if(f!==void 0){for(var m=0;m<f.childNodes.length;m++){var d=f.childNodes[m];if(d.nodeType===1){var w=d.getAttribute("id");switch(d.nodeName){case"source":l.sources[w]=wt(d);break;case"vertices":l.vertices=Oi(d);break;case"polygons":console.warn("THREE.ColladaLoader: Unsupported primitive type: ",d.nodeName);break;case"lines":case"linestrips":case"polylist":case"triangles":l.primitives.push(Ni(d));break;default:console.log(d)}}}U.geometries[o.getAttribute("id")]=l}}function wt(o){for(var l={array:[],stride:3},f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];if(m.nodeType===1)switch(m.nodeName){case"float_array":l.array=a(m.textContent);break;case"Name_array":l.array=n(m.textContent);break;case"technique_common":var d=i(m,"accessor")[0];d!==void 0&&(l.stride=parseInt(d.getAttribute("stride")));break}}return l}function Oi(o){for(var l={},f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];m.nodeType===1&&(l[m.getAttribute("semantic")]=u(m.getAttribute("source")))}return l}function Ni(o){for(var l={type:o.nodeName,material:o.getAttribute("material"),count:parseInt(o.getAttribute("count")),inputs:{},stride:0,hasUV:!1},f=0,m=o.childNodes.length;f<m;f++){var d=o.childNodes[f];if(d.nodeType===1)switch(d.nodeName){case"input":var w=u(d.getAttribute("source")),C=d.getAttribute("semantic"),N=parseInt(d.getAttribute("offset")),I=parseInt(d.getAttribute("set")),K=I>0?C+I:C;l.inputs[K]={id:w,offset:N},l.stride=Math.max(l.stride,N+1),C==="TEXCOORD"&&(l.hasUV=!0);break;case"vcount":l.vcount=s(d.textContent);break;case"p":l.p=s(d.textContent);break}}return l}function Pi(o){for(var l={},f=0;f<o.length;f++){var m=o[f];l[m.type]===void 0&&(l[m.type]=[]),l[m.type].push(m)}return l}function Fi(o){for(var l=0,f=0,m=o.length;f<m;f++){var d=o[f];d.hasUV===!0&&l++}l>0&&l<o.length&&(o.uvsNeedsFix=!0)}function Ut(o){var l={},f=o.sources,m=o.vertices,d=o.primitives;if(d.length===0)return{};var w=Pi(d);for(var C in w){var N=w[C];Fi(N),l[C]=Ii(N,f,m)}return l}function Ii(o,l,f){for(var m={},d={array:[],stride:0},w={array:[],stride:0},C={array:[],stride:0},N={array:[],stride:0},I={array:[],stride:0},K={array:[],stride:4},F={array:[],stride:4},j=new THREE.BufferGeometry,re=[],Z=0,Y=0;Y<o.length;Y++){var z=o[Y],Q=z.inputs,ee=0;switch(z.type){case"lines":case"linestrips":ee=z.count*2;break;case"triangles":ee=z.count*3;break;case"polylist":for(var ae=0;ae<z.count;ae++){var le=z.vcount[ae];switch(le){case 3:ee+=3;break;case 4:ee+=6;break;default:ee+=(le-2)*3;break}}break;default:console.warn("THREE.ColladaLoader: Unknow primitive type:",z.type)}j.addGroup(Z,ee,Y),Z+=ee,z.material&&re.push(z.material);for(var ve in Q){var te=Q[ve];switch(ve){case"VERTEX":for(var xe in f){var W=f[xe];switch(xe){case"POSITION":var Rt=d.array.length;if(Oe(z,l[W],te.offset,d.array),d.stride=l[W].stride,l.skinWeights&&l.skinIndices&&(Oe(z,l.skinIndices,te.offset,K.array),Oe(z,l.skinWeights,te.offset,F.array)),z.hasUV===!1&&o.uvsNeedsFix===!0)for(var ee=(d.array.length-Rt)/d.stride,ht=0;ht<ee;ht++)C.array.push(0,0);break;case"NORMAL":Oe(z,l[W],te.offset,w.array),w.stride=l[W].stride;break;case"COLOR":Oe(z,l[W],te.offset,I.array),I.stride=l[W].stride;break;case"TEXCOORD":Oe(z,l[W],te.offset,C.array),C.stride=l[W].stride;break;case"TEXCOORD1":Oe(z,l[W],te.offset,N.array),C.stride=l[W].stride;break;default:console.warn('THREE.ColladaLoader: Semantic "%s" not handled in geometry build process.',xe)}}break;case"NORMAL":Oe(z,l[te.id],te.offset,w.array),w.stride=l[te.id].stride;break;case"COLOR":Oe(z,l[te.id],te.offset,I.array),I.stride=l[te.id].stride;break;case"TEXCOORD":Oe(z,l[te.id],te.offset,C.array),C.stride=l[te.id].stride;break;case"TEXCOORD1":Oe(z,l[te.id],te.offset,N.array),N.stride=l[te.id].stride;break}}}return d.array.length>0&&j.addAttribute("position",new THREE.Float32BufferAttribute(d.array,d.stride)),w.array.length>0&&j.addAttribute("normal",new THREE.Float32BufferAttribute(w.array,w.stride)),I.array.length>0&&j.addAttribute("color",new THREE.Float32BufferAttribute(I.array,I.stride)),C.array.length>0&&j.addAttribute("uv",new THREE.Float32BufferAttribute(C.array,C.stride)),N.array.length>0&&j.addAttribute("uv2",new THREE.Float32BufferAttribute(N.array,N.stride)),K.array.length>0&&j.addAttribute("skinIndex",new THREE.Float32BufferAttribute(K.array,K.stride)),F.array.length>0&&j.addAttribute("skinWeight",new THREE.Float32BufferAttribute(F.array,F.stride)),m.data=j,m.type=o[0].type,m.materialKeys=re,m}function Oe(o,l,f,m){var d=o.p,w=o.stride,C=o.vcount;function N(ve){for(var te=d[ve+f]*K,xe=te+K;te<xe;te++)m.push(I[te])}var I=l.array,K=l.stride;if(o.vcount!==void 0)for(var F=0,j=0,re=C.length;j<re;j++){var Z=C[j];if(Z===4){var Y=F+w*0,z=F+w*1,Q=F+w*2,ee=F+w*3;N(Y),N(z),N(ee),N(z),N(Q),N(ee)}else if(Z===3){var Y=F+w*0,z=F+w*1,Q=F+w*2;N(Y),N(z),N(Q)}else if(Z>4)for(var ae=1,le=Z-2;ae<=le;ae++){var Y=F+w*0,z=F+w*ae,Q=F+w*(ae+1);N(Y),N(z),N(Q)}F+=w*Z}else for(var j=0,re=d.length;j<re;j+=w)N(j)}function qt(o){return H(U.geometries[o],Ut)}function Bi(o){for(var l={name:o.getAttribute("name")||"",joints:{},links:[]},f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];if(m.nodeType===1)switch(m.nodeName){case"technique_common":ji(m,l);break}}U.kinematicsModels[o.getAttribute("id")]=l}function zi(o){return o.build!==void 0?o.build:o}function Vi(o){return H(U.kinematicsModels[o],zi)}function ji(o,l){for(var f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];if(m.nodeType===1)switch(m.nodeName){case"joint":l.joints[m.getAttribute("sid")]=Ki(m);break;case"link":l.links.push($t(m));break}}}function Ki(o){for(var l,f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];if(m.nodeType===1)switch(m.nodeName){case"prismatic":case"revolute":l=Gi(m);break}}return l}function Gi(o,f){for(var f={sid:o.getAttribute("sid"),name:o.getAttribute("name")||"",axis:new THREE.Vector3,limits:{min:0,max:0},type:o.nodeName,static:!1,zeroPosition:0,middlePosition:0},m=0;m<o.childNodes.length;m++){var d=o.childNodes[m];if(d.nodeType===1)switch(d.nodeName){case"axis":var w=a(d.textContent);f.axis.fromArray(w);break;case"limits":var C=d.getElementsByTagName("max")[0],N=d.getElementsByTagName("min")[0];f.limits.max=parseFloat(C.textContent),f.limits.min=parseFloat(N.textContent);break}}return f.limits.min>=f.limits.max&&(f.static=!0),f.middlePosition=(f.limits.min+f.limits.max)/2,f}function $t(o){for(var l={sid:o.getAttribute("sid"),name:o.getAttribute("name")||"",attachments:[],transforms:[]},f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];if(m.nodeType===1)switch(m.nodeName){case"attachment_full":l.attachments.push(Ui(m));break;case"matrix":case"translate":case"rotate":l.transforms.push(Xt(m));break}}return l}function Ui(o){for(var l={joint:o.getAttribute("joint").split("/").pop(),transforms:[],links:[]},f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];if(m.nodeType===1)switch(m.nodeName){case"link":l.links.push($t(m));break;case"matrix":case"translate":case"rotate":l.transforms.push(Xt(m));break}}return l}function Xt(o){var l={type:o.nodeName},f=a(o.textContent);switch(l.type){case"matrix":l.obj=new THREE.Matrix4,l.obj.fromArray(f).transpose();break;case"translate":l.obj=new THREE.Vector3,l.obj.fromArray(f);break;case"rotate":l.obj=new THREE.Vector3,l.obj.fromArray(f),l.angle=THREE.Math.degToRad(f[3]);break}return l}function qi(o){for(var l={name:o.getAttribute("name")||"",rigidBodies:{}},f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];if(m.nodeType===1)switch(m.nodeName){case"rigid_body":l.rigidBodies[m.getAttribute("name")]={},$i(m,l.rigidBodies[m.getAttribute("name")]);break}}U.physicsModels[o.getAttribute("id")]=l}function $i(o,l){for(var f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];if(m.nodeType===1)switch(m.nodeName){case"technique_common":Xi(m,l);break}}}function Xi(o,l){for(var f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];if(m.nodeType===1)switch(m.nodeName){case"inertia":l.inertia=a(m.textContent);break;case"mass":l.mass=a(m.textContent)[0];break}}}function Wi(o){for(var l={bindJointAxis:[]},f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];if(m.nodeType===1)switch(m.nodeName){case"bind_joint_axis":l.bindJointAxis.push(Zi(m));break}}U.kinematicsScenes[u(o.getAttribute("url"))]=l}function Zi(o){for(var l={target:o.getAttribute("target").split("/").pop()},f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];if(m.nodeType===1)switch(m.nodeName){case"axis":var d=m.getElementsByTagName("param")[0];l.axis=d.textContent;var w=l.axis.split("inst_").pop().split("axis")[0];l.jointIndex=w.substr(0,w.length-1);break}}return l}function Ji(o){return o.build!==void 0?o.build:o}function Yi(o){return H(U.kinematicsScenes[o],Ji)}function Qi(){var o=Object.keys(U.kinematicsModels)[0],l=Object.keys(U.kinematicsScenes)[0],f=Object.keys(U.visualScenes)[0];if(o===void 0||l===void 0)return;for(var m=Vi(o),d=Yi(l),w=ei(f),C=d.bindJointAxis,N={},I=0,K=C.length;I<K;I++){var F=C[I],j=pe.querySelector('[sid="'+F.target+'"]');if(j){var re=j.parentElement;Z(F.jointIndex,re)}}function Z(z,Q){var ee=Q.getAttribute("name"),ae=m.joints[z];w.traverse(function(le){le.name===ee&&(N[z]={object:le,transforms:en(Q),joint:ae,position:ae.zeroPosition})})}var Y=new THREE.Matrix4;ni={joints:m&&m.joints,getJointValue:function(z){var Q=N[z];if(Q)return Q.position;console.warn("THREE.ColladaLoader: Joint "+z+" doesn't exist.")},setJointValue:function(z,Q){var ee=N[z];if(ee){var ae=ee.joint;if(Q>ae.limits.max||Q<ae.limits.min)console.warn("THREE.ColladaLoader: Joint "+z+" value "+Q+" outside of limits (min: "+ae.limits.min+", max: "+ae.limits.max+").");else if(ae.static)console.warn("THREE.ColladaLoader: Joint "+z+" is static.");else{var le=ee.object,ve=ae.axis,te=ee.transforms;Ae.identity();for(var xe=0;xe<te.length;xe++){var W=te[xe];if(W.sid&&W.sid.indexOf(z)!==-1)switch(ae.type){case"revolute":Ae.multiply(Y.makeRotationAxis(ve,THREE.Math.degToRad(Q)));break;case"prismatic":Ae.multiply(Y.makeTranslation(ve.x*Q,ve.y*Q,ve.z*Q));break;default:console.warn("THREE.ColladaLoader: Unknown joint type: "+ae.type);break}else switch(W.type){case"matrix":Ae.multiply(W.obj);break;case"translate":Ae.multiply(Y.makeTranslation(W.obj.x,W.obj.y,W.obj.z));break;case"scale":Ae.scale(W.obj);break;case"rotate":Ae.multiply(Y.makeRotationAxis(W.obj,W.angle));break}}le.matrix.copy(Ae),le.matrix.decompose(le.position,le.quaternion,le.scale),N[z].position=Q}}else console.log("THREE.ColladaLoader: "+z+" does not exist.")}}}function en(o){for(var l=[],f=pe.querySelector('[id="'+o.id+'"]'),m=0;m<f.childNodes.length;m++){var d=f.childNodes[m];if(d.nodeType===1)switch(d.nodeName){case"matrix":var C=a(d.textContent),w=new THREE.Matrix4().fromArray(C).transpose();l.push({sid:d.getAttribute("sid"),type:d.nodeName,obj:w});break;case"translate":case"scale":var C=a(d.textContent),N=new THREE.Vector3().fromArray(C);l.push({sid:d.getAttribute("sid"),type:d.nodeName,obj:N});break;case"rotate":var C=a(d.textContent),N=new THREE.Vector3().fromArray(C),I=THREE.Math.degToRad(C[3]);l.push({sid:d.getAttribute("sid"),type:d.nodeName,obj:N,angle:I});break}}return l}function tn(o){for(var l=o.getElementsByTagName("node"),f=0;f<l.length;f++){var m=l[f];m.hasAttribute("id")===!1&&m.setAttribute("id",g())}}var Ae=new THREE.Matrix4,Ze=new THREE.Vector3;function kt(o){for(var l={name:o.getAttribute("name")||"",type:o.getAttribute("type"),id:o.getAttribute("id"),sid:o.getAttribute("sid"),matrix:new THREE.Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}},f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];if(m.nodeType===1)switch(m.nodeName){case"node":l.nodes.push(m.getAttribute("id")),kt(m);break;case"instance_camera":l.instanceCameras.push(u(m.getAttribute("url")));break;case"instance_controller":l.instanceControllers.push(Wt(m));break;case"instance_light":l.instanceLights.push(u(m.getAttribute("url")));break;case"instance_geometry":l.instanceGeometries.push(Wt(m));break;case"instance_node":l.instanceNodes.push(u(m.getAttribute("url")));break;case"matrix":var w=a(m.textContent);l.matrix.multiply(Ae.fromArray(w).transpose()),l.transforms[m.getAttribute("sid")]=m.nodeName;break;case"translate":var w=a(m.textContent);Ze.fromArray(w),l.matrix.multiply(Ae.makeTranslation(Ze.x,Ze.y,Ze.z)),l.transforms[m.getAttribute("sid")]=m.nodeName;break;case"rotate":var w=a(m.textContent),d=THREE.Math.degToRad(w[3]);l.matrix.multiply(Ae.makeRotationAxis(Ze.fromArray(w),d)),l.transforms[m.getAttribute("sid")]=m.nodeName;break;case"scale":var w=a(m.textContent);l.matrix.scale(Ze.fromArray(w)),l.transforms[m.getAttribute("sid")]=m.nodeName;break;case"extra":break;default:console.log(m)}}return Yt(l.id)?console.warn("THREE.ColladaLoader: There is already a node with ID %s. Exclude current node from further processing.",l.id):U.nodes[l.id]=l,l}function Wt(o){for(var l={id:u(o.getAttribute("url")),materials:{},skeletons:[]},f=0;f<o.childNodes.length;f++){var m=o.childNodes[f];switch(m.nodeName){case"bind_material":for(var d=m.getElementsByTagName("instance_material"),w=0;w<d.length;w++){var C=d[w],N=C.getAttribute("symbol"),I=C.getAttribute("target");l.materials[N]=u(I)}break;case"skeleton":l.skeletons.push(u(m.textContent));break}}return l}function nn(o,l){var f=[],m=[],d,w,C;for(d=0;d<o.length;d++){var N=o[d],I;if(Yt(N))I=Je(N),Zt(I,l,f);else if(ln(N))for(var K=U.visualScenes[N],F=K.children,w=0;w<F.length;w++){var j=F[w];if(j.type==="JOINT"){var I=Je(j.id);Zt(I,l,f)}}else console.error("THREE.ColladaLoader: Unable to find root bone of skeleton with ID:",N)}for(d=0;d<l.length;d++)for(w=0;w<f.length;w++)if(C=f[w],C.bone.name===l[d].name){m[d]=C,C.processed=!0;break}for(d=0;d<f.length;d++)C=f[d],C.processed===!1&&(m.push(C),C.processed=!0);var re=[],Z=[];for(d=0;d<m.length;d++)C=m[d],re.push(C.bone),Z.push(C.boneInverse);return new THREE.Skeleton(re,Z)}function Zt(o,l,f){o.traverse(function(m){if(m.isBone===!0){for(var d,w=0;w<l.length;w++){var C=l[w];if(C.name===m.name){d=C.boneInverse;break}}d===void 0&&(d=new THREE.Matrix4),f.push({bone:m,boneInverse:d,processed:!1})}})}function rn(o){for(var l=[],f=o.matrix,m=o.nodes,d=o.type,w=o.instanceCameras,C=o.instanceControllers,N=o.instanceLights,I=o.instanceGeometries,K=o.instanceNodes,F=0,j=m.length;F<j;F++)l.push(Je(m[F]));for(var F=0,j=w.length;F<j;F++){var re=Ci(w[F]);re!==null&&l.push(re.clone())}for(var F=0,j=C.length;F<j;F++)for(var Z=C[F],Y=V(Z.id),z=qt(Y.id),Q=Jt(z,Z.materials),ee=Z.skeletons,ae=Y.skin.joints,le=nn(ee,ae),ve=0,te=Q.length;ve<te;ve++){var W=Q[ve];W.isSkinnedMesh&&(W.bind(le,Y.skin.bindMatrix),W.normalizeSkinWeights()),l.push(W)}for(var F=0,j=N.length;F<j;F++){var xe=Hi(N[F]);xe!==null&&l.push(xe.clone())}for(var F=0,j=I.length;F<j;F++)for(var Z=I[F],z=qt(Z.id),Q=Jt(z,Z.materials),ve=0,te=Q.length;ve<te;ve++)l.push(Q[ve]);for(var F=0,j=K.length;F<j;F++)l.push(Je(K[F]).clone());var W;if(m.length===0&&l.length===1)W=l[0];else{W=d==="JOINT"?new THREE.Bone:new THREE.Group;for(var F=0;F<l.length;F++)W.add(l[F])}return W.name===""&&(W.name=d==="JOINT"?o.sid:o.name),W.matrix.copy(f),W.matrix.decompose(W.position,W.quaternion,W.scale),W}var an=new THREE.MeshBasicMaterial({color:16711935});function sn(o,l){for(var f=[],m=0,d=o.length;m<d;m++){var w=l[o[m]];w===void 0?(console.warn("THREE.ColladaLoader: Material with key %s not found. Apply fallback material.",o[m]),f.push(an)):f.push(ki(w))}return f}function Jt(o,l){var f=[];for(var m in o){var d=o[m],w=sn(d.materialKeys,l);w.length===0&&(m==="lines"||m==="linestrips"?w.push(new THREE.LineBasicMaterial):w.push(new THREE.MeshPhongMaterial));var C=d.data.attributes.skinIndex!==void 0;if(C)for(var N=0,I=w.length;N<I;N++)w[N].skinning=!0;var K=w.length===1?w[0]:w,F;switch(m){case"lines":F=new THREE.LineSegments(d.data,K);break;case"linestrips":F=new THREE.Line(d.data,K);break;case"triangles":case"polylist":C?F=new THREE.SkinnedMesh(d.data,K):F=new THREE.Mesh(d.data,K);break}f.push(F)}return f}function Yt(o){return U.nodes[o]!==void 0}function Je(o){return H(U.nodes[o],rn)}function on(o){var l={name:o.getAttribute("name"),children:[]};tn(o);for(var f=i(o,"node"),m=0;m<f.length;m++)l.children.push(kt(f[m]));U.visualScenes[o.getAttribute("id")]=l}function Qt(o){var l=new THREE.Group;l.name=o.name;for(var f=o.children,m=0;m<f.length;m++){var d=f[m];l.add(Je(d.id))}return l}function ln(o){return U.visualScenes[o]!==void 0}function ei(o){return H(U.visualScenes[o],Qt)}function cn(o){var l=i(o,"instance_visual_scene")[0];return ei(u(l.getAttribute("url")))}function un(){var o=U.clips;if(y(o)===!0){if(y(U.animations)===!1){var l=[];for(var f in U.animations)for(var m=he(f),d=0,w=m.length;d<w;d++)l.push(m[d]);_t.push(new THREE.AnimationClip("default",-1,l))}}else for(var f in o)_t.push(v(f))}if(e.length===0)return{scene:new THREE.Scene};var hn=new DOMParser().parseFromString(e,"application/xml"),pe=i(hn,"COLLADA")[0],fn=pe.getAttribute("version");console.log("THREE.ColladaLoader: File version",fn);var ti=_(i(pe,"asset")[0]),ii=new THREE.TextureLoader(this.manager);ii.setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);var xt;THREE.TGALoader&&(xt=new THREE.TGALoader(this.manager),xt.setPath(this.resourcePath||t));var _t=[],ni={},dn=0,U={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};M(pe,"library_animations","animation",P),M(pe,"library_animation_clips","animation_clip",h),M(pe,"library_controllers","controller",E),M(pe,"library_images","image",B),M(pe,"library_effects","effect",me),M(pe,"library_materials","material",Ti),M(pe,"library_cameras","camera",xi),M(pe,"library_lights","light",Mi),M(pe,"library_geometries","geometry",Di),M(pe,"library_nodes","node",kt),M(pe,"library_visual_scenes","visual_scene",on),M(pe,"library_kinematics_models","kinematics_model",Bi),M(pe,"library_physics_models","physics_model",qi),M(pe,"scene","instance_kinematics_scene",Wi),A(U.animations,ie),A(U.clips,p),A(U.controllers,O),A(U.images,se),A(U.effects,ut),A(U.materials,jt),A(U.cameras,Kt),A(U.lights,Gt),A(U.geometries,Ut),A(U.visualScenes,Qt),un(),Qi();var At=cn(i(pe,"scene")[0]);return ti.upAxis==="Z_UP"&&At.quaternion.setFromEuler(new THREE.Euler(-Math.PI/2,0,0)),At.scale.multiplyScalar(ti.unit),{animations:_t,kinematics:ni,library:U,scene:At}}};THREE.ColladaLoader=Kn;AFRAME.registerComponent("collada-model-legacy",{schema:{type:"asset"},init:function(){this.model=null,this.loader=new THREE.ColladaLoader},update:function(){var e=this,t=this.el,i=this.data,n=this.el.sceneEl.systems.renderer;!i||(this.remove(),this.loader.load(i,function(a){e.model=a.scene,e.model.traverse(function(s){if(s.isMesh){var u=s.material;u.color&&n.applyColorCorrection(u.color),u.map&&n.applyColorCorrection(u.map),u.emissive&&n.applyColorCorrection(u.emissive),u.emissiveMap&&n.applyColorCorrection(u.emissiveMap)}}),t.setObject3D("mesh",e.model),t.emit("model-loaded",{format:"collada",model:e.model})}))},remove:function(){!this.model||this.el.removeObject3D("mesh")}});var Gn=THREE.FBXLoader=function(){var e,t,i;function n(r){this.manager=r!==void 0?r:THREE.DefaultLoadingManager}n.prototype={constructor:n,crossOrigin:"anonymous",load:function(r,c,h,p){var v=this,E=THREE.LoaderUtils.extractUrlBase(r),T=new THREE.FileLoader(this.manager);T.setResponseType("arraybuffer"),T.load(r,function(k){try{var S=v.parse(k,E);c(S)}catch(O){setTimeout(function(){p&&p(O),v.manager.itemError(r)},0)}},h,p)},setCrossOrigin:function(r){return this.crossOrigin=r,this},parse:function(r,c){if(L(r))e=new y().parse(r);else{var h=de(r);if(!M(h))throw new Error("THREE.FBXLoader: Unknown format.");if(A(h)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+A(h));e=new g().parse(h)}var p=new THREE.TextureLoader(this.manager).setPath(c).setCrossOrigin(this.crossOrigin);return new a(p).parse(e)}};function a(r){this.textureLoader=r}a.prototype={constructor:a,parse:function(){t=this.parseConnections();var r=this.parseImages(),c=this.parseTextures(r),h=this.parseMaterials(c),p=this.parseDeformers(),v=new s().parse(p);return this.parseScene(p,v,h),i},parseConnections:function(){var r=new Map;if("Connections"in e){var c=e.Connections.connections;c.forEach(function(h){var p=h[0],v=h[1],E=h[2];r.has(p)||r.set(p,{parents:[],children:[]});var T={ID:v,relationship:E};r.get(p).parents.push(T),r.has(v)||r.set(v,{parents:[],children:[]});var k={ID:p,relationship:E};r.get(v).children.push(k)})}return r},parseImages:function(){var r={},c={};if("Video"in e.Objects){var h=e.Objects.Video;for(var p in h){var v=h[p],E=parseInt(p);if(r[E]=v.RelativeFilename||v.Filename,"Content"in v){var T=v.Content instanceof ArrayBuffer&&v.Content.byteLength>0,k=typeof v.Content=="string"&&v.Content!=="";if(T||k){var S=this.parseImage(h[p]);c[v.RelativeFilename||v.Filename]=S}}}}for(var E in r){var O=r[E];c[O]!==void 0?r[E]=c[O]:r[E]=r[E].split("\\").pop()}return r},parseImage:function(r){var c=r.Content,h=r.RelativeFilename||r.Filename,p=h.slice(h.lastIndexOf(".")+1).toLowerCase(),v;switch(p){case"bmp":v="image/bmp";break;case"jpg":case"jpeg":v="image/jpeg";break;case"png":v="image/png";break;case"tif":v="image/tiff";break;case"tga":if(typeof THREE.TGALoader!="function"){console.warn("FBXLoader: THREE.TGALoader is required to load TGA textures");return}else{THREE.Loader.Handlers.get(".tga")===null&&THREE.Loader.Handlers.add(/\.tga$/i,new THREE.TGALoader),v="image/tga";break}default:console.warn('FBXLoader: Image type "'+p+'" is not supported.');return}if(typeof c=="string")return"data:"+v+";base64,"+c;var E=new Uint8Array(c);return window.URL.createObjectURL(new Blob([E],{type:v}))},parseTextures:function(r){var c=new Map;if("Texture"in e.Objects){var h=e.Objects.Texture;for(var p in h){var v=this.parseTexture(h[p],r);c.set(parseInt(p),v)}}return c},parseTexture:function(r,c){var h=this.loadTexture(r,c);h.ID=r.id,h.name=r.attrName;var p=r.WrapModeU,v=r.WrapModeV,E=p!==void 0?p.value:0,T=v!==void 0?v.value:0;if(h.wrapS=E===0?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,h.wrapT=T===0?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,"Scaling"in r){var k=r.Scaling.value;h.repeat.x=k[0],h.repeat.y=k[1]}return h},loadTexture:function(r,c){var h,p=this.textureLoader.path,v=t.get(r.id).children;v!==void 0&&v.length>0&&c[v[0].ID]!==void 0&&(h=c[v[0].ID],(h.indexOf("blob:")===0||h.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));var E,T=r.FileName.slice(-3).toLowerCase();if(T==="tga"){var k=THREE.Loader.Handlers.get(".tga");k===null?(console.warn("FBXLoader: TGALoader not found, creating empty placeholder texture for",h),E=new THREE.Texture):E=k.load(h)}else T==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating empty placeholder texture for",h),E=new THREE.Texture):E=this.textureLoader.load(h);return this.textureLoader.setPath(p),E},parseMaterials:function(r){var c=new Map;if("Material"in e.Objects){var h=e.Objects.Material;for(var p in h){var v=this.parseMaterial(h[p],r);v!==null&&c.set(parseInt(p),v)}}return c},parseMaterial:function(r,c){var h=r.id,p=r.attrName,v=r.ShadingModel;if(typeof v=="object"&&(v=v.value),!t.has(h))return null;var E=this.parseParameters(r,c,h),T;switch(v.toLowerCase()){case"phong":T=new THREE.MeshPhongMaterial;break;case"lambert":T=new THREE.MeshLambertMaterial;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',v),T=new THREE.MeshPhongMaterial({color:3342591});break}return T.setValues(E),T.name=p,T},parseParameters:function(r,c,h){var p={};r.BumpFactor&&(p.bumpScale=r.BumpFactor.value),r.Diffuse?p.color=new THREE.Color().fromArray(r.Diffuse.value):r.DiffuseColor&&r.DiffuseColor.type==="Color"&&(p.color=new THREE.Color().fromArray(r.DiffuseColor.value)),r.DisplacementFactor&&(p.displacementScale=r.DisplacementFactor.value),r.Emissive?p.emissive=new THREE.Color().fromArray(r.Emissive.value):r.EmissiveColor&&r.EmissiveColor.type==="Color"&&(p.emissive=new THREE.Color().fromArray(r.EmissiveColor.value)),r.EmissiveFactor&&(p.emissiveIntensity=parseFloat(r.EmissiveFactor.value)),r.Opacity&&(p.opacity=parseFloat(r.Opacity.value)),p.opacity<1&&(p.transparent=!0),r.ReflectionFactor&&(p.reflectivity=r.ReflectionFactor.value),r.Shininess&&(p.shininess=r.Shininess.value),r.Specular?p.specular=new THREE.Color().fromArray(r.Specular.value):r.SpecularColor&&r.SpecularColor.type==="Color"&&(p.specular=new THREE.Color().fromArray(r.SpecularColor.value));var v=this;return t.get(h).children.forEach(function(E){var T=E.relationship;switch(T){case"Bump":p.bumpMap=v.getTexture(c,E.ID);break;case"DiffuseColor":p.map=v.getTexture(c,E.ID);break;case"DisplacementColor":p.displacementMap=v.getTexture(c,E.ID);break;case"EmissiveColor":p.emissiveMap=v.getTexture(c,E.ID);break;case"NormalMap":p.normalMap=v.getTexture(c,E.ID);break;case"ReflectionColor":p.envMap=v.getTexture(c,E.ID),p.envMap.mapping=THREE.EquirectangularReflectionMapping;break;case"SpecularColor":p.specularMap=v.getTexture(c,E.ID);break;case"TransparentColor":p.alphaMap=v.getTexture(c,E.ID),p.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",T);break}}),p},getTexture:function(r,c){return"LayeredTexture"in e.Objects&&c in e.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),c=t.get(c).children[0].ID),r.get(c)},parseDeformers:function(){var r={},c={};if("Deformer"in e.Objects){var h=e.Objects.Deformer;for(var p in h){var v=h[p],E=t.get(parseInt(p));if(v.attrType==="Skin"){var T=this.parseSkeleton(E,h);T.ID=p,E.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),T.geometryID=E.parents[0].ID,r[p]=T}else if(v.attrType==="BlendShape"){var k={id:p};k.rawTargets=this.parseMorphTargets(E,h),k.id=p,E.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),c[p]=k}}}return{skeletons:r,morphTargets:c}},parseSkeleton:function(r,c){var h=[];return r.children.forEach(function(p){var v=c[p.ID];if(v.attrType==="Cluster"){var E={ID:p.ID,indices:[],weights:[],transform:new THREE.Matrix4().fromArray(v.Transform.a),transformLink:new THREE.Matrix4().fromArray(v.TransformLink.a),linkMode:v.Mode};"Indexes"in v&&(E.indices=v.Indexes.a,E.weights=v.Weights.a),h.push(E)}}),{rawBones:h,bones:[]}},parseMorphTargets:function(r,c){for(var h=[],p=0;p<r.children.length;p++){if(p===8){console.warn("FBXLoader: maximum of 8 morph targets supported. Ignoring additional targets.");break}var v=r.children[p],E=c[v.ID],T={name:E.attrName,initialWeight:E.DeformPercent,id:E.id,fullWeights:E.FullWeights.a};if(E.attrType!=="BlendShapeChannel")return;var k=t.get(parseInt(v.ID));k.children.forEach(function(S){S.relationship===void 0&&(T.geoID=S.ID)}),h.push(T)}return h},parseScene:function(r,c,h){i=new THREE.Group;var p=this.parseModels(r.skeletons,c,h),v=e.Objects.Model,E=this;p.forEach(function(k){var S=v[k.ID];E.setLookAtProperties(k,S);var O=t.get(k.ID).parents;O.forEach(function(R){var V=p.get(R.ID);V!==void 0&&V.add(k)}),k.parent===null&&i.add(k)}),this.bindSkeleton(r.skeletons,c,p),this.createAmbientLight(),this.setupMorphMaterials();var T=new u().parse();i.children.length===1&&i.children[0].isGroup&&(i.children[0].animations=T,i=i.children[0]),i.animations=T},parseModels:function(r,c,h){var p=new Map,v=e.Objects.Model;for(var E in v){var T=parseInt(E),k=v[E],S=t.get(T),O=this.buildSkeleton(S,r,T,k.attrName);if(!O){switch(k.attrType){case"Camera":O=this.createCamera(S);break;case"Light":O=this.createLight(S);break;case"Mesh":O=this.createMesh(S,c,h);break;case"NurbsCurve":O=this.createCurve(S,c);break;case"LimbNode":case"Null":default:O=new THREE.Group;break}O.name=THREE.PropertyBinding.sanitizeNodeName(k.attrName),O.ID=T}this.setModelTransforms(O,k),p.set(T,O)}return p},buildSkeleton:function(r,c,h,p){var v=null;return r.parents.forEach(function(E){for(var T in c){var k=c[T];k.rawBones.forEach(function(S,O){if(S.ID===E.ID){var R=v;v=new THREE.Bone,v.matrixWorld.copy(S.transformLink),v.name=THREE.PropertyBinding.sanitizeNodeName(p),v.ID=h,k.bones[O]=v,R!==null&&v.add(R)}})}}),v},createCamera:function(r){var c,h;if(r.children.forEach(function(V){var B=e.Objects.NodeAttribute[V.ID];B!==void 0&&(h=B)}),h===void 0)c=new THREE.Object3D;else{var p=0;h.CameraProjectionType!==void 0&&h.CameraProjectionType.value===1&&(p=1);var v=1;h.NearPlane!==void 0&&(v=h.NearPlane.value/1e3);var E=1e3;h.FarPlane!==void 0&&(E=h.FarPlane.value/1e3);var T=window.innerWidth,k=window.innerHeight;h.AspectWidth!==void 0&&h.AspectHeight!==void 0&&(T=h.AspectWidth.value,k=h.AspectHeight.value);var S=T/k,O=45;h.FieldOfView!==void 0&&(O=h.FieldOfView.value);var R=h.FocalLength?h.FocalLength.value:null;switch(p){case 0:c=new THREE.PerspectiveCamera(O,S,v,E),R!==null&&c.setFocalLength(R);break;case 1:c=new THREE.OrthographicCamera(-T/2,T/2,k/2,-k/2,v,E);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+p+"."),c=new THREE.Object3D;break}}return c},createLight:function(r){var c,h;if(r.children.forEach(function(R){var V=e.Objects.NodeAttribute[R.ID];V!==void 0&&(h=V)}),h===void 0)c=new THREE.Object3D;else{var p;h.LightType===void 0?p=0:p=h.LightType.value;var v=16777215;h.Color!==void 0&&(v=new THREE.Color().fromArray(h.Color.value));var E=h.Intensity===void 0?1:h.Intensity.value/100;h.CastLightOnObject!==void 0&&h.CastLightOnObject.value===0&&(E=0);var T=0;h.FarAttenuationEnd!==void 0&&(h.EnableFarAttenuation!==void 0&&h.EnableFarAttenuation.value===0?T=0:T=h.FarAttenuationEnd.value);var k=1;switch(p){case 0:c=new THREE.PointLight(v,E,T,k);break;case 1:c=new THREE.DirectionalLight(v,E);break;case 2:var S=Math.PI/3;h.InnerAngle!==void 0&&(S=THREE.Math.degToRad(h.InnerAngle.value));var O=0;h.OuterAngle!==void 0&&(O=THREE.Math.degToRad(h.OuterAngle.value),O=Math.max(O,1)),c=new THREE.SpotLight(v,E,T,S,O,k);break;default:console.warn("THREE.FBXLoader: Unknown light type "+h.LightType.value+", defaulting to a THREE.PointLight."),c=new THREE.PointLight(v,E);break}h.CastShadows!==void 0&&h.CastShadows.value===1&&(c.castShadow=!0)}return c},createMesh:function(r,c,h){var p,v=null,E=null,T=[];return r.children.forEach(function(k){c.has(k.ID)&&(v=c.get(k.ID)),h.has(k.ID)&&T.push(h.get(k.ID))}),T.length>1?E=T:T.length>0?E=T[0]:(E=new THREE.MeshPhongMaterial({color:13421772}),T.push(E)),"color"in v.attributes&&T.forEach(function(k){k.vertexColors=THREE.VertexColors}),v.FBX_Deformer?(T.forEach(function(k){k.skinning=!0}),p=new THREE.SkinnedMesh(v,E)):p=new THREE.Mesh(v,E),p},createCurve:function(r,c){var h=r.children.reduce(function(v,E){return c.has(E.ID)&&(v=c.get(E.ID)),v},null),p=new THREE.LineBasicMaterial({color:3342591,linewidth:1});return new THREE.Line(h,p)},setModelTransforms:function(r,c){var h={};"RotationOrder"in c&&(h.eulerOrder=parseInt(c.RotationOrder.value)),"Lcl_Translation"in c&&(h.translation=c.Lcl_Translation.value),"RotationOffset"in c&&(h.rotationOffset=c.RotationOffset.value),"Lcl_Rotation"in c&&(h.rotation=c.Lcl_Rotation.value),"PreRotation"in c&&(h.preRotation=c.PreRotation.value),"PostRotation"in c&&(h.postRotation=c.PostRotation.value),"Lcl_Scaling"in c&&(h.scale=c.Lcl_Scaling.value);var p=J(h);r.applyMatrix(p)},setLookAtProperties:function(r,c){if("LookAtProperty"in c){var h=t.get(r.ID).children;h.forEach(function(p){if(p.relationship==="LookAtProperty"){var v=e.Objects.Model[p.ID];if("Lcl_Translation"in v){var E=v.Lcl_Translation.value;r.target!==void 0?(r.target.position.fromArray(E),i.add(r.target)):r.lookAt(new THREE.Vector3().fromArray(E))}}})}},bindSkeleton:function(r,c,h){var p=this.parsePoseNodes();for(var v in r){var E=r[v],T=t.get(parseInt(E.ID)).parents;T.forEach(function(k){if(c.has(k.ID)){var S=k.ID,O=t.get(S);O.parents.forEach(function(R){if(h.has(R.ID)){var V=h.get(R.ID);V.bind(new THREE.Skeleton(E.bones),p[R.ID])}})}})}},parsePoseNodes:function(){var r={};if("Pose"in e.Objects){var c=e.Objects.Pose;for(var h in c)if(c[h].attrType==="BindPose"){var p=c[h].PoseNode;Array.isArray(p)?p.forEach(function(v){r[v.Node]=new THREE.Matrix4().fromArray(v.Matrix.a)}):r[p.Node]=new THREE.Matrix4().fromArray(p.Matrix.a)}}return r},createAmbientLight:function(){if("GlobalSettings"in e&&"AmbientColor"in e.GlobalSettings){var r=e.GlobalSettings.AmbientColor.value,c=r[0],h=r[1],p=r[2];if(c!==0||h!==0||p!==0){var v=new THREE.Color(c,h,p);i.add(new THREE.AmbientLight(v,1))}}},setupMorphMaterials:function(){i.traverse(function(r){if(r.isMesh&&(r.geometry.morphAttributes.position||r.geometry.morphAttributes.normal)){var c=r.uuid,h=r.material.uuid,p=!1;i.traverse(function(v){v.isMesh&&v.material.uuid===h&&v.uuid!==c&&(p=!0)}),p===!0&&(r.material=r.material.clone()),r.material.morphTargets=!0}})}};function s(){}s.prototype={constructor:s,parse:function(r){var c=new Map;if("Geometry"in e.Objects){var h=e.Objects.Geometry;for(var p in h){var v=t.get(parseInt(p)),E=this.parseGeometry(v,h[p],r);c.set(parseInt(p),E)}}return c},parseGeometry:function(r,c,h){switch(c.attrType){case"Mesh":return this.parseMeshGeometry(r,c,h);case"NurbsCurve":return this.parseNurbsGeometry(c)}},parseMeshGeometry:function(r,c,h){var p=h.skeletons,v=h.morphTargets,E=r.parents.map(function(V){return e.Objects.Model[V.ID]});if(E.length!==0){var T=r.children.reduce(function(V,B){return p[B.ID]!==void 0&&(V=p[B.ID]),V},null),k=r.children.reduce(function(V,B){return v[B.ID]!==void 0&&(V=v[B.ID]),V},null),S=E[0],O={};"RotationOrder"in S&&(O.eulerOrder=S.RotationOrder.value),"GeometricTranslation"in S&&(O.translation=S.GeometricTranslation.value),"GeometricRotation"in S&&(O.rotation=S.GeometricRotation.value),"GeometricScaling"in S&&(O.scale=S.GeometricScaling.value);var R=J(O);return this.genGeometry(c,T,k,R)}},genGeometry:function(r,c,h,p){var v=new THREE.BufferGeometry;r.attrName&&(v.name=r.attrName);var E=this.parseGeoNode(r,c),T=this.genBuffers(E),k=new THREE.Float32BufferAttribute(T.vertex,3);if(p.applyToBufferAttribute(k),v.addAttribute("position",k),T.colors.length>0&&v.addAttribute("color",new THREE.Float32BufferAttribute(T.colors,3)),c&&(v.addAttribute("skinIndex",new THREE.Uint16BufferAttribute(T.weightsIndices,4)),v.addAttribute("skinWeight",new THREE.Float32BufferAttribute(T.vertexWeights,4)),v.FBX_Deformer=c),T.normal.length>0){var S=new THREE.Float32BufferAttribute(T.normal,3),O=new THREE.Matrix3().getNormalMatrix(p);O.applyToBufferAttribute(S),v.addAttribute("normal",S)}if(T.uvs.forEach(function(be,me){var ke="uv"+(me+1).toString();me===0&&(ke="uv"),v.addAttribute(ke,new THREE.Float32BufferAttribute(T.uvs[me],2))}),E.material&&E.material.mappingType!=="AllSame"){var R=T.materialIndex[0],V=0;if(T.materialIndex.forEach(function(be,me){be!==R&&(v.addGroup(V,me-V,R),R=be,V=me)}),v.groups.length>0){var B=v.groups[v.groups.length-1],se=B.start+B.count;se!==T.materialIndex.length&&v.addGroup(se,T.materialIndex.length-se,R)}v.groups.length===0&&v.addGroup(0,T.materialIndex.length,T.materialIndex[0])}return this.addMorphTargets(v,r,h,p),v},parseGeoNode:function(r,c){var h={};if(h.vertexPositions=r.Vertices!==void 0?r.Vertices.a:[],h.vertexIndices=r.PolygonVertexIndex!==void 0?r.PolygonVertexIndex.a:[],r.LayerElementColor&&(h.color=this.parseVertexColors(r.LayerElementColor[0])),r.LayerElementMaterial&&(h.material=this.parseMaterialIndices(r.LayerElementMaterial[0])),r.LayerElementNormal&&(h.normal=this.parseNormals(r.LayerElementNormal[0])),r.LayerElementUV){h.uv=[];for(var p=0;r.LayerElementUV[p];)h.uv.push(this.parseUVs(r.LayerElementUV[p])),p++}return h.weightTable={},c!==null&&(h.skeleton=c,c.rawBones.forEach(function(v,E){v.indices.forEach(function(T,k){h.weightTable[T]===void 0&&(h.weightTable[T]=[]),h.weightTable[T].push({id:E,weight:v.weights[k]})})})),h},genBuffers:function(r){var c={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]},h=0,p=0,v=!1,E=[],T=[],k=[],S=[],O=[],R=[],V=this;return r.vertexIndices.forEach(function(B,se){var be=!1;B<0&&(B=B^-1,be=!0);var me=[],ke=[];if(E.push(B*3,B*3+1,B*3+2),r.color){var De=$(se,h,B,r.color);k.push(De[0],De[1],De[2])}if(r.skeleton){if(r.weightTable[B]!==void 0&&r.weightTable[B].forEach(function(Ie){ke.push(Ie.weight),me.push(Ie.id)}),ke.length>4){v||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),v=!0);var et=[0,0,0,0],ot=[0,0,0,0];ke.forEach(function(Ie,je){var Ke=Ie,lt=me[je];ot.forEach(function(ct,tt,ut){if(Ke>ct){ut[tt]=Ke,Ke=ct;var Tt=et[tt];et[tt]=lt,lt=Tt}})}),me=et,ke=ot}for(;ke.length<4;)ke.push(0),me.push(0);for(var Fe=0;Fe<4;++Fe)O.push(ke[Fe]),R.push(me[Fe])}if(r.normal){var De=$(se,h,B,r.normal);T.push(De[0],De[1],De[2])}if(r.material&&r.material.mappingType!=="AllSame")var bt=$(se,h,B,r.material)[0];r.uv&&r.uv.forEach(function(Ie,je){var Ke=$(se,h,B,Ie);S[je]===void 0&&(S[je]=[]),S[je].push(Ke[0]),S[je].push(Ke[1])}),p++,be&&(V.genFace(c,r,E,bt,T,k,S,O,R,p),h++,p=0,E=[],T=[],k=[],S=[],O=[],R=[])}),c},genFace:function(r,c,h,p,v,E,T,k,S,O){for(var R=2;R<O;R++)r.vertex.push(c.vertexPositions[h[0]]),r.vertex.push(c.vertexPositions[h[1]]),r.vertex.push(c.vertexPositions[h[2]]),r.vertex.push(c.vertexPositions[h[(R-1)*3]]),r.vertex.push(c.vertexPositions[h[(R-1)*3+1]]),r.vertex.push(c.vertexPositions[h[(R-1)*3+2]]),r.vertex.push(c.vertexPositions[h[R*3]]),r.vertex.push(c.vertexPositions[h[R*3+1]]),r.vertex.push(c.vertexPositions[h[R*3+2]]),c.skeleton&&(r.vertexWeights.push(k[0]),r.vertexWeights.push(k[1]),r.vertexWeights.push(k[2]),r.vertexWeights.push(k[3]),r.vertexWeights.push(k[(R-1)*4]),r.vertexWeights.push(k[(R-1)*4+1]),r.vertexWeights.push(k[(R-1)*4+2]),r.vertexWeights.push(k[(R-1)*4+3]),r.vertexWeights.push(k[R*4]),r.vertexWeights.push(k[R*4+1]),r.vertexWeights.push(k[R*4+2]),r.vertexWeights.push(k[R*4+3]),r.weightsIndices.push(S[0]),r.weightsIndices.push(S[1]),r.weightsIndices.push(S[2]),r.weightsIndices.push(S[3]),r.weightsIndices.push(S[(R-1)*4]),r.weightsIndices.push(S[(R-1)*4+1]),r.weightsIndices.push(S[(R-1)*4+2]),r.weightsIndices.push(S[(R-1)*4+3]),r.weightsIndices.push(S[R*4]),r.weightsIndices.push(S[R*4+1]),r.weightsIndices.push(S[R*4+2]),r.weightsIndices.push(S[R*4+3])),c.color&&(r.colors.push(E[0]),r.colors.push(E[1]),r.colors.push(E[2]),r.colors.push(E[(R-1)*3]),r.colors.push(E[(R-1)*3+1]),r.colors.push(E[(R-1)*3+2]),r.colors.push(E[R*3]),r.colors.push(E[R*3+1]),r.colors.push(E[R*3+2])),c.material&&c.material.mappingType!=="AllSame"&&(r.materialIndex.push(p),r.materialIndex.push(p),r.materialIndex.push(p)),c.normal&&(r.normal.push(v[0]),r.normal.push(v[1]),r.normal.push(v[2]),r.normal.push(v[(R-1)*3]),r.normal.push(v[(R-1)*3+1]),r.normal.push(v[(R-1)*3+2]),r.normal.push(v[R*3]),r.normal.push(v[R*3+1]),r.normal.push(v[R*3+2])),c.uv&&c.uv.forEach(function(V,B){r.uvs[B]===void 0&&(r.uvs[B]=[]),r.uvs[B].push(T[B][0]),r.uvs[B].push(T[B][1]),r.uvs[B].push(T[B][(R-1)*2]),r.uvs[B].push(T[B][(R-1)*2+1]),r.uvs[B].push(T[B][R*2]),r.uvs[B].push(T[B][R*2+1])})},addMorphTargets:function(r,c,h,p){if(h!==null){r.morphAttributes.position=[],r.morphAttributes.normal=[];var v=this;h.rawTargets.forEach(function(E){var T=e.Objects.Geometry[E.geoID];T!==void 0&&v.genMorphGeometry(r,c,T,p)})}},genMorphGeometry:function(r,c,h,p){var v=new THREE.BufferGeometry;h.attrName&&(v.name=h.attrName);for(var E=c.PolygonVertexIndex!==void 0?c.PolygonVertexIndex.a:[],T=c.Vertices!==void 0?c.Vertices.a.slice():[],k=h.Vertices!==void 0?h.Vertices.a:[],S=h.Indexes!==void 0?h.Indexes.a:[],O=0;O<S.length;O++){var R=S[O]*3;T[R]+=k[O*3],T[R+1]+=k[O*3+1],T[R+2]+=k[O*3+2]}var V={vertexIndices:E,vertexPositions:T},B=this.genBuffers(V),se=new THREE.Float32BufferAttribute(B.vertex,3);se.name=h.attrName,p.applyToBufferAttribute(se),r.morphAttributes.position.push(se)},parseNormals:function(r){var c=r.MappingInformationType,h=r.ReferenceInformationType,p=r.Normals.a,v=[];return h==="IndexToDirect"&&("NormalIndex"in r?v=r.NormalIndex.a:"NormalsIndex"in r&&(v=r.NormalsIndex.a)),{dataSize:3,buffer:p,indices:v,mappingType:c,referenceType:h}},parseUVs:function(r){var c=r.MappingInformationType,h=r.ReferenceInformationType,p=r.UV.a,v=[];return h==="IndexToDirect"&&(v=r.UVIndex.a),{dataSize:2,buffer:p,indices:v,mappingType:c,referenceType:h}},parseVertexColors:function(r){var c=r.MappingInformationType,h=r.ReferenceInformationType,p=r.Colors.a,v=[];return h==="IndexToDirect"&&(v=r.ColorIndex.a),{dataSize:4,buffer:p,indices:v,mappingType:c,referenceType:h}},parseMaterialIndices:function(r){var c=r.MappingInformationType,h=r.ReferenceInformationType;if(c==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:h};for(var p=r.Materials.a,v=[],E=0;E<p.length;++E)v.push(E);return{dataSize:1,buffer:p,indices:v,mappingType:c,referenceType:h}},parseNurbsGeometry:function(r){if(THREE.NURBSCurve===void 0)return console.error("THREE.FBXLoader: The loader relies on THREE.NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new THREE.BufferGeometry;var c=parseInt(r.Order);if(isNaN(c))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",r.Order,r.id),new THREE.BufferGeometry;for(var h=c-1,p=r.KnotVector.a,v=[],E=r.Points.a,T=0,k=E.length;T<k;T+=4)v.push(new THREE.Vector4().fromArray(E,T));var S,O;if(r.Form==="Closed")v.push(v[0]);else if(r.Form==="Periodic"){S=h,O=p.length-1-S;for(var T=0;T<h;++T)v.push(v[T])}var R=new THREE.NURBSCurve(h,p,v,S,O),V=R.getPoints(v.length*7),B=new Float32Array(V.length*3);V.forEach(function(be,me){be.toArray(B,me*3)});var se=new THREE.BufferGeometry;return se.addAttribute("position",new THREE.BufferAttribute(B,3)),se}};function u(){}u.prototype={constructor:u,parse:function(){var r=[],c=this.parseClips();if(c===void 0)return r;for(var h in c){var p=c[h],v=this.addClip(p);r.push(v)}return r},parseClips:function(){if(e.Objects.AnimationCurve!==void 0){var r=this.parseAnimationCurveNodes();this.parseAnimationCurves(r);var c=this.parseAnimationLayers(r),h=this.parseAnimStacks(c);return h}},parseAnimationCurveNodes:function(){var r=e.Objects.AnimationCurveNode,c=new Map;for(var h in r){var p=r[h];if(p.attrName.match(/S|R|T|DeformPercent/)!==null){var v={id:p.id,attr:p.attrName,curves:{}};c.set(v.id,v)}}return c},parseAnimationCurves:function(r){var c=e.Objects.AnimationCurve;for(var h in c){var p={id:c[h].id,times:c[h].KeyTime.a.map(H),values:c[h].KeyValueFloat.a},v=t.get(p.id);if(v!==void 0){var E=v.parents[0].ID,T=v.parents[0].relationship;T.match(/X/)?r.get(E).curves.x=p:T.match(/Y/)?r.get(E).curves.y=p:T.match(/Z/)?r.get(E).curves.z=p:T.match(/d|DeformPercent/)&&r.has(E)&&(r.get(E).curves.morph=p)}}},parseAnimationLayers:function(r){var c=e.Objects.AnimationLayer,h=new Map;for(var p in c){var v=[],E=t.get(parseInt(p));if(E!==void 0){var T=E.children,k=this;T.forEach(function(S,O){if(r.has(S.ID)){var R=r.get(S.ID);if(R.curves.x!==void 0||R.curves.y!==void 0||R.curves.z!==void 0){if(v[O]===void 0){var V;t.get(S.ID).parents.forEach(function(De){De.relationship!==void 0&&(V=De.ID)});var B=e.Objects.Model[V.toString()],se={modelName:THREE.PropertyBinding.sanitizeNodeName(B.attrName),initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1],transform:k.getModelAnimTransform(B)};"PreRotation"in B&&(se.preRotations=B.PreRotation.value),"PostRotation"in B&&(se.postRotations=B.PostRotation.value),v[O]=se}v[O][R.attr]=R}else if(R.curves.morph!==void 0){if(v[O]===void 0){var be;t.get(S.ID).parents.forEach(function(Fe){Fe.relationship!==void 0&&(be=Fe.ID)});var me=t.get(be).parents[0].ID,ke=t.get(me).parents[0].ID,V=t.get(ke).parents[0].ID,B=e.Objects.Model[V],se={modelName:THREE.PropertyBinding.sanitizeNodeName(B.attrName),morphName:e.Objects.Deformer[be].attrName};v[O]=se}v[O][R.attr]=R}}}),h.set(parseInt(p),v)}}return h},getModelAnimTransform:function(r){var c={};return"RotationOrder"in r&&(c.eulerOrder=parseInt(r.RotationOrder.value)),"Lcl_Translation"in r&&(c.translation=r.Lcl_Translation.value),"RotationOffset"in r&&(c.rotationOffset=r.RotationOffset.value),"Lcl_Rotation"in r&&(c.rotation=r.Lcl_Rotation.value),"PreRotation"in r&&(c.preRotation=r.PreRotation.value),"PostRotation"in r&&(c.postRotation=r.PostRotation.value),"Lcl_Scaling"in r&&(c.scale=r.Lcl_Scaling.value),J(c)},parseAnimStacks:function(r){var c=e.Objects.AnimationStack,h={};for(var p in c){var v=t.get(parseInt(p)).children;v.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");var E=r.get(v[0].ID);h[p]={name:c[p].attrName,layer:E}}return h},addClip:function(r){var c=[],h=this;return r.layer.forEach(function(p){c=c.concat(h.generateTracks(p))}),new THREE.AnimationClip(r.name,-1,c)},generateTracks:function(r){var c=[],h=new THREE.Vector3,p=new THREE.Quaternion,v=new THREE.Vector3;if(r.transform&&r.transform.decompose(h,p,v),h=h.toArray(),p=new THREE.Euler().setFromQuaternion(p).toArray(),v=v.toArray(),r.T!==void 0&&Object.keys(r.T.curves).length>0){var E=this.generateVectorTrack(r.modelName,r.T.curves,h,"position");E!==void 0&&c.push(E)}if(r.R!==void 0&&Object.keys(r.R.curves).length>0){var T=this.generateRotationTrack(r.modelName,r.R.curves,p,r.preRotations,r.postRotations);T!==void 0&&c.push(T)}if(r.S!==void 0&&Object.keys(r.S.curves).length>0){var k=this.generateVectorTrack(r.modelName,r.S.curves,v,"scale");k!==void 0&&c.push(k)}if(r.DeformPercent!==void 0){var S=this.generateMorphTrack(r);S!==void 0&&c.push(S)}return c},generateVectorTrack:function(r,c,h,p){var v=this.getTimesForAllAxes(c),E=this.getKeyframeTrackValues(v,c,h);return new THREE.VectorKeyframeTrack(r+"."+p,v,E)},generateRotationTrack:function(r,c,h,p,v){c.x!==void 0&&(this.interpolateRotations(c.x),c.x.values=c.x.values.map(THREE.Math.degToRad)),c.y!==void 0&&(this.interpolateRotations(c.y),c.y.values=c.y.values.map(THREE.Math.degToRad)),c.z!==void 0&&(this.interpolateRotations(c.z),c.z.values=c.z.values.map(THREE.Math.degToRad));var E=this.getTimesForAllAxes(c),T=this.getKeyframeTrackValues(E,c,h);p!==void 0&&(p=p.map(THREE.Math.degToRad),p.push("ZYX"),p=new THREE.Euler().fromArray(p),p=new THREE.Quaternion().setFromEuler(p)),v!==void 0&&(v=v.map(THREE.Math.degToRad),v.push("ZYX"),v=new THREE.Euler().fromArray(v),v=new THREE.Quaternion().setFromEuler(v).inverse());for(var k=new THREE.Quaternion,S=new THREE.Euler,O=[],R=0;R<T.length;R+=3)S.set(T[R],T[R+1],T[R+2],"ZYX"),k.setFromEuler(S),p!==void 0&&k.premultiply(p),v!==void 0&&k.multiply(v),k.toArray(O,R/3*4);return new THREE.QuaternionKeyframeTrack(r+".quaternion",E,O)},generateMorphTrack:function(r){var c=r.DeformPercent.curves.morph,h=c.values.map(function(v){return v/100}),p=i.getObjectByName(r.modelName).morphTargetDictionary[r.morphName];return new THREE.NumberKeyframeTrack(r.modelName+".morphTargetInfluences["+p+"]",c.times,h)},getTimesForAllAxes:function(r){var c=[];return r.x!==void 0&&(c=c.concat(r.x.times)),r.y!==void 0&&(c=c.concat(r.y.times)),r.z!==void 0&&(c=c.concat(r.z.times)),c=c.sort(function(h,p){return h-p}).filter(function(h,p,v){return v.indexOf(h)==p}),c},getKeyframeTrackValues:function(r,c,h){var p=h,v=[],E=-1,T=-1,k=-1;return r.forEach(function(S){if(c.x&&(E=c.x.times.indexOf(S)),c.y&&(T=c.y.times.indexOf(S)),c.z&&(k=c.z.times.indexOf(S)),E!==-1){var O=c.x.values[E];v.push(O),p[0]=O}else v.push(p[0]);if(T!==-1){var R=c.y.values[T];v.push(R),p[1]=R}else v.push(p[1]);if(k!==-1){var V=c.z.values[k];v.push(V),p[2]=V}else v.push(p[2])}),v},interpolateRotations:function(r){for(var c=1;c<r.values.length;c++){var h=r.values[c-1],p=r.values[c]-h,v=Math.abs(p);if(v>=180){for(var E=v/180,T=p/E,k=h+T,S=r.times[c-1],O=r.times[c]-S,R=O/E,V=S+R,B=[],se=[];V<r.times[c];)B.push(V),V+=R,se.push(k),k+=T;r.times=st(r.times,c,B),r.values=st(r.values,c,se)}}}};function g(){}g.prototype={constructor:g,getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(r){this.nodeStack.push(r),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(r,c){this.currentProp=r,this.currentPropName=c},parse:function(r){this.currentIndent=0,console.log("FBXTree: ",b),this.allNodes=new b,this.nodeStack=[],this.currentProp=[],this.currentPropName="";var c=this,h=r.split(/[\r\n]+/);return h.forEach(function(p,v){var E=p.match(/^[\s\t]*;/),T=p.match(/^[\s\t]*$/);if(!(E||T)){var k=p.match("^\\t{"+c.currentIndent+"}(\\w+):(.*){",""),S=p.match("^\\t{"+c.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),O=p.match("^\\t{"+(c.currentIndent-1)+"}}");k?c.parseNodeBegin(p,k):S?c.parseNodeProperty(p,S,h[++v]):O?c.popStack():p.match(/^[^\s\t}]/)&&c.parseNodePropertyContinued(p)}}),this.allNodes},parseNodeBegin:function(r,c){var h=c[1].trim().replace(/^"/,"").replace(/"$/,""),p=c[2].split(",").map(function(k){return k.trim().replace(/^"/,"").replace(/"$/,"")}),v={name:h},E=this.parseNodeAttr(p),T=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(h,v):h in T?(h==="PoseNode"?T.PoseNode.push(v):T[h].id!==void 0&&(T[h]={},T[h][T[h].id]=T[h]),E.id!==""&&(T[h][E.id]=v)):typeof E.id=="number"?(T[h]={},T[h][E.id]=v):h!=="Properties70"&&(h==="PoseNode"?T[h]=[v]:T[h]=v),typeof E.id=="number"&&(v.id=E.id),E.name!==""&&(v.attrName=E.name),E.type!==""&&(v.attrType=E.type),this.pushStack(v)},parseNodeAttr:function(r){var c=r[0];r[0]!==""&&(c=parseInt(r[0]),isNaN(c)&&(c=r[0]));var h="",p="";return r.length>1&&(h=r[1].replace(/^(\w+)::/,""),p=r[2]),{id:c,name:h,type:p}},parseNodeProperty:function(r,c,h){var p=c[1].replace(/^"/,"").replace(/"$/,"").trim(),v=c[2].replace(/^"/,"").replace(/"$/,"").trim();p==="Content"&&v===","&&(v=h.replace(/"/g,"").replace(/,$/,"").trim());var E=this.getCurrentNode(),T=E.name;if(T==="Properties70"){this.parseNodeSpecialProperty(r,p,v);return}if(p==="C"){var k=v.split(",").slice(1),S=parseInt(k[0]),O=parseInt(k[1]),R=v.split(",").slice(3);R=R.map(function(V){return V.trim().replace(/^"/,"")}),p="connections",v=[S,O],yt(v,R),E[p]===void 0&&(E[p]=[])}p==="Node"&&(E.id=v),p in E&&Array.isArray(E[p])?E[p].push(v):p!=="a"?E[p]=v:E.a=v,this.setCurrentProp(E,p),p==="a"&&v.slice(-1)!==","&&(E.a=fe(v))},parseNodePropertyContinued:function(r){var c=this.getCurrentNode();c.a+=r,r.slice(-1)!==","&&(c.a=fe(c.a))},parseNodeSpecialProperty:function(r,c,h){var p=h.split('",').map(function(O){return O.trim().replace(/^\"/,"").replace(/\s/,"_")}),v=p[0],E=p[1],T=p[2],k=p[3],S=p[4];switch(E){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":S=parseFloat(S);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":S=fe(S);break}this.getPrevNode()[v]={type:E,type2:T,flag:k,value:S},this.setCurrentProp(this.getPrevNode(),v)}};function y(){}y.prototype={constructor:y,parse:function(r){var c=new _(r);c.skip(23);var h=c.getUint32();console.log("THREE.FBXLoader: FBX binary version: "+h);for(var p=new b;!this.endOfContent(c);){var v=this.parseNode(c,h);v!==null&&p.add(v.name,v)}return p},endOfContent:function(r){return r.size()%16===0?(r.getOffset()+160+16&-16)>=r.size():r.getOffset()+160+16>=r.size()},parseNode:function(r,c){var h={},p=c>=7500?r.getUint64():r.getUint32(),v=c>=7500?r.getUint64():r.getUint32();c>=7500?r.getUint64():r.getUint32();var E=r.getUint8(),T=r.getString(E);if(p===0)return null;for(var k=[],S=0;S<v;S++)k.push(this.parseProperty(r));var O=k.length>0?k[0]:"",R=k.length>1?k[1]:"",V=k.length>2?k[2]:"";for(h.singleProperty=v===1&&r.getOffset()===p;p>r.getOffset();){var B=this.parseNode(r,c);B!==null&&this.parseSubNode(T,h,B)}return h.propertyList=k,typeof O=="number"&&(h.id=O),R!==""&&(h.attrName=R),V!==""&&(h.attrType=V),T!==""&&(h.name=T),h},parseSubNode:function(r,c,h){if(h.singleProperty===!0){var p=h.propertyList[0];Array.isArray(p)?(c[h.name]=h,h.a=p):c[h.name]=p}else if(r==="Connections"&&h.name==="C"){var v=[];h.propertyList.forEach(function(V,B){B!==0&&v.push(V)}),c.connections===void 0&&(c.connections=[]),c.connections.push(v)}else if(h.name==="Properties70"){var E=Object.keys(h);E.forEach(function(V){c[V]=h[V]})}else if(r==="Properties70"&&h.name==="P"){var T=h.propertyList[0],k=h.propertyList[1],S=h.propertyList[2],O=h.propertyList[3],R;T.indexOf("Lcl ")===0&&(T=T.replace("Lcl ","Lcl_")),k.indexOf("Lcl ")===0&&(k=k.replace("Lcl ","Lcl_")),k==="Color"||k==="ColorRGB"||k==="Vector"||k==="Vector3D"||k.indexOf("Lcl_")===0?R=[h.propertyList[4],h.propertyList[5],h.propertyList[6]]:R=h.propertyList[4],c[T]={type:k,type2:S,flag:O,value:R}}else c[h.name]===void 0?typeof h.id=="number"?(c[h.name]={},c[h.name][h.id]=h):c[h.name]=h:h.name==="PoseNode"?(Array.isArray(c[h.name])||(c[h.name]=[c[h.name]]),c[h.name].push(h)):c[h.name][h.id]===void 0&&(c[h.name][h.id]=h)},parseProperty:function(r){var c=r.getString(1);switch(c){case"C":return r.getBoolean();case"D":return r.getFloat64();case"F":return r.getFloat32();case"I":return r.getInt32();case"L":return r.getInt64();case"R":var h=r.getUint32();return r.getArrayBuffer(h);case"S":var h=r.getUint32();return r.getString(h);case"Y":return r.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":var p=r.getUint32(),v=r.getUint32(),E=r.getUint32();if(v===0)switch(c){case"b":case"c":return r.getBooleanArray(p);case"d":return r.getFloat64Array(p);case"f":return r.getFloat32Array(p);case"i":return r.getInt32Array(p);case"l":return r.getInt64Array(p)}typeof Zlib>"u"&&console.error("THREE.FBXLoader: External library Inflate.min.js required, obtain or import from https://github.com/imaya/zlib.js");var T=new Zlib.Inflate(new Uint8Array(r.getArrayBuffer(E))),k=new _(T.decompress().buffer);switch(c){case"b":case"c":return k.getBooleanArray(p);case"d":return k.getFloat64Array(p);case"f":return k.getFloat32Array(p);case"i":return k.getInt32Array(p);case"l":return k.getInt64Array(p)}default:throw new Error("THREE.FBXLoader: Unknown property type "+c)}}};function _(r,c){this.dv=new DataView(r),this.offset=0,this.littleEndian=c!==void 0?c:!0}_.prototype={constructor:_,getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(r){this.offset+=r},getBoolean:function(){return(this.getUint8()&1)===1},getBooleanArray:function(r){for(var c=[],h=0;h<r;h++)c.push(this.getBoolean());return c},getUint8:function(){var r=this.dv.getUint8(this.offset);return this.offset+=1,r},getInt16:function(){var r=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,r},getInt32:function(){var r=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,r},getInt32Array:function(r){for(var c=[],h=0;h<r;h++)c.push(this.getInt32());return c},getUint32:function(){var r=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,r},getInt64:function(){var r,c;return this.littleEndian?(r=this.getUint32(),c=this.getUint32()):(c=this.getUint32(),r=this.getUint32()),c&2147483648?(c=~c&4294967295,r=~r&4294967295,r===4294967295&&(c=c+1&4294967295),r=r+1&4294967295,-(c*4294967296+r)):c*4294967296+r},getInt64Array:function(r){for(var c=[],h=0;h<r;h++)c.push(this.getInt64());return c},getUint64:function(){var r,c;return this.littleEndian?(r=this.getUint32(),c=this.getUint32()):(c=this.getUint32(),r=this.getUint32()),c*4294967296+r},getFloat32:function(){var r=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,r},getFloat32Array:function(r){for(var c=[],h=0;h<r;h++)c.push(this.getFloat32());return c},getFloat64:function(){var r=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,r},getFloat64Array:function(r){for(var c=[],h=0;h<r;h++)c.push(this.getFloat64());return c},getArrayBuffer:function(r){var c=this.dv.buffer.slice(this.offset,this.offset+r);return this.offset+=r,c},getString:function(r){for(var c=[],h=0;h<r;h++)c[h]=this.getUint8();var p=c.indexOf(0);return p>=0&&(c=c.slice(0,p)),THREE.LoaderUtils.decodeText(new Uint8Array(c))}};function b(){}b.prototype={constructor:b,add:function(r,c){this[r]=c}};function L(r){var c="Kaydara FBX Binary  \0";return r.byteLength>=c.length&&c===de(r,0,c.length)}function M(r){var c=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],h=0;function p(T){var k=r[T-1];return r=r.slice(h+T),h++,k}for(var v=0;v<c.length;++v){var E=p(1);if(E===c[v])return!1}return!0}function A(r){var c=/FBXVersion: (\d+)/,h=r.match(c);if(h){var p=parseInt(h[1]);return p}throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function H(r){return r/46186158e3}var P=[];function $(r,c,h,p){var v;switch(p.mappingType){case"ByPolygonVertex":v=r;break;case"ByPolygon":v=c;break;case"ByVertice":v=h;break;case"AllSame":v=p.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+p.mappingType)}p.referenceType==="IndexToDirect"&&(v=p.indices[v]);var E=v*p.dataSize,T=E+p.dataSize;return Et(P,p.buffer,E,T)}var D=new THREE.Matrix4,ie=new THREE.Euler,he=new THREE.Vector3,Ve=new THREE.Vector3,G=new THREE.Matrix4;function J(r){var c=new THREE.Matrix4;Ve.set(0,0,0),G.identity();var h=r.eulerOrder?X(r.eulerOrder):X(0);if(r.translation&&Ve.fromArray(r.translation),r.rotationOffset&&Ve.add(he.fromArray(r.rotationOffset)),r.rotation){var p=r.rotation.map(THREE.Math.degToRad);p.push(h),G.makeRotationFromEuler(ie.fromArray(p))}if(r.preRotation){var p=r.preRotation.map(THREE.Math.degToRad);p.push(h),D.makeRotationFromEuler(ie.fromArray(p)),G.premultiply(D)}if(r.postRotation){var p=r.postRotation.map(THREE.Math.degToRad);p.push(h),D.makeRotationFromEuler(ie.fromArray(p)),D.getInverse(D),G.multiply(D)}return r.scale&&c.scale(he.fromArray(r.scale)),c.setPosition(Ve),c.multiply(G),c}function X(r){var c=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return r===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),c[0]):c[r]}function fe(r){var c=r.split(",").map(function(h){return parseFloat(h)});return c}function de(r,c,h){return c===void 0&&(c=0),h===void 0&&(h=r.byteLength),THREE.LoaderUtils.decodeText(new Uint8Array(r,c,h))}function yt(r,c){for(var h=0,p=r.length,v=c.length;h<v;h++,p++)r[p]=c[h]}function Et(r,c,h,p){for(var v=h,E=0;v<p;v++,E++)r[E]=c[v];return r}function st(r,c,h){return r.slice(0,c).concat(h).concat(r.slice(c))}return n}();THREE.FBXLoader=Gn;AFRAME.registerComponent("fbx-model",{schema:{src:{type:"asset"},crossorigin:{default:""}},init:function(){this.model=null},update:function(){const e=this.data;if(!e.src)return;this.remove();const t=new THREE.FBXLoader;e.crossorigin&&t.setCrossOrigin(e.crossorigin),t.load(e.src,this.load.bind(this))},load:function(e){this.model=e,this.el.setObject3D("mesh",e),this.el.emit("model-loaded",{format:"fbx",model:e})},remove:function(){this.model&&this.el.removeObject3D("mesh")}});function Un(){return"script_"+Date.now()+"_"+Math.ceil(Math.random()*1e5)}function qn(e,t){var i=document.createElement("script");return i.type="text/javascript",i.async=!0,i.id=t,i.src=e,i}function St(e){const t=document.getElementById(e),i=t.parentNode;try{i&&i.removeChild(t)}catch{}}function $n(e){const t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}function Xn(e,t,i){return new i(function(n,a){const s=t.timeout||5e3,u=Un(),g=qn(e,u),y=setTimeout(function(){a(new Error("Script request to "+e+" timed out")),St(u)},s),_=function(b){clearTimeout(b)};g.addEventListener("load",function(b){n({ok:!0}),_(y),St(u)}),g.addEventListener("error",function(b){a(new Error("Script request to "+e+" failed "+b)),_(y),St(u)}),$n(g)})}function Wn(e){return e=e||{},function(t,i){return i=i||{},Xn(t,i,e.Promise||Promise)}}var Zn=Wn;const Jn=Zn(),Yn="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r86/examples/js/loaders/GLTFLoader.js",Qn=function(){let e;return function(){return e=e||Jn(Yn),e}}();AFRAME.registerComponent("gltf-model-legacy",{schema:{type:"model"},init:function(){this.model=null,this.loader=null,this.loaderPromise=Qn().then(()=>{this.loader=new THREE.GLTFLoader,this.loader.setCrossOrigin("Anonymous")})},update:function(){const e=this,t=this.el,i=this.data;!i||(this.remove(),this.loaderPromise.then(()=>{this.loader.load(i,function(a){e.model=a.scene,e.model.animations=a.animations,t.setObject3D("mesh",e.model),t.emit("model-loaded",{format:"gltf",model:e.model})})}))},remove:function(){!this.model||this.el.removeObject3D("mesh")}});AFRAME.registerComponent("object-model",{schema:{src:{type:"asset"},crossorigin:{default:""}},init:function(){this.model=null},update:function(){let e;const t=this.data;!t.src||(this.remove(),e=new THREE.ObjectLoader,t.crossorigin&&e.setCrossOrigin(t.crossorigin),e.load(t.src,i=>{i.traverse(n=>{n instanceof THREE.SkinnedMesh&&n.material&&(n.material.skinning=!!(n.geometry&&n.geometry.bones||[]).length)}),this.load(i)}))},load:function(e){this.model=e,this.el.setObject3D("mesh",e),this.el.emit("model-loaded",{format:"json",model:e})},remove:function(){this.model&&this.el.removeObject3D("mesh")}});AFRAME.registerComponent("checkpoint",{schema:{offset:{default:{x:0,y:0,z:0},type:"vec3"}},init:function(){this.active=!1,this.targetEl=null,this.fire=this.fire.bind(this),this.offset=new THREE.Vector3},update:function(){this.offset.copy(this.data.offset)},play:function(){this.el.addEventListener("click",this.fire)},pause:function(){this.el.removeEventListener("click",this.fire)},remove:function(){this.pause()},fire:function(){const e=this.el.sceneEl.querySelector("[checkpoint-controls]");if(!e)throw new Error("No `checkpoint-controls` component found.");e.components["checkpoint-controls"].setCheckpoint(this.el)},getOffset:function(){return this.offset.copy(this.data.offset)}});function er(e){return e?Array.isArray(e)?e:e.materials?e.materials:[e]:[]}function nt(e,t,i,n){!e||(t=t||[],e.traverse(a=>{if(!a.isMesh)return;er(a.material).forEach(u=>{u&&!("envMap"in u)||t.length&&t.indexOf(u.name)===-1||(u.envMap=i,u.reflectivity=n,u.needsUpdate=!0)})}))}AFRAME.registerComponent("cube-env-map",{multiple:!0,schema:{path:{default:""},extension:{default:"jpg",oneOf:["jpg","png"]},format:{default:"RGBFormat",oneOf:["RGBFormat","RGBAFormat"]},enableBackground:{default:!1},reflectivity:{default:1,min:0,max:1},materials:{default:[]}},init:function(){const e=this.data;this.texture=new THREE.CubeTextureLoader().load([e.path+"posx."+e.extension,e.path+"negx."+e.extension,e.path+"posy."+e.extension,e.path+"negy."+e.extension,e.path+"posz."+e.extension,e.path+"negz."+e.extension]),this.texture.format=THREE[e.format],this.object3dsetHandler=()=>{const t=this.el.getObject3D("mesh"),i=this.data;nt(t,i.materials,this.texture,i.reflectivity)},this.el.addEventListener("object3dset",this.object3dsetHandler)},update:function(e){const t=this.data,i=this.el.getObject3D("mesh");let n=[],a=[];if(t.materials.length&&(e.materials?(n=t.materials.filter(s=>!e.materials.includes(s)),a=e.materials.filter(s=>!t.materials.includes(s))):n=t.materials),n.length&&nt(i,n,this.texture,t.reflectivity),a.length&&nt(i,a,null,1),e.materials&&t.reflectivity!==e.reflectivity){const s=t.materials.filter(u=>e.materials.includes(u));s.length&&nt(i,s,this.texture,t.reflectivity)}this.data.enableBackground&&!e.enableBackground?this.setBackground(this.texture):!this.data.enableBackground&&e.enableBackground&&this.setBackground(null)},remove:function(){this.el.removeEventListener("object3dset",this.object3dsetHandler);const e=this.el.getObject3D("mesh"),t=this.data;nt(e,t.materials,null,1),t.enableBackground&&this.setBackground(null)},setBackground:function(e){this.el.sceneEl.object3D.background=e}});AFRAME.registerComponent("grab",{init:function(){this.system=this.el.sceneEl.systems.physics,this.GRABBED_STATE="grabbed",this.grabbing=!1,this.hitEl=null,this.physics=this.el.sceneEl.systems.physics,this.constraint=null,this.onHit=this.onHit.bind(this),this.onGripOpen=this.onGripOpen.bind(this),this.onGripClose=this.onGripClose.bind(this)},play:function(){const e=this.el;e.addEventListener("hit",this.onHit),e.addEventListener("gripdown",this.onGripClose),e.addEventListener("gripup",this.onGripOpen),e.addEventListener("trackpaddown",this.onGripClose),e.addEventListener("trackpadup",this.onGripOpen),e.addEventListener("triggerdown",this.onGripClose),e.addEventListener("triggerup",this.onGripOpen)},pause:function(){const e=this.el;e.removeEventListener("hit",this.onHit),e.removeEventListener("gripdown",this.onGripClose),e.removeEventListener("gripup",this.onGripOpen),e.removeEventListener("trackpaddown",this.onGripClose),e.removeEventListener("trackpadup",this.onGripOpen),e.removeEventListener("triggerdown",this.onGripClose),e.removeEventListener("triggerup",this.onGripOpen)},onGripClose:function(){this.grabbing=!0},onGripOpen:function(){const e=this.hitEl;this.grabbing=!1,e&&(e.removeState(this.GRABBED_STATE),this.hitEl=void 0,this.system.removeConstraint(this.constraint),this.constraint=null)},onHit:function(e){const t=e.detail.el;!t||t.is(this.GRABBED_STATE)||!this.grabbing||this.hitEl||(t.addState(this.GRABBED_STATE),this.hitEl=t,this.constraint=new CANNON.LockConstraint(this.el.body,t.body),this.system.addConstraint(this.constraint))}});const tr=-9.8,ir=-15;AFRAME.registerComponent("jump-ability",{dependencies:["velocity"],schema:{on:{default:"keydown:Space gamepadbuttondown:0"},playerHeight:{default:1.764},maxJumps:{default:1},distance:{default:5},debug:{default:!1}},init:function(){this.velocity=0,this.numJumps=0;const e=this.beginJump.bind(this),t=this.data.on.split(" ");this.bindings={};for(let i=0;i<t.length;i++)this.bindings[t[i]]=e,this.el.addEventListener(t[i],e);this.bindings.collide=this.onCollide.bind(this),this.el.addEventListener("collide",this.bindings.collide)},remove:function(){for(var e in this.bindings)this.bindings.hasOwnProperty(e)&&(this.el.removeEventListener(e,this.bindings[e]),delete this.bindings[e]);this.el.removeEventListener("collide",this.bindings.collide),delete this.bindings.collide},beginJump:function(){if(this.numJumps<this.data.maxJumps){const e=this.data,t=Math.sqrt(-2*e.distance*(tr+ir)),i=this.el.getAttribute("velocity");this.el.setAttribute("velocity",{x:i.x,y:t,z:i.z}),this.numJumps++,this.el.emit("jumpstart")}},onCollide:function(){this.numJumps>0&&this.el.emit("jumpend"),this.numJumps=0}});const hi=1e-6;AFRAME.registerComponent("kinematic-body",{dependencies:["velocity"],schema:{mass:{default:5},radius:{default:1.3},linearDamping:{default:.05},enableSlopes:{default:!0},enableJumps:{default:!1}},init:function(){this.system=this.el.sceneEl.systems.physics,this.system.addComponent(this);const e=this.el,t=this.data,i=new CANNON.Vec3().copy(e.object3D.getWorldPosition(new THREE.Vector3));this.body=new CANNON.Body({material:this.system.getMaterial("staticMaterial"),position:i,mass:t.mass,linearDamping:t.linearDamping,fixedRotation:!0}),this.body.addShape(new CANNON.Sphere(t.radius),new CANNON.Vec3(0,t.radius,0)),this.body.el=this.el,this.el.body=this.body,this.system.addBody(this.body),e.hasAttribute("wasd-controls")&&console.warn("[kinematic-body] Not compatible with wasd-controls, use movement-controls.")},remove:function(){this.system.removeBody(this.body),this.system.removeComponent(this),delete this.el.body},beforeStep:function(e,t){if(!t)return;const i=this.el,n=this.data,a=this.body;n.enableJumps||a.velocity.set(0,0,0),a.position.copy(i.getAttribute("position"))},step:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3,n=new THREE.Vector3;return function(a,s){if(!s)return;let u=this.body,g=this.data,y=!1,_,b=-1/0,L,M=this.system.getContacts();s=Math.min(s,this.system.data.maxInterval*1e3),n.set(0,0,0),e.copy(this.el.getAttribute("velocity")),u.velocity.copy(e);for(var A=0,H;H=M[A];A++)if(!!H.enabled){if(u.id===H.bi.id)H.ni.negate(i);else if(u.id===H.bj.id)i.copy(H.ni);else continue;y=u.velocity.dot(i)<-hi,y&&i.y<=.5?e.projectOnPlane(i):i.y>.5&&(_=u.id===H.bi.id?Math.abs(H.rj.y+H.bj.position.y):Math.abs(H.ri.y+H.bi.position.y),_>b&&(b=_,n.copy(i),L=u.id===H.bi.id?H.bj:H.bi))}t.copy(e).normalize(),L&&(!g.enableJumps||t.y<.5)?(g.enableSlopes?n.y<1-hi&&n.copy(this.raycastToGround(L,n)):n.set(0,1,0),e.projectOnPlane(n)):this.system.driver.world&&e.add(this.system.driver.world.gravity.scale(s*4/1e3)),u.velocity.copy(e),this.el.setAttribute("velocity",u.velocity),this.el.setAttribute("position",u.position)}}(),raycastToGround:function(e,t){let i,n,a=this.body.position,s=this.body.position.clone();return i=new CANNON.Ray(a,s),i._updateDirection(),i.intersectBody(e),i.hasHit?(n=i.result.hitNormalWorld,Math.abs(n.y)>Math.abs(t.y)?n:t):t}});AFRAME.registerComponent("mesh-smooth",{init:function(){this.el.addEventListener("model-loaded",e=>{e.detail.model.traverse(t=>{t.isMesh&&t.geometry.computeVertexNormals()})})}});AFRAME.registerComponent("normal-material",{init:function(){this.material=new THREE.MeshNormalMaterial({flatShading:!0}),this.applyMaterial=this.applyMaterial.bind(this),this.el.addEventListener("object3dset",this.applyMaterial)},remove:function(){this.el.removeEventListener("object3dset",this.applyMaterial)},applyMaterial:function(){this.el.object3D.traverse(e=>{e.isMesh&&(e.material=this.material)})}});AFRAME.registerComponent("sphere-collider",{schema:{objects:{default:""},state:{default:"collided"},radius:{default:.05},watch:{default:!0}},init:function(){this.observer=null,this.els=[],this.collisions=[],this.handleHit=this.handleHit.bind(this),this.handleHitEnd=this.handleHitEnd.bind(this)},remove:function(){this.pause()},play:function(){const e=this.el.sceneEl;this.data.watch&&(this.observer=new MutationObserver(this.update.bind(this,null)),this.observer.observe(e,{childList:!0,subtree:!0}))},pause:function(){this.observer&&(this.observer.disconnect(),this.observer=null)},update:function(){const e=this.data;let t;e.objects?t=this.el.sceneEl.querySelectorAll(e.objects):t=this.el.sceneEl.children,this.els=Array.prototype.slice.call(t)},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3,n=new THREE.Vector3,a=new THREE.Box3,s=new Map;return function(){const u=this.el,g=this.data,y=u.getObject3D("mesh"),_=[];let b;if(!y)return;s.clear(),u.object3D.getWorldPosition(e),u.object3D.getWorldScale(i),b=g.radius*M(i),this.els.forEach(L),_.sort((A,H)=>s.get(A)>s.get(H)?1:-1).forEach(this.handleHit),_.length===0&&u.emit("hit",{el:null}),this.collisions.filter(A=>!s.has(A)).forEach(this.handleHitEnd),this.collisions=_;function L(A){let H,P,$,D;!A.isEntity||(P=A.getObject3D("mesh"),P&&(a.setFromObject(P).getSize(n),D=Math.max(n.x,n.y,n.z)/2,H=Math.sqrt(2*D*D),a.getCenter(t),H&&($=e.distanceTo(t),$<H+b&&(_.push(A),s.set(A,$)))))}function M(A){return Math.max.apply(null,A.toArray())}}}(),handleHit:function(e){e.emit("hit"),e.addState(this.data.state),this.el.emit("hit",{el:e})},handleHitEnd:function(e){e.emit("hitend"),e.removeState(this.data.state),this.el.emit("hitend",{el:e})}});AFRAME.registerComponent("nav-mesh",{init:function(){this.system=this.el.sceneEl.systems.nav,this.hasLoadedNavMesh=!1,this.el.addEventListener("object3dset",this.loadNavMesh.bind(this))},play:function(){this.hasLoadedNavMesh||this.loadNavMesh()},loadNavMesh:function(){const e=this.el.getObject3D("mesh"),t=this.el.sceneEl.object3D;if(!e)return;let i;if(e.traverse(a=>{a.isMesh&&(i=a)}),!i)return;const n=i.geometry.isBufferGeometry?new THREE.Geometry().fromBufferGeometry(i.geometry):i.geometry.clone();t.updateMatrixWorld(),n.applyMatrix(i.matrixWorld),this.system.setNavMeshGeometry(n),this.hasLoadedNavMesh=!0}});AFRAME.registerComponent("nav-agent",{schema:{destination:{type:"vec3"},active:{default:!1},speed:{default:2}},init:function(){this.system=this.el.sceneEl.systems.nav,this.system.addAgent(this),this.group=null,this.path=[],this.raycaster=new THREE.Raycaster},remove:function(){this.system.removeAgent(this)},update:function(){this.path.length=0},updateNavLocation:function(){this.group=null,this.path=[]},tick:function(){const e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3;return function(n,a){const s=this.el,u=this.data,g=this.raycaster,y=u.speed*a/1e3;if(!u.active)return;if(!this.path.length){const H=this.el.object3D.position;this.group=this.group||this.system.getGroup(H),this.path=this.system.getPath(H,e.copy(u.destination),this.group)||[],s.emit("navigation-start")}if(!this.path.length){console.warn("[nav] Unable to find path to %o.",u.destination),this.el.setAttribute("nav-agent",{active:!1}),s.emit("navigation-end");return}const _=s.object3D.position,b=this.path[0];t.subVectors(b,_);const L=t.length();let M;if(L<y){if(this.path.shift(),!this.path.length){this.el.setAttribute("nav-agent",{active:!1}),s.emit("navigation-end");return}i.copy(_),M=this.path[0]}else i.copy(t.setLength(y)).add(_),M=b;M.y=_.y,s.object3D.lookAt(M),g.ray.origin.copy(i),g.ray.origin.y+=1.5,g.ray.direction.y=-1;const A=g.intersectObject(this.system.getNavMesh());A.length?(t.subVectors(A[0].point,_),_.add(t.setLength(y))):_.copy(i)}}()});var ne=function(){};ne.computeCentroids=function(e){var t,i,n;for(t=0,i=e.faces.length;t<i;t++)(n=e.faces[t]).centroid=new THREE.Vector3(0,0,0),n.centroid.add(e.vertices[n.a]),n.centroid.add(e.vertices[n.b]),n.centroid.add(e.vertices[n.c]),n.centroid.divideScalar(3)},ne.roundNumber=function(e,t){return Number(e.toFixed(t))},ne.sample=function(e){return e[Math.floor(Math.random()*e.length)]},ne.mergeVertexIds=function(e,t){var i=[];if(e.forEach(function(y){t.indexOf(y)>=0&&i.push(y)}),i.length<2)return[];i.includes(e[0])&&i.includes(e[e.length-1])&&e.push(e.shift()),i.includes(t[0])&&i.includes(t[t.length-1])&&t.push(t.shift()),i=[],e.forEach(function(y){t.includes(y)&&i.push(y)});for(var n=i[1],a=i[0],s=e.slice();s[0]!==n;)s.push(s.shift());for(var u=0,g=t.slice();g[0]!==a;)if(g.push(g.shift()),u++>10)throw new Error("Unexpected state");return g.shift(),g.pop(),s=s.concat(g)},ne.setPolygonCentroid=function(e,t){var i=new THREE.Vector3,n=t.vertices;e.vertexIds.forEach(function(a){i.add(n[a])}),i.divideScalar(e.vertexIds.length),e.centroid.copy(i)},ne.cleanPolygon=function(e,t){for(var i=[],n=t.vertices,a=0;a<e.vertexIds.length;a++){var s,u,g,y=n[e.vertexIds[a]];a===0?(s=e.vertexIds[1],u=e.vertexIds[e.vertexIds.length-1]):a===e.vertexIds.length-1?(s=e.vertexIds[0],u=e.vertexIds[e.vertexIds.length-2]):(s=e.vertexIds[a+1],u=e.vertexIds[a-1]),g=n[u];var _=n[s].clone().sub(y),b=g.clone().sub(y),L=_.angleTo(b);if(L>Math.PI-.01&&L<Math.PI+.01){var M=[];e.neighbours.forEach(function(A){A.vertexIds.includes(e.vertexIds[a])||M.push(A)}),e.neighbours=M}else i.push(e.vertexIds[a])}e.vertexIds=i,this.setPolygonCentroid(e,t)},ne.isConvex=function(e,t){var i=t.vertices;if(e.vertexIds.length<3)return!1;for(var n=!0,a=[],s=0;s<e.vertexIds.length;s++){var u,g,y=i[e.vertexIds[s]];s===0?(u=i[e.vertexIds[1]],g=i[e.vertexIds[e.vertexIds.length-1]]):s===e.vertexIds.length-1?(u=i[e.vertexIds[0]],g=i[e.vertexIds[e.vertexIds.length-2]]):(u=i[e.vertexIds[s+1]],g=i[e.vertexIds[s-1]]);var _=u.clone().sub(y),b=g.clone().sub(y),L=_.angleTo(b);if(L===Math.PI||L===0)return!1;var M=_.cross(b).y;a.push(M)}return a.forEach(function(A){A===0&&(n=!1)}),a.forEach(a[0]>0?function(A){A<0&&(n=!1)}:function(A){A>0&&(n=!1)}),n},ne.distanceToSquared=function(e,t){var i=e.x-t.x,n=e.y-t.y,a=e.z-t.z;return i*i+n*n+a*a},ne.isPointInPoly=function(e,t){for(var i=!1,n=-1,a=e.length,s=a-1;++n<a;s=n)(e[n].z<=t.z&&t.z<e[s].z||e[s].z<=t.z&&t.z<e[n].z)&&t.x<(e[s].x-e[n].x)*(t.z-e[n].z)/(e[s].z-e[n].z)+e[n].x&&(i=!i);return i},ne.isVectorInPolygon=function(e,t,i){var n=1e5,a=-1e5,s=[];return t.vertexIds.forEach(function(u){n=Math.min(i[u].y,n),a=Math.max(i[u].y,a),s.push(i[u])}),!!(e.y<a+.5&&e.y>n-.5&&this.isPointInPoly(s,e))},ne.triarea2=function(e,t,i){return(i.x-e.x)*(t.z-e.z)-(t.x-e.x)*(i.z-e.z)},ne.vequal=function(e,t){return this.distanceToSquared(e,t)<1e-5};var Ue=function(e){this.content=[],this.scoreFunction=e};Ue.prototype.push=function(e){this.content.push(e),this.sinkDown(this.content.length-1)},Ue.prototype.pop=function(){var e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e},Ue.prototype.remove=function(e){var t=this.content.indexOf(e),i=this.content.pop();t!==this.content.length-1&&(this.content[t]=i,this.scoreFunction(i)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))},Ue.prototype.size=function(){return this.content.length},Ue.prototype.rescoreElement=function(e){this.sinkDown(this.content.indexOf(e))},Ue.prototype.sinkDown=function(e){for(var t=this.content[e];e>0;){var i=(e+1>>1)-1,n=this.content[i];if(!(this.scoreFunction(t)<this.scoreFunction(n)))break;this.content[i]=t,this.content[e]=n,e=i}},Ue.prototype.bubbleUp=function(e){for(var t=this.content.length,i=this.content[e],n=this.scoreFunction(i);;){var a=e+1<<1,s=a-1,u=null,g=void 0;if(s<t&&(g=this.scoreFunction(this.content[s]))<n&&(u=s),a<t&&this.scoreFunction(this.content[a])<(u===null?n:g)&&(u=a),u===null)break;this.content[e]=this.content[u],this.content[u]=i,e=u}};var Xe=function(){};Xe.init=function(e){for(var t=0;t<e.length;t++){var i=e[t];i.f=0,i.g=0,i.h=0,i.cost=1,i.visited=!1,i.closed=!1,i.parent=null}},Xe.cleanUp=function(e){for(var t=0;t<e.length;t++){var i=e[t];delete i.f,delete i.g,delete i.h,delete i.cost,delete i.visited,delete i.closed,delete i.parent}},Xe.heap=function(){return new Ue(function(e){return e.f})},Xe.search=function(e,t,i){this.init(e);var n=this.heap();for(n.push(t);n.size()>0;){var a=n.pop();if(a===i){for(var s=a,u=[];s.parent;)u.push(s),s=s.parent;return this.cleanUp(u),u.reverse()}a.closed=!0;for(var g=this.neighbours(e,a),y=0,_=g.length;y<_;y++){var b=g[y];if(!b.closed){var L=a.g+b.cost,M=b.visited;if(!M||L<b.g){if(b.visited=!0,b.parent=a,!b.centroid||!i.centroid)throw new Error("Unexpected state");b.h=b.h||this.heuristic(b.centroid,i.centroid),b.g=L,b.f=b.g+b.h,M?n.rescoreElement(b):n.push(b)}}}}return[]},Xe.heuristic=function(e,t){return ne.distanceToSquared(e,t)},Xe.neighbours=function(e,t){for(var i=[],n=0;n<t.neighbours.length;n++)i.push(e[t.neighbours[n]]);return i};var nr=1,We=function(){};We.buildZone=function(e){var t=this,i=this._buildNavigationMesh(e),n={};i.vertices.forEach(function(u){u.x=ne.roundNumber(u.x,2),u.y=ne.roundNumber(u.y,2),u.z=ne.roundNumber(u.z,2)}),n.vertices=i.vertices;var a=this._buildPolygonGroups(i);n.groups=[];var s=function(u,g){for(var y=0;y<u.length;y++)if(g===u[y])return y};return a.forEach(function(u){var g=[];u.forEach(function(y){var _=y.neighbours.map(function(L){return s(u,L)}),b=y.neighbours.map(function(L){return t._getSharedVerticesInOrder(y,L)});y.centroid.x=ne.roundNumber(y.centroid.x,2),y.centroid.y=ne.roundNumber(y.centroid.y,2),y.centroid.z=ne.roundNumber(y.centroid.z,2),g.push({id:s(u,y),neighbours:_,vertexIds:y.vertexIds,centroid:y.centroid,portals:b})}),n.groups.push(g)}),n},We._buildNavigationMesh=function(e){return ne.computeCentroids(e),e.mergeVertices(),this._buildPolygonsFromGeometry(e)},We._buildPolygonGroups=function(e){var t=[],i=0,n=function(a){a.neighbours.forEach(function(s){s.group===void 0&&(s.group=a.group,n(s))})};return e.polygons.forEach(function(a){a.group===void 0&&(a.group=i++,n(a)),t[a.group]||(t[a.group]=[]),t[a.group].push(a)}),t},We._buildPolygonNeighbours=function(e,t,i){var n=new Set,a=i.get(e.vertexIds[0]),s=i.get(e.vertexIds[1]),u=i.get(e.vertexIds[2]);a.forEach(function(g){(s.has(g)||u.has(g))&&n.add(t.polygons[g])}),s.forEach(function(g){u.has(g)&&n.add(t.polygons[g])}),e.neighbours=Array.from(n)},We._buildPolygonsFromGeometry=function(e){for(var t=this,i=[],n=e.vertices,a=e.faceVertexUvs,s=new Map,u=0;u<n.length;u++)s.set(u,new Set);e.faces.forEach(function(y){i.push({id:nr++,vertexIds:[y.a,y.b,y.c],centroid:y.centroid,normal:y.normal,neighbours:[]}),s.get(y.a).add(i.length-1),s.get(y.b).add(i.length-1),s.get(y.c).add(i.length-1)});var g={polygons:i,vertices:n,faceVertexUvs:a};return i.forEach(function(y){t._buildPolygonNeighbours(y,g,s)}),g},We._getSharedVerticesInOrder=function(e,t){var i=e.vertexIds,n=t.vertexIds,a=new Set;if(i.forEach(function(u){n.includes(u)&&a.add(u)}),a.size<2)return[];a.has(i[0])&&a.has(i[i.length-1])&&i.push(i.shift()),a.has(n[0])&&a.has(n[n.length-1])&&n.push(n.shift());var s=[];return i.forEach(function(u){n.includes(u)&&s.push(u)}),s};var Nt=function(){this.portals=[]};Nt.prototype.push=function(e,t){t===void 0&&(t=e),this.portals.push({left:e,right:t})},Nt.prototype.stringPull=function(){var e,t,i,n=this.portals,a=[],s=0,u=0,g=0;t=n[0].left,i=n[0].right,a.push(e=n[0].left);for(var y=1;y<n.length;y++){var _=n[y].left,b=n[y].right;if(ne.triarea2(e,i,b)<=0){if(!(ne.vequal(e,i)||ne.triarea2(e,t,b)>0)){a.push(t),t=e=t,i=e,u=s=u,g=s,y=s;continue}i=b,g=y}if(ne.triarea2(e,t,_)>=0){if(!(ne.vequal(e,t)||ne.triarea2(e,i,_)<0)){a.push(i),t=e=i,i=e,u=s=g,g=s,y=s;continue}t=_,u=y}}return a.length!==0&&ne.vequal(a[a.length-1],n[n.length-1].left)||a.push(n[n.length-1].left),this.path=a,a};var Lt,Ht,$e,Dt,Ot,dt,qe=function(){this.zones={}};qe.createZone=function(e){return We.buildZone(e)},qe.prototype.setZoneData=function(e,t){this.zones[e]=t},qe.prototype.getGroup=function(e,t){if(!this.zones[e])return null;var i=null,n=Math.pow(50,2);return this.zones[e].groups.forEach(function(a,s){a.forEach(function(u){var g=ne.distanceToSquared(u.centroid,t);g<n&&(i=s,n=g)})}),i},qe.prototype.getRandomNode=function(e,t,i,n){if(!this.zones[e])return new THREE.Vector3;i=i||null,n=n||0;var a=[];return this.zones[e].groups[t].forEach(function(s){i&&n?ne.distanceToSquared(i,s.centroid)<n*n&&a.push(s.centroid):a.push(s.centroid)}),ne.sample(a)||new THREE.Vector3},qe.prototype.getClosestNode=function(e,t,i,n){n===void 0&&(n=!1);var a=this.zones[t].vertices,s=null,u=1/0;return this.zones[t].groups[i].forEach(function(g){var y=ne.distanceToSquared(g.centroid,e);y<u&&(!n||ne.isVectorInPolygon(e,g,a))&&(s=g,u=y)}),s},qe.prototype.findPath=function(e,t,i,n){var a=this.zones[i].groups[n],s=this.zones[i].vertices,u=this.getClosestNode(e,i,n),g=this.getClosestNode(t,i,n,!0);if(!u||!g)return null;var y=Xe.search(a,u,g),_=function(P,$){for(var D=0;D<P.neighbours.length;D++)if(P.neighbours[D]===$.id)return P.portals[D]},b=new Nt;b.push(e);for(var L=0;L<y.length;L++){var M=y[L+1];if(M){var A=_(y[L],M);b.push(s[A[0]],s[A[1]])}}b.push(t),b.stringPull();var H=b.path.map(function(P){return new THREE.Vector3(P.x,P.y,P.z)});return H.shift(),H},qe.prototype.clampStep=($e=new THREE.Vector3,Dt=new THREE.Plane,Ot=new THREE.Triangle,dt=new THREE.Vector3,function(e,t,i,n,a,s){var u=this.zones[n].vertices,g=this.zones[n].groups[a],y=[i],_={};_[i.id]=0,Lt=void 0,dt.set(0,0,0),Ht=1/0,Dt.setFromCoplanarPoints(u[i.vertexIds[0]],u[i.vertexIds[1]],u[i.vertexIds[2]]),Dt.projectPoint(t,$e),t.copy($e);for(var b=y.pop();b;b=y.pop()){Ot.set(u[b.vertexIds[0]],u[b.vertexIds[1]],u[b.vertexIds[2]]),Ot.closestPointToPoint(t,$e),$e.distanceToSquared(t)<Ht&&(Lt=b,dt.copy($e),Ht=$e.distanceToSquared(t));var L=_[b];if(!(L>2))for(var M=0;M<b.neighbours.length;M++){var A=g[b.neighbours[M]];A.id in _||(y.push(A),_[A.id]=L+1)}}return s.copy(dt),Lt});const rr=Object.freeze(Object.defineProperty({__proto__:null,Pathfinding:qe},Symbol.toStringTag,{value:"Module"})),ar=_n(rr),{Pathfinding:Ei}=ar,rt=new Ei,at="level";AFRAME.registerSystem("nav",{init:function(){this.navMesh=null,this.agents=new Set},setNavMeshGeometry:function(e){this.navMesh=new THREE.Mesh(e),rt.setZoneData(at,Ei.createZone(e)),Array.from(this.agents).forEach(t=>t.updateNavLocation())},getNavMesh:function(){return this.navMesh},addAgent:function(e){this.agents.add(e)},removeAgent:function(e){this.agents.delete(e)},getPath:function(e,t,i){return this.navMesh?rt.findPath(e,t,at,i):null},getGroup:function(e){return this.navMesh?rt.getGroup(at,e):null},getNode:function(e,t){return this.navMesh?rt.getClosestNode(e,at,t,!0):null},clampStep:function(e,t,i,n,a){if(this.navMesh){if(!n)return a.copy(t),this.getNode(t,i)}else return a.copy(t),null;return rt.clampStep(e,t,n,at,i,a)}});AFRAME.registerPrimitive("a-grid",{defaultComponents:{geometry:{primitive:"plane",width:75,height:75},rotation:{x:-90,y:0,z:0},material:{src:"url(https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v1.16.3/assets/grid.png)",repeat:"75 75"}},mappings:{width:"geometry.width",height:"geometry.height",src:"material.src"}});var bi={exports:{}},x=bi.exports={VERSION:"0.1.1",PI:Math.PI,TAU:2*Math.PI,DEG_TO_RAD:.0174532925,RAD_TO_DEG:57.2957795,SQRT3:Math.sqrt(3),TILE:"tile",ENT:"entity",STR:"structure",HEX:"hex",SQR:"square",ABS:"abstract"};x.Board=function(e,t){if(!e)throw new Error("You must pass in a grid system for the board to use.");this.tiles=[],this.tileGroup=null,this.group=new THREE.Object3D,this.grid=null,this.overlay=null,this.finder=new x.AStarFinder(t),x.Loader.init(),this.setGrid(e)},x.Board.prototype={setEntityOnTile:function(e,t){var i=this.grid.cellToPixel(t.cell);e.position.copy(i),e.position.y+=e.heightOffset||0,e.tile&&(e.tile.entity=null),e.tile=t,t.entity=e},addTile:function(e){var t=this.tiles.indexOf(e);t===-1&&(this.tiles.push(e),this.snapTileToGrid(e),e.position.y=0,this.tileGroup.add(e.mesh),this.grid.add(e.cell),e.cell.tile=e)},removeTile:function(e){if(e){var t=this.tiles.indexOf(e);this.grid.remove(e.cell),t!==-1&&this.tiles.splice(t,1),e.dispose()}},removeAllTiles:function(){if(this.tileGroup)for(var e=this.tileGroup.children,t=0;t<e.length;t++)this.tileGroup.remove(e[t])},getTileAtCell:function(e){var t=this.grid.cellToHash(e);return e.tile||(typeof this.grid.cells[t]<"u"?this.grid.cells[t].tile:null)},snapToGrid:function(e){var t=this.grid.pixelToCell(e);e.copy(this.grid.cellToPixel(t))},snapTileToGrid:function(e){if(e.cell)e.position.copy(this.grid.cellToPixel(e.cell));else{var t=this.grid.pixelToCell(e.position);e.position.copy(this.grid.cellToPixel(t))}return e},getRandomTile:function(){var e=x.Tools.randomInt(0,this.tiles.length-1);return this.tiles[e]},findPath:function(e,t,i){return this.finder.findPath(e.cell,t.cell,i,this.grid)},setGrid:function(e){this.group.remove(this.tileGroup),this.grid&&e!==this.grid&&(this.removeAllTiles(),this.tiles.forEach(function(t){this.grid.remove(t.cell),t.dispose()}),this.grid.dispose()),this.grid=e,this.tiles=[],this.tileGroup=new THREE.Object3D,this.group.add(this.tileGroup)},generateOverlay:function(e){var t=new THREE.LineBasicMaterial({color:0,opacity:.3});this.overlay&&this.group.remove(this.overlay),this.overlay=new THREE.Object3D,this.grid.generateOverlay(e,this.overlay,t),this.group.add(this.overlay)},generateTilemap:function(e){this.reset();var t=this.grid.generateTiles(e);this.tiles=t,this.tileGroup=new THREE.Object3D;for(var i=0;i<t.length;i++)this.tileGroup.add(t[i].mesh);this.group.add(this.tileGroup)},reset:function(){this.removeAllTiles(),this.tileGroup&&this.group.remove(this.tileGroup)}},x.Board.prototype.constructor=x.Board,x.Cell=function(e,t,i,n){this.q=e||0,this.r=t||0,this.s=i||0,this.h=n||1,this.tile=null,this.userData={},this.walkable=!0,this._calcCost=0,this._priority=0,this._visited=!1,this._parent=null,this.uniqueID=x.LinkedList.generateID()},x.Cell.prototype={set:function(e,t,i){return this.q=e,this.r=t,this.s=i,this},copy:function(e){return this.q=e.q,this.r=e.r,this.s=e.s,this.h=e.h,this.tile=e.tile||null,this.userData=e.userData||{},this.walkable=e.walkable,this},add:function(e){return this.q+=e.q,this.r+=e.r,this.s+=e.s,this},equals:function(e){return this.q===e.q&&this.r===e.r&&this.s===e.s}},x.Cell.prototype.constructor=x.Cell,x.HexGrid=function(e){e=e||{},this.type=x.HEX,this.size=5,this.cellSize=typeof e.cellSize>"u"?10:e.cellSize,this.cells={},this.numCells=0,this.extrudeSettings=null,this.autogenerated=!1;var t,i=[];for(t=0;6>t;t++)i.push(this._createVertex(t));for(this.cellShape=new THREE.Shape,this.cellShape.moveTo(i[0].x,i[0].y),t=1;6>t;t++)this.cellShape.lineTo(i[t].x,i[t].y);this.cellShape.lineTo(i[0].x,i[0].y),this.cellShape.autoClose=!0,this.cellGeo=new THREE.Geometry,this.cellGeo.vertices=i,this.cellGeo.verticesNeedUpdate=!0,this.cellShapeGeo=new THREE.ShapeGeometry(this.cellShape),this._cellWidth=2*this.cellSize,this._cellLength=.5*x.SQRT3*this._cellWidth,this._hashDelimeter=".",this._directions=[new x.Cell(1,-1,0),new x.Cell(1,0,-1),new x.Cell(0,1,-1),new x.Cell(-1,1,0),new x.Cell(-1,0,1),new x.Cell(0,-1,1)],this._diagonals=[new x.Cell(2,-1,-1),new x.Cell(1,1,-2),new x.Cell(-1,2,-1),new x.Cell(-2,1,1),new x.Cell(-1,-1,2),new x.Cell(1,-2,1)],this._list=[],this._vec3=new THREE.Vector3,this._cel=new x.Cell,this._conversionVec=new THREE.Vector3,this._geoCache=[],this._matCache=[]},x.HexGrid.TWO_THIRDS=2/3,x.HexGrid.prototype={cellToPixel:function(e){return this._vec3.x=e.q*this._cellWidth*.75,this._vec3.y=e.h,this._vec3.z=-((e.s-e.r)*this._cellLength*.5),this._vec3},pixelToCell:function(e){var t=e.x*(x.HexGrid.TWO_THIRDS/this.cellSize),i=(-e.x/3+x.SQRT3/3*e.z)/this.cellSize;return this._cel.set(t,i,-t-i),this._cubeRound(this._cel)},getCellAt:function(e){var t=e.x*(x.HexGrid.TWO_THIRDS/this.cellSize),i=(-e.x/3+x.SQRT3/3*e.z)/this.cellSize;return this._cel.set(t,i,-t-i),this._cubeRound(this._cel),this.cells[this.cellToHash(this._cel)]},getNeighbors:function(e,t,i){var n,a,s=this._directions.length;for(this._list.length=0,n=0;s>n;n++)this._cel.copy(e),this._cel.add(this._directions[n]),a=this.cells[this.cellToHash(this._cel)],!a||i&&!i(e,a)||this._list.push(a);if(t)for(n=0;s>n;n++)this._cel.copy(e),this._cel.add(this._diagonals[n]),a=this.cells[this.cellToHash(this._cel)],!a||i&&!i(e,a)||this._list.push(a);return this._list},getRandomCell:function(){var e,t=0,i=x.Tools.randomInt(0,this.numCells);for(e in this.cells){if(t===i)return this.cells[e];t++}return this.cells[e]},cellToHash:function(e){return e.q+this._hashDelimeter+e.r+this._hashDelimeter+e.s},distance:function(e,t){var i=Math.max(Math.abs(e.q-t.q),Math.abs(e.r-t.r),Math.abs(e.s-t.s));return i+=t.h-e.h},clearPath:function(){var e,t;for(e in this.cells)t=this.cells[e],t._calcCost=0,t._priority=0,t._parent=null,t._visited=!1},traverse:function(e){var t;for(t in this.cells)e(this.cells[t])},generateTile:function(e,t,i){var n=Math.abs(e.h);1>n&&(n=1);var a=this._geoCache[n];a||(this.extrudeSettings.amount=n,a=new THREE.ExtrudeGeometry(this.cellShape,this.extrudeSettings),this._geoCache[n]=a);var s=new x.Tile({size:this.cellSize,scale:t,cell:e,geometry:a,material:i});return e.tile=s,s},generateTiles:function(e){e=e||{};var t=[],i={tileScale:.95,cellSize:this.cellSize,material:null,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5}};i=x.Tools.merge(i,e),this.cellSize=i.cellSize,this._cellWidth=2*this.cellSize,this._cellLength=.5*x.SQRT3*this._cellWidth,this.autogenerated=!0,this.extrudeSettings=i.extrudeSettings;var n,a,s;for(n in this.cells)s=this.cells[n],a=this.generateTile(s,i.tileScale,i.material),a.position.copy(this.cellToPixel(s)),a.position.y=0,t.push(a);return t},generateTilePoly:function(e){e||(e=new THREE.MeshBasicMaterial({color:2405631}));var t=new THREE.Mesh(this.cellShapeGeo,e);return this._vec3.set(1,0,0),t.rotateOnAxis(this._vec3,x.PI/2),t},generate:function(e){e=e||{},this.size=typeof e.size>"u"?this.size:e.size;var t,i,n,a;for(t=-this.size;t<this.size+1;t++)for(i=-this.size;i<this.size+1;i++)n=-t-i,Math.abs(t)<=this.size&&Math.abs(i)<=this.size&&Math.abs(n)<=this.size&&(a=new x.Cell(t,i,n),this.add(a))},generateOverlay:function(e,t,i){var n,a,s,u=this.cellShape.createPointsGeometry();for(n=-e;e+1>n;n++)for(a=-e;e+1>a;a++)if(s=-n-a,Math.abs(n)<=e&&Math.abs(a)<=e&&Math.abs(s)<=e){this._cel.set(n,a,s);var g=new THREE.Line(u,i);g.position.copy(this.cellToPixel(this._cel)),g.rotation.x=90*x.DEG_TO_RAD,t.add(g)}},add:function(e){var t=this.cellToHash(e);if(!this.cells[t])return this.cells[t]=e,this.numCells++,e},remove:function(e){var t=this.cellToHash(e);this.cells[t]&&(delete this.cells[t],this.numCells--)},dispose:function(){this.cells=null,this.numCells=0,this.cellShape=null,this.cellGeo.dispose(),this.cellGeo=null,this.cellShapeGeo.dispose(),this.cellShapeGeo=null,this._list=null,this._vec3=null,this._conversionVec=null,this._geoCache=null,this._matCache=null},load:function(e,t,i){var n=this;x.Tools.getJSON({url:e,callback:function(a){n.fromJSON(a),t.call(i||null,a)},cache:!1,scope:n})},fromJSON:function(e){var t,i,n=e.cells;for(this.cells={},this.numCells=0,this.size=e.size,this.cellSize=e.cellSize,this._cellWidth=2*this.cellSize,this._cellLength=.5*x.SQRT3*this._cellWidth,this.extrudeSettings=e.extrudeSettings,this.autogenerated=e.autogenerated,t=0;t<n.length;t++)i=new x.Cell,i.copy(n[t]),this.add(i)},toJSON:function(){var e,t,i={size:this.size,cellSize:this.cellSize,extrudeSettings:this.extrudeSettings,autogenerated:this.autogenerated},n=[];for(t in this.cells)e=this.cells[t],n.push({q:e.q,r:e.r,s:e.s,h:e.h,walkable:e.walkable,userData:e.userData});return i.cells=n,i},_createVertex:function(e){var t=x.TAU/6*e;return new THREE.Vector3(this.cellSize*Math.cos(t),this.cellSize*Math.sin(t),0)},_cubeRound:function(e){var t=Math.round(e.q),i=Math.round(e.r),n=Math.round(e.s),a=Math.abs(t-e.q),s=Math.abs(i-e.r),u=Math.abs(n-e.s);return a>s&&a>u?t=-i-n:s>u?i=-t-n:n=-t-i,this._cel.set(t,i,n)}},x.HexGrid.prototype.constructor=x.HexGrid,x.SqrGrid=function(e){e=e||{},this.type=x.SQR,this.size=5,this.cellSize=typeof e.cellSize>"u"?10:e.cellSize,this.cells={},this.numCells=0,this.extrudeSettings=null,this.autogenerated=!1;var t=[];t.push(new THREE.Vector3),t.push(new THREE.Vector3(-this.cellSize,this.cellSize)),t.push(new THREE.Vector3(this.cellSize,this.cellSize)),t.push(new THREE.Vector3(this.cellSize,-this.cellSize)),this.cellShape=new THREE.Shape,this.cellShape.moveTo(-this.cellSize,-this.cellSize),this.cellShape.lineTo(-this.cellSize,this.cellSize),this.cellShape.lineTo(this.cellSize,this.cellSize),this.cellShape.lineTo(this.cellSize,-this.cellSize),this.cellShape.lineTo(-this.cellSize,-this.cellSize),this.cellGeo=new THREE.Geometry,this.cellGeo.vertices=t,this.cellGeo.verticesNeedUpdate=!0,this.cellShapeGeo=new THREE.ShapeGeometry(this.cellShape),this._fullCellSize=2*this.cellSize,this._hashDelimeter=".",this._directions=[new x.Cell(1,0,0),new x.Cell(0,-1,0),new x.Cell(-1,0,0),new x.Cell(0,1,0)],this._diagonals=[new x.Cell(-1,-1,0),new x.Cell(-1,1,0),new x.Cell(1,1,0),new x.Cell(1,-1,0)],this._list=[],this._vec3=new THREE.Vector3,this._cel=new x.Cell,this._conversionVec=new THREE.Vector3,this._geoCache=[],this._matCache=[]},x.SqrGrid.prototype={cellToPixel:function(e){return this._vec3.x=e.q*this._fullCellSize,this._vec3.y=e.h,this._vec3.z=e.r*this._fullCellSize,this._vec3},pixelToCell:function(e){var t=Math.round(e.x/this._fullCellSize),i=Math.round(e.z/this._fullCellSize);return this._cel.set(t,i,0)},getCellAt:function(e){var t=Math.round(e.x/this._fullCellSize),i=Math.round(e.z/this._fullCellSize);return this._cel.set(t,i),this.cells[this.cellToHash(this._cel)]},getNeighbors:function(e,t,i){var n,a,s=this._directions.length;for(this._list.length=0,n=0;s>n;n++)this._cel.copy(e),this._cel.add(this._directions[n]),a=this.cells[this.cellToHash(this._cel)],!a||i&&!i(e,a)||this._list.push(a);if(t)for(n=0;s>n;n++)this._cel.copy(e),this._cel.add(this._diagonals[n]),a=this.cells[this.cellToHash(this._cel)],!a||i&&!i(e,a)||this._list.push(a);return this._list},getRandomCell:function(){var e,t=0,i=x.Tools.randomInt(0,this.numCells);for(e in this.cells){if(t===i)return this.cells[e];t++}return this.cells[e]},cellToHash:function(e){return e.q+this._hashDelimeter+e.r},distance:function(e,t){var i=Math.max(Math.abs(e.q-t.q),Math.abs(e.r-t.r));return i+=t.h-e.h},clearPath:function(){var e,t;for(e in this.cells)t=this.cells[e],t._calcCost=0,t._priority=0,t._parent=null,t._visited=!1},traverse:function(e){var t;for(t in this.cells)e(this.cells[t])},generateTile:function(e,t,i){var n=Math.abs(e.h);1>n&&(n=1);var a=this._geoCache[n];a||(this.extrudeSettings.amount=n,a=new THREE.ExtrudeGeometry(this.cellShape,this.extrudeSettings),this._geoCache[n]=a);var s=new x.Tile({size:this.cellSize,scale:t,cell:e,geometry:a,material:i});return e.tile=s,s},generateTiles:function(e){e=e||{};var t=[],i={tileScale:.95,cellSize:this.cellSize,material:null,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5}};i=x.Tools.merge(i,e),this.cellSize=i.cellSize,this._fullCellSize=2*this.cellSize,this.autogenerated=!0,this.extrudeSettings=i.extrudeSettings;var n,a,s;for(n in this.cells)s=this.cells[n],a=this.generateTile(s,i.tileScale,i.material),a.position.copy(this.cellToPixel(s)),a.position.y=0,t.push(a);return t},generateTilePoly:function(e){e||(e=new THREE.MeshBasicMaterial({color:2405631}));var t=new THREE.Mesh(this.cellShapeGeo,e);return this._vec3.set(1,0,0),t.rotateOnAxis(this._vec3,x.PI/2),t},generate:function(e){e=e||{},this.size=typeof e.size>"u"?this.size:e.size;var t,i,n,a=Math.ceil(this.size/2);for(t=-a;a>t;t++)for(i=-a;a>i;i++)n=new x.Cell(t,i+1),this.add(n)},generateOverlay:function(e,t,i){var n,a,s=Math.ceil(e/2);for(n=-s;s>n;n++)for(a=-s;s>a;a++){this._cel.set(n,a);var u=new THREE.Line(this.cellGeo,i);u.position.copy(this.cellToPixel(this._cel)),u.rotation.x=90*x.DEG_TO_RAD,t.add(u)}},add:function(e){var t=this.cellToHash(e);if(!this.cells[t])return this.cells[t]=e,this.numCells++,e},remove:function(e){var t=this.cellToHash(e);this.cells[t]&&(delete this.cells[t],this.numCells--)},dispose:function(){this.cells=null,this.numCells=0,this.cellShape=null,this.cellGeo.dispose(),this.cellGeo=null,this.cellShapeGeo.dispose(),this.cellShapeGeo=null,this._list=null,this._vec3=null,this._conversionVec=null,this._geoCache=null,this._matCache=null},load:function(e,t,i){x.Tools.getJSON({url:e,callback:function(n){this.fromJSON(n),t.call(i||null,n)},cache:!1,scope:this})},fromJSON:function(e){var t,i,n=e.cells;for(this.cells={},this.numCells=0,this.size=e.size,this.cellSize=e.cellSize,this._fullCellSize=2*this.cellSize,this.extrudeSettings=e.extrudeSettings,this.autogenerated=e.autogenerated,t=0;t<n.length;t++)i=new x.Cell,i.copy(n[t]),this.add(i)},toJSON:function(){var e,t,i={size:this.size,cellSize:this.cellSize,extrudeSettings:this.extrudeSettings,autogenerated:this.autogenerated},n=[];for(t in this.cells)e=this.cells[t],n.push({q:e.q,r:e.r,s:e.s,h:e.h,walkable:e.walkable,userData:e.userData});return i.cells=n,i}},x.SqrGrid.prototype.constructor=x.SqrGrid,x.Tile=function(e){e=e||{};var t={cell:null,geometry:null,material:null};if(t=x.Tools.merge(t,e),!t.cell||!t.geometry)throw new Error("Missing vg.Tile configuration");this.cell=t.cell,this.cell.tile&&this.cell.tile!==this&&this.cell.tile.dispose(),this.cell.tile=this,this.uniqueID=x.Tools.generateID(),this.geometry=t.geometry,this.material=t.material,this.material||(this.material=new THREE.MeshPhongMaterial({color:x.Tools.randomizeRGB("30, 30, 30",13)})),this.objectType=x.TILE,this.entity=null,this.userData={},this.selected=!1,this.highlight="0x0084cc",this.mesh=new THREE.Mesh(this.geometry,this.material),this.mesh.userData.structure=this,this.position=this.mesh.position,this.rotation=this.mesh.rotation,this.rotation.x=-90*x.DEG_TO_RAD,this.mesh.scale.set(t.scale,t.scale,1),this.material.emissive?this._emissive=this.material.emissive.getHex():this._emissive=null},x.Tile.prototype={select:function(){return this.material.emissive&&this.material.emissive.setHex(this.highlight),this.selected=!0,this},deselect:function(){return this._emissive!==null&&this.material.emissive&&this.material.emissive.setHex(this._emissive),this.selected=!1,this},toggle:function(){return this.selected?this.deselect():this.select(),this},dispose:function(){this.cell&&this.cell.tile&&(this.cell.tile=null),this.cell=null,this.position=null,this.rotation=null,this.mesh.parent&&this.mesh.parent.remove(this.mesh),this.mesh.userData.structure=null,this.mesh=null,this.material=null,this.userData=null,this.entity=null,this.geometry=null,this._emissive=null}},x.Tile.prototype.constructor=x.Tile,function(){var e=function(){this.obj=null,this.next=null,this.prev=null,this.free=!0},t=function(){this.first=null,this.last=null,this.length=0,this.objToNodeMap={},this.uniqueID=Date.now()+""+Math.floor(1e3*Math.random()),this.sortArray=[]};t.generateID=function(){return Math.random().toString(36).slice(2)+Date.now()},t.prototype={getNode:function(i){return this.objToNodeMap[i.uniqueID]},addNode:function(i){var n=new e;if(!i.uniqueID)try{i.uniqueID=t.generateID()}catch{return console.error("[LinkedList.addNode] obj passed is immutable: cannot attach necessary identifier"),null}return n.obj=i,n.free=!1,this.objToNodeMap[i.uniqueID]=n,n},swapObjects:function(i,n){this.objToNodeMap[i.obj.uniqueID]=null,this.objToNodeMap[n.uniqueID]=i,i.obj=n},add:function(i){var n=this.objToNodeMap[i.uniqueID];if(n){if(n.free===!1)return;n.obj=i,n.free=!1,n.next=null,n.prev=null}else n=this.addNode(i);if(this.first){if(!this.last)throw new Error("[LinkedList.add] No last in the list -- that shouldn't happen here");this.last.next=n,n.prev=this.last,this.last=n,n.next=null}else this.first=n,this.last=n,n.next=null,n.prev=null;this.length++,this.showDebug&&this.dump("after add")},has:function(i){return!!this.objToNodeMap[i.uniqueID]},moveUp:function(i){this.dump("before move up");var n=this.getNode(i);if(!n)throw"Oops, trying to move an object that isn't in the list";if(n.prev){var a=n.prev,s=a.prev;n==this.last&&(this.last=a);var u=n.next;s&&(s.next=n),n.next=a,n.prev=a.prev,a.next=u,a.prev=n,this.first==a&&(this.first=n)}},moveDown:function(i){var n=this.getNode(i);if(!n)throw"Oops, trying to move an object that isn't in the list";if(n.next){var a=n.next;this.moveUp(a.obj),this.last==a&&(this.last=n)}},sort:function(i){var n,a,s=this.sortArray,u=this.first;for(s.length=0;u;)s.push(u.obj),u=u.next;for(this.clear(),s.sort(i),a=s.length,n=0;a>n;n++)this.add(s[n])},remove:function(i){var n=this.getNode(i);return!n||n.free?!1:(n.prev&&(n.prev.next=n.next),n.next&&(n.next.prev=n.prev),n.prev||(this.first=n.next),n.next||(this.last=n.prev),n.free=!0,n.prev=null,n.next=null,this.length--,!0)},shift:function(){var i=this.first;return this.length===0?null:(i.prev&&(i.prev.next=i.next),i.next&&(i.next.prev=i.prev),this.first=i.next,i.next||(this.last=null),i.free=!0,i.prev=null,i.next=null,this.length--,i.obj)},pop:function(){var i=this.last;return this.length===0?null:(i.prev&&(i.prev.next=i.next),i.next&&(i.next.prev=i.prev),this.last=i.prev,i.prev||(this.first=null),i.free=!0,i.prev=null,i.next=null,this.length--,i.obj)},concat:function(i){for(var n=i.first;n;)this.add(n.obj),n=n.next},clear:function(){for(var i=this.first;i;)i.free=!0,i=i.next;this.first=null,this.length=0},dispose:function(){for(var i=this.first;i;)i.obj=null,i=i.next;this.first=null,this.objToNodeMap=null},dump:function(i){console.log("===================="+i+"=====================");for(var n=this.first;n;)console.log("{"+n.obj.toString()+"} previous="+(n.prev?n.prev.obj:"NULL")),n=n.next();console.log("==================================="),console.log("Last: {"+(this.last?this.last.obj:"NULL")+"} First: {"+(this.first?this.first.obj:"NULL")+"}")}},t.prototype.constructor=t,x.LinkedList=t}(),function(){var e=function(i,n,a,s,u){this._listener=n,this.isOnce=a,this.context=s,this.signal=i,this._priority=u||0};e.prototype={active:!0,params:null,execute:function(i){var n,a;return this.active&&this._listener&&(a=this.params?this.params.concat(i):i,n=this._listener.apply(this.context,a),this.isOnce&&this.detach()),n},detach:function(){return this.isBound()?this.signal.remove(this._listener,this.context):null},isBound:function(){return!!this.signal&&!!this._listener},_destroy:function(){delete this.signal,delete this._listener,delete this.context},toString:function(){return"[SignalBinding isOnce:"+this.isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}},e.prototype.constructor=e;var t=function(){this._bindings=[],this._prevParams=null;var i=this;this.dispatch=function(){t.prototype.dispatch.apply(i,arguments)}};t.prototype={memorize:!1,_shouldPropagate:!0,active:!0,validateListener:function(i,n){if(typeof i!="function")throw new Error("Signal: listener is a required param of {fn}() and should be a Function.".replace("{fn}",n))},_registerListener:function(i,n,a,s){var u,g=this._indexOfListener(i,a);if(g!==-1){if(u=this._bindings[g],u.isOnce!==n)throw new Error("You cannot add"+(n?"":"Once")+"() then add"+(n?"Once":"")+"() the same listener without removing the relationship first.")}else u=new e(this,i,n,a,s),this._addBinding(u);return this.memorize&&this._prevParams&&u.execute(this._prevParams),u},_addBinding:function(i){var n=this._bindings.length;do n--;while(this._bindings[n]&&i._priority<=this._bindings[n]._priority);this._bindings.splice(n+1,0,i)},_indexOfListener:function(i,n){for(var a,s=this._bindings.length;s--;)if(a=this._bindings[s],a._listener===i&&a.context===n)return s;return-1},has:function(i,n){return this._indexOfListener(i,n)!==-1},add:function(i,n,a){return this.validateListener(i,"add"),this._registerListener(i,!1,n,a)},addOnce:function(i,n,a){return this.validateListener(i,"addOnce"),this._registerListener(i,!0,n,a)},remove:function(i,n){this.validateListener(i,"remove");var a=this._indexOfListener(i,n);return a!==-1&&(this._bindings[a]._destroy(),this._bindings.splice(a,1)),i},removeAll:function(i){typeof i>"u"&&(i=null);for(var n=this._bindings.length;n--;)i?this._bindings[n].context===i&&(this._bindings[n]._destroy(),this._bindings.splice(n,1)):this._bindings[n]._destroy();i||(this._bindings.length=0)},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(){if(this.active){var i,n=Array.prototype.slice.call(arguments),a=this._bindings.length;if(this.memorize&&(this._prevParams=n),a){i=this._bindings.slice(),this._shouldPropagate=!0;do a--;while(i[a]&&this._shouldPropagate&&i[a].execute(n)!==!1)}}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}},t.prototype.constructor=t,x.Signal=t}(),x.AStarFinder=function(e){e=e||{};var t={allowDiagonal:!1,heuristicFilter:null};t=x.Tools.merge(t,e),this.allowDiagonal=t.allowDiagonal,this.heuristicFilter=t.heuristicFilter,this.list=new x.LinkedList},x.AStarFinder.prototype={findPath:function(e,t,i,n){var a,s,u,g,y,_;for(i=i||this.heuristicFilter,n.clearPath(),this.list.clear(),this.list.add(e);this.list.length>0;){if(this.list.sort(this.compare),a=this.list.shift(),a._visited=!0,a===t)return x.PathUtil.backtrace(t);for(u=n.getNeighbors(a,this.allowDiagonal,i),y=0,_=u.length;_>y;y++)if(g=u[y],g.walkable&&(s=a._calcCost+n.distance(a,g),!g._visited||s<g._calcCost)){if(g._visited=!0,g._parent=a,g._calcCost=s,g._priority=s+n.distance(t,g),g===t)return x.PathUtil.backtrace(t);this.list.add(g)}}return null},compare:function(e,t){return e._priority-t._priority}},x.AStarFinder.prototype.constructor=x.AStarFinder,x.PathUtil={backtrace:function(e){for(var t=[e];e._parent;)e=e._parent,t.push(e);return t.reverse()},biBacktrace:function(e,t){var i=this.backtrace(e),n=this.backtrace(t);return i.concat(n.reverse())},pathLength:function(e){var t,i,n,a,s,u=0;for(t=1;t<e.length;++t)i=e[t-1],n=e[t],a=i[0]-n[0],s=i[1]-n[1],u+=Math.sqrt(a*a+s*s);return u},interpolate:function(e,t,i,n){var a,s,u,g,y,_,b=Math.abs,L=[];for(u=b(i-e),g=b(n-t),a=i>e?1:-1,s=n>t?1:-1,y=u-g;e!==i||t!==n;)L.push([e,t]),_=2*y,_>-g&&(y-=g,e+=a),u>_&&(y+=u,t+=s);return L},expandPath:function(e){var t,i,n,a,s,u,g=[],y=e.length;if(2>y)return g;for(s=0;y-1>s;++s)for(t=e[s],i=e[s+1],n=this.interpolate(t[0],t[1],i[0],i[1]),a=n.length,u=0;a-1>u;++u)g.push(n[u]);return g.push(e[y-1]),g},smoothenPath:function(e,t){var i,n,a,s,u,g,y,_,b,L,M,A,H=t.length,P=t[0][0],$=t[0][1],D=t[H-1][0],ie=t[H-1][1];for(i=P,n=$,u=[[i,n]],y=2;H>y;++y){for(b=t[y],a=b[0],s=b[1],L=this.interpolate(i,n,a,s),A=!1,_=1;_<L.length;++_)if(M=L[_],!e.isWalkableAt(M[0],M[1])){A=!0;break}A&&(g=t[y-1],u.push(g),i=g[0],n=g[1])}return u.push([D,ie]),u},compressPath:function(e){if(e.length<3)return e;var t,i,n,a,s,u,g=[],y=e[0][0],_=e[0][1],b=e[1][0],L=e[1][1],M=b-y,A=L-_;for(s=Math.sqrt(M*M+A*A),M/=s,A/=s,g.push([y,_]),u=2;u<e.length;u++)t=b,i=L,n=M,a=A,b=e[u][0],L=e[u][1],M=b-t,A=L-i,s=Math.sqrt(M*M+A*A),M/=s,A/=s,(M!==n||A!==a)&&g.push([t,i]);return g.push([b,L]),g}},x.Loader={manager:null,imageLoader:null,crossOrigin:!1,init:function(e){this.crossOrigin=e||!1,this.manager=new THREE.LoadingManager(function(){},function(){},function(){console.warn("Error loading images")}),this.imageLoader=new THREE.ImageLoader(this.manager),this.imageLoader.crossOrigin=e},loadTexture:function(e,t,i,n){var a=new THREE.Texture(null,t);return this.imageLoader.load(e,function(s){a.image=s,a.needsUpdate=!0,i&&i(a)},null,function(s){n&&n(s)}),a.sourceFile=e,a}},x.MouseCaster=function(e,t,i){this.down=!1,this.rightDown=!1,this.pickedObject=null,this.selectedObject=null,this.allHits=null,this.active=!0,this.shift=!1,this.ctrl=!1,this.wheel=0,this.position=new THREE.Vector3,this.screenPosition=new THREE.Vector2,this.signal=new x.Signal,this.group=e,this._camera=t,this._raycaster=new THREE.Raycaster,this._preventDefault=!1,i=i||document,i.addEventListener("mousemove",this._onDocumentMouseMove.bind(this),!1),i.addEventListener("mousedown",this._onDocumentMouseDown.bind(this),!1),i.addEventListener("mouseup",this._onDocumentMouseUp.bind(this),!1),i.addEventListener("mousewheel",this._onMouseWheel.bind(this),!1),i.addEventListener("DOMMouseScroll",this._onMouseWheel.bind(this),!1)},x.MouseCaster.OVER="over",x.MouseCaster.OUT="out",x.MouseCaster.DOWN="down",x.MouseCaster.UP="up",x.MouseCaster.CLICK="click",x.MouseCaster.WHEEL="wheel",x.MouseCaster.prototype={update:function(){if(this.active){this._raycaster.setFromCamera(this.screenPosition,this._camera);var e,t,i=this._raycaster.intersectObject(this.group,!0);i.length>0?(e=i[0],t=e.object.userData.structure,this.pickedObject!=t&&(this.pickedObject&&this.signal.dispatch(x.MouseCaster.OUT,this.pickedObject),this.pickedObject=t,this.selectedObject=null,this.signal.dispatch(x.MouseCaster.OVER,this.pickedObject)),this.position.copy(e.point),this.screenPosition.z=e.distance):(this.pickedObject&&this.signal.dispatch(x.MouseCaster.OUT,this.pickedObject),this.pickedObject=null,this.selectedObject=null),this.allHits=i}},preventDefault:function(){this._preventDefault=!0},_onDocumentMouseDown:function(e){return e=e||window.event,e.preventDefault(),this._preventDefault?(this._preventDefault=!1,!1):(this.pickedObject&&(this.selectedObject=this.pickedObject),this.shift=e.shiftKey,this.ctrl=e.ctrlKey,this.down=e.which===1,this.rightDown=e.which===3,void this.signal.dispatch(x.MouseCaster.DOWN,this.pickedObject))},_onDocumentMouseUp:function(e){return e.preventDefault(),this._preventDefault?(this._preventDefault=!1,!1):(this.shift=e.shiftKey,this.ctrl=e.ctrlKey,this.signal.dispatch(x.MouseCaster.UP,this.pickedObject),this.selectedObject&&this.pickedObject&&this.selectedObject.uniqueID===this.pickedObject.uniqueID&&this.signal.dispatch(x.MouseCaster.CLICK,this.pickedObject),this.down=e.which===1?!1:this.down,void(this.rightDown=e.which===3?!1:this.rightDown))},_onDocumentMouseMove:function(e){e.preventDefault(),this.screenPosition.x=e.clientX/window.innerWidth*2-1,this.screenPosition.y=2*-(e.clientY/window.innerHeight)+1},_onMouseWheel:function(e){if(this.active){e.preventDefault(),e.stopPropagation();var t=0;e.wheelDelta!==void 0?t=e.wheelDelta:e.detail!==void 0&&(t=-e.detail),t>0?this.wheel++:this.wheel--,this.signal.dispatch(x.MouseCaster.WHEEL,this.wheel)}}},x.MouseCaster.prototype.constructor=x.MouseCaster,x.Scene=function(e,t){var i={element:document.body,alpha:!0,antialias:!0,clearColor:"#fff",sortObjects:!1,fog:null,light:new THREE.DirectionalLight(16777215),lightPosition:null,cameraType:"PerspectiveCamera",cameraPosition:null,orthoZoom:4},n={minDistance:100,maxDistance:1e3,zoomSpeed:2,noZoom:!1};if(i=x.Tools.merge(i,e),typeof t!="boolean"&&(n=x.Tools.merge(n,t)),this.renderer=new THREE.WebGLRenderer({alpha:i.alpha,antialias:i.antialias}),this.renderer.setClearColor(i.clearColor,0),this.renderer.sortObjects=i.sortObjects,this.width=window.innerWidth,this.height=window.innerHeight,this.orthoZoom=i.orthoZoom,this.container=new THREE.Scene,this.container.fog=i.fog,this.container.add(new THREE.AmbientLight(14540253)),i.lightPosition||i.light.position.set(-1,1,-1).normalize(),this.container.add(i.light),i.cameraType==="OrthographicCamera"){var a=window.innerWidth/this.orthoZoom,s=window.innerHeight/this.orthoZoom;this.camera=new THREE.OrthographicCamera(a/-2,a/2,s/2,s/-2,1,5e3)}else this.camera=new THREE.PerspectiveCamera(50,this.width/this.height,1,5e3);this.contolled=!!t,this.contolled&&(this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.minDistance=n.minDistance,this.controls.maxDistance=n.maxDistance,this.controls.zoomSpeed=n.zoomSpeed,this.controls.noZoom=n.noZoom),i.cameraPosition&&this.camera.position.copy(i.cameraPosition),window.addEventListener("resize",function(){if(this.width=window.innerWidth,this.height=window.innerHeight,this.camera.type==="OrthographicCamera"){var u=this.width/this.orthoZoom,g=this.height/this.orthoZoom;this.camera.left=u/-2,this.camera.right=u/2,this.camera.top=g/2,this.camera.bottom=g/-2}else this.camera.aspect=this.width/this.height;this.camera.updateProjectionMatrix(),this.renderer.setSize(this.width,this.height)}.bind(this),!1),this.attachTo(i.element)},x.Scene.prototype={attachTo:function(e){e.style.width=this.width+"px",e.style.height=this.height+"px",this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(this.width,this.height),e.appendChild(this.renderer.domElement)},add:function(e){this.container.add(e)},remove:function(e){this.container.remove(e)},render:function(){this.contolled&&this.controls.update(),this.renderer.render(this.container,this.camera)},updateOrthoZoom:function(){if(this.orthoZoom<=0)return void(this.orthoZoom=0);var e=this.width/this.orthoZoom,t=this.height/this.orthoZoom;this.camera.left=e/-2,this.camera.right=e/2,this.camera.top=t/2,this.camera.bottom=t/-2,this.camera.updateProjectionMatrix()},focusOn:function(e){this.camera.lookAt(e.position)}},x.Scene.prototype.constructor=x.Scene,x.SelectionManager=function(e){this.mouse=e,this.onSelect=new x.Signal,this.onDeselect=new x.Signal,this.selected=null,this.toggleSelection=!1,this.mouse.signal.add(this.onMouse,this)},x.SelectionManager.prototype={select:function(e,t){e&&(t=t||!0,this.selected!==e&&this.clearSelection(t),e.selected?this.toggleSelection&&(t&&this.onDeselect.dispatch(e),e.deselect()):e.select(),this.selected=e,t&&this.onSelect.dispatch(e))},clearSelection:function(e){e=e||!0,this.selected&&(e&&this.onDeselect.dispatch(this.selected),this.selected.deselect()),this.selected=null},onMouse:function(e,t){switch(e){case x.MouseCaster.DOWN:t||this.clearSelection();break;case x.MouseCaster.CLICK:this.select(t)}}},x.SelectionManager.prototype.constructor=x.SelectionManager,x.Tools={clamp:function(e,t,i){return Math.max(t,Math.min(i,e))},sign:function(e){return e&&e/Math.abs(e)},random:function(e,t){return arguments.length===1?Math.random()*e-.5*e:Math.random()*(t-e)+e},randomInt:function(e,t){return arguments.length===1?Math.random()*e-.5*e|0:Math.random()*(t-e+1)+e|0},normalize:function(e,t,i){return(e-t)/(i-t)},getShortRotation:function(e){return e%=this.TAU,e>this.PI?e-=this.TAU:e<-this.PI&&(e+=this.TAU),e},generateID:function(){return Math.random().toString(36).slice(2)+Date.now()},isPlainObject:function(e){if(typeof e!="object"||e.nodeType||e===e.window)return!1;try{if(e.constructor&&!Object.prototype.hasOwnProperty.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch{return!1}return!0},merge:function(e,t){var i=this,n=Array.isArray(t),a=n&&[]||{};return n?(e=e||[],a=a.concat(e),t.forEach(function(s,u){typeof a[u]>"u"?a[u]=s:i.isPlainObject(s)?a[u]=i.merge(e[u],s):e.indexOf(s)===-1&&a.push(s)}),a):(e&&i.isPlainObject(e)&&Object.keys(e).forEach(function(s){a[s]=e[s]}),Object.keys(t).forEach(function(s){t[s]&&i.isPlainObject(t[s])&&e[s]?a[s]=i.merge(e[s],t[s]):a[s]=t[s]}),a)},now:function(){return window.nwf?window.nwf.system.Performance.elapsedTime:window.performance.now()},empty:function(e){for(;e.lastChild;)e.removeChild(e.lastChild)},radixSort:function(e,t,i,n){if(t=t||0,i=i||e.length,n=n||31,!(t>=i-1||0>n)){for(var a=t,s=i,u=1<<n;s>a;)if(e[a]&u){--s;var g=e[a];e[a]=e[s],e[s]=g}else++a;this.radixSort(e,t,s,n-1),this.radixSort(e,s,i,n-1)}},randomizeRGB:function(e,t){var i,n,a=e.split(","),s="rgb(";for(t=this.randomInt(t),i=0;3>i;i++)n=parseInt(a[i])+t,0>n?n=0:n>255&&(n=255),s+=n+",";return s=s.substring(0,s.length-1),s+=")"},getJSON:function(e){var t=new XMLHttpRequest,i=typeof e.cache>"u"?!1:e.cache,n=i?e.url:e.url+"?t="+Math.floor(1e4*Math.random())+Date.now();t.onreadystatechange=function(){if(this.status===200){var a=null;try{a=JSON.parse(this.responseText)}catch{return}return void e.callback.call(e.scope||null,a)}this.status!==0&&console.warn("[Tools.getJSON] Error: "+this.status+" ("+this.statusText+") :: "+e.url)},t.open("GET",n,!0),t.setRequestHeader("Accept","application/json"),t.setRequestHeader("Content-Type","application/json"),t.send("")}};var sr={size:5,cellSize:10,extrudeSettings:{amount:1,bevelEnabled:!0,bevelSegments:1,steps:1,bevelSize:.5,bevelThickness:.5},autogenerated:!0,cells:[{q:-1,r:0,s:1,h:1,walkable:!0,userData:{}},{q:0,r:-1,s:1,h:1,walkable:!0,userData:{}},{q:0,r:0,s:0,h:1,walkable:!0,userData:{}},{q:1,r:-1,s:0,h:1,walkable:!0,userData:{}},{q:-1,r:1,s:0,h:0,walkable:!0,userData:{}},{q:0,r:1,s:-1,h:0,walkable:!0,userData:{}},{q:1,r:0,s:-1,h:0,walkable:!0,userData:{}}]};const fi=bi.exports,or=sr;AFRAME.registerPrimitive("a-hexgrid",{defaultComponents:{hexgrid:{}},mappings:{src:"hexgrid.src"}});AFRAME.registerComponent("hexgrid",{dependencies:["material"],schema:{src:{type:"asset"}},init:function(){const e=this.data;e.src?fetch(e.src).then(t=>t.json()).then(t=>this.addMesh(t)):this.addMesh(or)},addMesh:function(e){const t=new fi.HexGrid;t.fromJSON(e);const i=new fi.Board(t);i.generateTilemap(),this.el.setObject3D("mesh",i.group),this.addMaterial()},addMaterial:function(){const t=(this.el.components.material||{}).material;!t||this.el.object3D.traverse(i=>{i.isMesh&&(i.material=t)})},remove:function(){this.el.removeObject3D("mesh")}});AFRAME.registerPrimitive("a-ocean",{defaultComponents:{ocean:{},rotation:{x:-90,y:0,z:0}},mappings:{width:"ocean.width",depth:"ocean.depth",density:"ocean.density",amplitude:"ocean.amplitude",amplitudeVariance:"ocean.amplitudeVariance",speed:"ocean.speed",speedVariance:"ocean.speedVariance",color:"ocean.color",opacity:"ocean.opacity"}});AFRAME.registerComponent("ocean",{schema:{width:{default:10,min:0},depth:{default:10,min:0},density:{default:10},amplitude:{default:.1},amplitudeVariance:{default:.3},speed:{default:1},speedVariance:{default:2},color:{default:"#7AD2F7",type:"color"},opacity:{default:.8}},play:function(){const e=this.el,t=this.data;let i=e.components.material;const n=new THREE.PlaneGeometry(t.width,t.depth,t.density,t.density);n.mergeVertices(),this.waves=[];for(let a,s=0,u=n.vertices.length;s<u;s++)a=n.vertices[s],this.waves.push({z:a.z,ang:Math.random()*Math.PI*2,amp:t.amplitude+Math.random()*t.amplitudeVariance,speed:(t.speed+Math.random()*t.speedVariance)/1e3});i||(i={},i.material=new THREE.MeshPhongMaterial({color:t.color,transparent:t.opacity<1,opacity:t.opacity,shading:THREE.FlatShading})),this.mesh=new THREE.Mesh(n,i.material),e.setObject3D("mesh",this.mesh)},remove:function(){this.el.removeObject3D("mesh")},tick:function(e,t){if(!t)return;const i=this.mesh.geometry.vertices;for(let n,a,s=0;n=i[s];s++)a=this.waves[s],n.z=a.z+Math.sin(a.ang)*a.amp,a.ang+=a.speed*t;this.mesh.geometry.verticesNeedUpdate=!0}});AFRAME.registerPrimitive("a-tube",{defaultComponents:{tube:{}},mappings:{path:"tube.path",segments:"tube.segments",radius:"tube.radius","radial-segments":"tube.radialSegments",closed:"tube.closed"}});AFRAME.registerComponent("tube",{schema:{path:{default:[]},segments:{default:64},radius:{default:1},radialSegments:{default:8},closed:{default:!1}},init:function(){const e=this.el,t=this.data;let i=e.components.material;if(!t.path.length){console.error("[a-tube] `path` property expected but not found.");return}const n=new THREE.CatmullRomCurve3(t.path.map(function(s){return s=s.split(" "),new THREE.Vector3(Number(s[0]),Number(s[1]),Number(s[2]))})),a=new THREE.TubeGeometry(n,t.segments,t.radius,t.radialSegments,t.closed);i||(i={},i.material=new THREE.MeshPhongMaterial),this.mesh=new THREE.Mesh(a,i.material),this.el.setObject3D("mesh",this.mesh)},update:function(e){!Object.keys(e).length||(this.remove(),this.init())},remove:function(){this.mesh&&this.el.removeObject3D("mesh")}});const lr=e=>({}),di=e=>({}),cr=e=>({}),pi=e=>({}),ur=e=>({}),vi=e=>({});function hr(e){let t;return{c(){t=Ne("Back to preview")},l(i){t=Pe(i,"Back to preview")},m(i,n){oe(i,t,n)},d(i){i&&q(t)}}}function fr(e){let t,i;return t=new yi({props:{back:!0,to:"/scan/preview",$$slots:{default:[hr]},$$scope:{ctx:e}}}),{c(){Re(t.$$.fragment)},l(n){Ce(t.$$.fragment,n)},m(n,a){Me(t,n,a),i=!0},p(n,a){const s={};a&1024&&(s.$$scope={dirty:a,ctx:n}),t.$set(s)},i(n){i||(ue(t.$$.fragment,n),i=!0)},o(n){ce(t.$$.fragment,n),i=!1},d(n){Se(t,n)}}}function dr(e){let t;return{c(){t=Ne("Place targets")},l(i){t=Pe(i,"Place targets")},m(i,n){oe(i,t,n)},d(i){i&&q(t)}}}function pr(e){let t,i;return t=new yi({props:{to:"/targetplacement/"+(e[0]?"ar":"model"),$$slots:{default:[dr]},$$scope:{ctx:e}}}),{c(){Re(t.$$.fragment)},l(n){Ce(t.$$.fragment,n)},m(n,a){Me(t,n,a),i=!0},p(n,a){const s={};a&1&&(s.to="/targetplacement/"+(n[0]?"ar":"model")),a&1024&&(s.$$scope={dirty:a,ctx:n}),t.$set(s)},i(n){i||(ue(t.$$.fragment,n),i=!0)},o(n){ce(t.$$.fragment,n),i=!1},d(n){Se(t,n)}}}function vr(e){let t,i;return t=new Qe({props:{disabled:!0,secondary:!0,$$slots:{default:[gr]},$$scope:{ctx:e}}}),{c(){Re(t.$$.fragment)},l(n){Ce(t.$$.fragment,n)},m(n,a){Me(t,n,a),i=!0},p(n,a){const s={};a&1024&&(s.$$scope={dirty:a,ctx:n}),t.$set(s)},i(n){i||(ue(t.$$.fragment,n),i=!0)},o(n){ce(t.$$.fragment,n),i=!1},d(n){Se(t,n)}}}function mr(e){let t,i,n,a;const s=[Er,yr],u=[];function g(y,_){return y[3]?0:1}return t=g(e),i=u[t]=s[t](e),{c(){i.c(),n=ai()},l(y){i.l(y),n=ai()},m(y,_){u[t].m(y,_),oe(y,n,_),a=!0},p(y,_){let b=t;t=g(y),t===b?u[t].p(y,_):(zt(),ce(u[b],1,1,()=>{u[b]=null}),Vt(),i=u[t],i?i.p(y,_):(i=u[t]=s[t](y),i.c()),ue(i,1),i.m(n.parentNode,n))},i(y){a||(ue(i),a=!0)},o(y){ce(i),a=!1},d(y){u[t].d(y),y&&q(n)}}}function gr(e){let t;return{c(){t=Ne("Place targets to begin")},l(i){t=Pe(i,"Place targets to begin")},m(i,n){oe(i,t,n)},d(i){i&&q(t)}}}function yr(e){let t,i;return t=new Qe({props:{$$slots:{default:[br]},$$scope:{ctx:e}}}),t.$on("click",e[7]),{c(){Re(t.$$.fragment)},l(n){Ce(t.$$.fragment,n)},m(n,a){Me(t,n,a),i=!0},p(n,a){const s={};a&1024&&(s.$$scope={dirty:a,ctx:n}),t.$set(s)},i(n){i||(ue(t.$$.fragment,n),i=!0)},o(n){ce(t.$$.fragment,n),i=!1},d(n){Se(t,n)}}}function Er(e){let t,i,n,a;return t=new Qe({props:{secondary:!0,$$slots:{default:[Tr]},$$scope:{ctx:e}}}),t.$on("click",e[8]),n=new Qe({props:{green:!0,$$slots:{default:[wr]},$$scope:{ctx:e}}}),{c(){Re(t.$$.fragment),i=Le(),Re(n.$$.fragment)},l(s){Ce(t.$$.fragment,s),i=He(s),Ce(n.$$.fragment,s)},m(s,u){Me(t,s,u),oe(s,i,u),Me(n,s,u),a=!0},p(s,u){const g={};u&1024&&(g.$$scope={dirty:u,ctx:s}),t.$set(g);const y={};u&1040&&(y.$$scope={dirty:u,ctx:s}),n.$set(y)},i(s){a||(ue(t.$$.fragment,s),ue(n.$$.fragment,s),a=!0)},o(s){ce(t.$$.fragment,s),ce(n.$$.fragment,s),a=!1},d(s){Se(t,s),s&&q(i),Se(n,s)}}}function br(e){let t,i,n,a,s;return a=new An({props:{path:Rn}}),{c(){t=ye("span"),i=Ne("Reveal lava"),n=Le(),Re(a.$$.fragment)},l(u){t=Ee(u,"SPAN",{});var g=we(t);i=Pe(g,"Reveal lava"),g.forEach(q),n=He(u),Ce(a.$$.fragment,u)},m(u,g){oe(u,t,g),_e(t,i),oe(u,n,g),Me(a,u,g),s=!0},p:mn,i(u){s||(ue(a.$$.fragment,u),s=!0)},o(u){ce(a.$$.fragment,u),s=!1},d(u){u&&q(t),u&&q(n),Se(a,u)}}}function Tr(e){let t;return{c(){t=Ne("Hide lava")},l(i){t=Pe(i,"Hide lava")},m(i,n){oe(i,t,n)},d(i){i&&q(t)}}}function wr(e){let t,i,n,a,s;return{c(){t=Ne("Energy: "),i=Ne(e[4]),n=Ne("/"),a=Ne(Pt),s=Ne(" MW")},l(u){t=Pe(u,"Energy: "),i=Pe(u,e[4]),n=Pe(u,"/"),a=Pe(u,Pt),s=Pe(u," MW")},m(u,g){oe(u,t,g),oe(u,i,g),oe(u,n,g),oe(u,a,g),oe(u,s,g)},p(u,g){g&16&&gn(i,u[4])},d(u){u&&q(t),u&&q(i),u&&q(n),u&&q(a),u&&q(s)}}}function kr(e){let t,i,n,a,s,u,g;const y=e[9].backButton,_=pt(y,e,e[10],pi),b=_||fr(e),L=e[9].targetButton,M=pt(L,e,e[10],di),A=M||pr(e),H=[mr,vr],P=[];function $(D,ie){return D[6].length>0?0:1}return s=$(e),u=P[s]=H[s](e),{c(){t=ye("div"),b&&b.c(),i=Le(),n=ye("div"),A&&A.c(),a=Le(),u.c(),this.h()},l(D){t=Ee(D,"DIV",{class:!0});var ie=we(t);b&&b.l(ie),ie.forEach(q),i=He(D),n=Ee(D,"DIV",{class:!0});var he=we(n);A&&A.l(he),a=He(he),u.l(he),he.forEach(q),this.h()},h(){Te(t,"class","button backButton svelte-elbc8i"),Te(n,"class","button rightButton svelte-elbc8i")},m(D,ie){oe(D,t,ie),b&&b.m(t,null),oe(D,i,ie),oe(D,n,ie),A&&A.m(n,null),_e(n,a),P[s].m(n,null),g=!0},p(D,ie){_&&_.p&&(!g||ie&1024)&&vt(_,y,D,D[10],g?gt(y,D[10],ie,cr):mt(D[10]),pi),M?M.p&&(!g||ie&1024)&&vt(M,L,D,D[10],g?gt(L,D[10],ie,lr):mt(D[10]),di):A&&A.p&&(!g||ie&1)&&A.p(D,g?ie:-1);let he=s;s=$(D),s===he?P[s].p(D,ie):(zt(),ce(P[he],1,1,()=>{P[he]=null}),Vt(),u=P[s],u?u.p(D,ie):(u=P[s]=H[s](D),u.c()),ue(u,1),u.m(n,null))},i(D){g||(ue(b,D),ue(A,D),ue(u),g=!0)},o(D){ce(b,D),ce(A,D),ce(u),g=!1},d(D){D&&q(t),b&&b.d(D),D&&q(i),D&&q(n),A&&A.d(D),P[s].d()}}}function xr(e){let t,i,n,a;return t=new gi({props:{scale:e[1],rotation:e[2],lava_revealed:e[3]}}),{c(){Re(t.$$.fragment),i=Le(),n=ye("a-camera"),this.h()},l(s){Ce(t.$$.fragment,s),i=He(s),n=Ee(s,"A-CAMERA",{position:!0}),we(n).forEach(q),this.h()},h(){ge(n,"position","0 3 3")},m(s,u){Me(t,s,u),oe(s,i,u),oe(s,n,u),a=!0},p(s,u){const g={};u&2&&(g.scale=s[1]),u&4&&(g.rotation=s[2]),u&8&&(g.lava_revealed=s[3]),t.$set(g)},i(s){a||(ue(t.$$.fragment,s),a=!0)},o(s){ce(t.$$.fragment,s),a=!1},d(s){Se(t,s),s&&q(i),s&&q(n)}}}function _r(e){let t,i,n,a,s,u,g,y=e[5]&&mi();return a=new gi({props:{scale:e[1],lava_revealed:e[3]}}),{c(){t=ye("a-marker"),y&&y.c(),i=Le(),n=ye("a-entity"),Re(a.$$.fragment),s=Le(),u=ye("a-entity"),this.h()},l(_){t=Ee(_,"A-MARKER",{id:!0,type:!0,value:!0,raycaster:!0,emitevents:!0,cursor:!0});var b=we(t);y&&y.l(b),i=He(b),n=Ee(b,"A-ENTITY",{class:!0,"gesture-handler":!0});var L=we(n);Ce(a.$$.fragment,L),L.forEach(q),b.forEach(q),s=He(_),u=Ee(_,"A-ENTITY",{camera:!0}),we(u).forEach(q),this.h()},h(){ge(n,"class","clickable"),ge(n,"gesture-handler",""),ge(t,"id","marker0"),ge(t,"type","barcode"),ge(t,"value","0"),ge(t,"raycaster","objects: .clickable"),ge(t,"emitevents","true"),ge(t,"cursor","fuse: false; rayOrigin: mouse;"),ge(u,"camera","")},m(_,b){oe(_,t,b),y&&y.m(t,null),_e(t,i),_e(t,n),Me(a,n,null),oe(_,s,b),oe(_,u,b),g=!0},p(_,b){_[5]?y||(y=mi(),y.c(),y.m(t,i)):y&&(y.d(1),y=null);const L={};b&2&&(L.scale=_[1]),b&8&&(L.lava_revealed=_[3]),a.$set(L)},i(_){g||(ue(a.$$.fragment,_),g=!0)},o(_){ce(a.$$.fragment,_),g=!1},d(_){_&&q(t),y&&y.d(),Se(a),_&&q(s),_&&q(u)}}}function mi(e){let t;return{c(){t=ye("a-box"),this.h()},l(i){t=Ee(i,"A-BOX",{position:!0,material:!0}),we(t).forEach(q),this.h()},h(){ge(t,"position","0 0 0"),ge(t,"material","color: blue; opacity: 0.5;")},m(i,n){oe(i,t,n)},d(i){i&&q(t)}}}function Ar(e){let t,i,n,a,s,u,g;const y=e[9].overlay,_=pt(y,e,e[10],vi),b=_||kr(e),L=[_r,xr],M=[];function A(H,P){return H[0]?0:1}return s=A(e),u=M[s]=L[s](e),{c(){t=ye("a-scene"),b&&b.c(),i=Le(),n=ye("a-entity"),a=Le(),u.c(),this.h()},l(H){t=Ee(H,"A-SCENE",{embedded:!0,"vr-mode-ui":!0,"gesture-detector":!0,arjs:!0,class:!0});var P=we(t);b&&b.l(P),i=He(P),n=Ee(P,"A-ENTITY",{light:!0}),we(n).forEach(q),a=He(P),u.l(P),P.forEach(q),this.h()},h(){ge(n,"light","type: ambient; color: #fff"),ge(t,"embedded",""),ge(t,"vr-mode-ui","enabled: false"),ge(t,"gesture-detector",""),ge(t,"arjs","trackingMethod: best; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"),ge(t,"class","svelte-elbc8i"),ri(t,"arMode",e[0])},m(H,P){oe(H,t,P),b&&b.m(t,null),_e(t,i),_e(t,n),_e(t,a),M[s].m(t,null),g=!0},p(H,[P]){_?_.p&&(!g||P&1024)&&vt(_,y,H,H[10],g?gt(y,H[10],P,ur):mt(H[10]),vi):b&&b.p&&(!g||P&1113)&&b.p(H,g?P:-1);let $=s;s=A(H),s===$?M[s].p(H,P):(zt(),ce(M[$],1,1,()=>{M[$]=null}),Vt(),u=M[s],u?u.p(H,P):(u=M[s]=L[s](H),u.c()),ue(u,1),u.m(t,null)),(!g||P&1)&&ri(t,"arMode",H[0])},i(H){g||(ue(b,H),ue(u),g=!0)},o(H){ce(b,H),ce(u),g=!1},d(H){H&&q(t),b&&b.d(H),M[s].d()}}}let Pt=1e3;function Rr(e,t,i){let n,a,s,u,g;it(e,li,D=>i(11,n=D)),it(e,Hn,D=>i(12,a=D)),it(e,Dn,D=>i(5,s=D)),it(e,ft,D=>i(13,u=D)),it(e,Ln,D=>i(6,g=D));let{$$slots:y={},$$scope:_}=t,{arMode:b=!1}=t,{scale:L=[.05,.025,.05]}=t,{rotation:M=0}=t,A=!1,H=0;function P(){i(4,H=ft.computePlayerPoints(Pt)),i(3,A=!0)}function $(){i(3,A=!1)}return vn(async()=>{if(!u){if(!s&&!n){Sn("/scan/mapscanning");return}n||(console.warn("SCENE VIEWER: gltf is loaded from hardcoded data"),li.setup({curves:kn,hierarchy:xn,size:{width:800,height:960}})),await ft.setup(n,a.lava_forking),ft.build(n)}}),e.$$set=D=>{"arMode"in D&&i(0,b=D.arMode),"scale"in D&&i(1,L=D.scale),"rotation"in D&&i(2,M=D.rotation),"$$scope"in D&&i(10,_=D.$$scope)},[b,L,M,A,H,s,g,P,$,y,_]}class Cr extends Ft{constructor(t){super(),It(this,t,Rr,Ar,Bt,{arMode:0,scale:1,rotation:2})}}function Mr(e){let t;return{c(){t=Ne("Slide me")},l(i){t=Pe(i,"Slide me")},m(i,n){oe(i,t,n)},d(i){i&&q(t)}}}function Sr(e){let t,i,n,a,s,u,g;const y=e[5].default,_=pt(y,e,e[4],null),b=_||Mr();return{c(){t=ye("div"),i=ye("div"),b&&b.c(),n=Le(),a=ye("input"),this.h()},l(L){t=Ee(L,"DIV",{class:!0});var M=we(t);i=Ee(M,"DIV",{class:!0});var A=we(i);b&&b.l(A),A.forEach(q),n=He(M),a=Ee(M,"INPUT",{type:!0,min:!0,max:!0,step:!0,class:!0}),M.forEach(q),this.h()},h(){Te(i,"class","svelte-19nugep"),Te(a,"type","range"),Te(a,"min",e[1]),Te(a,"max",e[2]),Te(a,"step",e[3]),Te(a,"class","svelte-19nugep"),Te(t,"class","slider svelte-19nugep")},m(L,M){oe(L,t,M),_e(t,i),b&&b.m(i,null),_e(t,n),_e(t,a),si(a,e[0]),s=!0,u||(g=[oi(a,"change",e[6]),oi(a,"input",e[6])],u=!0)},p(L,[M]){_&&_.p&&(!s||M&16)&&vt(_,y,L,L[4],s?gt(y,L[4],M,null):mt(L[4]),null),(!s||M&2)&&Te(a,"min",L[1]),(!s||M&4)&&Te(a,"max",L[2]),(!s||M&8)&&Te(a,"step",L[3]),M&1&&si(a,L[0])},i(L){s||(ue(b,L),s=!0)},o(L){ce(b,L),s=!1},d(L){L&&q(t),b&&b.d(L),u=!1,yn(g)}}}function Lr(e,t,i){let{$$slots:n={},$$scope:a}=t,{value:s=0}=t,{from:u=-180}=t,{to:g=180}=t,{step:y=10}=t;function _(){s=En(this.value),i(0,s)}return e.$$set=b=>{"value"in b&&i(0,s=b.value),"from"in b&&i(1,u=b.from),"to"in b&&i(2,g=b.to),"step"in b&&i(3,y=b.step),"$$scope"in b&&i(4,a=b.$$scope)},[s,u,g,y,a,n,_]}class Hr extends Ft{constructor(t){super(),It(this,t,Lr,Sr,Bt,{value:0,from:1,to:2,step:3})}}function Dr(e){let t,i,n,a,s,u,g,y,_,b,L,M;t=new Cr({props:{rotation:e[0],scale:e[1]}});function A(P){e[4](P)}let H={from:-200,to:200,step:10};return e[0]!==void 0&&(H.value=e[0]),a=new Hr({props:H}),bn.push(()=>Tn(a,"value",A)),y=new Qe({props:{icon:Cn}}),y.$on("click",e[2]),L=new Qe({props:{icon:Mn}}),L.$on("click",e[3]),{c(){Re(t.$$.fragment),i=Le(),n=ye("div"),Re(a.$$.fragment),u=Le(),g=ye("div"),Re(y.$$.fragment),_=Le(),b=ye("div"),Re(L.$$.fragment),this.h()},l(P){Ce(t.$$.fragment,P),i=He(P),n=Ee(P,"DIV",{class:!0});var $=we(n);Ce(a.$$.fragment,$),u=He($),g=Ee($,"DIV",{class:!0});var D=we(g);Ce(y.$$.fragment,D),D.forEach(q),_=He($),b=Ee($,"DIV",{class:!0});var ie=we(b);Ce(L.$$.fragment,ie),ie.forEach(q),$.forEach(q),this.h()},h(){Te(g,"class","iconButton"),Te(b,"class","iconButton"),Te(n,"class","rotationSlider svelte-158ga96")},m(P,$){Me(t,P,$),oe(P,i,$),oe(P,n,$),Me(a,n,null),_e(n,u),_e(n,g),Me(y,g,null),_e(n,_),_e(n,b),Me(L,b,null),M=!0},p(P,[$]){const D={};$&1&&(D.rotation=P[0]),$&2&&(D.scale=P[1]),t.$set(D);const ie={};!s&&$&1&&(s=!0,ie.value=P[0],wn(()=>s=!1)),a.$set(ie)},i(P){M||(ue(t.$$.fragment,P),ue(a.$$.fragment,P),ue(y.$$.fragment,P),ue(L.$$.fragment,P),M=!0)},o(P){ce(t.$$.fragment,P),ce(a.$$.fragment,P),ce(y.$$.fragment,P),ce(L.$$.fragment,P),M=!1},d(P){Se(t,P),P&&q(i),P&&q(n),Se(a),Se(y),Se(L)}}}const Ur=!0;function Or(e,t,i){let n=0,a=[.05,.025,.05];function s(){i(1,a=a.map(y=>y*1.1))}function u(){i(1,a=a.map(y=>y/1.1))}function g(y){n=y,i(0,n)}return[n,a,s,u,g]}class qr extends Ft{constructor(t){super(),It(this,t,Or,Dr,Bt,{})}}export{qr as default,Ur as prerender};
